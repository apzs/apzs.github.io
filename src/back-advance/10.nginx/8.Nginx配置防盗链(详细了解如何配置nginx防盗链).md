 

> ğŸŒ±æœ¬ä¸“æ å°†ä¼šä»åŸºç¡€å¼€å§‹ï¼Œå¾ªåºæ¸è¿›è®²è§£Nginxçš„ä½¿ç”¨å’Œæœ‰å…³é…ç½®ï¼Œä¹Ÿè¯·å¤§å®¶å¤šå¤šæ”¯æŒ,å¸Œæœ›å¤§å®¶éƒ½èƒ½å¤Ÿä»ä¸­è·ç›Šã€‚  
> ğŸ“«ä¸“æ åœ°å€:[Nginx](https://blog.csdn.net/learning_xzj/category_11792194.html)  
> ğŸ“«ç›¸å…³è½¯ä»¶:[é“¾æ¥åœ°å€](https://pan.baidu.com/s/12VmjEzxEKeiwrONceaWguA?pwd=aaaa)

### æ–‡ç« ç›®å½•

*   *   [é˜²ç›—é“¾](#_5)
    *   *   [nginxé˜²ç›—é“¾é…ç½®](#nginx_9)
        *   *   [valid_referersè§£é‡Š](#valid_referers_222)
        *   [ä½¿ç”¨curlæµ‹è¯•](#curl_270)
        *   [é…ç½®é”™è¯¯æç¤ºé¡µé¢](#_282)
        *   *   [è¿”å›é”™è¯¯é¡µé¢](#_284)
            *   [è¿”å›å‡ºé”™å›¾ç‰‡](#_378)

é˜²ç›—é“¾
---

ç›—é“¾æ˜¯æŒ‡æœåŠ¡æä¾›å•†è‡ªå·±ä¸æä¾›æœåŠ¡çš„å†…å®¹ï¼Œé€šè¿‡æŠ€æœ¯æ‰‹æ®µç»•è¿‡å…¶å®ƒæœ‰åˆ©ç›Šçš„æœ€ç»ˆç”¨æˆ·ç•Œé¢ï¼ˆå¦‚å¹¿å‘Šï¼‰ï¼Œç›´æ¥åœ¨è‡ªå·±çš„ç½‘ç«™ä¸Šå‘æœ€ç»ˆç”¨æˆ·æä¾›å…¶å®ƒæœåŠ¡æä¾›å•†çš„æœåŠ¡å†…å®¹ï¼Œéª—å–æœ€ç»ˆç”¨æˆ·çš„æµè§ˆå’Œç‚¹å‡»ç‡ã€‚å—ç›Šè€…ä¸æä¾›èµ„æºæˆ–æä¾›å¾ˆå°‘çš„èµ„æºï¼Œè€ŒçœŸæ­£çš„æœåŠ¡æä¾›å•†å´å¾—ä¸åˆ°ä»»ä½•çš„æ”¶ç›Šã€‚

### nginxé˜²ç›—é“¾é…ç½®

ä¸ºäº†æ¨¡æ‹Ÿç›—é“¾ï¼Œåœ¨è¿™é‡Œè®©101ä¸ºæœåŠ¡ç«™ç‚¹ï¼Œ102ä¸ºç½‘å…³æœåŠ¡å™¨ï¼Œ103è®¿é—®102è¿›è¡Œç›—é“¾ã€‚

101çš„nginx.cfg

```nginx
worker_processes  1; #å…è®¸è¿›ç¨‹æ•°é‡ï¼Œå»ºè®®è®¾ç½®ä¸ºcpuæ ¸å¿ƒæ•°æˆ–è€…autoè‡ªåŠ¨æ£€æµ‹ï¼Œæ³¨æ„WindowsæœåŠ¡å™¨ä¸Šè™½ç„¶å¯ä»¥å¯åŠ¨å¤šä¸ªprocessesï¼Œä½†æ˜¯å®é™…åªä¼šç”¨å…¶ä¸­ä¸€ä¸ª

events {
    #å•ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼ˆæœ€å¤§è¿æ¥æ•°=è¿æ¥æ•°*è¿›ç¨‹æ•°ï¼‰
    #æ ¹æ®ç¡¬ä»¶è°ƒæ•´ï¼Œå’Œå‰é¢å·¥ä½œè¿›ç¨‹é…åˆèµ·æ¥ç”¨ï¼Œå°½é‡å¤§ï¼Œä½†æ˜¯åˆ«æŠŠcpuè·‘åˆ°100%å°±è¡Œã€‚
    worker_connections  1024;
}


http {
    #æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨(æ˜¯confç›®å½•ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶)
    include       mime.types;
    #é»˜è®¤æ–‡ä»¶ç±»å‹ï¼Œå¦‚æœmime.typesé¢„å…ˆå®šä¹‰çš„ç±»å‹æ²¡åŒ¹é…ä¸Šï¼Œé»˜è®¤ä½¿ç”¨äºŒè¿›åˆ¶æµçš„æ–¹å¼ä¼ è¾“
    default_type  application/octet-stream;

    #sendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfile å‡½æ•°ï¼ˆzero copy æ–¹å¼ï¼‰æ¥è¾“å‡ºæ–‡ä»¶ï¼Œå¯¹äºæ™®é€šåº”ç”¨ï¼Œå¿…é¡»è®¾ä¸ºonã€‚å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨ï¼Œå¯è®¾ç½®ä¸ºoffï¼Œä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œIOå¤„ç†é€Ÿåº¦ã€‚
    sendfile        on;
    
     #é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’
    keepalive_timeout  65;

#å®šä¹‰ä¸€ç»„æœåŠ¡å™¨
upstream httpds{
    server 192.168.8.102 weight=10;
    server 192.168.8.103 weight=1;
}

 #è™šæ‹Ÿä¸»æœºçš„é…ç½®
    server {
    #ç›‘å¬ç«¯å£
        listen       80;
        #åŸŸåï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨ç©ºæ ¼éš”å¼€
        server_name  test80.xzj520520.cn;

	#é…ç½®æ ¹ç›®å½•ä»¥åŠé»˜è®¤é¡µé¢
        location / {
            proxy_pass http://httpds;
            # root   /www/test80;
            # index  index.html index.htm;
        }

	#å‡ºé”™é¡µé¢é…ç½®
        error_page   500 502 503 504  /50x.html;
        #/50x.htmlæ–‡ä»¶æ‰€åœ¨ä½ç½®
        location = /50x.html {
            root   html;
        }
        
    }
    

}
```


102çš„nginx.cfg

```nginx
worker_processes  1;



events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;

    keepalive_timeout  65;


    server {
        listen       80;
        server_name  localhost;


        location / {
            proxy_pass http://192.168.8.101:8080;
        }
        
        
        location ^~/images/ {
            root   /www/resources;
        }
       
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

}
```

103çš„nginx.cfg

```nginx
worker_processes  1;



events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;


    server {
        listen       80;
        server_name  localhost;

        location / {
            proxy_pass http://192.168.8.102;
        }
         
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }

}
```


è®¿é—®http://192.168.8.103

![image-20220501163618594](https://gitlab.com/apzs/image/-/raw/master/image/8876edae0402f056f5d8da41b7ea301e.png)

å¦‚æœä¸æƒ³è¢«ç›—é“¾ï¼Œå¯ä»¥å¯¹ç½‘å…³æœåŠ¡å™¨102åšå¦‚ä¸‹é…ç½®ï¼š

nginx.cfg

```nginx
worker_processes  1;



events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;


    sendfile        on;
    
    keepalive_timeout  65;


    server {
        listen       80;
        server_name  localhost;


        location / {
            proxy_pass http://192.168.8.101:8080;
        }
        
        
        
        location ^~/images/ {
            valid_referers 192.168.8.102;  #valid_referers æŒ‡ä»¤ï¼Œé…ç½®æ˜¯å¦å…è®¸ referer å¤´éƒ¨ä»¥åŠå…è®¸å“ªäº› referer è®¿é—®ã€‚192.168.8.102ä¸æ˜¯ipè€Œæ˜¯åŸŸåï¼ˆå»æ‰http:// å‰ç¼€ï¼‰
            if ($invalid_referer) {  # æ³¨æ„è¿™é‡Œifåè¦åŠ ç©ºæ ¼
                return 403; ## è¿”å›é”™è¯¯ç 
            }
            
            root   /www/resources;
        }
        

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }


}
```

![image-20220501170655802](https://gitlab.com/apzs/image/-/raw/master/image/bdd6d5484ef37b22deeb50db49413fac.png)

![image-20220501170754065](https://gitlab.com/apzs/image/-/raw/master/image/83d69c148f7bf62dd725409dac7efff6.png)

æµ‹è¯•ï¼Œè®¿é—®http://192.168.8.103

![image-20220501173200034](https://gitlab.com/apzs/image/-/raw/master/image/d7b654c33e02267bc59f6c766e99582d.png)

#### valid_referersè§£é‡Š

å¯ä»¥åŒæ—¶æºå¸¦å¤šä¸ªå‚æ•°ï¼Œè¡¨ç¤ºå¤šä¸ª referer å¤´éƒ¨éƒ½ç”Ÿæ•ˆã€‚

**å‚æ•°å€¼**

*   noneï¼šå…è®¸æ²¡æœ‰ referer ä¿¡æ¯çš„è¯·æ±‚è®¿é—®ï¼Œå³ç›´æ¥é€šè¿‡urlè®¿é—®ã€‚
*   blockedï¼šè¯·æ±‚å¤´Refererå­—æ®µä¸ä¸ºç©ºï¼ˆå³å­˜åœ¨Refererï¼‰ï¼Œä½†æ˜¯å€¼å¯ä»¥ä¸ºç©ºï¼ˆå€¼è¢«ä»£ç†æˆ–è€…é˜²ç«å¢™åˆ é™¤äº†ï¼‰ï¼Œå¹¶ä¸”å…è®¸referä¸ä»¥â€œhttp://â€æˆ–â€œhttps://â€å¼€å¤´ï¼Œé€šä¿—ç‚¹è¯´å°±æ˜¯å…è®¸â€œhttp://â€æˆ–"https//"ä»¥å¤–çš„è¯·æ±‚ã€‚
*   server\_namesï¼šè‹¥ referer ä¸­ç«™ç‚¹åŸŸåä¸ server\_name ä¸­æœ¬æœºåŸŸåæŸä¸ªåŒ¹é…ï¼Œåˆ™å…è®¸è¯¥è¯·æ±‚è®¿é—®
*   å…¶ä»–å­—ç¬¦ä¸²ç±»å‹ï¼šæ£€æµ‹refererä¸å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™å…è®¸è®¿é—®ï¼Œå¯ä»¥é‡‡ç”¨é€šé…ç¬¦*
*   æ­£åˆ™è¡¨è¾¾å¼ï¼šè‹¥ referer çš„å€¼åŒ¹é…ä¸Šäº†æ­£åˆ™ï¼Œå°±å…è®¸è®¿é—®

**invalid_referer å˜é‡**

*   å…è®¸è®¿é—®æ—¶å˜é‡å€¼ä¸ºç©º
*   ä¸å…è®¸è®¿é—®æ—¶å˜é‡å€¼ä¸º 1

ä¾‹

    server {
        server_name referer.test.com;
        listen 80;
    
        error_log logs/myerror.log debug;
        root html;
        location / {
            valid_referers none server_names
                           *.test.com www.test.org.cn/nginx/;
            if ($invalid_referer) {
                    return 403; # è¿”å›é”™è¯¯ç 
            }
            return 200 'valid\n';
        }
    }
    
    # noneï¼šè¡¨ç¤ºæ²¡æœ‰ referer çš„å¯ä»¥è®¿é—®
    # server_namesï¼šè¡¨ç¤ºæœ¬æœº server_name ä¹Ÿå°±æ˜¯ referer.test.com å¯ä»¥è®¿é—®
    # *.test.comï¼šåŒ¹é…ä¸Šäº†æ­£åˆ™çš„å¯ä»¥è®¿é—®
    # www.test.org.cn/nginx/ï¼šè¯¥é¡µé¢å‘èµ·çš„è¯·æ±‚å¯ä»¥è®¿é—®


è®¾ç½®ä¸ºnoneçš„æƒ…å†µï¼š

![image-20220501174036398](https://gitlab.com/apzs/image/-/raw/master/image/5814d5313305e3a88fc4f3733ea45574.png)

![image-20220501174009132](https://gitlab.com/apzs/image/-/raw/master/image/cb4607cd33727c18f389c5dbc0556079.png)

### ä½¿ç”¨curlæµ‹è¯•

![image-20220501175110561](https://gitlab.com/apzs/image/-/raw/master/image/04aea1c179923b679318f0788bb06811.png)

ä»baiduè®¿é—®è¿‡æ¥çš„è¯·æ±‚ï¼š

![image-20220501175433326](https://gitlab.com/apzs/image/-/raw/master/image/9dd486930253786ca1b0d7881cc8ea20.png)

å¦‚æœæ·»åŠ äº†baidu.comï¼Œå‘ç°è®¿é—®æˆåŠŸï¼š

![image-20220501175824843](https://gitlab.com/apzs/image/-/raw/master/image/f17d141c8c636e3470d2ae5c3254e94f.png)

### é…ç½®é”™è¯¯æç¤ºé¡µé¢

#### è¿”å›é”™è¯¯é¡µé¢

åœ¨102nginxçš„htmlç›®å½•ä¸­æ·»åŠ [403](https://so.csdn.net/so/search?q=403&spm=1001.2101.3001.7020).html

    <!DOCTYPE html>
    <html>
    <head>
    <meta charset="utf-8">
    <title>Error</title>
    <style>
    html { color-scheme: light dark; }
    body { width: 35em; margin: 0 auto;
    font-family: Tahoma, Verdana, Arial, sans-serif; }
    </style>
    </head>
    <body>
    <h1>An error occurred.</h1>
    <p>éæ³•è¯·æ±‚.</p>
    
    </body>
    </html>


 ä¿®æ”¹nginx.conf

![image-20220501180853897](https://gitlab.com/apzs/image/-/raw/master/image/178ce88b287406fb64c0d236ed598da2.png)

ä»£ç å¦‚ä¸‹:

```nginx
worker_processes  1;



events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

   

    sendfile        on;

    keepalive_timeout  65;



    server {
        listen       80;
        server_name  localhost;

        location / {
            proxy_pass http://192.168.8.101:8080;
        }
        
        
        location ^~/images/ {
            valid_referers 192.168.8.102 baidu.com;
            if ($invalid_referer) {
                return 403; # è¿”å›é”™è¯¯ç 
            }
            
            root   /www/resources;
        }
        

        error_page   403  /403.html;
        location = /403.html {
            root   html;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        
    }

}
```

è®¿é—®http://192.168.8.103/images/bg.jpg

![image-20220501180531243](https://gitlab.com/apzs/image/-/raw/master/image/a5980a6a934456b8ab3fc7810f9fdf7a.png)

#### è¿”å›å‡ºé”™å›¾ç‰‡

ä¿®æ”¹ç½‘å…³æœåŠ¡å™¨102

![image-20220501181602775](https://gitlab.com/apzs/image/-/raw/master/image/12399be39ef7bd88b9d162bc440df75a.png)

å°†403.pngä¿å­˜åˆ°/www/resources/imagesä¸­

![image-20220501182639312](https://gitlab.com/apzs/image/-/raw/master/image/b4ed53ef3e4a4b3807dbfefb075a1f97.png)

è®¿é—®192.168.8.103:

![image-20220501182707030](https://gitlab.com/apzs/image/-/raw/master/image/5f738a013a45900950b6bef735f2281e.png)
