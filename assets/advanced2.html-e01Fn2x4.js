import{_ as i}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as o,o as l,c as u,a as n,b as a,d as s,w as c,e as p}from"./app-db_OQQsY.js";const r={},d=p(`<h2 id="_5-4、商城业务-缓存-锁" tabindex="-1"><a class="header-anchor" href="#_5-4、商城业务-缓存-锁" aria-hidden="true">#</a> 5.4、商城业务-缓存，锁</h2><h3 id="_5-4-1、缓存-缓存使用" tabindex="-1"><a class="header-anchor" href="#_5-4-1、缓存-缓存使用" aria-hidden="true">#</a> 5.4.1、缓存-缓存使用</h3><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.0.png" alt="image-20220721212905833" tabindex="0" loading="lazy"><figcaption>image-20220721212905833</figcaption></figure><h4 id="_1、本地缓存" tabindex="-1"><a class="header-anchor" href="#_1、本地缓存" aria-hidden="true">#</a> 1、本地缓存</h4><p>把从数据库中查询的数据放到本类的属性里面，再次有请求进入后，发现该类已存储从数据库中查询的数据，直接返回即可</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.0.png" alt="image-20220713195239272" style="zoom:50%;"><h5 id="_1、修改categoryserviceimpl类" tabindex="-1"><a class="header-anchor" href="#_1、修改categoryserviceimpl类" aria-hidden="true">#</a> 1、修改<code>CategoryServiceImpl</code>类</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里修改部分方法，使把查出的数据放到本地的<code>cache</code>里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache <span class="token operator">=</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//一次查询所有</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l1 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、该一级分类的所有二级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span>l1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span></span> catelog2VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>category2Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catelog2VoList <span class="token operator">=</span> category2Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog1Id</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//3、当前二级分类的所有三级分类</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span>l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catelog3VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>category3Entities<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    catelog3VoList <span class="token operator">=</span> category3Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span> catelog3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setCatalog2Id</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> catelog3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>catelog3VoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catelog2VoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities<span class="token punctuation">,</span><span class="token class-name">CategoryEntity</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//LambdaQueryWrapper&lt;CategoryEntity&gt; category2QueryWrapper = new LambdaQueryWrapper&lt;&gt;();</span>
    <span class="token comment">//category2QueryWrapper.eq(CategoryEntity::getParentCid, l1.getCatId());</span>
    <span class="token comment">//return this.baseMapper.selectList(category2QueryWrapper);</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> categoryEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>categoryEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> categoryEntity<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.1.png" alt="image-20220713194616644" tabindex="0" loading="lazy"><figcaption>image-20220713194616644</figcaption></figure><h5 id="_2、准备工作" tabindex="-1"><a class="header-anchor" href="#_2、准备工作" aria-hidden="true">#</a> 2、准备工作</h5><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>50</code>，表示<strong>启动50个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.2.1.png" alt="image-20220713194704485" tabindex="0" loading="lazy"><figcaption>image-20220713194704485</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/index/catalog.json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.2.2.png" alt="image-20220713194722501" tabindex="0" loading="lazy"><figcaption>image-20220713194722501</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，取消勾选<code>从HTML文件获取所有内含的资源</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.2.3.png" alt="image-20220713194735626" tabindex="0" loading="lazy"><figcaption>image-20220713194735626</figcaption></figure><p>要压测的接口： http://localhost:10000/index/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.2.4.png" alt="image-20220713194807049" tabindex="0" loading="lazy"><figcaption>image-20220713194807049</figcaption></figure><h5 id="_3、执行测试" tabindex="-1"><a class="header-anchor" href="#_3、执行测试" aria-hidden="true">#</a> 3、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.3.gif" alt="GIF 2022-7-13 19-44-33" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 19-44-33</figcaption></figure><h5 id="_4、查看压测报告" tabindex="-1"><a class="header-anchor" href="#_4、查看压测报告" aria-hidden="true">#</a> 4、查看压测报告</h5><p>可以看到，使用本地缓存的方式接口的吞吐量非常高</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.4.1.png" alt="image-20220713194911408" tabindex="0" loading="lazy"><figcaption>image-20220713194911408</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.4.2.png" alt="image-20220713194923340" tabindex="0" loading="lazy"><figcaption>image-20220713194923340</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.4.3.png" alt="image-20220713194935181" tabindex="0" loading="lazy"><figcaption>image-20220713194935181</figcaption></figure><h5 id="_5、问题" tabindex="-1"><a class="header-anchor" href="#_5、问题" aria-hidden="true">#</a> 5、问题</h5><p>在<code>集群</code>环境下，每一个<code>gulimall-product</code>服务都存储自己的一份<code>cache</code>，这极大的浪费了<code>堆</code>的内存，</p><p>而且更严重的是当其中一个<code>gulimall-product</code>服务修改了数据后，其他服务感知不到修改，其他服务还在使用旧的数据，这样就违反了数据的最终一致性。</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.1.5.png" alt="image-20220713195353065" style="zoom:50%;"><h4 id="_2、分布式缓存" tabindex="-1"><a class="header-anchor" href="#_2、分布式缓存" aria-hidden="true">#</a> 2、分布式缓存</h4><p>在分布式项目中，应使用分布式缓存技术，所有<code>gulimall-product</code>服务都向<code>缓存中间件</code>里获取数据，这样防止浪费了本地缓存，最重要的是当其中一个服务修改了数据后，其他服务也能获取最新的数据(虽然不能达到严格的一致性，但可以确保数据的最终一致性)</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.0.png" alt="image-20220713195507412" style="zoom:50%;"><h5 id="_1、添加依赖" tabindex="-1"><a class="header-anchor" href="#_1、添加依赖" aria-hidden="true">#</a> 1、添加依赖</h5><p>在<code>gulimall-product</code>模块的<code>pom.xml</code>文件内添加<code>redis</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.1.png" alt="image-20220713200117460" tabindex="0" loading="lazy"><figcaption>image-20220713200117460</figcaption></figure><h5 id="_2、配置redis主机地址和端口" tabindex="-1"><a class="header-anchor" href="#_2、配置redis主机地址和端口" aria-hidden="true">#</a> 2、配置<code>redis</code>主机地址和端口</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件内配置<code>redis</code>主机地址和端口</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.56.10
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.2.png" alt="image-20220713200015211" tabindex="0" loading="lazy"><figcaption>image-20220713200015211</figcaption></figure><h5 id="_3、可使用的对象" tabindex="-1"><a class="header-anchor" href="#_3、可使用的对象" aria-hidden="true">#</a> 3、可使用的对象</h5><p>在<code>org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</code>类里提供了<code>RedisTemplate</code>和<code>StringRedisTemplate</code>两个对象来操作<code>redis</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
   <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> <span class="token function">stringRedisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
   <span class="token class-name">StringRedisTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.3.1.png" alt="image-20220713200342377" tabindex="0" loading="lazy"><figcaption>image-20220713200342377</figcaption></figure><p>由于<code>String</code>类型在<code>redis</code>里非常常用，因此封装了继承<code>RedisTemplate</code>类的<code>StringRedisTemplate</code>用于操作<code>redis</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.3.2.png" alt="image-20220713200628278" tabindex="0" loading="lazy"><figcaption>image-20220713200628278</figcaption></figure><h5 id="_4、简单使用" tabindex="-1"><a class="header-anchor" href="#_4、简单使用" aria-hidden="true">#</a> 4、简单使用</h5><p>常用方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//操作字符串</span>
stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//操作hash</span>
stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//操作list</span>
stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//操作set</span>
stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//操作有序set</span>
stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.GulimallProductApplicationTests</code>测试类里添加如下测试代码，在<code>redis</code>里添加<code>key</code>为<code>hello</code>的数据，然后执行测试</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stringRedisTemplateTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//保存</span>
   ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;world&quot;</span><span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//查询</span>
   <span class="token class-name">String</span> hello <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;之前保存的数据是：&quot;</span><span class="token operator">+</span> hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.4.1.png" alt="image-20220713201403494" tabindex="0" loading="lazy"><figcaption>image-20220713201403494</figcaption></figure><p>打开<code>Redis Desktop Manager</code>可以看到<code>key</code>为<code>hello</code>的数据已经存进<code>redis</code>里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.2.4.2.png" alt="image-20220713202139733" tabindex="0" loading="lazy"><figcaption>image-20220713202139733</figcaption></figure><h4 id="_3、测试" tabindex="-1"><a class="header-anchor" href="#_3、测试" aria-hidden="true">#</a> 3、测试</h4><h5 id="_1、准备工作" tabindex="-1"><a class="header-anchor" href="#_1、准备工作" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>50</code>，表示<strong>启动50个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.1.1.png" alt="image-20220713221119905" tabindex="0" loading="lazy"><figcaption>image-20220713221119905</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/index/catalog.json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.1.2.png" alt="image-20220713221142043" tabindex="0" loading="lazy"><figcaption>image-20220713221142043</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，取消勾选<code>从HTML文件获取所有内含的资源</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.1.3.png" alt="image-20220713221159131" tabindex="0" loading="lazy"><figcaption>image-20220713221159131</figcaption></figure><p>要压测的接口： http://localhost:10000/index/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.1.4.png" alt="image-20220713221912300" tabindex="0" loading="lazy"><figcaption>image-20220713221912300</figcaption></figure><h5 id="_2、执行测试" tabindex="-1"><a class="header-anchor" href="#_2、执行测试" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.2.gif" alt="GIF 2022-7-13 22-29-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 22-29-14</figcaption></figure><h5 id="_3、堆外内存溢出" tabindex="-1"><a class="header-anchor" href="#_3、堆外内存溢出" aria-hidden="true">#</a> 3、堆外内存溢出</h5><p>可以看到<code>http://localhost:10000/index/catalog.json</code>已无法访问</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.3.1.png" alt="image-20220713223323423" tabindex="0" loading="lazy"><figcaption>image-20220713223323423</figcaption></figure><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.3.2.png" alt="image-20220713223350313" tabindex="0" loading="lazy"><figcaption>image-20220713223350313</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.3.3.png" alt="image-20220713223400875" tabindex="0" loading="lazy"><figcaption>image-20220713223400875</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.3.4.png" alt="image-20220713223414080" tabindex="0" loading="lazy"><figcaption>image-20220713223414080</figcaption></figure><p>控制台报<code>堆外内存溢出</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-07-13 22:34:29.065  WARN 8940 --- [ioEventLoop-4-2] io.lettuce.core.protocol.CommandHandler  : null Unexpected exception during request: io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 37748736 byte(s) of direct memory (used: 67108864, max: 100663296)

io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 37748736 byte(s) of direct memory (used: 67108864, max: 100663296)
   at io.netty.util.internal.PlatformDependent.incrementMemoryCounter(PlatformDependent.java:725) ~[netty-common-4.1.39.Final.jar:4.1.39.Final]
   at io.netty.util.internal.PlatformDependent.allocateDirectNoCleaner(PlatformDependent.java:680) ~[netty-common-4.1.39.Final.jar:4.1.39.Final]
   at io.netty.buffer.PoolArena$DirectArena.allocateDirect(PoolArena.java:772) ~[netty-buffer-4.1.39.Final.jar:4.1.39.Final]
   at io.netty.buffer.PoolArena$DirectArena.newUnpooledChunk(PoolArena.java:762) ~[netty-buffer-4.1.39.Final.jar:4.1.39.Final]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.3.5.png" alt="image-20220713223441846" tabindex="0" loading="lazy"><figcaption>image-20220713223441846</figcaption></figure><h5 id="_4、原因" tabindex="-1"><a class="header-anchor" href="#_4、原因" aria-hidden="true">#</a> 4、原因</h5><p>因为<code>spring-boot-starter-data-redis-2.1.8.RELEASE</code>在操作<code>redis</code>时，使用了<code>lettuce</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.4.1.png" alt="image-20220715103407245" tabindex="0" loading="lazy"><figcaption>image-20220715103407245</figcaption></figure><p>而<code>lettuce-core-5.1.8.RELEASE</code>引用了<code>netty</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-handler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-transport<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.4.2.png" alt="image-20220715103430255" tabindex="0" loading="lazy"><figcaption>image-20220715103430255</figcaption></figure><p>所以会报<code>netty</code>相关的异常</p><h5 id="_5、报错的类" tabindex="-1"><a class="header-anchor" href="#_5、报错的类" aria-hidden="true">#</a> 5、报错的类</h5><p>在<code>io.netty.util.internal.OutOfDirectMemoryError.java</code>类里报了这个异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">OutOfMemoryError</span></span><span class="token punctuation">}</span> that is throws if <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">PlatformDependent</span><span class="token punctuation">#</span><span class="token function">allocateDirectNoCleaner</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> can not allocate
 * a new <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ByteBuffer</span></span><span class="token punctuation">}</span> due memory restrictions.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">OutOfDirectMemoryError</span> <span class="token keyword">extends</span> <span class="token class-name">OutOfMemoryError</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">4228264016184011555L</span><span class="token punctuation">;</span>

    <span class="token class-name">OutOfDirectMemoryError</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.5.1.png" alt="image-20220715150401848" tabindex="0" loading="lazy"><figcaption>image-20220715150401848</figcaption></figure><p>在<code>io.netty.util.internal.PlatformDependent.java</code>类里当<code>newUsedMemory</code>(新的已用内存) <code>&gt;</code> <code>DIRECT_MEMORY_LIMIT</code>(直接内存限制)，就会抛出异常。(这个直接内存是<code>netty</code>自己在底层计数)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">incrementMemoryCounter</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DIRECT_MEMORY_COUNTER</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> newUsedMemory <span class="token operator">=</span> <span class="token constant">DIRECT_MEMORY_COUNTER</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newUsedMemory <span class="token operator">&gt;</span> <span class="token constant">DIRECT_MEMORY_LIMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">DIRECT_MEMORY_COUNTER</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token operator">-</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OutOfDirectMemoryError</span><span class="token punctuation">(</span><span class="token string">&quot;failed to allocate &quot;</span> <span class="token operator">+</span> capacity
                    <span class="token operator">+</span> <span class="token string">&quot; byte(s) of direct memory (used: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>newUsedMemory <span class="token operator">-</span> capacity<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;, max: &quot;</span> <span class="token operator">+</span> <span class="token constant">DIRECT_MEMORY_LIMIT</span> <span class="token operator">+</span> <span class="token char">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.5.2.png" alt="image-20220715150701735" tabindex="0" loading="lazy"><figcaption>image-20220715150701735</figcaption></figure><p>在当前类申明了<code>DIRECT_MEMORY_LIMIT</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">DIRECT_MEMORY_LIMIT</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.5.3.png" alt="image-20220715151444404" tabindex="0" loading="lazy"><figcaption>image-20220715151444404</figcaption></figure><p>可以通过<code>-Dio.netty.maxDirectMemory</code>这个虚拟机参数设置最大内存，如果不设置默认就和堆内存大小<code>-Xmx参数</code>一样</p><p>通过<code>-Dio.netty.maxDirectMemory</code>这个虚拟机参数调大内存、或修改堆内存<code>-Xmx参数</code>后，可以延缓异常抛出的时间，但不能解决问题</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;-Dio.netty.maxDirectMemory: {} bytes&quot;</span><span class="token punctuation">,</span> maxDirectMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">DIRECT_MEMORY_LIMIT</span> <span class="token operator">=</span> maxDirectMemory <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">?</span> maxDirectMemory <span class="token operator">:</span> <span class="token constant">MAX_DIRECT_MEMORY</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.3.5.4.png" alt="image-20220715151559659" tabindex="0" loading="lazy"><figcaption>image-20220715151559659</figcaption></figure><h4 id="_4、调大内存后重试" tabindex="-1"><a class="header-anchor" href="#_4、调大内存后重试" aria-hidden="true">#</a> 4、调大内存后重试</h4><h5 id="_1、修改运行参数" tabindex="-1"><a class="header-anchor" href="#_1、修改运行参数" aria-hidden="true">#</a> 1、修改运行参数</h5><p>在<code>GulimallProductApplication</code>模块的运行配置里的<code>Environment</code>栏的<code>VM options</code>里的右方框里输入<code>-Xmx300m</code>，重新限制<code>GulimallProductApplication</code>模块的最大内存占用为<code>300m</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-Xmx300m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重新启动<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.1.png" alt="image-20220715153737538" tabindex="0" loading="lazy"><figcaption>image-20220715153737538</figcaption></figure><h5 id="_2、执行测试-1" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-1" aria-hidden="true">#</a> 2、执行测试</h5><p>可以看到调大<code>-Xmx参数</code>后，异常出现时间明显延后，但是还是不能从根本上解决问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.2.gif" alt="GIF 2022-7-15 15-46-29" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-15 15-46-29</figcaption></figure><h5 id="_3、查看压测报告" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告" aria-hidden="true">#</a> 3、查看压测报告</h5><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.3.1.png" alt="image-20220715155239718" tabindex="0" loading="lazy"><figcaption>image-20220715155239718</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.3.2.png" alt="image-20220715155249984" tabindex="0" loading="lazy"><figcaption>image-20220715155249984</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.3.3.png" alt="image-20220715155301898" tabindex="0" loading="lazy"><figcaption>image-20220715155301898</figcaption></figure><p>在<code>jvisualvm</code>的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>服务的<code>Visual GC</code>里查看<code>新生代</code>和<code>老年代</code>使用情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.3.4.png" alt="image-20220715155209605" tabindex="0" loading="lazy"><figcaption>image-20220715155209605</figcaption></figure><p>在<code>jvisualvm</code>的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>服务的<code>监视</code>里查看<code>CPU</code>、<code>堆</code>等资源使用情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.4.3.5.png" alt="image-20220715155151814" tabindex="0" loading="lazy"><figcaption>image-20220715155151814</figcaption></figure><h4 id="_5、根本上解决对外内存异常" tabindex="-1"><a class="header-anchor" href="#_5、根本上解决对外内存异常" aria-hidden="true">#</a> 5、根本上解决对外内存异常</h4><h5 id="_1、使用jedis" tabindex="-1"><a class="header-anchor" href="#_1、使用jedis" aria-hidden="true">#</a> 1、使用<code>jedis</code></h5><p>在<code>spring-boot-starter-data-redis-2.1.8.RELEASE</code>里使用了<code>lettuce</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.1.1.png" alt="image-20220713224440576" tabindex="0" loading="lazy"><figcaption>image-20220713224440576</figcaption></figure><p>因此只需要排除<code>lettuce</code>，并重新引入<code>jedis</code>即可</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.1.2.png" alt="image-20220713224540175" tabindex="0" loading="lazy"><figcaption>image-20220713224540175</figcaption></figure><p>在<code>org\\springframework\\boot\\spring-boot-dependencies\\2.1.8.RELEASE\\spring-boot-dependencies-2.1.8.RELEASE.pom</code></p><p>里指定了<code>jedis</code>的版本，因此我们并不需要指定<code>jedis</code>的版本</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.1.3.gif" alt="GIF 2022-7-13 22-50-50" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 22-50-50</figcaption></figure><p>要压测的接口： http://localhost:10000/index/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.1.4.png" alt="image-20220715152455155" tabindex="0" loading="lazy"><figcaption>image-20220715152455155</figcaption></figure><h5 id="_2、执行测试-2" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-2" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.2.gif" alt="GIF 2022-7-15 15-27-41" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-15 15-27-41</figcaption></figure><h5 id="_3、查看压测报告-1" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-1" aria-hidden="true">#</a> 3、查看压测报告</h5><p>可以发现<code>jedis</code>比<code>lettuce</code>在性能上差了不少</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.3.1.png" alt="image-20220715152929879" tabindex="0" loading="lazy"><figcaption>image-20220715152929879</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.3.2.png" alt="image-20220715153026558" tabindex="0" loading="lazy"><figcaption>image-20220715153026558</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.3.3.png" alt="image-20220715153043208" tabindex="0" loading="lazy"><figcaption>image-20220715153043208</figcaption></figure><p>在<code>jvisualvm</code>的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>服务的<code>Visual GC</code>里查看<code>新生代</code>和<code>老年代</code>使用情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.3.4.png" alt="image-20220715153055591" tabindex="0" loading="lazy"><figcaption>image-20220715153055591</figcaption></figure><p>在<code>jvisualvm</code>的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>服务的<code>监视</code>里查看<code>CPU</code>、<code>堆</code>等资源使用情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.3.5.png" alt="image-20220715153112065" tabindex="0" loading="lazy"><figcaption>image-20220715153112065</figcaption></figure><h5 id="_4、内存调大-xmx300m又测试了一次" tabindex="-1"><a class="header-anchor" href="#_4、内存调大-xmx300m又测试了一次" aria-hidden="true">#</a> 4、内存调大<code>-Xmx300m</code>又测试了一次</h5><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.4.1.png" alt="image-20220715160023816" tabindex="0" loading="lazy"><figcaption>image-20220715160023816</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.4.2.png" alt="image-20220715160047736" tabindex="0" loading="lazy"><figcaption>image-20220715160047736</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.5.4.3.png" alt="image-20220715160103038" tabindex="0" loading="lazy"><figcaption>image-20220715160103038</figcaption></figure><h4 id="_6、说明" tabindex="-1"><a class="header-anchor" href="#_6、说明" aria-hidden="true">#</a> 6、说明</h4><p>在<code>org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</code>类里导入了<code>LettuceConnectionConfiguration.class</code>和<code>JedisConnectionConfiguration.class</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">LettuceConnectionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">JedisConnectionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.6.1.png" alt="image-20220715160337658" tabindex="0" loading="lazy"><figcaption>image-20220715160337658</figcaption></figure><p>在<code>org.springframework.boot.autoconfigure.data.redis.LettuceConnectionConfiguration</code>类里如果<code>RedisConnectionFactory.class</code>类在<code>ioc</code>容器中不存在，则向<code>ioc</code>容器注入<code>RedisConnectionFactory</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">LettuceConnectionFactory</span> <span class="token function">redisConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">ClientResources</span> clientResources<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
   <span class="token class-name">LettuceClientConfiguration</span> clientConfig <span class="token operator">=</span> <span class="token function">getLettuceClientConfiguration</span><span class="token punctuation">(</span>clientResources<span class="token punctuation">,</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getLettuce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">createLettuceConnectionFactory</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.6.2.png" alt="image-20220715160551114" tabindex="0" loading="lazy"><figcaption>image-20220715160551114</figcaption></figure><p>在<code>org.springframework.boot.autoconfigure.data.redis.JedisConnectionConfiguration</code>类里如果<code>RedisConnectionFactory.class</code>类在<code>ioc</code>容器中不存在，则向<code>ioc</code>容器注入<code>RedisConnectionFactory</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">JedisConnectionFactory</span> <span class="token function">redisConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">createJedisConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.6.3.png" alt="image-20220715160746996" tabindex="0" loading="lazy"><figcaption>image-20220715160746996</figcaption></figure><p>在<code>org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration</code>类里则会使用它们其中一个注入到<code>ioc</code>容器的<code>RedisConnectionFactory</code>来操作<code>redis</code></p><p>相当于<code>lettuce</code>和<code> jedis</code>都是操作<code>redis</code>底层的客户端，<code>spring</code>再次封装成了<code>redisTemplate</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
   <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>\`<span class="token punctuation">;</span>
   template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> <span class="token function">stringRedisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
   <span class="token class-name">StringRedisTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.1.6.4.png" alt="image-20220715161018842" tabindex="0" loading="lazy"><figcaption>image-20220715161018842</figcaption></figure><h3 id="_5-4-2、缓存-redis锁" tabindex="-1"><a class="header-anchor" href="#_5-4-2、缓存-redis锁" aria-hidden="true">#</a> 5.4.2、缓存-redis锁</h3><h4 id="_1、常见问题" tabindex="-1"><a class="header-anchor" href="#_1、常见问题" aria-hidden="true">#</a> 1、常见问题</h4><h5 id="_1、缓存穿透" tabindex="-1"><a class="header-anchor" href="#_1、缓存穿透" aria-hidden="true">#</a> 1、缓存穿透</h5><p><strong>缓存穿透</strong>： 指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是 数据库也无此记录，我们没有将这次查询的null写入缓存，这将导致这个不 存在的数据每次请求都要到存储层去查询，失去了缓存的意义</p><p><strong>风险</strong>： 利用不存在的数据进行攻击，数据库瞬时压力增大，最终导致崩溃</p><p><strong>解决</strong>： null结果缓存，并加入短暂过期时间</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.1.1.png" alt="image-20220715162001456" style="zoom:50%;"><h5 id="_2、缓存雪崩" tabindex="-1"><a class="header-anchor" href="#_2、缓存雪崩" aria-hidden="true">#</a> 2、缓存雪崩</h5><p><strong>缓存雪崩</strong>： 缓存雪崩是指在我们设置缓存时key采用了相同的过期时间， 导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时 压力过重雪崩。</p><p><strong>解决</strong>： 原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这 样每一个缓存的过期时间的重复率就会降低，就很难引发集体 失效的事件。</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.1.2.png" alt="image-20220715162139708" style="zoom:50%;"><h5 id="_3、缓存穿透" tabindex="-1"><a class="header-anchor" href="#_3、缓存穿透" aria-hidden="true">#</a> 3、缓存穿透</h5><p><strong>缓存穿透</strong>：</p><ul><li><p>对于一些设置了过期时间的key，如果这些key可能会在某些 时间点被超高并发地访问，是一种非常“热点”的数据。</p></li><li><p>如果这个key在大量请求同时进来前正好失效，那么所有对 这个key的数据查询都落到db，我们称为缓存击穿。</p></li></ul><p><strong>解决</strong>： 加锁</p><p>大量并发只让一个去查，其他人等待，查到以后释放锁，其他 人获取到锁，先查缓存，就会有数据，不用去db</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.1.3.png" alt="image-20220715162219429" style="zoom:50%;"><h4 id="_2、本地锁-单体架构" tabindex="-1"><a class="header-anchor" href="#_2、本地锁-单体架构" aria-hidden="true">#</a> 2、本地锁(单体架构)</h4><p>通过本地锁(性能高)，只能锁住当前进程，在分布式环境下如果部署了100台机器，如果只锁当前进程，虽然放行了100个线程查询数据库，看起来性能也还行。但是如果一台机器修改该数据，其他机器却感知不到数据被修改了，这就引起了数据最终不一致的问题。因此在分布式架构下，应使用分布式锁(性能低)。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.0.png" alt="image-20220721205546480" tabindex="0" loading="lazy"><figcaption>image-20220721205546480</figcaption></figure><p>本地锁，只能锁住当前进程，所以我们需要分布式锁</p><h5 id="_1、本地锁代码" tabindex="-1"><a class="header-anchor" href="#_1、本地锁代码" aria-hidden="true">#</a> 1、本地锁代码</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 1、空结果缓存:解诀缓存穿透
 * 2、设置过期时间(加随机值) :解诀缓存雪崩
 * 3、加锁:解决缓存击穿
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、加入缓存逻辑,缓存中存的数据是json字符串。</span>
    <span class="token comment">//JSON跨语言，跨平台兼容。</span>
    <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> catalogJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、缓存中没有,查询数据库</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;缓存不命中...查询数据库...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.查到的数据再放入缓存，将对象转为json放在缓存中</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>catalogJsonForDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;缓存命中...直接返回&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">,</span>typeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//得到锁以后，我们应该再去缓存中确定一 次，如果没有才需要继续查询(双检锁)</span>
    <span class="token comment">//只要是同一把锁，就能锁住需要这个锁的所有线程</span>
    <span class="token comment">//synchronized (this): SpringBoot所有的组件在容器中都是单例的。</span>
    <span class="token comment">//TODO 本地锁: synchronized, JUC(Lock) 在分布式情况下，想要锁住所有，必须使用分布式锁</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> catalogJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">,</span>typeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询了数据库......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一次查询所有</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1、查出所有一级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l1 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//2、该一级分类的所有二级分类</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span> l1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span></span> catelog2VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>category2Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                catelog2VoList <span class="token operator">=</span> category2Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog1Id</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    catelog2Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    catelog2Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//3、当前二级分类的所有三级分类</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span> l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catelog3VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>category3Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        catelog3VoList <span class="token operator">=</span> category3Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span> catelog3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            catelog3Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            catelog3Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            catelog3Vo<span class="token punctuation">.</span><span class="token function">setCatalog2Id</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> catelog3Vo<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>catelog3VoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> catelog2VoList<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.1.png" alt="image-20220715163745249" tabindex="0" loading="lazy"><figcaption>image-20220715163745249</figcaption></figure><h5 id="_2、删除redis中key为catalogjson的数据" tabindex="-1"><a class="header-anchor" href="#_2、删除redis中key为catalogjson的数据" aria-hidden="true">#</a> 2、删除<code>redis</code>中<code>key</code>为<code>catalogJson</code>的数据</h5><p>使用<code>Redis Desktop Manager</code>工具，删除<code>redis</code>中<code>key</code>为<code>catalogJson</code>的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.2.png" alt="image-20220716085225713" tabindex="0" loading="lazy"><figcaption>image-20220716085225713</figcaption></figure><h5 id="_3、重新测试-锁-时序问题" tabindex="-1"><a class="header-anchor" href="#_3、重新测试-锁-时序问题" aria-hidden="true">#</a> 3、重新测试(锁-时序问题)</h5><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.3.0.png" alt="image-20220721205904236" style="zoom:50%;"><p>重新运行<code>GulimallProductApplication</code>服务，<strong>不要</strong>刷新前端页面，确保在压力测试之前、<code>redis</code>里面没有<code>catalogJson</code>的数据</p><p>可以发现查询了两次数据库，这是因为加锁加小了，查询完数据库后就释放锁了，释放锁以后才把最新数据发送给<code>redis</code>，在发送给<code>redis</code>的这段时间内，又一个线程进来了它从<code>redis</code>获取数据发现没有获取到(此时先查询数据库的线程还未完全把数据放到<code>redis</code>里)，因此查询了两次数据库。正确的做法应该是先<code>放入缓存</code>，再<code>释放锁</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.3.gif" alt="GIF 2022-7-16 8-58-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 8-58-13</figcaption></figure><h5 id="_4、修改categoryserviceimpl类代码" tabindex="-1"><a class="header-anchor" href="#_4、修改categoryserviceimpl类代码" aria-hidden="true">#</a> 4、修改<code>CategoryServiceImpl</code>类代码</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类，把<code>getCatalogJson</code>方法里的以下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//3.查到的数据再放入缓存，将对象转为json放在缓存中</span>
<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>放到<code>getCatalogJsonForDb</code>方法的锁里面，保证只有一个线程查询数据库</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.4.1.png" alt="image-20220716091107158" tabindex="0" loading="lazy"><figcaption>image-20220716091107158</figcaption></figure><p>最后我又修改成了这样：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 1、空结果缓存:解诀缓存穿透
 * 2、设置过期时间(加随机值) :解诀缓存雪崩
 * 3、加锁:解决缓存击穿
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、加入缓存逻辑,缓存中存的数据是json字符串。</span>
    <span class="token comment">//JSON跨语言，跨平台兼容。</span>
    <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> catalogJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、缓存中没有,查询数据库</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;缓存不命中...查询数据库...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDbWithLocalLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.查到的数据再放入缓存，将对象转为json放在缓存中</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>catalogJsonForDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;缓存命中...直接返回&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">,</span>typeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithLocalLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//得到锁以后，我们应该再去缓存中确定一 次，如果没有才需要继续查询(双检锁)</span>
    <span class="token comment">//只要是同一把锁，就能锁住需要这个锁的所有线程</span>
    <span class="token comment">//synchronized (this): SpringBoot所有的组件在容器中都是单例的。</span>
    <span class="token comment">//TODO 本地锁: synchronized, JUC(Lock) 在分布式情况下，想要锁住所有，必须使用分布式锁</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> catalogJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typeReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>catalogJson<span class="token punctuation">,</span> typeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询了数据库......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//一次查询所有</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l1 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、该一级分类的所有二级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span> l1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span></span> catelog2VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>category2Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catelog2VoList <span class="token operator">=</span> category2Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog1Id</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//3、当前二级分类的所有三级分类</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span> l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catelog3VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>category3Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    catelog3VoList <span class="token operator">=</span> category3Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span> catelog3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setCatalog2Id</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> catelog3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>catelog3VoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catelog2VoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.查到的数据再放入缓存，将对象转为json放在缓存中</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.4.2.png" alt="image-20220716191130234" tabindex="0" loading="lazy"><figcaption>image-20220716191130234</figcaption></figure><h5 id="_5、重新测试" tabindex="-1"><a class="header-anchor" href="#_5、重新测试" aria-hidden="true">#</a> 5、重新测试</h5><p>重启<code>GulimallProductApplication</code>服务，删除<code>redis</code>里的<code>catalogJson</code>的数据，开始测试。这时就只有一个线程查询了数据库</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.2.5.gif" alt="GIF 2022-7-16 9-13-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 9-13-46</figcaption></figure><h4 id="_3、集群测试" tabindex="-1"><a class="header-anchor" href="#_3、集群测试" aria-hidden="true">#</a> 3、集群测试</h4><h5 id="_1、启动多个product服务" tabindex="-1"><a class="header-anchor" href="#_1、启动多个product服务" aria-hidden="true">#</a> 1、启动多个<code>product</code>服务</h5><p>选中<code>Service</code>里的<code>GulimallProductApplication</code>服务，右键选择<code>Copy Configuration..</code>或者按<code>Ctrl+D </code>快捷键，复制一个配置</p><p>在<code>name</code>里输入<code>GulimallProductApplication - 10001</code>，在<code>Program arguments:</code>里输入<code>--server.port=10001</code>用于在启动的参数里指定运行的端口</p><p>同理在复制2个</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GulimallProductApplication - 10001
--server.port=10001

GulimallProductApplication - 10002
--server.port=10002

GulimallProductApplication - 10003
--server.port=10003
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.1.1.gif" alt="GIF 2022-7-16 9-29-47" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 9-29-47</figcaption></figure><p>一共复制了3个配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.1.2.png" alt="image-20220716191356029" tabindex="0" loading="lazy"><figcaption>image-20220716191356029</figcaption></figure><h5 id="_2、启动这些服务" tabindex="-1"><a class="header-anchor" href="#_2、启动这些服务" aria-hidden="true">#</a> 2、启动这些服务</h5><p>启动<code>GulimallProductApplication - 10001</code>服务、<code>GulimallProductApplication - 10002</code>服务、<code>GulimallProductApplication - 10003</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.2.gif" alt="GIF 2022-7-16 9-36-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 9-36-02</figcaption></figure><h5 id="_3、准备工作" tabindex="-1"><a class="header-anchor" href="#_3、准备工作" aria-hidden="true">#</a> 3、准备工作</h5><p>使用<code>Redis Desktop Manager</code>工具，删除<code>redis</code>中<code>key</code>为<code>catalogJson</code>的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.3.1.png" alt="5.4.1.7.2.9" tabindex="0" loading="lazy"><figcaption>5.4.1.7.2.9</figcaption></figure><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>100</code>，表示<strong>启动100个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里输入<code>5</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.3.2.png" alt="image-20220716093748583" tabindex="0" loading="lazy"><figcaption>image-20220716093748583</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>gulimall</code>，<code>端口号：</code>输入<code>80</code>，<code>路径</code>输入<code>/index/catalog.json</code></p><p>通过<code>nginx</code>负载均衡到这些<code>project</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.3.3.png" alt="image-20220716094914063" tabindex="0" loading="lazy"><figcaption>image-20220716094914063</figcaption></figure><h5 id="_4、执行测试" tabindex="-1"><a class="header-anchor" href="#_4、执行测试" aria-hidden="true">#</a> 4、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.4.gif" alt="GIF 2022-7-16 9-52-32" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 9-52-32</figcaption></figure><h5 id="_5、查看结果" tabindex="-1"><a class="header-anchor" href="#_5、查看结果" aria-hidden="true">#</a> 5、查看结果</h5><p>可以看到这次只查询了一次数据库</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.5.1.gif" alt="GIF 2022-7-16 9-54-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 9-54-15</figcaption></figure><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.5.2.png" alt="image-20220716100401468" tabindex="0" loading="lazy"><figcaption>image-20220716100401468</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.5.3.png" alt="image-20220716100423673" tabindex="0" loading="lazy"><figcaption>image-20220716100423673</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.3.5.4.png" alt="image-20220716100440990" tabindex="0" loading="lazy"><figcaption>image-20220716100440990</figcaption></figure><h4 id="_4、手动分布式锁" tabindex="-1"><a class="header-anchor" href="#_4、手动分布式锁" aria-hidden="true">#</a> 4、手动分布式锁</h4><p><strong>分布式锁演进-基本原理</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.0.png" alt="image-20220721210115751" tabindex="0" loading="lazy"><figcaption>image-20220721210115751</figcaption></figure><p>我们可以同时去一个地方“占坑”，如果占到，就执行逻辑。否则就必须等待，直到释放锁。</p><p>“占坑”可以去redis，可以去数据库，可以去任何大家都能访问的地方。 等待可以自旋的方式。</p><h5 id="_1、参考文档" tabindex="-1"><a class="header-anchor" href="#_1、参考文档" aria-hidden="true">#</a> 1、参考文档</h5><p>中文文档地址： https://www.redis.com.cn/commands/set.html</p>`,260),k=p("<p><strong>SET key value [EX seconds|PX milliseconds|KEEPTTL] [NX|XX] [GET]</strong></p><p>Redis SET 命令用于将键 <code>key</code> 设定为指定的“字符串”值。</p><p>如果 <code>key</code> 已经保存了一个值，那么这个操作会直接覆盖原来的值，并且忽略原始类型。</p><p>当 <code>set</code> 命令执行成功之后，之前设置的过期时间都将失效</p><p><strong>选项</strong></p><p>从2.6.12版本开始，redis为<code>SET</code>命令增加了一系列选项:</p>",6),m=p("<li><code>EX</code> <em>seconds</em> – 设置键key的过期时间，单位时秒</li><li><code>PX</code> <em>milliseconds</em> – 设置键key的过期时间，单位时毫秒</li><li><code>NX</code> – 只有键key不存在的时候才会设置key的值</li><li><code>XX</code> – 只有键key存在的时候才会设置key的值</li><li><code>KEEPTTL</code> -- 获取 key 的过期时间</li>",5),g={href:"https://www.redis.com.cn/commands/get.html",target:"_blank",rel:"noopener noreferrer"},v=n("strong",null,"注意:",-1),b=n("code",null,"SET",-1),h=n("code",null,"SETNX",-1),f={href:"https://www.redis.com.cn/commands/setex.html",target:"_blank",rel:"noopener noreferrer"},q={href:"https://www.redis.com.cn/commands/psetex.html",target:"_blank",rel:"noopener noreferrer"},y={href:"https://www.redis.com.cn/commands/getset.html",target:"_blank",rel:"noopener noreferrer"},w=n("p",null,[n("strong",null,"返回值")],-1),x={href:"https://www.redis.com.cn/topics/protocol.html#simple-string-reply",target:"_blank",rel:"noopener noreferrer"},_=n("code",null,"SET",-1),C=n("code",null,"OK",-1),z={href:"https://www.redis.com.cn/topics/protocol.html#bulk-string-reply",target:"_blank",rel:"noopener noreferrer"},S={href:"https://www.redis.com.cn/topics/protocol.html#nil-reply",target:"_blank",rel:"noopener noreferrer"},I=n("code",null,"NX",-1),j=n("code",null,"XX",-1),R={href:"https://www.redis.com.cn/commands/set.html",target:"_blank",rel:"noopener noreferrer"},E=n("p",null,[n("strong",null,"历史")],-1),P=p("<li><code>&gt;= 2.6.12</code>: Added the <code>EX</code>, <code>PX</code>, <code>NX</code> and <code>XX</code> options.</li><li><code>&gt;= 6.0</code>: Added the <code>KEEPTTL</code> option.</li>",2),A=n("code",null,">= 6.2",-1),L={href:"https://www.redis.com.cn/commands/get.html",target:"_blank",rel:"noopener noreferrer"},T=p(`<p><strong>例子</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SET mykey <span class="token string">&quot;Hello&quot;</span>
<span class="token string">&quot;OK&quot;</span>
redis<span class="token operator">&gt;</span> GET mykey
<span class="token string">&quot;Hello&quot;</span>
redis<span class="token operator">&gt;</span> SET anotherkey <span class="token string">&quot;will expire in a minute&quot;</span> EX <span class="token number">60</span>
<span class="token string">&quot;OK&quot;</span>
redis<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),F={href:"https://www.redis.com.cn/commands/set.html",target:"_blank",rel:"noopener noreferrer"},G=n("strong",null,"Note:",-1),N={href:"https://redis.io/topics/distlock",target:"_blank",rel:"noopener noreferrer"},M=p(`<p>命令 <code>SET resource-name anystring NX EX max-lock-time</code> 是一种用 Redis 来实现锁机制的简单方法。</p><p>如果上述命令返回<code>OK</code>，那么客户端就可以获得锁（如果上述命令返回Nil，那么客户端可以在一段时间之后重新尝试），并且可以通过<code>DEL</code>命令来释放锁。</p><p>客户端加锁之后，如果没有主动释放，会在过期时间之后自动释放。</p><p>可以通过如下优化使得上面的锁系统变得更加鲁棒：</p><ul><li>不要设置固定的字符串，而是设置为随机的大字符串，可以称为token。</li><li>通过脚步删除指定锁的key，而不是<code>DEL</code>命令。</li></ul><p>上述优化方法会避免下述场景：a客户端获得的锁（键key）已经由于过期时间到了被redis服务器删除，但是这个时候a客户端还去执行<code>DEL</code>命令。而b客户端已经在a设置的过期时间之后重新获取了这个同样key的锁，那么a执行<code>DEL</code>就会释放了b客户端加好的锁。</p><p>解锁脚本的一个例子将类似于以下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>if redis.call(&quot;get&quot;,KEYS[1]) == ARGV[1]
then
    return redis.call(&quot;del&quot;,KEYS[1])
else
    return 0
end
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个脚本执行方式如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>EVAL ...script... 1 resource-name token-value
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>可用版本&gt;= 1.0.0.</strong></p><p><strong>时间复杂度:</strong> O(1)</p>`,12),V=p(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.1.gif" alt="GIF 2022-7-16 10-00-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 10-00-15</figcaption></figure><h5 id="_2、redis命令获取锁" tabindex="-1"><a class="header-anchor" href="#_2、redis命令获取锁" aria-hidden="true">#</a> 2、<code>redis</code>命令获取锁</h5><p>进入<code>redis</code>的客户端，执行<code>set lock haha NX</code>即可获取锁</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker exec -it redis redis-cli
set lock haha NX
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1、复制当前会话" tabindex="-1"><a class="header-anchor" href="#_1、复制当前会话" aria-hidden="true">#</a> 1、复制当前会话</h6><p>点击<code>1 电商</code> ，右键选择<code>复制会话(D)</code>即可复制当前会话</p><p>双击<code>1 电商</code> 也可以复制当前会话</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.2.1.gif" alt="GIF 2022-7-16 10-16-12" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 10-16-12</figcaption></figure><h6 id="_2、多个会话同时执行命令" tabindex="-1"><a class="header-anchor" href="#_2、多个会话同时执行命令" aria-hidden="true">#</a> 2、多个会话同时执行命令</h6><p>在<code>Xshell</code>里依次点击 <code>查看(V)</code> -&gt; <code>撰写(C)</code> -&gt; <code>撰写栏(B)</code> 即可在<code>Xshell</code>下方打开<code>撰写栏</code></p><p>点击<code>撰写栏</code>的左边，选择<code>全部会话(A)</code>，在<code>撰写栏</code>发送的所有命名都会发送给所有会话</p><p>如在<code>撰写栏</code>里输入<code>docker exec -it redis redis-cli</code>命令，所有会话都执行了该命令</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.2.2.1.gif" alt="GIF 2022-7-16 10-19-01" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 10-19-01</figcaption></figure><p>在<code>Xshell</code>里点击<code>工具(T)</code>里 的<code>发送键输入到所有会话(K)</code>，在一个会话里输入的命令，也会同步发送给其他<code>发送键输入到所有会话。</code>状态为<code>开</code>的会话</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.2.2.2.gif" alt="GIF 2022-7-16 10-22-25" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 10-22-25</figcaption></figure><p>在一个会话的输入命令的地方右键选择<code>发送键输入到所有会话(K)</code>，在这个会话里输入的命令，也会同步发送给其他<code>发送键输入到所有会话。</code>状态为<code>开</code>的会话</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.2.2.3.gif" alt="GIF 2022-7-16 10-25-22" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 10-25-22</figcaption></figure><p>点击<code>发送键输入到所有会话。</code>右侧的<code>OFF</code>按钮后，别的会话发送<code>发送键输入到所有会话(K)</code>类型的命令该会话不会执行</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.2.2.4.png" alt="GIF 2022-7-16 20-11-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 20-11-40</figcaption></figure><h6 id="_3、获取锁" tabindex="-1"><a class="header-anchor" href="#_3、获取锁" aria-hidden="true">#</a> 3、获取锁</h6><p>所有会话执行<code>set lock haha NX</code>命令，可以看到只有<code>2 电商</code>获取到了锁</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.2.3.gif" alt="GIF 2022-7-16 10-20-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 10-20-14</figcaption></figure><h5 id="_3、简单分布式锁" tabindex="-1"><a class="header-anchor" href="#_3、简单分布式锁" aria-hidden="true">#</a> 3、简单分布式锁</h5><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.3.0.png" alt="image-20220721210223375" style="zoom:67%;"><p>问题：setnx占好了位，业务代码异常或者程序在页面过程 中宕机。没有执行删除锁逻辑，这就造成了死锁</p><p>解决：设置锁的自动过期，即使没有删除，会自动删除</p><p>本次可以完成分布式锁的功能，但是<code>getCatalogJsonForDb()</code>方法有可能抛出异常 <code>stringRedisTemplate.delete(&quot;lock&quot;);</code>删除锁就无法执行，导致锁一直无法释放，从而导致死锁</p><p>即使把<code>stringRedisTemplate.delete(&quot;lock&quot;);</code>删除锁的代码放到<code>finally</code>里面，也有可能出现机器<code>宕机</code>、<code>停电</code>等意外情况，导致<code>finally</code>里面的代码无法执行，从而导致无法删除锁</p><p>在<code>org.springframework.data.redis.core.ValueOperations</code>接口里的<code>setIfAbsent</code>方法相当于<code>SETNX</code>命令(与<code>set key value NX</code>一样)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.3.1.png" alt="image-20220716104241003" tabindex="0" loading="lazy"><figcaption>image-20220716104241003</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里，添加<code>getCatalogJsonForDbWithRedisLock</code>方法</p><p><a href="code/5.4.2.4.3.CategoryServiceImpl.java">点击查看<code>CategoryServiceImpl</code>类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取redis锁</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除锁</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁失败，休眠100ms后重试，synchronized</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//自旋锁</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.3.2.png" alt="image-20220716105028700" tabindex="0" loading="lazy"><figcaption>image-20220716105028700</figcaption></figure><h5 id="_4、添加过期时间" tabindex="-1"><a class="header-anchor" href="#_4、添加过期时间" aria-hidden="true">#</a> 4、添加过期时间</h5><p>问题：setnx设置好，正要去设置过期时间，宕机。又死锁了。</p><p>解决：设置过期时间和占位必须是原子的。redis支持使用<code>setnx ex</code>命令</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.4.0.png" alt="image-20220721210446105" style="zoom:67%;"><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里，修改<code>getCatalogJsonForDbWithRedisLock</code>方法</p><p>获取锁后可以修改该锁的过期时间，这样看似解决了机器<code>宕机</code>、<code>停电</code>等意外情况，导致无法删除锁的问题。</p><p>但是有可能在获取锁后，<code>stringRedisTemplate.expire(&quot;lock&quot;,30, TimeUnit.SECONDS);</code>修改该锁的过期时间之前机器<code>宕机</code>了，这样锁还是不会释放</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取redis锁</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//设置过期时间，必须和加锁是同步的，原子的</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除锁</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁失败，休眠100ms后重试，synchronized</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//自旋锁</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.4.png" alt="image-20220716105732979" tabindex="0" loading="lazy"><figcaption>image-20220716105732979</figcaption></figure><h5 id="_5、获取锁并设置过期时间" tabindex="-1"><a class="header-anchor" href="#_5、获取锁并设置过期时间" aria-hidden="true">#</a> 5、获取锁并设置过期时间</h5><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.5.0.png" alt="image-20220721210625076" style="zoom:67%;"><p>问题：</p><p>1、删除锁直接删除？？？</p><p>如果由于业务时间很长，锁自己过期了，我们 直接删除，有可能把别人正在持有的锁删除了。</p><p>解决：占锁的时候，值指定为uuid，每个人匹配是自己 的锁才删除。</p><p>上一步不能解决问题的原因根本上是<code>获取锁</code>和<code>设置过期时间</code>不是原子操作，这样就确保这两步<code>都执行</code>或<code>都不执行</code></p><p>因此设置过期时间，必须和加锁是同步的，原子的</p><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里，修改<code>getCatalogJsonForDbWithRedisLock</code>方法，保证<code>获取锁</code>和<code>设置过期时间</code>是原子的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取redis锁</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;111&quot;</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除锁</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁失败，休眠100ms后重试，synchronized</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//自旋锁</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.5.1.png" alt="image-20220716105834671" tabindex="0" loading="lazy"><figcaption>image-20220716105834671</figcaption></figure><p>执行语句大概相当于以下命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#进入redis的客户端</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis redis-cli
<span class="token comment">#获取锁并设置过期时间为30s</span>
<span class="token builtin class-name">set</span> lock <span class="token number">111</span> EX <span class="token number">30</span> NX
<span class="token comment">#查看该锁的过期时间(最终为-2)</span>
ttl lcok
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.5.2.gif" alt="GIF 2022-7-16 21-05-26" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 21-05-26</figcaption></figure><h5 id="_6、释放锁之前先判断" tabindex="-1"><a class="header-anchor" href="#_6、释放锁之前先判断" aria-hidden="true">#</a> 6、释放锁之前先判断</h5><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.6.0.png" alt="image-20220721210734185" style="zoom:67%;"><p>问题：如果正好判断是当前值，正要删除锁的时候，锁已经过期， 别人已经设置到了新的值。那么我们删除的是别人的锁</p><p>解决：删除锁必须保证原子性。使用redis+Lua脚本完成</p><p>有可能当前线程获取的锁已经过期了。然后别的线程也进来了，此时别的线程获取了这把锁。然后当前线程执行完业务代码后，把别的线程获取的锁给释放了。因此释放锁之前应先判断是不是自己的锁</p><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里，修改<code>getCatalogJsonForDbWithRedisLock</code>方法，释放锁之前应先判断是不是自己的锁</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取redis锁</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除锁</span>
        <span class="token class-name">String</span> lockValue <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lockValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁失败，休眠100ms后重试，synchronized</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//自旋锁</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.6.png" alt="image-20220716110950969" tabindex="0" loading="lazy"><figcaption>image-20220716110950969</figcaption></figure><h5 id="_7、判断并删除" tabindex="-1"><a class="header-anchor" href="#_7、判断并删除" aria-hidden="true">#</a> 7、判断并删除</h5><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.7.0.png" alt="image-20220721210834600" style="zoom:67%;"><p>String script = &quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&quot;;</p><p>保证加锁【占位+过期时间】和删除锁【判断+删除】的原子性。 更难的事情，锁的自动续期</p><p>在<code>释放锁之前应先判断是不是自己的锁</code>这个阶段，先获取当前锁的值，在当前线程获取到该锁的值后，有可能当前线程获取的锁到了过期时间，此时别的线程进入后，重新获取到了锁，此时当前线程获取的锁的值还是自己锁的值，从而导致删除了别的线程的锁</p><p>出现这种情况的原因还是因为<code>判断锁的值</code>和<code>删除该锁</code>不是原子操作，可以使用<code>lua</code>脚本，保证<code>判断锁的值</code>和<code>删除该锁</code>是原子操作</p><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里，修改<code>getCatalogJsonForDbWithRedisLock</code>方法，保证<code>判断锁的值</code>和<code>删除该锁</code>是原子操作</p><p>该操作可以保证不会<code>死锁</code>和<code>释放了别的线程的锁</code>，但是当前线程未执行完，锁有可能已经过期了，此时别的线程就可以占用了这个锁，因此应加上<code>自动续期</code>续期的功能</p>`,73),O={href:"https://www.redis.com.cn/commands/set.html",target:"_blank",rel:"noopener noreferrer"},D=p(`<div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;del&quot;</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.7.1.png" alt="image-20220716121842148" tabindex="0" loading="lazy"><figcaption>image-20220716121842148</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取redis锁</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//删除锁</span>
            <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call(&#39;get&#39;,KEYS[1]) == ARGV[1] then  return redis.call(&#39;del&#39;,KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// KEYS[1] 为 Arrays.asList(&quot;lock&quot;) ；ARGV[1] 为 uuid</span>
            <span class="token class-name">Long</span> lockValue <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">,</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lockValue<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> lockValue<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除成功...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除失败...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁失败，休眠100ms后重试，synchronized</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//自旋锁</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.2.4.7.2.png" alt="image-20220716123404456" tabindex="0" loading="lazy"><figcaption>image-20220716123404456</figcaption></figure><h3 id="_5-4-3、缓存-redisson分布式锁" tabindex="-1"><a class="header-anchor" href="#_5-4-3、缓存-redisson分布式锁" aria-hidden="true">#</a> 5.4.3、缓存-Redisson分布式锁</h3><p>官方文档： https://github.com/redisson/redisson/wiki/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.0.gif" alt="GIF 2022-7-16 14-36-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-16 14-36-13</figcaption></figure><h4 id="_1、使用redisson" tabindex="-1"><a class="header-anchor" href="#_1、使用redisson" aria-hidden="true">#</a> 1、使用<code>Redisson</code></h4><p>可以使用<code>Redisson</code>(Redis Java client with features of In-Memory Data Grid)来操作<code>redis</code>，进而了解<code>Redisson</code>的使用过程</p><p>后续可以使用<code>Redisson/Spring Boot Starter</code>来操作<code>redis</code></p><h5 id="_1、引入依赖" tabindex="-1"><a class="header-anchor" href="#_1、引入依赖" aria-hidden="true">#</a> 1、引入依赖</h5><p>在<code>Maven Repository </code>里查找<code>Redisson</code>： https://mvnrepository.com/artifact/org.redisson/redisson</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.1.1.png" alt="image-20220716145200593" tabindex="0" loading="lazy"><figcaption>image-20220716145200593</figcaption></figure><p>引入<code>redisson</code>，做分布式锁和分布式对象</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 引入redisson，做分布式锁和分布式对象 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.12.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.1.2.png" alt="image-20220716145354907" tabindex="0" loading="lazy"><figcaption>image-20220716145354907</figcaption></figure><h5 id="_2、添加配置" tabindex="-1"><a class="header-anchor" href="#_2、添加配置" aria-hidden="true">#</a> 2、添加配置</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config</code>包里新建<code>MyRedissonConfig</code>类，在<code>MyRedissonConfig</code>类里新建<code>redisson</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span></span><span class="token class-name">Redisson</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Config</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedissonConfig</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 所有对Redisson的使用都是通过RedissonClient对象
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod<span class="token operator">=</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、创建配置</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//config.useSingleServer().setAddress(&quot;192.168.56.10:6379&quot;).setPassword(&quot;&quot;);</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.56.10:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2、根据Config创建出RedissonClient示例</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.2.1.png" alt="image-20220716150239076" tabindex="0" loading="lazy"><figcaption>image-20220716150239076</figcaption></figure><p><strong>第三方框架整合的参考文档：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://github.com/redisson/redisson/wiki/14.-第三方框架整合
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod<span class="token operator">=</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useClusterServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">addNodeAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:7004&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:7001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CacheConfig</span><span class="token punctuation">&gt;</span></span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CacheConfig</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建一个名称为&quot;testMap&quot;的缓存，过期时间ttl为24分钟，同时最长空闲时maxIdleTime为12分钟。</span>
        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;testMap&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfig</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedissonSpringCacheManager</span><span class="token punctuation">(</span>redissonClient<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.2.2.png" alt="image-20220716150830328" tabindex="0" loading="lazy"><figcaption>image-20220716150830328</figcaption></figure><p><strong>单Redis节点模式的参考文档：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://github.com/redisson/redisson/wiki/2.-配置方法#26-单redis节点模式
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 默认连接地址 127.0.0.1:6379</span>
<span class="token class-name">RedissonClient</span> redisson <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;myredisserver:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RedissonClient</span> redisson <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.2.3.png" alt="image-20220716150909929" tabindex="0" loading="lazy"><figcaption>image-20220716150909929</figcaption></figure><h5 id="_3、添加测试方法" tabindex="-1"><a class="header-anchor" href="#_3、添加测试方法" aria-hidden="true">#</a> 3、添加测试方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.GulimallProductApplicationTests</code>测试类里添加如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redissonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redissonClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.3.png" alt="image-20220716150604827" tabindex="0" loading="lazy"><figcaption>image-20220716150604827</figcaption></figure><h5 id="_4、执行测试-1" tabindex="-1"><a class="header-anchor" href="#_4、执行测试-1" aria-hidden="true">#</a> 4、执行测试</h5><p>执行<code>redissonTest</code>方法，可以看到报了如下错误：错误的原因也指出来了<code>java.lang.IllegalArgumentException: Redis url should start with redis:// or rediss:// (for SSL connection)</code></p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code><span class="token property">java.lang.IllegalStateException:</span> Failed to load ApplicationContext

   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>DefaultCacheAwareContextLoaderDelegate<span class="token punctuation">.</span>loadContext<span class="token operator">(</span>DefaultCacheAwareContextLoaderDelegate<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">125</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span>DefaultTestContext<span class="token punctuation">.</span>getApplicationContext<span class="token operator">(</span>DefaultTestContext<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">108</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>web<span class="token punctuation">.</span>ServletTestExecutionListener<span class="token punctuation">.</span>setUpRequestContextIfNecessary<span class="token operator">(</span>ServletTestExecutionListener<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">190</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>web<span class="token punctuation">.</span>ServletTestExecutionListener<span class="token punctuation">.</span>prepareTestInstance<span class="token operator">(</span>ServletTestExecutionListener<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">132</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>TestContextManager<span class="token punctuation">.</span>prepareTestInstance<span class="token operator">(</span>TestContextManager<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">246</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>createTest<span class="token operator">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">227</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token operator">$</span>1<span class="token punctuation">.</span>runReflectiveCall<span class="token operator">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">289</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ReflectiveCallable<span class="token punctuation">.</span>run<span class="token operator">(</span>ReflectiveCallable<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>methodBlock<span class="token operator">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">291</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>runChild<span class="token operator">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">246</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>runChild<span class="token operator">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">97</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token operator">$</span>3<span class="token punctuation">.</span>run<span class="token operator">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">290</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token operator">$</span>1<span class="token punctuation">.</span>schedule<span class="token operator">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">71</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span>runChildren<span class="token operator">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">288</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span>access<span class="token operator">$</span><span class="token number">000</span><span class="token operator">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">58</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token operator">$</span>2<span class="token punctuation">.</span>evaluate<span class="token operator">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">268</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunBeforeTestClassCallbacks<span class="token punctuation">.</span>evaluate<span class="token operator">(</span>RunBeforeTestClassCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">61</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>statements<span class="token punctuation">.</span>RunAfterTestClassCallbacks<span class="token punctuation">.</span>evaluate<span class="token operator">(</span>RunAfterTestClassCallbacks<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">70</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runners<span class="token punctuation">.</span>ParentRunner<span class="token punctuation">.</span>run<span class="token operator">(</span>ParentRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">363</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>run<span class="token operator">(</span>SpringJUnit4ClassRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">190</span><span class="token operator">)</span>
   at org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>JUnitCore<span class="token punctuation">.</span>run<span class="token operator">(</span>JUnitCore<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">137</span><span class="token operator">)</span>
   at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>JUnit4IdeaTestRunner<span class="token punctuation">.</span>startRunnerWithArgs<span class="token operator">(</span>JUnit4IdeaTestRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">69</span><span class="token operator">)</span>
   at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>IdeaTestRunner<span class="token operator">$</span>Repeater<span class="token punctuation">.</span>startRunnerWithArgs<span class="token operator">(</span>IdeaTestRunner<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">33</span><span class="token operator">)</span>
   at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>JUnitStarter<span class="token punctuation">.</span>prepareStreamsAndStart<span class="token operator">(</span>JUnitStarter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">220</span><span class="token operator">)</span>
   at com<span class="token punctuation">.</span>intellij<span class="token punctuation">.</span>rt<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>JUnitStarter<span class="token punctuation">.</span>main<span class="token operator">(</span>JUnitStarter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">53</span><span class="token operator">)</span>
<span class="token property">Caused by:</span> <span class="token property">org.springframework.beans.factory.BeanCreationException:</span> Error creating bean with name <span class="token string">&#39;redisson&#39;</span> defined in class path resource <span class="token punctuation">[</span>com<span class="token operator">/</span>atguigu<span class="token operator">/</span>gulimall<span class="token operator">/</span>product<span class="token operator">/</span>config<span class="token operator">/</span>MyRedissonConfig<span class="token punctuation">.</span>class<span class="token punctuation">]</span><span class="token operator">:</span> Bean instantiation via factory method failed<span class="token operator">;</span> nested exception is org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>BeanInstantiationException<span class="token operator">:</span> Failed to instantiate <span class="token punctuation">[</span>org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span>RedissonClient<span class="token punctuation">]</span><span class="token operator">:</span> Factory method <span class="token string">&#39;redisson&#39;</span> threw exception<span class="token operator">;</span> nested exception is java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalArgumentException<span class="token operator">:</span> Redis url should start with redis<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> or rediss<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">(</span>for SSL connection<span class="token operator">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.4.1.png" alt="image-20220716150731143" tabindex="0" loading="lazy"><figcaption>image-20220716150731143</figcaption></figure><p>参考文档：<code>https://github.com/redisson/redisson/wiki/2.-配置方法#21-程序化配置方法</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">setTransportMode</span><span class="token punctuation">(</span><span class="token class-name">TransportMode</span><span class="token punctuation">.</span><span class="token constant">EPOLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span><span class="token function">useClusterServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//可以用&quot;rediss://&quot;来启用SSL连接</span>
      <span class="token punctuation">.</span><span class="token function">addNodeAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://127.0.0.1:7181&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.4.2.png" alt="image-20220716151118513" tabindex="0" loading="lazy"><figcaption>image-20220716151118513</figcaption></figure><h5 id="_5、修改配置" tabindex="-1"><a class="header-anchor" href="#_5、修改配置" aria-hidden="true">#</a> 5、修改配置</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.MyRedissonConfig</code>类里修改<code>redisson</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 所有对Redisson的使用都是通过RedissonClient对象
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
 */</span>
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod<span class="token operator">=</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、创建配置</span>
    <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Redis url should start with redis:// or rediss:// (for SSL connection)</span>
    <span class="token comment">//config.useSingleServer().setAddress(&quot;192.168.56.10:6379&quot;).setPassword(&quot;&quot;);</span>
    config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.56.10:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、根据Config创建出RedissonClient示例</span>
    <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.5.png" alt="image-20220716213623896" tabindex="0" loading="lazy"><figcaption>image-20220716213623896</figcaption></figure><h5 id="_6、重新测试" tabindex="-1"><a class="header-anchor" href="#_6、重新测试" aria-hidden="true">#</a> 6、重新测试</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.GulimallProductApplicationTests</code>测试类里执行<code>redissonTest</code>方法，可以看到这次执行成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.1.6.png" alt="image-20220716151536203" tabindex="0" loading="lazy"><figcaption>image-20220716151536203</figcaption></figure><h4 id="_2、-可重入锁-reentrant-lock" tabindex="-1"><a class="header-anchor" href="#_2、-可重入锁-reentrant-lock" aria-hidden="true">#</a> 2、 可重入锁（Reentrant Lock）</h4>`,47),B={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLock.html",target:"_blank",rel:"noopener noreferrer"},U=n("code",null,"RLock",-1),J=n("code",null,"java.util.concurrent.locks.Lock",-1),$={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockAsync.html",target:"_blank",rel:"noopener noreferrer"},W={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockReactive.html",target:"_blank",rel:"noopener noreferrer"},H={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockRx.html",target:"_blank",rel:"noopener noreferrer"},K=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RLock</span> lock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最常见的使用方法</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),X={href:"https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92",target:"_blank",rel:"noopener noreferrer"},Q=p(`<p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 加锁以后10秒钟自动解锁</span>
<span class="token comment">// 无需调用unlock方法手动解锁</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redisson同时还为分布式锁提供了异步执行的相关方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RLock</span> lock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),Y=n("code",null,"RLock",-1),Z=n("code",null,"IllegalMonitorStateException",-1),nn={href:"https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8#86-%E4%BF%A1%E5%8F%B7%E9%87%8Fsemaphore",target:"_blank",rel:"noopener noreferrer"},an=n("code",null,"Semaphore",-1),sn=p(`<p>官方文档：<code>https://github.com/redisson/redisson/wiki/8.-分布式锁和同步器</code></p><p>http://localhost:10000/hello</p><h5 id="_1、有看门狗" tabindex="-1"><a class="header-anchor" href="#_1、有看门狗" aria-hidden="true">#</a> 1、有看门狗</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.web.IndexController</code>类的<code>hello</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//1、获取一把锁，只要锁的名字一样，就是同一把锁</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;my-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、加锁</span>
    <span class="token comment">//阻塞式等待(其他线程不断地尝试获取这把锁)。默认加的锁都是30s时间。</span>
    <span class="token comment">//1)、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s。不用担心业务时间长，锁自动过期被删掉</span>
    <span class="token comment">//2)、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除。</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加锁成功。。。执行业务。。。&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//3、解锁</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁。。。&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.1.1.png" alt="image-20220716153633748" tabindex="0" loading="lazy"><figcaption>image-20220716153633748</figcaption></figure><p>启动<code>GulimallProductApplication</code>服务，访问： http://localhost:10000/hello 进行测试</p><p>可以看到当该线程未处理完时，会自动给锁延长过期时间(已过去<code>1/3过期时间</code>时<code>看门狗</code>开始自动续期)，不会出现该线程业务未处理完，别的线程可以获取到该锁的情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.1.2.gif" alt="GIF 2022-7-18 9-51-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 9-51-02</figcaption></figure><p>开启两个商品服务(<code>GulimallProductApplication</code>和<code>GulimallProductApplication - 10001</code>)，然后通过<code>GulimallGatewayApplication</code>网关访问，模拟集群环境，然后停掉已获得锁的服务，模拟<code>宕机</code>的情况，查看别的机器是否能获得锁</p><p>访问路径： http://localhost:88/hello</p><p>可以看到<code>GulimallProductApplication - 10001</code>获得锁后，停掉该服务。<code>GulimallProductApplication</code>服务在<code>GulimallProductApplication - 10001</code>服务的锁过期后依旧能获取到锁</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.1.3.gif" alt="GIF 2022-7-18 10-04-16" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 10-04-16</figcaption></figure><p>调用<code>lock.lock();</code>方法，如果没有获取到这把锁，没有获取到锁的线程不断地尝试获取这把锁(<code>阻塞式等待</code>)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.1.4.png" alt="image-20220718102213193" tabindex="0" loading="lazy"><figcaption>image-20220718102213193</figcaption></figure><h5 id="_2、无看门狗" tabindex="-1"><a class="header-anchor" href="#_2、无看门狗" aria-hidden="true">#</a> 2、无看门狗</h5><p>使用<code>lock.lock(10, TimeUnit.SECONDS); </code>方法，该线程业务没有处理完不会自动续期，别的线程也可以进入</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、获取一把锁，只要锁的名字一样，就是同一把锁</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;my-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、加锁</span>
    <span class="token comment">//阻塞式等待(其他线程不断地尝试获取这把锁)。默认加的锁都是30s时间。</span>
    <span class="token comment">//1)、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s。不用担心业务时间长，锁自动过期被删掉</span>
    <span class="token comment">//2)、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除。</span>
    <span class="token comment">//lock.lock();</span>

    <span class="token comment">//问题: lock. lock(10, TimeUnit. SECONDS); 在锁时间到了以后，不会自动续期。</span>
    <span class="token comment">//1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时就是我们指定的时间</span>
    <span class="token comment">//2、如果我们未指定锁的超时时间，就使用30 * 1000 [LockWatchdogTimeout看门狗的默认时间] ;</span>
    <span class="token comment">//只要占锁成功，就会启动一一个定时任务[重新给锁设置过期时间，新的过期时间就是看门门狗的默认时间]</span>
    <span class="token comment">//internallockleaseTime [看i门狗时间] / 3, 10s</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10秒自动解锁,自动解锁时间一-定要大于业务的执行时间。</span>
    <span class="token comment">//最佳实战 ：lock.lock(30, TimeUnit. SECONDS);省掉了整个续期操作。手动解锁</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加锁成功。。。执行业务。。。&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//3、解锁</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁。。。&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.2.1.png" alt="image-20220718163902337" tabindex="0" loading="lazy"><figcaption>image-20220718163902337</figcaption></figure><p>当前线程业务没有处理完不会自动续期，处理完后释放锁会报异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.2.2.gif" alt="GIF 2022-7-18 16-48-34" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-48-34</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>加锁成功。。。执行业务。。。99
释放锁。。。99
2022-07-18 16:56:22.611 ERROR 12492 --- [io-10000-exec-4] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalMonitorStateException: attempt to unlock lock, not locked by current thread by node id: c4f38ca8-3108-40a2-a8da-3c9d7ec1213f thread-id: 99] with root cause

java.lang.IllegalMonitorStateException: attempt to unlock lock, not locked by current thread by node id: c4f38ca8-3108-40a2-a8da-3c9d7ec1213f thread-id: 99
   at org.redisson.RedissonLock.lambda$unlockAsync$3(RedissonLock.java:580) ~[redisson-3.12.0.jar:3.12.0]
   at org.redisson.misc.RedissonPromise.lambda$onComplete$0(RedissonPromise.java:187) ~[redisson-3.12.0.jar:3.12.0]
   at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:500) ~[netty-common-4.1.39.Final.jar:4.1.39.Final]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.2.3.png" alt="image-20220718165656843" tabindex="0" loading="lazy"><figcaption>image-20220718165656843</figcaption></figure><p>(我的这个测试了几次，都是前一个线程执行完了，后一个线程才能获取到锁。按理说<code>redis</code>里面都没有锁了，应该不会获取不到锁呀)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.2.4.gif" alt="GIF 2022-7-18 17-04-18" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 17-04-18</figcaption></figure><h5 id="_3、非阻塞式等待" tabindex="-1"><a class="header-anchor" href="#_3、非阻塞式等待" aria-hidden="true">#</a> 3、非阻塞式等待</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、获取一把锁，只要锁的名字一样，就是同一把锁</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;my-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、加锁</span>
    <span class="token comment">//阻塞式等待(其他线程不断地尝试获取这把锁)。默认加的锁都是30s时间。</span>
    <span class="token comment">//1)、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s。不用担心业务时间长，锁自动过期被删掉</span>
    <span class="token comment">//2)、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除。</span>
    <span class="token comment">//lock.lock();</span>

    <span class="token comment">//问题: lock. lock(10, TimeUnit. SECONDS); 在锁时间到了以后，不会自动续期。</span>
    <span class="token comment">//1、如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时就是我们指定的时间</span>
    <span class="token comment">//2、如果我们未指定锁的超时时间，就使用30 * 1000 [LockWatchdogTimeout看门狗的默认时间] ;</span>
    <span class="token comment">//只要占锁成功，就会启动一一个定时任务[重新给锁设置过期时间，新的过期时间就是看门门狗的默认时间]</span>
    <span class="token comment">//internallockleaseTime [看i门狗时间] / 3, 10s</span>
    <span class="token comment">//lock.lock(10, TimeUnit.SECONDS); //10秒自动解锁,自动解锁时间一-定要大于业务的执行时间。</span>
    <span class="token comment">//最佳实战 ：lock.lock(30, TimeUnit. SECONDS);省掉了整个续期操作。手动解锁</span>

    <span class="token keyword">boolean</span> b <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加锁成功。。。执行业务。。。&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//3、解锁</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁。。。&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello=&gt;&quot;</span><span class="token operator">+</span>b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.3.1.png" alt="image-20220718172229790" tabindex="0" loading="lazy"><figcaption>image-20220718172229790</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.2.3.2.gif" alt="GIF 2022-7-18 17-19-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 17-19-14</figcaption></figure><h4 id="_3、-公平锁-fair-lock" tabindex="-1"><a class="header-anchor" href="#_3、-公平锁-fair-lock" aria-hidden="true">#</a> 3、 公平锁（Fair Lock）</h4><p><code>公平锁</code>是按照请求发出的先后顺序来处理请求，是<code>先进先出</code>的，而非向其他锁一样是<code>抢占式</code>的</p>`,31),tn=n("code",null,"java.util.concurrent.locks.Lock",-1),pn=n("code",null,"RLock",-1),en={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockAsync.html",target:"_blank",rel:"noopener noreferrer"},on={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockReactive.html",target:"_blank",rel:"noopener noreferrer"},cn={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RLockRx.html",target:"_blank",rel:"noopener noreferrer"},ln=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RLock</span> fairLock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最常见的使用方法</span>
fairLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),un={href:"https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92",target:"_blank",rel:"noopener noreferrer"},rn=p(`<p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 10秒钟以后自动解锁</span>
<span class="token comment">// 无需调用unlock方法手动解锁</span>
fairLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> fairLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
fairLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redisson同时还为分布式可重入公平锁提供了异步执行的相关方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RLock</span> fairLock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fairLock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fairLock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> fairLock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),dn=n("p",null,[a("官方文档："),n("code",null,"https://github.com/redisson/redisson/wiki/8.-分布式锁和同步器")],-1),kn=n("h4",{id:"_4、读写锁-readwritelock",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4、读写锁-readwritelock","aria-hidden":"true"},"#"),a(" 4、读写锁（ReadWriteLock）")],-1),mn={href:"http://static.javadoc.io/org.redisson/redisson/3.4.3/org/redisson/api/RReadWriteLock.html",target:"_blank",rel:"noopener noreferrer"},gn=n("code",null,"RReadWriteLock",-1),vn=n("code",null,"java.util.concurrent.locks.ReadWriteLock",-1),bn={href:"https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8#81-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81reentrant-lock",target:"_blank",rel:"noopener noreferrer"},hn=p(`<p>分布式可重入读写锁允许同时有多个读锁和一个写锁处于加锁状态。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RReadWriteLock</span> rwlock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyRWLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最常见的使用方法</span>
rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),fn={href:"https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92",target:"_blank",rel:"noopener noreferrer"},qn=p(`<p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 10秒钟以后自动解锁</span>
<span class="token comment">// 无需调用unlock方法手动解锁</span>
rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),yn=p(`<p>官方文档：<code>https://github.com/redisson/redisson/wiki/8.-分布式锁和同步器</code></p><h5 id="_1、读写锁测试" tabindex="-1"><a class="header-anchor" href="#_1、读写锁测试" aria-hidden="true">#</a> 1、读写锁测试</h5><p>http://localhost:10000/read</p><p>http://localhost:10000/write</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/read&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RReadWriteLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;rw-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ReentrantReadwriteLock writeLock = new ReentrantReadWriteLock();</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//加读锁</span>
    <span class="token class-name">RLock</span> rLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;writeValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        rLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//保证一定能读到最新数据，修改期间，写锁是一个排他锁(互斥锁、独享锁)。读锁是一个共享锁</span>
<span class="token comment">//写锁没释放读就必须等待</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/write&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">writeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RReadWriteLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;rw-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">RLock</span> rLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、改数据加写锁，读数据加读锁</span>
        rLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;writeValue&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        rLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.1.1.png" alt="image-20220718145647660" tabindex="0" loading="lazy"><figcaption>image-20220718145647660</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.1.2.gif" alt="GIF 2022-7-18 14-49-32" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 14-49-32</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.1.3.gif" alt="GIF 2022-7-18 14-54-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 14-54-38</figcaption></figure><h5 id="_2、修改代码" tabindex="-1"><a class="header-anchor" href="#_2、修改代码" aria-hidden="true">#</a> 2、修改代码</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/read&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RReadWriteLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;rw-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ReentrantReadwriteLock writeLock = new ReentrantReadWriteLock();</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//加读锁</span>
    <span class="token class-name">RLock</span> rLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;读锁加锁成功&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;writeValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        rLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;读锁释放&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//保证一定能读到最新数据，修改期间，写锁是一个排他锁(互斥锁、独享锁)。读锁是一个共享锁</span>
<span class="token comment">//写锁没释放读就必须等待</span>
<span class="token comment">//读 + 读: 相当于无锁，并发读，只会在redis中记录好，所有当前的读锁。他们都会同时加锁成功</span>
<span class="token comment">//写 + 读: 等待写锁释放</span>
<span class="token comment">//写 + 写: 阻塞方式</span>
<span class="token comment">//读 + 写: 有读锁。写也需要等待。</span>
<span class="token comment">//只要有写的存在，都必须等待</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/write&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">writeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RReadWriteLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;rw-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">RLock</span> rLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、改数据加写锁，读数据加读锁</span>
        rLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">&quot;写锁加锁成功... &quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;writeValue&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        rLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> <span class="token string">&quot;写锁释放&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.2.png" alt="image-20220718160814759" tabindex="0" loading="lazy"><figcaption>image-20220718160814759</figcaption></figure><h5 id="_3、测试读-读" tabindex="-1"><a class="header-anchor" href="#_3、测试读-读" aria-hidden="true">#</a> 3、测试<code>读 + 读</code></h5><p>第一次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.3.1.gif" alt="GIF 2022-7-18 15-55-55" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-55-55</figcaption></figure><p>第二次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.3.2.gif" alt="GIF 2022-7-18 15-57-29" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-57-29</figcaption></figure><p>第三次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.3.3.gif" alt="GIF 2022-7-18 15-58-29" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-58-29</figcaption></figure><h5 id="_4、测试写-读" tabindex="-1"><a class="header-anchor" href="#_4、测试写-读" aria-hidden="true">#</a> 4、测试<code>写 + 读</code></h5><p>第一次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.4.1.gif" alt="GIF 2022-7-18 15-50-12" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-50-12</figcaption></figure><p>第二次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.4.2.gif" alt="GIF 2022-7-18 15-53-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-53-02</figcaption></figure><p>第三次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.4.3.gif" alt="GIF 2022-7-18 15-26-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-26-15</figcaption></figure><h5 id="_5、测试写-写" tabindex="-1"><a class="header-anchor" href="#_5、测试写-写" aria-hidden="true">#</a> 5、测试<code>写 + 写</code></h5><p>第一次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.5.1.gif" alt="GIF 2022-7-18 15-39-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-39-31</figcaption></figure><p>第二次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.5.2.gif" alt="GIF 2022-7-18 15-46-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-46-46</figcaption></figure><p>第三次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.5.3.gif" alt="GIF 2022-7-18 15-47-45" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 15-47-45</figcaption></figure><h5 id="_6、测试读-写" tabindex="-1"><a class="header-anchor" href="#_6、测试读-写" aria-hidden="true">#</a> 6、测试<code>读 + 写</code></h5><p>第一次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.6.1.gif" alt="GIF 2022-7-18 16-02-03" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-02-03</figcaption></figure><p>第二次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.6.2.gif" alt="GIF 2022-7-18 16-03-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-03-38</figcaption></figure><p>第三次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.6.3.gif" alt="GIF 2022-7-18 16-04-59" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-04-59</figcaption></figure><h5 id="_7、读写锁存储结构" tabindex="-1"><a class="header-anchor" href="#_7、读写锁存储结构" aria-hidden="true">#</a> 7、读写锁存储结构</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.4.7.gif" alt="GIF 2022-7-18 16-14-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-14-13</figcaption></figure><h4 id="_5、信号量-semaphore" tabindex="-1"><a class="header-anchor" href="#_5、信号量-semaphore" aria-hidden="true">#</a> 5、信号量（Semaphore）</h4>`,42),wn={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphore.html",target:"_blank",rel:"noopener noreferrer"},xn=n("code",null,"RSemaphore",-1),_n=n("code",null,"java.util.concurrent.Semaphore",-1),Cn={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreAsync.html",target:"_blank",rel:"noopener noreferrer"},zn={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreReactive.html",target:"_blank",rel:"noopener noreferrer"},Sn={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreRx.html",target:"_blank",rel:"noopener noreferrer"},In=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;semaphore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//或</span>
semaphore<span class="token punctuation">.</span><span class="token function">acquireAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//或</span>
semaphore<span class="token punctuation">.</span><span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//或</span>
semaphore<span class="token punctuation">.</span><span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//或</span>
semaphore<span class="token punctuation">.</span><span class="token function">releaseAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),jn=p(`<p>官方文档：<code>https://github.com/redisson/redisson/wiki/8.-分布式锁和同步器</code></p><h5 id="_1、阻塞式等待" tabindex="-1"><a class="header-anchor" href="#_1、阻塞式等待" aria-hidden="true">#</a> 1、阻塞式等待</h5><p>访问： http://localhost:10000/park</p><p>访问： http://localhost:10000/go</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/park&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;park&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//阻塞式</span>
    park<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取一个信号，,占一个车位</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/go&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span>redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;park&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    park<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放一个车位</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.5.1.1.png" alt="image-20220718162522921" tabindex="0" loading="lazy"><figcaption>image-20220718162522921</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.5.1.2.gif" alt="GIF 2022-7-18 16-24-35" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-24-35</figcaption></figure><h5 id="_2、非阻塞式等待" tabindex="-1"><a class="header-anchor" href="#_2、非阻塞式等待" aria-hidden="true">#</a> 2、非阻塞式等待</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/park&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;park&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//阻塞式等待</span>
    <span class="token comment">//park.acquire();//获取一个信号，,占一个车位</span>
    <span class="token comment">//非阻塞式等待</span>
    <span class="token keyword">boolean</span> b <span class="token operator">=</span> park<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok=&gt;&quot;</span> <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/go&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;park&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    park<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放一个车位</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.5.2.1.png" alt="image-20220718163318725" tabindex="0" loading="lazy"><figcaption>image-20220718163318725</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.5.2.2.gif" alt="GIF 2022-7-18 16-32-01" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 16-32-01</figcaption></figure><h5 id="_3、分布式限流" tabindex="-1"><a class="header-anchor" href="#_3、分布式限流" aria-hidden="true">#</a> 3、分布式限流</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 车库停车
 * 3车位
 * 信号量也可以用作分布式限流;
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/park&quot;</span> <span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;park&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token comment">//阻塞式等待</span>
    <span class="token comment">//park.acquire();//获取一个信号，,占一个车位</span>
    <span class="token comment">//非阻塞式等待</span>
    <span class="token keyword">boolean</span> b <span class="token operator">=</span> park<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//执行业务</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok=&gt;&quot;</span><span class="token operator">+</span>b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/go&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;park&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    park<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放一个车位</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.5.3.png" alt="image-20220718172703326" tabindex="0" loading="lazy"><figcaption>image-20220718172703326</figcaption></figure><h4 id="_6、闭锁-countdownlatch" tabindex="-1"><a class="header-anchor" href="#_6、闭锁-countdownlatch" aria-hidden="true">#</a> 6、闭锁（CountDownLatch）</h4>`,15),Rn={href:"http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RCountDownLatch.html",target:"_blank",rel:"noopener noreferrer"},En=n("code",null,"RCountDownLatch",-1),Pn=n("code",null,"java.util.concurrent.CountDownLatch",-1),An=p(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RCountDownLatch</span> latch <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">&quot;anyCountDownLatch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
latch<span class="token punctuation">.</span><span class="token function">trySetCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在其他线程或其他JVM里</span>
<span class="token class-name">RCountDownLatch</span> latch <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">&quot;anyCountDownLatch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),Ln=p(`<p>官方文档：<code>https://github.com/redisson/redisson/wiki/8.-分布式锁和同步器</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 放假，锁门
 * 1班没人了，2
 * 5个班全部走完，我们可以锁大门
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/lockDoor&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">lockDoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RCountDownLatch</span> door <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">&quot;door&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">trySetCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待闭锁都完成</span>
    <span class="token keyword">return</span> <span class="token string">&quot;放假了...&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/gogogo/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">gogogo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RCountDownLatch</span> door <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">&quot;door&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计数减一;</span>
    <span class="token keyword">return</span> id <span class="token operator">+</span> <span class="token string">&quot;班的人都走了...&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.6.1.png" alt="image-20220718183034909" tabindex="0" loading="lazy"><figcaption>image-20220718183034909</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.6.2.gif" alt="GIF 2022-7-18 18-16-16" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 18-16-16</figcaption></figure><p>一定要保证先访问： http://localhost:10000/lockDoor 再访问 http://localhost:10000/gogogo/1</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.6.3.gif" alt="GIF 2022-7-18 18-17-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 18-17-15</figcaption></figure><h4 id="_7、添加" tabindex="-1"><a class="header-anchor" href="#_7、添加" aria-hidden="true">#</a> 7、添加</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里添加<code>getCatalogJsonForDbWithRedisson</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonForDbWithRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、锁的名字。锁的粒度， 越细越快。</span>
    <span class="token comment">//锁的粒度:具体缓存的是某个数据，11-号商品; product- 11-lock product-12-lock</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> catalogJsonForDb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改<code>getCatalogJson</code>方法，把</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>修改为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonForDb <span class="token operator">=</span> <span class="token function">getCatalogJsonForDbWithRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.7.png" alt="image-20220718190606032" tabindex="0" loading="lazy"><figcaption>image-20220718190606032</figcaption></figure><h4 id="_8、缓存数据一致性" tabindex="-1"><a class="header-anchor" href="#_8、缓存数据一致性" aria-hidden="true">#</a> 8、缓存数据一致性</h4><h5 id="_1、双写模式" tabindex="-1"><a class="header-anchor" href="#_1、双写模式" aria-hidden="true">#</a> 1、双写模式</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.8.1.png" alt="image-20220721211214914" tabindex="0" loading="lazy"><figcaption>image-20220721211214914</figcaption></figure><p>由于卡顿等原因，导致写缓存2在最前，写缓存1在后面就出现了不一致脏数据问题：</p><p>这是暂时性的脏数据问题，但是在数据稳定，缓存过期以后，又能得到最新的正确数据</p><p>读到的最新数据有延迟：最终一致性</p><h5 id="_2、失效模式" tabindex="-1"><a class="header-anchor" href="#_2、失效模式" aria-hidden="true">#</a> 2、失效模式</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.8.2.png" alt="image-20220721211304919" tabindex="0" loading="lazy"><figcaption>image-20220721211304919</figcaption></figure><p>我们系统的一致性解决方案：</p><p>1、缓存的所有数据都有过期时间，数据过期下一次查询触发主动更新</p><p>2、读写数据的时候，加上分布式的读写锁。 经常写，经常读</p><h5 id="_3、解决方案" tabindex="-1"><a class="header-anchor" href="#_3、解决方案" aria-hidden="true">#</a> 3、解决方案</h5><p>无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？</p><ol><li><p>如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加 上过期时间，每隔一段时间触发读的主动更新即可</p></li><li><p>如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。</p></li><li><p>缓存数据+过期时间也足够解决大部分业务对于缓存的要求。</p></li><li><p>通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心 脏数据，允许临时脏数据可忽略）；</p></li></ol><p><strong>总结：</strong></p><ul><li><p>我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保 证每天拿到当前最新数据即可。</p></li><li><p>我们不应该过度设计，增加系统的复杂性</p></li><li><p>遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。</p></li></ul><h5 id="_4、强一致性解决方案-canal" tabindex="-1"><a class="header-anchor" href="#_4、强一致性解决方案-canal" aria-hidden="true">#</a> 4、强一致性解决方案-Canal</h5><p>使用<code>Canal</code>更新缓存</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.8.4.1.png" alt="image-20220721211610540"><p>使用<code>Canal</code>解决数据异构</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.3.8.4.2.png" alt="image-20220721211810088" tabindex="0" loading="lazy"><figcaption>image-20220721211810088</figcaption></figure><h3 id="_5-4-4、springcache" tabindex="-1"><a class="header-anchor" href="#_5-4-4、springcache" aria-hidden="true">#</a> 5.4.4、<code>SpringCache</code></h3><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.0.png" alt="image-20220721212944809" tabindex="0" loading="lazy"><figcaption>image-20220721212944809</figcaption></figure><p>官方文档： https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.0.gif" alt="GIF 2022-7-18 19-15-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-18 19-15-46</figcaption></figure><h4 id="_1、springcache组成" tabindex="-1"><a class="header-anchor" href="#_1、springcache组成" aria-hidden="true">#</a> 1、<code>SpringCache</code>组成</h4><h5 id="_1、cachemanager" tabindex="-1"><a class="header-anchor" href="#_1、cachemanager" aria-hidden="true">#</a> 1、<code>CacheManager</code></h5><p>双击<code>Shift</code>，在搜索框中搜索<code>CacheManager</code>，可以看到<code>org.springframework.cache.CacheManager</code>类有<code>getCache</code>和<code>getCacheNames</code>两个方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2002-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Nullable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Spring&#39;s central cache manager SPI.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Allows for retrieving named <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Cache</span></span><span class="token punctuation">}</span> regions.
 *
 * <span class="token keyword">@author</span> Costin Leau
 * <span class="token keyword">@author</span> Sam Brannen
 * <span class="token keyword">@since</span> 3.1
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CacheManager</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Get the cache associated with the given name.
    * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Note that the cache may be lazily created at runtime if the
    * native provider supports it.
    * <span class="token keyword">@param</span> <span class="token parameter">name</span> the cache identifier (must not be <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>)
    * <span class="token keyword">@return</span> the associated cache, or <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span> if such a cache
    * does not exist or could be not created
    */</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token class-name">Cache</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Get a collection of the cache names known by this manager.
    * <span class="token keyword">@return</span> the names of all caches known by the cache manager
    */</span>
   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.1.png" alt="image-20220718192613795" tabindex="0" loading="lazy"><figcaption>image-20220718192613795</figcaption></figure><h5 id="_2、cache" tabindex="-1"><a class="header-anchor" href="#_2、cache" aria-hidden="true">#</a> 2、<code>Cache</code></h5><p>点击<code>Cache</code>类里面，可以看到在<code>org.springframework.cache.Cache</code>类里面定义的有缓存的<code>增删查改</code>等方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.2.png" alt="image-20220718192541559" tabindex="0" loading="lazy"><figcaption>image-20220718192541559</figcaption></figure><h5 id="_3、concurrentmapcachemanager" tabindex="-1"><a class="header-anchor" href="#_3、concurrentmapcachemanager" aria-hidden="true">#</a> 3、<code>ConcurrentMapCacheManager</code></h5><p>在<code>CacheManager</code>类里，按<code>ctrl+H</code>快捷键，可以看到<code>Spring</code>支持非常多的缓存管理器，打开<code>ConcurrentMapCacheManager</code>类</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.3.1.png" alt="image-20220718193327516" tabindex="0" loading="lazy"><figcaption>image-20220718193327516</figcaption></figure><p>在<code>org.springframework.cache.concurrent.ConcurrentMapCacheManager</code>类的构造器里可以输入需要管理的缓存的名字</p><p>该构造方法会调用本类的<code>setCacheNames</code>方法，并把传进来的不定长的<code>cacheNames</code>转为<code>List</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Construct a static ConcurrentMapCacheManager,
 * managing caches for the specified cache names only.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">ConcurrentMapCacheManager</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cacheNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">setCacheNames</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token doc-comment comment">/**
 * Specify the set of cache names for this CacheManager&#39;s &#39;static&#39; mode.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The number of caches and their names will be fixed after a call to this method,
 * with no creation of further cache regions at runtime.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Calling this with a <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span> collection argument resets the
 * mode to &#39;dynamic&#39;, allowing for further creation of caches again.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCacheNames</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheNames <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> cacheNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">createConcurrentMapCache</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dynamic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.3.2.png" alt="image-20220718193810047" tabindex="0" loading="lazy"><figcaption>image-20220718193810047</figcaption></figure><p>在<code>setCacheNames</code>方法里会遍历传进来的<code>cacheNames</code>，并把这些<code>name</code>作为<code>k</code>、调用<code>createConcurrentMapCache(name)</code>方法的返回值作为<code>v</code>放入本类的<code>cacheMap</code>属性里，本类的<code>cacheMap</code>对象其实就是<code>ConcurrentHashMap</code>类型</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Cache</span><span class="token punctuation">&gt;</span></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.3.3.png" alt="image-20220718193947559" tabindex="0" loading="lazy"><figcaption>image-20220718193947559</figcaption></figure><p><code>createConcurrentMapCache(name)</code>方法的返回的形式参数为<code>org.springframework.cache.Cache</code>，实际参数为<code>org.springframework.cache.concurrent.ConcurrentMapCache</code>，而<code>ConcurrentMapCache</code>继承<code>org.springframework.cache.support.AbstractValueAdaptingCache</code>，<code>AbstractValueAdaptingCache</code>实现<code>org.springframework.cache.Cache</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentMapCache</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractValueAdaptingCache</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractValueAdaptingCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.3.4.png" alt="image-20220718194203552" tabindex="0" loading="lazy"><figcaption>image-20220718194203552</figcaption></figure><h5 id="_4、concurrentmapcache" tabindex="-1"><a class="header-anchor" href="#_4、concurrentmapcache" aria-hidden="true">#</a> 4、<code>ConcurrentMapCache</code></h5><p>点进<code>ConcurrentMapCache</code>里面，可以看到<code>org.springframework.cache.concurrent.ConcurrentMapCache</code>类里有类型为<code>ConcurrentMap&lt;Object, Object&gt;</code>的<code>store</code>属性，该属性用于存储数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.4.1.png" alt="image-20220718194415502" tabindex="0" loading="lazy"><figcaption>image-20220718194415502</figcaption></figure><p>往下看，可以看到都是从<code>store</code>中获取数据的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.1.4.2.png" alt="image-20220718194619323" tabindex="0" loading="lazy"><figcaption>image-20220718194619323</figcaption></figure><h4 id="_2、引入springcache" tabindex="-1"><a class="header-anchor" href="#_2、引入springcache" aria-hidden="true">#</a> 2、引入<code>SpringCache</code></h4><h5 id="_1、导入依赖" tabindex="-1"><a class="header-anchor" href="#_1、导入依赖" aria-hidden="true">#</a> 1、导入依赖</h5><p>在<code>gulimall-product</code>模块的<code>pom.xml</code>里引入<code>SpringCache</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.1.png" alt="image-20220718195140052" tabindex="0" loading="lazy"><figcaption>image-20220718195140052</figcaption></figure><h5 id="_2、cacheautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_2、cacheautoconfiguration" aria-hidden="true">#</a> 2、<code>CacheAutoConfiguration</code></h5><p>缓存的自动配置类是<code>org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration</code>类，在<code>CacheAutoConfiguration</code>类里，缓存的所有属性都在<code>CacheProperties</code>类里封装着</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.2.png" alt="image-20220718195906577" tabindex="0" loading="lazy"><figcaption>image-20220718195906577</figcaption></figure><h5 id="_3、cacheproperties" tabindex="-1"><a class="header-anchor" href="#_3、cacheproperties" aria-hidden="true">#</a> 3、<code>CacheProperties</code></h5><p>在<code>org.springframework.boot.autoconfigure.cache.CacheProperties</code>类里的属性，在配置文件中都以<code>spring.cache</code>开始</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.3.png" alt="image-20220718200219087" tabindex="0" loading="lazy"><figcaption>image-20220718200219087</figcaption></figure><h5 id="_4、切换到cacheautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_4、切换到cacheautoconfiguration" aria-hidden="true">#</a> 4、切换到<code>CacheAutoConfiguration</code></h5><p>返回<code>CacheAutoConfiguration</code>类，其内部的<code>CacheConfigurationImportSelector</code>选择器里面又导了很多配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ImportSelector</span></span><span class="token punctuation">}</span> to add <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CacheType</span></span><span class="token punctuation">}</span> configuration classes.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfigurationImportSelector</span> <span class="token keyword">implements</span> <span class="token class-name">ImportSelector</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">CacheType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> imports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> types<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         imports<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CacheConfigurations</span><span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span>types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> imports<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.4.png" alt="image-20220718200424084" tabindex="0" loading="lazy"><figcaption>image-20220718200424084</figcaption></figure><h5 id="_5、cacheconfigurations" tabindex="-1"><a class="header-anchor" href="#_5、cacheconfigurations" aria-hidden="true">#</a> 5、<code>CacheConfigurations</code></h5><p>在<code>org.springframework.boot.autoconfigure.cache.CacheConfigurations</code>类的<code>getConfigurationClass</code>方法里，按照缓存的类型进行映射</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span> cacheType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configurationClass <span class="token operator">=</span> <span class="token constant">MAPPINGS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheType<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>configurationClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Unknown cache type &quot;</span> <span class="token operator">+</span> cacheType<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> configurationClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.5.1.png" alt="image-20220718200709725" tabindex="0" loading="lazy"><figcaption>image-20220718200709725</figcaption></figure><p>如果使用的是<code>redis</code>，就使用RedisCacheConfiguration配置类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CacheType</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token constant">MAPPINGS</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CacheType</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnumMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">GENERIC</span><span class="token punctuation">,</span> <span class="token class-name">GenericCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">EHCACHE</span><span class="token punctuation">,</span> <span class="token class-name">EhCacheCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">HAZELCAST</span><span class="token punctuation">,</span> <span class="token class-name">HazelcastCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">INFINISPAN</span><span class="token punctuation">,</span> <span class="token class-name">InfinispanCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">JCACHE</span><span class="token punctuation">,</span> <span class="token class-name">JCacheCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">COUCHBASE</span><span class="token punctuation">,</span> <span class="token class-name">CouchbaseCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">REDIS</span><span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">CAFFEINE</span><span class="token punctuation">,</span> <span class="token class-name">CaffeineCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">SIMPLE</span><span class="token punctuation">,</span> <span class="token class-name">SimpleCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">,</span> <span class="token class-name">NoOpCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token constant">MAPPINGS</span> <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.5.2.png" alt="image-20220718201112614" tabindex="0" loading="lazy"><figcaption>image-20220718201112614</figcaption></figure><h5 id="_6、rediscacheconfiguration" tabindex="-1"><a class="header-anchor" href="#_6、rediscacheconfiguration" aria-hidden="true">#</a> 6、<code>RedisCacheConfiguration</code></h5><p>在<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>类里，配置了缓存管理器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">,</span>
      <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">RedisCacheManagerBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span><span class="token function">determineConfiguration</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties<span class="token punctuation">.</span><span class="token function">getCacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">initialCacheNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customizerInvoker<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.6.png" alt="image-20220718201922910" tabindex="0" loading="lazy"><figcaption>image-20220718201922910</figcaption></figure><h5 id="_7、cacheproperties" tabindex="-1"><a class="header-anchor" href="#_7、cacheproperties" aria-hidden="true">#</a> 7、<code>CacheProperties</code></h5><p>在<code>org.springframework.boot.autoconfigure.cache.CacheProperties</code>类里如果配置了<code>spring.cache.cacheNames</code>，就可以获取到这些缓存的名字</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.7.png" alt="image-20220718202018699" tabindex="0" loading="lazy"><figcaption>image-20220718202018699</figcaption></figure><h5 id="_8、切换到rediscacheconfiguration" tabindex="-1"><a class="header-anchor" href="#_8、切换到rediscacheconfiguration" aria-hidden="true">#</a> 8、切换到<code>RedisCacheConfiguration</code></h5><p>切换到<code>RedisCacheConfiguration</code>类，在<code>cacheManager</code>方法获取到缓存的名字后，在<code>builder.initialCacheNames(new LinkedHashSet&lt;&gt;(cacheNames));</code>初始化缓存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.8.png" alt="image-20220718202231757" tabindex="0" loading="lazy"><figcaption>image-20220718202231757</figcaption></figure><h5 id="_9、rediscachemanager" tabindex="-1"><a class="header-anchor" href="#_9、rediscachemanager" aria-hidden="true">#</a> 9、<code>RedisCacheManager</code></h5><p>在<code>org.springframework.data.redis.cache.RedisCacheManager</code>类的<code>initialCacheNames</code>方法里</p><p>遍历<code>cacheNames</code>，使用默认缓存配置，把它们放到<code>cacheConfigMap</code>里面，并初始化缓存配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Append a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Set</span></span><span class="token punctuation">}</span> of cache names to be pre initialized with current <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">}</span>.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>NOTE:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> This calls depends on <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span><span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> using whatever
 * default <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">}</span> is present at the time of invoking this method.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">cacheNames</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
 * <span class="token keyword">@return</span> this <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheManagerBuilder</span></span><span class="token punctuation">}</span>.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManagerBuilder</span> <span class="token function">initialCacheNames</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">,</span> <span class="token string">&quot;CacheNames must not be null!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">&gt;</span></span> cacheConfigMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//遍历\`cacheNames\`，使用默认缓存配置，把它们放到\`cacheConfigMap\`里面</span>
   cacheNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> cacheConfigMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> defaultCacheConfiguration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//初始化缓存配置</span>
   <span class="token keyword">return</span> <span class="token function">withInitialCacheConfigurations</span><span class="token punctuation">(</span>cacheConfigMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.9.1.png" alt="image-20220718202707460" tabindex="0" loading="lazy"><figcaption>image-20220718202707460</figcaption></figure><p><code>withInitialCacheConfigurations(cacheConfigMap)</code>方法会把类型为<code>Map&lt;String, RedisCacheConfiguration&gt;</code>的<code>cacheConfigMap</code>放到同样类型的<code>initialCaches</code>里面</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">&gt;</span></span> initialCaches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Append a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Map</span></span><span class="token punctuation">}</span> of cache name/<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">}</span> pairs to be pre initialized.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">cacheConfigurations</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
 * <span class="token keyword">@return</span> this <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheManagerBuilder</span></span><span class="token punctuation">}</span>.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManagerBuilder</span> <span class="token function">withInitialCacheConfigurations</span><span class="token punctuation">(</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">&gt;</span></span> cacheConfigurations<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>cacheConfigurations<span class="token punctuation">,</span> <span class="token string">&quot;CacheConfigurations must not be null!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   cacheConfigurations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span>
         <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;RedisCacheConfiguration for cache %s must not be null!&quot;</span><span class="token punctuation">,</span> cacheName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>initialCaches<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>cacheConfigurations<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.9.2.png" alt="image-20220718202932830" tabindex="0" loading="lazy"><figcaption>image-20220718202932830</figcaption></figure><p><code>initialCaches</code>属性的类型为<code>Map&lt;String, RedisCacheConfiguration&gt;</code>，其中<code>String</code>存放了缓存的名字，<code>RedisCacheConfiguration</code>存放了<code>RedisCacheConfiguration.defaultCacheConfig()</code>方法返回的默认的<code>RedisCacheConfiguration</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">&gt;</span></span> initialCaches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.9.3.png" alt="image-20220718203136409" tabindex="0" loading="lazy"><figcaption>image-20220718203136409</figcaption></figure><h5 id="_10、切换到rediscacheconfiguration" tabindex="-1"><a class="header-anchor" href="#_10、切换到rediscacheconfiguration" aria-hidden="true">#</a> 10、切换到<code>RedisCacheConfiguration</code></h5><p>切换到<code>RedisCacheConfiguration</code>，在<code>cacheManager</code>方法里调用了<code>determineConfiguration</code>方法，<code>determineConfiguration</code>方法里如果<code>ioc</code>容器中不存在<code>RedisCacheConfiguration</code>则会进行默认配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">,</span>
      <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">RedisCacheManagerBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span><span class="token function">determineConfiguration</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties<span class="token punctuation">.</span><span class="token function">getCacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">initialCacheNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customizerInvoker<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> <span class="token function">determineConfiguration</span><span class="token punctuation">(</span>
      <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">Redis</span> redisProperties <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span>
         <span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>
         <span class="token class-name">SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//序列化机制</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//过期时间</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//前缀</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//要不要缓存空数据</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//是否使用缓存的前缀</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.2.10.png" alt="image-20220718203626286" tabindex="0" loading="lazy"><figcaption>image-20220718203626286</figcaption></figure><h4 id="_3、添加配置" tabindex="-1"><a class="header-anchor" href="#_3、添加配置" aria-hidden="true">#</a> 3、添加配置</h4><p>在<code>gulimall-product</code>模块的<code>src/main/resources</code>目录下新建<code>application.properties</code>配置文件，在该配置文件内添加配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#缓存的类型</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>

<span class="token comment">#缓存的名字</span>
<span class="token comment">#如果配置了缓存的名字，则只能使用这些名字</span>
<span class="token comment">#系统中用到哪些缓存了，帮你创建出来</span>
<span class="token comment">#spring.cache.cache-names=qq,qqq</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.3.1.png" alt="image-20220718204448764" tabindex="0" loading="lazy"><figcaption>image-20220718204448764</figcaption></figure><p>在<code>org.springframework.boot.autoconfigure.cache.CacheProperties</code>类的<code>cacheNames</code>字段上有一段注释</p><p>如果底层缓存管理器支持，要创建的缓存名称的逗号分隔列表。 通常，这会禁用动态创建附加缓存的能力。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Comma-separated list of cache names to create if supported by the underlying cache
 * manager. Usually, this disables the ability to create additional caches on-the-fly.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.3.2.png" alt="image-20220718204336191" tabindex="0" loading="lazy"><figcaption>image-20220718204336191</figcaption></figure><h4 id="_4、常用注解-1" tabindex="-1"><a class="header-anchor" href="#_4、常用注解-1" aria-hidden="true">#</a> 4、常用注解(1)</h4><p>For caching declaration, Spring’s caching abstraction provides a set of Java annotations:</p><ul><li><code>@Cacheable</code>: Triggers cache population. 触发缓存填充 (触发将数据保存到缓存的操作)</li><li><code>@CacheEvict</code>: Triggers cache eviction. 触发缓存驱逐 (触发将数据从缓存删除的操作)</li><li><code>@CachePut</code>: Updates the cache without interfering with the method execution. 在不干扰方法执行的情况下更新缓存 (不影响方法执行更新缓存)</li><li><code>@Caching</code>: Regroups multiple cache operations to be applied on a method. 重新组合多个缓存操作以应用于一个方法 (组合以上多个操作)</li><li><code>@CacheConfig</code>: Shares some common cache-related settings at class-level. 在类级别共享一些常见的缓存相关设置 (在类级别共享缓存的相同配置)</li></ul><h5 id="_1、-enablecaching开启缓存功能" tabindex="-1"><a class="header-anchor" href="#_1、-enablecaching开启缓存功能" aria-hidden="true">#</a> 1、<code>@EnableCaching</code>开启缓存功能</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>启动类上添加<code>@EnableCaching</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.atguigu.gulimall.product.feign&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.atguigu.gulimall.product.dao&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallProductApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GulimallProductApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.4.1.png" alt="image-20220718205852014" tabindex="0" loading="lazy"><figcaption>image-20220718205852014</figcaption></figure><h5 id="_2、-cacheable添加缓存" tabindex="-1"><a class="header-anchor" href="#_2、-cacheable添加缓存" aria-hidden="true">#</a> 2、<code>@Cacheable</code>添加缓存</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的<code>getLevel1Categories</code>方法。添加<code>@Cacheable</code>注解，代表当前方法的结果需要缓存，如果缓存中有，方法不用调用。如果缓存中没有，会调用方法，最后将方法的结果放入缓存。<code>value = {&quot;category&quot;}</code>，指定放到名为<code>category</code>的分区下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//每一个需要缓存的数据我们都来指定要放到那个名字的缓存。[ 缓存的分区(按照业务类型分)]</span>
<span class="token comment">//代表当前方法的结果需要缓存，如果缓存中有，方法不用调用。如果缓存中没有，会调用方法，最后将方法的结果放入缓存</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getLevel1Categories...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getParentCid</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getCatId</span><span class="token punctuation">,</span> <span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//long start = System.currentTimeMillis();</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//long end = System.currentTimeMillis();</span>
    <span class="token comment">//System.out.println(&quot;消耗时间：&quot;+(end-start));</span>
    <span class="token keyword">return</span> categoryEntities<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.4.2.png" alt="image-20220718210308329" tabindex="0" loading="lazy"><figcaption>image-20220718210308329</figcaption></figure><h5 id="_3、测试-1" tabindex="-1"><a class="header-anchor" href="#_3、测试-1" aria-hidden="true">#</a> 3、测试</h5><p>如果缓存中没有数据，会调用方法，最后将方法的结果放入缓存。如果缓存中有，方法不用调用，直接返回数据</p><p>可以看到已经自动缓存数据了，但是<code>key</code>不是我们指定的，过期时间也为<code>-1</code>(永不过期)、数据的格式也不为<code>JSON</code></p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.4.3.gif" alt="GIF 2022-7-18 21-11-35" style="zoom:50%;"><h5 id="_4、-cacheable可选参数" tabindex="-1"><a class="header-anchor" href="#_4、-cacheable可选参数" aria-hidden="true">#</a> 4、<code>@Cacheable</code>可选参数</h5><p>在<code>org.springframework.cache.annotation.Cacheable</code>注解接口里</p><p><code>value</code>起了个别名叫<code>cacheNames</code></p><p><code>cacheNames</code>起了个别名叫<code>value</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Documented</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ElementType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Inherited</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Retention</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RetentionPolicy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Callable</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">AliasFor</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Cacheable</span> <span class="token punctuation">{</span>

  <span class="token doc-comment comment">/**
   * Alias for <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">cacheNames</span></span><span class="token punctuation">}</span>.
   */</span>
  <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span><span class="token string">&quot;cacheNames&quot;</span><span class="token punctuation">)</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * Names of the caches in which method invocation results are stored.
   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Names may be used to determine the target cache (or caches), matching
   * the qualifier value or bean name of a specific bean definition.
   * <span class="token keyword">@since</span> 4.2
   * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">value</span></span>
   * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">CacheConfig</span><span class="token punctuation">#</span><span class="token field">cacheNames</span></span>
   */</span>
  <span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">cacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">keyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">cacheResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> <span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">boolean</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.4.4.1.png" alt="image-20220718212829162" tabindex="0" loading="lazy"><figcaption>image-20220718212829162</figcaption></figure><p>其他参数代表如下意思：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//指定k值是什么(支持SpringEL)(如果不是EL表达式，需要加上单引号)</span>
<span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//k的生成器</span>
<span class="token class-name">String</span> <span class="token function">keyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//指定使用哪个缓存管理器</span>
<span class="token class-name">String</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//缓存用的条件(把哪些数据放到缓存里面，可以接收一个表达式)</span>
<span class="token class-name">String</span> <span class="token function">condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//除了指定的情况外，其他情况都向缓存中保存数据</span>
<span class="token class-name">String</span> <span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//设置是否使用同步方式(如果是同步方式，unless就不可用)</span>
<span class="token keyword">boolean</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.4.4.2.png" alt="image-20220718212426919" tabindex="0" loading="lazy"><figcaption>image-20220718212426919</figcaption></figure><p>官方文档： https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache</p><p>支持的EL表达式</p><table><thead><tr><th style="text-align:left;">Name</th><th style="text-align:left;">Location</th><th style="text-align:left;">Description</th><th style="text-align:left;">Example</th></tr></thead><tbody><tr><td style="text-align:left;"><code>methodName</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The name of the method being invoked</td><td style="text-align:left;"><code>#root.methodName</code></td></tr><tr><td style="text-align:left;"><code>method</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The method being invoked</td><td style="text-align:left;"><code>#root.method.name</code></td></tr><tr><td style="text-align:left;"><code>target</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The target object being invoked</td><td style="text-align:left;"><code>#root.target</code></td></tr><tr><td style="text-align:left;"><code>targetClass</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The class of the target being invoked</td><td style="text-align:left;"><code>#root.targetClass</code></td></tr><tr><td style="text-align:left;"><code>args</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The arguments (as array) used for invoking the target</td><td style="text-align:left;"><code>#root.args[0]</code></td></tr><tr><td style="text-align:left;"><code>caches</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">Collection of caches against which the current method is run</td><td style="text-align:left;"><code>#root.caches[0].name</code></td></tr><tr><td style="text-align:left;">Argument name</td><td style="text-align:left;">Evaluation context</td><td style="text-align:left;">Name of any of the method arguments. If the names are not available (perhaps due to having no debug information), the argument names are also available under the <code>#a&lt;#arg&gt;</code> where <code>#arg</code> stands for the argument index (starting from <code>0</code>).</td><td style="text-align:left;"><code>#iban</code> or <code>#a0</code> (you can also use <code>#p0</code> or <code>#p&lt;#arg&gt;</code> notation as an alias).</td></tr><tr><td style="text-align:left;"><code>result</code></td><td style="text-align:left;">Evaluation context</td><td style="text-align:left;">The result of the method call (the value to be cached). Only available in <code>unless</code> expressions, <code>cache put</code> expressions (to compute the <code>key</code>), or <code>cache evict</code> expressions (when <code>beforeInvocation</code> is <code>false</code>). For supported wrappers (such as <code>Optional</code>), <code>#result</code> refers to the actual object, not the wrapper.</td><td style="text-align:left;"><code>#result</code></td></tr></tbody></table><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.4.4.3.png" alt="image-20220718213355681" tabindex="0" loading="lazy"><figcaption>image-20220718213355681</figcaption></figure><h4 id="_5、需求" tabindex="-1"><a class="header-anchor" href="#_5、需求" aria-hidden="true">#</a> 5、需求</h4><h5 id="_1、指定key" tabindex="-1"><a class="header-anchor" href="#_1、指定key" aria-hidden="true">#</a> 1、指定<code>key</code></h5><p>可以在<code>key</code>的值的字符串里加上<code>&#39;</code>单引号(<code>key = &quot;&#39;xxx&#39;&quot;</code>)，指明不使用<code>SpEL</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 1、每一个需要缓存的数据我们都来指定要放到那个名字的缓存。[ 缓存的分区(按照业务类型分)]
 * 2、@Cacheable(<span class="token punctuation">{</span>&quot;category&quot;<span class="token punctuation">}</span>)
 *   代表当前方法的结果需要缓存，如果缓存中有，方法不用调用。
 *   如果缓存中没有，会调用方法，最后将方法的结果放入缓存
 * 3、默认行为
 *   1)、如果缓存中有，方法不用调用。
 *   2)、key默认自动生成;缓存的名字::SimpleKey []( 自主生成的key值)
 *   3)、缓存的value的值。默认使用jdk序列化机制，将序列化后的数据存到redis
 * 4)、默认ttl时间-1; .
 * 自定义:
 *   1)、指定生成的缓存使用的key:
 *     key属性指定，接受一个SpEL
 *     SpEL的详细https ://docs.spring. io/spring/docs/5.1.12. REL EASE/spring-framework-re.
 *   2)、指定缓存的数据的存活时间:配置文件中 修改ttL
 *   3)、将数据保存为json格式
 **/</span>

<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;&#39;level1Categories&#39;&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getLevel1Categories...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getParentCid</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getCatId</span><span class="token punctuation">,</span> <span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//long start = System.currentTimeMillis();</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//long end = System.currentTimeMillis();</span>
    <span class="token comment">//System.out.println(&quot;消耗时间：&quot;+(end-start));</span>
    <span class="token keyword">return</span> categoryEntities<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.5.1.png" alt="image-20220718214321219" tabindex="0" loading="lazy"><figcaption>image-20220718214321219</figcaption></figure><h5 id="_2、指定过期时间" tabindex="-1"><a class="header-anchor" href="#_2、指定过期时间" aria-hidden="true">#</a> 2、指定过期时间</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>类里添加<code>key</code>为<code>spring.cache.redis.time-to-live</code>的属性可以指定缓存的过期时间(以<code>ms</code>(毫秒)为单位)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>spring<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>time<span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>live<span class="token operator">=</span><span class="token number">3600000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.5.2.png" alt="image-20220718214404174" tabindex="0" loading="lazy"><figcaption>image-20220718214404174</figcaption></figure><h5 id="_3、使用json存储" tabindex="-1"><a class="header-anchor" href="#_3、使用json存储" aria-hidden="true">#</a> 3、使用<code>JSON</code>存储</h5><p>使用<code>JSON</code>存储，不可以直接通过配置文件或参数的方式指定，需要自定义<code>RedisCacheConfiguration</code></p><h4 id="_6、自定义rediscacheconfiguration" tabindex="-1"><a class="header-anchor" href="#_6、自定义rediscacheconfiguration" aria-hidden="true">#</a> 6、自定义<code>RedisCacheConfiguration</code></h4><h5 id="_1、rediscacheconfiguration" tabindex="-1"><a class="header-anchor" href="#_1、rediscacheconfiguration" aria-hidden="true">#</a> 1、<code>RedisCacheConfiguration</code></h5><p>查看<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>类，<code>Redis缓存管理器</code>调用了<code>确定配置</code>的方法，用于确定使用什么配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">,</span>
      <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">RedisCacheManagerBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span><span class="token function">determineConfiguration</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties<span class="token punctuation">.</span><span class="token function">getCacheNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">initialCacheNames</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cacheNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customizerInvoker<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而<code>确定配置</code>的方法里，判断如果本类的<code>redis缓存配置</code>存在，就使用存在的缓存配置</p><p>如果不存在就是使用默认的缓存配置</p><p>如果<code>ioc</code>容器中存在<code>redis缓存配置</code>，就赋值到本类的<code>redis缓存配置</code>属性里</p><p><a href="code/5.4.4.6.1.RedisCacheConfiguration.java">点击查看<code>RedisCacheConfiguration</code>类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> <span class="token function">determineConfiguration</span><span class="token punctuation">(</span>
      <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">Redis</span> redisProperties <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span>
         <span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>
         <span class="token class-name">SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.1.png" alt="image-20220720145109609" tabindex="0" loading="lazy"><figcaption>image-20220720145109609</figcaption></figure><h5 id="_2、rediscacheconfiguration" tabindex="-1"><a class="header-anchor" href="#_2、rediscacheconfiguration" aria-hidden="true">#</a> 2、<code>RedisCacheConfiguration</code></h5><p>点击</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> redisCacheConfiguration<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>里的<code>RedisCacheConfiguration</code>，即可看到<code>org.springframework.data.redis.cache.RedisCacheConfiguration</code>的<code>RedisCacheConfiguration</code></p><p>这里就有<code>keySerializationPair</code>(键序列化对)和<code>valueSerializationPair</code>(值序列化对)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.2.1.png" alt="image-20220720145752451" tabindex="0" loading="lazy"><figcaption>image-20220720145752451</figcaption></figure><p>在<code>defaultCacheConfig</code>方法的文档注释里可以看到，<code>key</code>使用了<code>StringRedisSerializer</code>来序列化，<code>value</code>使用<code>JdkSerializationRedisSerializer</code>来序列化</p><p><a href="code/5.4.4.6.2.RedisCacheConfiguration.java">点击查看<code>RedisCacheConfiguration</code>类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Default <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">}</span> using the following:
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>key expiration<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>eternal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>cache null values<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>prefix cache keys<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>default prefix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>[the actual cache name]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>key serializer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>value serializer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">JdkSerializationRedisSerializer</span></span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">&gt;</span></span>conversion service<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultFormattingConversionService</span></span><span class="token punctuation">}</span> with <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">registerDefaultConverters</span><span class="token punctuation">(</span><span class="token class-name">ConverterRegistry</span><span class="token punctuation">)</span></span> default<span class="token punctuation">}</span>
 * cache key converters<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token keyword">@return</span> new <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">}</span>.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.2.2.png" alt="image-20220720145809659" tabindex="0" loading="lazy"><figcaption>image-20220720145809659</figcaption></figure><h5 id="_3、编写myrediscacheconfig类" tabindex="-1"><a class="header-anchor" href="#_3、编写myrediscacheconfig类" aria-hidden="true">#</a> 3、编写<code>MyRedisCacheConfig</code>类</h5><p>可以参考<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>类的<code>determineConfiguration</code>方法的写法，编写<code>org.springframework.data.redis.cache.RedisCacheConfiguration</code>类型的<code>Bean</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.3.0.png" alt="image-20220720151648207" tabindex="0" loading="lazy"><figcaption>image-20220720151648207</figcaption></figure><p>删掉<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>启动类的<code>@EnableCaching</code>注解</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.3.1.png" alt="image-20220720150049487" tabindex="0" loading="lazy"><figcaption>image-20220720150049487</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config</code>包下新建<code>MyRedisCacheConfig</code>配置类，在该配置类里编写类型为<code>org.springframework.data.redis.cache.RedisCacheConfiguration</code>的<code>Bean</code> <strong>(不要导错包了)</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.3.2.png" alt="image-20220720151543631" tabindex="0" loading="lazy"><figcaption>image-20220720151543631</figcaption></figure><p><s>进入<code>org.springframework.data.redis.serializer.RedisSerializer</code>，然后按<code>ctrl+H</code>查看其子类，可以看到有<code>String</code>类型和<code>Json</code>类型的序列化方式，<code>spring</code>框架提供的<code>org.springframework.data.redis.serializer.StringRedisSerializer</code> ，阿里提供的<code>com.alibaba.fastjson.support.spring.FastJsonRedisSerializer</code>，阿里提供的<code>com.alibaba.fastjson.support.spring.GenericFastJsonRedisSerializer</code></s> 带了<code>Generic</code>的可以兼容任意类型，因此需要选择带<code>Generic</code>的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.3.3.png" alt="image-20220720151527159" tabindex="0" loading="lazy"><figcaption>image-20220720151527159</figcaption></figure><p>完整代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/20
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedisCacheConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.3.4.png" alt="image-20220720152347608" tabindex="0" loading="lazy"><figcaption>image-20220720152347608</figcaption></figure><h5 id="_4、测试" tabindex="-1"><a class="header-anchor" href="#_4、测试" aria-hidden="true">#</a> 4、测试</h5><p>删掉以前的在<code>redis</code>里的<code>category（1）</code>数据，刷新 http://localhost:10000/ 页面，在新生成的<code>category（1）</code>可以看到，数据并没有变为<code>JSON</code>格式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.4.gif" alt="GIF 2022-7-20 15-29-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 15-29-31</figcaption></figure><h5 id="_5、修改rediscacheconfiguration方法" tabindex="-1"><a class="header-anchor" href="#_5、修改rediscacheconfiguration方法" aria-hidden="true">#</a> 5、修改<code>redisCacheConfiguration</code>方法</h5><p>重新修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.MyRedisCacheConfig</code>类的<code>redisCacheConfiguration</code>方法</p><p>每一步设置都会返回一个新的<code>RedisCacheConfiguration</code>，因此应该覆盖老的<code>config</code>。(参照<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>类的<code>determineConfiguration</code>方法的做法)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/20
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedisCacheConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.5.png" alt="image-20220720160907935" tabindex="0" loading="lazy"><figcaption>image-20220720160907935</figcaption></figure><h5 id="_6、再次测试" tabindex="-1"><a class="header-anchor" href="#_6、再次测试" aria-hidden="true">#</a> 6、再次测试</h5><p>删掉以前的在<code>redis</code>里的<code>category（1）</code>数据，刷新 http://localhost:10000/ 页面，在新生成的<code>category（1）</code>可以看到，这次成功返回了<code>JSON</code>数据，但是<code>TTL</code>为<code>-1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.6.gif" alt="GIF 2022-7-20 16-08-11" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 16-08-11</figcaption></figure><h5 id="json序列化" tabindex="-1"><a class="header-anchor" href="#json序列化" aria-hidden="true">#</a> 📝 <code>JSON</code>序列化</h5><p>进入<code>org.springframework.data.redis.serializer.RedisSerializer</code>，然后按<code>ctrl+H</code>查看其子类，可以看到有<code>String</code>类型和<code>Json</code>类型的序列化方式，<code>spring</code>框架提供的<code>org.springframework.data.redis.serializer.StringRedisSerializer</code> ，<code>spring</code>框架提供的<code>org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer</code>，阿里提供的<code>com.alibaba.fastjson.support.spring.GenericFastJsonRedisSerializer</code>，带了<code>Generic</code>的可以兼容任意类型，因此需要选择带<code>Generic</code>的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.6.7.png" alt="image-20220720153113504" tabindex="0" loading="lazy"><figcaption>image-20220720153113504</figcaption></figure><h4 id="_7、读取yml数据" tabindex="-1"><a class="header-anchor" href="#_7、读取yml数据" aria-hidden="true">#</a> 7、读取<code>yml</code>数据</h4><h5 id="_1、查看如何把不能修改的类注入容器" tabindex="-1"><a class="header-anchor" href="#_1、查看如何把不能修改的类注入容器" aria-hidden="true">#</a> 1、查看如何把不能修改的类注入容器</h5><p>之所以<code>ttl</code>为<code>-1</code>，是因为<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>类的<code>determineConfiguration</code>方法，首先会判断<code>org.springframework.data.redis.cache.RedisCacheConfiguration</code>是否存在，如果存在，则直接返回，根本不会走下面的逻辑，因此可以直接复制后面序列化后的代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> <span class="token function">determineConfiguration</span><span class="token punctuation">(</span>
      <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">Redis</span> redisProperties <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span>
         <span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>
         <span class="token class-name">SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.1.1.png" alt="image-20220720161252722" tabindex="0" loading="lazy"><figcaption>image-20220720161252722</figcaption></figure><p><s>由于<code>org.springframework.boot.autoconfigure.cache.CacheProperties</code>类没有放入<code>ioc</code>容器中，因此我们不能直接获取</s></p><p>其实注入进去了，<code>@ConfigurationProperties(prefix = &quot;spring.redis&quot;)</code>注解指明当前<code>RedisProperties</code>类与配置文件的<code>spring.redis</code>绑定，但不会把该<code>RedisProperties</code>类注入到<code>ioc</code>容器，可以在本类(<code>RedisProperties</code>类)使用<code>@Component</code>注解把该类放入到<code>ioc</code>容器中，但是如果在不能修改源码的情况下，还可以使用<code>@EnableConfigurationProperties(RedisProperties.class)</code>注解，把<code>RedisProperties</code>类放入到<code>ioc</code>容器中</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.1.2.png" alt="image-20220720161550757" tabindex="0" loading="lazy"><figcaption>image-20220720161550757</figcaption></figure><p>可以看到<code>org.springframework.boot.autoconfigure.data.redis</code>包的<code>RedisAutoConfiguration</code>类，使用<code>@EnableConfigurationProperties(RedisProperties.class)</code>绑定了本包下的<code>RedisProperties</code>类，该注解(<code>@EnableConfigurationProperties(RedisProperties.class)</code>注解)会把<code>RedisProperties</code>类放到<code>ioc</code>容器中</p><p>(如果只使用<code>@EnableConfigurationProperties</code>注解，不指明具体的类，则不会把<code>RedisProperties</code>类放到<code>ioc</code>容器中)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.1.3.png" alt="image-20220723102142594" tabindex="0" loading="lazy"><figcaption>image-20220723102142594</figcaption></figure><p>因此,可以参照<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>类的写法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">CacheManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">CacheCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">RedisCacheConfiguration</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CacheManagerCustomizers</span> customizerInvoker<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span> redisCacheConfiguration<span class="token punctuation">;</span>

   <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">,</span> <span class="token class-name">CacheManagerCustomizers</span> customizerInvoker<span class="token punctuation">,</span>
         <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>RedisCacheConfiguration</span><span class="token punctuation">&gt;</span></span> redisCacheConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cacheProperties <span class="token operator">=</span> cacheProperties<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>customizerInvoker <span class="token operator">=</span> customizerInvoker<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>redisCacheConfiguration <span class="token operator">=</span> redisCacheConfiguration<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.1.4.png" alt="image-20220720161334346" tabindex="0" loading="lazy"><figcaption>image-20220720161334346</figcaption></figure><h5 id="_2、修改myrediscacheconfig类" tabindex="-1"><a class="header-anchor" href="#_2、修改myrediscacheconfig类" aria-hidden="true">#</a> 2、修改<code>MyRedisCacheConfig</code>类</h5><p>用传参的方式使用<code>CacheProperties</code>（但是这种方式好像需要<code>CacheProperties</code>类在容器吧😥(亲测必须在容器内)，老师讲的好像有问题，如果<code>CacheProperties</code>没在容器，不能通过这种方式，这样能成功的原因是<code>CacheProperties</code>类在<code>ioc</code>容器里，而老师讲的是不在<code>ioc</code>容器中该怎么做)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/20
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedisCacheConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CacheProperties<span class="token punctuation">.</span>Redis</span> redisProperties <span class="token operator">=</span> cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.2.1.png" alt="image-20220720161738193" tabindex="0" loading="lazy"><figcaption>image-20220720161738193</figcaption></figure><p>如果<code>CacheProperties</code>不在<code>ioc</code>容器，这才是正确的做法(当然最好不要直接通过<code>@Autowired</code>注入，最好通过传参的方式注入)</p><p>或者可以学习<code>org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration</code>类的做法在类上加上<code>@EnableConfigurationProperties(CacheProperties.class)</code>注解(我试了以下，不加\`\`@EnableConfigurationProperties(CacheProperties.class)<code>注解</code>，直接注入也可以用)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">EnableConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/20
 * @Description:
 */</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedisCacheConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CacheProperties<span class="token punctuation">.</span>Redis</span> redisProperties <span class="token operator">=</span> cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.2.2.png" alt="image-20220720162428178" tabindex="0" loading="lazy"><figcaption>image-20220720162428178</figcaption></figure><h5 id="_3、测试-2" tabindex="-1"><a class="header-anchor" href="#_3、测试-2" aria-hidden="true">#</a> 3、测试</h5><p>删掉以前的在<code>redis</code>里的<code>category（1）</code>数据，刷新 http://localhost:10000/ 页面，在新生成的<code>category（1）</code>可以看到，这次成功返回了<code>JSON</code>数据，<code>ttl</code>也是指定的过期时间了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.3.1.gif" alt="GIF 2022-7-20 16-19-09" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 16-19-09</figcaption></figure><p>数据的格式：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.7.3.2.png" alt="image-20220720163602260" tabindex="0" loading="lazy"><figcaption>image-20220720163602260</figcaption></figure><h5 id="enableconfigurationproperties参考文档" tabindex="-1"><a class="header-anchor" href="#enableconfigurationproperties参考文档" aria-hidden="true">#</a> <code>EnableConfigurationProperties</code>参考文档</h5><p><code>EnableConfigurationProperties</code>注解参考文档： https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/EnableConfigurationProperties.html</p>`,234),Tn=p(`<p><strong>Annotation Type EnableConfigurationProperties</strong></p><hr><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span>EnableConfigurationPropertiesRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableConfigurationProperties</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),Fn={href:"https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/ConfigurationProperties.html",target:"_blank",rel:"noopener noreferrer"},Gn=n("code",null,"@ConfigurationProperties",-1),Nn=n("code",null,"@ConfigurationProperties",-1),Mn={href:"https://docs.spring.io/spring-framework/docs/5.3.22/javadoc-api/org/springframework/context/annotation/Bean.html?is-external=true",target:"_blank",rel:"noopener noreferrer"},Vn=n("code",null,"@Bean",-1),On=p(`<p>详细使用说明： https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-typesafe-configuration-properties</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetAddress</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span><span class="token string">&quot;acme&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AcmeProperties</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">InetAddress</span> remoteAddress<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Security</span> security <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Security</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">InetAddress</span> <span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRemoteAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span> remoteAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">Security</span> <span class="token function">getSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Security</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRoles</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The preceding POJO defines the following properties:</p><ul><li><code>acme.enabled</code>, with a value of <code>false</code> by default.</li><li><code>acme.remote-address</code>, with a type that can be coerced from <code>String</code>.</li><li><code>acme.security.username</code>, with a nested &quot;security&quot; object whose name is determined by the name of the property. In particular, the return type is not used at all there and could have been <code>SecurityProperties</code>.</li><li><code>acme.security.password</code>.</li><li><code>acme.security.roles</code>, with a collection of <code>String</code>.</li></ul><p>You also need to list the properties classes to register in the <code>@EnableConfigurationProperties</code> annotation, as shown in the following example:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">AcmeProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfiguration</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>Even if the preceding configuration creates a regular bean for <code>AcmeProperties</code>, we recommend that <code>@ConfigurationProperties</code> only deal with the environment and, in particular, does not inject other beans from the context. Having said that, the <code>@EnableConfigurationProperties</code> annotation is <em>also</em> automatically applied to your project so that any <em>existing</em> bean annotated with <code>@ConfigurationProperties</code> is configured from the <code>Environment</code>. You could shortcut <code>MyConfiguration</code> by making sure <code>AcmeProperties</code> is already a bean, as shown in the following example:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">&quot;acme&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AcmeProperties</span> <span class="token punctuation">{</span>

  <span class="token comment">// ... see the preceding example</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This style of configuration works particularly well with the <code>SpringApplication</code> external YAML configuration, as shown in the following example:</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># application.yml</span>

<span class="token key atrule">acme</span><span class="token punctuation">:</span>
  <span class="token key atrule">remote-address</span><span class="token punctuation">:</span> 192.168.1.1
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">roles</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> USER
      <span class="token punctuation">-</span> ADMIN

<span class="token comment"># additional configuration as required</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To work with <code>@ConfigurationProperties</code> beans, you can inject them in the same way as any other bean, as shown in the following example:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AcmeProperties</span> properties<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">public</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token class-name">AcmeProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//...</span>

  <span class="token annotation punctuation">@PostConstruct</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8、可选配置" tabindex="-1"><a class="header-anchor" href="#_8、可选配置" aria-hidden="true">#</a> 8、可选配置</h4><h5 id="_1、cache-null-value是否缓存空值" tabindex="-1"><a class="header-anchor" href="#_1、cache-null-value是否缓存空值" aria-hidden="true">#</a> 1、<code>cache-null-value</code>是否缓存空值</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件中，配置<code>spring.cache.redis.cache-null-values=true</code>，设置缓存空值</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#缓存的类型</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>

<span class="token comment">#缓存的名字</span>
<span class="token comment">#如果配置了缓存的名字，则只能使用这些名字</span>
<span class="token comment">#系统中用到哪些缓存了，帮你创建出来</span>
<span class="token comment">#spring.cache.cache-names=qq,qqq</span>
<span class="token key attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token value attr-value">3600000</span>
<span class="token comment">#如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span>
<span class="token key attr-name">spring.cache.redis.key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">CACHE_</span>
<span class="token comment">#是否开启前缀</span>
<span class="token key attr-name">spring.cache.redis.use-key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否缓存空值，防止缓存穿透</span>
<span class="token key attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.1.1.png" alt="image-20220720163351170" tabindex="0" loading="lazy"><figcaption>image-20220720163351170</figcaption></figure><p>将<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的<code>getLevel1Categories</code>方法的返回值设置为<code>null</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.1.2.png" alt="image-20220720163452069" tabindex="0" loading="lazy"><figcaption>image-20220720163452069</figcaption></figure><p>删掉以前的在<code>redis</code>里的<code>category（1）</code>数据，刷新 http://localhost:10000/ 页面，在新生成的<code>category（1）</code>可以看到，空值也缓存了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.1.3.gif" alt="GIF 2022-7-20 16-38-33" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 16-38-33</figcaption></figure><h5 id="_2、use-key-prefix是否开启前缀" tabindex="-1"><a class="header-anchor" href="#_2、use-key-prefix是否开启前缀" aria-hidden="true">#</a> 2、<code>use-key-prefix</code>是否开启前缀</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件中，配置<code>spring.cache.redis.use-key-prefix=false</code>，设置不使用前缀</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#缓存的类型</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>

<span class="token comment">#缓存的名字</span>
<span class="token comment">#如果配置了缓存的名字，则只能使用这些名字</span>
<span class="token comment">#系统中用到哪些缓存了，帮你创建出来</span>
<span class="token comment">#spring.cache.cache-names=qq,qqq</span>
<span class="token key attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token value attr-value">3600000</span>
<span class="token comment">#如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span>
<span class="token key attr-name">spring.cache.redis.key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">CACHE_</span>
<span class="token comment">#是否开启前缀</span>
<span class="token key attr-name">spring.cache.redis.use-key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token comment">#是否缓存空值，防止缓存穿透</span>
<span class="token key attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.2.1.png" alt="image-20220720163957315" tabindex="0" loading="lazy"><figcaption>image-20220720163957315</figcaption></figure><p>删掉以前的在<code>redis</code>里的<code>category（1）</code>数据，刷新 http://localhost:10000/ 页面，在新生成的<code>category（1）</code>可以看到，直接把注解里设置的<code>key</code>作为<code>redis</code>里面的<code>key</code>而不加<code>自定义前缀</code>或<code>默认前缀</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.2.2.gif" alt="GIF 2022-7-20 16-42-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 16-42-54</figcaption></figure><h5 id="_3、测试完后-修改为最初配置" tabindex="-1"><a class="header-anchor" href="#_3、测试完后-修改为最初配置" aria-hidden="true">#</a> 3、测试完后，修改为最初配置</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件中，修改为最初配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#缓存的类型</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>

<span class="token comment">#缓存的名字</span>
<span class="token comment">#如果配置了缓存的名字，则只能使用这些名字</span>
<span class="token comment">#系统中用到哪些缓存了，帮你创建出来</span>
<span class="token comment">#spring.cache.cache-names=qq,qqq</span>
<span class="token comment">#以\`ms\`(毫秒)为单位</span>
<span class="token key attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token value attr-value">3600000</span>
<span class="token comment">#如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span>
<span class="token comment">#spring.cache.redis.key-prefix=CACHE_</span>
<span class="token comment">#是否开启前缀</span>
<span class="token key attr-name">spring.cache.redis.use-key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否缓存空值，防止缓存穿透</span>
<span class="token key attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.3.1.png" alt="image-20220720165738274" tabindex="0" loading="lazy"><figcaption>image-20220720165738274</figcaption></figure><p>将<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的<code>getLevel1Categories</code>方法的返回值设置为<code>categoryEntities</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.8.3.2.png" alt="image-20220720165749301" tabindex="0" loading="lazy"><figcaption>image-20220720165749301</figcaption></figure><h4 id="_9、常用注解-2" tabindex="-1"><a class="header-anchor" href="#_9、常用注解-2" aria-hidden="true">#</a> 9、常用注解(2)</h4><h5 id="_1、-cacheevict" tabindex="-1"><a class="header-anchor" href="#_1、-cacheevict" aria-hidden="true">#</a> 1、<code>@CacheEvict</code></h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里的<code>updateCascade</code>方法上添加<code>@CacheEvict(value = {&quot;category&quot;}, key = &quot;&#39;level1Categories&#39;&quot;)</code>注解，表示使用<code>失效模式</code>（即删除指定的数据）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.1.1.png" alt="image-20220720171836317" tabindex="0" loading="lazy"><figcaption>image-20220720171836317</figcaption></figure><p>使用<code>npm run dev</code>启动前端项目，账号密码都是<code>admin</code>。</p><p>启动后台的<code>GulimallGatewayApplication</code>服务、<code>GulimallProductApplication</code>服务、<code>RenrenApplication</code>服务</p><p>删除<code>redis</code>里<code>key</code>为<code>level1Categories</code>的数据，刷新<code>http://localhost:10000/</code>页面，可以看到在<code>redis</code>里已经有<code>key</code>为<code>CACHE_level1Categories</code>的数据了</p><p>访问<code>http://localhost:8001/</code>网址，打开后台页面，在<code>商品系统/分类维护</code>，修改<code>手机</code>的<code>图标</code>信息，可以看到在<code>redis</code>里<code>key</code>为<code>CACHE_level1Categories</code>的数据已经被删除了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.1.2.gif" alt="GIF 2022-7-20 17-15-42" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 17-15-42</figcaption></figure><h5 id="_2、重写getcatalogjson方法" tabindex="-1"><a class="header-anchor" href="#_2、重写getcatalogjson方法" aria-hidden="true">#</a> 2、重写<code>getCatalogJson</code>方法</h5><p>将<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的<code>getCatalogJson</code>方法重命名为<code>getCatalogJson2</code>，然后重新写一个<code>getCatalogJson</code>方法，添加<code>@Cacheable(value = &quot;category&quot;,key = &quot;#root.methodName&quot;)</code>注解，指定<code>key</code>为方法名</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;category&quot;</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token string">&quot;#root.methodName&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询了数据库......&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//一次查询所有</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l1 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、该一级分类的所有二级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span> l1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span></span> catelog2VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>category2Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catelog2VoList <span class="token operator">=</span> category2Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog1Id</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//3、当前二级分类的所有三级分类</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span> l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catelog3VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>category3Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    catelog3VoList <span class="token operator">=</span> category3Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span> catelog3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setCatalog2Id</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> catelog3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>catelog3VoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catelog2VoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.2.1.png" alt="image-20220720184549647" tabindex="0" loading="lazy"><figcaption>image-20220720184549647</figcaption></figure><p>删除<code>redis</code>里<code>key</code>为<code>CACHE_level1Categories</code>的数据，由于商城首页会调用<code>getCatalogJson</code>方法，因此可以刷新<code>http://gulimall.com/</code>页面，可以看到在<code>redis</code>里已经有<code>key</code>为<code>CACHE_getCatalogJson</code>的数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.2.2.png" alt="GIF 2022-7-20 18-43-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 18-43-13</figcaption></figure><h5 id="_3、批量删除数据" tabindex="-1"><a class="header-anchor" href="#_3、批量删除数据" aria-hidden="true">#</a> 3、批量删除数据</h5><p><strong>方法一：</strong></p><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的<code>updateCascade</code>上添加如下注解，执行两个删除语句</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 级联更新所有的数据
 *@CacheEvict: 失效模式
 * <span class="token keyword">@param</span> <span class="token parameter">category</span>
 */</span>
<span class="token annotation punctuation">@Caching</span><span class="token punctuation">(</span>evict <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;&#39;level1Categories&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;&#39;getCatalogJson&#39;&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCascade</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> category<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
    categoryBrandRelationService<span class="token punctuation">.</span><span class="token function">updateCategory</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.3.1.1.png" alt="image-20220720185106905" tabindex="0" loading="lazy"><figcaption>image-20220720185106905</figcaption></figure><p>删除<code>redis</code>里<code>key</code>为<code>CACHE_level1Categories</code>和<code>catalogJson</code>的数据，由于商城首页会调用<code>getCatalogJson</code>和<code>getLevel1Categories</code>方法，因此可以刷新<code>http://gulimall.com/</code>页面，可以看到在<code>redis</code>里已经有<code>key</code>为<code>CACHE_getCatalogJson</code>和<code>CACHE_level1Categories</code>的数据了，，在<code>商品系统/分类维护</code>，修改<code>手机</code>的<code>图标</code>信息，可以看到在<code>redis</code>里<code>key</code>为<code>CACHE_getCatalogJson</code>和<code>CACHE_level1Categories</code>的数据已经被删除了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.3.1.2.gif" alt="GIF 2022-7-20 18-57-47" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 18-57-47</figcaption></figure><p><strong>方法二：</strong></p><p><code>@CacheEvict</code>注解的<code>allEntries = true</code>属性可以把该分区的所有数据都删除，这样也可以达到批量删除数据的目的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 级联更新所有的数据
 *@CacheEvict: 失效模式
 * @Caching: 批量操作
 * @CacheEvict(value = <span class="token punctuation">{</span>&quot;category&quot;<span class="token punctuation">}</span>,allEntries = true) 删除该分区的所有数据
 * <span class="token keyword">@param</span> <span class="token parameter">category</span>
 */</span>
<span class="token comment">//@Caching(evict = {</span>
<span class="token comment">//        @CacheEvict(value = {&quot;category&quot;}, key = &quot;&#39;level1Categories&#39;&quot;),</span>
<span class="token comment">//        @CacheEvict(value = {&quot;category&quot;}, key = &quot;&#39;getCatalogJson&#39;&quot;)</span>
<span class="token comment">//})</span>
<span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>allEntries <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCascade</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> category<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
    categoryBrandRelationService<span class="token punctuation">.</span><span class="token function">updateCategory</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.3.2.png" alt="image-20220720190209669" tabindex="0" loading="lazy"><figcaption>image-20220720190209669</figcaption></figure><h5 id="_4、不指定key-prefix" tabindex="-1"><a class="header-anchor" href="#_4、不指定key-prefix" aria-hidden="true">#</a> 4、不指定<code>key-prefix</code></h5><p>把<code>spring.cache.redis.key-prefix=CACHE_</code>注释掉</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#缓存的类型</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>

<span class="token comment">#缓存的名字</span>
<span class="token comment">#如果配置了缓存的名字，则只能使用这些名字</span>
<span class="token comment">#系统中用到哪些缓存了，帮你创建出来</span>
<span class="token comment">#spring.cache.cache-names=qq,qqq</span>
<span class="token key attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token value attr-value">3600000</span>
<span class="token comment">#如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span>
<span class="token comment">#spring.cache.redis.key-prefix=CACHE_</span>
<span class="token comment">#是否开启前缀</span>
<span class="token key attr-name">spring.cache.redis.use-key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否缓存空值，防止缓存穿透</span>
<span class="token key attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.4.1.png" alt="image-20220720190805585" tabindex="0" loading="lazy"><figcaption>image-20220720190805585</figcaption></figure><p>重新刷新<code>http://gulimall.com/</code>页面，可以看到不指定前缀后，会生成名为<code>分区名</code>的文件夹，在该文件夹内存放该分区的数据，这样显得更有层级关系</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.4.4.9.4.2.gif" alt="GIF 2022-7-20 19-13-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 19-13-46</figcaption></figure><h5 id="_5、双写模式" tabindex="-1"><a class="header-anchor" href="#_5、双写模式" aria-hidden="true">#</a> 5、双写模式</h5><p>如果想使用双写模式，可以使用<code>@CachePut</code>注解，由于该方法没有返回值，所以用不了双写模式，这里就不演示了，大概结构如下</p><p><code>@CachePut(value = {&quot;category&quot;}, key = &quot;&#39;level1Categories&#39;&quot;)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;&#39;level1Categories&#39;&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">updateCascade</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> category<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> categoryBrandRelationService<span class="token punctuation">.</span><span class="token function">updateCategory</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-172" tabindex="-1"><a class="header-anchor" href="#_10-172" aria-hidden="true">#</a> 10 172</h4><p>4、Spring-Cache的不 足; 1)、读模式: 缓存穿透:查询一个null数据。解决:缓存空数据; <code>spring.cache.redis.cache-null-values=true</code> 缓存击穿:大量并发进来同时查询一一个正好过期的数据。解决:加锁; ? <code>@Cacheable(value = {&quot;category&quot;}, key = &quot;&#39;level1Categories&#39;&quot;,sync = true)</code> 只有<code>@Cacheable</code>注解可以加锁 缓存雪崩:大量的key同时过期。解决:加随机时间。（加随机时间有可能弄巧成拙，本来是2s、1s时间过期，加随机时间变为<code>2s+2s=4s</code>、<code>1s+3s=4s</code>时间过期） <code>spring.cache.redis.time-to-live=3600000</code></p><p>2)、写模式: (缓存与数据库一 致) 1)、读写加锁。 2)、引入Canal,感知到MySQL的更新去更新数据库 3)、读多写多，直接去数据库查询就行</p><p>总结: 常规数据(读多写少，即时性，- 致性要求不高的数据) ;完全可以使用Spring-Cache(只要缓存的数据有过期时间就足够了): 特殊数据:特殊设计</p><h2 id="_5-5、商城业务-检索服务" tabindex="-1"><a class="header-anchor" href="#_5-5、商城业务-检索服务" aria-hidden="true">#</a> 5.5、商城业务-检索服务</h2><h3 id="_5-5-1、初始化" tabindex="-1"><a class="header-anchor" href="#_5-5-1、初始化" aria-hidden="true">#</a> 5.5.1、初始化</h3><h4 id="_1、添加配置" tabindex="-1"><a class="header-anchor" href="#_1、添加配置" aria-hidden="true">#</a> 1、添加配置</h4><h5 id="_1、引入依赖-1" tabindex="-1"><a class="header-anchor" href="#_1、引入依赖-1" aria-hidden="true">#</a> 1、引入依赖</h5><p>在<code>gulimall-search</code>模块的<code>pom.xml</code>文件里引入<code>thymeleaf</code>依赖和<code>devtools</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入thymeleaf--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--引入devtools--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.1.1.png" alt="image-20220720210415704" tabindex="0" loading="lazy"><figcaption>image-20220720210415704</figcaption></figure><h5 id="_2、关闭缓存" tabindex="-1"><a class="header-anchor" href="#_2、关闭缓存" aria-hidden="true">#</a> 2、关闭缓存</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/application.properties</code>配置文件里配置关闭缓存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.1.2.png" alt="image-20220720210556603" tabindex="0" loading="lazy"><figcaption>image-20220720210556603</figcaption></figure><h5 id="_3、导入index-html" tabindex="-1"><a class="header-anchor" href="#_3、导入index-html" aria-hidden="true">#</a> 3、导入<code>index.html</code></h5><p>在资料里的<code>2.分布式高级篇（微服务架构篇\\资料源码\\代码\\html\\搜索页</code>文件夹下，复制<code>index.html</code>文件，粘贴到<code>gulimall-search</code>模块的<code>src/main/resources/templates</code>目录下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.1.3.gif" alt="GIF 2022-7-20 19-37-45" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 19-37-45</figcaption></figure><h5 id="_4、导入静态资源到nginx" tabindex="-1"><a class="header-anchor" href="#_4、导入静态资源到nginx" aria-hidden="true">#</a> 4、导入静态资源到<code>nginx</code></h5><p>在资料里的<code>D:\\尚硅谷\\谷粒商城\\2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\搜索页</code>文件夹下，复制所有文件夹(除<code>index.html</code>)，在虚拟机的<code>/mydata/nginx/html/static/</code>目录下，新建<code>search</code>文件夹。 粘贴到虚拟机里的 <code>/mydata/nginx/html/static/search</code>目录下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.1.4.gif" alt="GIF 2022-7-20 20-46-29" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 20-46-29</figcaption></figure><h5 id="_5、修改index-html" tabindex="-1"><a class="header-anchor" href="#_5、修改index-html" aria-hidden="true">#</a> 5、修改<code>index.html</code></h5><p>修改<code>gulimall-search</code>模块的<code>src/main/resources/templates/index.html</code>文件，使所有静态文件都访问<code>nigix</code></p>`,92),Dn=n("code",null,"index.html",-1),Bn=p(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.1.5.png" alt="image-20220724100623230" tabindex="0" loading="lazy"><figcaption>image-20220724100623230</figcaption></figure><h5 id="_6、访问检索页" tabindex="-1"><a class="header-anchor" href="#_6、访问检索页" aria-hidden="true">#</a> 6、访问检索页</h5><p>启动<code>GulimallSearchApplication</code>服务，访问： http://localhost:12000/</p><p>可以看到可以获得数据，但没有访问到静态资源</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.1.6.png" alt="image-20220720201949003" tabindex="0" loading="lazy"><figcaption>image-20220720201949003</figcaption></figure><h4 id="_2、首页通过检索跳转到检索页" tabindex="-1"><a class="header-anchor" href="#_2、首页通过检索跳转到检索页" aria-hidden="true">#</a> 2、<code>首页</code>通过检索跳转到<code>检索页</code></h4><h5 id="_1、在首页中检索" tabindex="-1"><a class="header-anchor" href="#_1、在首页中检索" aria-hidden="true">#</a> 1、在首页中检索</h5><p>在首页中检索时，应该来到<code>search.gulimall.com</code>，但此时无法访问，是因为<code>search.gulimall.com</code>域名没有配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.2.1.gif" alt="GIF 2022-7-20 20-25-47" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 20-25-47</figcaption></figure><h5 id="_2、host文件添加域名" tabindex="-1"><a class="header-anchor" href="#_2、host文件添加域名" aria-hidden="true">#</a> 2、<code>Host</code>文件添加域名</h5><p>在<code>SwitchHosts</code>工具里，编辑<code>本地方案/gulimall</code>，然后点击<code>对勾</code>，应用此方案</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># gulimall</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">search.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.2.2.png" alt="image-20220720202806012" tabindex="0" loading="lazy"><figcaption>image-20220720202806012</figcaption></figure><h5 id="_3、再次测试" tabindex="-1"><a class="header-anchor" href="#_3、再次测试" aria-hidden="true">#</a> 3、再次测试</h5><p>在首页中检索后，来到了<code>nginx</code>配置的默认首页，此时<code>http://search.gulimall.com/</code>域名下的<code>Host</code>为<code>search.gulimall.com</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.2.3.png" alt="image-20220720203018405" tabindex="0" loading="lazy"><figcaption>image-20220720203018405</figcaption></figure><h4 id="_3、修改search-gulimall-com配置" tabindex="-1"><a class="header-anchor" href="#_3、修改search-gulimall-com配置" aria-hidden="true">#</a> 3、修改<code>search.gulimall.com</code>配置</h4><h5 id="_1、修改gulimall-conf文件" tabindex="-1"><a class="header-anchor" href="#_1、修改gulimall-conf文件" aria-hidden="true">#</a> 1、修改<code>gulimall.conf</code>文件</h5><p>执行以下命令，修改<code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件，并重启<code>nginx</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /mydata/nginx
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> conf/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> conf.d/
<span class="token function">ls</span>
<span class="token function">vi</span> gulimall.conf
<span class="token function">docker</span> restart nginx
<span class="token function">docker</span> <span class="token function">ps</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.3.1.1.png" alt="image-20220720203705064" tabindex="0" loading="lazy"><figcaption>image-20220720203705064</figcaption></figure><p>将<code>server_name gulimall.com;</code>修改为<code>server_name *.gulimall.com;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.3.1.2.png" alt="image-20220720203443206" tabindex="0" loading="lazy"><figcaption>image-20220720203443206</figcaption></figure><h5 id="_2、访问到了首页" tabindex="-1"><a class="header-anchor" href="#_2、访问到了首页" aria-hidden="true">#</a> 2、访问到了首页</h5><p>访问 http://search.gulimall.com/ ，可以看到来到了首页，而不是检索页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.3.2.png" alt="image-20220720203821469" tabindex="0" loading="lazy"><figcaption>image-20220720203821469</figcaption></figure><h5 id="_3、修改gateway配置" tabindex="-1"><a class="header-anchor" href="#_3、修改gateway配置" aria-hidden="true">#</a> 3、修改<code>gateway</code>配置</h5><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>文件里，修改id为<code> gulimall_host_route</code>的配置，并添加id为<code> gulimall_search_route</code>的配置</p><p>然后重启<code>GulimallGatewayApplication</code>服务</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_host_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>product
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Host=gulimall.com

<span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_search_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>search
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Host=search.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.3.3.png" alt="image-20220720205136681" tabindex="0" loading="lazy"><figcaption>image-20220720205136681</figcaption></figure><h5 id="_4、访问的检索页" tabindex="-1"><a class="header-anchor" href="#_4、访问的检索页" aria-hidden="true">#</a> 4、访问的检索页</h5><p>访问 http://search.gulimall.com/ ，这次来到了检索页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.3.4.1.png" alt="image-20220720205237222" tabindex="0" loading="lazy"><figcaption>image-20220720205237222</figcaption></figure><p>有几个文件没有找到不用管，本来就没有</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.3.4.2.png" alt="image-20220720205803381" tabindex="0" loading="lazy"><figcaption>image-20220720205803381</figcaption></figure><h4 id="_4、nginx转发效果" tabindex="-1"><a class="header-anchor" href="#_4、nginx转发效果" aria-hidden="true">#</a> 4、<code>Nginx转发效果</code></h4><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.4.png" alt="image-20220720205507777" style="zoom:50%;"><h4 id="_5、点击logo返回首页" tabindex="-1"><a class="header-anchor" href="#_5、点击logo返回首页" aria-hidden="true">#</a> 5、点击<code>logo</code>返回首页</h4><h5 id="_1、查看logo所在标签" tabindex="-1"><a class="header-anchor" href="#_1、查看logo所在标签" aria-hidden="true">#</a> 1、查看<code>logo</code>所在标签</h5><p>在 http://search.gulimall.com/ 页面里，打开控制台，定位到<code>logo</code>，复制<code>src=&quot;/static/search/./image/logo1.jpg&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.5.1.png" alt="image-20220720211104053" tabindex="0" loading="lazy"><figcaption>image-20220720211104053</figcaption></figure><h5 id="_2、修改该标签" tabindex="-1"><a class="header-anchor" href="#_2、修改该标签" aria-hidden="true">#</a> 2、修改该标签</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里搜索刚刚复制的内容</p><p>把该<code>a标签</code>的<code>href</code>修改为<code>&quot;http://gulimall.com</code>，使其访问首页</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/search/./image/logo1.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.5.2.png" alt="image-20220720211434554" tabindex="0" loading="lazy"><figcaption>image-20220720211434554</figcaption></figure><h5 id="_3、测试-3" tabindex="-1"><a class="header-anchor" href="#_3、测试-3" aria-hidden="true">#</a> 3、测试</h5><p>重启<code>GulimallSearchApplication</code>服务，在 http://search.gulimall.com/ 页面里，点击<code>logo</code>，可以看到跳转到了<code>nginx</code>的默认首页</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.5.3.gif" alt="GIF 2022-7-20 21-15-25" style="zoom:67%;"><h5 id="_4、修改nginx配置" tabindex="-1"><a class="header-anchor" href="#_4、修改nginx配置" aria-hidden="true">#</a> 4、修改<code>nginx</code>配置</h5><p>进入虚拟机的<code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件，修改配置，然后重启<code>nginx</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /mydata/nginx/conf/conf.d/
<span class="token function">vi</span> gulimall.conf
<span class="token function">docker</span> restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入<code>gulimall.conf</code>后，把</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server_name</span> <span class="token value attr-value"> *.gulimall.com;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>修改为(<code>gulimall.com</code>和<code>*.gulimall.com;</code>中间有空格)</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server_name</span> <span class="token value attr-value"> gulimall.com *.gulimall.com;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.5.4.png" alt="image-20220720212048919" tabindex="0" loading="lazy"><figcaption>image-20220720212048919</figcaption></figure><h5 id="_5、再次测试" tabindex="-1"><a class="header-anchor" href="#_5、再次测试" aria-hidden="true">#</a> 5、再次测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.5.5.gif" alt="GIF 2022-7-22 15-02-08" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-02-08</figcaption></figure><h4 id="_6、点击谷粒商城首页返回首页" tabindex="-1"><a class="header-anchor" href="#_6、点击谷粒商城首页返回首页" aria-hidden="true">#</a> 6、点击<code>谷粒商城首页</code>返回首页</h4><h5 id="_1、查看谷粒商城首页所在标签" tabindex="-1"><a class="header-anchor" href="#_1、查看谷粒商城首页所在标签" aria-hidden="true">#</a> 1、查看<code>谷粒商城首页</code>所在标签</h5><p>在 http://search.gulimall.com/ 页面里，打开控制台，定位到<code>谷粒商城首页</code>，复制<code>谷粒商城首页</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.6.1.png" alt="image-20220722145830936" tabindex="0" loading="lazy"><figcaption>image-20220722145830936</figcaption></figure><h5 id="_2、修改该标签-1" tabindex="-1"><a class="header-anchor" href="#_2、修改该标签-1" aria-hidden="true">#</a> 2、修改该标签</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里搜索刚刚复制的内容</p><p>把该<code>a标签</code>的<code>href</code>修改为<code>&quot;http://gulimall.com</code>，使其访问首页</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_head_p_a1<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>73px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    谷粒商城首页
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.6.2.png" alt="image-20220722150037921" tabindex="0" loading="lazy"><figcaption>image-20220722150037921</figcaption></figure><h5 id="_3、测试-4" tabindex="-1"><a class="header-anchor" href="#_3、测试-4" aria-hidden="true">#</a> 3、测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.6.3.gif" alt="GIF 2022-7-24 10-59-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-24 10-59-14</figcaption></figure><h4 id="_7、首页通过分类跳转到检索页" tabindex="-1"><a class="header-anchor" href="#_7、首页通过分类跳转到检索页" aria-hidden="true">#</a> 7、<code>首页</code>通过分类跳转到<code>检索页</code></h4><h5 id="_1、测试" tabindex="-1"><a class="header-anchor" href="#_1、测试" aria-hidden="true">#</a> 1、测试</h5><p>在 http://gulimall.com/ 首页里，在左侧的导航栏里，鼠标悬浮到<code>手机</code>，在<code>手机通讯</code>里点击<code>手机</code>，可以看到来到了</p><p>http://search.gmall.com/list.html?catalog3Id=225 ，而不是 http://search.gulimall.com/list.html?catalog3Id=225</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.7.1.gif" alt="GIF 2022-7-22 15-18-20" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-18-20</figcaption></figure><h5 id="_2、修改catalogloader-js" tabindex="-1"><a class="header-anchor" href="#_2、修改catalogloader-js" aria-hidden="true">#</a> 2、修改<code>catalogLoader.js</code></h5><p>修改虚拟机里<code>/mydata/nginx/html/static/index/js</code>下的<code>catalogLoader.js</code>，搜索<code>gmall</code>，把<code>gmall</code>修改为<code>gulimall</code>，然后重启<code>nginx</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.7.2.gif" alt="GIF 2022-7-20 21-33-03" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 21-33-03</figcaption></figure><h5 id="_3、再次测试-1" tabindex="-1"><a class="header-anchor" href="#_3、再次测试-1" aria-hidden="true">#</a> 3、再次测试</h5><p>先清除浏览器的缓存，再在 http://gulimall.com/ 首页里，在左侧的导航栏里，鼠标悬浮到<code>手机</code>，在<code>手机通讯</code>里点击<code>手机</code>，可以看到来到了 http://search.gulimall.com/list.html?catalog3Id=225</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.7.3.gif" alt="GIF 2022-7-20 21-36-27" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-20 21-36-27</figcaption></figure><h4 id="_8、通过list-html访问检索页" tabindex="-1"><a class="header-anchor" href="#_8、通过list-html访问检索页" aria-hidden="true">#</a> 8、通过<code>list.html</code>访问检索页</h4><h5 id="_1、关闭thymeleaf缓存" tabindex="-1"><a class="header-anchor" href="#_1、关闭thymeleaf缓存" aria-hidden="true">#</a> 1、关闭<code>thymeleaf</code>缓存</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/application.yml</code>配置文件里，关闭<code>thymeleaf</code>缓存</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token comment">#关闭thymeleaf缓存</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.8.1.png" alt="image-20220722145204078" tabindex="0" loading="lazy"><figcaption>image-20220722145204078</figcaption></figure><h5 id="_2、index-html重命名为list-html" tabindex="-1"><a class="header-anchor" href="#_2、index-html重命名为list-html" aria-hidden="true">#</a> 2、<code>index.html</code>重命名为<code>list.html</code></h5><p>将<code>gulimall-search</code>模块的<code>src/main/resources/templates/index.html</code>重命名为<code>list.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.8.2.gif" alt="GIF 2022-7-22 15-09-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-09-31</figcaption></figure><h5 id="_3、添加listpage方法" tabindex="-1"><a class="header-anchor" href="#_3、添加listpage方法" aria-hidden="true">#</a> 3、添加<code>listPage</code>方法</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.SearchController</code>类里添加<code>listPage</code>方法，跳转到<code>list.html</code>页面</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/22
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">listPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.8.3.png" alt="image-20220722153722746" tabindex="0" loading="lazy"><figcaption>image-20220722153722746</figcaption></figure><h5 id="_4、测试-1" tabindex="-1"><a class="header-anchor" href="#_4、测试-1" aria-hidden="true">#</a> 4、测试</h5><p>在 http://gulimall.com/ 首页里，在左侧的导航栏里，鼠标悬浮到<code>手机</code>，在<code>手机通讯</code>里点击<code>手机</code>，可以看到来到了 http://search.gulimall.com/list.html?catalog3Id=225 并成功访问到页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.8.4.gif" alt="GIF 2022-7-22 15-25-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-25-39</figcaption></figure><h4 id="_9、首页通过检索跳转到了search-html" tabindex="-1"><a class="header-anchor" href="#_9、首页通过检索跳转到了search-html" aria-hidden="true">#</a> 9、<code>首页</code>通过检索跳转到了<code>search.html</code></h4><h5 id="_1、检索跳转到了search-html" tabindex="-1"><a class="header-anchor" href="#_1、检索跳转到了search-html" aria-hidden="true">#</a> 1、检索跳转到了<code>search.html</code></h5><p>在 http://gulimall.com/ 里，通过搜索，跳转到了 http://search.gulimall.com/search.html?keyword=111 而不是 http://search.gulimall.com/list.html?keyword=111</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.1.gif" alt="GIF 2022-7-22 15-28-44" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-28-44</figcaption></figure><h5 id="_2、查找搜索所在标签" tabindex="-1"><a class="header-anchor" href="#_2、查找搜索所在标签" aria-hidden="true">#</a> 2、查找<code>搜索</code>所在标签</h5><p>在 http://gulimall.com/ 里，打开控制台，找到<code>搜索</code>图标，复制<code>search()</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.2.png" alt="image-20220722153047210" tabindex="0" loading="lazy"><figcaption>image-20220722153047210</figcaption></figure><h5 id="_3、修改跳转的路径" tabindex="-1"><a class="header-anchor" href="#_3、修改跳转的路径" aria-hidden="true">#</a> 3、修改跳转的路径</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>页面里搜索刚刚复制的内容</p><p>修改<code>script</code>里的<code> window.location.href=&quot;http://search.gulimall.com/search.html?keyword=&quot;+keyword;</code>为以下内容</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> keyword<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#searchText&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token operator">=</span><span class="token string">&quot;http://search.gulimall.com/list.html?keyword=&quot;</span><span class="token operator">+</span>keyword<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.3.png" alt="image-20220722153411321" tabindex="0" loading="lazy"><figcaption>image-20220722153411321</figcaption></figure><h5 id="_4、修改不生效" tabindex="-1"><a class="header-anchor" href="#_4、修改不生效" aria-hidden="true">#</a> 4、修改不生效</h5><p>重启<code>gulimall-product</code>服务，在 http://gulimall.com/ 里，通过搜索，跳转到了 http://search.gulimall.com/search.html?keyword=111 而不是 http://search.gulimall.com/list.html?keyword=111 很明显配置没生效</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.4.gif" alt="GIF 2022-7-22 15-32-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-32-40</figcaption></figure><h5 id="_5、关闭thymeleaf缓存" tabindex="-1"><a class="header-anchor" href="#_5、关闭thymeleaf缓存" aria-hidden="true">#</a> 5、关闭<code>thymeleaf</code>缓存</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件里，关闭<code>thymeleaf</code>缓存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.5.png" alt="image-20220722153254270" tabindex="0" loading="lazy"><figcaption>image-20220722153254270</figcaption></figure><h5 id="_6、再次测试-1" tabindex="-1"><a class="header-anchor" href="#_6、再次测试-1" aria-hidden="true">#</a> 6、再次测试</h5><p>重启<code>GulimallProductApplication</code>服务，在 http://gulimall.com/ 里，通过搜索，成功跳转到了 http://search.gulimall.com/list.html?keyword=111</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.6.gif" alt="GIF 2022-7-22 15-35-30" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-22 15-35-30</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里。如果不行的话，可以在<code>a</code>标签里调<code>javascript</code>的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:search();<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/index/img/img_09.png<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.1.9.7.png" alt="image-20220722154519044" tabindex="0" loading="lazy"><figcaption>image-20220722154519044</figcaption></figure><h3 id="_5-5-2、编写检索数据代码" tabindex="-1"><a class="header-anchor" href="#_5-5-2、编写检索数据代码" aria-hidden="true">#</a> 5.5.2、编写检索数据代码</h3><h5 id="_1、新建searchparam类" tabindex="-1"><a class="header-anchor" href="#_1、新建searchparam类" aria-hidden="true">#</a> 1、新建<code>SearchParam</code>类</h5><p>在<code>gulimall-search</code>模块里，在<code>com.atguigu.gulimall.search</code>包下新建<code>vo</code>文件夹，在<code>vo</code>文件夹下新建<code>SearchParam</code>类</p><p>用来获取<code>查询商品请求</code>的数据参数</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/22
 * @Description: 封装可能的所有的查询条件
 *  catalog3Id=225&amp;keyword=小米&amp;sort=saleCount_asc&amp;hasStock=0/1
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchParam</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 页面传过来的全文匹配的关键字
     * keyword=小米
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyword<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 三级分类的id
     * catalog3Id=225
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> catalog3Id<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 排序条件
     * 按照销量升序或降序     sort=saleCount_asc/desc
     * 按照sku价格升序或降序  sort=skuPrice_asc/desc
     * 按照热度评分升序或降序  sort=hotScore_asc/desc
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sort<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 品牌的id(可以指定多个品牌)
     * brandId=1&amp;brandId=2
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> brandId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 是否有货(是否只显示有货)
     * hasStock=0/1
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> hasStock<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 价格区间
     * 价格在1~500之间  skuPrice=1_500
     * 价格不高于500    skuPrice=_500
     * 价格不低于1      skuPrice=1_
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> skuPrice<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 指定属性
     * attrs=1_安卓:其他&amp;attrs=2_5寸:6寸
     *
     * 1号属性(系统)值为 \`安卓\`或\`其他\`
     * 2号属性(屏幕尺寸)值为 \`5寸\`或\`6寸\`
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attrs<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 页码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.2.1.png" alt="image-20220722163637498" tabindex="0" loading="lazy"><figcaption>image-20220722163637498</figcaption></figure><h5 id="_2、新建searchresult类" tabindex="-1"><a class="header-anchor" href="#_2、新建searchresult类" aria-hidden="true">#</a> 2、新建<code>SearchResult</code>类</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.vo</code>包下新建<code>SearchResult</code>类，用来封装<code>查询商品请求</code>所响应的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es<span class="token punctuation">.</span></span><span class="token class-name">SkuEsModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/22
 * @Description: 根据查询条件返回的结果
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchResult</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 查询到的所有商品信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> products<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 当前页码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 总记录数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> total<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 总页码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> totalPages<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 当前查询到的结果涉及到的所有品牌
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrandVo</span><span class="token punctuation">&gt;</span></span> brands<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 当前查询到的结果涉及到的所有分类
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CatalogVo</span><span class="token punctuation">&gt;</span></span> catalogs<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     *  当前查询到的结果涉及到的所有属性
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrVo</span><span class="token punctuation">&gt;</span></span> attrs<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 品牌vo
     */</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BrandVo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 品牌id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 品牌名
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> brandName<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 品牌图片
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> brandImg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 分类vo
     */</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CatalogVo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 分类id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 分类名
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> catalogName<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 属性vo
     */</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AttrVo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 属性的id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 属性名
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> attrName<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 属性值
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attrValue<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.2.2.png" alt="image-20220722170225469" tabindex="0" loading="lazy"><figcaption>image-20220722170225469</figcaption></figure><h5 id="_3、新建mallsearchservice类" tabindex="-1"><a class="header-anchor" href="#_3、新建mallsearchservice类" aria-hidden="true">#</a> 3、新建<code>MallSearchService</code>类</h5><p>在<code>gulimall-search</code>模块里，在<code>com.atguigu.gulimall.search.service</code>包下新建<code>MallSearchService</code>接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">SearchParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">SearchResult</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/22
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MallSearchService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 查询商品
     * <span class="token keyword">@param</span> <span class="token parameter">searchParam</span> 检索的参数
     * <span class="token keyword">@return</span> 根据检索的参数查询到的结果，包含页面需要的所有信息
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.2.3.png" alt="image-20220722170144372" tabindex="0" loading="lazy"><figcaption>image-20220722170144372</figcaption></figure><h5 id="_4、修改listpage方法" tabindex="-1"><a class="header-anchor" href="#_4、修改listpage方法" aria-hidden="true">#</a> 4、修改<code>listPage</code>方法</h5><p>修改<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.SearchController</code>类的<code>listPage</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MallSearchService</span> mallSearchService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 自动将页面提交过来的所有请求查询参数封装成指定的对象
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">listPage</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> mallSearchService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.2.4.png" alt="image-20220722170844284" tabindex="0" loading="lazy"><figcaption>image-20220722170844284</figcaption></figure><h3 id="_5-5-3、测试请求es格式" tabindex="-1"><a class="header-anchor" href="#_5-5-3、测试请求es格式" aria-hidden="true">#</a> 5.5.3、测试请求<code>ES</code>格式</h3><p>访问<code>kibana</code>： http://192.168.56.10:5601/</p><h4 id="_1、nested嵌入式查询" tabindex="-1"><a class="header-anchor" href="#_1、nested嵌入式查询" aria-hidden="true">#</a> 1、<code>nested</code>嵌入式查询</h4><p><code>skuTitle</code>在<code>must</code>里，通过<code>skuTitle</code>来获取权重。其他在<code>filter</code>里，只做查询不设权重，以加快查询速度。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;华为&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;225&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;9&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">{</span>
                    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;A2100&quot;</span>
                      <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.1.1.png" alt="image-20220722191738587" tabindex="0" loading="lazy"><figcaption>image-20220722191738587</figcaption></figure><p>其中如果想查<code>attrs</code>里的属性(如<code>attrs.attrId</code>)，则必须先写<code>nested</code>，并指定<code>path</code>，然后通过<code>query</code>来进行查询</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                      <span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;A2100&quot;</span>
                    <span class="token punctuation">]</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/8.3/query-dsl-nested-query.html</p>`,148),Un={href:"https://www.elastic.co/guide/en/elasticsearch/reference/0.90/mapping-nested-type.html",target:"_blank",rel:"noopener noreferrer"},Jn=p(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type1&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;obj1&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And here is a sample nested query usage:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;nested&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;path&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;obj1&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;score_mode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;avg&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;bool&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;must&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        <span class="token string-property property">&quot;match&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;obj1.name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span>
                        <span class="token string-property property">&quot;range&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;obj1.count&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;gt&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The query <code>path</code> points to the nested object path, and the <code>query</code> (or <code>filter</code>) includes the query that will run on the nested docs matching the direct path, and joining with the root parent docs.</p><p>The <code>score_mode</code> allows to set how inner children matching affects scoring of parent. It defaults to <code>avg</code>, but can be <code>total</code>, <code>max</code> and <code>none</code>.</p><p>Multi level nesting is automatically supported, and detected, resulting in an inner nested query to automatically match the relevant nesting level (and not root) if it exists within another nested query.</p>`,6),$n=p(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.1.2.gif" alt="GIF 2022-7-24 18-45-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-24 18-45-46</figcaption></figure><h4 id="_2、加入range查不出数据" tabindex="-1"><a class="header-anchor" href="#_2、加入range查不出数据" aria-hidden="true">#</a> 2、加入<code>range</code>查不出数据</h4><p>在<code>filter</code>里加了个<code>range</code>就查不出数据了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">6000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.2.1.png" alt="image-20220722195006076" tabindex="0" loading="lazy"><figcaption>image-20220722195006076</figcaption></figure><p>删掉<code>range</code>，再次查询可以发现，数据里少了<code>skuPrice</code>这个属性，这是因为在<code>Elasticsearch</code>里，最初设置的<code>skuPrice</code>的属性类型为<code>double</code>，而<code>SkuEsModel</code>类里的<code>skuPrice</code>属性的类型为<code>BigDecimal</code>，<code>Elasticsearch</code>不能兼容这两个数据类型，<s>因此要在<code>Elasticsearch</code>里，设置的<code>skuPrice</code>的属性类型为<code>keyword</code></s> (在<code>Elasticsearch</code>里，<s>设置的<code>skuPrice</code>的属性类型为<code>keyword</code>也不行</s>，设置的<code>skuPrice</code>的属性类型为<code>keyword</code>可以，我代码里没有设置<code>skuImg</code>和<code>skuPrice</code>所以不行))</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.2.2.png" alt="image-20220722194900142" tabindex="0" loading="lazy"><figcaption>image-20220722194900142</figcaption></figure><p>完整查询：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;华为&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;225&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;9&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">{</span>
                    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;A2100&quot;</span>
                      <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">6000</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、数据迁移-不推荐" tabindex="-1"><a class="header-anchor" href="#_3、数据迁移-不推荐" aria-hidden="true">#</a> 3、数据迁移(不推荐)</h4><p><strong>可以通过<code>数据迁移</code>(不推荐)，来增加<code>skuPrice</code>属性，但是后面还要修改数据，这次迁移后，还要再次迁移，可以先把<code>range</code>注释掉，最后再<code>数据迁移</code></strong></p><h5 id="_1、获取product映射" tabindex="-1"><a class="header-anchor" href="#_1、获取product映射" aria-hidden="true">#</a> 1、获取<code>product</code>映射</h5><p>使用<code>GET product/_mapping</code>，获取<code>product</code>的映射信息，然后复制结果</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.1.png" alt="image-20220723202123465" tabindex="0" loading="lazy"><figcaption>image-20220723202123465</figcaption></figure><h5 id="_2、向product2创建映射" tabindex="-1"><a class="header-anchor" href="#_2、向product2创建映射" aria-hidden="true">#</a> 2、向<code>product2</code>创建映射</h5><p>然后输入<code>PUT product2</code>，并粘贴刚刚复制的结果，再删除<code>粘贴过来的结果</code>里的<code>&quot;product&quot; :{ }</code>右括号随便在最后删除一个就行了</p><p>然后点击<code>工具</code>图标，选择<code>Auto indent</code>格式化一下代码，再在里面修改映射信息</p><p>这里需要把<code>skuPrice</code>里的<code>&quot;type&quot; : &quot;double&quot;</code>修改为<code>&quot;type&quot;: &quot;keyword&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.2.png" alt="image-20220723202738147" tabindex="0" loading="lazy"><figcaption>image-20220723202738147</figcaption></figure><p>完整代码：（<code>attrs</code>里面应该还有<code>&quot;type&quot; : &quot;nested&quot;,</code>，最开始弄错了）</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT product
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3、写错后-可以通过delete删除" tabindex="-1"><a class="header-anchor" href="#_3、写错后-可以通过delete删除" aria-hidden="true">#</a> 3、写错后，可以通过<code>DELETE</code>删除</h5><p>如果写错了可以使用<code>DELETE product2</code>删除，<code>product2</code>重新添加就行了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DELETE product2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.3.png" alt="image-20220723203114440" tabindex="0" loading="lazy"><figcaption>image-20220723203114440</figcaption></figure><h5 id="_4、迁移数据" tabindex="-1"><a class="header-anchor" href="#_4、迁移数据" aria-hidden="true">#</a> 4、迁移数据</h5><p>然后使用如下命令，进行数据迁移</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _reindex
<span class="token punctuation">{</span>
  <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>POST _reindex</code>为固定写法，<code>source</code>里的<code>index</code>里写老数据的索引，<code>dest</code>写想要迁移到的索引</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.4.png" alt="image-20220723204346825" tabindex="0" loading="lazy"><figcaption>image-20220723204346825</figcaption></figure><h5 id="_5、查询数据" tabindex="-1"><a class="header-anchor" href="#_5、查询数据" aria-hidden="true">#</a> 5、查询数据</h5><p>使用<code>GET product2/_search</code>命令，查看数据，可以看到数据已经迁移过来了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product2/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.5.png" alt="image-20220723204514369" tabindex="0" loading="lazy"><figcaption>image-20220723204514369</figcaption></figure><h5 id="_6、添加skuprice属性" tabindex="-1"><a class="header-anchor" href="#_6、添加skuprice属性" aria-hidden="true">#</a> 6、添加<code>skuPrice</code>属性</h5><p>使用如下方式，可以把匹配到的数据里，添加<code>skuPrice</code>属性</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /product2/_update_by_query
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;inline&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx._source[&#39;skuPrice&#39;] = &#39;5000&#39;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.6.png" alt="image-20220723205423193" tabindex="0" loading="lazy"><figcaption>image-20220723205423193</figcaption></figure><p>1.源生API</p><p>在这里没有用官方提供的<code>bulk</code> API，而是用的另外一种方式。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST /infomations/infomations/_update_by_query
JSON请求格式
{
    &quot;query&quot;: {
        &quot;match&quot;: {
            &quot;status&quot;: &quot;UP_SHELF&quot;
        }
    },
    &quot;script&quot;: {
        &quot;inline&quot;: &quot;ctx._source[&#39;status&#39;] = &#39;DOWN_SHELF&#39;&quot;
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST请求/索引/文档名/_update_by_query

主要看一下下面的script

ctx._source[字段名] = “值”;ctx._source[字段名] = “值”;
多个的话就用分号隔开。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.JAVA API操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//集群模式，获取链接        </span>
<span class="token class-name">Client</span> client <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
<span class="token class-name">UpdateByQueryRequestBuilder</span> updateByQuery <span class="token operator">=</span> <span class="token class-name">UpdateByQueryAction</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">newRequestBuilder</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;修改数值&quot;</span><span class="token punctuation">;</span>
updateByQuery<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">&quot;索引&quot;</span><span class="token punctuation">)</span>         <span class="token comment">//查询要修改的结果集</span>
<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;field&quot;</span><span class="token punctuation">,</span> <span class="token number">412</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment">//修改操作 </span>
<span class="token punctuation">.</span><span class="token function">script</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Script</span><span class="token punctuation">(</span> <span class="token string">&quot;ctx._source[&#39;field&#39;]=&#39;&quot;</span><span class="token operator">+</span> name<span class="token operator">+</span><span class="token string">&quot;&#39;;ctx._source[&#39;field&#39;]=&#39;&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//响应结果集        </span>
<span class="token class-name">BulkByScrollResponse</span> response <span class="token operator">=</span> updateByQuery<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> updated <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getUpdated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_7、查看数据" tabindex="-1"><a class="header-anchor" href="#_7、查看数据" aria-hidden="true">#</a> 7、查看数据</h5><p>使用<code>GET product2/_search</code>命令，查看数据，可以看到已有<code>skuPrice</code>属性，并附上默认值了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product2/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.7.png" alt="image-20220723205510858" tabindex="0" loading="lazy"><figcaption>image-20220723205510858</figcaption></figure><h5 id="_8、再迁移回product" tabindex="-1"><a class="header-anchor" href="#_8、再迁移回product" aria-hidden="true">#</a> 8、再迁移回<code>product</code></h5><p>再通过相同的方式，删掉<code>product</code>，再迁移过来</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DELETE product
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.8.1.png" alt="image-20220723210155470" tabindex="0" loading="lazy"><figcaption>image-20220723210155470</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product2/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.8.2.png" alt="image-20220723210322868" tabindex="0" loading="lazy"><figcaption>image-20220723210322868</figcaption></figure><p>这里的<code>attrs</code>里面应该还有<code>&quot;type&quot; : &quot;nested&quot;,</code>，这里没有，所以后面报错了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.8.3.png" alt="image-20220723210305651" tabindex="0" loading="lazy"><figcaption>image-20220723210305651</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST _reindex
{
  &quot;source&quot;: {
    &quot;index&quot;: &quot;product2&quot;
  },
  &quot;dest&quot;: {
    &quot;index&quot;: &quot;product&quot;
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.8.4.png" alt="image-20220723210438315" tabindex="0" loading="lazy"><figcaption>image-20220723210438315</figcaption></figure><h5 id="_9、查询出错" tabindex="-1"><a class="header-anchor" href="#_9、查询出错" aria-hidden="true">#</a> 9、查询出错</h5><p>然后执行查询，可以发现执行出错了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.9.1.png" alt="image-20220723213928183" tabindex="0" loading="lazy"><figcaption>image-20220723213928183</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里的<code>attrs</code>里面应该还有<code>&quot;type&quot; : &quot;nested&quot;,</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.9.2.png" alt="image-20220723214306034" tabindex="0" loading="lazy"><figcaption>image-20220723214306034</figcaption></figure><h5 id="_10、重新映射" tabindex="-1"><a class="header-anchor" href="#_10、重新映射" aria-hidden="true">#</a> 10、重新映射</h5><p>删掉<code>product</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DELETE product
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.10.1.png" alt="image-20220724160104844" tabindex="0" loading="lazy"><figcaption>image-20220724160104844</figcaption></figure><p>重新映射</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT product
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.10.2.png" alt="image-20220724160201531" tabindex="0" loading="lazy"><figcaption>image-20220724160201531</figcaption></figure><p>这次有<code>attrs</code>属性有<code>&quot;type&quot;: &quot;nested&quot;,</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.10.3.png" alt="image-20220724161122333" tabindex="0" loading="lazy"><figcaption>image-20220724161122333</figcaption></figure><p><code>skuPrice</code>的<code>type</code>也为<code>keyword</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.10.4.png" alt="image-20220724161159451" tabindex="0" loading="lazy"><figcaption>image-20220724161159451</figcaption></figure><h5 id="_11、重新上架" tabindex="-1"><a class="header-anchor" href="#_11、重新上架" aria-hidden="true">#</a> 11、重新上架</h5><p>打开<code>Navicat</code>软件，点击<code>gulimall_pms</code>数据库，打开<code>pms_spu_info</code>表，修改<code>华为</code>和<code>IPhone</code>的<code>publish_status</code>为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.11.1.png" alt="image-20220724155727408" tabindex="0" loading="lazy"><figcaption>image-20220724155727408</figcaption></figure><p>启动<code>Unnamed</code>，即启动<code>GulimallCouponApplication</code>、<code>GulimallGatewayApplication</code>、<code>GulimallMemberApplication</code>、<code>GulimallProductApplication</code>、<code>GulimallSearchApplication</code>、<code>GulimallThirdPartyApplication</code>、<code>GulimallWareApplication</code>、<code>RenrenApplication</code>，共8个服务(注意启动<code>nacos</code>)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.11.2.png" alt="image-20220724155937981" tabindex="0" loading="lazy"><figcaption>image-20220724155937981</figcaption></figure><p>然后启动后台的<code>vue</code>项目，用户名和密码都为<code>admin</code>，在<code>商品系统/商品维护/spu管理</code>里点击<code>华为</code>和<code>IPhone</code>右侧<code>操作</code>里的<code>上架</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.11.3.png" alt="image-20220724161631575" tabindex="0" loading="lazy"><figcaption>image-20220724161631575</figcaption></figure><p>通过<code>kibana</code>查询数据，可以看到还是没有<code>skuPrice</code>属性</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.11.4.png" alt="image-20220724161903319" tabindex="0" loading="lazy"><figcaption>image-20220724161903319</figcaption></figure><p>使用如下方式，可以把匹配到的数据里，添加<code>skuPrice</code>属性</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /product/_update_by_query
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;inline&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx._source[&#39;skuPrice&#39;] = &#39;5000&#39;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.11.5.png" alt="image-20220724163508606" tabindex="0" loading="lazy"><figcaption>image-20220724163508606</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /product/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.3.11.6.png" alt="image-20220724163524123" tabindex="0" loading="lazy"><figcaption>image-20220724163524123</figcaption></figure><h4 id="_4、高亮显示" tabindex="-1"><a class="header-anchor" href="#_4、高亮显示" aria-hidden="true">#</a> 4、高亮显示</h4><p>添加分页从<code>0</code>开始，向后查询<code>5</code>个数据，并把匹配到的<code>skuTitle</code>颜色设置为红色</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
<span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
<span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;/b&gt;&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.4.png" alt="image-20220722213436383" tabindex="0" loading="lazy"><figcaption>image-20220722213436383</figcaption></figure><p>完整查询语句：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;华为&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;225&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;9&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">{</span>
                    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">{</span>
                    <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;A2100&quot;</span>
                      <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">6000</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;/b&gt;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5、聚合查询" tabindex="-1"><a class="header-anchor" href="#_5、聚合查询" aria-hidden="true">#</a> 5、聚合查询</h4><h5 id="_1、子聚合报错" tabindex="-1"><a class="header-anchor" href="#_1、子聚合报错" aria-hidden="true">#</a> 1、子聚合报错</h5><p>聚合后只能获取到<code>brandId</code>，想要获取<code>brandName</code>可以用到子聚合，子聚合可以根据上一步的聚合结果再次进行聚合</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">,</span> <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是通过子聚合报错了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;reason&quot;: &quot;Can&#39;t load fielddata on [brandName] because fielddata is unsupported on fields of type [keyword]. Use doc values instead.&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.5.1.png" alt="image-20220724164420419" tabindex="0" loading="lazy"><figcaption>image-20220724164420419</figcaption></figure><h5 id="_2、原因" tabindex="-1"><a class="header-anchor" href="#_2、原因" aria-hidden="true">#</a> 2、原因</h5><p>这是因为当时在创建映射时，对这些字段设置<code>&quot;index&quot; : false,</code>不进行查询，<code>&quot;doc_values&quot; : false</code>不进行聚合，从而节省内存。要想可以聚合只能进行数据迁移，然后再修改映射</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.5.2.png" alt="image-20220724164941728" tabindex="0" loading="lazy"><figcaption>image-20220724164941728</figcaption></figure><h4 id="_6、数据迁移" tabindex="-1"><a class="header-anchor" href="#_6、数据迁移" aria-hidden="true">#</a> 6、数据迁移</h4><h5 id="_1、获取product映射-1" tabindex="-1"><a class="header-anchor" href="#_1、获取product映射-1" aria-hidden="true">#</a> 1、获取<code>product</code>映射</h5><p>使用<code>GET product/_mapping</code>，获取<code>product</code>的映射信息，然后复制结果</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET product/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.6.1.png" alt="image-20220724165209526" tabindex="0" loading="lazy"><figcaption>image-20220724165209526</figcaption></figure><h5 id="_2、向gulimall-product创建映射" tabindex="-1"><a class="header-anchor" href="#_2、向gulimall-product创建映射" aria-hidden="true">#</a> 2、向<code>gulimall_product</code>创建映射</h5><p>输入<code>PUT gulimall_product</code>，并粘贴刚刚复制的结果，再删除<code>粘贴过来的结果</code>里的<code>&quot;product&quot; :{ }</code>右括号随便在最后删除一个就行了</p><p>然后点击<code>工具</code>图标，选择<code>Auto indent</code>格式化一下代码，再在里面修改映射信息</p><p>这里需要把所有的<code>&quot;index&quot; : false, &quot;doc_values&quot; : false</code>都删掉，然后点击执行</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT gulimall_product
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.6.2.png" alt="image-20220724165940837" tabindex="0" loading="lazy"><figcaption>image-20220724165940837</figcaption></figure><h5 id="_3、迁移数据" tabindex="-1"><a class="header-anchor" href="#_3、迁移数据" aria-hidden="true">#</a> 3、迁移数据</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _reindex
<span class="token punctuation">{</span>
  <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gulimall_product&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.6.3.png" alt="image-20220724170234036" tabindex="0" loading="lazy"><figcaption>image-20220724170234036</figcaption></figure><h5 id="_4、查询数据" tabindex="-1"><a class="header-anchor" href="#_4、查询数据" aria-hidden="true">#</a> 4、查询数据</h5><p>可以看到数据都迁移过来了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET gulimall_product/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.6.4.png" alt="image-20220724170343570" tabindex="0" loading="lazy"><figcaption>image-20220724170343570</figcaption></figure><h5 id="_5、修改常量" tabindex="-1"><a class="header-anchor" href="#_5、修改常量" aria-hidden="true">#</a> 5、修改常量</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.constant.EsConstant</code>常量类里修改<code>PRODUCT_INDEX</code>字段，使用新的索引</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PRODUCT_INDEX</span> <span class="token operator">=</span> <span class="token string">&quot;gulimall_product&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.6.5.png" alt="image-20220724170527735" tabindex="0" loading="lazy"><figcaption>image-20220724170527735</figcaption></figure><h5 id="_6、再次查询" tabindex="-1"><a class="header-anchor" href="#_6、再次查询" aria-hidden="true">#</a> 6、再次查询</h5><p>再次使用<code>gulimall_product</code>查询，就可以查到数据了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">,</span> <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.6.6.png" alt="image-20220724182331880" tabindex="0" loading="lazy"><figcaption>image-20220724182331880</figcaption></figure><h4 id="_7、嵌入式聚合" tabindex="-1"><a class="header-anchor" href="#_7、嵌入式聚合" aria-hidden="true">#</a> 7、嵌入式聚合</h4><p>使用如下查询回查询不到数据</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">,</span> <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;catalog_name_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;attr_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.7.1.png" alt="image-20220725161115201" tabindex="0" loading="lazy"><figcaption>image-20220725161115201</figcaption></figure><p>如果是嵌入式的属性，查询，聚合，分析都应该用嵌入式的，因此不能直接获取<code>attrs.attrId</code>的聚合结果</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;catalog_name_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attr_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;attr_id_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.7.2.png" alt="image-20220725160847972" tabindex="0" loading="lazy"><figcaption>image-20220725160847972</figcaption></figure><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/8.3/query-dsl-nested-query.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.7.3.gif" alt="GIF 2022-7-24 18-47-57" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-24 18-47-57</figcaption></figure><p><strong>Nested aggregation</strong></p><blockquote><p>A special single bucket aggregation that enables aggregating nested documents.</p><p>For example, lets say we have an index of products, and each product holds the list of resellers - each having its own price for the product. The mapping could look like:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /products
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;resellers&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;reseller&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;double&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The following request adds a product with two resellers:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /products/_doc/<span class="token number">0</span>?refresh
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;LED TV&quot;</span><span class="token punctuation">,</span> 
  <span class="token property">&quot;resellers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;reseller&quot;</span><span class="token operator">:</span> <span class="token string">&quot;companyA&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">350</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;reseller&quot;</span><span class="token operator">:</span> <span class="token string">&quot;companyB&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">500</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The following request returns the minimum price a product can be purchased for:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /products/_search?size=<span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;led tv&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;resellers&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;resellers&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;min_price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;min&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;resellers.price&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>As you can see above, the nested aggregation requires the <code>path</code> of the nested documents within the top level documents. Then one can define any type of aggregation over these nested documents.</p></blockquote><h4 id="_8、完整查询" tabindex="-1"><a class="header-anchor" href="#_8、完整查询" aria-hidden="true">#</a> 8、完整查询</h4><p><a href="code/5.5.3.8.txt">点击查看完整查询</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.3.8.png" alt="image-20220724190807948" tabindex="0" loading="lazy"><figcaption>image-20220724190807948</figcaption></figure><h3 id="_5-5-4、java发送请求给es" tabindex="-1"><a class="header-anchor" href="#_5-5-4、java发送请求给es" aria-hidden="true">#</a> 5.5.4、<code>Java</code>发送请求给<code>ES</code></h3><h4 id="_1、封装请求数据" tabindex="-1"><a class="header-anchor" href="#_1、封装请求数据" aria-hidden="true">#</a> 1、封装请求数据</h4><h5 id="_1、指定分页大小" tabindex="-1"><a class="header-anchor" href="#_1、指定分页大小" aria-hidden="true">#</a> 1、指定分页大小</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.constant.EsConstant</code>类里，添加<code>PRODUCT_PAGE_SIZE</code>属性，用来指定分页的大小</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 分页大小
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> <span class="token constant">PRODUCT_PAGE_SIZE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.1.png" alt="image-20220725151744774" tabindex="0" loading="lazy"><figcaption>image-20220725151744774</figcaption></figure><h5 id="_2、模糊匹配-过滤" tabindex="-1"><a class="header-anchor" href="#_2、模糊匹配-过滤" aria-hidden="true">#</a> 2、<code>模糊匹配</code>，<code>过滤</code></h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl</code>包下，新建<code>ProductSaveServiceImpl</code>类，用来进行商品的检索</p><p>首先封装<code>模糊匹配，过滤</code>，可以把<code>IDEA</code>水平分割，在<code>IDEA</code>里的左边放<code>想发送的请求</code>，在<code>IDEA</code>里的右边放<code>要用代码实现的请求</code>，</p><p>每写一部分，把该部分<code>想发送的请求</code>的<code>JSON</code>展开，把其他部分的<code>JSON</code>折叠，这样可以一步一步实现对应功能</p><p><a href="code/5.5.4.1.2.MallSearchServiceImpl.java">点击查看<code>MallSearchServiceImpl</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.2.png" alt="image-20220725144145427" tabindex="0" loading="lazy"><figcaption>image-20220725144145427</figcaption></figure><h5 id="_3、排序、分页、高亮" tabindex="-1"><a class="header-anchor" href="#_3、排序、分页、高亮" aria-hidden="true">#</a> 3、<code>排序</code>、<code>分页</code>、<code>高亮</code></h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.ProductSaveServiceImpl</code>类里的<code>buildSearchRequest</code>方法里，添加如下代码，用来设置<code>排序</code>、<code>分页</code>、<code>高亮</code>等信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//排序</span>
<span class="token comment">//sort=saleCount_asc/desc</span>
<span class="token class-name">String</span> sort <span class="token operator">=</span> searchParam<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> sort<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sort<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">SortOrder</span> sortOrder <span class="token operator">=</span> <span class="token string">&quot;asc&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token operator">:</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">;</span>
        <span class="token comment">//SortOrder sortOrder = SortOrder.fromString(s[1]);</span>
        sourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sortOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//分页</span>
<span class="token class-name">Integer</span> pageNum <span class="token operator">=</span> searchParam<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>pageNum<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> pageNum<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> from <span class="token operator">=</span> <span class="token punctuation">(</span>pageNum<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_PAGE_SIZE</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//高亮</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.3.png" alt="image-20220725145835141" tabindex="0" loading="lazy"><figcaption>image-20220725145835141</figcaption></figure><h5 id="_4、测试-1-1" tabindex="-1"><a class="header-anchor" href="#_4、测试-1-1" aria-hidden="true">#</a> 4、测试(1)</h5><h6 id="_1、输出sourcebuilder信息" tabindex="-1"><a class="header-anchor" href="#_1、输出sourcebuilder信息" aria-hidden="true">#</a> 1、输出<code>sourceBuilder</code>信息</h6><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.ProductSaveServiceImpl</code>类里的<code>buildSearchRequest</code>方法返回前，输出<code>sourceBuilder</code>信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.4.1.png" alt="image-20220725150952617" tabindex="0" loading="lazy"><figcaption>image-20220725150952617</figcaption></figure><h6 id="_2、发送请求" tabindex="-1"><a class="header-anchor" href="#_2、发送请求" aria-hidden="true">#</a> 2、发送请求</h6><p>使用<code>Postman</code>发送如下请求，查看默认返回的商品信息</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.4.2.png" alt="image-20220725151033746" tabindex="0" loading="lazy"><figcaption>image-20220725151033746</figcaption></figure><h6 id="_3、复制发送的请求" tabindex="-1"><a class="header-anchor" href="#_3、复制发送的请求" aria-hidden="true">#</a> 3、复制发送的请求</h6><p>复制<code>GulimallSearchApplication</code>服务的控制台输出的请求信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.4.3.png" alt="image-20220725152405404" tabindex="0" loading="lazy"><figcaption>image-20220725152405404</figcaption></figure><h6 id="_4、查看请求" tabindex="-1"><a class="header-anchor" href="#_4、查看请求" aria-hidden="true">#</a> 4、查看请求</h6>`,177),Wn=n("code",null,"JSON",-1),Hn={href:"https://www.bejson.com/",target:"_blank",rel:"noopener noreferrer"},Kn=n("code",null,"格式化校验",-1),Xn=p(`<p>可以看到，此时的查询条件只有<code>hasStock</code>为<code>true</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
						<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
						<span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1.0</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			<span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1.0</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.4.4.png" alt="image-20220725152445606" tabindex="0" loading="lazy"><figcaption>image-20220725152445606</figcaption></figure><h6 id="_5、在kibana中执行请求" tabindex="-1"><a class="header-anchor" href="#_5、在kibana中执行请求" aria-hidden="true">#</a> 5、在<code>kibana</code>中执行请求</h6><p>在<code>kibana</code>中执行如下请求，然后查看返回的结果，可以看到，已经查询出所有<code>hasStock</code>为<code>true</code>的数据了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
	<span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
						<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
						<span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1.0</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			<span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1.0</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.4.5.png" alt="image-20220725152528831" tabindex="0" loading="lazy"><figcaption>image-20220725152528831</figcaption></figure><h5 id="_5、测试-2" tabindex="-1"><a class="header-anchor" href="#_5、测试-2" aria-hidden="true">#</a> 5、测试(2)</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.5.1.png" alt="image-20220725152803797" tabindex="0" loading="lazy"><figcaption>image-20220725152803797</figcaption></figure><p>复制<code>GulimallSearchApplication</code>服务的控制台输出的请求信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.5.2.png" alt="image-20220725152907806" tabindex="0" loading="lazy"><figcaption>image-20220725152907806</figcaption></figure><p>在<code>kibana</code>中执行如下请求，然后查看返回的结果，可以看到，已经查询出所有<code>hasStock</code>为<code>true</code>、<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>的数据了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;operator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
              <span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">225</span><span class="token punctuation">,</span>
              <span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;&lt;/b&gt;&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.5.3.png" alt="image-20220725152956547" tabindex="0" loading="lazy"><figcaption>image-20220725152956547</figcaption></figure><h5 id="_6、测试-3" tabindex="-1"><a class="header-anchor" href="#_6、测试-3" aria-hidden="true">#</a> 6、测试(3)</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225&amp;attrs=1_LIO-A00:A13
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.6.1.png" alt="image-20220725153318989" tabindex="0" loading="lazy"><figcaption>image-20220725153318989</figcaption></figure><p>复制<code>GulimallSearchApplication</code>服务的控制台输出的请求信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;A13&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignore_unmapped&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;score_mode&quot;</span><span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.6.2.png" alt="image-20220725153352316" tabindex="0" loading="lazy"><figcaption>image-20220725153352316</figcaption></figure><p>在<code>kibana</code>中执行如下请求，然后查看返回的结果，可以看到，已经查询出所有<code>hasStock</code>为<code>true</code>、<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 的数据了，<a href="code/5.5.4.1.6.txt">点击查看完整请求</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.6.3.png" alt="image-20220725153503635" tabindex="0" loading="lazy"><figcaption>image-20220725153503635</figcaption></figure><h5 id="_7、测试-4" tabindex="-1"><a class="header-anchor" href="#_7、测试-4" aria-hidden="true">#</a> 7、测试(4)</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>2</code>号<code>attrId</code>其属性值为<code>HUAWEI Kirin 970</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225&amp;attrs=1_LIO-A00:A13&amp;attrs=2_HUAWEI Kirin 970
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.7.1.png" alt="image-20220725154316824" tabindex="0" loading="lazy"><figcaption>image-20220725154316824</figcaption></figure><p>复制<code>GulimallSearchApplication</code>服务的控制台输出的请求信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;A13&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignore_unmapped&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;score_mode&quot;</span><span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;HUAWEI Kirin 970&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignore_unmapped&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;score_mode&quot;</span><span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.7.2.png" alt="image-20220725154357224" tabindex="0" loading="lazy"><figcaption>image-20220725154357224</figcaption></figure><p>在<code>kibana</code>中执行如下请求，然后查看返回的结果，可以看到，已经查询出所有<code>hasStock</code>为<code>true</code>、<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>2</code>号<code>attrId</code>其属性值为<code>HUAWEI Kirin 970</code>的数据了，此时没有一条数据符合要求</p><p><a href="code/5.5.4.1.7.txt">点击查看完整请求</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.7.3.png" alt="image-20220725154517396" tabindex="0" loading="lazy"><figcaption>image-20220725154517396</figcaption></figure><h5 id="_8、测试-5" tabindex="-1"><a class="header-anchor" href="#_8、测试-5" aria-hidden="true">#</a> 8、测试(5)</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>skuPrice</code>大于<code>6000</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225&amp;attrs=1_LIO-A00:A13&amp;skuPrice=_6000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.8.1.png" alt="image-20220725154730511" tabindex="0" loading="lazy"><figcaption>image-20220725154730511</figcaption></figure><p>复制<code>GulimallSearchApplication</code>服务的控制台输出的请求信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;A13&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignore_unmapped&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;score_mode&quot;</span><span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;range&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;6000&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;include_lower&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;include_upper&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.8.2.png" alt="image-20220725154813592" tabindex="0" loading="lazy"><figcaption>image-20220725154813592</figcaption></figure><p>在<code>kibana</code>中执行如下请求，然后查看返回的结果，可以看到，已经查询出所有<code>hasStock</code>为<code>true</code>、<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>skuPrice</code>大于<code>6000</code>的数据了</p><p><a href="code/5.5.4.1.8.txt">点击查看完整请求</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.8.3.png" alt="image-20220725154927216" tabindex="0" loading="lazy"><figcaption>image-20220725154927216</figcaption></figure><h5 id="_9、聚合分析" tabindex="-1"><a class="header-anchor" href="#_9、聚合分析" aria-hidden="true">#</a> 9、<code>聚合分析</code></h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchRequest</code>方法里的返回前面，添加如下代码：，用于<code>品牌聚合</code>、<code>分类聚合</code>、<code>属性聚合</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//聚合分析</span>

<span class="token comment">//品牌聚合</span>
<span class="token comment">//&quot;aggs&quot;: {&quot;brand_agg&quot;: {&quot;terms&quot;: {&quot;field&quot;: &quot;brandId&quot;,&quot;size&quot;: 10},</span>
<span class="token comment">//                         &quot;aggs&quot;: {&quot;brand_name_agg&quot;: {&quot;terms&quot;: {&quot;field&quot;: &quot;brandName&quot;,&quot;size&quot;: 1}},</span>
<span class="token comment">//                                  &quot;brand_img_agg&quot;:{&quot;terms&quot;: {&quot;field&quot;: &quot;brandImg&quot;,&quot;size&quot;: 1}}}}}</span>
<span class="token class-name">TermsAggregationBuilder</span> brandAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
brandAgg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
brandAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
brandAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_img_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>brandAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//分类聚合</span>
<span class="token comment">//&quot;aggs&quot;: {&quot;catalog_agg&quot;: {&quot;terms&quot;: {&quot;field&quot;: &quot;catalogId&quot;,&quot;size&quot;: 10},</span>
<span class="token comment">//                          &quot;aggs&quot;: {&quot;catalog_name_agg&quot;: {&quot;terms&quot;: {&quot;field&quot;: &quot;catalogName&quot;,&quot;size&quot;: 1}}}},}</span>
<span class="token class-name">TermsAggregationBuilder</span> catalogAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
catalogAgg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
catalogAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>catalogAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//属性聚合</span>
<span class="token comment">//&quot;aggs&quot;: {&quot;attr_agg&quot;:{&quot;nested&quot;: {&quot;path&quot;: &quot;attrs&quot;},</span>
<span class="token comment">//         &quot;aggs&quot;: {&quot;attr_id_agg&quot;:{&quot;terms&quot;: {&quot;field&quot;: &quot;attrs.attrId&quot;,&quot;size&quot;: 10},</span>
<span class="token comment">//            &quot;aggs&quot;: {&quot;attr_name_agg&quot;: {&quot;terms&quot;: {&quot;field&quot;: &quot;attrs.attrName&quot;,&quot;size&quot;: 1}},</span>
<span class="token comment">//                   &quot;attr_value_agg&quot;:{&quot;terms&quot;: {&quot;field&quot;: &quot;attrs.attrValue&quot;,&quot;size&quot;: 10}}}}}}}</span>
<span class="token class-name">NestedAggregationBuilder</span> attrAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">nested</span><span class="token punctuation">(</span><span class="token string">&quot;attr_agg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TermsAggregationBuilder</span> attrIdAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_id_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attrIdAgg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attrIdAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attrIdAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_value_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
attrAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>attrIdAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>attrAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.9.png" alt="image-20220725185608463" tabindex="0" loading="lazy"><figcaption>image-20220725185608463</figcaption></figure><h5 id="_10、测试" tabindex="-1"><a class="header-anchor" href="#_10、测试" aria-hidden="true">#</a> 10、测试</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>skuPrice</code>大于<code>6000</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225&amp;attrs=1_LIO-A00:A13&amp;skuPrice=_6000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.10.1.png" alt="image-20220725185732014" tabindex="0" loading="lazy"><figcaption>image-20220725185732014</figcaption></figure><p>复制<code>GulimallSearchApplication</code>服务的控制台输出的请求信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attrs.attrValue&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;LIO-A00&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;A13&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;ignore_unmapped&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;score_mode&quot;</span><span class="token operator">:</span><span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;range&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;6000&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;include_lower&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;include_upper&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalog_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_id_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_value_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.10.2.png" alt="image-20220725185835546" tabindex="0" loading="lazy"><figcaption>image-20220725185835546</figcaption></figure><p>在<code>kibana</code>中执行如下请求，然后查看返回的结果，可以看到，<code>品牌聚合</code>、<code>分类聚合</code>、<code>属性聚合</code>都已经成功展示了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.1.10.3.png" alt="image-20220727154908170" tabindex="0" loading="lazy"><figcaption>image-20220727154908170</figcaption></figure><h5 id="_11、完整代码" tabindex="-1"><a class="header-anchor" href="#_11、完整代码" aria-hidden="true">#</a> 11、完整代码</h5><p><a href="code/5.5.4.1.11.MallSearchServiceImpl.java">点击查看<code>MallSearchServiceImpl</code>类完整代码</a></p><h4 id="_2、处理响应数据" tabindex="-1"><a class="header-anchor" href="#_2、处理响应数据" aria-hidden="true">#</a> 2、处理响应数据</h4><h5 id="_1、打断点" tabindex="-1"><a class="header-anchor" href="#_1、打断点" aria-hidden="true">#</a> 1、打断点</h5><p>可以通过<code>debug</code>的方式查看<code>ES</code>返回的数据，进而对返回的数据进行相应处理</p><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里添加如下代码，并在该方法的第一行打上断点。以<code>debug</code>方式重新启动<code>GulimallSearchApplication</code>服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据查询到的数据，构建返回结果
 *
 * <span class="token keyword">@param</span> <span class="token parameter">searchParam</span>
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">SearchResult</span> <span class="token function">buildSearchResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">,</span> <span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResult</span> searchResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">////1、返回的所有查询到的商品</span>
    <span class="token comment">//searchResult.setProducts();</span>
    <span class="token comment">////2、当前所有商品涉及到的所有属性信息</span>
    <span class="token comment">//searchResult.setAttrs();</span>
    <span class="token comment">////3、当前所有商品涉及到的所有品牌信息</span>
    <span class="token comment">//searchResult.setBrands();</span>
    <span class="token comment">////4、当前所有商品涉及到的所有分类信息</span>
    <span class="token comment">//searchResult.setCatalogs();</span>
    <span class="token comment">//5、分页信息-页码</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//6、分页信息-总记录树</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//7、分页信息-总页码</span>
    <span class="token keyword">long</span> totalPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>total<span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//long totalPage = (total-1)%EsConstant.PRODUCT_PAGE_SIZE +1;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalPage<span class="token operator">&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        totalPage <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setTotalPages</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>totalPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> searchResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.1.png" alt="image-20220725184629044" tabindex="0" loading="lazy"><figcaption>image-20220725184629044</figcaption></figure><h5 id="_2、发送请求-1" tabindex="-1"><a class="header-anchor" href="#_2、发送请求-1" aria-hidden="true">#</a> 2、发送请求</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>skuPrice</code>大于<code>6000</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225&amp;attrs=1_LIO-A00:A13&amp;skuPrice=_6000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.2.png" alt="image-20220725190023037" tabindex="0" loading="lazy"><figcaption>image-20220725190023037</figcaption></figure><h5 id="_3、查看响应的response对象" tabindex="-1"><a class="header-anchor" href="#_3、查看响应的response对象" aria-hidden="true">#</a> 3、查看响应的<code>response</code>对象</h5><p>切换到<code>IDEA</code>，可以看到在<code>response</code>对象里的<code>internalResponse</code>属性里即有<code>hits</code>命中的记录和<code>aggregations</code>聚合分析的结果</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.3.png" alt="image-20220725190134099" tabindex="0" loading="lazy"><figcaption>image-20220725190134099</figcaption></figure><h5 id="_4、查看返回类型" tabindex="-1"><a class="header-anchor" href="#_4、查看返回类型" aria-hidden="true">#</a> 4、查看返回类型</h5><p>从<code>ES</code>中查出的数据是什么类型，<code>aggregations.get(&quot;catalog_agg&quot;);</code>返回的类型就写什么，不要使用<code>IDEA</code>生成的<code>Aggregation</code>类型</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.4.png" alt="image-20220725193128221" tabindex="0" loading="lazy"><figcaption>image-20220725193128221</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据查询到的数据，构建返回结果
 *
 * <span class="token keyword">@param</span> <span class="token parameter">searchParam</span>
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">SearchResult</span> <span class="token function">buildSearchResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">,</span> <span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResult</span> searchResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、返回的所有查询到的商品</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hits <span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> hits<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        skuEsModels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skuEsModels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setProducts</span><span class="token punctuation">(</span>skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">////2、当前所有商品涉及到的所有属性信息</span>
    <span class="token comment">//searchResult.setAttrs();</span>
    <span class="token comment">////3、当前所有商品涉及到的所有品牌信息</span>
    <span class="token comment">//searchResult.setBrands();</span>
    <span class="token comment">////4、当前所有商品涉及到的所有分类信息</span>
    <span class="token class-name">ParsedLongTerms</span> catalogAgg <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//searchResult.setCatalogs();</span>
    <span class="token comment">//5、分页信息-页码</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//6、分页信息-总记录树</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//7、分页信息-总页码</span>
    <span class="token keyword">long</span> totalPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>total<span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//long totalPage = (total-1)%EsConstant.PRODUCT_PAGE_SIZE +1;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalPage<span class="token operator">&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        totalPage <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    searchResult<span class="token punctuation">.</span><span class="token function">setTotalPages</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>totalPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> searchResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5、打断点" tabindex="-1"><a class="header-anchor" href="#_5、打断点" aria-hidden="true">#</a> 5、打断点</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里添加如下代码，获取聚合结果里的需要数据，并在该方法中根据获取到的聚合结果对<code>searchResult</code>对象设置各种属性的关键位置打上断点，<a href="code/5.5.4.2.5.buildSearchResponse.java">点击查看<code>buildSearchResponse</code>方法完整代码</a></p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.5.png" alt="image-20220725203447427" style="zoom:50%;"><h5 id="_6、测试" tabindex="-1"><a class="header-anchor" href="#_6、测试" aria-hidden="true">#</a> 6、测试</h5><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>、<code>catalogId</code>为<code>225</code>、<code>1</code>号<code>attrId</code>其属性值为<code>LIO-A00</code>或<code>A13</code> 、<code>skuPrice</code>大于<code>6000</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为&amp;catalog3Id=225&amp;attrs=1_LIO-A00:A13&amp;skuPrice=_6000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.1.png" alt="image-20220725190023037" tabindex="0" loading="lazy"><figcaption>image-20220725190023037</figcaption></figure><p>点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>searchResult.setProducts(skuEsModels);</code>这里，可以看到，在<code>skuEsModels</code>对象了，封装了<code>skuId</code>为<code>1</code>和<code>skuId</code>为<code>2</code>的两条数据，一个<code>skuTitle</code>为<code>8GB+128GB</code>，另一个<code>skuTitle</code>为<code>8GB+256GB</code>，但是查到的<code>skuImg</code>为空，而数据库中是有该图片的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.2.png" alt="image-20220725202950392" tabindex="0" loading="lazy"><figcaption>image-20220725202950392</figcaption></figure><p>这与在<code>kibana</code>中查询的数据一致，但是在通过<code>keyword</code>为<code>华为</code>进行搜索时，<code>skuTitle</code>里的<code>华为</code>并没有<code>红色</code>、<code>加粗</code>样式</p><p>而且没有<code>skuImg</code>属性，而数据库中是有该图片的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.3.png" alt="image-20220725204650097" tabindex="0" loading="lazy"><figcaption>image-20220725204650097</figcaption></figure><p>登录后台系统，在<code>商品系统/商品维护/商品管理</code>里面，可以看到<code>华为</code>的商品都是有图片的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.4.png" alt="image-20220727164425971" tabindex="0" loading="lazy"><figcaption>image-20220727164425971</figcaption></figure><p>继续点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>searchResult.setAttrs(attrVos);</code>这里，可以看到<code>attrVos</code>里封装了一个<code>attrVo</code>对象</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.5.png" alt="image-20220725203020614" tabindex="0" loading="lazy"><figcaption>image-20220725203020614</figcaption></figure><p>继续点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>searchResult.setBrands(brandVos);</code>这里，可以看到已经封装了<code>brandVos</code>对象的信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.6.png" alt="image-20220725203234794" tabindex="0" loading="lazy"><figcaption>image-20220725203234794</figcaption></figure><p>继续点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>searchResult.setCatalogs(catalogVos);</code>这里，可以看到已经封装了<code>catalogVos</code>对象的信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.7.png" alt="image-20220725203257449" tabindex="0" loading="lazy"><figcaption>image-20220725203257449</figcaption></figure><p>继续点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>return searchResult;</code>这里，可以看到已成功封装了<code>searchResult</code>的相关数据，但是<code>pageNum</code>为<code>null</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.2.6.8.png" alt="image-20220725203400694" tabindex="0" loading="lazy"><figcaption>image-20220725203400694</figcaption></figure><h4 id="_3、处理bug" tabindex="-1"><a class="header-anchor" href="#_3、处理bug" aria-hidden="true">#</a> 3、处理<code>bug</code></h4><h5 id="_1、设置当前页" tabindex="-1"><a class="header-anchor" href="#_1、设置当前页" aria-hidden="true">#</a> 1、设置当前页</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里，在<code>searchResult.setPageNum(pageNum);</code>前面加一处判断，如果当前页<code>pageNum</code>为<code>null</code>或<code>&lt;=0</code>，就赋上默认值<code>1</code></p><p>然后重启<code>GulimallSearchApplication</code>服务</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Integer pageNum = searchParam.getPageNum();
if (pageNum ==null|| pageNum&lt;=0){
    pageNum = 1;
}
searchResult.setPageNum(pageNum);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.1.1.png" alt="image-20220725210716273" tabindex="0" loading="lazy"><figcaption>image-20220725210716273</figcaption></figure><p>使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.1.2.png" alt="image-20220726150930269" tabindex="0" loading="lazy"><figcaption>image-20220726150930269</figcaption></figure><p>一直点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>return searchResult;</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.1.3.png" alt="image-20220726151842483" tabindex="0" loading="lazy"><figcaption>image-20220726151842483</figcaption></figure><p>查看<code>searchResult</code>对象数据，可以看到当前页<code>pageNum</code>已赋上默认值<code>1</code>，此时的<code>searchResult</code>对象里的<code>products</code>属性的<code>SkuEsModel</code>列表里的<code>skuTitle</code>里的<code>华为</code>还没有<code>红色</code>、<code>加粗</code>样式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.1.4.png" alt="image-20220726151826495" tabindex="0" loading="lazy"><figcaption>image-20220726151826495</figcaption></figure><p><code>skuTitle</code>里的<code>华为</code>还没有<code>红色</code>、<code>加粗</code>样式在<code>response</code>对象的<code>internalResponse</code>属性里的<code>hits</code>中的相应的<code>hit</code>里的<code>highlightFields</code>属性的第一个列表里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.1.5.png" alt="image-20220726150926735" tabindex="0" loading="lazy"><figcaption>image-20220726150926735</figcaption></figure><h5 id="_2、对关键字加粗" tabindex="-1"><a class="header-anchor" href="#_2、对关键字加粗" aria-hidden="true">#</a> 2、对关键字加粗</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里，在<code>skuEsModels.add(skuEsModel);</code>之前加个判断，如果请求中带有<code>keyword</code>，就把<code>skuTitle</code>里的<code>keyword</code>相关的部分应用<code>红色</code>、<code>加粗</code>样式</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HighlightField</span> skuTitle <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>skuTitle <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Text</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fragments <span class="token operator">=</span> skuTitle<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fragments <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> fragments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            skuEsModel<span class="token punctuation">.</span><span class="token function">setSkuTitle</span><span class="token punctuation">(</span>fragments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.2.1.png" alt="image-20220726152129230" tabindex="0" loading="lazy"><figcaption>image-20220726152129230</figcaption></figure><p>然后重启<code>GulimallSearchApplication</code>服务，使用<code>Postman</code>发送如下请求，查看<code>skuTitle</code>为<code>华为</code>的数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:12000/list.html?keyword=华为
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.2.2.png" alt="image-20220726150930269" tabindex="0" loading="lazy"><figcaption>image-20220726150930269</figcaption></figure><p>一直点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>return searchResult;</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.2.3.png" alt="image-20220726152009525" tabindex="0" loading="lazy"><figcaption>image-20220726152009525</figcaption></figure><p>查看<code>searchResult</code>对象数据，可以看到<code>searchResult</code>对象里的<code>products</code>属性的<code>SkuEsModel</code>列表里的<code>skuTitle</code>里的<code>华为</code>已应用<code>红色</code>、<code>加粗</code>样式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.4.3.2.4.png" alt="image-20220726151955731" tabindex="0" loading="lazy"><figcaption>image-20220726151955731</figcaption></figure><h5 id="_3、完整代码" tabindex="-1"><a class="header-anchor" href="#_3、完整代码" aria-hidden="true">#</a> 3、完整代码</h5><p><a href="code/5.5.4.3.3.MallSearchServiceImpl.java">点击查看<code>MallSearchServiceImpl</code>类完整代码</a></p><h3 id="_5-5-5、完善检索页-1" tabindex="-1"><a class="header-anchor" href="#_5-5-5、完善检索页-1" aria-hidden="true">#</a> 5.5.5、完善检索页(1)</h3><h4 id="_1、设置es里的商品数据" tabindex="-1"><a class="header-anchor" href="#_1、设置es里的商品数据" aria-hidden="true">#</a> 1、设置<code>ES</code>里的商品数据</h4><h5 id="_1、页面结构" tabindex="-1"><a class="header-anchor" href="#_1、页面结构" aria-hidden="true">#</a> 1、页面结构</h5><p>打开<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>，可以看到页面由<code>头部</code>、<code>搜索导航</code>、<code>热卖促销</code>、<code>手机</code>、<code>商品筛选和排序</code>、<code>商品精选</code>、<code>猜你喜欢</code>、<code>我的足迹</code>、<code>底部</code>、<code>右侧侧边栏</code>几部分组成</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.1.1.png" alt="image-20220726152506150" style="zoom:50%;"><h5 id="_2、rig-tab包裹4个商品div" tabindex="-1"><a class="header-anchor" href="#_2、rig-tab包裹4个商品div" aria-hidden="true">#</a> 2、<code>rig_tab</code>包裹4个商品<code>div</code></h5><p>在 http://search.gulimall.com/list.html 里，打开控制台，定位到<code>商品</code>的<code>div</code> ，可以看到每一个<code>class</code>为<code>rig_tab</code>的<code>div</code>里面有<code>4</code>个商品的<code>div</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.1.2.1.png" alt="image-20220726150521869" tabindex="0" loading="lazy"><figcaption>image-20220726150521869</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>里搜索<code>rig_tab</code>，也可以看出来，每一个<code>class</code>为<code>rig_tab</code>的<code>div</code>里面有<code>4</code>个商品的<code>div</code>，代表一行的商品</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.1.2.2.png" alt="image-20220726152654607" tabindex="0" loading="lazy"><figcaption>image-20220726152654607</figcaption></figure><h5 id="_3、修改代码" tabindex="-1"><a class="header-anchor" href="#_3、修改代码" aria-hidden="true">#</a> 3、修改代码</h5><p>只保留一个<code>class</code>为<code>rig_tab</code>的<code>div</code>，删掉其他<code>class</code>为<code>rig_tab</code>的<code>div</code>。并在这个<code>class</code>为<code>rig_tab</code>的<code>div</code>里面，只保留里面的一个<code>div</code>，删掉其他<code>div</code>，修改里面的代码，修改为如下所示：</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rig_tab<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prodect:\${result.getProducts()}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ico<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>iconfont icon-weiguanzhu<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>关注<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>da<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">th</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${prodect.skuImg}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dim<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tab_im<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>黑色<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${prodect.skuImg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tab_R<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>¥&#39;+\${prodect.skuPrice}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>¥5199.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tab_JE<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${prodect.skuTitle}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                Apple iPhone 7 Plus (A1661) 32G 黑色 移动联通电信4G手机
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tab_PI<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>已有<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>11万+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>热门评价
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>二手有售<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tab_CP<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>谷粒商城Apple产品专营店<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>谷粒商城Apple产品...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>#<span class="token punctuation">&#39;</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>联系供应商进行咨询<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/search/img/xcxc.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tab_FO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FO_one<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>自营
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>谷粒商城自营,品质保证<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>满赠
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>该商品参加满赠活动<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.1.3.png" alt="image-20220726155055223" tabindex="0" loading="lazy"><figcaption>image-20220726155055223</figcaption></figure><h5 id="_4、测试-2" tabindex="-1"><a class="header-anchor" href="#_4、测试-2" aria-hidden="true">#</a> 4、测试</h5><p>在浏览器中输入如下网址，可以看到已显示<code>ES</code>里的商品数据，但是图片没有显示出来</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.1.4.png" alt="image-20220726155237785" tabindex="0" loading="lazy"><figcaption>image-20220726155237785</figcaption></figure><h4 id="_2、添加图片url" tabindex="-1"><a class="header-anchor" href="#_2、添加图片url" aria-hidden="true">#</a> 2、添加图片<code>url</code></h4><p>启动<code>Unnamed</code>，即启动<code>GulimallCouponApplication</code>、<code>GulimallGatewayApplication</code>、<code>GulimallMemberApplication</code>、<code>GulimallProductApplication</code>、<code>GulimallSearchApplication</code>、<code>GulimallThirdPartyApplication</code>、<code>GulimallWareApplication</code>、<code>RenrenApplication</code>，共8个服务(注意启动<code>nacos</code>)</p><h5 id="_1、重新上架" tabindex="-1"><a class="header-anchor" href="#_1、重新上架" aria-hidden="true">#</a> 1、重新上架</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里的第一行打上断点。以<code>debug</code>方式重新启动<code>GulimallSearchApplication</code>服务，并刷新浏览器<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为</code>页面，切换到<code>IDEA</code>，可以看到<code>skuImg</code>为<code>null</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.1.1.png" alt="image-20220726155136252" tabindex="0" loading="lazy"><figcaption>image-20220726155136252</figcaption></figure><p>而在<code>kibana</code>中作以下查询，也会发现数据里面没有<code>skuImg</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;operator&quot;</span><span class="token operator">:</span><span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span><span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalog_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_id_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_value_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;pre_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;b style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;post_tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.1.2.png" alt="image-20220726155016758" tabindex="0" loading="lazy"><figcaption>image-20220726155016758</figcaption></figure><p>打开<code>Navicat</code>软件，点击<code>gulimall_pms</code>数据库，打开<code>pms_spu_info</code>表，修改<code>华为</code>的<code>publish_status</code>为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.1.3.png" alt="image-20220726161322223" tabindex="0" loading="lazy"><figcaption>image-20220726161322223</figcaption></figure><p>然后启动后台的<code>vue</code>项目，用户名和密码都为<code>admin</code>，在<code>商品系统/商品维护/spu管理</code>里点击<code>华为</code>和<code>IPhone</code>右侧<code>操作</code>里的<code>上架</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.1.4.png" alt="image-20220726161515229" tabindex="0" loading="lazy"><figcaption>image-20220726161515229</figcaption></figure><p>通过<code>kibana</code>查询数据，可以看到还是没有<code>skuPrice</code>属性</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.1.5.png" alt="image-20220726160010185" tabindex="0" loading="lazy"><figcaption>image-20220726160010185</figcaption></figure><h5 id="_2、打断点测试" tabindex="-1"><a class="header-anchor" href="#_2、打断点测试" aria-hidden="true">#</a> 2、打断点测试</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.ProductSaveServiceImpl</code>类的<code>productStatusUp</code>方法的第一行打上断点，然后重启<code>GulimallSearchApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.2.1.png" alt="image-20220726155921886" tabindex="0" loading="lazy"><figcaption>image-20220726155921886</figcaption></figure><p>打开<code>Navicat</code>软件，点击<code>gulimall_pms</code>数据库，打开<code>pms_spu_info</code>表，重新修改<code>华为</code>的<code>publish_status</code>字段，使其为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.2.2.png" alt="image-20220726161348561" tabindex="0" loading="lazy"><figcaption>image-20220726161348561</figcaption></figure><p>打开后台的<code>vue</code>项目，在<code>商品系统/商品维护/spu管理</code>里点击<code>华为</code>和<code>IPhone</code>右侧<code>操作</code>里的<code>上架</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.2.3.png" alt="image-20220726161520362" tabindex="0" loading="lazy"><figcaption>image-20220726161520362</figcaption></figure><p>可以看到<code>skuEsModels</code>里的<code>skuImg</code>和<code>skuPrice</code>都为<code>null</code>，所有就没有把<code>skuImg</code>和<code>skuPrice</code>的数据上传到<code>ES</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.2.4.png" alt="image-20220726160121631" tabindex="0" loading="lazy"><figcaption>image-20220726160121631</figcaption></figure><p>而后台的<code>vue</code>项目里，在<code>商品系统/商品维护/商品管理</code>里面，可以看到<code>华为</code>的商品都是有图片的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.2.5.png" alt="image-20220726160144185" tabindex="0" loading="lazy"><figcaption>image-20220726160144185</figcaption></figure><h5 id="_3、再次测试-2" tabindex="-1"><a class="header-anchor" href="#_3、再次测试-2" aria-hidden="true">#</a> 3、再次测试</h5><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>服务和<code>GulimallGatewayApplication</code>服务，在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法里的<code>第一行</code>和<code>R r = searchFeignService.productStatusUp(collect);</code>这两个地方打上断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.1.png" alt="image-20220726161650347" tabindex="0" loading="lazy"><figcaption>image-20220726161650347</figcaption></figure><p>打开后台的<code>vue</code>项目，在<code>商品系统/商品维护/spu管理</code>里点击<code>华为</code>和<code>IPhone</code>右侧<code>操作</code>里的<code>上架</code>按钮</p><p>💬如果放行了上次请求，可以打开<code>Navicat</code>软件，点击<code>gulimall_pms</code>数据库，打开<code>pms_spu_info</code>表，重新修改<code>华为</code>的<code>publish_status</code>字段，使其为<code>0</code>，再点击<code>上传</code></p><p>可以看到在数据中查询的<code>skuInfoEntities</code>是有<code>skuImg</code>和<code>skuPrice</code>数据的，不过叫<code>skuDefaultImg</code>和<code>price</code>罢了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.2.png" alt="image-20220726160514310" tabindex="0" loading="lazy"><figcaption>image-20220726160514310</figcaption></figure><p>点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>R r = searchFeignService.productStatusUp(collect);</code>这里，可以看到这里想向<code>GulimallSearchApplication</code>服务传的<code>collect</code>数据里的<code>skuImg</code>和<code>skuPrice</code>已经都为<code>null</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.3.png" alt="image-20220726160933888" tabindex="0" loading="lazy"><figcaption>image-20220726160933888</figcaption></figure><p>可以看到在整理向<code>GulimallSearchApplication</code>服务发送数据的代码里，就注释了要写<code>skuPrice</code>和<code>skuImg</code>，怪不得前面<code>ES</code>里没有<code>skuPrice</code>的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.4.png" alt="image-20220726160949540" tabindex="0" loading="lazy"><figcaption>image-20220726160949540</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法里，在<code>List&lt;SkuEsModel&gt; collect = skuInfoEntities.stream().map(skuInfoEntity -&gt; {</code>里添加如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//skuPrice</span>
skuEsModel<span class="token punctuation">.</span><span class="token function">setSkuPrice</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//skuImg</span>
skuEsModel<span class="token punctuation">.</span><span class="token function">setSkuImg</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getSkuDefaultImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.5.png" alt="image-20220726161058461" tabindex="0" loading="lazy"><figcaption>image-20220726161058461</figcaption></figure><p>打开后台的<code>vue</code>项目，在<code>商品系统/商品维护/spu管理</code>里点击<code>华为</code>和<code>IPhone</code>右侧<code>操作</code>里的<code>上架</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.6.png" alt="image-20220726161706872" tabindex="0" loading="lazy"><figcaption>image-20220726161706872</figcaption></figure><p>点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点停到<code>R r = searchFeignService.productStatusUp(collect);</code>这里，可以看到这里想向<code>GulimallSearchApplication</code>服务传的<code>collect</code>数据里的<code>skuImg</code>和<code>skuPrice</code>已经都有数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.7.png" alt="image-20220726161758500" tabindex="0" loading="lazy"><figcaption>image-20220726161758500</figcaption></figure><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，跳转到<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.ProductSaveServiceImpl</code>类的<code>productStatusUp</code>方法的第一行，</p><p>在<code>BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);</code>上打个断点，点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点，使断点听到刚打的断点的位置，可以看到<code>bulkRequest</code>对象里，已经有<code>skuImg</code>和<code>skuPrice</code>的数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.8.png" alt="image-20220726162655583" tabindex="0" loading="lazy"><figcaption>image-20220726162655583</figcaption></figure><p>在<code>kibana</code>里执行以下查询语句，就可以看到有<code>8</code>条数据，并且有正确的<code>skuImg</code>和<code>skuPrice</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;华为&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.9.png" alt="image-20220727202654983" tabindex="0" loading="lazy"><figcaption>image-20220727202654983</figcaption></figure><p>💬如果在<code>kibana</code>里执行<code>GET gulimall_product/_search</code>查询语句，则只有这一条<code>华为</code>的数据，这是因为<code>ES</code>分页了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.3.10.png" alt="image-20220726162739434" tabindex="0" loading="lazy"><figcaption>image-20220726162739434</figcaption></figure><h5 id="_4、收尾" tabindex="-1"><a class="header-anchor" href="#_4、收尾" aria-hidden="true">#</a> 4、收尾</h5><p>停掉<code>GulimallProductApplication</code>服务和<code>GulimallSearchApplication</code>服务，然后再运行这两个服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.4.1.png" alt="image-20220726161855276" tabindex="0" loading="lazy"><figcaption>image-20220726161855276</figcaption></figure><p>打开<code>Navicat</code>软件，点击<code>gulimall_pms</code>数据库，打开<code>pms_spu_info</code>表，修改<code>华为</code>和<code>IPhone</code>的<code>publish_status</code>为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.4.2.png" alt="image-20220727212558069" tabindex="0" loading="lazy"><figcaption>image-20220727212558069</figcaption></figure><p>打开后台的<code>vue</code>项目，在<code>商品系统/商品维护/spu管理</code>里点击<code>华为</code>和<code>IPhone</code>右侧<code>操作</code>里的<code>上架</code>按钮，就行了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.2.4.3.png" alt="image-20220727212654009" tabindex="0" loading="lazy"><figcaption>image-20220727212654009</figcaption></figure><h4 id="_3、对匹配到的关键词标红并加粗" tabindex="-1"><a class="header-anchor" href="#_3、对匹配到的关键词标红并加粗" aria-hidden="true">#</a> 3、对匹配到的关键词<code>标红</code>并<code>加粗</code></h4><p>打开<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为</code>页面，可以看到它标签对他进行了转义，显示了原本的<code>&lt;b style=&quot;color:red&quot;&gt;华为&lt;/b&gt;</code>，而不是对<code>华为</code>应用了<code>标红</code>并<code>加粗</code>的样式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.3.1.png" alt="image-20220726164052529" tabindex="0" loading="lazy"><figcaption>image-20220726164052529</figcaption></figure><p>打开<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件，搜索<code>\${prodect.skuTitle}</code>，然后把<code>&lt;a href=&quot;#&quot; th:text=&quot;\${prodect.skuTitle}&quot;&gt;</code>修改为<code>&lt;a href=&quot;#&quot; th:utext=&quot;\${prodect.skuTitle}&quot;&gt;</code></p><p><code>th:utext</code>表示不对文本进行转义，点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.3.2.png" alt="image-20220726164238113" tabindex="0" loading="lazy"><figcaption>image-20220726164238113</figcaption></figure><p>刷新<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为</code>页面，可以看到已经对<code>华为</code>应用了<code>标红</code>并<code>加粗</code>的样式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.3.3.png" alt="image-20220726164306730" tabindex="0" loading="lazy"><figcaption>image-20220726164306730</figcaption></figure><h4 id="_4、设置es里的品牌数据" tabindex="-1"><a class="header-anchor" href="#_4、设置es里的品牌数据" aria-hidden="true">#</a> 4、设置<code>ES</code>里的品牌数据</h4><p>在<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为</code>页面里，打开控制台，定位到<code>品牌</code>，复制<code>品牌</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.4.1.png" alt="image-20220726164420581" tabindex="0" loading="lazy"><figcaption>image-20220726164420581</figcaption></figure><p>然后在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，搜索品牌，即可看到相应标签，在里面找到<code>class</code>为<code>sl_value_logo</code>的<code>div</code>，只保留里面的一个<code>&lt;li&gt;</code>标签，删除其他多余的<code>&lt;li&gt;</code>标签</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.4.2.png" alt="image-20220726164642485" tabindex="0" loading="lazy"><figcaption>image-20220726164642485</figcaption></figure><p>修改其内容，如下所示：</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--品牌--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_nav_wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>品牌：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value_logo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>brand:\${result.brands}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${brand.brandImg}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${brand.brandName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                            华为(HUAWEI)
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.4.3.png" alt="image-20220726164956622" tabindex="0" loading="lazy"><figcaption>image-20220726164956622</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><p>然后刷新<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为</code>页面，可以看到已经成功显示相应<code>品牌</code>的<code>图标</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.4.4.png" alt="image-20220726165058838" tabindex="0" loading="lazy"><figcaption>image-20220726165058838</figcaption></figure><h4 id="_5、其他需要展示的属性" tabindex="-1"><a class="header-anchor" href="#_5、其他需要展示的属性" aria-hidden="true">#</a> 5、其他需要展示的属性</h4><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，在<code>品牌</code>的下面，删掉<code>价格</code>、<code>系统</code>、<code>热点</code>、<code>机身颜色</code>、<code>机身内存</code>，保留一个<code>屏幕尺寸</code>，修改里面的内容</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.5.1.png" alt="image-20220726165247466" tabindex="0" loading="lazy"><figcaption>image-20220726165247466</figcaption></figure><p>修改为如下内容，然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--其他的所有需要展示的属性--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_pre<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attr:\${result.attrs}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${attr.attrName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>屏幕尺寸：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>val:\${attr.attrValue}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${val}<span class="token punctuation">&quot;</span></span>
                   <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>attrs<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,<span class="token entity named-entity" title="&quot;">&amp;quot;</span>&#39;+attr.attrId+&#39;_&#39;+val+&#39;<span class="token entity named-entity" title="&quot;">&amp;quot;</span>)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
                5.56英寸及以上<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.5.2.png" alt="image-20220727205559815" tabindex="0" loading="lazy"><figcaption>image-20220727205559815</figcaption></figure><p>可以看到<code>入网型号</code>属性已经显示出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.5.3.png" alt="image-20220726165741784" tabindex="0" loading="lazy"><figcaption>image-20220726165741784</figcaption></figure><h4 id="_6、增加苹果库存" tabindex="-1"><a class="header-anchor" href="#_6、增加苹果库存" aria-hidden="true">#</a> 6、增加<code>苹果</code>库存</h4><p>浏览器输入<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=苹果</code>可以看到，都没有检索到数据，这是因为<code>苹果</code>的商品都没货，所以检索不到数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.6.1.png" alt="image-20220726171025918" tabindex="0" loading="lazy"><figcaption>image-20220726171025918</figcaption></figure><p>登录后台系统，在<code>商品系统/商品维护/商品管理</code>里面，可以看到<code>苹果</code>的商品有一个<code>skuId</code>为<code>9</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.6.2.png" alt="image-20220726170523635" tabindex="0" loading="lazy"><figcaption>image-20220726170523635</figcaption></figure><p>点击<code>库存系统/商品库存</code>里的<code>新增</code>按钮，新增一个商品库存</p><p><code>sku_id</code>输入<code>9</code>，<code>仓库</code>选择<code>1号仓库</code>，<code>库存数</code>输入<code>10</code>，<code>sku_name</code>输入<code>苹果手机</code>，<code>锁定库存</code>输入<code>0</code>，然后点击确定</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.6.3.png" alt="image-20220726170531116" tabindex="0" loading="lazy"><figcaption>image-20220726170531116</figcaption></figure><p>在<code>kibana</code>里，执行以下命令，将匹配到的数据的<code>hasStock</code>字段修改为<code>true</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_update_by_query
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;苹果&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;inline&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx._source[&#39;hasStock&#39;] = &#39;true&#39;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.6.4.png" alt="image-20220726170900220" tabindex="0" loading="lazy"><figcaption>image-20220726170900220</figcaption></figure><p>在<code>kibana</code>里，执行<code>GET gulimall_product/_search</code>命令，可以看到<code>苹果</code>的<code>hasStock</code>已经变为<code>true</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.6.5.png" alt="image-20220726171241380" tabindex="0" loading="lazy"><figcaption>image-20220726171241380</figcaption></figure><p>刷新<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=苹果</code>页面，可以看到已经查出数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.6.6.png" alt="image-20220726171202781" tabindex="0" loading="lazy"><figcaption>image-20220726171202781</figcaption></figure><h4 id="_7、增加可检索到的数据" tabindex="-1"><a class="header-anchor" href="#_7、增加可检索到的数据" aria-hidden="true">#</a> 7、增加可检索到的数据</h4><p>在<code>kibana</code>里，执行以下命令，修改<code>ES</code>中<code>id</code>为<code>10</code>的数据，修改<code>1</code>号<code>attrId</code>的<code>attrValue</code>为<code>A13</code>，修改<code>2</code>号<code>attrId</code>的<code>attrValue</code>为<code>8G</code>、<code>attrName</code>为<code>内存容量</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST gulimall_product/_doc/10
{
  &quot;brandImg&quot;: &quot;https://gulimall-anonymous.oss-cn-beijing.aliyuncs.com/2022-05-10/94d6c446-3d06-4e6e-8ddf-8da8f346f391_apple.png&quot;,
  &quot;hasStock&quot;: &quot;true&quot;,
  &quot;skuTitle&quot;: &quot;Apple IPhoneXS 苹果XS手机 银色 256GB&quot;,
  &quot;brandName&quot;: &quot;Apple&quot;,
  &quot;hotScore&quot;: 0,
  &quot;saleCount&quot;: 0,
  &quot;skuPrice&quot;: &quot;5000&quot;,
  &quot;attrs&quot;: [
    {
      &quot;attrId&quot;: 1,
      &quot;attrValue&quot;: &quot;A13&quot;,
      &quot;attrName&quot;: &quot;入网型号&quot;
    },
    {
      &quot;attrId&quot;: 2,
      &quot;attrValue&quot;: &quot;8G&quot;,
      &quot;attrName&quot;: &quot;内存容量&quot;
    }
  ],
  &quot;catalogName&quot;: &quot;手机&quot;,
  &quot;catalogId&quot;: 225,
  &quot;brandId&quot;: 4,
  &quot;spuId&quot;: 2,
  &quot;skuId&quot;: 10
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.7.1.png" alt="image-20220726173519836" tabindex="0" loading="lazy"><figcaption>image-20220726173519836</figcaption></figure><p>然后在<code>kibana</code>里，执行以下命令，查询刚刚修改的<code>id</code>为<code>10</code>的数据，可以看到数据已经修改了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET gulimall_product/_doc/10
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.7.2.png" alt="image-20220726173527413" tabindex="0" loading="lazy"><figcaption>image-20220726173527413</figcaption></figure><p>刷新<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=苹果</code>页面，可以看到<code>入网型号</code>多了<code>A13</code>，属性多了<code>内存容量</code>，其值为<code>8G</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.7.3.png" alt="image-20220726173451002" tabindex="0" loading="lazy"><figcaption>image-20220726173451002</figcaption></figure><p>输入<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=手机</code>网址，可以看到<code>华为</code>和<code>苹果</code>的<code>品牌</code>、<code>入网型号</code>、<code>内存容量</code>都显示出来了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=手机
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.7.4.png" alt="image-20220726173421220" tabindex="0" loading="lazy"><figcaption>image-20220726173421220</figcaption></figure><p>每次结果只能显示两个，结果有点少，因此可以修改<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.constant.EsConstant</code>类的<code>PRODUCT_PAGE_SIZE</code>字段，把该字段修改为<code>16</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> <span class="token constant">PRODUCT_PAGE_SIZE</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.7.5.png" alt="image-20220726194412699" tabindex="0" loading="lazy"><figcaption>image-20220726194412699</figcaption></figure><p>刷新<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=手机</code>页面，可以看到该页显示了更多的商品数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.7.6.png" alt="image-20220726194648709" tabindex="0" loading="lazy"><figcaption>image-20220726194648709</figcaption></figure><h4 id="_8、添加分类" tabindex="-1"><a class="header-anchor" href="#_8、添加分类" aria-hidden="true">#</a> 8、添加分类</h4><p>把<code>品牌</code>修改为<code>&lt;b&gt;品牌：&lt;/b&gt;</code>，复制<code>&lt;!--其他的所有需要展示的属性--&gt;</code>里的内容，粘贴到其上面，然后修改成分类的信息</p><p>点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--分类--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_pre<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>分类：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>catalog:\${result.catalogs}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${catalog.catalogName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.8.1.png" alt="image-20220726193026530" tabindex="0" loading="lazy"><figcaption>image-20220726193026530</figcaption></figure><p>可以看到在<code>商品筛选</code>里，已经多了<code>分类</code>条件，其可选值为<code>手机</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.8.2.png" alt="image-20220727211057758" tabindex="0" loading="lazy"><figcaption>image-20220727211057758</figcaption></figure><h4 id="_9、添加筛选条件" tabindex="-1"><a class="header-anchor" href="#_9、添加筛选条件" aria-hidden="true">#</a> 9、添加筛选条件</h4><h5 id="_1、添加品牌筛选" tabindex="-1"><a class="header-anchor" href="#_1、添加品牌筛选" aria-hidden="true">#</a> 1、添加品牌筛选</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下方法，用于添加条件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token operator">+</span><span class="token string">&quot;&amp;&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.1.1.png" alt="image-20220726194444104" tabindex="0" loading="lazy"><figcaption>image-20220726194444104</figcaption></figure><p>将<code>list.html</code>文件的<code>可选的品牌</code>里<code>class</code>为<code>sl_value</code>的<code>div</code>里的<code>&lt;a&gt;</code>标签改为如下代码，用于加参数跳转</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>brandId<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+brand.brandId+&#39;)&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中<code>&amp;quot;</code>为<code>&quot;</code>双引号，该代码相当于执行<code>javascript:searchProducts(&quot;brandId&quot;,brand.brandId)</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.1.2.png" alt="image-20220726194530101" tabindex="0" loading="lazy"><figcaption>image-20220726194530101</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=手机</code>页面里，点击<code>品牌</code>里的<code>华为</code>，可以看到已经跳转到了\`\`http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=手机&amp;brandId=1\`页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.1.3.gif" alt="GIF 2022-7-26 19-48-28" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 19-48-28</figcaption></figure><h5 id="_2、添加分类筛选" tabindex="-1"><a class="header-anchor" href="#_2、添加分类筛选" aria-hidden="true">#</a> 2、添加分类筛选</h5><p>将<code>list.html</code>文件的<code>可选的分类</code>里的<code>class</code>为<code>sl_value</code>的<code>div</code>里的<code>&lt;a&gt;</code>标签修改为如下代码，用于加参数跳转</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>catalog3Id<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+catalog.catalogId+&#39;)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${catalog.catalogName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中<code>&amp;quot;</code>为<code>&quot;</code>双引号，该代码相当于执行<code>javascript:searchProducts(&quot;catalog3Id&quot;,catalog.catalogId)</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.2.1.png" alt="image-20220726195357623" tabindex="0" loading="lazy"><figcaption>image-20220726195357623</figcaption></figure><p>在<code>http://search.gulimall.com/list.html</code>页面里，随便点击一个分类，此时的<code>url</code>为<code>http://search.gulimall.com/list.html&amp;catalog3Id=225</code>，而不是<code>http://search.gulimall.com/list.html?catalog3Id=225</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.2.2.gif" alt="GIF 2022-7-26 19-54-36" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 19-54-36</figcaption></figure><p>修改<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里的<code> searchProducts(name,value)</code>方法，当没有参数的时候用<code>?</code>拼接，而不是用<code>&amp;</code>拼接</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token operator">+</span><span class="token string">&quot;?&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token operator">+</span><span class="token string">&quot;&amp;&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.2.3.png" alt="image-20220726200128068" tabindex="0" loading="lazy"><figcaption>image-20220726200128068</figcaption></figure><p>再在<code>http://search.gulimall.com/list.html</code>页面里，随便点击一个分类，此时的<code>url</code>为<code>http://search.gulimall.com/list.html?catalog3Id=225</code>，已正确拼接了条件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.2.4.gif" alt="GIF 2022-7-26 20-01-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 20-01-54</figcaption></figure><h5 id="_3、添加属性筛选" tabindex="-1"><a class="header-anchor" href="#_3、添加属性筛选" aria-hidden="true">#</a> 3、添加属性筛选</h5><p>将<code>list.html</code>文件的<code>可选的属性</code>里的<code>class</code>为<code>sl_value</code>的<code>div</code>里的<code>&lt;a&gt;</code>标签修改为如下代码，用于加参数跳转</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${val}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>attrs<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,<span class="token entity named-entity" title="&quot;">&amp;quot;</span>&#39;+attr.attrId+&#39;_&#39;+val+&#39;<span class="token entity named-entity" title="&quot;">&amp;quot;</span>)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>5.56英寸及以上<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中<code>&amp;quot;</code>为<code>&quot;</code>双引号，该代码相当于执行<code>javascript:searchProducts(&quot;attrs&quot;,&quot;attr.attrId_val&quot;)</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.3.1.png" alt="image-20220726201041691" tabindex="0" loading="lazy"><figcaption>image-20220726201041691</figcaption></figure><p>打开<code>http://search.gulimall.com/list.html</code>页面，随便点一个<code>可选属性</code>的<code>属性值</code>，就来到了<code>http://search.gulimall.com/list.html?attrs=1_A2100</code>页面，可以看到以正确拼装了条件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.3.2.gif" alt="GIF 2022-7-26 20-09-25" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 20-09-25</figcaption></figure><h5 id="_4、修复bug" tabindex="-1"><a class="header-anchor" href="#_4、修复bug" aria-hidden="true">#</a> 4、修复<code>bug</code></h5><h6 id="_1、多属性添加" tabindex="-1"><a class="header-anchor" href="#_1、多属性添加" aria-hidden="true">#</a> 1、多属性添加</h6><p>在<code>http://search.gulimall.com/list.html</code>页面里，点击<code>入网型号</code>里的<code>A13</code>，会来到<code>http://search.gulimall.com/list.html?attrs=1_A13</code>页面。但点击<code>内存容量</code>里的<code>8G</code>后来到了<code>http://search.gulimall.com/list.html?attrs=2_8G</code>页面，变成了替换要筛选的属性，而不是继续添加属性。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.1.1.gif" alt="GIF 2022-7-30 19-25-45" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 19-25-45</figcaption></figure><p>将<code>list.html</code>文件的<code>可选的属性</code>里的<code>class</code>为<code>sl_value</code>的<code>div</code>里的<code>&lt;a&gt;</code>标签修改为如下代码，使其调用<code>attrAddOrReplace(paramName, replaceVal)</code>方法，用来进行特殊处理</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${val}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:attrAddOrReplace(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>attrs<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,<span class="token entity named-entity" title="&quot;">&amp;quot;</span>&#39;+attr.attrId+&#39;_&#39;+val+&#39;<span class="token entity named-entity" title="&quot;">&amp;quot;</span>)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>5.56英寸及以上<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.1.2.png" alt="image-20220730200503761" tabindex="0" loading="lazy"><figcaption>image-20220730200503761</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下方法，用来属性的添加与替换</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">attrAddOrReplace</span><span class="token punctuation">(</span><span class="token parameter">paramName<span class="token punctuation">,</span> replaceVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oUrl <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> nUrl <span class="token operator">=</span> oUrl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        oUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>oUrl<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> dif <span class="token operator">=</span> paramName <span class="token operator">+</span> replaceVal<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span><span class="token string">&quot;_&quot;</span>
    <span class="token comment">//如果url没有该参数名就添加，有就替换;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>dif<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span> dif <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=&#39;</span> <span class="token operator">+</span> replaceVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nUrl <span class="token operator">=</span> oUrl <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=&#39;</span> <span class="token operator">+</span> replaceVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            nUrl <span class="token operator">=</span> oUrl <span class="token operator">+</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=&#39;</span> <span class="token operator">+</span> replaceVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> nUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.1.3.png" alt="image-20220730200644618" tabindex="0" loading="lazy"><figcaption>image-20220730200644618</figcaption></figure><p>在<code>http://search.gulimall.com/list.html</code>页面里，点击<code>入网型号</code>里的<code>A13</code>，会来到<code>http://search.gulimall.com/list.html?attrs=1_A13</code>页面。但点击<code>内存容量</code>里的<code>8G</code>后来正确来到了<code>http://search.gulimall.com/list.html?attrs=1_A13&amp;attrs=2_8G</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.1.4.gif" alt="GIF 2022-7-30 20-03-05" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 20-03-05</figcaption></figure><h6 id="_2、总是添加属性而不进行替换" tabindex="-1"><a class="header-anchor" href="#_2、总是添加属性而不进行替换" aria-hidden="true">#</a> 2、总是添加属性而不进行替换</h6><p>当多次点击同一个<code>可选条件</code>的相同或不同的<code>可选值</code>时，同一个<code>可选条件</code>会不断添加，并不会替换为当前点击的\`\`可选值\`</p><p>比如在<code>http://search.gulimall.com/list.html</code>页面里，不断点击<code>品牌</code>为<code>华为</code>的可选值，该参数会不断添加成<code>http://search.gulimall.com/list.html?brandId=1&amp;brandId=1&amp;brandId=1&amp;brandId=1&amp;brandId=1&amp;brandId=1</code>这样的<code>url</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.2.1.gif" alt="GIF 2022-7-26 20-18-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 20-18-46</figcaption></figure><p>修改<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里的<code> searchProducts(name,value)</code>方法，修改相同<code>可选条件</code>的<code>可选值</code>为最新<code>可选值</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">var</span> href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> startIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url中有name参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> endIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span>startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果name参数不是最后一个参数，替换掉name参数后，则还要加上后面的参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>startIndex<span class="token punctuation">)</span> <span class="token operator">+</span> name <span class="token operator">+</span><span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>endIndex<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>startIndex<span class="token punctuation">)</span> <span class="token operator">+</span> name <span class="token operator">+</span><span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//url中没有name参数，则新的url中name有可能是第一个参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token operator">+</span><span class="token string">&quot;?&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token operator">+</span><span class="token string">&quot;&amp;&quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.2.2.png" alt="image-20220726204624453" tabindex="0" loading="lazy"><figcaption>image-20220726204624453</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?brandId=1&amp;catalog3Id=225&amp;attrs=1_LIO-A00</code>页面里，不断点击<code>入网型号</code>为<code>LIO-A00</code>的可选值，该参数的<code>url</code>始终为<code>http://search.gulimall.com/list.html?brandId=1&amp;catalog3Id=225&amp;attrs=1_LIO-A00</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.4.2.3.gif" alt="GIF 2022-7-26 20-41-48" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 20-41-48</figcaption></figure><h5 id="_5、添加关键字筛选" tabindex="-1"><a class="header-anchor" href="#_5、添加关键字筛选" aria-hidden="true">#</a> 5、添加关键字筛选</h5><p>在<code>http://search.gulimall.com/list.html?catalog3Id=225&amp;keyword=华为</code>页面里，打开控制台，定位到<code>搜索框</code>，复制<code>header_form</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.5.1.png" alt="image-20220726201255304" tabindex="0" loading="lazy"><figcaption>image-20220726201255304</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，将<code>class</code>为<code>header_form</code>的<code>div</code>里的<code>&lt;input&gt;</code>标签和<code>&lt;a&gt;</code>标签改为如下代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keyword_input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>手机<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:searchByKeyword();<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.5.2.png" alt="image-20220726204735176" tabindex="0" loading="lazy"><figcaption>image-20220726204735176</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下方法，用于关键字搜索，使用关键字搜索会清除其他筛选条件</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">searchByKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;?keyword&quot;</span><span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#keyword_input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> href <span class="token operator">+</span> <span class="token string">&quot;?keyword&quot;</span><span class="token operator">+</span><span class="token string">&quot;=&quot;</span><span class="token operator">+</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#keyword_input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.5.3.png" alt="image-20220726210238614" tabindex="0" loading="lazy"><figcaption>image-20220726210238614</figcaption></figure><p>打开<code>http://search.gulimall.com/list.html?brandId=1&amp;attrs=1_LIO-A00</code>页面，进行关键词搜索，可以看到已经清楚了其他筛选条件，来到了<code>http://search.gulimall.com/list.html?keyword=华为</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.5.4.gif" alt="GIF 2022-7-26 21-00-44" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-26 21-00-44</figcaption></figure><p>如果不起作用，可以将<code>class</code>为<code>header_form</code>的<code>div</code>里的<code>&lt;a&gt;</code>标签，使用<code>src</code>属性，调用<code>js</code>代码</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件，再进行尝试</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keyword_input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>手机<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:searchByKeyword();<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.5.5.png" alt="image-20220726205119808" tabindex="0" loading="lazy"><figcaption>image-20220726205119808</figcaption></figure><h5 id="_6、回显关键词" tabindex="-1"><a class="header-anchor" href="#_6、回显关键词" aria-hidden="true">#</a> 6、回显<code>关键词</code></h5><p>在<code>&lt;input&gt;</code>标签里添加<code>th:value=&quot;\${param.keyword}</code>，表示在<code>url</code>里面获取<code>keyword</code>参数的值作为<code>value</code>属性的值。</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keyword_input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>手机<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.keyword}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:searchByKeyword();<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.6.1.png" alt="image-20220729135851552" tabindex="0" loading="lazy"><figcaption>image-20220729135851552</figcaption></figure><p>可以看到，当在搜索框里搜索<code>商品</code>时，可以在<code>搜索框</code>里正确回显搜索的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.9.6.2.gif" alt="GIF 2022-7-29 13-52-47" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 13-52-47</figcaption></figure><h4 id="_10、分页" tabindex="-1"><a class="header-anchor" href="#_10、分页" aria-hidden="true">#</a> 10、分页</h4><h5 id="_1、遍历页数-显示总页数" tabindex="-1"><a class="header-anchor" href="#_1、遍历页数-显示总页数" aria-hidden="true">#</a> 1、遍历页数&amp;显示总页数</h5><p>在<code>http://search.gulimall.com/list.html</code>页面里，打开控制台，定位到<code>分页</code>，复制<code>filter_page</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.1.1.png" alt="image-20220726210456252" tabindex="0" loading="lazy"><figcaption>image-20220726210456252</figcaption></figure><p>然后在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，搜索<code>filter_page</code>，可以看到<code>分页</code>相关代码</p><p>修改页数代码，使其从<code>1</code>遍历到<code>result.totalPages</code>（<code>th:each=&quot;index:\${#numbers.sequence(1,result.totalPages)}&quot;</code>），并且如果遍历到<code>result.pageNum</code>（当前页）时对其应用<code>border: 0;color:#ee2222;background: #fff</code>样式，否则不应用（<code>th:style=&quot;\${index == result.pageNum ? &#39;border: 0;color:#ee2222;background: #fff&#39; : &#39;&#39;}&quot;</code>)</p><p>并修改为动态的<code>共多少页</code>（<code>&lt;em&gt;共&lt;b&gt;[[\${result.totalPages}]]&lt;/b&gt;页&amp;nbsp;&amp;nbsp;到第&lt;/em&gt;</code>）</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--分页--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_page<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                &lt; 上一页
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index:\${#numbers.sequence(1,result.totalPages)}<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${index == result.pageNum ? &#39;border: 0;color:#ee2222;background: #fff&#39; : &#39;&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>[[\${index}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--&lt;a href=&quot;#&quot; style=&quot;border: 0;font-size: 20px;color: #999;background: #fff&quot;&gt;...&lt;/a&gt;--&gt;</span>
            <span class="token comment">&lt;!--&lt;a href=&quot;#&quot;&gt;169&lt;/a&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                下一页 &gt;
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>共<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>[[\${result.totalPages}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>页<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span>到第<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>确定<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.1.2.png" alt="image-20220726214221219" tabindex="0" loading="lazy"><figcaption>image-20220726214221219</figcaption></figure><p>修改<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.constant.EsConstant</code>类的<code>PRODUCT_PAGE_SIZE</code>字段，把该字段修改为<code>6</code>，使数据能够多几页展示</p><p>然后重启<code>GulimallSearchApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.1.3.png" alt="image-20220728202822382" tabindex="0" loading="lazy"><figcaption>image-20220728202822382</figcaption></figure><p>在<code>kibana</code>里执行如下命令，把<code>苹果</code>商品都修改为有库存</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_update_by_query
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;苹果&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;inline&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ctx._source[&#39;hasStock&#39;] = &#39;true&#39;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.1.4.png" alt="image-20220728201454971" tabindex="0" loading="lazy"><figcaption>image-20220728201454971</figcaption></figure><p>执行以下命令，查询<code>苹果</code>商品的数据，可以看到都已经修改为有库存了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET gulimall_product/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;苹果&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.1.5.png" alt="image-20220728201625835" tabindex="0" loading="lazy"><figcaption>image-20220728201625835</figcaption></figure><p>访问<code>http://search.gulimall.com/list.html?pageNum=2</code>页面，可以看到遍历<code>1~3</code>没问题，当前<code>pageNum=2</code>页(第二页)也应用了不同的样式，<code>共多少页</code>也正确显示了</p><p>但是<code>上一页</code>和<code>下一页</code>的样式还有问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.1.6.png" alt="image-20220728203022631" tabindex="0" loading="lazy"><figcaption>image-20220728203022631</figcaption></figure><h5 id="_2、修改上一页和下一页样式" tabindex="-1"><a class="header-anchor" href="#_2、修改上一页和下一页样式" aria-hidden="true">#</a> 2、修改<code>上一页</code>和<code>下一页</code>样式</h5><p>修改<code>list.html</code>文件里<code>分页</code>相关代码，如果当前页为<code>1</code>就对<code>上一页</code>置灰，否则对<code>上一页</code>不置灰。<code>th:style=&quot;\${result.pageNum==1? &#39;color: #ccc;background: #fff;&#39; : &#39;color: #000;background: #F0F0F1;&#39;}&quot;</code></p><p>如果当前页为<code>最后一页</code>就对<code>下一页</code>置灰，否则对<code>下一页</code>不置灰。<code>th:style=&quot;\${result.pageNum==result.totalPages? &#39;color: #ccc;background: #fff;&#39; : &#39;color: #000;background: #F0F0F1;&#39;}&quot;</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--分页--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_page<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${result.pageNum==1? &#39;color: #ccc;background: #fff;&#39; : &#39;color: #000;background: #F0F0F1;&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>
                &lt; 上一页
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index:\${#numbers.sequence(1,result.totalPages)}<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${index == result.pageNum ? &#39;border: 0;color:#ee2222;background: #fff&#39; : &#39;&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>[[\${index}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--&lt;a href=&quot;#&quot; style=&quot;border: 0;font-size: 20px;color: #999;background: #fff&quot;&gt;...&lt;/a&gt;--&gt;</span>
            <span class="token comment">&lt;!--&lt;a href=&quot;#&quot;&gt;169&lt;/a&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${result.pageNum==result.totalPages? &#39;color: #ccc;background: #fff;&#39; : &#39;color: #000;background: #F0F0F1;&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>
                下一页 &gt;
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>共<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>[[\${result.totalPages}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>页<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span>到第<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>确定<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.2.1.png" alt="image-20220728203204858" tabindex="0" loading="lazy"><figcaption>image-20220728203204858</figcaption></figure><p>访问<code>http://search.gulimall.com/list.html?pageNum=1</code>页面，可以看到当前页是第一页时，已经对<code>上一页</code>置灰了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.2.2.png" alt="image-20220728203240624" tabindex="0" loading="lazy"><figcaption>image-20220728203240624</figcaption></figure><p>访问<code>http://search.gulimall.com/list.html?pageNum=2</code>页面，可以看到如果当前页既不是第一页，也不是最后一页，则<code>上一页</code>和<code>下一页</code>都不会置灰</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.2.3.png" alt="image-20220728203314064" tabindex="0" loading="lazy"><figcaption>image-20220728203314064</figcaption></figure><p>访问<code>http://search.gulimall.com/list.html?pageNum=3</code>页面，可以看到如果当前页是最后一页，则<code>下一页</code>置灰</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.2.4.png" alt="image-20220728203337157" tabindex="0" loading="lazy"><figcaption>image-20220728203337157</figcaption></figure><h5 id="_3、跳转到上一页、下一页、指定页" tabindex="-1"><a class="header-anchor" href="#_3、跳转到上一页、下一页、指定页" aria-hidden="true">#</a> 3、跳转到<code>上一页</code>、<code>下一页</code>、<code>指定页</code></h5><p>在<code>list.html</code>文件里，<code>上一页</code>对应的<code>&lt;a&gt;</code>标签里添加<code>th:href=&quot;\${&#39;javascript:searchProducts(&amp;quot;pageNum&amp;quot;,&#39;+(result.pageNum&gt;1 ? result.pageNum -1 : 1)+&#39;)&#39;}&quot;</code>属性，如果是当前页是<code>第一页</code>就跳转到<code>第一页</code>，如果不是<code>第一页</code>就跳转到<code>上一页</code>。并删除该标签的<code> href=&quot;#&quot;</code>属性</p><p>在<code>页码</code>对应的<code>&lt;a&gt;</code>标签里添加<code>th:href=&quot;\${&#39;javascript:searchProducts(&amp;quot;pageNum&amp;quot;,&#39;+index+&#39;)&#39;}&quot;</code>属性，跳转到该<code>页码</code>对应的页数。并删除该标签的<code> href=&quot;#&quot;</code>属性</p><p>在<code>下一页</code>对应的<code>&lt;a&gt;</code>标签里添加<code>th:href=&quot;\${&#39;javascript:searchProducts(&amp;quot;pageNum&amp;quot;,&#39;+(result.pageNum&lt;result.totalPages ? result.pageNum +1 : result.totalPages)+&#39;)&#39;}&quot;</code>属性，如果是当前页是<code>最后一页</code>就跳转到<code>最后一页</code>，如果不是<code>最后一页</code>就跳转到<code>下一页</code>。并删除该标签的<code> href=&quot;#&quot;</code>属性</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--分页--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_page<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${result.pageNum==1? &#39;color: #ccc;background: #fff;&#39; : &#39;color: #000;background: #F0F0F1;&#39;}<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>pageNum<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+(result.pageNum&gt;1 ? result.pageNum -1 : 1)+&#39;)&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>
                &lt; 上一页
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
               <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index:\${#numbers.sequence(1,result.totalPages)}<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${index == result.pageNum ? &#39;border: 0;color:#ee2222;background: #fff&#39; : &#39;&#39;}<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>pageNum<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+index+&#39;)&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>[[\${index}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--&lt;a href=&quot;#&quot; style=&quot;border: 0;font-size: 20px;color: #999;background: #fff&quot;&gt;...&lt;/a&gt;--&gt;</span>
            <span class="token comment">&lt;!--&lt;a href=&quot;#&quot;&gt;169&lt;/a&gt;--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
               <span class="token attr-name"><span class="token namespace">th:</span>style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${result.pageNum==result.totalPages? &#39;color: #ccc;background: #fff;&#39; : &#39;color: #000;background: #F0F0F1;&#39;}<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>pageNum<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+(result.pageNum&lt;result.totalPages ? result.pageNum +1 : result.totalPages)+&#39;)&#39;}<span class="token punctuation">&quot;</span></span>
            <span class="token punctuation">&gt;</span></span>
                下一页 &gt;
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>共<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>[[\${result.totalPages}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>页<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span>到第<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>确定<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.3.1.png" alt="image-20220729142051353" tabindex="0" loading="lazy"><figcaption>image-20220729142051353</figcaption></figure><p>经测试可以看到<code>跳转到指定页</code>、<code>跳转到上一页</code>、<code>跳转到下一页</code>功能都正常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.3.2.gif" alt="GIF 2022-7-29 14-17-12" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 14-17-12</figcaption></figure><h5 id="_4、跳转到输入页" tabindex="-1"><a class="header-anchor" href="#_4、跳转到输入页" aria-hidden="true">#</a> 4、跳转到<code>输入页</code></h5><p>在<code>list.html</code>文件里，<code>到第</code>与<code>页</code>中间的<code>&lt;input&gt;</code>标签里添加<code>id=&quot;pn&quot;</code>属性，给该标签一个<code>id</code>，方便获取其值</p><p>添加<code>th:value=&quot;\${param.pageNum}&quot;</code>属性，表示在<code>url</code>里面获取<code>pageNum</code>参数的值作为<code>value</code>属性的值。然后删除<code>value=&quot;1&quot; </code>属性</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page_span2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>共<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>[[\${result.totalPages}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>页<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span>到第<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.pageNum}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:toDirectPage()&#39;}<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>确定<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.4.1.png" alt="image-20220729143931531" tabindex="0" loading="lazy"><figcaption>image-20220729143931531</figcaption></figure><p>在<code>&lt;script&gt;</code>标签里添加如下方法，用来获取要指定跳转的页的值，然后再跳转</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">toDirectPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> pn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#pn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">,</span>pn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.4.2.png" alt="image-20220729144431616" tabindex="0" loading="lazy"><figcaption>image-20220729144431616</figcaption></figure><p>经测试可以发现已经可以成功跳转到<code>输入页</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.5.10.4.3.gif" alt="GIF 2022-7-29 14-45-58" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 14-45-58</figcaption></figure><h3 id="_5-5-6、完善检索页-2" tabindex="-1"><a class="header-anchor" href="#_5-5-6、完善检索页-2" aria-hidden="true">#</a> 5.5.6、完善检索页(2)</h3><h4 id="_1、按综合排序、销量、价格排序" tabindex="-1"><a class="header-anchor" href="#_1、按综合排序、销量、价格排序" aria-hidden="true">#</a> 1、按<code>综合排序</code>、<code>销量</code>、<code>价格</code>排序</h4><h5 id="_1、加红显示" tabindex="-1"><a class="header-anchor" href="#_1、加红显示" aria-hidden="true">#</a> 1、加红显示</h5><p>在<code>http://search.gulimall.com/list.html?pageNum=2</code>页面里，打开控制台，定位到<code>综合排序</code>，复制<code>综合排序</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.1.1.png" alt="image-20220729145326656" tabindex="0" loading="lazy"><figcaption>image-20220729145326656</figcaption></figure><p>然后在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，搜索<code>综合排序</code>，可以看到<code>综合排序</code>相关代码</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.1.2.png" alt="image-20220729145338358" tabindex="0" loading="lazy"><figcaption>image-20220729145338358</figcaption></figure><p>给<code>综合排序</code>、<code>销量</code>、<code>价格</code>、<code>评论分</code>、<code>上架时间</code>都加上<code>class=&quot;sort_a&quot;</code>属性</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--综合排序--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_top<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_top_left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>综合排序<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>销量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>评论分<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上架时间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_top_right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fp-text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span>169<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prev<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>&lt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>next<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> &gt; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.1.3.png" alt="image-20220729145540034" tabindex="0" loading="lazy"><figcaption>image-20220729145540034</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下方法，用于对点击的<code>&lt;a&gt;</code>标签添加<code>红色背景</code>样式，并清除其他类含<code>sort_a</code>的<code>&lt;a&gt;</code>标签的<code>红色背景</code>样式(如果有该<code>红色背景</code>样式的话)</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.sort_a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.sort_a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#333&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border-color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#ccc&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;background&quot;</span><span class="token operator">:</span><span class="token string">&quot;#fff&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#FFF&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border-color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;background&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 禁用默认行为（防止&lt;a&gt;标签进行页面跳转）</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.1.4.png" alt="image-20220729150155480" tabindex="0" loading="lazy"><figcaption>image-20220729150155480</figcaption></figure><p>测试后可以看到当点击<code>综合排序</code>、<code>销量</code>、<code>价格</code>、<code>评论分</code>、<code>上架时间</code>的其中一个后，会给该<code>&lt;a&gt;</code>标签添加<code>红色背景</code>样式，并清除了其他同类的<code>红色背景</code>样式(如果有该<code>红色背景</code>样式的话)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.1.5.gif" alt="GIF 2022-7-29 15-06-59" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 15-06-59</figcaption></figure><h5 id="_2、跳转页面" tabindex="-1"><a class="header-anchor" href="#_2、跳转页面" aria-hidden="true">#</a> 2、跳转页面</h5><p>给<code>综合排序</code>、<code>销量</code>、<code>价格</code>分别添加自定义<code>sort=&quot;hotScore&quot;</code>、<code>sort=&quot;saleCount&quot;</code>、<code>sort=&quot;skuPrice&quot;</code>属性，方便获取该标签传参所用的参数名</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_top_left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hotScore<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>综合排序<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>saleCount<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>销量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuPrice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>评论分<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>上架时间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.2.1.png" alt="image-20220729190028764" tabindex="0" loading="lazy"><figcaption>image-20220729190028764</figcaption></figure><p>在<code>list.html</code>文件里，修改<code>.sort_a</code>绑定的点击事件，使其<code>url</code>添加<code>sort</code>字段</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.sort_a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url为升序，再点击就降序</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">,</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;_desc&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">,</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;_asc&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 禁用默认行为（防止&lt;a&gt;标签进行页面跳转）</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.2.2.png" alt="image-20220729190117170" tabindex="0" loading="lazy"><figcaption>image-20220729190117170</figcaption></figure><p>添加页面加载时，自动触发的<code>js</code>代码，用于回显添加<code>红色背景</code>样式的<code>&lt;a&gt;</code>标签</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> sortValue <span class="token operator">=</span> <span class="token function">getURLParamValue</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sortValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">changeStyle</span><span class="token punctuation">(</span>sortValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">changeStyle</span><span class="token punctuation">(</span><span class="token parameter">sortValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> split <span class="token operator">=</span> sortValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;a[sort]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//设置被点击的标签的样式为选中状态</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#FFF&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border-color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;background&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;asc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                text <span class="token operator">=</span> text <span class="token operator">+</span><span class="token string">&quot;⬆&quot;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                text <span class="token operator">=</span> text <span class="token operator">+</span> <span class="token string">&quot;⬇&quot;</span>
            <span class="token punctuation">}</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//清除该类的选中样式</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#333&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border-color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#ccc&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;background&quot;</span><span class="token operator">:</span><span class="token string">&quot;#fff&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getURLParamValue</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> startIndex <span class="token operator">=</span> index <span class="token operator">+</span> param<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">let</span> endIndex <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span>startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果parm是最后一个参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            endIndex <span class="token operator">=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.2.3.png" alt="image-20220729190227067" tabindex="0" loading="lazy"><figcaption>image-20220729190227067</figcaption></figure><p>测试后可以发现，可以正确的添加请求参数，并且回显了添加<code>红色背景</code>样式的<code>&lt;a&gt;</code>标签。但是在鼠标第一次悬浮到<code>价格</code>的时候，鼠标的样式为<code>I</code>，而不是<code>小手</code>的样式，而且没有<code>红色边框</code>，而且页面有很明显的抖动，对用户体验很不好，其实这些应该都是前端来做，而且这样请求很浪费服务器资源</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.2.4.gif" alt="GIF 2022-7-29 18-55-22" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 18-55-22</figcaption></figure><h5 id="_3、添加鼠标经过样式" tabindex="-1"><a class="header-anchor" href="#_3、添加鼠标经过样式" aria-hidden="true">#</a> 3、添加<code>鼠标经过</code>样式</h5><p>在<code>changeStyle</code>的<code>js</code>方法的<code>$(&quot;a[sort]&quot;).each(function () {</code>下面添加如下代码，用于添加<code>鼠标经过</code>的<code>红色边框</code>样式和<code>鼠标离开</code>默认的<code>灰色边框</code>样式</p><p><code>$(this).hover</code>方法有两个参数，第一个参数为<code>鼠标经过</code>样式,第二个参数为<code>鼠标离开</code>样式，必须写<code>鼠标离开</code>样式，否则鼠标离开了还是保持着<code>鼠标经过</code>的样式，和<code>css</code>样式不一样，<code>css</code>里写<code>鼠标经过</code>样式，<code>鼠标离开</code>后就变化的原来的样式</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getURLParamValue</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hover</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;cursor&quot;</span><span class="token operator">:</span><span class="token string">&quot;pointer&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border&quot;</span><span class="token operator">:</span><span class="token string">&quot;1px solid #e4393c&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;z-index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;cursor&quot;</span><span class="token operator">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border&quot;</span><span class="token operator">:</span><span class="token string">&quot;1px solid #ccc&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#333&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;z-index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.1.png" alt="image-20220729195054068" tabindex="0" loading="lazy"><figcaption>image-20220729195054068</figcaption></figure><p>在<code>&lt;head&gt;</code>标签里添加如下样式，给<code>sort_a</code>类的<code>&lt;a&gt;</code>标签的<code>鼠标经过</code>都应用<code>pointer</code>的鼠标样式</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-css line-numbers-mode" data-ext="css"><pre class="language-css"><code><span class="token selector">&lt;style  type=&quot;text/css&quot;&gt;
    a.sort_a:hover</span><span class="token punctuation">{</span>
        <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.2.png" alt="image-20220729195331121" tabindex="0" loading="lazy"><figcaption>image-20220729195331121</figcaption></figure><p>鼠标经过<code>综合排序</code>、<code>销量</code>、<code>价格</code>中任何一个时，都能变为<code>小手</code>的样式，并且也加上了<code>红色边框</code>的样式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.3.gif" alt="GIF 2022-7-29 19-53-57" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 19-53-57</figcaption></figure><p>⚠️不可以直接设置如下样式（可能是之前使用<code>JQuery</code>在<code>changeStyle</code>方法里对每个<code>sort_a</code>类的<code>&lt;a&gt;</code>标签都应用了<code>$(this).css({&quot;color&quot;:&quot;#FFF&quot;,&quot;border-color&quot;:&quot;#e4393c&quot;,&quot;background&quot;:&quot;#e4393c&quot;})</code>或</p><p><code>$(this).css({&quot;color&quot;:&quot;#333&quot;,&quot;border-color&quot;:&quot;#ccc&quot;,&quot;background&quot;:&quot;#fff&quot;})</code>的<code>颜色</code>、<code>边框</code>、<code>背景</code>的样式吧，所以设置<code>鼠标经过</code>的<code>颜色</code>、<code>边框</code>的样式不成功，但设置<code>鼠标样式</code>却可以成功）</p><p>点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-css line-numbers-mode" data-ext="css"><pre class="language-css"><code><span class="token selector">&lt;style  type=&quot;text/css&quot;&gt;
    a.sort_a:hover</span><span class="token punctuation">{</span>
        <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #e4393c<span class="token punctuation">;</span>
        <span class="token property">color</span><span class="token punctuation">:</span> #e4393c<span class="token punctuation">;</span>
        <span class="token property">z-index</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.4.png" alt="image-20220729194021594" tabindex="0" loading="lazy"><figcaption>image-20220729194021594</figcaption></figure><p>如果这样设置就不会有鼠标经过的<code>红色边框</code>样式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.5.gif" alt="GIF 2022-7-29 19-44-30" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 19-44-30</figcaption></figure><p>📑在<code>list.html</code>文件里使用<code>JQuery</code>在<code>changeStyle</code>方法里对每个<code>sort_a</code>类的<code>&lt;a&gt;</code>标签都应用了<code>$(this).css({&quot;color&quot;:&quot;#FFF&quot;,&quot;border-color&quot;:&quot;#e4393c&quot;,&quot;background&quot;:&quot;#e4393c&quot;})</code>或</p><p><code>$(this).css({&quot;color&quot;:&quot;#333&quot;,&quot;border-color&quot;:&quot;#ccc&quot;,&quot;background&quot;:&quot;#fff&quot;})</code>的<code>颜色</code>、<code>边框</code>、<code>背景</code>的样式</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">changeStyle</span><span class="token punctuation">(</span><span class="token parameter">sortValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> split <span class="token operator">=</span> sortValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;a[sort]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//设置被点击的标签的样式为选中状态</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#FFF&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border-color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;background&quot;</span><span class="token operator">:</span><span class="token string">&quot;#e4393c&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;asc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                text <span class="token operator">=</span> text <span class="token operator">+</span><span class="token string">&quot;⬆&quot;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                text <span class="token operator">=</span> text <span class="token operator">+</span> <span class="token string">&quot;⬇&quot;</span>
            <span class="token punctuation">}</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//清除该类的选中样式</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#333&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;border-color&quot;</span><span class="token operator">:</span><span class="token string">&quot;#ccc&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;background&quot;</span><span class="token operator">:</span><span class="token string">&quot;#fff&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.6.png" alt="image-20220729194547892" tabindex="0" loading="lazy"><figcaption>image-20220729194547892</figcaption></figure><p>如果在<code>window.onload</code>里注释掉对<code>changeStyle(sortValue)</code>的方法调用，再在<code>&lt;head&gt;</code>标签里添加<code>鼠标形状</code>、<code>颜色</code>、<code>边框</code>样式</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span>  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">a.sort_a:hover</span><span class="token punctuation">{</span>
        <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #e4393c<span class="token punctuation">;</span>
        <span class="token property">color</span><span class="token punctuation">:</span> #e4393c<span class="token punctuation">;</span>
        <span class="token property">z-index</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.7.png" alt="image-20220729194732377" tabindex="0" loading="lazy"><figcaption>image-20220729194732377</figcaption></figure><p>这样就能成功使用原生的<code>css</code>里成功应用<code>鼠标经过</code>时的<code>鼠标形状</code>、<code>颜色</code>、<code>边框</code>等样式（由于还要调用<code>changeStyle(sortValue)</code>方法，所有并不能使用这种方式，测试完后别忘了改回来哟）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.1.3.8.gif" alt="GIF 2022-7-29 19-47-04" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 19-47-04</figcaption></figure><h4 id="_2、按价格区间排序" tabindex="-1"><a class="header-anchor" href="#_2、按价格区间排序" aria-hidden="true">#</a> 2、按<code>价格区间</code>排序</h4><h5 id="_1、添加价格区间" tabindex="-1"><a class="header-anchor" href="#_1、添加价格区间" aria-hidden="true">#</a> 1、添加<code>价格区间</code></h5><p>修改<code>filter_top_left</code>类的<code>div</code>的标签内容，注释掉<code>评论分</code>和<code>上架时间</code>，并添加<code>价格区间</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_top_left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hotScore<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>综合排序<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>saleCount<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>销量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuPrice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--&lt;a class=&quot;sort_a&quot; href=&quot;#&quot;&gt;评论分&lt;/a&gt;--&gt;</span>
    <span class="token comment">&lt;!--&lt;a class=&quot;sort_a&quot; href=&quot;#&quot;&gt;上架时间&lt;/a&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">margin-left</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span> 11px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>价格区间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span> -
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>确定<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.1.1.png" alt="image-20220729200604500" tabindex="0" loading="lazy"><figcaption>image-20220729200604500</figcaption></figure><p>可以看到<code>评论分</code>和<code>上架时间</code>已经没有了，也添加了<code>价格区间</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.1.2.png" alt="image-20220729200625658" tabindex="0" loading="lazy"><figcaption>image-20220729200625658</figcaption></figure><h5 id="_2、修改错误替换参数名的bug" tabindex="-1"><a class="header-anchor" href="#_2、修改错误替换参数名的bug" aria-hidden="true">#</a> 2、修改错误替换参数名的<code>bug</code></h5><p>给<code>价格区间</code>的<code>确定</code>按钮添加名为<code>skuPriceBtn</code>的<code>id</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>filter_top_left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hotScore<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>综合排序<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>saleCount<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>销量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sort_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuPrice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--&lt;a class=&quot;sort_a&quot; href=&quot;#&quot;&gt;评论分&lt;/a&gt;--&gt;</span>
    <span class="token comment">&lt;!--&lt;a class=&quot;sort_a&quot; href=&quot;#&quot;&gt;上架时间&lt;/a&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">margin-left</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span> 11px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>价格区间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span> -
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuPriceBtn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>确定<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并在<code>&lt;script&gt;</code>标签里给<code>id</code>为<code>skuPriceBtn</code>的标签添加点击事件，获取到<code>最小值</code>和<code>最大值</code>后带着<code>skuPrice</code>参数进行跳转</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#skuPriceBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> from <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#skuPriceFrom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> to <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#skuPriceTo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token string">&quot;skuPrice&quot;</span><span class="token punctuation">,</span>from<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span>to<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.1.png" alt="image-20220729202313226" tabindex="0" loading="lazy"><figcaption>image-20220729202313226</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?sort=skuPrice_asc</code>页面里，在最大值的输入框里输入<code>6000</code>后，点击<code>确定</code>按钮</p><p>来到了<code>http://search.gulimall.com/list.html?sort=skuPrice=_6000</code>的错误页面，这是因为查找到了<code>sort</code>参数里的<code>skuPrice_asc</code>，误以为这里的<code>skuPrice</code>是参数名，就将该参数名进行了替换</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.2.gif" alt="GIF 2022-7-29 20-21-52" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 20-21-52</figcaption></figure><p>修改<code>list.html</code>文件里的<code>searchProducts(name,value)</code>方法，如果该<code>name</code>在<code>location.href</code>里不止出现一次，就调用<code> findParamIndex(href,name,0)</code>方法，判断哪个才是正真的<code>参数名</code>，而不是<code>参数值</code>里含有该<code>name</code>。该<code>name</code>只出现一次或者调用<code> findParamIndex(href,name,0)</code>方法获取到参数名的正真索引后，需要判断该索引是否存在，并且该索引是否是<code>参数名</code>的索引(如果该<code>name</code>只出现一次，有可能是<code>参数值</code>里含有该<code>name</code>)</p><p>(其实可以不判断该索引前一个元素是不是<code>&amp;</code>或<code>?</code>，而判断该索引后一个元素是不是<code>=</code>，这样<code>findParamIndex(href,name,0)</code>根本就不用写，直接写<code>if (startIndex &gt;= 0 &amp;&amp; href.charAt(startIndex + 1) == &#39;=&#39;</code>就行了。我这里想试一下<code>js</code>的递归，<code>js</code>的递归我还每写过😊)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>function <span class="token function">searchProducts</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
    let href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>href<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    let startIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url中有name参数</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>href<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> startIndex <span class="token operator">!=</span> href<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        startIndex <span class="token operator">=</span> <span class="token function">findParamIndex</span><span class="token punctuation">(</span>href<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">&#39;&amp;&#39;</span> <span class="token operator">||</span> href<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">&#39;?&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> endIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果name参数不是最后一个参数，替换掉name参数后，则还要加上后面的参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>endIndex<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//url中没有name参数，则新的url中name有可能是第一个参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href <span class="token operator">+</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

function <span class="token function">findParamIndex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>param<span class="token punctuation">,</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        let startIndex <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">&#39;&amp;&#39;</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">&#39;?&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">)</span>
            <span class="token keyword">return</span> startIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index<span class="token operator">+</span>param<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">findParamIndex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>param<span class="token punctuation">,</span>startIndex<span class="token operator">+</span>param<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.3.png" alt="image-20220801101135056" tabindex="0" loading="lazy"><figcaption>image-20220801101135056</figcaption></figure><p>并在<code>&lt;script&gt;</code>标签里修改<code>id</code>为<code>skuPriceBtn</code>的标签点的击事件，<code>最小值</code>和<code>最大值</code>不能同时为空时，才带着<code>skuPrice</code>参数进行跳转</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#skuPriceBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> from <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#skuPriceFrom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> to <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#skuPriceTo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>from<span class="token operator">!=</span><span class="token string">&quot;&quot;</span> <span class="token operator">||</span> to<span class="token operator">!=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token string">&quot;skuPrice&quot;</span><span class="token punctuation">,</span>from<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span>to<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;价格区间不能为空！&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.4.png" alt="image-20220801105238406" tabindex="0" loading="lazy"><figcaption>image-20220801105238406</figcaption></figure><p>在<code>http://search.gulimall.com/list.html</code>页面里当<code>最小值</code>和<code>最大值</code>同时为空时，点击<code>确定</code>按钮，会弹出<code>价格区间不能为空！</code>的提示，当<code>最小值</code>和<code>最大值</code>其中任何一个不为空时，点击<code>确定</code>按钮，才可以进行跳转</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.5.gif" alt="GIF 2022-7-29 21-19-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 21-19-40</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?sort=skuPrice_asc</code>页面里测试也符合正确的逻辑，不会变为错误的<code>url</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.6.gif" alt="GIF 2022-7-29 21-22-24" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 21-22-24</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?sort=skuPrice_asc&amp;skuPrice=1_6666&amp;pageNum=2</code>页面里测试，<code>skuPrice=1_6666</code>在所有参数中间也符合正确的逻辑，不会变为错误的<code>url</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.2.7.gif" alt="GIF 2022-7-29 21-25-48" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 21-25-48</figcaption></figure><h5 id="_3、页码错误" tabindex="-1"><a class="header-anchor" href="#_3、页码错误" aria-hidden="true">#</a> 3、页码错误</h5><p>没有商品数据时，页面遍历的页数开始为<code>1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.3.1.png" alt="image-20220729212306463" tabindex="0" loading="lazy"><figcaption>image-20220729212306463</figcaption></figure><p>把遍历页码用到的<code>th:each=&quot;index:\${#numbers.sequence(1,result.totalPages)}&quot;</code>修改为如下代码，如果<code>result.totalPages</code>为<code>0</code>就只遍历<code>0</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>th:each=&quot;index: \${result.totalPages&gt;0 ? #numbers.sequence(1,result.totalPages) : #numbers.sequence(0,0)}&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.3.2.png" alt="image-20220729213045932" tabindex="0" loading="lazy"><figcaption>image-20220729213045932</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?skuPrice=_33</code>页码里测试，可以发现只会显示第<code>0</code>页了，即使手动在<code>url</code>后面添加<code>&amp;pageNum=2</code>参数也同样只能显示第<code>0</code>页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.2.3.3.gif" alt="GIF 2022-7-29 21-32-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-29 21-32-13</figcaption></figure><h4 id="_3、仅显示有货" tabindex="-1"><a class="header-anchor" href="#_3、仅显示有货" aria-hidden="true">#</a> 3、仅显示有货</h4><h5 id="_1、默认有货无货都显示" tabindex="-1"><a class="header-anchor" href="#_1、默认有货无货都显示" aria-hidden="true">#</a> 1、默认有货无货都显示</h5><p>修改<code>gulimall-search</code>模块<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>boolSearch</code>方法的相关设置是否有库存的逻辑，修改为默认有货无货都显示，只有指定了<code>仅显示有货</code>才仅显示有货的商品</p><p>然后重启<code>GulimallSearchApplication</code>服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//是否有库存</span>
<span class="token comment">//&quot;filter&quot;: [{&quot;term&quot;: {&quot;hasStock&quot;: {&quot;value&quot;: &quot;true&quot;}}}]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hasStock <span class="token operator">=</span>  searchParam<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
    boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;hasStock&quot;</span><span class="token punctuation">,</span> hasStock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.1.1.png" alt="image-20220730090539985" tabindex="0" loading="lazy"><figcaption>image-20220730090539985</figcaption></figure><p>刷新浏览器的如下网址的页面，然后查看<code>GulimallSearchApplication</code>服务的控制台</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?pageNum=2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到没有<code>hasStock</code>的信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalog_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_id_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_value_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.1.2.png" alt="image-20220730090715703" tabindex="0" loading="lazy"><figcaption>image-20220730090715703</figcaption></figure><p>在浏览器里输入如下网址，然后查看<code>GulimallSearchApplication</code>服务的控制台</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?pageNum=2&amp;hasStock=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到只有显式的指明了<code>hasStock=1</code>，才在查询字段里添加<code>hasStock=true</code>的查询条件</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;from&quot;</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;bool&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;filter&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">&quot;adjust_pure_negative&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;boost&quot;</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;brand_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;brand_img_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;catalog_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;catalog_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;nested&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_id_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;attr_name_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrName&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;attr_value_agg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;terms&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;field&quot;</span><span class="token operator">:</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;order&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;_count&quot;</span><span class="token operator">:</span><span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;_key&quot;</span><span class="token operator">:</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.1.3.png" alt="image-20220730090847529" tabindex="0" loading="lazy"><figcaption>image-20220730090847529</figcaption></figure><h5 id="_2、添加hasstock请求参数" tabindex="-1"><a class="header-anchor" href="#_2、添加hasstock请求参数" aria-hidden="true">#</a> 2、添加<code>hasStock</code>请求参数</h5><p>在<code>http://search.gulimall.com/list.html?pageNum=2</code>页面里，打开控制台，定位到<code>仅显示有货</code>，复制<code>仅显示有货</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.2.1.png" alt="image-20220730090258883" tabindex="0" loading="lazy"><figcaption>image-20220730090258883</figcaption></figure><p>然后在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，搜索<code>仅显示有货</code>，可以看到<code>仅显示有货</code>相关代码，将相关代码修改为如下样式，在<code>仅显示有货</code>上面删除<code>&lt;i&gt;</code>标签，添加加一个<code>&lt;input&gt;</code>标签，在其<code>&lt;a&gt;</code>父标签里添加<code>th:with=&quot;hasSelect = \${param.hasStock}&quot;</code>属性，用于暂存<code>url</code>里的<code>hasStock</code>参数，并给<code>&lt;input&gt;</code>添加名为<code>showHasStock</code>的<code>id</code>方便获取到该标签，并在<code>&lt;input&gt;</code>标签里添加<code>th:checked=&quot;\${#strings.equals(hasSelect,&#39;1&#39;)}&quot;</code>用于回显是否选择了这个复选框</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>with</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hasSelect = \${param.hasStock}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>showHasStock<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>checked</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#strings.equals(hasSelect,&#39;1&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        仅显示有货
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.2.2.png" alt="image-20220730101430137" tabindex="0" loading="lazy"><figcaption>image-20220730101430137</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下几个方法，在该复选框状态改变后，跳转到新的<code>url</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#showHasStock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">&quot;checked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token function">replaceOrAddParamVal</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span><span class="token string">&quot;hasStock&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token function">removeParamVal</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span><span class="token string">&quot;hasStock&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">function</span> <span class="token function">replaceOrAddParamVal</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> paramName<span class="token punctuation">,</span> replaceVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url没有该参数名就添加，有就替换;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> nUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=&#39;</span> <span class="token operator">+</span> replaceVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nUrl <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nUrl <span class="token operator">=</span> oUrl <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=&#39;</span> <span class="token operator">+</span> replaceVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            nUrl <span class="token operator">=</span> oUrl <span class="token operator">+</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=&#39;</span> <span class="token operator">+</span> replaceVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> nUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">removeParamVal</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> paramName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url有该参数名就删除参数</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//pre为 ? 或 &amp;</span>
        <span class="token keyword">let</span> pre <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span> pre <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> nUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.2.3.png" alt="image-20220730095547605" tabindex="0" loading="lazy"><figcaption>image-20220730095547605</figcaption></figure><p>在以下页面里，点击<code>仅显示有货</code>的左边复选框</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?pageNum=2#
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>来到了如下页面，由于页面很多地方设置了<code>href=&quot;#&quot;</code>，所有很有可能在<code>url</code>末尾添加上<code>#</code>，因此在添加新的参数之前需要删除最后面的<code>#</code>，然后再进行<code>替换</code>或<code>添加</code>属性(其实不添加该删除代码，替换并不会搜到影响)</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?pageNum=2#&amp;hasStock=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.2.4.gif" alt="GIF 2022-7-30 9-57-25" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 9-57-25</figcaption></figure><h5 id="_3、修复bug-1" tabindex="-1"><a class="header-anchor" href="#_3、修复bug-1" aria-hidden="true">#</a> 3、修复<code>bug</code>(1)</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里，在<code>function replaceOrAddParamVal(url, paramName, replaceVal) {</code>方法的<code>var oUrl = url.toString();</code>下面添加一个判断，如果<code>url</code>最后为<code>#</code>，就去掉这个<code>#</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    oUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>oUrl<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.3.1.png" alt="image-20220730101335302" tabindex="0" loading="lazy"><figcaption>image-20220730101335302</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?pageNum=2#</code>页面里点击<code>仅显示有货</code>的左边复选框，然后就来到了<code>http://search.gulimall.com/list.html?pageNum=2&amp;hasStock=1</code>页面，成功把最后的<code>#</code>截掉了</p><p>在<code>http://search.gulimall.com/list.html?pageNum=2&amp;hasStock=1#</code>，取消<code>仅显示有货</code>的左边复选框的选中状态，然后就来到了<code>http://search.gulimall.com/list.html?pageNum=2</code>页面，成功把最后的<code>#</code>截掉了，不过这是碰巧截掉的（并不是我刚刚添加的代码戒掉的），删除该参数时会匹配到后面所有不为<code>&amp;</code>的参数，所以也把<code>#</code>一起截掉了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.3.2.gif" alt="GIF 2022-7-30 10-15-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-15-46</figcaption></figure><p>但是如果在<code>http://search.gulimall.com/list.html?hasStock=1</code>，取消<code>仅显示有货</code>的左边复选框的选中状态，控制台就报错了，这是因为在<code>js正则</code>里，<code>?</code>为特殊符号，需要转义</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Uncaught SyntaxError<span class="token operator">:</span> Invalid regular expression<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?hasStock=)([^&amp;]*)</span><span class="token regex-delimiter">/</span></span><span class="token operator">:</span> Invalid group
    at <span class="token function">removeParamVal</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>html<span class="token operator">?</span>hasStock<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2360</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span>
    at HTMLInputElement<span class="token punctuation">.</span><span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>html<span class="token operator">?</span>hasStock<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2325</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">)</span>
    at HTMLInputElement<span class="token punctuation">.</span><span class="token function">dispatch</span> <span class="token punctuation">(</span>jquery<span class="token operator">-</span><span class="token number">1.12</span><span class="token number">.4</span><span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">5226</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">)</span>
    at elemData<span class="token punctuation">.</span><span class="token function">handle</span> <span class="token punctuation">(</span>jquery<span class="token operator">-</span><span class="token number">1.12</span><span class="token number">.4</span><span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">4878</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.3.3.gif" alt="GIF 2022-7-30 10-19-42" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-19-42</figcaption></figure><h5 id="_4、修复bug-2" tabindex="-1"><a class="header-anchor" href="#_4、修复bug-2" aria-hidden="true">#</a> 4、修复<code>bug</code>(2)</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里，修改<code>removeParamVal(url, paramName)</code>方法</p><p>对该参数名的前一个字符转义并删除，防止其是<code>?</code>，不过这里有问题，如果该<code>paramName</code>是第一个参数，但不是最后一个参数，就会把前面的<code>?</code>一起删了，后面就用<code>&amp;</code>来拼接参数了</p><p>想要的<code>js正则</code>为<code>/(\\?hasStock=)([^&amp;]*)/gi</code>，使用两个<code>\\\\</code>为对<code>\\</code>的转义，如果只使用一个<code>\\</code>，<code>js</code>就会误以为是对后面<code>&#39;</code>的转义，其实这里就是想要<code>\\</code>，方便对拼接的<code>?</code>或<code>&amp;</code>转义(<code>&amp;</code>不需要转义)</p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">removeParamVal</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> paramName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url有该参数名就删除参数</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//pre为 ? 或 &amp;</span>
        <span class="token keyword">let</span> pre <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span><span class="token string">&#39;\\\\&#39;</span> <span class="token operator">+</span> pre <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> nUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.4.1.png" alt="image-20220730102159120" tabindex="0" loading="lazy"><figcaption>image-20220730102159120</figcaption></figure><p>在<code>http://search.gulimall.com/list.html#</code>页面里点击<code>仅显示有货</code>的左边复选框，然后就来到了<code>http://search.gulimall.com/list.html?hasStock=1</code>页面，成功把最后的<code>#</code>截掉了</p><p>在<code>http://search.gulimall.com/list.html?hasStock=1#</code>页面里，取消<code>仅显示有货</code>的左边复选框的选中状态，就来到了<code>http://search.gulimall.com/list.html</code>页面，也成功把最后的<code>#</code>截掉了</p><p>此时的正则为<code>/(\\?hasStock=)([^&amp;]*)/gi</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.4.2.gif" alt="GIF 2022-7-30 10-23-10" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-23-10</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?pageNum=2#</code>页面里点击<code>仅显示有货</code>的左边复选框，然后就来到了<code>http://search.gulimall.com/list.html?pageNum=2&amp;hasStock=1</code>页面，成功把最后的<code>#</code>截掉了</p><p>在<code>http://search.gulimall.com/list.html?pageNum=2&amp;hasStock=1#</code>，取消<code>仅显示有货</code>的左边复选框的选中状态，然后就来到了<code>http://search.gulimall.com/list.html?pageNum=2</code>页面，成功把最后的<code>#</code>截掉了，不过这是碰巧截掉的（并不是我刚刚添加的代码戒掉的），删除该参数时会匹配到后面所有不为<code>&amp;</code>的参数，所以也把<code>#</code>一起截掉了</p><p>此时的正则为<code>/(\\&amp;hasStock=)([^&amp;]*)/gi</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.4.3.gif" alt="GIF 2022-7-30 10-24-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-24-02</figcaption></figure><p>但是如果该<code>paramName</code>是第一个参数，但不是最后一个参数，就会把前面的<code>?</code>一起删了，后面就用<code>&amp;</code>来拼接参数了，比如在<code>http://search.gulimall.com/list.html?hasStock=1&amp;sort=saleCount_asc</code>页面里，取消<code>仅显示有货</code>的左边复选框的选中状态，就错误地拼接为<code>http://search.gulimall.com/list.html&amp;sort=saleCount_asc</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.4.4.gif" alt="GIF 2022-7-30 10-34-41" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-34-41</figcaption></figure><h5 id="_5、修复bug-3" tabindex="-1"><a class="header-anchor" href="#_5、修复bug-3" aria-hidden="true">#</a> 5、修复<code>bug</code>(3)</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里，修改<code>removeParamVal(url, paramName)</code>方法，判断该参数名的前一个字符是是什么，如果是<code>?</code>并且该参数后面没有别的参数后，在删除时还需要对<code>?</code>进行转义</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">removeParamVal</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> paramName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oUrl <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url有该参数名就删除参数</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>paramName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//tag为 ? 或 &amp;</span>
        <span class="token keyword">let</span> tag <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> re<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag<span class="token operator">==</span><span class="token string">&#39;&amp;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span> tag <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// http://search.gulimall.com/list.html?hasStock=1&amp;sort=saleCount_asc</span>
            <span class="token comment">// http://search.gulimall.com/list.html?sort=saleCount_asc</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oUrl<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span>tag<span class="token operator">+</span>paramName<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*&amp;)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&#39;/(&#39;</span> <span class="token operator">+</span><span class="token string">&quot;\\?&quot;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> <span class="token string">&#39;=)([^&amp;]*)/gi&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span>
        <span class="token keyword">var</span> nUrl <span class="token operator">=</span> oUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.5.1.png" alt="image-20220730104953971" tabindex="0" loading="lazy"><figcaption>image-20220730104953971</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;hasStock=1&amp;sort=saleCount_asc</code>页面里，取消<code>仅显示有货</code>的左边复选框的选中状态，就正确拼接为<code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc</code>了，</p><p>再次点击<code>仅显示有货</code>的左边复选框，也能正确拼接为<code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc&amp;hasStock=1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.5.2.gif" alt="GIF 2022-7-30 10-47-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-47-02</figcaption></figure><p>但是如果在<code>http://search.gulimall.com/list.html?hasStock=1</code>页面里，取消<code>仅显示有货</code>的左边复选框的选中状态，控制台又报错了</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">VM5495</span><span class="token operator">:</span><span class="token number">1</span> Uncaught SyntaxError<span class="token operator">:</span> Invalid regular expression<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?hasStock=)([^&amp;]*)</span><span class="token regex-delimiter">/</span></span><span class="token operator">:</span> Invalid group
    at <span class="token function">removeParamVal</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>html<span class="token operator">?</span>hasStock<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2369</span><span class="token operator">:</span><span class="token number">54</span><span class="token punctuation">)</span>
    at HTMLInputElement<span class="token punctuation">.</span><span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>html<span class="token operator">?</span>hasStock<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2325</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">)</span>
    at HTMLInputElement<span class="token punctuation">.</span><span class="token function">dispatch</span> <span class="token punctuation">(</span>jquery<span class="token operator">-</span><span class="token number">1.12</span><span class="token number">.4</span><span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">5226</span><span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">)</span>
    at elemData<span class="token punctuation">.</span><span class="token function">handle</span> <span class="token punctuation">(</span>jquery<span class="token operator">-</span><span class="token number">1.12</span><span class="token number">.4</span><span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">4878</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.5.3.gif" alt="GIF 2022-7-30 10-53-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-53-17</figcaption></figure><h5 id="_6、修复bug-4" tabindex="-1"><a class="header-anchor" href="#_6、修复bug-4" aria-hidden="true">#</a> 6、修复<code>bug</code>(4)</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里，修改<code>removeParamVal(url, paramName)</code>方法，把<code> re = eval(&#39;/(&#39; +&quot;\\?&quot; + paramName + &#39;=)([^&amp;]*)/gi&#39;);</code>，修改为</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>re <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token char">&#39;/(&#39;</span> <span class="token operator">+</span><span class="token string">&quot;\\\\?&quot;</span> <span class="token operator">+</span> paramName <span class="token operator">+</span> &#39;<span class="token operator">=</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span>gi&#39;<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时的正则为<code>/(\\\\?hasStock=)([^&amp;]*)/gi</code>，比上次的正则多了一个<code>\\</code>，上次的正则为\`\`/(?hasStock=)([^&amp;]*)/gi\`</p><p>我也不知道为什么要将<code>\\</code>再次转义，而上次不用</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.6.1.png" alt="image-20220730105422250" tabindex="0" loading="lazy"><figcaption>image-20220730105422250</figcaption></figure><p>在<code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;hasStock=1&amp;sort=saleCount_asc#</code>页面里，取消<code>仅显示有货</code>的左边复选框的选中状态，成功来到了<code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc#</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.6.2.gif" alt="GIF 2022-7-30 10-56-20" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 10-56-20</figcaption></figure><h5 id="修改searchproducts方法" tabindex="-1"><a class="header-anchor" href="#修改searchproducts方法" aria-hidden="true">#</a> 📝修改<code>searchProducts</code>方法</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里的<code>&lt;script&gt;</code>标签里，修改<code>searchProducts(name,value)</code>方法，在<code>et href = location.href.toString();</code>后面也加一条判断，如果最后的字符为<code>#</code>，也去掉该字符</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">searchProducts</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> href <span class="token operator">=</span> location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>href<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> startIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果url中有name参数</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>href<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> startIndex <span class="token operator">!=</span> href<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        startIndex <span class="token operator">=</span> <span class="token function">findParamIndex</span><span class="token punctuation">(</span>href<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;&amp;&#39;</span> <span class="token operator">||</span> href<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>startIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> endIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果name参数不是最后一个参数，替换掉name参数后，则还要加上后面的参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>endIndex<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> startIndex<span class="token punctuation">)</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//url中没有name参数，则新的url中name有可能是第一个参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href <span class="token operator">+</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            location<span class="token punctuation">.</span>href <span class="token operator">=</span> location<span class="token punctuation">.</span>href <span class="token operator">+</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.3.7.png" alt="image-20220730094502450" tabindex="0" loading="lazy"><figcaption>image-20220730094502450</figcaption></figure><h4 id="_4、属性添加面包屑导航" tabindex="-1"><a class="header-anchor" href="#_4、属性添加面包屑导航" aria-hidden="true">#</a> 4、属性添加面包屑导航</h4><h5 id="_1、添加远程调用" tabindex="-1"><a class="header-anchor" href="#_1、添加远程调用" aria-hidden="true">#</a> 1、添加远程调用</h5><p>复制<code>gulimall-product</code>模块<code>pom.xml</code>文件的<code>&lt;spring-cloud.version&gt;</code>，然后粘贴到<code>gulimall-search</code>模块<code>pom.xml</code>文件的相应位置</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.1.1.png" alt="image-20220730155823834" tabindex="0" loading="lazy"><figcaption>image-20220730155823834</figcaption></figure><p>在<code>gulimall-search</code>模块<code>pom.xml</code>文件里的<code>&lt;dependencyManagement&gt;</code>里指定<code>spring-cloud</code>的依赖的版本，该配置不会添加依赖，只会用于控制版本</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.1.2.png" alt="image-20220730155939119" tabindex="0" loading="lazy"><figcaption>image-20220730155939119</figcaption></figure><p>在<code>gulimall-search</code>模块<code>pom.xml</code>文件里的<code>&lt;dependencies&gt;</code>里添加如下依赖，用于远程调用</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.1.3.png" alt="image-20220730160200795" tabindex="0" loading="lazy"><figcaption>image-20220730160200795</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplication</code>启动类上添加如下注解，用来开启远程调用功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.1.4.png" alt="image-20220730160253460" tabindex="0" loading="lazy"><figcaption>image-20220730160253460</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.AttrController</code>类里，修改<code>info</code>方法的<code>@RequestMapping(&quot;/info/{attrId}&quot;)</code>注解，将其改为<code>@GetMapping(&quot;/info/{attrId}&quot;)</code>，只接受<code>get</code>方法的调用</p><p>然后复制该方法的头部信息（<code>@GetMapping(&quot;/info/{attrId}&quot;) public R info(@PathVariable(&quot;attrId&quot;) Long attrId)</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.1.5.png" alt="image-20220730160417143" tabindex="0" loading="lazy"><figcaption>image-20220730160417143</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search</code>包下新建<code>feign</code>文件夹，在<code>feign</code>文件夹里添加<code>ProductFeignService</code>类，粘贴刚刚复制的头部信息，修改方法名，并将映射地址添加完整</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/30
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/attr/info/{attrId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">attrInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;attrId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.1.6.png" alt="image-20220730160711351" tabindex="0" loading="lazy"><figcaption>image-20220730160711351</figcaption></figure><h5 id="_2、进行远程调用" tabindex="-1"><a class="header-anchor" href="#_2、进行远程调用" aria-hidden="true">#</a> 2、进行远程调用</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>包下新建<code>AttrRespTo</code>类，用于<code>gulimall-search</code>模块获取从<code>gulimall-product</code>传来的数据</p><p>由于<code>AttrRespVo</code>继承了<code>AttrVo</code>，关系比较复杂，因此不适合直接移动位置，因此可以写个完整的<code>AttrRespTo</code>用于数据传输</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/30
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttrRespTo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 属性id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 属性名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> attrName<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 是否需要检索[0-不需要，1-需要]
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> searchType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 属性图标
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> icon<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 可选值列表[用逗号分隔]
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> valueSelect<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 属性类型[0-销售属性，1-基本属性，2-既是销售属性又是基本属性]
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> attrType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 启用状态[0 - 禁用，1 - 启用]
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> enable<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 所属分类
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> catelogId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 快速展示【是否展示在介绍上；0-否 1-是】，在sku中仍然可以调整
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> showDesc<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 值类型【0-只能单个值，1-允许多个值】
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> valueType<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> attrGroupId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 所属分类名   /手机/数码/手机
     */</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> catelogName<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 所属分组名  主机
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> groupName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 所属分类的完整路径
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> catelogPath<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.2.1.png" alt="image-20220730164710466" tabindex="0" loading="lazy"><figcaption>image-20220730164710466</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.vo.SearchResult</code>类里添加如下代码，用于面包屑导航（其实面包屑导航更适合前端做）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 面包屑导航
 */</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NavVo</span><span class="token punctuation">&gt;</span></span> navs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">NavVo</span><span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 导航名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> navName<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 导航值
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> navValue<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 导航链接
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> link<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.2.2.png" alt="image-20220730155710887" tabindex="0" loading="lazy"><figcaption>image-20220730155710887</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里添加如下代码，用于构造面包屑</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ProductFeignService</span> productFeignService<span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">&gt;</span></span> navs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navs <span class="token operator">=</span> searchParam<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span> navVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//attrs=1_安卓:其他</span>
        <span class="token comment">//s[0]=1   s[1]=安卓:其他</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &quot;1_安卓:其他&quot; ==&gt; [1,安卓:其他]  length=2</span>
        <span class="token comment">// &quot;_安卓:其他&quot;  ==&gt;  [,_安卓:其他]  length=2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>attr<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> attrId <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//如果远程服务调用失败，就用id作为属性值</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> attrId<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">attrInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>attrId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">Object</span> attrVo <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> attrString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>attrVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AttrRespTo</span> attrRespTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>attrString<span class="token punctuation">,</span> <span class="token class-name">AttrRespTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    name <span class="token operator">=</span> attrRespTo<span class="token punctuation">.</span><span class="token function">getAttrName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            navVo<span class="token punctuation">.</span><span class="token function">setNavName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置属性值</span>
            navVo<span class="token punctuation">.</span><span class="token function">setNavValue</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//取消这个导航栏需要跳转到的url</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> navVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
searchResult<span class="token punctuation">.</span><span class="token function">setNavs</span><span class="token punctuation">(</span>navs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.2.3.png" alt="image-20220730165358765" tabindex="0" loading="lazy"><figcaption>image-20220730165358765</figcaption></figure><h5 id="_3、取消这个导航栏要跳转到的url" tabindex="-1"><a class="header-anchor" href="#_3、取消这个导航栏要跳转到的url" aria-hidden="true">#</a> 3、取消这个导航栏要跳转到的url</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.vo.SearchParam</code>类里添加字段，调用原生的方法，获取所有参数所组成的字符串（比如访问<code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc</code>，<code>queryString</code>就保存<code>attrs=1_A2100&amp;sort=saleCount_asc</code>）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**
 * 调用原生的方法，获取所有参数的字符串
 */</span>
<span class="token keyword">private</span> String queryString<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.3.1.png" alt="image-20220730165546344" tabindex="0" loading="lazy"><figcaption>image-20220730165546344</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.SearchController</code>类里修改<code>listPage</code>方法，用于调用原生的<code>HttpServletRequest</code>类的<code>getQueryString</code>方法，获取所有参数的字符串并赋值给<code>SearchParam</code>类的<code>queryString</code>字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 自动将页面提交过来的所有请求查询参数封装成指定的对象
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">listPage</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">{</span>
    searchParam<span class="token punctuation">.</span><span class="token function">setQueryString</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> mallSearchService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.3.2.png" alt="image-20220730165854263" tabindex="0" loading="lazy"><figcaption>image-20220730165854263</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.constant.EsConstant</code>常量类里添加<code>searchURI</code>字段，用于保存<code>检索页</code>的域名（其实放在该类并不合适，不过我懒得写了）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 检索页的url
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> searchURI <span class="token operator">=</span> <span class="token string">&quot;http://search.gulimall.com/list.html&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.3.3.png" alt="image-20220730170318248" tabindex="0" loading="lazy"><figcaption>image-20220730170318248</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里修改<code> navs = searchParam.getAttrs().stream().map</code>里的代码，用于设置<code>取消这个导航栏需要跳转到的url</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">&gt;</span></span> navs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navs <span class="token operator">=</span> searchParam<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span> navVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//attrs=1_安卓:其他</span>
        <span class="token comment">//s[0]=1   s[1]=安卓:其他</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &quot;1_安卓:其他&quot; ==&gt; [1,安卓:其他]  length=2</span>
        <span class="token comment">// &quot;_安卓:其他&quot;  ==&gt;  [,_安卓:其他]  length=2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>attr<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> attrId <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//如果远程服务调用失败，就用id作为属性值</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> attrId<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">attrInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>attrId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">Object</span> attrVo <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> attrString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>attrVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AttrRespTo</span> attrRespTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>attrString<span class="token punctuation">,</span> <span class="token class-name">AttrRespTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    name <span class="token operator">=</span> attrRespTo<span class="token punctuation">.</span><span class="token function">getAttrName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            navVo<span class="token punctuation">.</span><span class="token function">setNavName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置属性值</span>
            navVo<span class="token punctuation">.</span><span class="token function">setNavValue</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//取消这个导航栏需要跳转到的url</span>
            <span class="token class-name">String</span> queryString <span class="token operator">=</span> searchParam<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> attrString <span class="token operator">=</span> <span class="token string">&quot;attrs=&quot;</span><span class="token operator">+</span>attr<span class="token punctuation">;</span>
            <span class="token keyword">int</span> attrIndex <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>attrString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>queryString<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>attrString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//判断该参数后面还有没有参数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>queryString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span>attrIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//该属性是第一个参数，且不是最后一个参数</span>
                    <span class="token comment">//http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc</span>
                    replace <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;attrs=&quot;</span> <span class="token operator">+</span> attr <span class="token operator">+</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//该参数是第一个参数，也是最后一个参数</span>
                    <span class="token comment">//http://search.gulimall.com/list.html?attrs=1_A2100</span>
                    replace <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;attrs=&quot;</span> <span class="token operator">+</span> attr<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//该属性不是第一个参数</span>
                <span class="token comment">//http://search.gulimall.com/list.html?hasStock=1&amp;attrs=1_A2100</span>
                replace <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;attrs=&quot;</span> <span class="token operator">+</span> attr<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>replace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                navVo<span class="token punctuation">.</span><span class="token function">setLink</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>searchURI <span class="token operator">+</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">+</span> replace<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                navVo<span class="token punctuation">.</span><span class="token function">setLink</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>searchURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> navVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
searchResult<span class="token punctuation">.</span><span class="token function">setNavs</span><span class="token punctuation">(</span>navs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.3.4.png" alt="image-20220730185710988" tabindex="0" loading="lazy"><figcaption>image-20220730185710988</figcaption></figure><p>由于<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.AttrServiceImpl</code>类的<code>getAttrInfo</code>方法经常使用，因此可以把结果放入到缓存中，供下次使用</p><p><code>productFeignService.attrInfo(Long.parseLong(attrId));</code>方法会调用<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.AttrController#info</code>方法，而<code>info</code>方法又会调用<code>com.atguigu.gulimall.product.service.impl.AttrServiceImpl#getAttrInfo</code>方法，由于是远程调用可能非常耗时，因此可以加入缓存以提高查询效率</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Cacheable(value = &quot;attr&quot;,key = &quot;&#39;attrInfo:&#39;+ #root.args[0]&quot;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.3.5.png" alt="image-20220730203558184" tabindex="0" loading="lazy"><figcaption>image-20220730203558184</figcaption></figure><h5 id="_4、测试-3" tabindex="-1"><a class="header-anchor" href="#_4、测试-3" aria-hidden="true">#</a> 4、测试</h5><p>重启<code>GulimallProductApplication</code>服务和<code>GulimallSearchApplication</code>服务，在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里的<code>return navVo;</code>这里打上断点</p><p>在浏览器中输入如下网址</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?hasStock=1&amp;attrs=1_A2100
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时<code>SearchParam</code>类的<code>queryString</code>字段为<code>hasStock=1&amp;attrs=1_A2100</code></p><p>在<code>NavVo</code>类的<code>navValue</code>为<code>A2100</code>时，该类的<code>link</code>字段的值为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?hasStock=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>取消该属性确实是跳转到该<code>link</code>所在的页面</p><p>然后一直点击<code>Pause Program</code>按钮，放行完该请求，方便下次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.4.1.png" alt="image-20220730181259014" tabindex="0" loading="lazy"><figcaption>image-20220730181259014</figcaption></figure><p>在浏览器中输入如下网址</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时<code>SearchParam</code>类的<code>queryString</code>字段为<code>attrs=1_A2100&amp;sort=saleCount_asc</code></p><p>在<code>NavVo</code>类的<code>navValue</code>为<code>A2100</code>时，该类的<code>link</code>字段的值为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?sort=saleCount_asc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>取消该属性确实是跳转到该<code>link</code>所在的页面</p><p>然后一直点击<code>Pause Program</code>按钮，放行完该请求，方便下次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.4.2.png" alt="image-20220730181453448" tabindex="0" loading="lazy"><figcaption>image-20220730181453448</figcaption></figure><p>在浏览器中输入如下网址</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?attrs=1_A2100
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时<code>SearchParam</code>类的<code>queryString</code>字段为<code>attrs=1_A2100</code></p><p>在<code>NavVo</code>类的<code>navValue</code>为<code>A2100</code>时，该类的<code>link</code>字段的值为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>取消该属性确实是跳转到该<code>link</code>所在的页面</p><p>然后一直点击<code>Pause Program</code>按钮，放行完该请求，方便下次测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.4.3.png" alt="image-20220730181628394" tabindex="0" loading="lazy"><figcaption>image-20220730181628394</figcaption></figure><p>但是在请求的参数里有中文或空格就会出现问题</p><p>先在<code>kibana</code>里修改<code>skuId</code>为<code>10</code>的数据，使其出现空格和中文</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST gulimall_product/_doc/<span class="token number">10</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gulimall-anonymous.oss-cn-beijing.aliyuncs.com/2022-05-10/94d6c446-3d06-4e6e-8ddf-8da8f346f391_apple.png&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Apple IPhoneXS 苹果XS手机 银色 256GB&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Apple&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5000&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A13 plus加强版&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;入网型号&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8G&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;内存容量&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token number">225</span><span class="token punctuation">,</span>
  <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.4.4.png" alt="image-20220730182241428" tabindex="0" loading="lazy"><figcaption>image-20220730182241428</figcaption></figure><p>在浏览器中输入如下网址</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?attrs=1_A13 plus加强版
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时<code>SearchParam</code>类的<code>queryString</code>字段为<code>attrs=1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88</code></p><p>而<code>attr</code>的值为<code>1_A13 plus加强版</code>，这样肯定匹配不到该字符串，肯定无法删除该字符串</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.4.5.png" alt="image-20220730182552437" tabindex="0" loading="lazy"><figcaption>image-20220730182552437</figcaption></figure><h5 id="_5、修改代码后再次测试" tabindex="-1"><a class="header-anchor" href="#_5、修改代码后再次测试" aria-hidden="true">#</a> 5、修改代码后再次测试</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里的<code> navs = searchParam.getAttrs().stream().map</code>里的<code> String queryString = searchParam.getQueryString();</code>下面添加如下代码，用于将<code>attr</code>属性修改为<code>url</code>对应的格式</p><p>然后重启<code>GulimallSearchApplication</code>服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    attr <span class="token operator">=</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>刷新<code>http://search.gulimall.com/list.html?attrs=1_A13 plus加强版</code>页面，可以看到<code>queryString</code>字段的值为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>attrs=1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>而<code>attr</code>字段的值为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>1_A13+plus%E5%8A%A0%E5%BC%BA%E7%89%88
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>jdk</code>的把<code> 空格</code>，转为了<code>+</code>，而浏览器则把<code>空格</code>转换为了<code>%20</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.5.1.png" alt="image-20220730183333093" tabindex="0" loading="lazy"><figcaption>image-20220730183333093</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplicationTests</code>测试类里添加<code>testCoder</code>测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
   <span class="token comment">//jdk自带编码 java.net.URLDecoder; java.net.URLEncoder;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;jdk自带编码：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;错误的编码： &quot;</span> <span class="token operator">+</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;1_A13 plus加强版&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正确的编码： &quot;</span> <span class="token operator">+</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;1_A13 plus加强版&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;+&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;%20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">&quot;attrs=1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//Spring提供的编码 org.springframework.web.util.UriUtils;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Spring提供编码：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">UriUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;1_A13 plus加强版&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">UriUtils</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">&quot;attrs=1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到<code>jdk</code>会把<code>空格</code>加码为<code>+</code>，而解码可以成功把<code>%20</code>解码为<code>空格</code>，使用<code>Spring</code>提供的<code>UriUtils</code>则不会出现这个问题</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>jdk自带编码：
错误的编码： 1_A13+plus%E5%8A%A0%E5%BC%BA%E7%89%88
正确的编码： 1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88
attrs=1_A13 plus加强版

Spring提供编码：
1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88
attrs=1_A13 plus加强版
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.5.2.png" alt="image-20220730184823672" tabindex="0" loading="lazy"><figcaption>image-20220730184823672</figcaption></figure><p>将</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    attr <span class="token operator">=</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改为如下代码，使用<code>Spring</code>提供的加码方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>attr <span class="token operator">=</span> <span class="token class-name">UriUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后重启<code>GulimallSearchApplication</code>服务，刷新<code>http://search.gulimall.com/list.html?attrs=1_A13 plus加强版</code>页面</p><p>此时<code>SearchParam</code>类的<code>queryString</code>字段为<code>attrs=1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88</code></p><p>attr字段的值为<code>1_A13%20plus%E5%8A%A0%E5%BC%BA%E7%89%88</code>，与<code>queryString</code>字段的<code>attrs</code>参数值一致</p><p>在<code>NavVo</code>类的<code>navValue</code>为<code>A13 plus加强版</code>时，该类的<code>link</code>字段的值为</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.5.3.png" alt="image-20220730185201829" tabindex="0" loading="lazy"><figcaption>image-20220730185201829</figcaption></figure><h5 id="_6、检索页添加属性面包屑导航" tabindex="-1"><a class="header-anchor" href="#_6、检索页添加属性面包屑导航" aria-hidden="true">#</a> 6、检索页添加<code>属性</code>面包屑导航</h5><p>在<code>http://search.gulimall.com/list.html</code>页面里，打开控制台，定位到<code>手机</code>，复制<code>JD_ipone_one c</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.6.1.png" alt="image-20220730213102247" tabindex="0" loading="lazy"><figcaption>image-20220730213102247</figcaption></figure><p>然后在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里，搜索<code>JD_ipone_one c</code>，可以看到<code>手机</code>面包屑相关代码，复制<code>class</code>为<code>JD_ipone_one c</code>的<code>div</code>，并粘贴到其下面，并修改部分代码，遍历<code>result.navs</code>里的<code>navName</code>和<code>navValue</code></p><p>然后点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--面包屑导航--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_ipone_one c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav : \${result.navs}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${nav.link}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${nav.navName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> ：
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${nav.navValue}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> ×
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/search/image/right-@1x.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.6.2.png" alt="image-20220730215338331" tabindex="0" loading="lazy"><figcaption>image-20220730215338331</figcaption></figure><p>在<code>http://search.gulimall.com/list.html</code>页面里，依次点击<code>A13 plus加强版</code>和<code>8G</code>，可以看到面包屑的链接地址正确，并且点击<code>×</code>后可以来到正确的页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.4.6.3.gif" alt="GIF 2022-7-30 21-52-00" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 21-52-00</figcaption></figure><h4 id="_5、品牌添加面包屑导航" tabindex="-1"><a class="header-anchor" href="#_5、品牌添加面包屑导航" aria-hidden="true">#</a> 5、品牌添加面包屑导航</h4><h5 id="_1、远程查询品牌列表" tabindex="-1"><a class="header-anchor" href="#_1、远程查询品牌列表" aria-hidden="true">#</a> 1、远程查询品牌列表</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.BrandController</code>类里，复制<code>info</code>方法，粘贴到其下面，修改部分代码，使其在<code>BrandServiceImpl</code>类里根据<code>brandIds</code>查询<code>Brands</code>(品牌列表)</p><p>复制该方法的头信息(<code>@GetMapping(&quot;/infos&quot;) public R info(@RequestParam(&quot;brandIds&quot;) List&lt;Long&gt; brandIds)</code>)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据品牌id批量查询
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/infos&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;brandIds&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> brandIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrandEntity</span><span class="token punctuation">&gt;</span></span> brand <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">getBrandsByIds</span><span class="token punctuation">(</span>brandIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;brand&quot;</span><span class="token punctuation">,</span> brand<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.1.1.png" alt="image-20220730201920706" tabindex="0" loading="lazy"><figcaption>image-20220730201920706</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.BrandService</code>接口里添加<code>getBrandsByIds</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrandEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBrandsByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> brandIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.1.2.png" alt="image-20220730201954416" tabindex="0" loading="lazy"><figcaption>image-20220730201954416</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.BrandServiceImpl</code>类里实现<code>getBrandsByIds</code>抽象方法，用于根据<code>brandIds</code>查询<code>Brands</code>(品牌列表)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrandEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBrandsByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> brandIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BrandEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">BrandEntity</span><span class="token operator">::</span><span class="token function">getBrandId</span><span class="token punctuation">,</span> brandIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.1.3.png" alt="image-20220730202231316" tabindex="0" loading="lazy"><figcaption>image-20220730202231316</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.feign.ProductFeignService</code>接口里粘贴刚刚复制的头信息，并修改方法名为<code>branInfo</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/brand/infos&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">branInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;brandIds&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> brandIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.1.4.png" alt="image-20220730202357233" tabindex="0" loading="lazy"><figcaption>image-20220730202357233</figcaption></figure><p>选中<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法的里用来实现<code>面包屑取消功能</code>的<code>删除该参数</code>的这部分代码，按<code>ctrl + alt + M</code>快捷键，将其抽取为一个方法，并修改部分代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">replaceQueryString</span><span class="token punctuation">(</span><span class="token class-name">String</span> queryString<span class="token punctuation">,</span><span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> param <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
    <span class="token class-name">String</span> replace<span class="token punctuation">;</span>
    <span class="token keyword">int</span> attrIndex <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryString<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断该参数后面还有没有参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queryString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span>attrIndex<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//该属性是第一个参数，且不是最后一个参数</span>
            <span class="token comment">//http://search.gulimall.com/list.html?attrs=1_A2100&amp;sort=saleCount_asc</span>
            replace <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>key <span class="token operator">+</span><span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value <span class="token operator">+</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//该参数是第一个参数，也是最后一个参数</span>
            <span class="token comment">//http://search.gulimall.com/list.html?attrs=1_A2100</span>
            replace <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>key<span class="token operator">+</span><span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//该属性不是第一个参数</span>
        <span class="token comment">//http://search.gulimall.com/list.html?hasStock=1&amp;attrs=1_A2100</span>
        replace <span class="token operator">=</span> queryString<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token operator">+</span>key<span class="token operator">+</span><span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> replace<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.1.5.png" alt="image-20220730211452452" tabindex="0" loading="lazy"><figcaption>image-20220730211452452</figcaption></figure><p>此时，在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法的里用来实现<code>面包屑取消功能</code>的<code>删除该参数</code>的这部分代码可以直接使用以下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> queryString <span class="token operator">=</span> searchParam<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token class-name">UriUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token function">replaceQueryString</span><span class="token punctuation">(</span>queryString<span class="token punctuation">,</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.1.6.png" alt="image-20220730215002607" tabindex="0" loading="lazy"><figcaption>image-20220730215002607</figcaption></figure><h5 id="_2、设置品牌是否在检索页显示" tabindex="-1"><a class="header-anchor" href="#_2、设置品牌是否在检索页显示" aria-hidden="true">#</a> 2、设置<code>品牌</code>是否在检索页显示</h5><p>在<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件里修改<code>品牌</code>相关的代码，在<code>class=&quot;JD_nav_logo&quot;</code>的<code>&lt;div&gt;</code>里添加<code>th:with=&quot;brandId = \${param.brandId}&quot;</code>属性，用于暂存<code>url</code>里的<code>brandId</code>，并在<code>class=&quot;JD_nav_wrap&quot;</code>的<code>&lt;div&gt;</code>里添加<code>th:if=&quot;\${#strings.isEmpty(brandId)}&quot;</code>属性，当<code>brandId</code>为空时才显示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.2.png" alt="image-20220731094816752" tabindex="0" loading="lazy"><figcaption>image-20220731094816752</figcaption></figure><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_nav_logo<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>with</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>brandId = \${param.brandId}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--品牌--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_nav_wrap<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#strings.isEmpty(brandId)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>品牌：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value_logo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>brand:\${result.brands}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>brandId<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+brand.brandId+&#39;)&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${brand.brandImg}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${brand.brandName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                                华为(HUAWEI)
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_ext<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                更多
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">&quot;/static/search/image/search.ele.png&quot;</span><span class="token punctuation">)</span></span>no-repeat 3px 7px</span><span class="token punctuation">&#39;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span><span class="token value css language-css"><span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">&quot;/static/search/image/search.ele.png&quot;</span><span class="token punctuation">)</span></span>no-repeat 3px -44px</span><span class="token punctuation">&#39;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                多选
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span>+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--分类--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_pre<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>分类：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>catalog:\${result.catalogs}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:searchProducts(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>catalog3Id<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,&#39;+catalog.catalogId+&#39;)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${catalog.catalogName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--其他的所有需要展示的属性--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_pre<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attr:\${result.attrs}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${attr.attrName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>屏幕尺寸：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>val:\${attr.attrValue}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${val}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:attrAddOrReplace(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>attrs<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,<span class="token entity named-entity" title="&quot;">&amp;quot;</span>&#39;+attr.attrId+&#39;_&#39;+val+&#39;<span class="token entity named-entity" title="&quot;">&amp;quot;</span>)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>5.56英寸及以上<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3、测试-5" tabindex="-1"><a class="header-anchor" href="#_3、测试-5" aria-hidden="true">#</a> 3、测试</h5><p>重启<code>GulimallProductApplication</code>服务和<code>GulimallSearchApplication</code>服务，访问如下页面，可以看到页面已经报错了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://search.gulimall.com/list.html?brandId=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.3.1.png" alt="image-20220731094733723" tabindex="0" loading="lazy"><figcaption>image-20220731094733723</figcaption></figure><p>切换到<code>GulimallSearchApplication</code>服务的控制台，可以看到<code>MallSearchServiceImpl</code>类的<code>440</code>行报空指针</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-07-31 09:46:19.277 ERROR 3232 --- [io-12000-exec-2] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.NullPointerException] with root cause

java.lang.NullPointerException: null
	at com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl.buildSearchResponse(MallSearchServiceImpl.java:440) ~[classes/:na]
	at com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl.search(MallSearchServiceImpl.java:70) ~[classes/:na]
	at com.atguigu.gulimall.search.controller.SearchController.listPage(SearchController.java:31) ~[classes/:na]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.3.2.png" alt="image-20220731094938202" tabindex="0" loading="lazy"><figcaption>image-20220731094938202</figcaption></figure><p>在<code>navs</code>的定义那里设置<code>List&lt;SearchResult.NavVo&gt; navs = null;</code>，有可能<code>searchParam.getAttrs())</code>为空，这样<code>navs</code>就不能赋值，此时在<code>navs</code>里添加就报空指针异常了，可以让<code>navs = new ArrayList&lt;&gt;();</code>，这样即使<code>searchParam.getAttrs())</code>为空了页不会空指针了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>List&lt;SearchResult.NavVo&gt; navs = new ArrayList&lt;&gt;();
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.3.3.png" alt="image-20220731095017619" tabindex="0" loading="lazy"><figcaption>image-20220731095017619</figcaption></figure><p>重启<code>GulimallProductApplication</code>服务和<code>GulimallSearchApplication</code>服务，访问<code>http://search.gulimall.com/list.html</code>页面，点击<code>A13 plus加强版</code>，由于<code>华为</code>的<code>入网型号</code>里没有<code>A13 plus加强版</code>属性值，所以<code>华为</code>品牌不显示。再次点击<code>8G</code>，可以看到取消<code>A13 plus加强版</code>或<code>8G</code>后请求的<code>url</code>都正确</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.5.3.4.png" alt="GIF 2022-7-30 21-52-00" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-30 21-52-00</figcaption></figure><h4 id="_6、不显示已经选择过的属性" tabindex="-1"><a class="header-anchor" href="#_6、不显示已经选择过的属性" aria-hidden="true">#</a> 6、不显示已经选择过的属性</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.vo.SearchResult</code>类里添加<code>attrIds</code>字段，用于判断路径是否包含该<code>attr</code>，如果包含该<code>attr</code>，在面包屑上就已经显示了，不需要在筛选里面显示了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 路径是否包含该attr，如果包含该attr，在面包屑上就已经显示了，不需要在筛选里面显示了
 */</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.6.1.png" alt="image-20220731101339203" tabindex="0" loading="lazy"><figcaption>image-20220731101339203</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的<code>buildSearchResponse</code>方法里的<code>String attrId = s[0];</code>下面添加如下代码，用于表面该字段已经在面包屑中显示了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>searchResult.getAttrIds().add(Long.parseLong(attrId));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.6.2.png" alt="image-20220731101304593" tabindex="0" loading="lazy"><figcaption>image-20220731101304593</figcaption></figure><p>在<code>他的所有需要展示的属性</code>里的<code>class=&quot;JD_pre&quot;</code>的<code>&lt;div&gt;</code>里添加<code>th:if=&quot;\${!#lists.contains(result.attrIds,attr.attrId)}&quot;</code>属性，表示如果<code>result.attrIds</code>里面存在此次遍历的<code>attr.attrId</code>，就不显示该<code>attr.attrName</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--其他的所有需要展示的属性--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>JD_pre<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attr:\${result.attrs}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${!#lists.contains(result.attrIds,attr.attrId)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${attr.attrName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>屏幕尺寸：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sl_value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>val:\${attr.attrValue}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${val}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${&#39;javascript:attrAddOrReplace(<span class="token entity named-entity" title="&quot;">&amp;quot;</span>attrs<span class="token entity named-entity" title="&quot;">&amp;quot;</span>,<span class="token entity named-entity" title="&quot;">&amp;quot;</span>&#39;+attr.attrId+&#39;_&#39;+val+&#39;<span class="token entity named-entity" title="&quot;">&amp;quot;</span>)&#39;}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>5.56英寸及以上<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.6.3.png" alt="image-20220731101651964" tabindex="0" loading="lazy"><figcaption>image-20220731101651964</figcaption></figure><p>重启<code>GulimallSearchApplication</code>服务，可以看到在点击某个<code>品牌</code>或<code>属性</code>后，该<code>品牌</code>或<code>属性</code>会在面包屑中显示，而不会在筛选里面显示了。当取消面包屑里的<code>品牌</code>或<code>属性</code>后，会再次在筛选里面显示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.5.6.6.4.gif" alt="GIF 2022-7-31 10-17-36" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-31 10-17-36</figcaption></figure><p><code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.MallSearchServiceImpl</code>类的完整代码</p>`,747),Qn=n("code",null,"MallSearchServiceImpl",-1);function Yn(Zn,na){const t=o("ExternalLinkIcon"),e=o("RouterLink");return l(),u("div",null,[d,n("blockquote",null,[k,n("ul",null,[m,n("li",null,[n("a",g,[a("GET"),s(t)]),a(" -- 返回 key 存储的值，如果 key 不存在返回空")])]),n("p",null,[v,a(" 由于"),b,a("命令加上选项已经可以完全取代"),h,a(", "),n("a",f,[a("SETEX"),s(t)]),a(", "),n("a",q,[a("PSETEX"),s(t)]),a(", "),n("a",y,[a("GETSET"),s(t)]),a(",的功能，所以在将来的版本中，redis可能会不推荐使用并且最终抛弃这几个命令。")]),w,n("p",null,[n("a",x,[a("字符串"),s(t)]),a(": 如果"),_,a("命令正常执行那么回返回"),C,a(),n("a",z,[a("多行字符串"),s(t)]),a(": 使用 GET 选项，返回 key 存储的值，如果 key 不存在返回空 "),n("a",S,[a("空"),s(t)]),a(": 否则如果加了"),I,a(" 或者 "),j,a("选项，"),n("a",R,[a("SET"),s(t)]),a(" 没执行，那么会返回nil。")]),E,n("ul",null,[P,n("li",null,[A,a(": Added the "),n("a",L,[a("GET"),s(t)]),a(" option.")])]),T,n("p",null,[n("strong",null,[n("a",F,[a("SET"),s(t)])])]),n("p",null,[G,a(" 下面这种设计模式并不推荐用来实现redis分布式锁。应该参考 "),n("a",N,[a("the Redlock algorithm"),s(t)]),a(" 的实现，虽然这个方法只是复杂一点，但是却能保证更好的使用效果。")]),M]),V,n("p",null,[a("中文文档： "),n("a",O,[a("Redis SET 命令"),s(t)])]),D,n("blockquote",null,[n("p",null,[a("基于Redis的Redisson分布式可重入锁"),n("a",B,[U,s(t)]),a(" Java对象实现了"),J,a("接口。同时还提供了"),n("a",$,[a("异步（Async）"),s(t)]),a("、"),n("a",W,[a("反射式（Reactive）"),s(t)]),a("和"),n("a",H,[a("RxJava2标准"),s(t)]),a("的接口。")]),K,n("p",null,[a("大家都知道，如果负责储存这个分布式锁的Redisson节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改"),n("a",X,[a("Config.lockWatchdogTimeout"),s(t)]),a("来另行指定。")]),Q,n("p",null,[Y,a("对象完全符合Java的Lock规范。也就是说只有拥有锁的进程才能解锁，其他进程解锁则会抛出"),Z,a("错误。但是如果遇到需要其他进程也能解锁的情况，请使用"),n("a",nn,[a("分布式信号量"),an,s(t)]),a(" 对象.")])]),sn,n("blockquote",null,[n("p",null,[a("基于Redis的Redisson分布式可重入公平锁也是实现了"),tn,a("接口的一种"),pn,a("对象。同时还提供了"),n("a",en,[a("异步（Async）"),s(t)]),a("、"),n("a",on,[a("反射式（Reactive）"),s(t)]),a("和"),n("a",cn,[a("RxJava2标准"),s(t)]),a("的接口。它保证了当多个Redisson客户端线程同时请求加锁时，优先分配给先发出请求的线程。所有请求线程会在一个队列中排队，当某个线程出现宕机时，Redisson会等待5秒后继续下一个线程，也就是说如果前面有5个线程都处于等待状态，那么后面的线程会等待至少25秒。")]),ln,n("p",null,[a("大家都知道，如果负责储存这个分布式锁的Redis节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改"),n("a",un,[a("Config.lockWatchdogTimeout"),s(t)]),a("来另行指定。")]),rn]),dn,kn,n("blockquote",null,[n("p",null,[a("基于Redis的Redisson分布式可重入读写锁"),n("a",mn,[gn,s(t)]),a(" Java对象实现了"),vn,a("接口。其中读锁和写锁都继承了"),n("a",bn,[a("RLock"),s(t)]),a("接口。")]),hn,n("p",null,[a("大家都知道，如果负责储存这个分布式锁的Redis节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改"),n("a",fn,[a("Config.lockWatchdogTimeout"),s(t)]),a("来另行指定。")]),qn]),yn,n("blockquote",null,[n("p",null,[a("基于Redis的Redisson的分布式信号量（"),n("a",wn,[a("Semaphore"),s(t)]),a("）Java对象"),xn,a("采用了与"),_n,a("相似的接口和用法。同时还提供了"),n("a",Cn,[a("异步（Async）"),s(t)]),a("、"),n("a",zn,[a("反射式（Reactive）"),s(t)]),a("和"),n("a",Sn,[a("RxJava2标准"),s(t)]),a("的接口。")]),In]),jn,n("blockquote",null,[n("p",null,[a("基于Redisson的Redisson分布式闭锁（"),n("a",Rn,[a("CountDownLatch"),s(t)]),a("）Java对象"),En,a("采用了与"),Pn,a("相似的接口和用法。")]),An]),Ln,n("blockquote",null,[Tn,n("p",null,[a("Enable support for "),n("a",Fn,[Gn,s(t)]),a(" annotated beans. "),Nn,a(" beans can be registered in the standard way (for example using "),n("a",Mn,[Vn,s(t)]),a(" methods) or, for convenience, can be specified directly on this annotation.")])]),On,n("p",null,[s(e,{to:"/gulimall/code/5.5.1.1.5.index.html"},{default:c(()=>[a("点击查看"),Dn,a("完整代码")]),_:1})]),Bn,n("blockquote",null,[n("p",null,[a("Nested query allows to query nested objects / docs (see "),n("a",Un,[a("nested mapping"),s(t)]),a("). The query is executed against the nested objects / docs as if they were indexed as separate docs (they are, internally) and resulting in the root parent doc (or parent nested mapping). Here is a sample mapping we will work with:")]),Jn]),$n,n("p",null,[a("随便找一个"),Wn,a("格式化工具，比如 "),n("a",Hn,[a("在线JSON校验格式化工具（Be JSON）"),s(t)]),a(" ，粘贴刚刚复制的请求，然后点击"),Kn]),Xn,n("p",null,[s(e,{to:"/gulimall/code/"},{default:c(()=>[a("点击查看"),Qn,a("类的完整代码")]),_:1})])])}const ta=i(r,[["render",Yn],["__file","advanced2.html.vue"]]);export{ta as default};
