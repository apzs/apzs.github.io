import{_ as i}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as c,o as l,c as u,a as n,b as s,d as a,w as o,e as t}from"./app-db_OQQsY.js";const r={},d=t(`<h3 id="_5-7、认证中心" tabindex="-1"><a class="header-anchor" href="#_5-7、认证中心" aria-hidden="true">#</a> 5.7、认证中心</h3><p>认证中心对用户进行统一的登录认证</p><h3 id="_5-7-1、添加认证中心" tabindex="-1"><a class="header-anchor" href="#_5-7-1、添加认证中心" aria-hidden="true">#</a> 5.7.1、添加认证中心</h3><h4 id="_1、认证中心初始化" tabindex="-1"><a class="header-anchor" href="#_1、认证中心初始化" aria-hidden="true">#</a> 1、认证中心初始化</h4><h5 id="_1、新建认证中心模块" tabindex="-1"><a class="header-anchor" href="#_1、新建认证中心模块" aria-hidden="true">#</a> 1、新建认证中心模块</h5><p>选中<code>IDEA</code>里<code>Project</code>的<code>gulimall</code>，右键依次点击<code>New</code>-&gt;<code>Module</code>-&gt;<code>Spring Initializr</code>-&gt;<code>Next</code></p><p>在<code>New Module</code>对话框里<code>Group</code>里输入<code>com.atguigu.gulimall</code>，<code>Artifact</code>里输入<code>gulimall-auth-server</code>，<code>Java Version</code>选择<code>8</code>，<code>Description</code>里输入<code>认证中心(社交登录、OAuth2.0、单点登录)</code>，<code>Package</code>里输入<code>com.atguigu.gulimall.auth</code>，然后点击<code>Next</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>com.atguigu.gulimall
gulimall-auth-server
0.0.1-SNAPSHOT
gulimall-auth-server
认证中心(社交登录、OAuth2.0、单点登录) 
com.atguigu.gulimall.auth
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.1.png" alt="image-20220803110137987" tabindex="0" loading="lazy"><figcaption>image-20220803110137987</figcaption></figure><p>选择<code>Devloper Tools</code>里的<code>Spring Boot DevTools</code>和<code>Lombox</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.2.png" alt="image-20220803110344173" tabindex="0" loading="lazy"><figcaption>image-20220803110344173</figcaption></figure><p>选择<code>Web</code>里的<code>Spring Web</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.3.png" alt="image-20220803110414437" tabindex="0" loading="lazy"><figcaption>image-20220803110414437</figcaption></figure><p>选择<code>Template Engines</code>里的<code>Thymeleaf</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.4.png" alt="image-20220803110442958" tabindex="0" loading="lazy"><figcaption>image-20220803110442958</figcaption></figure><p>选择<code>Spring Cloud Routing</code>里的<code>OpenFeign</code>，然后点击<code>Next</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.5.png" alt="image-20220803110528317" tabindex="0" loading="lazy"><figcaption>image-20220803110528317</figcaption></figure><p>最后点击<code>Finish</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.6.png" alt="image-20220803110555561" tabindex="0" loading="lazy"><figcaption>image-20220803110555561</figcaption></figure><p>复制<code>gulimall-auth-server</code>模块的<code>pom.xml</code>文件的<code>dependencies</code>和<code>项目信息</code>的部分，(<code>properties</code>里的不要)</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.gulimall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-auth-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>gulimall-auth-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>认证中心(社交登录、OAuth2.0、单点登录) <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   ......
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后复制<code>gulimall-product</code>模块的<code>pom.xml</code>文件，粘贴到<code>gulimall-auth-server</code>模块的<code>pom.xml</code>文件里，删除<code>dependencies</code>和<code>项目信息</code>的部分，替换为<code>gulimall-auth-server</code>模块的<code>pom.xml</code>文件的<code>dependencies</code>和<code>项目信息</code></p><p>如果<code>pom.xml</code>文件颜色为赤橙色，可以选中<code>pom.xml</code>文件，右键选择<code>Add as Maven Project</code>就好了(最好先替换文件，再加入到项目)</p><p><a href="code/5.7.1.1.1.pom.xml">点击查看完整<code>pom.xml</code>文件</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.7.png" alt="image-20220803111313234" tabindex="0" loading="lazy"><figcaption>image-20220803111313234</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.GulimallAuthServerApplicationTests</code>测试类为<code>junit4</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallAuthServerApplicationTests</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.1.8.png" alt="image-20220803111831437" tabindex="0" loading="lazy"><figcaption>image-20220803111831437</figcaption></figure><h5 id="_2、添加依赖" tabindex="-1"><a class="header-anchor" href="#_2、添加依赖" aria-hidden="true">#</a> 2、添加依赖</h5><p>在<code>gulimall-auth-server</code>模块的<code>pom.xml</code>的<code>&lt;dependencies&gt;</code>标签里引入<code>gulimall-common</code>依赖，由于<code>gulimall-auth-server</code>模块不操作数据库可以移除<code>gulimall-common</code>模块的<code>mybatis-plus</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.gulimall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.2.1.png" alt="image-20220803112729182" tabindex="0" loading="lazy"><figcaption>image-20220803112729182</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里配置应用名和注册中心的地址</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">gulimall-auth-server</span>
<span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">20000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.2.2.png" alt="image-20220803113146718" tabindex="0" loading="lazy"><figcaption>image-20220803113146718</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.GulimallAuthServerApplication</code>启动类上添加<code>@EnableDiscoveryClient</code>注解，开启服务发现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.2.3.png" alt="image-20220803113235752" tabindex="0" loading="lazy"><figcaption>image-20220803113235752</figcaption></figure><p>由于<code>gulimall-auth-server</code>模块的<code>pom.xml</code>文件已经引入了远程调用的<code>openfeign</code>，因此就不用引了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.2.4.png" alt="image-20220803113318794" tabindex="0" loading="lazy"><figcaption>image-20220803113318794</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.GulimallAuthServerApplication</code>启动类上添加<code>@EnableFeignClients</code>注解，开启远程调用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.2.5.png" alt="image-20220803113414085" tabindex="0" loading="lazy"><figcaption>image-20220803113414085</figcaption></figure><p>使用浏览器访问<code>http://localhost:8848/nacos</code>页面，用户名和密码都为<code>nacos</code></p><p>点击<code>服务管理/服务列表</code>可以看到<code>gulimall-auth-server</code>已经加入进来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.2.6.png" alt="image-20220803113608915" tabindex="0" loading="lazy"><figcaption>image-20220803113608915</figcaption></figure><h5 id="_3、导入静态资源" tabindex="-1"><a class="header-anchor" href="#_3、导入静态资源" aria-hidden="true">#</a> 3、导入静态资源</h5><p>在<code>2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\登录页面</code>里把<code>index.html</code>复制到<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates</code>文件里面，并将<code>index.html</code>改名为<code>login.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.1.gif" alt="GIF 2022-8-3 11-38-10" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 11-38-10</figcaption></figure><p>在<code>2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\注册页面</code>里，把<code>index.html</code>复制到<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates</code>文件里面，并将<code>index.html</code>改名为<code>reg.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.2.gif" alt="GIF 2022-8-3 11-44-00" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 11-44-00</figcaption></figure><p>打开<code>SwitchHosts</code>软件，依次点击<code>hosts</code>-&gt;<code>本地方案</code>-&gt;<code>gulimall</code>，在后面添加<code>192.168.56.10 auth.gulimall.com</code>，然后点击<code>对勾</code>图标</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># gulimall</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">search.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">item.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">auth.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.3.png" alt="image-20220803114604485" tabindex="0" loading="lazy"><figcaption>image-20220803114604485</figcaption></figure><p>在<code>linux虚拟机</code>的<code>/mydata/nginx/html/static</code>目录下新建<code>login</code>目录，把<code>2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\登录页面</code>里的所有文件夹都复制到<code>linux虚拟机</code>的<code>/mydata/nginx/html/static/login</code>里面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.4.gif" alt="GIF 2022-8-3 11-54-19" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 11-54-19</figcaption></figure><p>在<code>linux虚拟机</code>的<code>/mydata/nginx/html/static</code>目录下新建<code>reg</code>目录，把<code>2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\注册页面</code>里的所有文件夹都复制到<code>linux虚拟机</code>的<code>/mydata/nginx/html/static/reg</code>里面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.5.gif" alt="GIF 2022-8-3 11-56-22" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 11-56-22</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件里，将<code>src=&quot;</code>(除<code>src=&#39;某url&#39;</code>)替换为<code> src=&quot;/static/login/</code>，将<code>href=&quot;</code>(除<code>href=&#39;某url&#39;</code>或<code>href=&#39;#&#39;</code>)替换为<code>href=&quot;/static/login/</code></p>`,59),k=t('<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.6.png" alt="image-20220803115948128" tabindex="0" loading="lazy"><figcaption>image-20220803115948128</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里，将<code>src=&quot;</code>(除<code>src=&#39;某url&#39;</code>)替换为<code> src=&quot;/static/reg/</code>，将<code>href=&quot;</code>(除<code>href=&#39;某url&#39;</code>或<code>href=&#39;#&#39;</code>)替换为<code>href=&quot;/static/reg/</code></p>',2),m=t(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.3.7.png" alt="image-20220803162601349" tabindex="0" loading="lazy"><figcaption>image-20220803162601349</figcaption></figure><h5 id="_4、添加到gateway" tabindex="-1"><a class="header-anchor" href="#_4、添加到gateway" aria-hidden="true">#</a> 4、添加到<code>gateway</code></h5><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>文件里添加如下配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_auth_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Host=auth.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.4.png" alt="image-20220803163319730" tabindex="0" loading="lazy"><figcaption>image-20220803163319730</figcaption></figure><h5 id="_5、访问页面" tabindex="-1"><a class="header-anchor" href="#_5、访问页面" aria-hidden="true">#</a> 5、访问页面</h5><p>将<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件改名为<code>index.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.5.1.png" alt="image-20220803163331963" tabindex="0" loading="lazy"><figcaption>image-20220803163331963</figcaption></figure><p>启动<code>GulimallGatewayApplication</code>服务和<code>GulimallAuthServerApplication</code>服务</p><p>在浏览器里打开<code>http://auth.gulimall.com/</code>页面，可以看到已经访问成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.5.2.png" alt="image-20220803163348978" tabindex="0" loading="lazy"><figcaption>image-20220803163348978</figcaption></figure><h5 id="_6、修改页面" tabindex="-1"><a class="header-anchor" href="#_6、修改页面" aria-hidden="true">#</a> 6、修改页面</h5><p>在<code>http://auth.gulimall.com</code>页面里，打开控制台，定位到<code>谷粒商城</code>的图标，复制<code>/static/login/JD_img/logo.jpg</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.6.1.png" alt="image-20220803163520948" tabindex="0" loading="lazy"><figcaption>image-20220803163520948</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/index.html</code>文件里，搜索<code>/static/login/JD_img/logo.jpg</code>，将该行修改为如下代码，点击谷粒商城图标可以跳转到主页</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/login/JD_img/logo.jpg<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.6.2.png" alt="image-20220803163704631" tabindex="0" loading="lazy"><figcaption>image-20220803163704631</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里关闭<code>thymeleaf</code>缓存</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.thymeleaf.cache</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.6.3.png" alt="image-20220803163911690" tabindex="0" loading="lazy"><figcaption>image-20220803163911690</figcaption></figure><p>在<code>http://auth.gulimall.com</code>页面里点击<code>谷粒商城</code>图标，可以正常跳转到<code>http://gulimall.com</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.1.6.4.png" alt="GIF 2022-8-3 16-40-23" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 16-40-23</figcaption></figure><h4 id="_2、完善页面跳转" tabindex="-1"><a class="header-anchor" href="#_2、完善页面跳转" aria-hidden="true">#</a> 2、完善页面跳转</h4><h5 id="_1、主页跳转到登录页和注册页" tabindex="-1"><a class="header-anchor" href="#_1、主页跳转到登录页和注册页" aria-hidden="true">#</a> 1、主页跳转到登录页和注册页</h5><p>在<code>gulimall.com</code>页面里，打开控制台，定位到<code>你好，请登录</code>，复制<code>你好，请登录</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.1.1.png" alt="image-20220803164134463" tabindex="0" loading="lazy"><figcaption>image-20220803164134463</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里搜索<code>你好，请登录</code>，修改<code>登录</code>和<code>注册</code>的<code> href</code>属性</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>li_2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.1.2.png" alt="image-20220803164336789" tabindex="0" loading="lazy"><figcaption>image-20220803164336789</figcaption></figure><p>重新启动<code>GulimallProductApplication</code>服务和<code>GulimallAuthServerApplication</code>服务，在<code>http://gulimall.com</code>页面里点击<code>你好，请登录</code>来到了<code>http://auth.gulimall.com/login.html</code>页面，但是网页没有正常显示。返回到<code>http://gulimall.com</code>页面，点击<code>免费注册</code>来到了<code>http://auth.gulimall.com/reg.html</code>页面，但是网页也没有正常显示。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.1.3.gif" alt="GIF 2022-8-3 16-44-56" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 16-44-56</figcaption></figure><p>在<code>gulimall-auth-server</code>模块里，重新将<code>src/main/resources/templates/index.html</code>文件修改为<code>login.html</code></p><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth</code>包下新建<code>controller</code>文件夹，在<code>controller</code>文件夹里新建<code>LoginController</code>类，用来映射<code>login.html</code>和<code>reg.html</code>文件</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/3
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/reg.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">regPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;reg&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.1.4.png" alt="image-20220803164844472" tabindex="0" loading="lazy"><figcaption>image-20220803164844472</figcaption></figure><p>重新启动<code>GulimallProductApplication</code>服务和<code>GulimallAuthServerApplication</code>服务，在<code>http://gulimall.com</code>页面里点击<code>你好，请登录</code>来到了<code>http://auth.gulimall.com/login.html</code>页面，页面也正确显示。返回到<code>http://gulimall.com</code>页面，点击<code>免费注册</code>来到了<code>http://auth.gulimall.com/reg.html</code>页面，页面也正确显示。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.1.5.gif" alt="GIF 2022-8-3 16-50-21" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 16-50-21</figcaption></figure><h5 id="_2、登录页跳转到注册页" tabindex="-1"><a class="header-anchor" href="#_2、登录页跳转到注册页" aria-hidden="true">#</a> 2、登录页跳转到注册页</h5><p>在<code>http://auth.gulimall.com/login.html</code>页面里，打开控制台，定位到<code>立即注册</code>，复制<code>立即注册</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.2.1.png" alt="image-20220803165137388" tabindex="0" loading="lazy"><figcaption>image-20220803165137388</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件里搜索<code>立即注册</code>，修改其<code>href</code>属性</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rig<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/login/JD_img/4de5019d2404d347897dee637895d02b_25.png<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立即注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.2.2.png" alt="image-20220803165341685" tabindex="0" loading="lazy"><figcaption>image-20220803165341685</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;login.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><p>在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>立即注册</code>，正确来到了<code>http://auth.gulimall.com/reg.html</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.2.3.gif" alt="GIF 2022-8-3 16-53-59" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 16-53-59</figcaption></figure><h5 id="_3、注册页跳转到登录页" tabindex="-1"><a class="header-anchor" href="#_3、注册页跳转到登录页" aria-hidden="true">#</a> 3、注册页跳转到登录页</h5><p>打开<code>http://auth.gulimall.com/reg.html</code>页面，点击<code>同意并继续</code>，然后打开控制台，定位到<code>请登录</code>，复制<code>请登录</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.3.1.png" alt="image-20220803165522990" tabindex="0" loading="lazy"><figcaption>image-20220803165522990</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里搜索<code>请登录</code>，修改其<code>href</code>属性</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dfg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>已有账号？<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.3.2.png" alt="image-20220803165726261" tabindex="0" loading="lazy"><figcaption>image-20220803165726261</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;reg.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><p>打开<code>http://auth.gulimall.com/reg.html</code>页面，点击<code>同意并继续</code>，然后点击<code>请登录</code>，成功跳转到<code>http://auth.gulimall.com/login.html</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.2.3.3.gif" alt="GIF 2022-8-3 16-58-06" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 16-58-06</figcaption></figure><h4 id="_3、修改验证码图片" tabindex="-1"><a class="header-anchor" href="#_3、修改验证码图片" aria-hidden="true">#</a> 3、修改验证码图片</h4><h5 id="_1、修改前端页面" tabindex="-1"><a class="header-anchor" href="#_1、修改前端页面" aria-hidden="true">#</a> 1、修改前端页面</h5><p>打开<code>http://auth.gulimall.com/reg.html</code>页面，点击<code>同意并继续</code>，然后打开控制台，定位到验证码的图片，复制<code>id=&quot;code&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.1.1.png" alt="image-20220803165946124" tabindex="0" loading="lazy"><figcaption>image-20220803165946124</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里搜索<code>id=&quot;code&quot;</code>，将<code>&lt;span id=&quot;code&quot;&gt;&lt;/span&gt;</code>修改为<code>&lt;span&gt;发送验证码&lt;/span&gt;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>发送验证码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.1.2.png" alt="image-20220803170107555" tabindex="0" loading="lazy"><figcaption>image-20220803170107555</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;reg.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><p>打开<code>http://auth.gulimall.com/reg.html</code>页面，点击<code>同意并继续</code>，图片验证码的位置已经替换为<code>发送验证码</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.1.3.png" alt="image-20220803170149877" tabindex="0" loading="lazy"><figcaption>image-20220803170149877</figcaption></figure><h5 id="_2、添加倒计时" tabindex="-1"><a class="header-anchor" href="#_2、添加倒计时" aria-hidden="true">#</a> 2、添加倒计时</h5><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里，给<code>发送验证码</code>的<code>&lt;a&gt;</code>标签添加<code>id=&quot;sendCode&quot;</code>属性</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sendCode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送验证码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.2.1.png" alt="image-20220803170307131" tabindex="0" loading="lazy"><figcaption>image-20220803170307131</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里，在<code>&lt;script&gt;</code>标签里，添加如下方法：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 发送验证码</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//1、给指定手机号发送验证码</span>
      <span class="token comment">//2、倒计时</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//正在倒计时。</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;发送验证码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> str <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token string">&quot;s 后再次发送&quot;</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token string">&quot;timeoutChangeStyle()&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      num<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.2.2.png" alt="image-20220803171507886" tabindex="0" loading="lazy"><figcaption>image-20220803171507886</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;reg.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><p>打开<code>http://auth.gulimall.com/reg.html</code>页面，点击<code>同意并继续</code>，点击<code>发送验证码</code>，已经出现了<code>10s</code>的倒计时了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.2.3.gif" alt="GIF 2022-8-3 17-14-08" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 17-14-08</figcaption></figure><h5 id="_3、批量配置简单视图映射" tabindex="-1"><a class="header-anchor" href="#_3、批量配置简单视图映射" aria-hidden="true">#</a> 3、批量配置简单视图映射</h5><p>在<code>org.springframework.web.servlet.config.annotation.WebMvcConfigurer</code>接口里有一个<code>addViewControllers</code>方法可以批量配置视图的映射</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Configure simple automated controllers pre-configured with the response
 * status code and/or a view to render the response body. This is useful in
 * cases where there is no need for custom controller logic -- e.g. render a
 * home page, perform simple site URL redirects, return a 404 status with
 * HTML content, a 204 with no content, and more.
 */</span>
<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.3.1.png" alt="image-20220803172040830" tabindex="0" loading="lazy"><figcaption>image-20220803172040830</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth</code>包下新建<code>config</code>文件夹，在<code>config</code>文件夹里新建<code>GulimallWebConfig</code>类，实现<code>WebMvcConfigurer</code>接口，重写<code>addViewControllers</code>方法，配置对<code>login.html</code>文件和<code>reg.html</code>文件的路径映射</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ViewControllerRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/3
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * @GetMapping(&quot;/login.html&quot;)
     * public String loginPage()<span class="token punctuation">{</span>
     *     return &quot;login&quot;;
     * <span class="token punctuation">}</span>
     * <span class="token keyword">@param</span> <span class="token parameter">registry</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/reg.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;reg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.3.2.png" alt="image-20220803172800659" tabindex="0" loading="lazy"><figcaption>image-20220803172800659</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类里删掉对<code>login.html</code>文件和<code>reg.html</code>文件的路径映射</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/3
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{</span>

    <span class="token comment">//@GetMapping(&quot;/login.html&quot;)</span>
    <span class="token comment">//public String loginPage(){</span>
    <span class="token comment">//    return &quot;login&quot;;</span>
    <span class="token comment">//}</span>
    <span class="token comment">//</span>
    <span class="token comment">//@GetMapping(&quot;/reg.html&quot;)</span>
    <span class="token comment">//public String regPage(){</span>
    <span class="token comment">//    return &quot;reg&quot;;</span>
    <span class="token comment">//}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.3.3.png" alt="image-20220803172434752" tabindex="0" loading="lazy"><figcaption>image-20220803172434752</figcaption></figure><p>重启<code>GulimallAuthServerApplication</code>服务，可以看到<code>http://auth.gulimall.com/login.html</code>和<code>http://auth.gulimall.com/reg.html</code>也能正确访问</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.1.3.3.4.gif" alt="GIF 2022-8-3 17-28-32" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 17-28-32</figcaption></figure><h3 id="_5-7-2、短信服务-邮件服务" tabindex="-1"><a class="header-anchor" href="#_5-7-2、短信服务-邮件服务" aria-hidden="true">#</a> 5.7.2、短信服务&amp;邮件服务</h3><h4 id="_1、短信服务简单测试" tabindex="-1"><a class="header-anchor" href="#_1、短信服务简单测试" aria-hidden="true">#</a> 1、短信服务简单测试</h4><h5 id="_1、购买短信服务" tabindex="-1"><a class="header-anchor" href="#_1、购买短信服务" aria-hidden="true">#</a> 1、购买短信服务</h5><p>在阿里云网站里点击<code>云市场</code>，在<code>云市场</code>里搜索<code>短信</code>，随便点击一个商家，购买免费的几次短信服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.1.gif" alt="GIF 2022-8-3 18-43-05" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-3 18-43-05</figcaption></figure><h5 id="_2、调试工具测试" tabindex="-1"><a class="header-anchor" href="#_2、调试工具测试" aria-hidden="true">#</a> 2、调试工具测试</h5><p><strong>短信单条发送</strong></p><p>*调用地址：*http(s)😕/gyytz.market.alicloudapi.com/sms/smsSend</p><p>*请求方式：*POST</p><p>*返回类型：*JSON</p><p><strong>请求参数（Query）</strong></p><table><thead><tr><th style="text-align:left;">名称</th><th style="text-align:left;">类型</th><th style="text-align:left;">是否必须</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">mobile</td><td style="text-align:left;">STRING</td><td style="text-align:left;">必选</td><td style="text-align:left;">需要发送的手机号。（同一手机号码，同一签名验证码，一分钟一次，频率过快可能会导致运营商系统屏蔽，用户无法正常接收。）</td></tr><tr><td style="text-align:left;">param</td><td style="text-align:left;">STRING</td><td style="text-align:left;">可选</td><td style="text-align:left;">短信模板变量替换。（字符串格式：<strong>key</strong>:value,<strong>key</strong>:value。例如：<strong>code</strong>:12345,<strong>minute</strong>:5。如模板中有多个变量请使用英文逗号隔开。建议对参数进行URLEncode编码，以免出现乱码等异常情况）</td></tr><tr><td style="text-align:left;">smsSignId</td><td style="text-align:left;">STRING</td><td style="text-align:left;">必选</td><td style="text-align:left;">短信前缀ID（签名ID），联系客服申请。（测试ID请用：2e65b1bb3d054466b82f0c9d125465e2，对应短信前缀为【国阳云】。测试签名短信限流规则，同一个号码，1分钟1次，1小时5次，24小时10次，且仅支持接口调试少量测试，不支持大量商用）</td></tr><tr><td style="text-align:left;">templateId</td><td style="text-align:left;">STRING</td><td style="text-align:left;">必选</td><td style="text-align:left;">短信正文ID（模板ID），联系客服申请。（测试ID请用：908e94ccf08b4476ba6c876d13f084ad，对应短信正文为 { 验证码：<strong>code</strong>，<strong>minute</strong>分钟内有效，请勿泄漏于他人！}）</td></tr></tbody></table><p>点击<code>API接口</code>-&gt;<code>短信单条发送</code>-&gt;<code>调试工具</code>里的<code>去调试</code>，可以进入到短信调试界面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.2.1.png" alt="image-20220803191838428" tabindex="0" loading="lazy"><figcaption>image-20220803191838428</figcaption></figure><p>短信服务提供商已自动把需要的<code>Query</code>参数和<code>AppCode</code>填写好了，直接输入自己的电话号就行了</p><p><a href="code/5.7.2.1.2.txt">点击查看调试工具的控制台完整信息</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.2.2.png" alt="image-20220803190740766" tabindex="0" loading="lazy"><figcaption>image-20220803190740766</figcaption></figure><p><code>AppCode</code>可以在<code>云市场</code>里的<code>已购买的服务</code>中查看</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.2.3.png" alt="image-20220803190422539" tabindex="0" loading="lazy"><figcaption>image-20220803190422539</figcaption></figure><p>收到的短信：</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.2.4.png" alt="无标题" style="zoom:33%;"><p>本服务商的可选模板有以下几种，可以修改<code>templateId</code>参数选择想要的模板</p><table><thead><tr><th>模版类型</th><th>模版内容</th><th>templateId</th></tr></thead><tbody><tr><td>通用验证码</td><td>验证码：<strong>code</strong>，<strong>minute</strong>分钟内有效，请勿泄漏于他人！</td><td>908e94ccf08b4476ba6c876d13f084ad</td></tr><tr><td>通用验证码</td><td>验证码：<strong>code</strong>，如非本人操作，请忽略本短信！</td><td>63698e3463bd490dbc3edc46a20c55f5</td></tr><tr><td>注册验证码</td><td>验证码：<strong>code</strong>，<strong>minute</strong>分钟内有效，您正在进行注册，若非本人操作，请勿泄露。</td><td>a09602b817fd47e59e7c6e603d3f088d</td></tr><tr><td>注册验证码</td><td>尊敬的用户，您的注册验证码为：<strong>code</strong>，请勿泄漏于他人！</td><td>305b8db49cdb4b18964ffe255188cb20</td></tr><tr><td>注册验证码</td><td>验证码：<strong>code</strong>，您正在进行注册操作，感谢您的支持！</td><td>47990cc6d3ca42e2bbaad2dd06371238</td></tr><tr><td>修改密码验证码</td><td>验证码：<strong>code</strong>，您正在进行密码重置操作，如非本人操作，请忽略本短信！</td><td>96d32c69f15a4fbf89410bdba185cbdc</td></tr><tr><td>修改密码验证码</td><td>验证码：<strong>code</strong>，<strong>minute</strong>分钟内有效，您正在进行密码重置操作，请妥善保管账户信息。</td><td>29833afb9ae94f21a3f66af908d54627</td></tr><tr><td>修改密码验证码</td><td>验证码：<strong>code</strong>，您正在尝试修改登录密码，请妥善保管账户信息。</td><td>8166a0ae27b7499fa8bdda1ed12a07bd</td></tr><tr><td>身份验证验证码</td><td>验证码：<strong>code</strong>，您正在进行身份验证，打死不要告诉别人哦！</td><td>d6d95d8fb03c4246b944abcc1ea7efd8</td></tr><tr><td>登录确认验证码</td><td>验证码：<strong>code</strong>，您正在登录，若非本人操作，请勿泄露。</td><td>f7e31e0d8c264a9c8d6e9756de806767</td></tr><tr><td>登录确认验证码</td><td>验证码：<strong>code</strong>，<strong>minute</strong>分钟内容有效，您正在登录，若非本人操作，请勿泄露。</td><td>02551a4313154fe4805794ca069d70bf</td></tr><tr><td>登录异常验证码</td><td>验证码：<strong>code</strong>，您正尝试异地登录，若非本人操作，请勿泄露。</td><td>dd7423a5749840f4ae6836ab31b7839e</td></tr><tr><td>登录异常验证码</td><td>验证码：<strong>code</strong>，<strong>minute</strong>分钟内容有效，您正尝试异地登录，若非本人操作，请勿泄露。</td><td>81e8a442ea904694a37d2cec6ea6f2bc</td></tr><tr><td>信息变更验证码</td><td>验证码：<strong>code</strong>，您正在尝试变更重要信息，请妥善保管账户信息。</td><td>9c16efaf248d41c59334e926634b4dc0</td></tr><tr><td>信息变更验证码</td><td>验证码：<strong>code</strong>，<strong>minute</strong>分钟内容有效，您正在尝试变更重要信息，请妥善保管账户信息。</td><td>ea66d14c664649a69a19a6b47ba028db</td></tr></tbody></table><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.2.5.png" alt="image-20220803191201175" tabindex="0" loading="lazy"><figcaption>image-20220803191201175</figcaption></figure><h5 id="_3、使用postman测试" tabindex="-1"><a class="header-anchor" href="#_3、使用postman测试" aria-hidden="true">#</a> 3、使用<code>Postman</code>测试</h5><p>复制给的调用地址<code>http(s)://gyytz.market.alicloudapi.com/sms/smsSend</code>，然后去掉<code>(s)</code>，再添加服务商指定的参数</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.1.png" alt="image-20220803193515856" tabindex="0" loading="lazy"><figcaption>image-20220803193515856</figcaption></figure><p>在请求<code>Header</code>中添加的<code>Authorization</code>字段；配置<code>Authorization</code>字段的值为<code>APPCODE ＋ 半角空格 ＋APPCODE值</code>。</p><p>格式如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>Authorization<span class="token punctuation">:</span>APPCODE AppCode值
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>Authorization<span class="token punctuation">:</span>APPCODE 3F2504E04F8911D39A0C0305E82C3301
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.2.png" alt="image-20220803193305242" tabindex="0" loading="lazy"><figcaption>image-20220803193305242</figcaption></figure><p>点击<code>Postman</code>里的<code>Headers</code>，<code>KEY</code>输入<code>Authorization</code>，<code>VALUE</code>输入自己购买的商品的<code>AppCode值</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.3.png" alt="image-20220803193638377" tabindex="0" loading="lazy"><figcaption>image-20220803193638377</figcaption></figure><p>我的服务商的请求方式要求是<code>Post</code>，因此修改为<code>Post</code>方式，然后点击<code>Send</code>，可以看到响应里面已经显示<code>成功</code>了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://gyytz.market.alicloudapi.com/sms/smsSend?mobile=13xxxxxxx86&amp;param=**code**:54321,**minute**:3&amp;smsSignId=2e65b1bb3d054466b82f0c9d125465e2&amp;templateId=908e94ccf08b4476ba6c876d13f084ad
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.4.png" alt="image-20220803193745906" tabindex="0" loading="lazy"><figcaption>image-20220803193745906</figcaption></figure><p>收到的短信：</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.5.png" alt="无标2题" style="zoom:33%;"><p>修改以下验证码和模板，然后重新点击<code>Send</code>，再次点击发送</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://gyytz.market.alicloudapi.com/sms/smsSend?mobile=13xxxxxxx86&amp;param=**code**:565331,**minute**:10&amp;smsSignId=2e65b1bb3d054466b82f0c9d125465e2&amp;templateId=305b8db49cdb4b18964ffe255188cb20
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应的内容：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{&quot;msg&quot;:&quot;成功&quot;,&quot;smsid&quot;:&quot;165952695412518315203379241&quot;,&quot;code&quot;:&quot;0&quot;,&quot;balance&quot;:&quot;18&quot;}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.6.png" alt="image-20220803194314348" tabindex="0" loading="lazy"><figcaption>image-20220803194314348</figcaption></figure><p>收到的短信：</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.1.3.7.png" alt="无标3题" style="zoom:33%;"><h4 id="_2、使用java测试短信接口" tabindex="-1"><a class="header-anchor" href="#_2、使用java测试短信接口" aria-hidden="true">#</a> 2、使用<code>java</code>测试短信接口</h4><h5 id="_1、查看文档" tabindex="-1"><a class="header-anchor" href="#_1、查看文档" aria-hidden="true">#</a> 1、查看文档</h5><p>查看服务商提供的<code>java</code>代码发送短信的示例代码</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.1.png" alt="image-20220803195021539" style="zoom:67%;"><p>其给的代码如下所示：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token string">&quot;https://gyytz.market.alicloudapi.com&quot;</span><span class="token punctuation">;</span>
	    <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">&quot;/sms/smsSend&quot;</span><span class="token punctuation">;</span>
	    <span class="token class-name">String</span> method <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">;</span>
	    <span class="token class-name">String</span> appcode <span class="token operator">=</span> <span class="token string">&quot;你自己的AppCode&quot;</span><span class="token punctuation">;</span>
	    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">//最后在header中的格式(中间是英文空格)为Authorization:APPCODE 83359fd73fe94948385f570e3c139105</span>
	    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPCODE &quot;</span> <span class="token operator">+</span> appcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> querys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mobile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**code**:12345,**minute**:5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;smsSignId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2e65b1bb3d054466b82f0c9d125465e2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;templateId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;908e94ccf08b4476ba6c876d13f084ad&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bodys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	    	<span class="token doc-comment comment">/**
	    	* 重要提示如下:
	    	* HttpUtils请从
	    	* https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/src/main/java/com/aliyun/api/gateway/demo/util/HttpUtils.java
	    	* 下载
	    	*
	    	* 相应的依赖请参照
	    	* https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/pom.xml
	    	*/</span>
	    	<span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> querys<span class="token punctuation">,</span> bodys<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    	<span class="token comment">//获取response的body</span>
	    	<span class="token comment">//System.out.println(EntityUtils.toString(response.getEntity()));</span>
	    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    	e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>正常返回示例</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">,</span> 
    <span class="token property">&quot;smsid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;16565614329364584123421&quot;</span><span class="token punctuation">,</span> <span class="token comment">//批次号，该值做为应答及状态报告中的消息ID一一对应。</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>失败返回示例</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token string">&quot;XXXX&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;错误提示内容&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ILLEGAL_WORDS&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;XX&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;XX&quot;</span><span class="token punctuation">]</span>    <span class="token comment">// 如有则显示</span>
     <span class="token comment">// 1、http响应状态码对照表请参考：https://help.aliyun.com/document_detail/43906.html；</span>
     <span class="token comment">// 2、如果次数用完会返回 403，Quota Exhausted，此时继续购买就可以；</span>
     <span class="token comment">// 3、如果appCode输入不正确会返回 403，Unauthorized；</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>错误码定义</p><table><thead><tr><th style="text-align:left;">错误码</th><th style="text-align:left;">错误信息</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">1204</td><td style="text-align:left;">签名未报备</td><td style="text-align:left;">请联系客服申请。</td></tr><tr><td style="text-align:left;">1205</td><td style="text-align:left;">签名不可用</td><td style="text-align:left;">签名一般为：公司名简称、产品名、商城名称、网站名称、APP名称、系统名称、公众号、小程序名称等等。不可以是纯数字、电话号码或者无意义的签名，如：【温馨提示】【测试】【你好】等；</td></tr><tr><td style="text-align:left;">1302</td><td style="text-align:left;">短信内容包含敏感词</td><td style="text-align:left;">短信内容包含敏感词</td></tr><tr><td style="text-align:left;">1304</td><td style="text-align:left;">短信内容过长</td><td style="text-align:left;">短信内容实际长度=短信签名+短信内容。（短信计费方式：70字内按1条计费，超出按67字每条计费；一个汉字、数字、字母、符号都算一个字；带变量短信按实际替换后的长度计费）</td></tr><tr><td style="text-align:left;">1320</td><td style="text-align:left;">模板ID不存在</td><td style="text-align:left;">请联系客服申请。</td></tr><tr><td style="text-align:left;">1403</td><td style="text-align:left;">手机号码不正确</td><td style="text-align:left;">手机号码不正确</td></tr><tr><td style="text-align:left;">1905</td><td style="text-align:left;">验证未通过</td><td style="text-align:left;">验证未通过</td></tr></tbody></table><h5 id="_2、测试" tabindex="-1"><a class="header-anchor" href="#_2、测试" aria-hidden="true">#</a> 2、测试</h5><p>根据提示下载<code>HttpUtils</code>工具类，在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty</code>包里新建<code>util</code>文件夹，在<code>util</code>文件夹里新建<code>HttpUtils</code>类，将提供的<code>HttpUtils</code>工具类粘贴到这里面</p>`,148),g=t(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.1.png" alt="image-20220803195801902" tabindex="0" loading="lazy"><figcaption>image-20220803195801902</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类里添加<code>sendSms</code>方法，对发送短信的接口进行测试</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token string">&quot;https://gyytz.market.alicloudapi.com&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">&quot;/sms/smsSend&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> method <span class="token operator">=</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> appcode <span class="token operator">=</span> <span class="token string">&quot;你自己的AppCode&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//最后在header中的格式(中间是英文空格)为Authorization:APPCODE 83359fd73fe94948385f570e3c139105</span>
    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPCODE &quot;</span> <span class="token operator">+</span> appcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> querys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;要发送的手机号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**code**:12345,**minute**:5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;smsSignId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2e65b1bb3d054466b82f0c9d125465e2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;templateId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;908e94ccf08b4476ba6c876d13f084ad&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bodys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 重要提示如下:
         * HttpUtils请从
         * https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/src/main/java/com/aliyun/api/gateway/demo/util/HttpUtils.java
         * 下载
         *
         * 相应的依赖请参照
         * https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/pom.xml
         */</span>
        <span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> querys<span class="token punctuation">,</span> bodys<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取response的body</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.2.png" alt="image-20220803200305027" tabindex="0" loading="lazy"><figcaption>image-20220803200305027</figcaption></figure><p>测试结果如下，可以看出来把所有的连接信息都显示出来了，而不是想要的<code>json</code>数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> <span class="token constant">OK</span> <span class="token punctuation">[</span><span class="token class-name">Date</span><span class="token operator">:</span> <span class="token class-name">Wed</span><span class="token punctuation">,</span> <span class="token number">03</span> <span class="token class-name">Aug</span> <span class="token number">2022</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">28</span> <span class="token constant">GMT</span><span class="token punctuation">,</span> <span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span>charset<span class="token operator">=</span>utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Length</span><span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive<span class="token punctuation">,</span> <span class="token class-name">Keep</span><span class="token operator">-</span><span class="token class-name">Alive</span><span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Allow</span><span class="token operator">-</span><span class="token class-name">Headers</span><span class="token operator">:</span> <span class="token class-name">Origin</span><span class="token punctuation">,</span> <span class="token class-name">Accept</span><span class="token punctuation">,</span> x<span class="token operator">-</span>auth<span class="token operator">-</span>token<span class="token punctuation">,</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Request</span><span class="token operator">-</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Request</span><span class="token operator">-</span><span class="token class-name">Headers</span><span class="token punctuation">,</span> <span class="token class-name">Server</span><span class="token operator">:</span> <span class="token class-name">Jetty</span><span class="token punctuation">(</span><span class="token number">9.4</span><span class="token number">.9</span><span class="token punctuation">.</span>v20180320<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Ca</span><span class="token operator">-</span><span class="token class-name">Request</span><span class="token operator">-</span><span class="token class-name">Id</span><span class="token operator">:</span> <span class="token constant">E5D22290</span><span class="token operator">-</span><span class="token constant">F3DF</span><span class="token operator">-</span><span class="token number">4827</span><span class="token operator">-</span><span class="token number">9D</span><span class="token constant">EF</span><span class="token operator">-</span><span class="token number">27</span><span class="token constant">BA89272C6F</span><span class="token punctuation">,</span> <span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Disposition</span><span class="token operator">:</span> inline<span class="token punctuation">;</span>filename<span class="token operator">=</span>f<span class="token punctuation">.</span>txt<span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Allow</span><span class="token operator">-</span><span class="token class-name">Origin</span><span class="token operator">:</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Ca</span><span class="token operator">-</span><span class="token class-name">Market</span><span class="token operator">-</span><span class="token class-name">Billing</span><span class="token operator">-</span><span class="token class-name">Result</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Allow</span><span class="token operator">-</span><span class="token class-name">Credentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Accept</span><span class="token operator">-</span><span class="token class-name">Charset</span><span class="token operator">:</span> big5<span class="token punctuation">,</span> big5<span class="token operator">-</span>hkscs<span class="token punctuation">,</span> cesu<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> euc<span class="token operator">-</span>jp<span class="token punctuation">,</span> euc<span class="token operator">-</span>kr<span class="token punctuation">,</span> gb18030<span class="token punctuation">,</span> gb2312<span class="token punctuation">,</span> gbk<span class="token punctuation">,</span> ibm<span class="token operator">-</span>thai<span class="token punctuation">,</span> ibm00858<span class="token punctuation">,</span> ibm01140<span class="token punctuation">,</span> ibm01141<span class="token punctuation">,</span> ibm01142<span class="token punctuation">,</span> ibm01143<span class="token punctuation">,</span> ibm01144<span class="token punctuation">,</span> ibm01145<span class="token punctuation">,</span> ibm01146<span class="token punctuation">,</span> ibm01147<span class="token punctuation">,</span> ibm01148<span class="token punctuation">,</span> ibm01149<span class="token punctuation">,</span> ibm037<span class="token punctuation">,</span> ibm1026<span class="token punctuation">,</span> ibm1047<span class="token punctuation">,</span> ibm273<span class="token punctuation">,</span> ibm277<span class="token punctuation">,</span> ibm278<span class="token punctuation">,</span> ibm280<span class="token punctuation">,</span> ibm284<span class="token punctuation">,</span> ibm285<span class="token punctuation">,</span> ibm290<span class="token punctuation">,</span> ibm297<span class="token punctuation">,</span> ibm420<span class="token punctuation">,</span> ibm424<span class="token punctuation">,</span> ibm437<span class="token punctuation">,</span> ibm500<span class="token punctuation">,</span> ibm775<span class="token punctuation">,</span> ibm850<span class="token punctuation">,</span> ibm852<span class="token punctuation">,</span> ibm855<span class="token punctuation">,</span> ibm857<span class="token punctuation">,</span> ibm860<span class="token punctuation">,</span> ibm861<span class="token punctuation">,</span> ibm862<span class="token punctuation">,</span> ibm863<span class="token punctuation">,</span> ibm864<span class="token punctuation">,</span> ibm865<span class="token punctuation">,</span> ibm866<span class="token punctuation">,</span> ibm868<span class="token punctuation">,</span> ibm869<span class="token punctuation">,</span> ibm870<span class="token punctuation">,</span> ibm871<span class="token punctuation">,</span> ibm918<span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">2022</span><span class="token operator">-</span>cn<span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">2022</span><span class="token operator">-</span>jp<span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">2022</span><span class="token operator">-</span>jp<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">2022</span><span class="token operator">-</span>kr<span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">,</span> jis_x0201<span class="token punctuation">,</span> jis_x0212<span class="token operator">-</span><span class="token number">1990</span><span class="token punctuation">,</span> koi8<span class="token operator">-</span>r<span class="token punctuation">,</span> koi8<span class="token operator">-</span>u<span class="token punctuation">,</span> shift_jis<span class="token punctuation">,</span> tis<span class="token operator">-</span><span class="token number">620</span><span class="token punctuation">,</span> us<span class="token operator">-</span>ascii<span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">16</span>be<span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">16l</span>e<span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">32</span>be<span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">32l</span>e<span class="token punctuation">,</span> utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1250</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1251</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1252</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1253</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1254</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1255</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1256</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1257</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">1258</span><span class="token punctuation">,</span> windows<span class="token operator">-</span><span class="token number">31</span>j<span class="token punctuation">,</span> x<span class="token operator">-</span>big5<span class="token operator">-</span>hkscs<span class="token operator">-</span><span class="token number">2001</span><span class="token punctuation">,</span> x<span class="token operator">-</span>big5<span class="token operator">-</span>solaris<span class="token punctuation">,</span> x<span class="token operator">-</span>compound_text<span class="token punctuation">,</span> x<span class="token operator">-</span>euc<span class="token operator">-</span>jp<span class="token operator">-</span>linux<span class="token punctuation">,</span> x<span class="token operator">-</span>euc<span class="token operator">-</span>tw<span class="token punctuation">,</span> x<span class="token operator">-</span>eucjp<span class="token operator">-</span><span class="token keyword">open</span><span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1006<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1025<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1046<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1097<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1098<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1112<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1122<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1123<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1124<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1166<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1364<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1381<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm1383<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm300<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm33722<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm737<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm833<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm834<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm856<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm874<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm875<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm921<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm922<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm930<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm933<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm935<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm937<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm939<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm942<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm942c<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm943<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm943c<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm948<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm949<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm949c<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm950<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm964<span class="token punctuation">,</span> x<span class="token operator">-</span>ibm970<span class="token punctuation">,</span> x<span class="token operator">-</span>iscii91<span class="token punctuation">,</span> x<span class="token operator">-</span>iso<span class="token operator">-</span><span class="token number">2022</span><span class="token operator">-</span>cn<span class="token operator">-</span>cns<span class="token punctuation">,</span> x<span class="token operator">-</span>iso<span class="token operator">-</span><span class="token number">2022</span><span class="token operator">-</span>cn<span class="token operator">-</span>gb<span class="token punctuation">,</span> x<span class="token operator">-</span>iso<span class="token operator">-</span><span class="token number">8859</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">,</span> x<span class="token operator">-</span>jis0208<span class="token punctuation">,</span> x<span class="token operator">-</span>jisautodetect<span class="token punctuation">,</span> x<span class="token operator">-</span>johab<span class="token punctuation">,</span> x<span class="token operator">-</span>macarabic<span class="token punctuation">,</span> x<span class="token operator">-</span>maccentraleurope<span class="token punctuation">,</span> x<span class="token operator">-</span>maccroatian<span class="token punctuation">,</span> x<span class="token operator">-</span>maccyrillic<span class="token punctuation">,</span> x<span class="token operator">-</span>macdingbat<span class="token punctuation">,</span> x<span class="token operator">-</span>macgreek<span class="token punctuation">,</span> x<span class="token operator">-</span>machebrew<span class="token punctuation">,</span> x<span class="token operator">-</span>maciceland<span class="token punctuation">,</span> x<span class="token operator">-</span>macroman<span class="token punctuation">,</span> x<span class="token operator">-</span>macromania<span class="token punctuation">,</span> x<span class="token operator">-</span>macsymbol<span class="token punctuation">,</span> x<span class="token operator">-</span>macthai<span class="token punctuation">,</span> x<span class="token operator">-</span>macturkish<span class="token punctuation">,</span> x<span class="token operator">-</span>macukraine<span class="token punctuation">,</span> x<span class="token operator">-</span>ms932_0213<span class="token punctuation">,</span> x<span class="token operator">-</span>ms950<span class="token operator">-</span>hkscs<span class="token punctuation">,</span> x<span class="token operator">-</span>ms950<span class="token operator">-</span>hkscs<span class="token operator">-</span>xp<span class="token punctuation">,</span> x<span class="token operator">-</span>mswin<span class="token operator">-</span><span class="token number">936</span><span class="token punctuation">,</span> x<span class="token operator">-</span>pck<span class="token punctuation">,</span> x<span class="token operator">-</span>sjis_0213<span class="token punctuation">,</span> x<span class="token operator">-</span>utf<span class="token operator">-</span><span class="token number">16l</span>e<span class="token operator">-</span>bom<span class="token punctuation">,</span> x<span class="token operator">-</span>utf<span class="token operator">-</span><span class="token number">32</span>be<span class="token operator">-</span>bom<span class="token punctuation">,</span> x<span class="token operator">-</span>utf<span class="token operator">-</span><span class="token number">32l</span>e<span class="token operator">-</span>bom<span class="token punctuation">,</span> x<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">50220</span><span class="token punctuation">,</span> x<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">50221</span><span class="token punctuation">,</span> x<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">874</span><span class="token punctuation">,</span> x<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">949</span><span class="token punctuation">,</span> x<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token number">950</span><span class="token punctuation">,</span> x<span class="token operator">-</span>windows<span class="token operator">-</span>iso2022jp<span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Allow</span><span class="token operator">-</span><span class="token class-name">Methods</span><span class="token operator">:</span> <span class="token constant">POST</span><span class="token punctuation">,</span><span class="token constant">GET</span><span class="token punctuation">,</span><span class="token constant">OPTIONS</span><span class="token punctuation">,</span> <span class="token class-name">Access</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">-</span><span class="token class-name">Max</span><span class="token operator">-</span><span class="token class-name">Age</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span></span>BasicManagedEntity</span><span class="token annotation punctuation">@335f5c69</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.3.png" alt="image-20220803200411711" tabindex="0" loading="lazy"><figcaption>image-20220803200411711</figcaption></figure><p>将<code> System.out.println(response.toString());</code>修改为<code>System.out.println(response.getEntity());</code>，并在其上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.4.png" alt="image-20220803200925114" tabindex="0" loading="lazy"><figcaption>image-20220803200925114</figcaption></figure><p>以<code>debug</code>方式执行<code>sendSms</code>方法方法们可以看到请求参数都正常封装了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.5.png" alt="image-20220803201512696" tabindex="0" loading="lazy"><figcaption>image-20220803201512696</figcaption></figure><p>获取到的response也都正常封装了，但是还是没有获取到<code>json</code>数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.6.png" alt="image-20220803201238641" tabindex="0" loading="lazy"><figcaption>image-20220803201238641</figcaption></figure><p>后来发现取消<code>System.out.println(EntityUtils.toString(response.getEntity()));</code>的注释就行了，提供的代码已经写好获取<code>json</code>数据的方法了😥(只不过此手机号单日使用上限已经到了)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.7.png" alt="image-20220803201712329" tabindex="0" loading="lazy"><figcaption>image-20220803201712329</figcaption></figure><p>第二天再次测试，可以看到已经正确封装响应的<code>json</code>数据了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{&quot;msg&quot;:&quot;成功&quot;,&quot;smsid&quot;:&quot;165957496829318315203372267&quot;,&quot;code&quot;:&quot;0&quot;,&quot;balance&quot;:&quot;13&quot;}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.2.2.8.png" alt="image-20220804090324284" tabindex="0" loading="lazy"><figcaption>image-20220804090324284</figcaption></figure><h4 id="_3、添加短信注册业务" tabindex="-1"><a class="header-anchor" href="#_3、添加短信注册业务" aria-hidden="true">#</a> 3、添加短信注册业务</h4><h5 id="_1、编写短信业务代码" tabindex="-1"><a class="header-anchor" href="#_1、编写短信业务代码" aria-hidden="true">#</a> 1、编写短信业务代码</h5><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty</code>包里新建<code>component</code>文件夹，在<code>component</code>文件夹里添加<code>SmsComponent</code>类，在该类里添加发送短信短信的方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>thirdparty<span class="token punctuation">.</span>component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>thirdparty<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HttpUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">EntityUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/3
 * @Description:
 */</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.cloud.alicloud.sms&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsComponent</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> method<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appcode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> smsSignId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> templateId<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最后在header中的格式(中间是英文空格)为Authorization:APPCODE 83359fd73fe94948385f570e3c139105</span>
        headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPCODE &quot;</span> <span class="token operator">+</span> appcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> querys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;param&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**code**:&quot;</span><span class="token operator">+</span>code<span class="token operator">+</span><span class="token string">&quot;,**minute**:5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;smsSignId&quot;</span><span class="token punctuation">,</span> smsSignId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        querys<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;templateId&quot;</span><span class="token punctuation">,</span> templateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bodys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpResponse</span> response <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path<span class="token punctuation">,</span> method<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> querys<span class="token punctuation">,</span> bodys<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//System.out.println(response.toString());</span>
            <span class="token comment">//获取response的body</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.1.1.png" alt="image-20220803204051612" tabindex="0" loading="lazy"><figcaption>image-20220803204051612</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>pom.xml</code>文件里添加<code>注释处理器</code>，使用idea添加自定义配置会有提示</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--添加注释处理器(使用idea添加自定义配置会有提示)--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.1.2.png" alt="image-20220803203214363" tabindex="0" loading="lazy"><figcaption>image-20220803203214363</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加如下配置，用于对短信服务的配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">alicloud</span><span class="token punctuation">:</span>
      <span class="token key atrule">sms</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gyytz.market.alicloudapi.com
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /sms/smsSend
        <span class="token key atrule">method</span><span class="token punctuation">:</span> POST
        <span class="token key atrule">appcode</span><span class="token punctuation">:</span> 9448945d840d4a6493c905c145fb0a83
        <span class="token key atrule">sms-signId</span><span class="token punctuation">:</span> 2e65b1bb3d054466b82f0c9d125465e2
        <span class="token key atrule">templateId</span><span class="token punctuation">:</span> 908e94ccf08b4476ba6c876d13f084ad
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.1.3.png" alt="image-20220803205817201" tabindex="0" loading="lazy"><figcaption>image-20220803205817201</figcaption></figure><h5 id="_2、测试-1" tabindex="-1"><a class="header-anchor" href="#_2、测试-1" aria-hidden="true">#</a> 2、测试</h5><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类里添加如下测试方法，用来对刚写的短信业务代码进行测试</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">SmsComponent</span> smsComponent<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    smsComponent<span class="token punctuation">.</span><span class="token function">sendSms</span><span class="token punctuation">(</span><span class="token string">&quot;13235691886&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;432567&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行该测试方法报了空指针异常</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>java.lang.NullPointerException
	at com.atguigu.gulimall.thirdparty.util.HttpUtils.wrapClient<span class="token punctuation">(</span>HttpUtils.java:283<span class="token punctuation">)</span>
	at com.atguigu.gulimall.thirdparty.util.HttpUtils.doPost<span class="token punctuation">(</span>HttpUtils.java:82<span class="token punctuation">)</span>
	at com.atguigu.gulimall.thirdparty.component.SmsComponent.sendSms<span class="token punctuation">(</span>SmsComponent.java:40<span class="token punctuation">)</span>
	at com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests.testSendCode<span class="token punctuation">(</span>GulimallThirdPartyApplicationTests.java:83<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.1.png" alt="image-20220803205400993" tabindex="0" loading="lazy"><figcaption>image-20220803205400993</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.SmsComponent</code>类的<code>sendSms</code>方法的第一行上打断点，以<code>debug</code>方式启动<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类的<code>testSendCode</code>方法</p><p>可以看到这些配置类里的配置都没有获取到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.2.png" alt="image-20220803205527093" tabindex="0" loading="lazy"><figcaption>image-20220803205527093</figcaption></figure><p>在配置文件里，写以<code>spring.cloud.alicloud.sms</code>为前缀的配置会有其他不是刚刚写的配置类里的字段的提示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.3.png" alt="image-20220803205847105" tabindex="0" loading="lazy"><figcaption>image-20220803205847105</figcaption></figure><p>随便选择一个配置属性，然后按住<code>ctrl</code>并点击鼠标左键，可以看到<code>com.alibaba.alicloud.context.sms.SmsProperties</code>类的前缀也为<code>spring.cloud.alicloud.sms</code>，和我们的前缀一样</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.4.png" alt="image-20220803205711848" tabindex="0" loading="lazy"><figcaption>image-20220803205711848</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.SmsComponent</code>类里，把<code>@ConfigurationProperties(prefix = &quot;spring.cloud.alicloud.sms&quot;)</code>修改为<code>@ConfigurationProperties(prefix = &quot;spring.cloud.alicloud.mysms&quot;)</code>，使配置文件的前缀为<code>spring.cloud.alicloud.mysms</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.5.png" alt="image-20220803210502786" tabindex="0" loading="lazy"><figcaption>image-20220803210502786</figcaption></figure><p>修改<code>gulimall-third-party</code>模块的<code>src/main/resources/application.yml</code>文件，把<code>sms</code>修改为<code>mysms</code>，使其前缀为<code>spring.cloud.alicloud.mysms</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.6.png" alt="image-20220803210431739" tabindex="0" loading="lazy"><figcaption>image-20220803210431739</figcaption></figure><p>再次以<code>debug</code>方式启动<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类的<code>testSendCode</code>方法，可以看到这些属性还是为<code>null</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.7.png" alt="image-20220803210355776" tabindex="0" loading="lazy"><figcaption>image-20220803210355776</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.SmsComponent</code>类里的<code>private String host;</code>字段上添加如下注解，指定注入的配置</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Value(&quot;spring.cloud.alicloud.mysms.host&quot;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到此时<code>hsot</code>注入成功了，因此配置文件里的配置没有问题，因此我就想到是没有<code>set</code>方法使得容器无法自动注入</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.8.png" alt="image-20220803210756368" tabindex="0" loading="lazy"><figcaption>image-20220803210756368</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.SmsComponent</code>类上添加<code>@Data</code>注解，再次以<code>debug</code>方式启动<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类的<code>testSendCode</code>方法，可以看到这些属性都已经注入成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.9.png" alt="image-20220803211319559" tabindex="0" loading="lazy"><figcaption>image-20220803211319559</figcaption></figure><p>然后点击<code>Resume Program F9</code>，执行完该方法，可以看到控制台已经显示成功的<code>json</code>数据了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{&quot;msg&quot;:&quot;成功&quot;,&quot;smsid&quot;:&quot;165957510676018315203379080&quot;,&quot;code&quot;:&quot;0&quot;,&quot;balance&quot;:&quot;12&quot;}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.10.png" alt="image-20220804090604010" tabindex="0" loading="lazy"><figcaption>image-20220804090604010</figcaption></figure><p>注意：直接使用<code>@ConfigurationProperties</code>注解而不指定具体的类，该注解并不会生效</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.3.2.11.png" alt="image-20220803211138228" tabindex="0" loading="lazy"><figcaption>image-20220803211138228</figcaption></figure><p><code>@EnableConfigurationProperties</code>的作用是把<code>springboot</code>配置文件中的值与我们的<code>xxxProperties.java</code>的属性进行绑定，需要配合<code>@ConfigurationProperties</code>使用。</p><p>首先我想说的是，不使用<code>@EnableConfigurationProperties</code>能否进行属性绑定呢？答案是肯定的！我们只需要给<code>xxxProperties.java</code>加上<code>@Component</code>注解，把它放到容器中，即可实现属性绑定。</p><h4 id="_4、邮件服务简单测试" tabindex="-1"><a class="header-anchor" href="#_4、邮件服务简单测试" aria-hidden="true">#</a> 4、邮件服务简单测试</h4>`,62),v={href:"https://blog.csdn.net/qq_25015861/article/details/121416826",target:"_blank",rel:"noopener noreferrer"},b=t(`<p>若想使用短信服务，需要开启<code>POP3/SMTP服务</code>(邮件发送与接收协议，<code>邮件发送方</code>发送到<code>发送方的邮件服务器</code>和<code>发送方的邮件服务器</code>与<code>接收方邮件服务器</code>通讯使用<code>POP3</code>协议，<code>接收方邮件服务器</code>与<code>邮件接收方</code>通讯使用<code>SMTP</code>协议)</p><h5 id="_1、开启邮件服务" tabindex="-1"><a class="header-anchor" href="#_1、开启邮件服务" aria-hidden="true">#</a> 1、开启邮件服务</h5><p>打开<code>QQ邮箱</code>，点击<code>设置</code>里的<code>账户</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.1.1.png" alt="image-20220803212054406" tabindex="0" loading="lazy"><figcaption>image-20220803212054406</figcaption></figure><p>往下滑，找到<code>开启服务</code>里的<code>POP3/SMTP服务</code>，点击<code>开启</code>按钮，然后根据要求，给指定的电话号码发送短信</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.1.2.png" alt="image-20220803212047859" tabindex="0" loading="lazy"><figcaption>image-20220803212047859</figcaption></figure><p>给指定的电话号码发送短信后，即可获得一个<code>授权码</code>，复制该授权码</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.1.3.png" alt="image-20220803212101247" tabindex="0" loading="lazy"><figcaption>image-20220803212101247</figcaption></figure><h5 id="_2、添加依赖-1" tabindex="-1"><a class="header-anchor" href="#_2、添加依赖-1" aria-hidden="true">#</a> 2、添加依赖</h5><p>在<code>gulimall-third-party</code>模块的<code>pom.xml</code>文件里添加如下依赖,引入邮件服务</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--邮件服务--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-mail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.2.1.png" alt="image-20220803212334978" tabindex="0" loading="lazy"><figcaption>image-20220803212334978</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下配置，输入自己的<code>QQ邮箱</code>与<code>授权码</code>(注：不同邮箱的<code>spring.mail.host</code>不同)</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.mail.username</span><span class="token punctuation">=</span><span class="token value attr-value">你的QQ邮箱(xxxxx@qq.com)</span>
<span class="token key attr-name">spring.mail.password</span><span class="token punctuation">=</span><span class="token value attr-value">授权码</span>
<span class="token key attr-name">spring.mail.host</span><span class="token punctuation">=</span><span class="token value attr-value">smtp.qq.com</span>
<span class="token key attr-name">spring.mail.properties.mail.smtp.ssl.enable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">spring.mail.default-encoding</span><span class="token punctuation">=</span><span class="token value attr-value">UTF-8</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8085</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.2.2.png" alt="image-20220803212546251" tabindex="0" loading="lazy"><figcaption>image-20220803212546251</figcaption></figure><h5 id="_3、测试" tabindex="-1"><a class="header-anchor" href="#_3、测试" aria-hidden="true">#</a> 3、测试</h5><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类里进行邮箱服务的简单测试</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mailTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//默认发送一次</span>
    <span class="token class-name">MimeMessage</span> mimeMessage <span class="token operator">=</span> mailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MimeMessageHelper</span> helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">--</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> codeNum <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//自动生成验证码</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> num <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> uppercase <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> lowercase <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">97</span><span class="token punctuation">;</span>
            code<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">;</span>
            code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uppercase<span class="token punctuation">;</span>
            code<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> lowercase<span class="token punctuation">;</span>
            codeNum <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> code<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>codeNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//标题</span>
        helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">&quot;您的验证码为：&quot;</span> <span class="token operator">+</span> codeNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//内容</span>
        helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">&quot;您好！,您的验证码为：&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;&lt;h2&gt;&quot;</span> <span class="token operator">+</span> codeNum <span class="token operator">+</span> <span class="token string">&quot;&lt;/h2&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;千万不能告诉别人哦！&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//邮件接收者</span>
        helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token string">&quot;1966447213@qq.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//邮件发送者，必须和配置文件里的一样，不然授权码匹配不上</span>
        helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token string">&quot;447398775@qq.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.3.1.png" alt="image-20220803214739127" tabindex="0" loading="lazy"><figcaption>image-20220803214739127</figcaption></figure><p>此时打开接收者的<code>QQ邮箱</code>，可以看到已经收到邮件了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.4.3.2.png" alt="image-20220803214723363" tabindex="0" loading="lazy"><figcaption>image-20220803214723363</figcaption></figure><h4 id="_5、添加邮件服务" tabindex="-1"><a class="header-anchor" href="#_5、添加邮件服务" aria-hidden="true">#</a> 5、添加邮件服务</h4><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component</code>包里新建<code>MailComponent</code>类，用于邮件发送</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>thirdparty<span class="token punctuation">.</span>component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>javamail<span class="token punctuation">.</span></span><span class="token class-name">JavaMailSenderImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>javamail<span class="token punctuation">.</span></span><span class="token class-name">MimeMessageHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span></span><span class="token class-name">MessagingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>internet<span class="token punctuation">.</span></span><span class="token class-name">MimeMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/3
 * @Description:
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailComponent</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">JavaMailSenderImpl</span> mailSender<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;spring.mail.username&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> username<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> fromMail<span class="token punctuation">,</span><span class="token class-name">String</span> targetMail<span class="token punctuation">,</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">MimeMessage</span> mimeMessage <span class="token operator">=</span> mailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> codeNum <span class="token operator">=</span> <span class="token function">generateVerificationCode</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>codeNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//标题</span>
        helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">&quot;您的验证码为：&quot;</span> <span class="token operator">+</span> codeNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//内容</span>
        helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">&quot;您好！,您的验证码为：&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;&lt;h2&gt;&quot;</span> <span class="token operator">+</span> codeNum <span class="token operator">+</span> <span class="token string">&quot;&lt;/h2&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;千万不能告诉别人哦！&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//邮件发送者，必须和配置文件里的一样，不然授权码匹配不上</span>
        helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>fromMail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//邮件接收者</span>
        helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>targetMail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;邮件发送成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> targetMail<span class="token punctuation">,</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>targetMail<span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> targetMail<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>targetMail<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 生成指定数目的验证码
     * <span class="token keyword">@param</span> <span class="token parameter">length</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateVerificationCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> codeNum <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//自动生成验证码</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> num <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> uppercase <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> lowercase <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">97</span><span class="token punctuation">;</span>
            code<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">;</span>
            code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> uppercase<span class="token punctuation">;</span>
            code<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> lowercase<span class="token punctuation">;</span>
            codeNum <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> code<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> codeNum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.5.1.png" alt="image-20220803215137800" tabindex="0" loading="lazy"><figcaption>image-20220803215137800</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplication</code>测试类了添加如下代码，测试邮件发送服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MailComponent</span> mailComponent<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMailTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{</span>
    mailComponent<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token string">&quot;2xxxxxxxx5@qq.com&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，执行报错了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.5.2.png" alt="image-20220803215423530" tabindex="0" loading="lazy"><figcaption>image-20220803215423530</figcaption></figure><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.MailComponent</code>类的<code>sendMail(java.lang.String, java.lang.String, int)</code>方法的第一行打断点，然后以<code>debug</code>方式运行<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplication</code>测试类的<code>sendMailTest</code>方法，可以看到<code>MailComponent</code>类的<code>username</code>字段直接注入了<code>spring.mail.username</code>，忘记加<code>\${}</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.5.3.png" alt="image-20220803215347004" tabindex="0" loading="lazy"><figcaption>image-20220803215347004</figcaption></figure><p>修改<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.MailComponent</code>类的<code>username</code>方法上的<code>@Value</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.mail.username}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> username<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.5.4.png" alt="image-20220803215813519" tabindex="0" loading="lazy"><figcaption>image-20220803215813519</figcaption></figure><p>再次执行<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplication</code>测试类的<code>sendMailTest</code>方法，这次显示邮件发送成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.5.5.png" alt="image-20220803215745860" tabindex="0" loading="lazy"><figcaption>image-20220803215745860</figcaption></figure><p>此时打开接收者的<code>QQ邮箱</code>，可以看到已经收到邮件了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.5.6.png" alt="image-20220803215711630" tabindex="0" loading="lazy"><figcaption>image-20220803215711630</figcaption></figure><h4 id="_6、远程调用短信服务" tabindex="-1"><a class="header-anchor" href="#_6、远程调用短信服务" aria-hidden="true">#</a> 6、远程调用短信服务</h4><h5 id="_1、远程调用third-party模块" tabindex="-1"><a class="header-anchor" href="#_1、远程调用third-party模块" aria-hidden="true">#</a> 1、远程调用<code>third-party</code>模块</h5><p>在<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.controller</code>包里新建<code>SmsSendController</code>类，用于短信发送</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>thirdparty<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>thirdparty<span class="token punctuation">.</span>component<span class="token punctuation">.</span></span><span class="token class-name">SmsComponent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/4
 * @Description:
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sms&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsSendController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">SmsComponent</span> smsComponent<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sendCode&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
        smsComponent<span class="token punctuation">.</span><span class="token function">sendSms</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.1.1.png" alt="image-20220804092409452" tabindex="0" loading="lazy"><figcaption>image-20220804092409452</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类里添加<code>sendCode</code>方法，用于处理页面的<code>发送验证码</code>请求</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.1.2.png" alt="image-20220804092128863" tabindex="0" loading="lazy"><figcaption>image-20220804092128863</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth</code>包下新建<code>feign</code>文件夹，在<code>feign</code>文件夹里新建<code>ThirdPartyFeignService</code>接口，在这个接口里调用<code>gulimall-third-party</code>模块的短信接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/4
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-third-party&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ThirdPartyFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.1.3.png" alt="image-20220804092504819" tabindex="0" loading="lazy"><figcaption>image-20220804092504819</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类里修改<code>sendCode</code>方法，调用远程<code>gulimall-third-party</code>服务的短信接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ThirdPartyFeignService</span> thirdPartyFeignService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 给指定手机号发送验证码
 * <span class="token keyword">@param</span> <span class="token parameter">phone</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thirdPartyFeignService<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.1.4.png" alt="image-20220804093226524" tabindex="0" loading="lazy"><figcaption>image-20220804093226524</figcaption></figure><h5 id="_2、前端编写发送短信请求" tabindex="-1"><a class="header-anchor" href="#_2、前端编写发送短信请求" aria-hidden="true">#</a> 2、前端编写发送短信请求</h5><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里的<code>建议使用常用手机</code>的<code>&lt;input&gt;</code>标签上添加一个<code>id</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;phone&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;phoneNum&quot;</span> maxlength<span class="token operator">=</span><span class="token string">&quot;20&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> placeholder<span class="token operator">=</span><span class="token string">&quot;建议使用常用手机&quot;</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.2.1.png" alt="image-20220804093353260" tabindex="0" loading="lazy"><figcaption>image-20220804093353260</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件的<code>&lt;script&gt;</code>标签里添加如下方法，用于向后端请求短信验证码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 发送验证码</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//正在倒计时。</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         <span class="token comment">// 给指定手机号发送验证码</span>
         $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode?phone=&quot;</span><span class="token operator">+</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#phoneNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;发送验证码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> str <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token string">&quot;s 后再次发送&quot;</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token string">&quot;timeoutChangeStyle()&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      num<span class="token operator">--</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.2.2.png" alt="image-20220804102603740" tabindex="0" loading="lazy"><figcaption>image-20220804102603740</figcaption></figure><h5 id="_3、测试-1" tabindex="-1"><a class="header-anchor" href="#_3、测试-1" aria-hidden="true">#</a> 3、测试</h5><p>重启<code>GulimallThirdPartyApplication</code>服务和<code>GulimallAuthServerApplication</code>服务，在<code>http://auth.gulimall.com/reg.html</code>页面里点击发送验证码，可以看到请求已经发送出去了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.3.1.png" alt="image-20220804094540385" tabindex="0" loading="lazy"><figcaption>image-20220804094540385</figcaption></figure><p>打开<code>GulimallAuthServerApplication</code>服务的控制台，可以看到随机验证码已经生成成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.3.2.png" alt="image-20220804094624295" tabindex="0" loading="lazy"><figcaption>image-20220804094624295</figcaption></figure><p>切换到<code>GulimallThirdPartyApplication</code>服务的控制台，已经显示短信发送成功的<code>json</code>数据了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;成功&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;smsid&quot;</span><span class="token operator">:</span><span class="token string">&quot;165957748665518315203378720&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token string">&quot;11&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.3.3.png" alt="image-20220804094619237" tabindex="0" loading="lazy"><figcaption>image-20220804094619237</figcaption></figure><h5 id="_4、优化短信接口" tabindex="-1"><a class="header-anchor" href="#_4、优化短信接口" aria-hidden="true">#</a> 4、优化短信接口</h5><p>由于后端没有时长限制，别人获取到该发送短信的接口后，可能会不断地向该接口发送请求，导致消耗资源（前端也暴露了短信接口，也容易获取到短信接口。其次如果<code>发送验证码</code>在倒计时，用户刷新页面又可以点击<code>发送送验证码</code>了）因此可以把<code>用途+发送验证码的手机</code>存入<code>redis</code>，并设置过期时间，如果<code>reids</code>又该信息就不让注册</p><p>在<code>gulimall-auth-server</code>模块的<code>pom.xml</code>文件里引入<code>redis</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.1.png" alt="image-20220804102816791" tabindex="0" loading="lazy"><figcaption>image-20220804102816791</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里配置主机地址和端口</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
<span class="token key attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.2.png" alt="image-20220804102952554" tabindex="0" loading="lazy"><figcaption>image-20220804102952554</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.constant</code>包下新建<code>auth</code>文件夹，在<code>auth</code>文件夹里新建<code>AuthServerConstant</code>类，在里面存放<code>注册账户的短信验证码前缀</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>auth</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/4
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthServerConstant</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 短信验证码前缀
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SMS_CODE_CACHE_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;sms:code:&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.3.png" alt="image-20220804103452075" tabindex="0" loading="lazy"><figcaption>image-20220804103452075</figcaption></figure><p>并在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加<code>同一手机号获取验证码频率太高错误</code>的类型枚举</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 同一手机号获取验证码频率太高
 */</span>
<span class="token function">SMS_CODE_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">10002</span><span class="token punctuation">,</span><span class="token string">&quot;验证码获取频率太高，请稍后再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.4.png" alt="image-20220804104928293" tabindex="0" loading="lazy"><figcaption>image-20220804104928293</figcaption></figure><p>修改<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.component.SmsComponent</code>类的<code>sendSms</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 给指定手机号发送验证码
 * <span class="token keyword">@param</span> <span class="token parameter">phone</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> phone<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//TODO 接口防刷</span>
    <span class="token class-name">String</span> redisCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">SMS_CODE_CACHE_PREFIX</span> <span class="token operator">+</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果redis有该手机号的验证码，如果有则判断是否过了60s。如果没有证明没有发送过验证码，直接发送验证码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> redisCode<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//同一手机号获取验证码频率太高</span>
                <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">SMS_CODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在code后添加当前系统时间，判断是否过了一分钟，防止同一个phone在60秒内再次发送验证码(用户刷新页面、拿接口直接发)</span>
    <span class="token class-name">String</span> redisValue <span class="token operator">=</span> code <span class="token operator">+</span><span class="token string">&quot;_&quot;</span> <span class="token operator">+</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//redis中缓存验证码再次校验  sms:code:17512080612 -&gt; 45678_系统时间</span>

    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">SMS_CODE_CACHE_PREFIX</span><span class="token operator">+</span>phone<span class="token punctuation">,</span>redisValue<span class="token punctuation">,</span>
            <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thirdPartyFeignService<span class="token punctuation">.</span><span class="token function">sendCode</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.5.png" alt="image-20220804110941872" tabindex="0" loading="lazy"><figcaption>image-20220804110941872</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件的<code>&lt;script&gt;</code>标签里的<code>id</code>为<code>sendCode</code>的点击事件，获取发送验证码的返回值，如果状态码不等于<code>0</code>就弹出对话框，告诉用户<code>msg</code>的信息</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 发送验证码</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span><span class="token string">&quot;disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">//正在倒计时。</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
         <span class="token comment">// 给指定手机号发送验证码</span>
         $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/sms/sendCode?phone=&quot;</span><span class="token operator">+</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#phoneNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>
         <span class="token function">timeoutChangeStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.6.png" alt="image-20220804111315736" tabindex="0" loading="lazy"><figcaption>image-20220804111315736</figcaption></figure><p>在<code>auth.gulimall.com/reg.html</code>页面里点击<code>发送验证码</code>，然后刷新页面再次点击<code>发送验证码</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.7.png" alt="image-20220804110419877" tabindex="0" loading="lazy"><figcaption>image-20220804110419877</figcaption></figure><p>可以看到，此时弹出了<code>验证码获取频率太高，请稍后再试</code>的提示框</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.8.png" alt="image-20220804110422242" tabindex="0" loading="lazy"><figcaption>image-20220804110422242</figcaption></figure><p>此时也可以看到<code>sms:code:手机号</code>为<code>key</code>的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.6.4.9.png" alt="image-20220804111113269" tabindex="0" loading="lazy"><figcaption>image-20220804111113269</figcaption></figure><h4 id="_7、注册" tabindex="-1"><a class="header-anchor" href="#_7、注册" aria-hidden="true">#</a> 7、注册</h4><h5 id="_1、编写注册代码" tabindex="-1"><a class="header-anchor" href="#_1、编写注册代码" aria-hidden="true">#</a> 1、编写注册代码</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth</code>包里新建<code>vo</code>文件夹，在<code>vo</code>文件夹里新建<code>UserRegisterVo</code>类，用于封装注册所填写的信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span></span><span class="token class-name">Length</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span></span><span class="token class-name">NotNull</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>constraints<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/4
 * @Description: 注册表单
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRegisterVo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 用户名
     */</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;用户名必须填写&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Length</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>max <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>message <span class="token operator">=</span> <span class="token string">&quot;用户名必须是6-18位字符&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 密码
     */</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;密码必须填写&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Length</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>max <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span>message <span class="token operator">=</span> <span class="token string">&quot;密码必须是6- 18位字符&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 手机号
     */</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;手机号必须填写&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">&quot;^[1]([3-9])[0-9]{9}$&quot;</span><span class="token punctuation">,</span>message <span class="token operator">=</span> <span class="token string">&quot;手机号格式不正确&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 验证码
     */</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;验证码必须填写&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.1.1.png" alt="image-20220805145043209" tabindex="0" loading="lazy"><figcaption>image-20220805145043209</figcaption></figure><p>在<code>auth.gulimall.com/reg.html</code>页面里，打开控制台，定位到<code>立 即 注 册</code>，复制<code>立 即 注 册</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.1.2.png" alt="image-20220805150325410" tabindex="0" loading="lazy"><figcaption>image-20220805150325410</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>类里搜索<code>立 即 注 册</code></p><p>给<code>立 即 注 册</code>所在的<code>&lt;section&gt;</code>标签里套上一个<code>&lt;form&gt;</code>标签</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.1.3.png" alt="image-20220805150614747" tabindex="0" loading="lazy"><figcaption>image-20220805150614747</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>类里修改<code>立 即 注 册</code>所在的<code>&lt;section&gt;</code>标签里的部分代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/regist<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         用 户 名
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>您的用户名和登录名<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         设 置 密 码
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>建议至少使用两种字符组合<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>确 认 密 码
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请再次输入密码<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>中国 0086∨<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phone<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phone<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phoneNum<span class="token punctuation">&quot;</span></span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>建议使用常用手机<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>验 证 码
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>code<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入验证码<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>caa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;span id=&quot;code&quot;&gt;&lt;/span&gt;--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sendCode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送验证码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;div class=&quot;tips&quot;&gt;--&gt;</span>

      <span class="token comment">&lt;!--&lt;/div&gt;--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arguement<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xieyi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 阅读并同意
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>《谷粒商城用户注册协议》<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>《隐私政策》<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit_btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit_btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立 即 注 册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.1.4.png" alt="image-20220805152346218" tabindex="0" loading="lazy"><figcaption>image-20220805152346218</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类的<code>regist</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/regist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">UserRegisterVo</span> userRegisterVo<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> bindingResult<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getField</span><span class="token punctuation">,</span> <span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/reg.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用远程服务注册</span>

    <span class="token comment">//注册成功，回到登录页</span>
    <span class="token comment">// (需要经过GulimallWebConfig类 registry.addViewController(&quot;/login.html&quot;).setViewName(&quot;login&quot;);)</span>
    <span class="token comment">//再跳转到login的视图</span>
    <span class="token keyword">return</span> <span class="token string">&quot;redirect:/login.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.1.5.png" alt="image-20220805153236781" tabindex="0" loading="lazy"><figcaption>image-20220805153236781</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里，将<code>提交按钮</code>注释下面的方法注释起来</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.1.6.png" alt="image-20220805152530066" tabindex="0" loading="lazy"><figcaption>image-20220805152530066</figcaption></figure><h5 id="_2、测试-2" tabindex="-1"><a class="header-anchor" href="#_2、测试-2" aria-hidden="true">#</a> 2、测试</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类的<code>regist</code>方法的第一行打上断点，以<code>debug</code>方式启动<code>GulimallAuthServerApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.2.1.png" alt="image-20220805152735520" tabindex="0" loading="lazy"><figcaption>image-20220805152735520</figcaption></figure><p>在<code>http://auth.gulimall.com/reg.html</code>页面里随便输入数据，然后点击立即注册</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.2.2.png" alt="image-20220805152853881" tabindex="0" loading="lazy"><figcaption>image-20220805152853881</figcaption></figure><p>切换到<code>IDEA</code>，可以看到后端的这些校验都正常判断出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.2.3.png" alt="image-20220805153011626" tabindex="0" loading="lazy"><figcaption>image-20220805153011626</figcaption></figure><p>取消断点，刷新<code>http://auth.gulimall.com/reg.html</code>页面，再次随便输入数据，然后点击立即注册，此时页面显示<code>Request method &#39;POST&#39; not supported</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.2.4.png" alt="image-20220805154114694" tabindex="0" loading="lazy"><figcaption>image-20220805154114694</figcaption></figure><p>打开<code>GulimallAuthServerApplication</code>服务的控制台，显示如下警告</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[org.springframework.web.HttpRequestMethodNotSupportedException: Request method &#39;POST&#39; not supported]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>/regist</code>的请求方式为<code>POST</code>，转发将请求原封不动的发给了<code>/reg.html</code>，因此发送的使<code>POST</code>方式的请求，而<code>/reg.html</code>的路径映射的请求方式为<code>GET</code>(在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config.GulimallWebConfig</code>类的<code>addViewControllers</code>方法里配置的)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.2.5.png" alt="image-20220805154123738" tabindex="0" loading="lazy"><figcaption>image-20220805154123738</figcaption></figure><p>将<code>return &quot;forward:/reg.html&quot;;</code>修改为<code>return &quot;reg&quot;;</code>，直接返回<code>reg.html</code>，而不是转发给<code>/reg.html</code>的映射</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.2.6.png" alt="image-20220805154609954" tabindex="0" loading="lazy"><figcaption>image-20220805154609954</figcaption></figure><h5 id="_3、修改页面" tabindex="-1"><a class="header-anchor" href="#_3、修改页面" aria-hidden="true">#</a> 3、修改页面</h5><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里的<code>&lt;html&gt;</code>标签里添加<code>xmlns:th=&quot;http://www.thymeleaf.org&quot;</code>，引入<code>thymeleaf</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.1.png" alt="image-20220805153328969" tabindex="0" loading="lazy"><figcaption>image-20220805153328969</figcaption></figure><p>在<code>用 户 名</code>对应的<code>class=&quot;tips&quot;</code>的<code>&lt;div&gt;</code>标签上加上<code>th:text=&quot;\${errors!=null?errors.username:&#39;&#39;}&quot;</code>属性</p><p>在<code>设 置 密 码</code>对应的<code>class=&quot;tips&quot;</code>的<code>&lt;div&gt;</code>标签上加上<code>th:text=&quot;\${errors!=null?errors.password:&#39;&#39;}&quot;</code>属性\`</p><p>在<code>中国 0086∨</code>对应的<code>class=&quot;tips&quot;</code>的<code>&lt;div&gt;</code>标签上加上<code>th:text=&quot;\${errors!=null?errors.phone:&#39;&#39;}&quot;</code>属性\`</p><p>在<code>发送验证码</code>相应的位置加上<code>&lt;div class=&quot;tips&quot; th:text=&quot;\${errors!=null?errors.phone:&#39;&#39;}&quot;&gt;&lt;/div&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.2.png" alt="image-20220805155749434" tabindex="0" loading="lazy"><figcaption>image-20220805155749434</figcaption></figure><p>在<code>http://auth.gulimall.com/reg.html</code>页面里随便输入数据，然后点击立即注册，来到了<code>http://auth.gulimall.com/regist</code>页面，点击<code>同意并继续</code>无反应</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.3.png" alt="image-20220805155946328" tabindex="0" loading="lazy"><figcaption>image-20220805155946328</figcaption></figure><p>打开<code>GulimallAuthServerApplication</code>服务的控制台，报了如下错误：(code字段没有找到)</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Caused by: org.attoparser.ParseException: Exception evaluating SpringEL expression: &quot;errors!=null?errors.code:&#39;&#39;&quot; (template: &quot;reg&quot; - line 5054, col 24)

Caused by: org.thymeleaf.exceptions.TemplateProcessingException: Exception evaluating SpringEL expression: &quot;errors!=null?errors.code:&#39;&#39;&quot; (template: &quot;reg&quot; - line 5054, col 24)

Caused by: org.springframework.expression.spel.SpelEvaluationException: EL1008E: Property or field &#39;code&#39; cannot be found on object of type &#39;java.util.HashMap&#39; - maybe not public or not valid?
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.4.png" alt="image-20220805160353885" tabindex="0" loading="lazy"><figcaption>image-20220805160353885</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里的<code>&lt;form&gt;</code>表单，对所有字段都判断是否为空</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/regist<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         用 户 名
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>您的用户名和登录名<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${errors!=null?(#maps.containsKey(errors,&#39;username&#39;)?errors.username:&#39;&#39;):&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         设 置 密 码
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>建议至少使用两种字符组合<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${errors!=null?(#maps.containsKey(errors,&#39;password&#39;)?errors.password:&#39;&#39;):&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>确 认 密 码
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请再次输入密码<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>中国 0086∨<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phone<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phone<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phoneNum<span class="token punctuation">&quot;</span></span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>建议使用常用手机<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${errors!=null?(#maps.containsKey(errors,&#39;phone&#39;)?errors.phone:&#39;&#39;):&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>register-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>other_label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>验 证 码
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>20<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>code<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入验证码<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>caa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;span id=&quot;code&quot;&gt;&lt;/span&gt;--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sendCode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送验证码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${errors!=null?(#maps.containsKey(errors,&#39;code&#39;)?errors.code:&#39;&#39;):&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arguement<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xieyi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 阅读并同意
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>《谷粒商城用户注册协议》<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>《隐私政策》<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit_btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit_btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立 即 注 册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.5.png" alt="image-20220805161711958" tabindex="0" loading="lazy"><figcaption>image-20220805161711958</figcaption></figure><p>直接返回页面导致<code>url</code>路径不变，所以再次刷新页面还是发送表单提交的那个请求，就会弹出如下提示框</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>确认重新提交表单
您所查找的网页要使用已输入的信息。返回此页可能需要重复已进行的所有操作。是否要继续操作?
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.6.png" alt="image-20220805161117226" tabindex="0" loading="lazy"><figcaption>image-20220805161117226</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类的<code>regist</code>方法，使用重定向的方式返回页面。</p><p>可以调用<code>RedirectAttributes</code>类的<code>redirectAttributes.addFlashAttribute(&quot;errors&quot;,errors);</code>方法，来添加一个一闪而过的属性(只能取一次)。当然也可以使用常规的<code>redirectAttributes.addAttribute(&quot;errors&quot;,errors);</code>方法，不过最好只取一次，获取到数据后就删除提示信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * <span class="token keyword">@param</span> <span class="token parameter">userRegisterVo</span>
 * <span class="token keyword">@param</span> <span class="token parameter">bindingResult</span> 校验失败的错误信息
 * <span class="token keyword">@param</span> <span class="token parameter">redirectAttributes</span> 重定向携带数据
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/regist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">UserRegisterVo</span> userRegisterVo<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> bindingResult<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> redirectAttributes<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getField</span><span class="token punctuation">,</span> <span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加一个一闪而过的属性(只需要取一次)</span>
        redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  /regist为Post方式，转发将请求原封不动的发给了/reg.html，而/reg.html的路径映射的请求方式为GET</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/reg.html&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//return &quot;reg&quot;;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用远程服务注册</span>

    <span class="token comment">//注册成功，回到登录页</span>
    <span class="token comment">// (需要经过GulimallWebConfig类 registry.addViewController(&quot;/login.html&quot;).setViewName(&quot;login&quot;);)</span>
    <span class="token comment">//再跳转到login的视图</span>
    <span class="token keyword">return</span> <span class="token string">&quot;redirect:/login.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.7.png" alt="image-20220805162618835" tabindex="0" loading="lazy"><figcaption>image-20220805162618835</figcaption></figure><p>在<code>http://auth.gulimall.com/reg.html</code>页面里，随便输入数据，然后点击<code>立即注册</code>，此时跳转到了<code>http://10.66.114.92:20000/reg.html</code>页面，使用了本服务器的<code>以太网ip</code>，而不是域名的方式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.8.gif" alt="GIF 2022-8-5 16-26-51" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-5 16-26-51</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类的<code>regist</code>方法，使用域名方式重定向页面</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * TODO 重定向携带数据，利用session原理。将数据放在session中。只要跳到下一个页面取出这个数据以后，session里面的数据就会删掉
 * <span class="token keyword">@param</span> <span class="token parameter">userRegisterVo</span>
 * <span class="token keyword">@param</span> <span class="token parameter">bindingResult</span> 校验失败的错误信息
 * <span class="token keyword">@param</span> <span class="token parameter">redirectAttributes</span> 重定向携带数据
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/regist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">UserRegisterVo</span> userRegisterVo<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> bindingResult<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> redirectAttributes<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getField</span><span class="token punctuation">,</span> <span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加一个一闪而过的属性(只需要取一次)</span>
        redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  /regist为Post方式，转发将请求原封不动的发给了/reg.html，而/reg.html的路径映射的请求方式为GET</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//return &quot;reg&quot;;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用远程服务注册</span>

    <span class="token comment">//注册成功，回到登录页</span>
    <span class="token comment">// (需要经过GulimallWebConfig类 registry.addViewController(&quot;/login.html&quot;).setViewName(&quot;login&quot;);)</span>
    <span class="token comment">//再跳转到login的视图</span>
    <span class="token keyword">return</span> <span class="token string">&quot;redirect:/login.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.9.png" alt="image-20220805163358815" tabindex="0" loading="lazy"><figcaption>image-20220805163358815</figcaption></figure><p>重启<code>GulimallAuthServerApplication</code>服务，在<code>http://auth.gulimall.com/reg.html</code>页面里，随便输入数据，然后点击<code>立即注册</code>，此正确跳转到了<code>http://auth.gulimall.com/reg.html</code>页面</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>重定向携带数据，利用session原理。将数据放在session中。只要跳到下一个页面取出这个数据以后，session里面的数据就会删掉。不过分布式项目使用session会有很多问题
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.3.10.gif" alt="GIF 2022-8-5 16-32-37" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-5 16-32-37</figcaption></figure><h5 id="_4、调用会员服务" tabindex="-1"><a class="header-anchor" href="#_4、调用会员服务" aria-hidden="true">#</a> 4、调用会员服务</h5><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member</code>包下新建<code>vo</code>文件夹，在<code>vo</code>文件夹里新建<code>MemberRegistVo</code>类，用于注册会员</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/5
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberRegistVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.1.png" alt="image-20220805170602941" tabindex="0" loading="lazy"><figcaption>image-20220805170602941</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.controller.MemberController</code>类里新建<code>regist</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/regist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MemberRegistVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    memberService<span class="token punctuation">.</span><span class="token function">regist</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.2.png" alt="image-20220805165310321" tabindex="0" loading="lazy"><figcaption>image-20220805165310321</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.MemberService</code>接口里添加<code>regist</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token class-name">MemberRegistVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.3.png" alt="image-20220805165338879" tabindex="0" loading="lazy"><figcaption>image-20220805165338879</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类里实现<code>regist</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MemberLevelDao</span> memberLevelDao<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token class-name">MemberRegistVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberDao</span> baseMapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">;</span>
    <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MemberLevelEntity</span> memberLevelEntity <span class="token operator">=</span> memberLevelDao<span class="token punctuation">.</span><span class="token function">getDefaultLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setLevelId</span><span class="token punctuation">(</span>memberLevelEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//检查手机号和用户名是否唯一，使用异常机制</span>
    <span class="token function">checkPhoneUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkUsernameUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    memberEntity<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 密码加密存储</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.4.png" alt="image-20220805171242685" tabindex="0" loading="lazy"><figcaption>image-20220805171242685</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.dao.MemberLevelDao</code>接口里添加<code>getDefaultLevel</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">MemberLevelEntity</span> <span class="token function">getDefaultLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.5.png" alt="image-20220805171336691" tabindex="0" loading="lazy"><figcaption>image-20220805171336691</figcaption></figure><p><code>gulimall_ums</code>数据库的<code>ums_member_level</code>表里的<code>default_status</code>字段，标识了当前用户的默认等级</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.6.png" alt="image-20220805171519674" tabindex="0" loading="lazy"><figcaption>image-20220805171519674</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>src/main/resources/mapper/member/MemberLevelDao.xml</code>文件里添加<code>id=&quot;getDefaultLevel&quot;</code>的<code>sql</code>语句，用于查询用户默认等级</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getDefaultLevel<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.atguigu.gulimall.member.entity.MemberLevelEntity<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select * from gulimall_ums.ums_member_level where default_status=1
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.7.png" alt="image-20220805171717875" tabindex="0" loading="lazy"><figcaption>image-20220805171717875</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member</code>包里新建<code>exception</code>文件夹，在<code>exception</code>文件夹里新建<code>UsernameExistException</code>类，用于抛出<code>用户名存在</code>的异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/5
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernameExistException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">UsernameExistException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;用户名存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.8.png" alt="image-20220805171953569" tabindex="0" loading="lazy"><figcaption>image-20220805171953569</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.exception</code>包里新建<code>PhoneExistException</code>类，用于抛出<code>手机号存在</code>的异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/5
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneExistException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">PhoneExistException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;手机号存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.9.png" alt="image-20220805172115826" tabindex="0" loading="lazy"><figcaption>image-20220805172115826</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类里添加<code>checkUsernameUnique</code>方法和<code>checkPhoneUnique</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkUsernameUnique</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameExistException</span><span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MemberEntity</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameExistException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkPhoneUnique</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PhoneExistException</span><span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MemberEntity</span><span class="token operator">::</span><span class="token function">getMobile</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PhoneExistException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.10.png" alt="image-20220805172707071" tabindex="0" loading="lazy"><figcaption>image-20220805172707071</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.MemberService</code>接口里添加<code>checkUsernameUnique</code>抽象方法和<code>checkPhoneUnique</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">checkUsernameUnique</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameExistException</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">checkPhoneUnique</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PhoneExistException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.2.7.4.11.png" alt="image-20220805172743895" tabindex="0" loading="lazy"><figcaption>image-20220805172743895</figcaption></figure><h3 id="_5-7-3、md5盐值加密" tabindex="-1"><a class="header-anchor" href="#_5-7-3、md5盐值加密" aria-hidden="true">#</a> 5.7.3、MD5盐值加密</h3><h4 id="_1、对用户密码进行加密" tabindex="-1"><a class="header-anchor" href="#_1、对用户密码进行加密" aria-hidden="true">#</a> 1、对用户密码进行加密</h4><p><strong>MD5</strong>：Message Digest algorithm 5，信息摘要算法</p><p>优点：</p><ul><li>压缩性：任意长度的数据，算出的MD5值长度都是固定的。</li><li>容易计算：从原数据计算出MD5值很容易。</li><li>抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别。</li><li>强抗碰撞：想找到两个不同的数据，使它们具有相同的MD5值，是非常困难的。</li><li>不可逆</li></ul><p>但是一个<code>明文</code>(加密后)对应一个唯一的<code>密文</code>(加密前)，只要维护一个彩虹表，记录<code>明文</code>和对应的<code>密文</code>，如果<code>密文</code>使用的是弱密码，可以直接根据<code>明文</code>查找密码表，就可以知道<code>密文</code></p><p><strong>加盐</strong></p><ul><li>通过生成随机数与MD5生成字符串进行组合</li><li>数据库同时存储MD5值与salt值。验证正确性时使用salt进行MD5即可</li></ul><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.GulimallMemberApplicationTests</code>测试类的<code>contextLoads</code>方法里测试常见的加密方式</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//e10adc3949ba59abbe56e057f20f883e</span>
   <span class="token comment">//抗修改性:彩虹表。 123456-&gt;&gt;xx</span>
   <span class="token comment">//1234567- &gt;dddd</span>
   <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s1=&gt;&quot;</span> <span class="token operator">+</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token comment">//MD5不能直接进行密码的加密存储;</span>
   <span class="token comment">//&quot;123456 &quot;+System.currentTimeMillis();</span>
   <span class="token comment">//盐值加密;随机值加盐: $1$+8位字符</span>
   <span class="token comment">//$1$q4yw9ojS$YQk9WvivLoEWT04q/Fr2q1</span>
   <span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token class-name">Md5Crypt</span><span class="token punctuation">.</span><span class="token function">md5Crypt</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s2=&gt;&quot;</span><span class="token operator">+</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//$1$qqqqqqqq$AZofg3QwurbxV3KEOzwuI1</span>
   <span class="token comment">//验证: 123456进行盐值(去数据库查)加密</span>
   <span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token class-name">Md5Crypt</span><span class="token punctuation">.</span>md5Crypt <span class="token punctuation">(</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;$1$qqqqqqqq&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span> out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;s3=&gt;&quot;</span><span class="token operator">+</span>s3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token class-name">BCryptPasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//$2a$10$4li09amFs0Tfof8Y/0PjKe0ZWngU5tMHuAYNUkyGiM/2FuJ25oeBi</span>
   <span class="token class-name">String</span> encode <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span>
         <span class="token string">&quot;$2a$10$4li09amFs0Tfof8Y/0PjKe0ZWngU5tMHuAYNUkyGiM/2FuJ25oeBi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>s1=&gt;e10adc3949ba59abbe56e057f20f883e
s2=&gt;$1$oOb6v3rn$FsjQJmtHzO1Bm/CGUAhNH1
s3=&gt;$1$qqqqqqqq$AZofg3QwurbxV3KEOzwuI1
$2a$10$dR0/M9hUPbHxqgrjqjv5xeA2JxKNDu5CLfn/wTcSF/JUD8BVR0Uc.
true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.1.1.png" alt="image-20220805192733343" tabindex="0" loading="lazy"><figcaption>image-20220805192733343</figcaption></figure><p>修改<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>regist</code>方法，使其使用<code>加盐的md5</code>来存储密文</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token class-name">MemberRegistVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberDao</span> baseMapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">;</span>
    <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MemberLevelEntity</span> memberLevelEntity <span class="token operator">=</span> memberLevelDao<span class="token punctuation">.</span><span class="token function">getDefaultLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setLevelId</span><span class="token punctuation">(</span>memberLevelEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//检查手机号和用户名是否唯一，使用异常机制</span>
    <span class="token function">checkPhoneUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkUsernameUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    memberEntity<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//盐值加密</span>
    <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> encode <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.1.2.png" alt="image-20220805200911397" tabindex="0" loading="lazy"><figcaption>image-20220805200911397</figcaption></figure><h4 id="_2、远程调用member服务" tabindex="-1"><a class="header-anchor" href="#_2、远程调用member服务" aria-hidden="true">#</a> 2、远程调用<code>member</code>服务</h4><h5 id="_1、添加错误信息" tabindex="-1"><a class="header-anchor" href="#_1、添加错误信息" aria-hidden="true">#</a> 1、添加错误信息</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加如下两个枚举</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户名重复
 */</span>
<span class="token function">USER_EXIST_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">15001</span><span class="token punctuation">,</span><span class="token string">&quot;用户存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token doc-comment comment">/**
 * 手机号重复
 */</span>
<span class="token function">PHONE_EXIST_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">15002</span><span class="token punctuation">,</span><span class="token string">&quot;手机号存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.1.1.png" alt="image-20220805193459836" tabindex="0" loading="lazy"><figcaption>image-20220805193459836</figcaption></figure><p>修改<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.controller.MemberController</code>类的<code>regist</code>方法，捕获<code>用户名重复</code>和<code>手机号重复</code>的异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/regist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MemberRegistVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        memberService<span class="token punctuation">.</span><span class="token function">regist</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameExistException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">USER_EXIST_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PhoneExistException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">PHONE_EXIST_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.1.2.png" alt="image-20220805193835367" tabindex="0" loading="lazy"><figcaption>image-20220805193835367</figcaption></figure><h5 id="_2、远程调用会员服务" tabindex="-1"><a class="header-anchor" href="#_2、远程调用会员服务" aria-hidden="true">#</a> 2、远程调用会员服务</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.feign</code>包里新建<code>MemberFeignService</code>接口，用于调用会员服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">UserRegisterVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/5
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-member&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/member/member/regist&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserRegisterVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.2.1.png" alt="image-20220805194153146" tabindex="0" loading="lazy"><figcaption>image-20220805194153146</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.utils.R</code>类里添加<code>getMsg</code>方法，用于获取消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.2.2.png" alt="image-20220805194951039" tabindex="0" loading="lazy"><figcaption>image-20220805194951039</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类的<code>regist</code>方法，调用远程的会员服务，完成注册</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * TODO 重定向携带数据，利用session原理。将数据放在session中。只要跳到下一个页面取出这个数据以后，session里面的数据就会删掉
 * <span class="token keyword">@param</span> <span class="token parameter">userRegisterVo</span>
 * <span class="token keyword">@param</span> <span class="token parameter">bindingResult</span> 校验失败的错误信息
 * <span class="token keyword">@param</span> <span class="token parameter">redirectAttributes</span> 重定向携带数据
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/regist&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">UserRegisterVo</span> userRegisterVo<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> bindingResult<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> redirectAttributes<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getField</span><span class="token punctuation">,</span> <span class="token class-name">FieldError</span><span class="token operator">::</span><span class="token function">getDefaultMessage</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加一个一闪而过的属性(只需要取一次)</span>
        redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  /regist为Post方式，转发将请求原封不动的发给了/reg.html，而/reg.html的路径映射的请求方式为GET</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//return &quot;reg&quot;;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用远程服务注册</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> userRegisterVo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">SMS_CODE_CACHE_PREFIX</span> <span class="token operator">+</span> userRegisterVo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> redisCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisCode<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">regist</span><span class="token punctuation">(</span>userRegisterVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//注册成功，回到登录页</span>
                <span class="token comment">// (需要经过GulimallWebConfig类 registry.addViewController(&quot;/login.html&quot;).setViewName(&quot;login&quot;);)</span>
                <span class="token comment">//再跳转到login的视图</span>
                <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;验证码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.2.3.png" alt="image-20220805200325158" tabindex="0" loading="lazy"><figcaption>image-20220805200325158</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/reg.html</code>文件里的<code>&lt;form&gt;</code>标签的下面添加如下代码，用于获取注册失败的错误提示</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tips<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span>
    <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${errors!=null?(#maps.containsKey(errors,&#39;msg&#39;)?errors.msg:&#39;&#39;):&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.2.4.png" alt="image-20220805195512378" tabindex="0" loading="lazy"><figcaption>image-20220805195512378</figcaption></figure><p>重启<code>GulimallAuthServerApplication</code>服务和<code>GulimallMemberApplication</code>服务</p><p>在<code>http://auth.gulimall.com/reg.html</code>页面填完信息提交后，成功来到了登录页<code>http://auth.gulimall.com/login.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.2.5.png" alt="image-20220805200605614" tabindex="0" loading="lazy"><figcaption>image-20220805200605614</figcaption></figure><p>打开<code>Navicat</code>，查看<code>gulimall_ums</code>数据库的<code>ums_member</code>表,可以看到刚刚注册的账户已经添加进来了，密码也是用的密文</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.2.2.6.png" alt="image-20220805201315222" tabindex="0" loading="lazy"><figcaption>image-20220805201315222</figcaption></figure><h4 id="_3、用户登录" tabindex="-1"><a class="header-anchor" href="#_3、用户登录" aria-hidden="true">#</a> 3、用户登录</h4><h5 id="_1、编写auth-server模块" tabindex="-1"><a class="header-anchor" href="#_1、编写auth-server模块" aria-hidden="true">#</a> 1、编写<code>auth-server</code>模块</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.vo</code>包里新建<code>UserLoginVo</code>类，用于封装用户登录所需要的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/5
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginVo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 登录的账号(邮箱/用户名/手机号)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginAccount<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 密码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.1.1.png" alt="image-20220805201802057" tabindex="0" loading="lazy"><figcaption>image-20220805201802057</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类里添加<code>login</code>方法，用于用户登录</p><p>页面传递的参数为<code>url</code>里的<code>k，v</code>，因此该方法上不加<code>@RequestBody</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">UserLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.1.2.png" alt="image-20220805210151060" tabindex="0" loading="lazy"><figcaption>image-20220805210151060</figcaption></figure><p>在<code>http://auth.gulimall.com/login.html</code>页面里，打开控制台，定位到<code>登录</code>，复制<code>登 &amp;nbsp; &amp;nbsp;录</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.1.3.png" alt="image-20220805202828971" tabindex="0" loading="lazy"><figcaption>image-20220805202828971</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件里搜索<code>登 &amp;nbsp; &amp;nbsp;录</code>，将<code>登 &amp;nbsp; &amp;nbsp;录</code>的<code>&lt;button&gt;</code>标签类型设置为<code>submit</code>，在<code>登 &amp;nbsp; &amp;nbsp;录</code>所在的<code>ul</code>外围加一个<code>&lt;form&gt;</code>，删掉登录左边的<code>&lt;a class=&quot;a&quot;&gt;</code>和右边的<code>&lt;/a&gt;</code>，给用户名和密码各一个<code>name</code>，方便取值</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/login<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top_1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/login/JD_img/user_03.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>err_img1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>loginAccount<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span> 邮箱/用户名/已验证手机<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/login/JD_img/user_06.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>err_img2<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span> 密码<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bri<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>忘记密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ent<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>登 <span class="token entity named-entity" title=" ">&amp;nbsp;</span> <span class="token entity named-entity" title=" ">&amp;nbsp;</span>录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.1.4.png" alt="image-20220805202926997" tabindex="0" loading="lazy"><figcaption>image-20220805202926997</figcaption></figure><h5 id="_2、编写member模块" tabindex="-1"><a class="header-anchor" href="#_2、编写member模块" aria-hidden="true">#</a> 2、编写<code>member</code>模块</h5><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.vo</code>包里新建<code>MemberLoginVo</code>类，用于封装<code>gulimall-auth-server</code>模块调用本模块进行登录所需要的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/5
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberLoginVo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 登录的账号(邮箱/用户名/手机号)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginAccount<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 密码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.2.1.png" alt="image-20220805203945860" tabindex="0" loading="lazy"><figcaption>image-20220805203945860</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加<code>登录的账号或密码错误 或 该用户不存在</code>的枚举</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 登录的账号或密码错误 或 该用户不存在
 */</span>
<span class="token function">ACCOUNT_PASSWORD_INVALID_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">15003</span><span class="token punctuation">,</span><span class="token string">&quot;账号或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.2.2.png" alt="image-20220805205824129" tabindex="0" loading="lazy"><figcaption>image-20220805205824129</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.controller.MemberController</code>类里添加<code>login</code>方法用于查找数据库，处理<code>gulimall-auth-server</code>模块登录请求</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MemberLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">MemberEntity</span> entity <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">ACCOUNT_PASSWORD_INVALID_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.2.3.png" alt="image-20220805210002751" tabindex="0" loading="lazy"><figcaption>image-20220805210002751</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.MemberService</code>接口里添加<code>login</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">MemberEntity</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">MemberLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.2.4.png" alt="image-20220805204448949" tabindex="0" loading="lazy"><figcaption>image-20220805204448949</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类里实现<code>login</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MemberEntity</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">MemberLoginVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MemberEntity</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span>vo<span class="token punctuation">.</span><span class="token function">getLoginAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MemberEntity</span><span class="token operator">::</span><span class="token function">getMobile</span><span class="token punctuation">,</span>vo<span class="token punctuation">.</span><span class="token function">getLoginAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MemberEntity</span><span class="token operator">::</span><span class="token function">getEmail</span><span class="token punctuation">,</span>vo<span class="token punctuation">.</span><span class="token function">getLoginAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memberEntity<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> matches <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberEntity<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matches<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> memberEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.2.5.png" alt="image-20220805205332991" tabindex="0" loading="lazy"><figcaption>image-20220805205332991</figcaption></figure><h5 id="_3、调用member服务" tabindex="-1"><a class="header-anchor" href="#_3、调用member服务" aria-hidden="true">#</a> 3、调用<code>member</code>服务</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.feign.MemberFeignService</code>类里添加<code>login</code>方法，用于调用<code>member</code>服务的登录接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/member/member/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserLoginVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.3.1.png" alt="image-20220805210346363" tabindex="0" loading="lazy"><figcaption>image-20220805210346363</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>类里的<code>&lt;html&gt;</code>标签里添加<code>xmlns:th=&quot;http://www.thymeleaf.org&quot;</code>属性，引入<code>thymeleaf</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.3.2.png" alt="image-20220805211142366" tabindex="0" loading="lazy"><figcaption>image-20220805211142366</figcaption></figure><p>在<code>&lt;form&gt;</code>标签下，加入如下代码，用于提醒登录失败</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span>
     <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${errors!=null?(#maps.containsKey(errors,&#39;msg&#39;)?errors.msg:&#39;&#39;):&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.3.3.png" alt="image-20220805211230010" tabindex="0" loading="lazy"><figcaption>image-20220805211230010</figcaption></figure><p>重启<code>GulimallAuthServerApplication</code>服务和<code>GulimallMemberApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里进行登录，可以看到当登录失败时，会有失败的提示（就是有点丑）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.3.4.gif" alt="GIF 2022-8-5 21-17-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-5 21-17-02</figcaption></figure><p>在<code>http://auth.gulimall.com/login.html</code>页面里输入正确的账户和密码，点击登录，可以正确来到<code>http://gulimall.com</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.3.3.3.5.gif" alt="GIF 2022-8-5 21-19-03" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-5 21-19-03</figcaption></figure><h3 id="_5-7-4、社交登录" tabindex="-1"><a class="header-anchor" href="#_5-7-4、社交登录" aria-hidden="true">#</a> 5.7.4、社交登录</h3><p>社交登录流程图</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.0.png" alt="image-20220805213414019" tabindex="0" loading="lazy"><figcaption>image-20220805213414019</figcaption></figure><h4 id="_1、社交登录流程" tabindex="-1"><a class="header-anchor" href="#_1、社交登录流程" aria-hidden="true">#</a> 1、社交登录流程</h4><h5 id="_1、oauth2-0概述" tabindex="-1"><a class="header-anchor" href="#_1、oauth2-0概述" aria-hidden="true">#</a> 1、OAuth2.0概述</h5><p>OAuth2.0较1.0相比，整个授权验证流程更简单更安全，也是未来最主要的用户身份验证和授权方式。</p><p>关于OAuth2.0协议的授权流程可以参考下面的流程图，其中Client指第三方应用，Resource Owner指用户，Authorization Server是我们的授权服务器，Resource Server是API服务器。</p><p>1、使用Code换取AccessToken，Code只能用一次</p><p>2、同一个用户的accessToken一段时间是不会变化的，即使多次获取</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.1.1.1.png" alt="image-20220805215519572" tabindex="0" loading="lazy"><figcaption>image-20220805215519572</figcaption></figure><p><strong>Web网站的授权</strong></p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.1.1.2.png" alt="image-20220805215615101" style="zoom:80%;"><p><strong>社交登录的时序图</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.1.1.3.png" alt="社交登录流程" tabindex="0" loading="lazy"><figcaption>社交登录流程</figcaption></figure><h5 id="_2、gitee登录流程" tabindex="-1"><a class="header-anchor" href="#_2、gitee登录流程" aria-hidden="true">#</a> 2、<a name="gitee登录流程">gitee登录流程</a></h5><p>参考文档：https://gitee.com/api/v5/swagger</p><h6 id="_1、获取code" tabindex="-1"><a class="header-anchor" href="#_1、获取code" aria-hidden="true">#</a> 1、获取<code>code</code></h6><p>点击第三方登录跳转到如下页面，<code>{client_id}</code>修改为自己申请的应用的<code>client_id</code>，<code>{redirect_uri}</code>修改为授权成功返回到的接口地址。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/authorize?client_id={client_id}&amp;redirect_uri={redirect_uri}&amp;response_type=code
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>eg:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/authorize?client_id=065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d&amp;redirect_uri=http://gulimall.com/oauth2.0/gitee/success&amp;response_type=code
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>用户点击<code>同意授权</code>后，会跳转到如下页面：（此<code>code</code>码只能使用一次）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{redirect_uri}?code=abc&amp;state=xyz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>eg：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://gulimall.com/oauth2.0/gitee/success?code=354dd0ceec0fe0457ae6ae03c93c5dace1ea28819aff74873ac4ac551e0907ab
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h6 id="_2、获取token" tabindex="-1"><a class="header-anchor" href="#_2、获取token" aria-hidden="true">#</a> 2、获取<code>token</code></h6><p>对以下接口发送请求：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/token?grant_type=authorization_code&amp;code={code}&amp;client_id={client_id}&amp;redirect_uri={redirect_uri}&amp;client_secret={client_secret}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>eg:</p><p>请求：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/token?grant_type=authorization_code&amp;code=354dd0ceec0fe0457ae6ae03c93c5dace1ea28819aff74873ac4ac551e0907ab&amp;client_id=065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d&amp;redirect_uri=http://gulimall.com/oauth2.0/gitee/success&amp;client_secret=0c58d0cca9c3fe12bd6c6824f6dc04cdbce5b07cad784c9b8d5938342fc004f7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;93c7871550aab0ac3b99c5f2c1a017ca&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">86400</span><span class="token punctuation">,</span>
    <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;d4da9bcc74d312d9f65239fd1b80f497f8d7959d668c382bf6bcab4e5c650312&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user_info&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token number">1659754964</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应参数说明：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>access_token (必需) 授权服务器发出的访问令牌
token_type （必需）这是令牌的类型，通常只是字符串“bearer”。
expires_in （推荐）访问令牌的过期时间。
refresh_token（可选）刷新令牌，在访问令牌过期后，可使用此令牌刷新。
scope（可选）如果用户授予的范围与应用程序请求的范围相同，则此参数为可选。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.1.2.2.png" alt="image-20220806110618299" tabindex="0" loading="lazy"><figcaption>image-20220806110618299</figcaption></figure><h6 id="_3、获取授权用户的信息" tabindex="-1"><a class="header-anchor" href="#_3、获取授权用户的信息" aria-hidden="true">#</a> 3、获取授权用户的信息</h6><p>请求：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/api/v5/user?access_token={access_token}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>响应：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">7559746</span><span class="token punctuation">,</span>
    <span class="token property">&quot;login&quot;</span><span class="token operator">:</span> <span class="token string">&quot;anonymouszs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;无名氏&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;avatar_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/assets/no_portrait.png&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;html_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/anonymouszs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;followers_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/followers&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;following_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/following_url{/other_user}&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;gists_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/gists{/gist_id}&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;starred_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/starred{/owner}{/repo}&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;subscriptions_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/subscriptions&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;organizations_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/orgs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;repos_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/repos&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;events_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/events{/privacy}&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;received_events_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://gitee.com/api/v5/users/anonymouszs/received_events&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;blog&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;weibo&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;bio&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;public_repos&quot;</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token property">&quot;public_gists&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;followers&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;following&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;stared&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">&quot;watched&quot;</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
    <span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-05-13T15:39:52+08:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;updated_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-08-06T16:02:02+08:00&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应各字段类型：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;avatar_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;bio&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;blog&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;events_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;followers&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;followers_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;following&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;following_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;gists_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;html_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> integer
    <span class="token property">&quot;login&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;member_role&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;organizations_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;public_gists&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;public_repos&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;received_events_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> string 企业备注名
    <span class="token property">&quot;repos_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;stared&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;starred_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;subscriptions_url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;updated_at&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;watched&quot;</span><span class="token operator">:</span> string
    <span class="token property">&quot;weibo&quot;</span><span class="token operator">:</span> string
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.1.2.3.png" alt="image-20220806161709372" tabindex="0" loading="lazy"><figcaption>image-20220806161709372</figcaption></figure><h4 id="_2、前端添加gitee登录" tabindex="-1"><a class="header-anchor" href="#_2、前端添加gitee登录" aria-hidden="true">#</a> 2、前端添加gitee登录</h4><h5 id="_1、gitee创建第三方应用" tabindex="-1"><a class="header-anchor" href="#_1、gitee创建第三方应用" aria-hidden="true">#</a> 1、gitee创建第三方应用</h5><p>登录<code>gitee</code>，点击头像右侧的<code>下三角</code>，点击<code>设置</code>，在左侧导航栏找到<code>数据管理</code>里的<code>第三方应用</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.2.1.1.png" alt="image-20220806091840266" tabindex="0" loading="lazy"><figcaption>image-20220806091840266</figcaption></figure><p>在<code>我的应用</code>里，点击右侧的<code>+创建应用</code>，创建一个应用</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.2.1.2.png" alt="image-20220806091843219" tabindex="0" loading="lazy"><figcaption>image-20220806091843219</figcaption></figure><p>应用名称输入<code>谷粒商城</code>，应用描述输入<code>谷粒商城</code>，应用主页输入<code>http://gulimall.com/</code>，应用回调地址输入<code>http://gulimall.com/success</code>，上传一个<code>Logo</code>，然后点击<code>创建应用</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.2.1.3.png" alt="image-20220806091952038" tabindex="0" loading="lazy"><figcaption>image-20220806091952038</figcaption></figure><p>此时就可以看到<code>Client ID</code>和<code>Client Secret</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.2.1.4.png" alt="image-20220806092026961" tabindex="0" loading="lazy"><figcaption>image-20220806092026961</figcaption></figure><h5 id="_2、修改页面" tabindex="-1"><a class="header-anchor" href="#_2、修改页面" aria-hidden="true">#</a> 2、修改页面</h5><p>修改<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件的<code>class=&quot;si_out&quot;</code>的<code>div</code>，将<code>QQ</code>和<code>微信</code>图标修改为<code>gitee</code>和<code>github</code>，并修改<code>gitee</code>登录的登录请求地址和参数（参考<a href="#gitee登录流程">5.7.4.2.gitee登录流程</a>）</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>si_out<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://gitee.com/oauth/authorize?client_id=065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d&amp;redirect_uri=http://gulimall.com/success&amp;response_type=code<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 55px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 45px</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://gitee.com/static/images/logo-black.svg?t=158106666<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>f4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> | <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>22<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">margin-top</span><span class="token punctuation">:</span> 10px</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0 0 16 16<span class="token punctuation">&quot;</span></span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>22<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-view-component</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">fill-rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>evenodd<span class="token punctuation">&quot;</span></span> <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">vertical-align</span><span class="token punctuation">:</span> top</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>github<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rig<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/login/JD_img/4de5019d2404d347897dee637895d02b_25.png<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立即注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.2.2.png" alt="image-20220806100848069" tabindex="0" loading="lazy"><figcaption>image-20220806100848069</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;login.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><h5 id="_3、测试-2" tabindex="-1"><a class="header-anchor" href="#_3、测试-2" aria-hidden="true">#</a> 3、测试</h5><p>在<code>http://auth.gulimall.com/login.html</code>页面里点击<code>gitee</code>图标，跳转到了<code>http://gulimall.com/success?code=74d8f002dc70a88c28f22724ea7fec774ffbdcc983990ae65e518563940ce629</code>页面，点击<code>同意授权</code>后，回调到了<code>https://gitee.com/oauth/authorize?client_id=065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d&amp;redirect_uri=http://gulimall.com/success&amp;response_type=code</code>，此接口还没写，所以没有访问到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.2.3.gif" alt="GIF 2022-8-6 10-17-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-6 10-17-39</figcaption></figure><h4 id="_3、换取token" tabindex="-1"><a class="header-anchor" href="#_3、换取token" aria-hidden="true">#</a> 3、换取<code>token</code></h4><h5 id="_1、修改回调地址" tabindex="-1"><a class="header-anchor" href="#_1、修改回调地址" aria-hidden="true">#</a> 1、修改回调地址</h5><p>在刚刚创建的<code>谷粒商城</code>应用里，添加<code>应用回调地址</code>为<code>http://gulimall.com/oauth2.0/gitee/success</code>，然后点击<code>提交修改</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.1.1.png" alt="image-20220806104444327" tabindex="0" loading="lazy"><figcaption>image-20220806104444327</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件里，修改点击<code>gitee</code>图标跳转到的请求</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://gitee.com/oauth/authorize?client_id=065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d&amp;redirect_uri=http://gulimall.com/oauth2.0/gitee/success&amp;response_type=code<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.1.2.png" alt="image-20220806104507366" tabindex="0" loading="lazy"><figcaption>image-20220806104507366</figcaption></figure><h5 id="_2、配置gitee登录参数" tabindex="-1"><a class="header-anchor" href="#_2、配置gitee登录参数" aria-hidden="true">#</a> 2、配置<code>gitee</code>登录参数</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config</code>包里新建<code>Oauth2FormGitee</code>类，用于配置使用<code>gitee</code>登录的参数</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;oauth2.gitee&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Oauth2FormGitee</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> clientId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> redirectUri<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> clientSecret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.2.1.png" alt="image-20220806112915387" tabindex="0" loading="lazy"><figcaption>image-20220806112915387</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里，配置使用<code>gitee</code>登录的信息</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">oauth2.gitee.client-id</span><span class="token punctuation">=</span><span class="token value attr-value">065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d</span>
<span class="token key attr-name">oauth2.gitee.redirect-uri</span><span class="token punctuation">=</span><span class="token value attr-value">http://gulimall.com/oauth2.0/gitee/success</span>
<span class="token key attr-name">oauth2.gitee.client-secret</span><span class="token punctuation">=</span><span class="token value attr-value">0c58d0cca9c3fe12bd6c6824f6dc04cdbce5b07cad784c9b8d5938342fc004f7</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.2.2.png" alt="image-20220806112944780" tabindex="0" loading="lazy"><figcaption>image-20220806112944780</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config</code>包里新建<code>RestTemplateConfig</code>类，用于配置<code>RestTemplateConfig</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ClientHttpRequestFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">SimpleClientHttpRequestFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span><span class="token class-name">StringHttpMessageConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplateConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientHttpRequestFactory</span> <span class="token function">simpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">SimpleClientHttpRequestFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//连接超时时间/毫秒（连接上服务器(握手成功)的时间，超出抛出connect timeout）</span>
        factory<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数据读取超时时间(socketTimeout)/毫秒（务器返回数据(response)的时间，超过抛出read timeout）</span>
        factory<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token class-name">ClientHttpRequestFactory</span> factory<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置UTF_8编码</span>
        restTemplate<span class="token punctuation">.</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">StringHttpMessageConverter</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.2.3.png" alt="image-20220806114152845" tabindex="0" loading="lazy"><figcaption>image-20220806114152845</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.vo</code>包里新建<code>GiteeCodeResponseVo</code>类，用于封装跳转到<code>gitee</code>后，点击<code>同意授权</code>返回到回调地址，再从回调地址根据<code>code</code>换取<code>token</code>的响应数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiteeCodeResponseVo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tokenType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expiresIn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> createdAt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.2.4.png" alt="image-20220806114502358" tabindex="0" loading="lazy"><figcaption>image-20220806114502358</figcaption></figure><h5 id="_3、新建oauth-gitee表" tabindex="-1"><a class="header-anchor" href="#_3、新建oauth-gitee表" aria-hidden="true">#</a> 3、新建<code>oauth_gitee</code>表</h5><p>执行以下<code>sql</code>，新建<code>oauth_gitee</code>表，用于存储<code>gitee</code>登录的数据</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>CREATE TABLE \`gulimall_ums\`.\`oauth_gitee\`  (
  \`id\` bigint(20) NOT NULL COMMENT &#39;id&#39;,
  \`member_id\` bigint(20) NULL COMMENT &#39;会员id&#39;,
  \`access_token\` varchar(40) NULL COMMENT &#39;授权服务器发出的访问令牌&#39;,
  \`token_type\` varchar(10) NULL COMMENT &#39;这是令牌的类型，通常只是字符串“bearer”&#39;,
  \`expires_in\` bigint(20) NULL COMMENT &#39;访问令牌的过期时间&#39;,
  \`refresh_token\` varchar(70) NULL COMMENT &#39;刷新令牌，在访问令牌过期后，可使用此令牌刷新&#39;,
  \`scope\` varchar(255) NULL COMMENT &#39;如果用户授予的范围与应用程序请求的范围相同，则此参数为可选&#39;,
  \`created_at\` bigint(255) NULL,
  \`avatar_url\` varchar(255) NULL COMMENT &#39;用户的头像&#39;,
  \`created_time\` datetime NULL COMMENT &#39;创建时间&#39;,
  PRIMARY KEY (\`id\`)
);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.3.1.png" alt="image-20220806161144329" tabindex="0" loading="lazy"><figcaption>image-20220806161144329</figcaption></figure><p>在<code>IDEA</code>里依次点击<code>Database</code> -&gt; <code>192.168.56.10</code> -&gt; <code>schemas</code> -&gt; <code>gulimall_ums</code>-&gt;<code>oauth_gitee</code>，然后右键鼠标悬浮到<code>Scripted Extensions</code>这里，然后点击<code>Generate POJOs groovy</code>，选择一个路径存放生成的实体类</p><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.entity</code>包里新建<code>OauthGiteeEntity</code>类，粘贴刚刚生成的实体类在该类里，然后稍作修改</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">FieldFill</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonFormat</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>format<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">DateTimeFormat</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span></span><span class="token punctuation">;</span>


<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;oauth_gitee&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OauthGiteeEntity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@TableId</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> memberId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tokenType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expiresIn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> createdAt<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatarUrl<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token class-name">FieldFill</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDate</span> createdTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.3.2.png" alt="image-20220806161307581" tabindex="0" loading="lazy"><figcaption>image-20220806161307581</figcaption></figure><p>使用<code>Postman</code>发送如下请求，用于换取获取用户信息（注意：要修改为自己的<code>token</code>）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/api/v5/user?access_token=4f1583c038a15f9e57344c868f281462
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.3.3.png" alt="image-20220806161532759" tabindex="0" loading="lazy"><figcaption>image-20220806161532759</figcaption></figure><h5 id="_4、编写gitee登录逻辑" tabindex="-1"><a class="header-anchor" href="#_4、编写gitee登录逻辑" aria-hidden="true">#</a> 4、编写<code>gitee</code>登录逻辑</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller</code>包里新建<code>OAuth2Controller</code>类，用于<code>gitee</code>登录注册</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description: 社交登录
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth2.0&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2Controller</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OAuth2Service</span> oAuth2Service<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/gitee/success&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            oAuth2Service<span class="token punctuation">.</span><span class="token function">giteeRegister</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;第三方登录失败 :{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;第三方登录失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.4.1.png" alt="image-20220806200442012" tabindex="0" loading="lazy"><figcaption>image-20220806200442012</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth</code>包里新建<code>service</code>文件夹，在<code>service</code>文件夹里新建<code>OAuth2Service</code>接口，并添加<code>giteeRegister</code>注册抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OAuth2Service</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.4.2.png" alt="image-20220806200511415" tabindex="0" loading="lazy"><figcaption>image-20220806200511415</figcaption></figure><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加如下参数，将路径为<code>/oauth2.0/**</code>的转给<code>gulimall-auth-server</code>模块（写在通过域名转载的前面）</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_oauth2_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/oauth2.0/<span class="token important">**</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.4.3.png" alt="image-20220806203319034" tabindex="0" loading="lazy"><figcaption>image-20220806203319034</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.vo</code>包里新建<code>GiteeTokenResponseVo</code>类，用于封装根据<code>tocken</code>换取用户信息的响应数据，这里先不写字段，先完成获取<code>token</code>的测试后，再完善字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiteeTokenResponseVo</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.4.4.png" alt="image-20220806211810567" tabindex="0" loading="lazy"><figcaption>image-20220806211810567</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service</code>包里新建<code>impl</code>文件夹，在<code>impl</code>文件夹里新建<code>OAuth2ServiceImpl</code>类，用于处理通过<code>gitee</code>登陆后注册账户</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Oauth2FormGitee</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">GiteeCodeResponseVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">GiteeTokenResponseVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OAuth2Service</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">Oauth2FormGitee</span> oauth2FormGitee<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">GiteeCodeResponseVo</span> vo <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vo<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;获取用户token失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">getGiteeUserInfo</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">GiteeCodeResponseVo</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">GiteeCodeResponseVo</span> vo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;https://gitee.com/oauth/token?grant_type=authorization_code&amp;code={code}&amp;client_id={client_id}&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;&amp;redirect_uri={redirect_uri}&amp;client_secret={client_secret}&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;client_id&quot;</span><span class="token punctuation">,</span>oauth2FormGitee<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">,</span>oauth2FormGitee<span class="token punctuation">.</span><span class="token function">getRedirectUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;client_secret&quot;</span><span class="token punctuation">,</span>oauth2FormGitee<span class="token punctuation">.</span><span class="token function">getClientSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GiteeCodeResponseVo</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token class-name">GiteeCodeResponseVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                vo <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;连接gitee获取token状态异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;连接gitee获取token响应参数异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;连接gitee获取token异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">GiteeTokenResponseVo</span> <span class="token function">getGiteeUserInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">GiteeTokenResponseVo</span> vo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;https://gitee.com/api/v5/user?access_token={access_token}&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GiteeTokenResponseVo</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">GiteeTokenResponseVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                vo <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;连接gitee获取token状态异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;连接gitee获取用户信息异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.4.5.png" alt="image-20220806205937535" tabindex="0" loading="lazy"><figcaption>image-20220806205937535</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl</code>类里的<code>getToken</code>方法的<code>ResponseEntity&lt;GiteeCodeResponseVo&gt; response = restTemplate.postForEntity(url,null,GiteeCodeResponseVo.class,map);</code>这一行打上断点。以<code>debug</code>方式运行<code>GulimallAuthServerApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>gitee</code>图标，然后点击<code>同意授权</code>，切换到<code>IDEA</code>，点击<code>Step Over F8</code>执行完根据<code>code</code>换取<code>token</code>的请求，可以看到返回的数据并没有封装到<code>GiteeCodeResponseVo</code>类里。这是因为返回的数据是<code>蛇形命名法</code>(以<code>_</code>区分各单词)，而<code>GiteeCodeResponseVo</code>类的字段使用的是<code>驼峰命名法</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.4.6.png" alt="image-20220806205902981" tabindex="0" loading="lazy"><figcaption>image-20220806205902981</figcaption></figure><h5 id="_5、修改giteecoderesponsevo类" tabindex="-1"><a class="header-anchor" href="#_5、修改giteecoderesponsevo类" aria-hidden="true">#</a> 5、修改<code>GiteeCodeResponseVo</code>类</h5><h6 id="方法一-不推荐" tabindex="-1"><a class="header-anchor" href="#方法一-不推荐" aria-hidden="true">#</a> 方法一（不推荐）</h6><p>可以将<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.vo.GiteeCodeResponseVo</code>类的字段都修改为<code>蛇形命名法</code>，不过很明显不符合<code>java</code>代码规范</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiteeCodeResponseVo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> access_token<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> token_type<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expires_in<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refresh_token<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> created_at<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.5.1.png" alt="image-20220806210726716" tabindex="0" loading="lazy"><figcaption>image-20220806210726716</figcaption></figure><h6 id="方法二-推荐" tabindex="-1"><a class="header-anchor" href="#方法二-推荐" aria-hidden="true">#</a> 方法二（推荐）</h6><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.vo.GiteeCodeResponseVo</code>类上添加<code>@JsonNaming(value = PropertyNamingStrategy.SnakeCaseStrategy.class)</code>注解，指明<code>json</code>是采用蛇形命名法，<code>java</code>实体类使用<code>驼峰命名法</code>来进行转换</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">PropertyNamingStrategy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonNaming</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@JsonNaming</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>SnakeCaseStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiteeCodeResponseVo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tokenType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expiresIn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> createdAt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.5.2.png" alt="image-20220807091632695" tabindex="0" loading="lazy"><figcaption>image-20220807091632695</figcaption></figure><h5 id="_6、测试" tabindex="-1"><a class="header-anchor" href="#_6、测试" aria-hidden="true">#</a> 6、测试</h5><p>再次以<code>debug</code>方式运行<code>GulimallAuthServerApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>gitee</code>图标，然后点击<code>同意授权</code>，切换到<code>IDEA</code>，点击<code>Step Over F8</code>执行完根据<code>code</code>换取<code>token</code>的请求，可以看到返回的数据已经成功封装到<code>GiteeCodeResponseVo</code>类里了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.3.6.png" alt="image-20220806210625293" tabindex="0" loading="lazy"><figcaption>image-20220806210625293</figcaption></figure><h4 id="_4、完善gitee登录逻辑" tabindex="-1"><a class="header-anchor" href="#_4、完善gitee登录逻辑" aria-hidden="true">#</a> 4、完善<code>gitee</code>登录逻辑</h4><h5 id="_1、封装giee用户信息" tabindex="-1"><a class="header-anchor" href="#_1、封装giee用户信息" aria-hidden="true">#</a> 1、封装<code>giee</code>用户信息</h5><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.vo.GiteeTokenResponseVo</code>类，用于封装用户信息（这里图省事就不写驼峰命名法了）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiteeTokenResponseVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> login<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> html_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> followers_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> following_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> gists_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starred_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> subscriptions_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> organizations_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> repos_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> events_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> received_events_url<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> blog<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> weibo<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> bio<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> public_repos<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> public_gists<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> followers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> following<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> stared<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> watched<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> created_at<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updated_at<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.1.1.png" alt="image-20220806211847697" tabindex="0" loading="lazy"><figcaption>image-20220806211847697</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl</code>类里的<code>getGiteeUserInfo</code>方法的<code>ResponseEntity&lt;GiteeTokenResponseVo&gt; response = restTemplate.getForEntity(url, GiteeTokenResponseVo.class, accessToken);</code>这一行打上断点。以<code>debug</code>方式运行<code>GulimallAuthServerApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>gitee</code>图标，然后点击<code>同意授权</code>，切换到<code>IDEA</code>，点击<code>Step Over F8</code>执行完根据<code>token</code>换取用户信息的请求，可以看到返回的数据已经封装到<code>GiteeTokenResponseVo</code>类里了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.1.2.png" alt="image-20220806212041987" tabindex="0" loading="lazy"><figcaption>image-20220806212041987</figcaption></figure><h5 id="_2、编写giteelogin接口" tabindex="-1"><a class="header-anchor" href="#_2、编写giteelogin接口" aria-hidden="true">#</a> 2、编写<code>giteeLogin</code>接口</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>包里新建<code>Oauth2GiteeLoginTo</code>类，用于传递获取到的<code>token</code>数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Oauth2GiteeLoginTo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tokenType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expiresIn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatarUrl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> createdAt<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.1.png" alt="image-20220807105520842" tabindex="0" loading="lazy"><figcaption>image-20220807105520842</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加<code>通过gitee登录失败</code>的枚举</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 通过gitee登录失败
 */</span>
<span class="token function">GITEE_LOGIN_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">15004</span><span class="token punctuation">,</span><span class="token string">&quot;通过gitee登录失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.2.png" alt="image-20220807112541519" tabindex="0" loading="lazy"><figcaption>image-20220807112541519</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.controller.MemberController</code>类里添加<code>giteeLogin</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/giteeLogin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Oauth2GiteeLoginTo</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">MemberEntity</span> entity <span class="token operator">=</span> memberService<span class="token punctuation">.</span><span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">GITEE_LOGIN_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.3.png" alt="image-20220807112628986" tabindex="0" loading="lazy"><figcaption>image-20220807112628986</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.MemberService</code>接口里添加<code>giteeLogin</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">MemberEntity</span> <span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token class-name">Oauth2GiteeLoginTo</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.4.png" alt="image-20220807112704285" tabindex="0" loading="lazy"><figcaption>image-20220807112704285</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service</code>包里新建<code>OauthGiteeService</code>接口，在<code>OauthGiteeService</code>接口里添加<code>getMemberId</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OauthGiteeEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IService</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OauthGiteeService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OauthGiteeEntity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 根据gitee的Id查询MemberId
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getMemberId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.5.png" alt="image-20220807095734455" tabindex="0" loading="lazy"><figcaption>image-20220807095734455</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.dao</code>包里添加<code>OauthGiteeDao</code>接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OauthGiteeEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">BaseMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OauthGiteeDao</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OauthGiteeEntity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.6.png" alt="image-20220807100029698" tabindex="0" loading="lazy"><figcaption>image-20220807100029698</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl</code>包里新建<code>OauthGiteeServiceImpl</code>类，实现抽象的<code>getMemberId</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">OauthGiteeDao</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OauthGiteeEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OauthGiteeService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OauthGiteeServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OauthGiteeDao</span><span class="token punctuation">,</span> <span class="token class-name">OauthGiteeEntity</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">OauthGiteeService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getMemberId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OauthGiteeEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OauthGiteeEntity</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">OauthGiteeEntity</span><span class="token operator">::</span><span class="token function">getMemberId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OauthGiteeEntity</span> oauthGiteeEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oauthGiteeEntity<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> oauthGiteeEntity<span class="token punctuation">.</span><span class="token function">getMemberId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.2.7.png" alt="image-20220807100732410" tabindex="0" loading="lazy"><figcaption>image-20220807100732410</figcaption></figure><h5 id="_3、添加sourcetype枚举" tabindex="-1"><a class="header-anchor" href="#_3、添加sourcetype枚举" aria-hidden="true">#</a> 3、添加<code>SourceType</code>枚举</h5><p>可以使用枚举来判断<code>SourceType</code>(用户来源)，在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member</code>包里新建<code>constant</code>文件夹，在<code>constant</code>文件夹里新建<code>SourceType</code>枚举类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnumValue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonValue</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">SourceType</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     *
     */</span>
    <span class="token function">UN_KNOW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;未知方式&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 用户通过本系统注册
     */</span>
    <span class="token function">REGISTER</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;注册&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 通过Gitte授权登录
     */</span>
    <span class="token function">GITEE_LOGIN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;gitee登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 通过github授权登录
     */</span>
    <span class="token function">GITHUB_LOGIN</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;github登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据sourceType的值向数据库中存储
     */</span>
    <span class="token annotation punctuation">@EnumValue</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> sourceType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * JSON通过该值序列化（可用用在可以用在get方法或者属性字段上，一个类只能用一个，序列化只包含该值）
     */</span>
    <span class="token annotation punctuation">@JsonValue</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token class-name">SourceType</span><span class="token punctuation">(</span><span class="token keyword">int</span> sourceType<span class="token punctuation">,</span><span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sourceType <span class="token operator">=</span> sourceType<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sourceType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSourceType</span><span class="token punctuation">(</span><span class="token keyword">int</span> sourceType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sourceType <span class="token operator">=</span> sourceType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> description<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.3.1.png" alt="image-20220807105110164" tabindex="0" loading="lazy"><figcaption>image-20220807105110164</figcaption></figure><p>可以使用如下方式配置<code>扫描枚举</code>(只需配置一种即可)，使用方式一可以在指定包下使用枚举、使用方式二可以全局使用枚举，但还需配置<code>mybatisPlusPropertiesCustomizer</code></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token important">*:/mapper/**/*.xml</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
      <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.atguigu.gulimall.member.entity
  <span class="token comment">#方式一：仅配置指定包内的枚举类使用 MybatisEnumTypeHandler</span>
  <span class="token comment">#支持统配符 * 或者 ; 分割</span>
  <span class="token key atrule">type-enums-package</span><span class="token punctuation">:</span> com.atguigu.gulimall.member.constant
  <span class="token comment">#方式二：全局 修改 mybatis 使用的 EnumTypeHandler(还需配置mybatisPlusPropertiesCustomizer)</span>
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">default-enum-type-handler</span><span class="token punctuation">:</span> org.apache.ibatis.type.EnumTypeHandler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.3.2.png" alt="image-20220807151436234" tabindex="0" loading="lazy"><figcaption>image-20220807151436234</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.entity.MemberEntity</code>实体类里，修改<code>sourceType</code>字段的类型，改为<code>SourceType</code>枚举类型</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户来源
 */</span>
<span class="token keyword">private</span> <span class="token class-name">SourceType</span> sourceType<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.3.3.png" alt="image-20220807105315893" tabindex="0" loading="lazy"><figcaption>image-20220807105315893</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类里添加<code>giteeLogin</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * gitee登录
 * <span class="token keyword">@param</span> <span class="token parameter">to</span>
 */</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MemberEntity</span> <span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token class-name">Oauth2GiteeLoginTo</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> memberId <span class="token operator">=</span> oauthGiteeService<span class="token punctuation">.</span><span class="token function">getMemberId</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//没有注册</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memberId<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        memberEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memberEntity<span class="token punctuation">.</span><span class="token function">setSourceType</span><span class="token punctuation">(</span><span class="token class-name">SourceType</span><span class="token punctuation">.</span><span class="token constant">GITEE_LOGIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memberEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memberEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MemberLevelEntity</span> memberLevelEntity <span class="token operator">=</span> memberLevelDao<span class="token punctuation">.</span><span class="token function">getDefaultLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memberEntity<span class="token punctuation">.</span><span class="token function">setLevelId</span><span class="token punctuation">(</span>memberLevelEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OauthGiteeEntity</span> oauthGiteeEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OauthGiteeEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">,</span>oauthGiteeEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oauthGiteeEntity<span class="token punctuation">.</span><span class="token function">setMemberId</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oauthGiteeService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>oauthGiteeEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        memberEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> memberEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.4.3.4.png" alt="image-20220807113100785" tabindex="0" loading="lazy"><figcaption>image-20220807113100785</figcaption></figure><h4 id="_5、调用member登录服务" tabindex="-1"><a class="header-anchor" href="#_5、调用member登录服务" aria-hidden="true">#</a> 5、调用<code>member</code>登录服务</h4><h5 id="_1、修改auth-server模块的gitee登录" tabindex="-1"><a class="header-anchor" href="#_1、修改auth-server模块的gitee登录" aria-hidden="true">#</a> 1、修改<code>auth-server</code>模块的<code>gitee</code>登录</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.feign.MemberFeignService</code>接口里添加<code>giteeLogin</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/member/member/giteeLogin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Oauth2GiteeLoginTo</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.1.1.png" alt="image-20220807115217403" tabindex="0" loading="lazy"><figcaption>image-20220807115217403</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>包里新建<code>MemberEntityTo</code>类，复制<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.entity.MemberEntity</code>实体类的字段，把<code>sourceType</code>的类型由<code>SourceType</code>改为<code>String</code>(<code>SourceType</code>类的<code>description</code>字段添加了<code>@JsonValue</code>注解，只会显示该字段)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberEntityTo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 会员等级id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> levelId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 用户名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 密码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 昵称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 手机号码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 邮箱
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 头像
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> header<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 性别
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> gender<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 生日
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> birth<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 所在城市
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 职业
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> job<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 个性签名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sign<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 用户来源
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sourceType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 积分
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> integration<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 成长值
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> growth<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 启用状态
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 注册时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.1.2.png" alt="image-20220807113843737" tabindex="0" loading="lazy"><figcaption>image-20220807113843737</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl</code>类的<code>giteeRegister</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MemberEntityTo</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">GiteeCodeResponseVo</span> giteeCodeResponseVo <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>giteeCodeResponseVo<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>giteeCodeResponseVo<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;通过gitee获取用户token失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">GiteeTokenResponseVo</span> giteeTokenResponseVo <span class="token operator">=</span> <span class="token function">getGiteeUserInfo</span><span class="token punctuation">(</span>giteeCodeResponseVo<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>giteeTokenResponseVo<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> giteeTokenResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;通过gitee获取用户基本失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Oauth2GiteeLoginTo</span> <span class="token keyword">to</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Oauth2GiteeLoginTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>giteeCodeResponseVo<span class="token punctuation">,</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>giteeTokenResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">setAvatarUrl</span><span class="token punctuation">(</span>giteeTokenResponseVo<span class="token punctuation">.</span><span class="token function">getAvatar_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>giteeTokenResponseVo<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Object</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">MemberEntityTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;社交登录失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;社交登录失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.1.3.png" alt="image-20220807114326306" tabindex="0" loading="lazy"><figcaption>image-20220807114326306</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service.OAuth2Service</code>接口的<code>giteeRegister</code>方法的返回类型为<code>MemberEntityTo</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">MemberEntityTo</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.1.4.png" alt="image-20220807114355606" tabindex="0" loading="lazy"><figcaption>image-20220807114355606</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.OAuth2Controller</code>类的<code>giteeRegister</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/gitee/success&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> oAuth2Service<span class="token punctuation">.</span><span class="token function">giteeRegister</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;第三方登录失败 :{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.1.5.png" alt="image-20220807114528553" tabindex="0" loading="lazy"><figcaption>image-20220807114528553</figcaption></figure><h5 id="_2、测试-3" tabindex="-1"><a class="header-anchor" href="#_2、测试-3" aria-hidden="true">#</a> 2、测试</h5><p>给<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl</code>类的以下代码行打上断点</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">giteeLogin</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GiteeCodeResponseVo</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token class-name">GiteeCodeResponseVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GiteeTokenResponseVo</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">GiteeTokenResponseVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>给<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法的<code>this.save(memberEntity);</code>这一行打上断点，以<code>debug</code>方式运行<code>GulimallAuthServerApplication</code>服务和<code>GulimallMemberApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>gitee</code>图标，然后点击<code>同意授权</code>，切换到<code>IDEA</code>，此时就来到了<code>gulimall-auth-server</code>服务的<code>com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl</code>类</p><p>点击<code>Step Over F8</code>执完<code>ResponseEntity&lt;GiteeCodeResponseVo&gt; response = restTemplate.postForEntity(url,null,GiteeCodeResponseVo.class,map);</code>这一行，可以看到返回的数据已成功封装到<code>GiteeCodeResponseVo</code>实体类里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.2.1.png" alt="image-20220807150729814" tabindex="0" loading="lazy"><figcaption>image-20220807150729814</figcaption></figure><p>点击<code>Resume Program F9</code>执行到下一处断点，点击<code>Step Over F8</code>执完<code>ResponseEntity&lt;GiteeTokenResponseVo&gt; response = restTemplate.getForEntity(url, GiteeTokenResponseVo.class, accessToken);</code>这一行，可以看到返回的数据已成功封装到<code>GiteeTokenResponseVo</code>实体类里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.2.2.png" alt="image-20220807150824635" tabindex="0" loading="lazy"><figcaption>image-20220807150824635</figcaption></figure><p>点击<code>Resume Program F9</code>执行到下一处断点，点击<code>Step Over F8</code>执完<code>R r = memberFeignService.giteeLogin(to);</code>这一行，可以看到发送请求的数据已成功封装到<code>Oauth2GiteeLoginTo</code>实体类里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.2.3.png" alt="image-20220807150853771" tabindex="0" loading="lazy"><figcaption>image-20220807150853771</figcaption></figure><p>点击<code>Step Over F8</code>就进入到了<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法，可以看到此时已正确封装了<code>MemberEntity</code>实体类数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.2.4.png" alt="image-20220807151002732" tabindex="0" loading="lazy"><figcaption>image-20220807151002732</figcaption></figure><p>再点击<code>Step Over F8</code>就报错了，说的是<code>source_type</code>列的值不能为<code>GITEE_LOGIN</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>### SQL: INSERT INTO ums_member  ( create_time, source_type, level_id,  nickname )  VALUES  ( ?, ?, ?,  ? )
### Cause: java.sql.SQLException: Incorrect integer value: &#39;GITEE_LOGIN&#39; for column &#39;source_type&#39; at row 1
; uncategorized SQLException; SQL state [HY000]; error code [1366]; Incorrect integer value: &#39;GITEE_LOGIN&#39; for column &#39;source_type&#39; at row 1; nested exception is java.sql.SQLException: Incorrect integer value: &#39;GITEE_LOGIN&#39; for column &#39;source_type&#39; at row 1] with root cause
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.2.5.png" alt="image-20220807151224876" tabindex="0" loading="lazy"><figcaption>image-20220807151224876</figcaption></figure><h5 id="_3、修改代码再次测试" tabindex="-1"><a class="header-anchor" href="#_3、修改代码再次测试" aria-hidden="true">#</a> 3、修改代码再次测试</h5><h6 id="方法一" tabindex="-1"><a class="header-anchor" href="#方法一" aria-hidden="true">#</a> 方法一</h6><p>注释掉<code>gulimall-member</code>模块的<code>src/main/resources/application.yml</code>文件中为使用枚举而使用方式二的配置，只保留方式一的配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.1.1.png" alt="image-20220807152047244" tabindex="0" loading="lazy"><figcaption>image-20220807152047244</figcaption></figure><p>重启<code>GulimallMemberApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>gitee</code>图标，然后点击<code>同意授权</code>，切换到<code>IDEA</code>，执行完<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法的<code>this.save(memberEntity);</code>这一行，可以看到引进保存完数据了，此时返回的<code>id</code>为<code>1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.1.2.png" alt="image-20220807151923689" tabindex="0" loading="lazy"><figcaption>image-20220807151923689</figcaption></figure><p>点击<code>Resume Program F9</code>本应该执行完测试，但却停在了<code>oauthGiteeService.save(oauthGiteeEntity);</code>这一行，查看<code>oauthGiteeEntity</code>实体类的数据，可以看到也正常封装了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.1.3.png" alt="image-20220807153319902" tabindex="0" loading="lazy"><figcaption>image-20220807153319902</figcaption></figure><p>再点击<code>Step Over F8</code>就来到捕获异常的类了，证明保存<code>oauthGiteeEntity</code>实体类的数据出错了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.1.4.png" alt="image-20220807153348725" tabindex="0" loading="lazy"><figcaption>image-20220807153348725</figcaption></figure><p>点击<code>Resume Program F9</code>执行完异常处理类，可以看到控制台报了如下错误：<code>id</code>没有一个默认值</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>### SQL: INSERT INTO oauth_gitee  ( expires_in, created_at, avatar_url, scope, created_time, token_type, access_token, refresh_token, member_id )  VALUES  ( ?, ?, ?, ?, ?, ?, ?, ?, ? )
### Cause: java.sql.SQLException: Field &#39;id&#39; doesn&#39;t have a default value
; Field &#39;id&#39; doesn&#39;t have a default value; nested exception is java.sql.SQLException: Field &#39;id&#39; doesn&#39;t have a default value] with root cause

java.sql.SQLException: Field &#39;id&#39; doesn&#39;t have a default value
	at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:129) ~[mysql-connector-java-8.0.17.jar:8.0.17]
	at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:97) ~[mysql-connector-java-8.0.17.jar:8.0.17]
	at com.mysql.cj.jdbc.exceptions.SQLExceptionsMapping.translateException(SQLExceptionsMapping.java:122) ~[mysql-connector-java-8.0.17.jar:8.0.17]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.1.5.png" alt="image-20220807153427809" tabindex="0" loading="lazy"><figcaption>image-20220807153427809</figcaption></figure><h6 id="方法二" tabindex="-1"><a class="header-anchor" href="#方法二" aria-hidden="true">#</a> 方法二</h6><p>注释掉<code>gulimall-member</code>模块的<code>src/main/resources/application.yml</code>文件中为使用枚举而使用方式一的配置，只保留方式二的配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.2.1.png" alt="image-20220807152240568" tabindex="0" loading="lazy"><figcaption>image-20220807152240568</figcaption></figure><p>可以看到如果不配置<code>MybatisPlusPropertiesCustomizer</code>，执行完<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法的<code>this.save(memberEntity);</code>这一行还是会报错</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.2.2.png" alt="image-20220807152244248" tabindex="0" loading="lazy"><figcaption>image-20220807152244248</figcaption></figure><p>点击<code>Resume Program F9</code>执行完异常处理类，可以看到控制台还是报了最开始的错误：<code>source_type</code>列的值不能为<code>GITEE_LOGIN</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.2.3.png" alt="image-20220807152316550" tabindex="0" loading="lazy"><figcaption>image-20220807152316550</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>src/main/resources/application.yml</code>配置文件的方式二添加注释</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token important">*:/mapper/**/*.xml</span>
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
      <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.atguigu.gulimall.member.entity
  <span class="token comment">#方式一：仅配置指定包内的枚举类使用 MybatisEnumTypeHandler</span>
  <span class="token comment"># 支持统配符 * 或者 ; 分割</span>
  <span class="token comment">#type-enums-package: com.atguigu.gulimall.member.constant</span>
  <span class="token comment">#方式二：全局 修改 mybatis 使用的 EnumTypeHandler(还需配置mybatisPlusPropertiesCustomizer)</span>
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">default-enum-type-handler</span><span class="token punctuation">:</span> org.apache.ibatis.type.EnumTypeHandler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.2.4.png" alt="image-20220807152820815" tabindex="0" loading="lazy"><figcaption>image-20220807152820815</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.config</code>包里新建<code>MybatisPlusAutoConfiguration</code>类，用于添加全局枚举配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">MybatisPlusPropertiesCustomizer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MybatisConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">GlobalConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>handlers<span class="token punctuation">.</span></span><span class="token class-name">MybatisEnumTypeHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisPlusAutoConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MybatisPlusPropertiesCustomizer</span> <span class="token function">mybatisPlusPropertiesCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> properties <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">GlobalConfig</span> globalConfig <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getGlobalConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            globalConfig<span class="token punctuation">.</span><span class="token function">setBanner</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MybatisConfiguration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MybatisConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configuration<span class="token punctuation">.</span><span class="token function">setDefaultEnumTypeHandler</span><span class="token punctuation">(</span><span class="token class-name">MybatisEnumTypeHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            properties<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.2.5.png" alt="image-20220807152813896" tabindex="0" loading="lazy"><figcaption>image-20220807152813896</figcaption></figure><p>再次执行完<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法的<code>this.save(memberEntity);</code>这一行，这次就可以看到成功保存数据了，此时也返回了刚刚保存返回的<code>id</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.3.2.6.png" alt="image-20220807152650962" tabindex="0" loading="lazy"><figcaption>image-20220807152650962</figcaption></figure><h5 id="_4、修改代码再次测试" tabindex="-1"><a class="header-anchor" href="#_4、修改代码再次测试" aria-hidden="true">#</a> 4、修改代码再次测试</h5><p>在<code>gulimall-member</code>模块里，修改<code>com.atguigu.gulimall.member.entity.OauthGiteeEntity</code>类的<code>id</code>字段的<code>@TableId</code>注解，添加<code>type = IdType.INPUT</code>指明这里的<code>id</code>是自己程序输入的，而非自动递增</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">INPUT</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.1.png" alt="image-20220807154012178" tabindex="0" loading="lazy"><figcaption>image-20220807154012178</figcaption></figure><p>然后突然发现忘记设置头像了，可以看到<code>gulimall_ums</code>数据库的<code>ums_member</code>表里的<code>header</code>字段为用户的头像</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.2.png" alt="image-20220807154101671" tabindex="0" loading="lazy"><figcaption>image-20220807154101671</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法的<code>this.save(memberEntity);</code>这一行的上面添加如下代码，用于设置头像</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>memberEntity<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getAvatarUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.3.png" alt="image-20220807154155577" tabindex="0" loading="lazy"><figcaption>image-20220807154155577</figcaption></figure><p>重启<code>GulimallMemberApplication</code>服务，在<code>http://auth.gulimall.com/login.html</code>页面里，点击<code>gitee</code>图标，然后点击<code>同意授权</code>，切换到<code>IDEA</code>，执行完<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>giteeLogin</code>方法的<code>oauthGiteeService.save(oauthGiteeEntity);</code>这一行，可以看到此时<code>memberEntity</code>对象和<code>oauthGiteeEntity</code>对象的数据都封装正确</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.4.png" alt="image-20220807154700666" tabindex="0" loading="lazy"><figcaption>image-20220807154700666</figcaption></figure><p>点击<code>Step Over F8</code>执行完<code>oauthGiteeService.save(oauthGiteeEntity);</code>这一行，此时就不报错了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.5.png" alt="image-20220807154723745" tabindex="0" loading="lazy"><figcaption>image-20220807154723745</figcaption></figure><p>此时切换到<code>GulimallAuthServerApplication</code>服务的控制台可以看到报了读取超时的异常，在调试的过程中很容易出现该异常，这是正常的</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>detailMessage = “Read timed out executing POST http://gulimall-member/member/member/giteeLogin”
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.6.png" alt="image-20220807154832750" tabindex="0" loading="lazy"><figcaption>image-20220807154832750</figcaption></figure><p>打开<code>Navicat</code>软件，可以看到<code>gulimall_ums</code>数据库的<code>ums_member</code>表里已经有刚刚授权的<code>gitee</code>用户信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.7.png" alt="image-20220807154956105" tabindex="0" loading="lazy"><figcaption>image-20220807154956105</figcaption></figure><p>切换到<code>gulimall_ums</code>数据库的<code>oauth_gitee</code>表，表里面已经有刚刚授权的用户信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.4.8.png" alt="image-20220807154952161" tabindex="0" loading="lazy"><figcaption>image-20220807154952161</figcaption></figure><h5 id="_5、整体测试" tabindex="-1"><a class="header-anchor" href="#_5、整体测试" aria-hidden="true">#</a> 5、整体测试</h5><p>取消<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl</code>类和<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类上的所有断点，重新运行<code>GulimallAuthServerApplication</code>服务和<code>GulimallMemberApplication</code>服务,可以看到使用<code>gitee</code>登录正常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://auth.gulimall.com/login.html

https://gitee.com/login?redirect_to_url=https%3A%2F%2Fgitee.com%2Foauth%2Fauthorize%3Fclient_id%3D065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d%26redirect_uri%3Dhttp%3A%2F%2Fgulimall.com%2Foauth2.0%2Fgitee%2Fsuccess%26response_type%3Dcode

http://gulimall.com/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.5.gif" alt="GIF 2022-8-7 15-56-48" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-7 15-56-48</figcaption></figure><h5 id="_6、其他问题" tabindex="-1"><a class="header-anchor" href="#_6、其他问题" aria-hidden="true">#</a> 6、其他问题</h5><p>由于回调为<code>http://gulimall.com/oauth2.0/gitee/success</code>，转给了<code>gulimall-auth-server</code>服务，所以回调的<code>http://gulimall.com</code>会有<code>jsonId</code>，如果回调为<code>http://auth.gulimall.com/oauth2.0/gitee/success</code>则只有<code>http://auth.gulimall.com</code>会有<code>jsonId</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.6.1.png" alt="image-20220807160743109" tabindex="0" loading="lazy"><figcaption>image-20220807160743109</figcaption></figure><p>回调为<code>http://gulimall.com/oauth2.0/gitee/success</code>时，<code>http://auth.gulimall.com</code>域名下没有以<code>jsonId</code>为<code>key</code>的<code>cookie</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.6.2.png" alt="image-20220807160024967" tabindex="0" loading="lazy"><figcaption>image-20220807160024967</figcaption></figure><p>回调为<code>http://gulimall.com/oauth2.0/gitee/success</code>时，<code>http://gulimall.com</code>域名下有以<code>jsonId</code>为<code>key</code>的<code>cookie</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.6.3.png" alt="image-20220807160028148" tabindex="0" loading="lazy"><figcaption>image-20220807160028148</figcaption></figure><p>虽然在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.OAuth2Controller</code>类的<code>giteeRegister</code>方法里可以设置<code>cookie</code>的作用范围,但默认只能在本域(不能为其父域名下)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/gitee/success&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> oAuth2Service<span class="token punctuation">.</span><span class="token function">giteeRegister</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//session.setAttribute(&quot;data&quot;,memberEntityTo);</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;第三方登录失败 :{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.6.4.png" alt="image-20220807162107754" tabindex="0" loading="lazy"><figcaption>image-20220807162107754</figcaption></figure><p>如果回调为<code>http://auth.gulimall.com/oauth2.0/gitee/success</code>们可以修改<code>jsonId</code>的<code>Doman</code>作用域，将其修改为<code>gulimall.com</code>，但是这样<code>http://auth.gulimall.com</code>域名下又没有<code>jsonId</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.6.5.png" alt="image-20220807162042047" tabindex="0" loading="lazy"><figcaption>image-20220807162042047</figcaption></figure><p>不推荐这样做，所以还是改回来为妙</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/gitee/success&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> oAuth2Service<span class="token punctuation">.</span><span class="token function">giteeRegister</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Cookie cookie = new Cookie(&quot;data&quot;,memberEntityTo.toString());</span>
        <span class="token comment">//cookie.setPath(&quot;/&quot;);</span>
        <span class="token comment">//response.addCookie(cookie);</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;第三方登录失败 :{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.5.6.6.png" alt="image-20220807165342333" tabindex="0" loading="lazy"><figcaption>image-20220807165342333</figcaption></figure><h4 id="_6、gitee参考文档" tabindex="-1"><a class="header-anchor" href="#_6、gitee参考文档" aria-hidden="true">#</a> 6、<code>gitee</code>参考文档</h4><p>参考文档： https://gitee.com/api/v5/oauth_doc#/</p><p>API 使用条款</p><ul><li>OSCHINA 用户是资源的拥有者，需尊重和保护用户的权益。</li><li>不能在应用中使用 OSCHINA 的名称。</li><li>未经用户允许，不准爬取或存储用户的资源。</li><li>禁止滥用 API，请求频率过快将导致请求终止。</li></ul><p>OAuth2 认证基本流程</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.6.1.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>OAuth2 获取 AccessToken 认证步骤</p><ol><li>授权码模式</li></ol>`,549),f=t(`<li><p>应用通过 浏览器 或 Webview 将用户引导到码云三方认证页面上（ <strong>GET请求</strong> ）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/authorize?client_id={client_id}&amp;redirect_uri={redirect_uri}&amp;response_type=code
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>用户对应用进行授权 注意: 如果之前已经授权过的需要跳过授权页面，需要在上面第一步的 URL 加上 scope 参数，且 scope 的值需要和用户上次授权的勾选的一致。如用户在上次授权了user_info、projects以及pull_requests。则步骤A 中 GET 请求应为：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/authorize?client_id={client_id}&amp;redirect_uri={redirect_uri}&amp;response_type=code&amp;scope=user_info%20projects%20pull_requests
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>码云认证服务器通过回调地址{redirect_uri}将 用户授权码 传递给 应用服务器 或者直接在 Webview 中跳转到携带 用户授权码的回调地址上，Webview 直接获取code即可（{redirect_uri}?code=abc&amp;state=xyz)</p></li><li><p>应用服务器 或 Webview 使用 access_token API 向 码云认证服务器发送post请求传入 用户授权码 以及 回调地址（ <strong>POST请求</strong> ）<strong>注：请求过程建议将 client_secret 放在 Body 中传值，以保证数据安全。</strong>\`\`</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/token?grant_type=authorization_code&amp;code={code}&amp;client_id={client_id}&amp;redirect_uri={redirect_uri}&amp;client_secret={client_secret}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>码云认证服务器返回 access_token 应用通过 access_token 访问 Open API 使用用户数据。</p></li><li><p>当 access_token 过期后（有效期为一天），你可以通过以下 refresh_token 方式重新获取 access_token（ <strong>POST请求</strong> ）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://gitee.com/oauth/token?grant_type=refresh_token&amp;refresh_token={refresh_token}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li>`,6),h={href:"https://gitee.com/oschina/git-osc/issues/IDBSA",target:"_blank",rel:"noopener noreferrer"},y=t(`<ol start="2"><li>密码模式</li></ol><ul><li><p>用户向客户端提供邮箱地址和密码。客户端将邮箱地址和密码发给码云认证服务器，并向码云认证服务器请求令牌。（ <strong>POST请求。Content-Type: application/x-www-form-urlencoded</strong> ）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>curl -X POST --data-urlencode &quot;grant_type=password&quot; --data-urlencode &quot;username={email}&quot; --data-urlencode &quot;password={password}&quot; --data-urlencode &quot;client_id={client_id}&quot; --data-urlencode &quot;client_secret={client_secret}&quot; --data-urlencode &quot;scope=projects user_info issues notes&quot; https://gitee.com/oauth/token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>scope表示权限范围，有以下选项，请求时使用空格隔开</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>user_info projects pull_requests issues notes keys hook groups gists enterprises
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>码云认证服务器返回 access_token 应用通过 access_token 访问 Open API 使用用户数据。</p></li></ul><p>创建应用流程</p>`,3),w={href:"https://gitee.com/profile",target:"_blank",rel:"noopener noreferrer"},q={href:"https://gitee.com/oauth/applications",target:"_blank",rel:"noopener noreferrer"},x=n("img",{src:"https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.6.2.png",alt:"img",loading:"lazy"},null,-1),S=n("li",null,[s("填写应用相关信息，勾选应用所需要的权限。其中: "),n("strong",null,"回调地址"),s("是用户授权后，码云回调到应用，并且回传授权码的地址。 "),n("img",{src:"https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.6.3.png",alt:"img",loading:"lazy"})],-1),z=n("li",null,[s("创建成功后，会生成 "),n("strong",null,"Cliend ID"),s(" 和 "),n("strong",null,"Client Secret"),s("。他们将会在上述OAuth2 认证基本流程用到。 "),n("img",{src:"https://gitlab.com/apzs/image/-/raw/master/image/5.7.4.6.4.png",alt:"img",loading:"lazy"})],-1),j=n("h3",{id:"_5-7-5、json格式化问题",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_5-7-5、json格式化问题","aria-hidden":"true"},"#"),s(" 5.7.5、Json格式化问题")],-1),I=n("p",null,[s("如何将使用"),n("code",null,"蛇形命名法"),s("的"),n("code",null,"json"),s("数据与使用"),n("code",null,"驼峰命名法"),s("的"),n("code",null,"java"),s("实体类进行互转？下面提供三种方式")],-1),_={href:"https://github.com/alibaba/fastjson/wiki/PropertyNamingStrategy_cn",target:"_blank",rel:"noopener noreferrer"},C=t(`<h4 id="_1、方式一-官方做法" tabindex="-1"><a class="header-anchor" href="#_1、方式一-官方做法" aria-hidden="true">#</a> 1、方式一（官方做法）</h4><h5 id="_1-简介" tabindex="-1"><a class="header-anchor" href="#_1-简介" aria-hidden="true">#</a> 1. 简介</h5><p>fastjson缺省使用CamelCase，在1.2.15版本之后，fastjson支持配置PropertyNamingStrategy，支持如下四种:</p><table><thead><tr><th>name</th><th>demo</th></tr></thead><tbody><tr><td>CamelCase</td><td>persionId</td></tr><tr><td>PascalCase</td><td>PersonId</td></tr><tr><td>SnakeCase</td><td>person_id</td></tr><tr><td>KebabCase</td><td>person-id</td></tr></tbody></table><h5 id="_2-serialization-and-parser" tabindex="-1"><a class="header-anchor" href="#_2-serialization-and-parser" aria-hidden="true">#</a> 2. Serialization and Parser</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">SerializeConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerializeConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生产环境中，config要做singleton处理，要不然会存在性能问题</span>
config<span class="token punctuation">.</span>propertyNamingStrategy <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>SnakeCase</span><span class="token punctuation">;</span>

<span class="token class-name">Model</span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
model<span class="token punctuation">.</span>personId <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;{\\&quot;person_id\\&quot;:1001}&quot;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ParserConfig</span> parserConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParserConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生产环境中，parserConfig要做singleton处理，要不然会存在性能问题</span>
parserConfig<span class="token punctuation">.</span>propertyNamingStrategy <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>SnakeCase</span><span class="token punctuation">;</span>
<span class="token class-name">Model</span> model2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token class-name">Model</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> parserConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>personId<span class="token punctuation">,</span> model2<span class="token punctuation">.</span>personId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-修改全局缺省的命名策略" tabindex="-1"><a class="header-anchor" href="#_3-修改全局缺省的命名策略" aria-hidden="true">#</a> 3. 修改全局缺省的命名策略</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">SerializeConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span>propertyNamingStrategy <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>PascalCase</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-基于jsontype配置propertynamingstrategy" tabindex="-1"><a class="header-anchor" href="#_4-基于jsontype配置propertynamingstrategy" aria-hidden="true">#</a> 4. 基于JSONType配置PropertyNamingStrategy</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_for_issue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Model</span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span>userId <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span>userName <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;{\\&quot;userName\\&quot;:\\&quot;test\\&quot;,\\&quot;user_id\\&quot;:1001}&quot;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Model</span> model2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token class-name">Model</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> model2<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> model2<span class="token punctuation">.</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 当某个字段有JSONField注解，JSONField中name属性不存在，并且类上有属性转换策略，
     * json属性名也要用类上的属性名转换策略为为准
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_when_JSONField_have_not_name_attr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ModelTwo</span> modelTwo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelTwo<span class="token punctuation">.</span>userId <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>
        modelTwo<span class="token punctuation">.</span>userName <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>modelTwo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;{\\&quot;userName\\&quot;:\\&quot;test\\&quot;,\\&quot;user_id\\&quot;:\\&quot;1001\\&quot;}&quot;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Model</span> model2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token class-name">Model</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> model2<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> model2<span class="token punctuation">.</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JSONType</span><span class="token punctuation">(</span>naming <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>SnakeCase</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> userName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JSONType</span><span class="token punctuation">(</span>naming <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>SnakeCase</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModelTwo</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 此字段准备序列化为字符串类型
         */</span>
        <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>serializeUsing <span class="token operator">=</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> userName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringSerializer</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectSerializer</span> <span class="token punctuation">{</span>

      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JSONSerializer</span> serializer<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Object</span> fieldName<span class="token punctuation">,</span> <span class="token class-name">Type</span> fieldType<span class="token punctuation">,</span> <span class="token keyword">int</span> features<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        serializer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、方式二-推荐" tabindex="-1"><a class="header-anchor" href="#_2、方式二-推荐" aria-hidden="true">#</a> 2、方式二（推荐）</h4><p>可以使用如下方法直接在当前实体使用，不需要配置（亲测可用）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@JsonNaming</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">PropertyNamingStrategy<span class="token punctuation">.</span>SnakeCaseStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GiteeCodeResponseVo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tokenType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expiresIn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> refreshToken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> scope<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> createdAt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、方式三-其他做法" tabindex="-1"><a class="header-anchor" href="#_3、方式三-其他做法" aria-hidden="true">#</a> 3、方式三（其他做法）</h4><p>可以参考如下链接，亲测可用，就是有点麻烦</p>`,15),T={href:"https://zhuanlan.zhihu.com/p/270875975",target:"_blank",rel:"noopener noreferrer"},R=t(`<h5 id="_1、导入依赖" tabindex="-1"><a class="header-anchor" href="#_1、导入依赖" aria-hidden="true">#</a> 1、导入依赖</h5><p>首先导入Pom依赖，Jackson的三个Jar包和FastJson（可不要，就是习惯了用而已）：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.0-rc1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-annotations<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.0-rc1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.0-rc1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.74<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2、需求" tabindex="-1"><a class="header-anchor" href="#_2、需求" aria-hidden="true">#</a> 2、需求</h5><p>我们模拟用户注册的场景，提交一系列基本信息，如：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jjn&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;org_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;01&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;org_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Class1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jjn@mail.ustc.edu.cn&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-11-01 09:11:03&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过接口处理之后生成的数据如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;update_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-11-01 22:06:45&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;create_time&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-11-01 09:11:03&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;registerTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-11-01 22:06:45&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jjn&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;org_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;01&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;registered&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;org_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Class1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jjn@mail.ustc.edu.cn&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么是如何实现的呢？其实主要就是Jackson Json库的几个注解，来看看吧~</p><ul><li>@JsonProperty</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Marker annotation that can be used to define a non-static
 * method as a &quot;setter&quot; or &quot;getter&quot; for a logical property
 * (depending on its signature),
 * or non-static object field to be used (serialized, deserialized) as
 * a logical property.
 *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * Default value (&quot;&quot;) indicates that the field name is used
 * as the property name without any modifications, but it
 * can be specified to non-empty value to specify different
 * name. Property name refers to name used externally, as
 * the field name in JSON objects.
 *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * Starting with Jackson 2.6 this annotation may also be
 * used to change serialization of <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">Enum</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> like so:
 *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>
<span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">MyEnum</span> <span class="token punctuation">{</span></span></span>
    <span class="token line"><span class="token code language-java"><span class="token punctuation">{</span><span class="token annotation punctuation">@literal</span> <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;theFirstValue&quot;</span><span class="token punctuation">)</span> <span class="token constant">THE_FIRST_VALUE</span><span class="token punctuation">,</span></span></span>
    <span class="token line"><span class="token code language-java"><span class="token punctuation">{</span><span class="token annotation punctuation">@literal</span> <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&quot;another_value&quot;</span><span class="token punctuation">)</span> <span class="token constant">ANOTHER_VALUE</span><span class="token punctuation">;</span></span></span>
<span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
 * as an alternative to using <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">JsonValue</span></span><span class="token punctuation">}</span> annotation.
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注释里面写的很清楚了，指定了value的值之后，在生成JSON的时候，会按value的值来。</p><ul><li>@JsonAlias</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Annotation that can be used to define one or more alternative names for
 * a property, accepted during deserialization as alternative to the official
 * name. Alias information is also exposed during POJO introspection, but has
 * no effect during serialization where primary name is always used.
 *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * Examples:
 *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>
 <span class="token code-section">*<span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Info</span> <span class="token punctuation">{</span></span></span>
 *  <span class="token line"><span class="token entity" title="@">&amp;#64;</span><span class="token code language-java"><span class="token class-name">JsonAlias</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Name&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>
 *  <span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></span></span>
 *<span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span>
 *</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token keyword">@since</span> 2.9
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3、实体类" tabindex="-1"><a class="header-anchor" href="#_3、实体类" aria-hidden="true">#</a> 3、实体类</h5><p>使用<code>@JsonProperty(value = &quot;user_name&quot;)</code>注解指定了<code>value</code>的值之后，在生成<code>JSON</code>的时候，会按<code>value</code>的值来</p><p><code>alias</code>的意思是别名，<code>value</code>值指定了之后，可以接受多种可能的赋值。使用<code>@JsonAlias(value = {&quot;user_name&quot;, &quot;userName&quot;})</code>注解后，<code>json</code>的<code>key</code>为<code>user_name</code>或<code>userName</code>时都能封装到<code>java</code>的<code>userName</code>字段</p><p>所以最后我们的用户实体类就会写成这样：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonAlias</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonFormat</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonProperty</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Builder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Jiang Jining
 * <span class="token keyword">@date</span> 2020/11/1 10:17
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user_name&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonAlias</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;user_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;org_id&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonAlias</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;org_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orgId&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orgId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;org_name&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonAlias</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;org_name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orgName&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orgName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonAlias</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;create_time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;createTime&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span> timezone <span class="token operator">=</span> <span class="token string">&quot;GMT+8&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;update_time&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonAlias</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;update_time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;updateTime&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span> timezone <span class="token operator">=</span> <span class="token string">&quot;GMT+8&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> registered<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span> timezone <span class="token operator">=</span> <span class="token string">&quot;GMT+8&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> registerTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回实体类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Builder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Jiang Jining
 * <span class="token keyword">@date</span> 2020/11/1 11:08
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Response</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">JSONObject</span> info<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Response</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Response</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4、service" tabindex="-1"><a class="header-anchor" href="#_4、service" aria-hidden="true">#</a> 4、service</h5><p>service接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Jiang Jining
 * <span class="token keyword">@date</span> 2020/11/1 11:12
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * Register user demo.
     *
     * <span class="token keyword">@param</span> <span class="token parameter">user</span> user param from front end
     * <span class="token keyword">@return</span> json object
     */</span>
    <span class="token class-name">JSONObject</span> <span class="token function">registerUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service接口实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UserService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Jiang Jining
 * <span class="token keyword">@date</span> 2020/11/1 11:12
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JSONObject</span> <span class="token function">registerUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setRegistered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setRegisterTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> string <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5、controller" tabindex="-1"><a class="header-anchor" href="#_5、controller" aria-hidden="true">#</a> 5、Controller</h5><p>最后的Controller实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Response</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>jjn<span class="token punctuation">.</span>demoproject<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UserService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">CrossOrigin</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Jiang Jining
 * <span class="token keyword">@date</span> 2020/11/1 11:06
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@CrossOrigin</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/api/user/register&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">userRegisterController</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">registerUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、方式四-亲测不可用" tabindex="-1"><a class="header-anchor" href="#_3、方式四-亲测不可用" aria-hidden="true">#</a> 3、方式四（亲测不可用）</h4><p>fastjson中的@JSONField注解（亲测不可用，也许是我技术不行吧）</p>`,31),E={href:"https://blog.csdn.net/y_bccl27/article/details/125376405",target:"_blank",rel:"noopener noreferrer"},O={href:"https://so.csdn.net/so/search?q=fastjson&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},A=t(`<div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.75<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JSONField中的name属性用来指定JSON串中key的名称</p><h5 id="_1-jsonfield作用在属性上" tabindex="-1"><a class="header-anchor" href="#_1-jsonfield作用在属性上" aria-hidden="true">#</a> 1.@JSONField作用在属性上</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;AGE&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> age<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>序列化测试：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Person</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Person</span> person<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，其输出结果为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;AGE&quot;</span><span class="token operator">:</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;userName&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>反序列化测试：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Person</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> jsonStr<span class="token operator">=</span><span class="token string">&quot;{\\&quot;AGE\\&quot;:\\&quot;20\\&quot;,\\&quot;userName\\&quot;:\\&quot;张三\\&quot;}&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJavaObject</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;json to bean：&quot;</span> <span class="token operator">+</span> person<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，其输出结果为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>json <span class="token keyword">to</span> <span class="token namespace">bean</span>：张三
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>@JSONField作用在Field时，其name不仅定义了输出的名称，同时也定义了输入key的名称</p><h5 id="_2-jsonfield作用在方法上" tabindex="-1"><a class="header-anchor" href="#_2-jsonfield作用在方法上" aria-hidden="true">#</a> 2.@JSONField作用在方法上</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> age<span class="token punctuation">;</span>
 
    <span class="token comment">// 针对的是序列化操作</span>
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 针对的是反序列化操作</span>
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;AGE&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;AGE&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Person</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 序列化</span>
        <span class="token class-name">Person</span> person<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">// 反序列化</span>
        <span class="token comment">// String jsonStr=&quot;{\\&quot;AGE\\&quot;:\\&quot;20\\&quot;,\\&quot;userName\\&quot;:\\&quot;张三\\&quot;}&quot;;</span>
        <span class="token comment">// Person person = JSONObject.toJavaObject(JSONObject.parseObject(jsonStr), Person.class);</span>
        <span class="token comment">// System.out.println(&quot;json to bean：&quot; + person.getName());</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，其输出结果为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;AGE&quot;</span><span class="token operator">:</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;userName&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>fastjson在进行操作时，是根据getter和setter的方法进行的，并不是依据Field进行</p><h5 id="_3-jsonfield中的format属性" tabindex="-1"><a class="header-anchor" href="#_3-jsonfield中的format属性" aria-hidden="true">#</a> 3.@JSONField中的format属性</h5>`,20),M={href:"https://so.csdn.net/so/search?q=%E5%BA%8F%E5%88%97%E5%8C%96&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},F=t(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> age<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>format<span class="token operator">=</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> date<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> date<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDate</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> date<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Person</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 序列化</span>
        <span class="token class-name">Person</span> person<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，其输出结果为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;date&quot;</span><span class="token operator">:</span><span class="token string">&quot;2022-06-21 09:52:37&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_4-jsonfield中的ordinal属性" tabindex="-1"><a class="header-anchor" href="#_4-jsonfield中的ordinal属性" aria-hidden="true">#</a> 4.@JSONField中的ordinal属性</h5><p>ordinal属性用于规定序列化时字段的顺序</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>ordinal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>ordinal <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> age<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>ordinal <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSex</span><span class="token punctuation">(</span><span class="token class-name">String</span> sex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Person</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 序列化</span>
        <span class="token class-name">Person</span> person<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，其输出结果为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;sex&quot;</span><span class="token operator">:</span><span class="token string">&quot;男&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_5-jsonfield中的serialize属性" tabindex="-1"><a class="header-anchor" href="#_5-jsonfield中的serialize属性" aria-hidden="true">#</a> 5.@JSONField中的serialize属性</h5><p>serialize属性其取值为false时表示该字段不进行序列化，就是转化为json字符串时不生成该字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
 
    <span class="token keyword">private</span> <span class="token class-name">String</span> age<span class="token punctuation">;</span>
 
    <span class="token comment">// 指定字段不进行序列化，就是转化为json字符串时不生成该字段</span>
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>serialize<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> date<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">String</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> date<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDate</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> date<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bc<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">Person</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 序列化</span>
        <span class="token class-name">Person</span> person<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，其输出结果为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token string">&quot;20&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_5-7-6、spring-session" tabindex="-1"><a class="header-anchor" href="#_5-7-6、spring-session" aria-hidden="true">#</a> 5.7.6、Spring Session</h3><p>参考文档： https://docs.spring.io/spring-session/reference/guides/boot-redis.html</p><h4 id="_1、session共享问题" tabindex="-1"><a class="header-anchor" href="#_1、session共享问题" aria-hidden="true">#</a> 1、Session共享问题</h4><p>原生的session方案不能解决父子域名共享session的问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.0.1.png" alt="image-20220807162338249" tabindex="0" loading="lazy"><figcaption>image-20220807162338249</figcaption></figure><p>原生的session方案，同一个服务部署在不同的机器上，这些机器不能共享用户的session，用户在一个机器上登陆后，再次访问其他请求有可能分配到别的机器上，由于别的机器没有该用户的session，因此再次要求用户登录。不同服务之间session更无法共享。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.0.2.png" alt="image-20220807162401133" tabindex="0" loading="lazy"><figcaption>image-20220807162401133</figcaption></figure><h5 id="_1、session复制-不推荐" tabindex="-1"><a class="header-anchor" href="#_1、session复制-不推荐" aria-hidden="true">#</a> 1、session复制(不推荐)</h5><p>可以让服务之间同步保存session，每台机器都保存一份相同的session，这样用户不管访问哪台机器都能得到用户session</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.1.png" alt="image-20220807162511571" tabindex="0" loading="lazy"><figcaption>image-20220807162511571</figcaption></figure><p>优点：web-server（Tomcat）原生支持，只需要修改配置文件 缺点：session同步需要数据传输，占用大量网络带宽，降低了服务器群的业务处理能力 任意一台web-server保存的数据都是所有web- server的session总和，受到内存限制无法水平扩展更多的web-server 大型分布式集群情况下，由于所有web-server都全量保存数据，所以此方案不可取。</p><h5 id="_2、客户端存储-不推荐" tabindex="-1"><a class="header-anchor" href="#_2、客户端存储-不推荐" aria-hidden="true">#</a> 2、客户端存储(不推荐)</h5><p>让用户的浏览器保存session，用户每个请求都带上session，这样用户访问任何机器都能得到session，非常节约服务器资源，但保存在用户浏览器里非常的不安全，非常不推荐。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.2.png" alt="image-20220807162614238" tabindex="0" loading="lazy"><figcaption>image-20220807162614238</figcaption></figure><p>优点：服务器不需存储session，用户保存自己的session信息到cookie中。节省服务端资源</p><p>缺点：都是缺点，这只是一种思路。 具体如下： 每次http请求，携带用户在cookie中的完整信息， 浪费网络带宽 session数据放在cookie中，cookie有长度限制4K，不能保存大量信息 session数据放在cookie中，存在泄漏、篡改、窃取等安全隐患 这种方式不会使用。</p><h5 id="_3、hash一致性-推荐" tabindex="-1"><a class="header-anchor" href="#_3、hash一致性-推荐" aria-hidden="true">#</a> 3、hash一致性(推荐)</h5><p>可以使用<code>OSI 7层网络模型</code>里的第<code>4</code>层<code>传输层</code>（分析IP层(第3层)及TCP/UDP层(第四层)，实现四层流量负载均衡）。根据用户的ip，然后做hash操作，使该用户每次请求都能负载均衡到相同的机器上</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.3.1.png" alt="image-20220807162823059" tabindex="0" loading="lazy"><figcaption>image-20220807162823059</figcaption></figure><p>还可以使用<code>OSI 7层网络模型</code>里的第<code>7</code>层<code>应用层</code>，通过http请求里存放的业务字段来做hash操作，使该用户每次请求都能负载均衡到相同的机器上(通过分析应用层的信息，如HTTP协议URI或Cookie信息)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.3.2.png" alt="image-20220807162831210" tabindex="0" loading="lazy"><figcaption>image-20220807162831210</figcaption></figure><p>优点：只需要改nginx配置，不需要修改应用代码 负载均衡，只要hash属性的值分布是均匀的，多台web-server的负载是均衡的 可以支持web-server水平扩展（session同步法是不行 的，受内存限制）</p><p>缺点：session还是存在web-server中的，所以web-server重启可能导致部分session丢失，影响业务，如部分用户需要重新登录 如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session 但是以上缺点问题也不是很大，因为session本来都是有有效期的。所以这两种反向代理的方式可以使用</p><p><strong>ip_hash</strong></p><p>ip_hash是根据用户请求过来的ip，然后映射成hash值，然后分配到一个特定的服务器里面； 使用ip_hash这种负载均衡以后，可以保证用户的每一次会话都只会发送到同一台特定的Tomcat里面，它的session不会跨到其他的tomcat里面去的；</p><p>首先通过将ip地址映射成一个hash值，然后将hash值对Tomcat的数量3取模，得到Tomcat的索引0、1、2； 比如：5%3=2，则把这个请求发送到Tomcat3服务器，以此类推； 这样一来，只要用户的IP不发生改变，当前用户的会话就能够一直保持； nginx的ip_hash算法是取ip地址的前三段数字进行hash映射，如果只有最后一段不一样，也会发送到同一个Tomcat里面</p><p>在nginx里面使用ip_hash,直接添加ip_hash关键字即可，后续同一ip的访问将只会请求同一个服务器。</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> tomcats</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.121.166:8080 weight=1 max_conns=2</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.121.167:8080 down</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.121.167:8088 weight=5 max_conns=2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code>[root@Nginx ~]# <span class="token directive"><span class="token keyword">cat</span> &lt;&lt;END &gt;&gt; /usr/local/nginx/conf/nginx.conf
stream</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">upstream</span> test_mysql</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">hash</span> <span class="token variable">$remote_addr</span> consistent</span><span class="token punctuation">;</span>       <span class="token comment"># 通过配置一致性 hash 来防止调度异常</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.1.1:3306 weight=5 max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">10086</span> so_keepalive=on</span><span class="token punctuation">;</span>       <span class="token comment"># 开启 TCP 存活探测</span>
    <span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">10s</span></span><span class="token punctuation">;</span>          <span class="token comment"># 连接超时时间</span>
    <span class="token directive"><span class="token keyword">proxy_timeout</span> <span class="token number">300s</span></span><span class="token punctuation">;</span>             <span class="token comment"># 端口保持时间</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> test_mysql</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
END
[root@Nginx ~]# nginx -s reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意事项：</p><p>一旦使用了ip_hash，当我们需要移除一台服务器的时候，不能直接删除这个配置项，而是需要在这台服务器配置后面加上关键字down，表示不可用；因为如果直接移除配置项，会导致hash算法发生更改，后续所有的请求都会发生混乱；</p><blockquote><ul><li><p>层是OSI 7层网络模型，OSI 模型是从上往下的，越底层越接近硬件，越往上越接近软件，这七层模型分别是物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。4层是指传输层的 tcp / udp、7层是指应用层，通常是http</p></li><li><p>4层用的是NAT技术。NAT英文全称是“Network Address Translation”，中文意思是“网络地址转换”，请求进来的时候，nginx修改数据包里面的目标IP、源IP和源端口，然后把数据包发向目标服务器，服务器处理完成后，nginx再做一次修改，返回给请求的客户端。</p></li><li><p>7层代理：需要读取并解析http请求内容，然后根据具体内容(url, 参数, cookie, 请求头)然后转发到相应的服务器。 转发的过程是：建立和目标机器的连接，然后转发请求，收到响应数据在转发给请求客户端。</p></li><li><p>性能： 理论上4层要比7层快，因为7层代理需要解析数据包的具体内容，需要消耗额外的cpu。但nginx具体强大的网络并发处理能力， 对于一些慢连接，nginx可以先将网络请求数据缓冲完了一次性转发给上游server，这样对于上游网络并发处理能力弱的服务器(比如tomcat)，这样对tomcat来说就是慢连接变成快连接(nginx到tomcat基本上都是可靠内网)，从而节省网络数据缓冲时间，提供并发性能。</p></li><li><p>灵活性： 由于4层代理用的是NAT，所以nginx不知道请求的具体内容，所以nginx啥也干不了。 用7层代理，可以根据请求内容(url,参数，cookie,请求头)做很多事情，比如： a.动态代理：不同的url转发到不同服务器。 b.风控：屏蔽外网IP请求某些敏感url；根据参数屏蔽某些刷单用户。 c.审计：在nginx层记录请求日志 …</p></li></ul></blockquote><h5 id="_4、统一存储-推荐" tabindex="-1"><a class="header-anchor" href="#_4、统一存储-推荐" aria-hidden="true">#</a> 4、统一存储(推荐)</h5><p>可以将session统一存储在数据库中，每个服务都访问同样的数据库，本次采用的就是这种方式，采用的时非关系型数据库<code>redis</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.4.png" alt="image-20220807162955043" tabindex="0" loading="lazy"><figcaption>image-20220807162955043</figcaption></figure><p>优点：没有安全隐患</p><p>可以水平扩展，数据库/缓存水平切分即可</p><p>web-server重启或者扩容都不会有 session丢失</p><p>缺点：增加了一次网络调用，并且需要修改应用代码；如将所有的getSession方法替 换为从Redis查数据的方式。redis获取数据比内存慢很多</p><p>上面缺点可以用SpringSession完美解决</p><h5 id="不同服务-子域session共享问题" tabindex="-1"><a class="header-anchor" href="#不同服务-子域session共享问题" aria-hidden="true">#</a> 不同服务，子域session共享问题</h5><p><code>jsessionid</code>这个<code>cookie</code>默认是当前系统域名的。当我们分拆服务，不同域名部署的时候，我们可以使用如下解决方案；</p><p>修改<code>cookie</code>的<code>domain</code>为<code>.gulimall.com</code>本域名及其子域名，然后所有的<code>seesion</code>都统一存储到<code>redis</code>里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.1.5.png" alt="image-20220807163133974" tabindex="0" loading="lazy"><figcaption>image-20220807163133974</figcaption></figure><h4 id="_2、整合springsession" tabindex="-1"><a class="header-anchor" href="#_2、整合springsession" aria-hidden="true">#</a> 2、整合SpringSession</h4><h5 id="_1、引入springsession" tabindex="-1"><a class="header-anchor" href="#_1、引入springsession" aria-hidden="true">#</a> 1、引入SpringSession</h5><p>首先在<code>gulimall-auth-server</code>模块的<code>pom.xml</code>文件里引入<code>spring-session-data-redis</code>的<code>jar</code>包</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入SpringSession--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.1.png" alt="image-20220806190404319" tabindex="0" loading="lazy"><figcaption>image-20220806190404319</figcaption></figure><p>在<code>src/main/resources/application.properties</code>配置文件中</p><h5 id="_2、添加配置" tabindex="-1"><a class="header-anchor" href="#_2、添加配置" aria-hidden="true">#</a> 2、添加配置</h5><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># Session store type.</span>
<span class="token key attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>
<span class="token comment"># Session timeout. If a duration suffix is not specified, seconds is used.</span>
<span class="token key attr-name">server.servlet.session.timeout</span><span class="token punctuation">=</span><span class="token value attr-value">30m</span>
<span class="token comment"># Sessions flush mode.</span>
<span class="token key attr-name">spring.session.redis.flush-mode</span><span class="token punctuation">=</span><span class="token value attr-value">on_save</span>
<span class="token comment"># Namespace for keys used to store sessions.</span>
<span class="token key attr-name">spring.session.redis.namespace</span><span class="token punctuation">=</span><span class="token value attr-value">spring:session</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置<code>redis</code>的连接信息</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
<span class="token key attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
<span class="token comment">#spring.redis.password=root</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.2.1.png" alt="image-20221214090946947" tabindex="0" loading="lazy"><figcaption>image-20221214090946947</figcaption></figure><p>启动类上添加该注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.2.2.png" alt="image-20220806193029395" tabindex="0" loading="lazy"><figcaption>image-20220806193029395</figcaption></figure><h5 id="_3、测试-3" tabindex="-1"><a class="header-anchor" href="#_3、测试-3" aria-hidden="true">#</a> 3、测试</h5><p>点击 http://auth.gulimall.com/login.html 页面的<code>gitee</code>，报了如下错误</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.3.1.gif" alt="GIF 2022-8-7 16-56-22" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-7 16-56-22</figcaption></figure><p>由于要向<code>reids</code>里保存数据，而默认又使用<code>jdk</code>进行序列化，因此需要把<code>MemberEntityTo</code>继承<code>Serializable</code>接口，使其序列化为二进制串才可以</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>org.springframework.data.redis.serializer.SerializationException: Cannot serialize<span class="token punctuation">;</span> nested exception is org.springframework.core.serializer.support.SerializationFailedException: Failed to serialize object using DefaultSerializer<span class="token punctuation">;</span> nested exception is java.lang.IllegalArgumentException: DefaultSerializer requires a Serializable payload but received an object of <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>com.atguigu.common.to.MemberEntityTo<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.3.2.png" alt="image-20220807165722818" tabindex="0" loading="lazy"><figcaption>image-20220807165722818</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to.MemberEntityTo</code>类里实现<code>Serializable</code>接口，即可实现序列化</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberEntityTo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.3.3.png" alt="image-20220807165925806" tabindex="0" loading="lazy"><figcaption>image-20220807165925806</figcaption></figure><p>重启<code>GulimallAuthServerApplication</code>服务，退出<code>gitee</code>(或清空<code>gitee</code>网站的cookie)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.3.4.png" alt="image-20220807163633204" tabindex="0" loading="lazy"><figcaption>image-20220807163633204</figcaption></figure><p>重新测试，此时<code>redis</code>里就有数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.3.5.png" alt="GIF 2022-8-7 17-06-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-7 17-06-13</figcaption></figure><h5 id="_4、其他模块引入springsession" tabindex="-1"><a class="header-anchor" href="#_4、其他模块引入springsession" aria-hidden="true">#</a> 4、其他模块引入SpringSession</h5><p>在<code>gulimall-product</code>模块的<code>pom.xml</code>文件中引入SpringSession</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入SpringSession--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.4.1.png" alt="image-20220807171900898" tabindex="0" loading="lazy"><figcaption>image-20220807171900898</figcaption></figure><p>在<code>gulimall-product</code>模块的启动类<code>com.atguigu.gulimall.product.GulimallProductApplication</code>上添加开启使用redis存储session的注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.4.2.png" alt="image-20220807171943750" tabindex="0" loading="lazy"><figcaption>image-20220807171943750</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件里选择session存储在redis中</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.4.3.png" alt="image-20220807172043746" tabindex="0" loading="lazy"><figcaption>image-20220807172043746</figcaption></figure><p>在redis里清空<code>spring:session</code>命令空间的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.4.4.png" alt="image-20220807190611065" tabindex="0" loading="lazy"><figcaption>image-20220807190611065</figcaption></figure><h5 id="_5、显示session中用户的昵称" tabindex="-1"><a class="header-anchor" href="#_5、显示session中用户的昵称" aria-hidden="true">#</a> 5、显示session中用户的昵称</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里的<code>你好，请登录</code>后面添加如下代码，显示一下session里存储的昵称，看一下是否能正常工作</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[[\${session.data.nickname}]]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.1.png" alt="image-20220807190049190" tabindex="0" loading="lazy"><figcaption>image-20220807190049190</figcaption></figure><p>访问 http://gulimall.com/ 报了如下的错误，提示没有<code>nickname</code>这个字段</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Caused by: org.springframework.expression.spel.SpelEvaluationException: EL1007E: Property or field <span class="token string">&#39;nickname&#39;</span> cannot be found on null
	at org.springframework.expression.spel.ast.PropertyOrFieldReference.readProperty<span class="token punctuation">(</span>PropertyOrFieldReference.java:213<span class="token punctuation">)</span>
	at org.springframework.expression.spel.ast.PropertyOrFieldReference.getValueInternal<span class="token punctuation">(</span>PropertyOrFieldReference.java:104<span class="token punctuation">)</span>
	at org.springframework.expression.spel.ast.PropertyOrFieldReference.access<span class="token variable">$000</span><span class="token punctuation">(</span>PropertyOrFieldReference.java:51<span class="token punctuation">)</span>
	at org.springframework.expression.spel.ast.PropertyOrFieldReference<span class="token variable">$AccessorLValue</span>.getValue<span class="token punctuation">(</span>PropertyOrFieldReference.java:406<span class="token punctuation">)</span>
	at org.springframework.expression.spel.ast.CompoundExpression.getValueInternal<span class="token punctuation">(</span>CompoundExpression.java:90<span class="token punctuation">)</span>
	at org.springframework.expression.spel.ast.SpelNodeImpl.getValue<span class="token punctuation">(</span>SpelNodeImpl.java:109<span class="token punctuation">)</span>
	at org.springframework.expression.spel.standard.SpelExpression.getValue<span class="token punctuation">(</span>SpelExpression.java:328<span class="token punctuation">)</span>
	at org.thymeleaf.spring5.expression.SPELVariableExpressionEvaluator.evaluate<span class="token punctuation">(</span>SPELVariableExpressionEvaluator.java:263<span class="token punctuation">)</span>
	<span class="token punctuation">..</span>. <span class="token number">76</span> <span class="token function">more</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.2.png" alt="image-20220807190154121" tabindex="0" loading="lazy"><figcaption>image-20220807190154121</figcaption></figure><p>可以将刚刚添加的代码修改成如下方式(data后面加了个<code>?</code>，即<code>session.data</code>存在才获取<code>nickname</code>)</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>session<span class="token punctuation">.</span>data<span class="token operator">?.</span>nickname<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>不可以使用如下方式，使用如下方式会报错</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">{</span>session<span class="token punctuation">.</span>data<span class="token punctuation">.</span>nickname<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>参考： https://github.com/thymeleaf/thymeleaf-spring/issues/186</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.3.png" alt="image-20220807190247265" tabindex="0" loading="lazy"><figcaption>image-20220807190247265</figcaption></figure><p>再次刷新页面，这次没有报错</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.4.png" alt="image-20220807190341361" tabindex="0" loading="lazy"><figcaption>image-20220807190341361</figcaption></figure><p>继续访问 http://auth.gulimall.com/login.html 页面使用gitee登录，回到 http://gulimall.com/ 页面继续报错</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.5.png" alt="GIF 2022-8-7 19-11-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-7 19-11-31</figcaption></figure><p>在<code>com.atguigu.common.to.MemberEntityTo</code>类里没有<code>nickname</code>字段，这是没有<code>getNickname()</code>方法导致的</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Caused by: org.springframework.expression.spel.SpelEvaluationException: EL1008E: Property or field &#39;nickname&#39; cannot be found on object of type &#39;com.atguigu.common.to.MemberEntityTo&#39; - maybe not public or not valid?
	at org.springframework.expression.spel.ast.PropertyOrFieldReference.readProperty(PropertyOrFieldReference.java:217)
	at org.springframework.expression.spel.ast.PropertyOrFieldReference.getValueInternal(PropertyOrFieldReference.java:104)
	at org.springframework.expression.spel.ast.PropertyOrFieldReference.access$000(PropertyOrFieldReference.java:51)
	at org.springframework.expression.spel.ast.PropertyOrFieldReference$AccessorLValue.getValue(PropertyOrFieldReference.java:406)
	at org.springframework.expression.spel.ast.CompoundExpression.getValueInternal(CompoundExpression.java:90)
	at org.springframework.expression.spel.ast.SpelNodeImpl.getValue(SpelNodeImpl.java:109)
	at org.springframework.expression.spel.standard.SpelExpression.getValue(SpelExpression.java:328)
	at org.thymeleaf.spring5.expression.SPELVariableExpressionEvaluator.evaluate(SPELVariableExpressionEvaluator.java:263)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.6.png" alt="image-20220807190713579" tabindex="0" loading="lazy"><figcaption>image-20220807190713579</figcaption></figure><p>参考：https://stackoverflow.com/questions/57369016/el1008e-property-or-field-username-cannot-be-found-on-object-of-type-user</p><p>忘记使用<code>@Data</code>注解了，在<code>gulimall-common</code>模块的<code>com.atguigu.common.to.MemberEntityTo</code>类上添加<code>@Data</code>注解即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.7.png" alt="image-20220807191103932" tabindex="0" loading="lazy"><figcaption>image-20220807191103932</figcaption></figure><p>重启<code>GulimallAuthServerApplication</code>服务，清空<code>redis</code>，再次使用<code>gitee</code>登录，这次就成功显示用户名了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.8.gif" alt="GIF 2022-8-7 19-15-19" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-7 19-15-19</figcaption></figure><p>但是这个使用<code>cookie</code>存储的<code>session</code>只有本域名有效，在 http://gulimall.com/ 页面下查看<code>cookie</code>，可以看到名为<code>SESSION</code>的<code>cookie</code>，它的<code>Domain</code>为<code>gulimall.com</code>，即只在 http://gulimall.com/ 页面有效，在其子域名下无效</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.9.png" alt="image-20220807192020569" tabindex="0" loading="lazy"><figcaption>image-20220807192020569</figcaption></figure><p>打开 http://auth.gulimall.com/login.html 页面，可以看到就没有这个名为<code>SESSION</code>的<code>cookie</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.5.10.png" alt="image-20220807192022495" tabindex="0" loading="lazy"><figcaption>image-20220807192022495</figcaption></figure><h5 id="_6、gitee添加成功回调" tabindex="-1"><a class="header-anchor" href="#_6、gitee添加成功回调" aria-hidden="true">#</a> 6、gitee添加成功回调</h5><p>在gitee的设置 -&gt; 第三方应用 -&gt; 我的应用 -&gt; 谷粒商城 里添加<strong>应用回调地址</strong>为如下所示</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://auth.gulimall.com/oauth2.0/gitee/success
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.6.1.png" alt="image-20220807195355737" tabindex="0" loading="lazy"><figcaption>image-20220807195355737</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的的<code>src/main/resources/templates/login.html</code>模块的<code>gitee</code>登录的<code>&lt;a&gt;</code>标签的<code>href</code>，修改登陆成功的回调地址为<code>http://auth.gulimall.com/oauth2.0/gitee/success</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://gitee.com/oauth/authorize?client_id=065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d&amp;redirect_uri=http://auth.gulimall.com/oauth2.0/gitee/success&amp;response_type=code<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 55px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 45px</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://gitee.com/static/images/logo-black.svg?t=158106666<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.6.2.png" alt="image-20220807195453473" tabindex="0" loading="lazy"><figcaption>image-20220807195453473</figcaption></figure><p>删除<code>gulimall-gateway</code>模块<code>src/main/resources/application.yml</code>文件的如下配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_oauth2_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/oauth2.0/<span class="token important">**</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.6.3.png" alt="image-20220807195556960" tabindex="0" loading="lazy"><figcaption>image-20220807195556960</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里将相关配置修改为如下（即修改登录成功后，重定向的地址）</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">oauth2.gitee.client-id</span><span class="token punctuation">=</span><span class="token value attr-value">065cf9a0adda5fdc2de82bb00bc97c447baf0ba6fc32aec45fe382008ccc9a6d</span>
<span class="token key attr-name">oauth2.gitee.redirect-uri</span><span class="token punctuation">=</span><span class="token value attr-value">http://auth.gulimall.com/oauth2.0/gitee/success</span>
<span class="token key attr-name">oauth2.gitee.client-secret</span><span class="token punctuation">=</span><span class="token value attr-value">0c58d0cca9c3fe12bd6c6824f6dc04cdbce5b07cad784c9b8d5938342fc004f7</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.6.4.png" alt="image-20220807200648197" tabindex="0" loading="lazy"><figcaption>image-20220807200648197</figcaption></figure><p>修改成功并重启<code>gulimall-gateway</code>模块和<code>gulimall-auth-server</code>模块后，可以看到首页没有显示<code>无名氏</code>，<code>http://gulimall.com/</code>域名没有名为<code>SESSION</code>的<code>cookie</code>，只有<code>http://auth.gulimall.com</code>域名有该<code>cookie</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.2.6.5.gif" alt="GIF 2022-8-7 20-18-50" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-7 20-18-50</figcaption></figure><h4 id="_3、修改cookie作用范围和json序列化器" tabindex="-1"><a class="header-anchor" href="#_3、修改cookie作用范围和json序列化器" aria-hidden="true">#</a> 3、修改cookie作用范围和JSON序列化器</h4><h5 id="_1、cookie作用范围配置" tabindex="-1"><a class="header-anchor" href="#_1、cookie作用范围配置" aria-hidden="true">#</a> 1、cookie作用范围配置</h5><p>查看官方文档，可以使用如下方式修改cookie作用范围为<strong>当前域名及其子域名</strong>，同时也可以设置cookie的名字等</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>1、默认发的令牌。session=dsajkdjl.作用域:当前域; (解决子域session共享问题)
2、使用JSON的序列化方式来序列化对象数据到redis中
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>https://docs.spring.io/spring-session/docs/2.5.0/reference/html5/guides/java-custom-cookie.html</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CookieSerializer</span> <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultCookieSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//We customize the name of the cookie to be JSESSIONID</span>
    serializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;JSESSIONID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//We customize the path of the cookie to be / (rather than the default of the context root).</span>
    serializer<span class="token punctuation">.</span><span class="token function">setCookiePath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     We customize the domain name pattern (a regular expression) to be ^.+?\\\\.(\\\\w+\\\\.[a-z]+)$.
     This allows sharing a session across domains and applications.
     If the regular expression does not match, no domain is set and the existing domain is used.
     If the regular expression matches, the first grouping is used as the domain.
     This means that a request to https://child.example.com sets the domain to example.com.
     However, a request to http://localhost:8080/ or https://192.168.1.100:8080/ leaves the cookie unset      and, thus, still works in development without any changes being necessary for production.
     **/</span>
    serializer<span class="token punctuation">.</span><span class="token function">setDomainNamePattern</span><span class="token punctuation">(</span><span class="token string">&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> serializer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.1.1.png" alt="image-20220807194309362" tabindex="0" loading="lazy"><figcaption>image-20220807194309362</figcaption></figure><p>默认使用jdk进行序列化，使用jdk序列化不能通用，因此可以修改为JSON格式</p><p>https://docs.spring.io/spring-session/reference/samples.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.1.2.png" alt="image-20220807192255113" tabindex="0" loading="lazy"><figcaption>image-20220807192255113</figcaption></figure><h5 id="_2、json序列化器配置" tabindex="-1"><a class="header-anchor" href="#_2、json序列化器配置" aria-hidden="true">#</a> 2、Json序列化器配置</h5><p>使用JSON进行序列化的相关代码如下所示：</p><p>https://github.com/spring-projects/spring-session/blob/2.7.0/spring-session-samples/spring-session-sample-boot-redis-json/src/main/java/sample/config/SessionConfig.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionDefaultRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.2.1.png" alt="image-20220807194511140" tabindex="0" loading="lazy"><figcaption>image-20220807194511140</figcaption></figure><p>使用<code>GenericJackson2JsonRedisSerializer</code>会保存序列化对象的完全限定名</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.2.2.png" alt="image-20220807194750745" tabindex="0" loading="lazy"><figcaption>image-20220807194750745</figcaption></figure><h5 id="_3、修改代码" tabindex="-1"><a class="header-anchor" href="#_3、修改代码" aria-hidden="true">#</a> 3、修改代码</h5><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config</code>包下添加<code>GulimallSessionConfig</code>配置类，用于修改cookie的作用范围为当前域名和子域名，修改redis的序列化器为json序列化器</p><p>使用该配置后，我们可以将Spring Session默认的Cookie Key从<code>SESSION</code>替换为<code>GULIMALL_JSESSIONID</code>。而CookiePath设置为根路径且DomainNamePattern配置了相关的正则表达式，可以达到同父域下的单点登录的效果，在未涉及跨域的单点登录系统中(跨域的单点登录系统指的是根域名不同的多个系统之间实现一个系统登录，全系统都登录。一个系统退出登录，全系统都退出登录)，这是一个非常优雅的解决方案。如果我们的当前域名是 <code>auth.gulimall.com</code>，该正则会将Cookie设置在父域 <code>gulimall.com</code>中，如果有另一个相同父域的子域名<code>search.gulimall.com</code>也会识别这个Cookie，便可以很方便的实现同父域下的单点登录。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">CookieSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">DefaultCookieSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSessionConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CookieSerializer</span> <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultCookieSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// We customize the name of the cookie to be JSESSIONID.</span>
        serializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;GULIMALL_JSESSIONID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//We customize the path of the cookie to be / (rather than the default of the context root).</span>
        serializer<span class="token punctuation">.</span><span class="token function">setCookiePath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//If the regular expression matches, the first grouping is used as the domain.</span>
        <span class="token comment">//This means that a request to https://child.example.com sets the domain to example.com.</span>
        <span class="token comment">//However, a request to http://localhost:8080/ or https://192.168.1.100:8080/ leaves the cookie unset and,</span>
        <span class="token comment">// thus, still works in development without any changes being necessary for production.</span>
        serializer<span class="token punctuation">.</span><span class="token function">setDomainNamePattern</span><span class="token punctuation">(</span><span class="token string">&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serializer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionDefaultRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.3.1.png" alt="image-20220807202944114" tabindex="0" loading="lazy"><figcaption>image-20220807202944114</figcaption></figure><p>复制一份<code>GulimallSessionConfig</code>配置类，粘贴到<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config</code>包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">CookieSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">DefaultCookieSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSessionConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CookieSerializer</span> <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultCookieSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//	We customize the name of the cookie to be JSESSIONID.</span>
        serializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;GULIMALL_JSESSIONID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//We customize the path of the cookie to be / (rather than the default of the context root).</span>
        serializer<span class="token punctuation">.</span><span class="token function">setCookiePath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//If the regular expression matches, the first grouping is used as the domain.</span>
        <span class="token comment">//This means that a request to https://child.example.com sets the domain to example.com.</span>
        <span class="token comment">//However, a request to http://localhost:8080/ or https://192.168.1.100:8080/ leaves the cookie unset and,</span>
        <span class="token comment">// thus, still works in development without any changes being necessary for production.</span>
        serializer<span class="token punctuation">.</span><span class="token function">setDomainNamePattern</span><span class="token punctuation">(</span><span class="token string">&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serializer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionDefaultRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.3.2.png" alt="image-20220807204934777" tabindex="0" loading="lazy"><figcaption>image-20220807204934777</figcaption></figure><p>清空首页和登录页的cookie，在 http://auth.gulimall.com/login.html 页面刷新后查看cookie，名字改为了<code>GULIMALL_JSESSIONID</code>但是<code>domain</code>还是<code>auth.gulimall.com</code>，修改并未生效</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.3.3.png" alt="image-20220807203331698" tabindex="0" loading="lazy"><figcaption>image-20220807203331698</figcaption></figure><p>打开 http://gulimall.com/ 页面查看cookie，这里面就没有名为<code>GULIMALL_JSESSIONID</code>的cookie了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.3.4.png" alt="image-20220807211710277" tabindex="0" loading="lazy"><figcaption>image-20220807211710277</figcaption></figure><p>查看redis里的数据，数据也变为<code>json</code>格式了，就只有cookie的作用范围有点问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.3.5.png" alt="image-20220807203417640" tabindex="0" loading="lazy"><figcaption>image-20220807203417640</figcaption></figure><h5 id="_4、重新修改代码" tabindex="-1"><a class="header-anchor" href="#_4、重新修改代码" aria-hidden="true">#</a> 4、重新修改代码</h5><p>只好将<code>DomainName</code>修改为<code>gulimall.com</code>了</p><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config.GulimallSessionConfig</code>类里，将<code>cookieSerializer()</code>方法的<code>serializer.setDomainNamePattern(&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;);</code>修改为<code>serializer.setDomainName(&quot;gulimall.com&quot;);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CookieSerializer</span> <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultCookieSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We customize the name of the cookie to be JSESSIONID.</span>
    serializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;GULIMALL_JSESSIONID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    serializer<span class="token punctuation">.</span><span class="token function">setDomainName</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">////We customize the path of the cookie to be / (rather than the default of the context root).</span>
    <span class="token comment">//serializer.setCookiePath(&quot;/&quot;);</span>
    <span class="token comment">////If the regular expression matches, the first grouping is used as the domain.</span>
    <span class="token comment">////This means that a request to https://child.example.com sets the domain to example.com.</span>
    <span class="token comment">////However, a request to http://localhost:8080/ or https://192.168.1.100:8080/ leaves the cookie unset and,</span>
    <span class="token comment">//// thus, still works in development without any changes being necessary for production.</span>
    <span class="token comment">////亲测不生效</span>
    <span class="token comment">//serializer.setDomainNamePattern(&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;);</span>
    <span class="token keyword">return</span> serializer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.4.1.png" alt="image-20220807211555730" tabindex="0" loading="lazy"><figcaption>image-20220807211555730</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.GulimallSessionConfig</code>类里，将<code>cookieSerializer()</code>方法的<code>serializer.setDomainNamePattern(&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;);</code>修改为<code>serializer.setDomainName(&quot;gulimall.com&quot;);</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.4.2.png" alt="image-20220807211600180" tabindex="0" loading="lazy"><figcaption>image-20220807211600180</figcaption></figure><p>清空首页和登录页的cookie， 打开 http://gulimall.com/ 页面并刷新，此时cookie 的作用范围才为当前域名和子域名(<code>.gulimall.com</code>前面有个<code>.</code>即表示当前域名和子域名)。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.4.3.png" alt="image-20220807211520607" tabindex="0" loading="lazy"><figcaption>image-20220807211520607</figcaption></figure><p>http://auth.gulimall.com/login.html 页面也有此 cookie 了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.3.4.4.png" alt="image-20220807211512492" tabindex="0" loading="lazy"><figcaption>image-20220807211512492</figcaption></figure><h4 id="_4、源码解读" tabindex="-1"><a class="header-anchor" href="#_4、源码解读" aria-hidden="true">#</a> 4、源码解读</h4><p>我们在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.GulimallAuthServerApplication</code>启动类上使用了<code>@EnableRedisHttpSession</code>注解</p><p><code>org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession</code>注解导入了<code>RedisHttpSessionConfiguration</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">RedisHttpSessionConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.1.png" alt="image-20220807211933163" tabindex="0" loading="lazy"><figcaption>image-20220807211933163</figcaption></figure><p>在<code>RedisHttpSessionConfiguration</code>类里向容器中注入了<code>RedisOperationsSessionRepository</code> 使用<code>redis</code>操作<code>Session</code>的持久层仓库(session的增删改查封装类)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedisOperationsSessionRepository</span> <span class="token function">sessionRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedisOperationsSessionRepository</span> sessionRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisOperationsSessionRepository</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepository<span class="token punctuation">.</span><span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventPublisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultRedisSerializer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sessionRepository<span class="token punctuation">.</span><span class="token function">setDefaultSerializer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.2.png" alt="image-20220807212155349" tabindex="0" loading="lazy"><figcaption>image-20220807212155349</figcaption></figure><p>在<code>RedisOperationsSessionRepository</code>类里使用<code>ctrl + F12</code>快捷键，可以看到该类有增删查改redis的方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.3.png" alt="image-20220807214019282" tabindex="0" loading="lazy"><figcaption>image-20220807214019282</figcaption></figure><p>返回到<code>RedisHttpSessionConfiguration</code>类，可以看到<code>RedisHttpSessionConfiguration</code>类继承于<code>SpringHttpSessionConfiguration</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.4.png" alt="image-20220807212706762" tabindex="0" loading="lazy"><figcaption>image-20220807212706762</figcaption></figure><p>在<code>SpringHttpSessionConfiguration</code>构造器执行之后，初始化了一个<code>CookieSerializer</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CookieSerializer</span> cookieSerializer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cookieSerializer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cookieSerializer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createDefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultHttpSessionIdResolver<span class="token punctuation">.</span><span class="token function">setCookieSerializer</span><span class="token punctuation">(</span>cookieSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.5.png" alt="image-20220807212802272" tabindex="0" loading="lazy"><figcaption>image-20220807212802272</figcaption></figure><p><code>SpringHttpSessionConfiguration</code>向容器中放了一个<code>SessionEventHttpSessionListenerAdapter</code>监听器，监听<code>服务器停机</code>，<code>Session的序列化</code>、<code>Session反序列化</code>、<code>session的活化</code>、<code>Session的钝化</code>等各种过程</p><p>(一)钝化</p><p>当服务器正常关闭时,还存活着的session(在设置时间内没有销毁)会随着服务器的关闭被以文件(“SESSIONS.ser”)的形式存储在tomcat的work目录下,这个过程叫做Session的钝化。</p><p>(二)活化</p><p>当服务器再次正常开启时,服务器会找到之前的“SESSIONS.ser”文件，从中恢复之前保存起来的Session对象，这个过程叫做Session的活化。</p><p>(三)注意事项</p><p>1）想要随着Session被钝化、活化的对象它的类必须实现Serializable接口，还有要注意的是只有在服务器正常关闭的条件下，还未超时的Session才会被钝化成文件。当Session超时、调用invalidate方法或者服务器在非正常情况下关闭时，Session都不会被钝化，因此也就不存在活化。</p><p>2）在被钝化成“SESSIONS.ser”文件时，不会因为超过Session过期时间而消失，这个文件会一直存在，等到下一次服务器开启时消失。</p><p>3）当多个Session被钝化时，这些被钝化的Session都被保存在一个文件中，并不会为每个Session都建立一个文件。</p><p>4）session中的数据与服务器是否关闭无关，只跟浏览器是否关闭有关。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">SessionEventHttpSessionListenerAdapter</span> <span class="token function">sessionEventHttpSessionListenerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SessionEventHttpSessionListenerAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpSessionListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.6.png" alt="image-20220807212910677" tabindex="0" loading="lazy"><figcaption>image-20220807212910677</figcaption></figure><p><code>SpringHttpSessionConfiguration</code>类还向容器中存放了<code>SessionRepositoryFilter</code>（<code>Session</code>存储过滤器）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">SessionRepositoryFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionRepositoryFilter</span><span class="token punctuation">(</span><span class="token class-name">SessionRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> sessionRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SessionRepositoryFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> sessionRepositoryFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">(</span>sessionRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepositoryFilter<span class="token punctuation">.</span><span class="token function">setServletContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionRepositoryFilter<span class="token punctuation">.</span><span class="token function">setHttpSessionIdResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpSessionIdResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sessionRepositoryFilter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.7.png" alt="image-20220807213346332" tabindex="0" loading="lazy"><figcaption>image-20220807213346332</figcaption></figure><p>返回的<code>org.springframework.session.web.http.SessionRepositoryFilter</code>继承自<code>org.springframework.session.web.http.OncePerRequestFilter</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.8.png" alt="image-20220807213534778" tabindex="0" loading="lazy"><figcaption>image-20220807213534778</figcaption></figure><p>而<code>org.springframework.session.web.http.OncePerRequestFilter</code>实现了一个<code>Filter</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.9.png" alt="image-20220807213552684" tabindex="0" loading="lazy"><figcaption>image-20220807213552684</figcaption></figure><p>而这个<code>Filter</code>就是<code>javax.servlet.Filter</code>，即SpringSession主要就是通过filter实现的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.10.png" alt="image-20220807213627268" tabindex="0" loading="lazy"><figcaption>image-20220807213627268</figcaption></figure><p><code>SessionRepositoryFilter</code>的<code>SessionRepositoryFilter</code>方法会到容器中找<code>SessionRepository</code>，而<code>SessionRepository</code>就是刚刚看到的<code>RedisOperationsSessionRepository</code> （使用<code>redis</code>操作<code>Session</code>的持久层仓库）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">(</span><span class="token class-name">SessionRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> sessionRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionRepository <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;sessionRepository cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository <span class="token operator">=</span> sessionRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.11.png" alt="image-20220807214300525" tabindex="0" loading="lazy"><figcaption>image-20220807214300525</figcaption></figure><p><code>org.springframework.session.web.http.SessionRepositoryFilter</code>重写了父类<code>org.springframework.session.web.http.OncePerRequestFilter</code>的<code>doFilterInternal</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.12.png" alt="image-20220807214711076" tabindex="0" loading="lazy"><figcaption>image-20220807214711076</figcaption></figure><p>而<code>org.springframework.session.web.http.OncePerRequestFilter</code>又重写了<code>javax.servlet.Filter</code>的<code>doFilter</code>，然后调用<code>doFilterInternal(httpRequest, httpResponse, filterChain);</code>方法执行相应功能（Spring和Tomcat都是这样，先实现jsr规范的接口做一些初始化或者异常捕获这些通用的事情，期间会调用<code>xxxInternal</code>方法执行真正的功能，<code>xxxInternal</code>方法为抽象方法，让其子类去实现该抽象方法以完成实际的功能）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * This <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">doFilter</span></span><span class="token punctuation">}</span> implementation stores a request attribute for
 * &quot;already filtered&quot;, proceeding without filtering again if the attribute is already
 * there.
 * <span class="token keyword">@param</span> <span class="token parameter">request</span> the request
 * <span class="token keyword">@param</span> <span class="token parameter">response</span> the response
 * <span class="token keyword">@param</span> <span class="token parameter">filterChain</span> the filter chain
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">ServletException</span></span> if request is not HTTP request
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span> in case of I/O operation exception
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span>
      <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span>
         <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>response <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;OncePerRequestFilter just supports HTTP requests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">HttpServletRequest</span> httpRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
   <span class="token class-name">HttpServletResponse</span> httpResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>
   <span class="token class-name">String</span> alreadyFilteredAttributeName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>alreadyFilteredAttributeName<span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> hasAlreadyFilteredAttribute <span class="token operator">=</span> request
         <span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>alreadyFilteredAttributeName<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>hasAlreadyFilteredAttribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DispatcherType</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getDispatcherType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">doFilterNestedErrorDispatch</span><span class="token punctuation">(</span>httpRequest<span class="token punctuation">,</span> httpResponse<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Proceed without invoking this filter...</span>
      filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Do invoke this filter...</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>alreadyFilteredAttributeName<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>httpRequest<span class="token punctuation">,</span> httpResponse<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// Remove the &quot;already filtered&quot; request attribute for this request.</span>
         request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>alreadyFilteredAttributeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.13.png" alt="image-20220807214927002" tabindex="0" loading="lazy"><figcaption>image-20220807214927002</figcaption></figure><p>因此核心原理在<code>org.springframework.session.web.http.SessionRepositoryFilter</code>类的<code>doFilterInternal</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
      <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">SESSION_REPOSITORY_ATTR</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">SessionRepositoryRequestWrapper</span> wrappedRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRepositoryRequestWrapper</span><span class="token punctuation">(</span>
         request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">SessionRepositoryResponseWrapper</span> wrappedResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRepositoryResponseWrapper</span><span class="token punctuation">(</span>
         wrappedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>wrappedRequest<span class="token punctuation">,</span> wrappedResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      wrappedRequest<span class="token punctuation">.</span><span class="token function">commitSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.14.png" alt="image-20220807214711076" tabindex="0" loading="lazy"><figcaption>image-20220807214711076</figcaption></figure><p>向session中存放key为<code>org.springframework.session.SessionRepository</code>的<code>RedisOperationsSessionRepository</code>对象</p><p><code>request.setAttribute</code>是在同一个请求共享数据的，把<code>this.sessionRepository</code>放到当前请求，当前的同一次请求，都使用的是同一个<code>sessionRepository</code>（全系统就一个）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>request.setAttribute(SESSION_REPOSITORY_ATTR, this.sessionRepository);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>把原生的请求对象<code>request, response, this.servletContext</code>传给<code>SessionRepositoryRequestWrapper</code>进行包装(包装原始请求对象)（装饰者模式）（<code>SessionRepositoryRequestWrapper</code>类为<code>org.springframework.session.web.http.SessionRepositoryFilter</code>类的内部类）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>SessionRepositoryRequestWrapper wrappedRequest = new SessionRepositoryRequestWrapper(
         request, response, this.servletContext);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后又把包装的<code>SessionRepositoryRequestWrapper</code>和<code>response</code>传给<code>SessionRepositoryResponseWrapper</code>进行包装（包装原始响应对象）（<code>SessionRepositoryResponseWrapper</code>类为<code>org.springframework.session.web.http.SessionRepositoryFilter</code>类的内部类）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>SessionRepositoryResponseWrapper wrappedResponse = new SessionRepositoryResponseWrapper(
         wrappedRequest, response);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>将通过包装后的<code>SessionRepositoryRequestWrapper</code>和<code>SessionRepositoryResponseWrapper</code> 放行给<code>filter</code>链，<code>filter</code>链执行完后就会放到<code>Controller</code>（包装后的对象应用到了后面的整个执行链）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>filterChain.doFilter(wrappedRequest, wrappedResponse);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.15.png" alt="image-20220808090432071" tabindex="0" loading="lazy"><figcaption>image-20220808090432071</figcaption></figure><p><code>doFilterInternal</code>方法把原生的<code>request</code>、<code>response</code>包装成了<code>wrappedRequest</code>、<code>wrappedResponse</code>，执行<code>request.getSession()</code>相当于执行<code>wrappedRequest.getSession()</code></p><p>而<code>SessionRepositoryRequestWrapper</code>类重写了<code>getSession</code></p><p>原生的<code>javax.servlet.http.HttpServletRequest</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Returns the current session associated with this request, or if the
 * request does not have a session, creates one.
 *
 * <span class="token keyword">@return</span> the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">HttpSession</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> associated with this request
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">)</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">HttpSession</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.16.png" alt="image-20221226112612769" tabindex="0" loading="lazy"><figcaption>image-20221226112612769</figcaption></figure><p>📌在一个Web应用程序中可以注册多个Filter程序，每个Filter程序都可以针对某一个URL进行拦截。如果多个Filter程序都对同一个URL进行拦截，那么这些Filter就会组成一个<strong>Filter链(也叫过滤器链)</strong> 内部类<code>org.springframework.session.web.http.SessionRepositoryFilter.SessionRepositoryRequestWrapper</code>重写后的<code>getSession();</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">HttpSessionWrapper</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> create<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">HttpSessionWrapper</span> currentSession <span class="token operator">=</span> <span class="token function">getCurrentSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">S</span> requestedSession <span class="token operator">=</span> <span class="token function">getRequestedSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>requestedSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">INVALID_SESSION_ID_ATTR</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         requestedSession<span class="token punctuation">.</span><span class="token function">setLastAccessedTime</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionIdValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         currentSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionWrapper</span><span class="token punctuation">(</span>requestedSession<span class="token punctuation">,</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         currentSession<span class="token punctuation">.</span><span class="token function">setNew</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">setCurrentSession</span><span class="token punctuation">(</span>currentSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is an invalid session id. No need to ask again if</span>
      <span class="token comment">// request.getSession is invoked for the duration of this request</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SESSION_LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token constant">SESSION_LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
               <span class="token string">&quot;No session found by id: Caching result for getSession(false) for this HttpServletRequest.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">INVALID_SESSION_ID_ATTR</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>create<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SESSION_LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">SESSION_LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
            <span class="token string">&quot;A new session was created. To help you troubleshoot where the session was created we provided a StackTrace (this is not an error). You can prevent this from appearing by disabling DEBUG logging for &quot;</span>
                  <span class="token operator">+</span> <span class="token constant">SESSION_LOGGER_NAME</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                  <span class="token string">&quot;For debugging purposes only (not an error)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">S</span> session <span class="token operator">=</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   session<span class="token punctuation">.</span><span class="token function">setLastAccessedTime</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   currentSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionWrapper</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">setCurrentSession</span><span class="token punctuation">(</span>currentSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.17.png" alt="image-20220808094820279" tabindex="0" loading="lazy"><figcaption>image-20220808094820279</figcaption></figure><p>首先调用本内部类的<code>getCurrentSession()</code>方法，查询<code>SESSION_REPOSITORY_ATTR</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">HttpSessionWrapper</span> <span class="token function">getCurrentSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">HttpSessionWrapper</span><span class="token punctuation">)</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">CURRENT_SESSION_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.18.png" alt="image-20220808095133989" tabindex="0" loading="lazy"><figcaption>image-20220808095133989</figcaption></figure><p>如果不等于空了就返回当前<code>Session</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">HttpSessionWrapper</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> create<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">HttpSessionWrapper</span> currentSession <span class="token operator">=</span> <span class="token function">getCurrentSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">S</span> requestedSession <span class="token operator">=</span> <span class="token function">getRequestedSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.19.png" alt="image-20220808095247834" tabindex="0" loading="lazy"><figcaption>image-20220808095247834</figcaption></figure><p>如果为空了就在<code>sessionRepository</code>里重新获取</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">S</span> <span class="token function">getRequestedSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionCached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sessionIds <span class="token operator">=</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpSessionIdResolver
            <span class="token punctuation">.</span><span class="token function">resolveSessionIds</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> sessionId <span class="token operator">:</span> sessionIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token class-name">S</span> session <span class="token operator">=</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository
               <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSession <span class="token operator">=</span> session<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSessionCached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestedSession<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.20.png" alt="image-20220808095507267" tabindex="0" loading="lazy"><figcaption>image-20220808095507267</figcaption></figure><p>如果还没有并且本<code>getSession(boolean create)</code>方法传过来的create为true的话，还会在redis中创建session。不过最开始设置的<code>create</code>为false，直接return了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">S</span> session <span class="token operator">=</span> <span class="token class-name">SessionRepositoryFilter</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionRepository<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
session<span class="token punctuation">.</span><span class="token function">setLastAccessedTime</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
currentSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionWrapper</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setCurrentSession</span><span class="token punctuation">(</span>currentSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> currentSession<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.21.png" alt="image-20221226115035822" tabindex="0" loading="lazy"><figcaption>image-20221226115035822</figcaption></figure><p>而这个<code>SessionRepository</code>就是以前放的<code>RedisOperationsSessionRepository</code>，所以对<code>session</code>的操作全在<code>redis</code>里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SessionRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> sessionRepository<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.22.png" alt="image-20220808095717747" tabindex="0" loading="lazy"><figcaption>image-20220808095717747</figcaption></figure><p><code>SessionRepository</code>里定义了增删改查的方法，并且也有<code>redis</code>的实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SessionRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span> <span class="token keyword">extends</span> <span class="token class-name">Session</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token doc-comment comment">/**
	 * Creates a new <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> that is capable of being persisted by this
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SessionRepository</span></span><span class="token punctuation">}</span>.
	 *
	 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
	 * This allows optimizations and customizations in how the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> is
	 * persisted. For example, the implementation returned might keep track of the changes
	 * ensuring that only the delta needs to be persisted on a save.
	 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
	 *
	 * <span class="token keyword">@return</span> a new <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> that is capable of being persisted by this
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SessionRepository</span></span><span class="token punctuation">}</span>
	 */</span>
	<span class="token class-name">S</span> <span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * Ensures the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> created by
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">SessionRepository</span><span class="token punctuation">#</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> is saved.
	 *
	 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
	 * Some implementations may choose to save as the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> is updated by
	 * returning a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> that immediately persists any changes. In this case,
	 * this method may not actually do anything.
	 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
	 *
	 * <span class="token keyword">@param</span> <span class="token parameter">session</span> the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> to save
	 */</span>
	<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">S</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * Gets the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> by the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span><span class="token punctuation">#</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> or null if no
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> is found.
	 *
	 * <span class="token keyword">@param</span> <span class="token parameter">id</span> the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">Session</span><span class="token punctuation">#</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> to lookup
	 * <span class="token keyword">@return</span> the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> by the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span><span class="token punctuation">#</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> or null if no
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> is found.
	 */</span>
	<span class="token class-name">S</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * Deletes the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> with the given <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span><span class="token punctuation">#</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> or does nothing
	 * if the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Session</span></span><span class="token punctuation">}</span> is not found.
	 * <span class="token keyword">@param</span> <span class="token parameter">id</span> the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">Session</span><span class="token punctuation">#</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> to delete
	 */</span>
	<span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.23.png" alt="image-20220808100406889" tabindex="0" loading="lazy"><figcaption>image-20220808100406889</figcaption></figure><p>返回null以后，进到了<code>org.springframework.web.servlet.support.SessionFlashMapManager</code>类的<code>retrieveFlashMaps</code>方法，由于调用的<code>request.getSession(false);</code>返回了null，因此session为null，直接返回null了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionFlashMapManager</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractFlashMapManager</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Retrieves saved FlashMap instances from the HTTP session, if any.
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlashMap</span><span class="token punctuation">&gt;</span></span> <span class="token function">retrieveFlashMaps</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlashMap</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FLASH_MAPS_SESSION_ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.24.png" alt="image-20221226115342407" tabindex="0" loading="lazy"><figcaption>image-20221226115342407</figcaption></figure><p>由于<code>retrieveFlashMaps(request)</code>返回了null，因此<code>org.springframework.web.servlet.support.AbstractFlashMapManager</code>类的<code>retrieveAndUpdate</code>方法也返回null</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractFlashMapManager</span> <span class="token keyword">implements</span> <span class="token class-name">FlashMapManager</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">FlashMap</span> <span class="token function">retrieveAndUpdate</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlashMap</span><span class="token punctuation">&gt;</span></span> allFlashMaps <span class="token operator">=</span> <span class="token function">retrieveFlashMaps</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>allFlashMaps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.25.png" alt="image-20221226115742369" tabindex="0" loading="lazy"><figcaption>image-20221226115742369</figcaption></figure><p>然后就执行了<code>org.springframework.web.servlet.DispatcherServlet</code>类的<code>doDispatch</code>方法（如果看过spring mvc源码应该知道该方法，所有请求是由<code>doDispatch</code>方法处理的）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DispatcherServlet</span> <span class="token keyword">extends</span> <span class="token class-name">FrameworkServlet</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doService</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token function">logRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flashMapManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">FlashMap</span> inputFlashMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flashMapManager<span class="token punctuation">.</span><span class="token function">retrieveAndUpdate</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>inputFlashMap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">INPUT_FLASH_MAP_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>inputFlashMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">OUTPUT_FLASH_MAP_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FlashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FLASH_MAP_MANAGER_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flashMapManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">doDispatch</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">finally</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Restore the original attribute snapshot, in case of an include.</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>attributesSnapshot <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">restoreAttributesAfterInclude</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> attributesSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.26.png" alt="image-20221226115914228" tabindex="0" loading="lazy"><figcaption>image-20221226115914228</figcaption></figure><p>再次点击<code>步过</code>按钮，就会发现<code>getSession(boolean create)</code>的<code>create</code>为<code>true</code>了，此时就会创建了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.27.png" alt="image-20221226120335389" tabindex="0" loading="lazy"><figcaption>image-20221226120335389</figcaption></figure><p>通过栈轨迹可以看到是<code>doDispatch</code>方法的<code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code>这行代码设置的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.28.png" alt="image-20221226120556560" tabindex="0" loading="lazy"><figcaption>image-20221226120556560</figcaption></figure><p><code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code>这个方法就是返回模型和视图的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.29.png" alt="image-20221226120733656" tabindex="0" loading="lazy"><figcaption>image-20221226120733656</figcaption></figure><p>并且可以自动续期，默认30分钟过期</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.30.gif" alt="GIF 2022-8-8 10-11-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 10-11-13</figcaption></figure>`,286),N={href:"https://python.itcast.cn/news/20200918/14565961247.shtml",target:"_blank",rel:"noopener noreferrer"},P=t(`<p>在一个Web应用程序中可以注册多个Filter程序，每个Filter程序都可以针对某一个URL进行拦截。如果多个Filter程序都对同一个URL进行拦截，那么这些Filter就会组成一个<strong>Filter链(也叫过滤器链)</strong>。Filter链用FilterChain对象来表示，FilterChain对象中有一个doFilter()方法，该方法作用就是让Filter链上的当前过滤器放行，请求进入下一个Filter，接下来通过一个图例来描述Filter链的拦截过程，如图1所示。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.4.31.png" alt="filter链" tabindex="0" loading="lazy"><figcaption>filter链</figcaption></figure><p>当浏览器访问Web服务器中的资源时需要经过两个过滤器Filter1和Filter2，首先Filter1会对这个请求进行拦截，在Filter1过滤器中处理好请求后，通过调用Filter1的doFilter()方法将请求传递给Filter2，Filter2将用户请求处理后同样调用doFilter()方法，最终将请求发送给目标资源。当Web服务器对这个请求做出响应时，也会被过滤器拦截，这个拦截顺序与之前相反，最终将响应结果发送给客户端。</p><h4 id="_5、使用session存放登录数据" tabindex="-1"><a class="header-anchor" href="#_5、使用session存放登录数据" aria-hidden="true">#</a> 5、使用session存放登录数据</h4><h5 id="_1、向session存放的数据" tabindex="-1"><a class="header-anchor" href="#_1、向session存放的数据" aria-hidden="true">#</a> 1、向session存放的数据</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.constant.auth.AuthServerConstant</code>类里添加字段，作为登录成功后，向session存放数据的key</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 登录成功后，向session存放的数据
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LOGIN_USER</span> <span class="token operator">=</span> <span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.1.1.png" alt="image-20220808105019374" tabindex="0" loading="lazy"><figcaption>image-20220808105019374</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.OAuth2Controller</code>类的<code>giteeRegister</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/gitee/success&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">giteeRegister</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> oAuth2Service<span class="token punctuation">.</span><span class="token function">giteeRegister</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Cookie cookie = new Cookie(&quot;data&quot;,memberEntityTo.toString());</span>
        <span class="token comment">//cookie.setPath(&quot;/&quot;);</span>
        <span class="token comment">//response.addCookie(cookie);</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;第三方登录失败 :{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.1.2.png" alt="image-20220808105126361" tabindex="0" loading="lazy"><figcaption>image-20220808105126361</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>的<code>login</code>方法里添加代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 页面传递 k，v不加 @RequestBody
 * <span class="token keyword">@param</span> <span class="token parameter">vo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">UserLoginVo</span> vo<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> redirectAttributes<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Object</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">MemberEntityTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.1.3.png" alt="image-20220808105605057" tabindex="0" loading="lazy"><figcaption>image-20220808105605057</figcaption></figure><p>修改<code>gulimall-product</code>模块<code>src/main/resources/templates/index.html</code>文件的<code>你好，请登录</code>周围代码，展示用户信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>ul<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>li<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>a th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;\${session.loginUser!=null}&quot;</span><span class="token operator">&gt;</span>欢迎：<span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>session<span class="token punctuation">.</span>loginUser<span class="token operator">?</span><span class="token punctuation">.</span>nickname<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;http://auth.gulimall.com/login.html&quot;</span> th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;\${session.loginUser==null}&quot;</span><span class="token operator">&gt;</span>你好，请登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>li<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;http://auth.gulimall.com/reg.html&quot;</span> th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;\${session.loginUser==null}&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;li_2&quot;</span><span class="token operator">&gt;</span>免费注册<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>span<span class="token punctuation">&gt;</span></span><span class="token operator">|</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>li<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;#&quot;</span><span class="token operator">&gt;</span>我的订单<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.1.4.png" alt="image-20220808110530695" tabindex="0" loading="lazy"><figcaption>image-20220808110530695</figcaption></figure><p>重启<code>GulimallProductApplication</code>、<code>GulimallAuthServerApplication</code>、<code>GulimallMemberApplication</code>服务</p><p>在<code>http://auth.gulimall.com/login.html</code>页面登陆后会跳转到<code>http://gulimall.com/</code>页面，再次访问<code>http://auth.gulimall.com/login.html</code>应该跳转到<code>http://gulimall.com/</code>页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.1.5.gif" alt="GIF 2022-8-8 11-05-53" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 11-05-53</figcaption></figure><h5 id="_2、登陆后访问登录页跳转到首页" tabindex="-1"><a class="header-anchor" href="#_2、登陆后访问登录页跳转到首页" aria-hidden="true">#</a> 2、登陆后访问登录页跳转到首页</h5><p>去掉<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config.GulimallWebConfig</code>类的<code>addViewControllers</code>方法的<code>registry.addViewController(&quot;/login.html&quot;).setViewName(&quot;login&quot;);</code>这行代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//registry.addViewController(&quot;/login.html&quot;).setViewName(&quot;login&quot;);</span>
    registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/reg.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;reg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.2.1.png" alt="image-20220808110902908" tabindex="0" loading="lazy"><figcaption>image-20220808110902908</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类里添加<code>loginPage</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> hasLogin <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasLogin<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.2.2.png" alt="image-20220808111407538" tabindex="0" loading="lazy"><figcaption>image-20220808111407538</figcaption></figure><p>重启<code>gulimall-auth-server</code>模块和<code>gulimall-product</code>模块，如果已登录，访问 http://auth.gulimall.com/login.html 会重定向到 http://gulimall.com/ 页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.2.3.gif" alt="GIF 2022-8-8 11-14-19" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 11-14-19</figcaption></figure><p>由于注册时没有昵称，所以 http://gulimall.com/ 页面没有显示昵称</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.2.4.gif" alt="GIF 2022-8-8 11-19-32" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 11-19-32</figcaption></figure><h5 id="_3、显示昵称" tabindex="-1"><a class="header-anchor" href="#_3、显示昵称" aria-hidden="true">#</a> 3、显示昵称</h5><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberServiceImpl</code>类的<code>regist</code>方法里添加<code>memberEntity.setNickname(vo.getUsername());</code>，设置用户名就是昵称</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">regist</span><span class="token punctuation">(</span><span class="token class-name">MemberRegistVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberDao</span> baseMapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">;</span>
    <span class="token class-name">MemberEntity</span> memberEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemberEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MemberLevelEntity</span> memberLevelEntity <span class="token operator">=</span> memberLevelDao<span class="token punctuation">.</span><span class="token function">getDefaultLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setLevelId</span><span class="token punctuation">(</span>memberLevelEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//检查手机号和用户名是否唯一，使用异常机制</span>
    <span class="token function">checkPhoneUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkUsernameUnique</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    memberEntity<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    memberEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//默认用户名也是昵称</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//盐值加密</span>
    <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> encode <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    memberEntity<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>memberEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.3.1.png" alt="image-20220808112252595" tabindex="0" loading="lazy"><figcaption>image-20220808112252595</figcaption></figure><p>修改<code>gulimall_ums</code>数据库的<code>ums_member</code>表的<code>username</code>为<code>test01</code>的<code>nickname</code>为<code>test01</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.3.2.png" alt="image-20220808113149618" tabindex="0" loading="lazy"><figcaption>image-20220808113149618</figcaption></figure><p>修改<code>gulimall-product</code>模块<code>src/main/resources/templates/item.html</code>文件<code>你好，请登录</code>周围代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>欢迎：[[\${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> |<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aa<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> |<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jingdong<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的京东<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>glyphicon glyphicon-menu-down<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.3.3.png" alt="image-20220808113051591" tabindex="0" loading="lazy"><figcaption>image-20220808113051591</figcaption></figure><p>重启<code>gulimall-member</code>模块和<code>gulimall-product</code>模块，此时就显示昵称了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.3.4.png" alt="image-20220808145909993" tabindex="0" loading="lazy"><figcaption>image-20220808145909993</figcaption></figure><h5 id="_4、修改logo" tabindex="-1"><a class="header-anchor" href="#_4、修改logo" aria-hidden="true">#</a> 4、修改logo</h5><p>在 http://item.gulimall.com/9.html 页面里，选择logo所在的元素，将其src修改为本项目的logo</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.4.1.png" alt="image-20220808150733517" tabindex="0" loading="lazy"><figcaption>image-20220808150733517</figcaption></figure><p>我们项目的logo是在linux的 <code>/mydata/nginx/html/static/item/image/logo1.jpg</code>位置</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>/mydata/nginx/html/static/item/image/logo1.jpg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.4.2.png" alt="image-20220808150750988" tabindex="0" loading="lazy"><figcaption>image-20220808150750988</figcaption></figure><p>修改<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件的logo的src</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;div class=&quot;nav_top_one&quot;&gt;&lt;a href=&quot;http://gulimall.com&quot;&gt;&lt;img src=&quot;/static/item/image/logo1.jpg&quot;/&gt;&lt;/a&gt;&lt;/div&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.4.3.png" alt="image-20221226133616234" tabindex="0" loading="lazy"><figcaption>image-20221226133616234</figcaption></figure><p>重启<code>gulimall-product</code>模块，访问 http://item.gulimall.com/9.html 页面，可以看到logo显示正确</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.5.4.4.gif" alt="GIF 2022-8-8 15-09-51" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 15-09-51</figcaption></figure><h4 id="_6、gulimall-search整合spring-session" tabindex="-1"><a class="header-anchor" href="#_6、gulimall-search整合spring-session" aria-hidden="true">#</a> 6、<code>gulimall-search</code>整合Spring Session</h4><p>在<code>gulimall-search</code>模块的<code>pom.xml</code>文件里添加如下依赖</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>操作redis的客户端<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>用redis存session<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>session<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.6.1.png" alt="image-20220808151427429" tabindex="0" loading="lazy"><figcaption>image-20220808151427429</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>src/main/resources/application.yml</code>文件里配置redis的连接信息和session的存储类型</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.56.10
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
  <span class="token key atrule">session</span><span class="token punctuation">:</span>
    <span class="token key atrule">store-type</span><span class="token punctuation">:</span> redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.6.2.png" alt="image-20220808151631945" tabindex="0" loading="lazy"><figcaption>image-20220808151631945</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplication</code>类上添加<code>@EnableRedisHttpSession</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.6.3.png" alt="image-20220808151736196" tabindex="0" loading="lazy"><figcaption>image-20220808151736196</figcaption></figure><p>复制一份<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.config.GulimallSessionConfig</code>，粘贴到<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.config</code>包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">CookieSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">DefaultCookieSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSessionConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CookieSerializer</span> <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultCookieSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// We customize the name of the cookie to be JSESSIONID.</span>
        serializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;GULIMALL_JSESSIONID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serializer<span class="token punctuation">.</span><span class="token function">setDomainName</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">////We customize the path of the cookie to be / (rather than the default of the context root).</span>
        <span class="token comment">//serializer.setCookiePath(&quot;/&quot;);</span>
        <span class="token comment">////If the regular expression matches, the first grouping is used as the domain.</span>
        <span class="token comment">////This means that a request to https://child.example.com sets the domain to example.com.</span>
        <span class="token comment">////However, a request to http://localhost:8080/ or https://192.168.1.100:8080/ leaves the cookie unset and,</span>
        <span class="token comment">//// thus, still works in development without any changes being necessary for production.</span>
        <span class="token comment">////亲测不生效</span>
        <span class="token comment">//serializer.setDomainNamePattern(&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;);</span>
        <span class="token keyword">return</span> serializer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionDefaultRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.6.4.png" alt="image-20220808151859307" tabindex="0" loading="lazy"><figcaption>image-20220808151859307</figcaption></figure><p>修改<code>gulimall-search</code>模块的<code>src/main/resources/templates/list.html</code>文件的<code>你好，请登录</code>周围代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>欢迎：[[\${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>li_2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.6.5.png" alt="image-20220808152108212" tabindex="0" loading="lazy"><figcaption>image-20220808152108212</figcaption></figure><p>重启<code>gulimall-search</code>模块，访问 http://search.gulimall.com/list.html?catalog3Id=225 页面，这里就显示昵称了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.6.6.6.png" alt="image-20220808152237367" tabindex="0" loading="lazy"><figcaption>image-20220808152237367</figcaption></figure><h3 id="_5-7-7、单点登录" tabindex="-1"><a class="header-anchor" href="#_5-7-7、单点登录" aria-hidden="true">#</a> 5.7.7、单点登录</h3><h4 id="_1、单点登录系统" tabindex="-1"><a class="header-anchor" href="#_1、单点登录系统" aria-hidden="true">#</a> 1、单点登录系统</h4><p>参考链接： https://blog.csdn.net/MyNAMS/article/details/123855044</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.1.0.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_1、早期单一服务器-用户认证" tabindex="-1"><a class="header-anchor" href="#_1、早期单一服务器-用户认证" aria-hidden="true">#</a> 1、早期单一服务器，用户认证</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.1.1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>缺点：单点性能压力，无法扩展</p><h5 id="_2、web应用集群-session共享模式" tabindex="-1"><a class="header-anchor" href="#_2、web应用集群-session共享模式" aria-hidden="true">#</a> 2、WEB应用集群，session共享模式</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.1.2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>解决了单点性能瓶颈。</p><p>问题：</p><ul><li>1、 多业务分布式数据独立管理，不适合统一维护一份session数据。</li><li>2、 分布式按业务功能切分，用户、认证解耦出来单独统一管理。</li><li>3、 cookie中使用jsessionId 容易被篡改、盗取。</li><li>4、 跨顶级域名无法访问。</li></ul><h5 id="_3、分布式-sso-single-sign-on-模式" tabindex="-1"><a class="header-anchor" href="#_3、分布式-sso-single-sign-on-模式" aria-hidden="true">#</a> 3、分布式，SSO(single sign on)模式</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.1.3.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>解决 ： 用户身份信息独立管理，更好的分布式管理。 可以自己扩展安全策略 跨域不是问题</p><p>缺点： 认证服务器访问压力较大。</p><h5 id="_4、业务流程图" tabindex="-1"><a class="header-anchor" href="#_4、业务流程图" aria-hidden="true">#</a> 4、业务流程图</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.1.4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="_5、生成token" tabindex="-1"><a class="header-anchor" href="#_5、生成token" aria-hidden="true">#</a> 5、生成token</h5>`,90),G={href:"https://so.csdn.net/so/search?q=JWT&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},L=n("ul",null,[n("li",null,"JWT（Json Web Token） 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准。"),n("li",null,"JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源。比如用在用户登录上"),n("li",null,"JWT 最重要的作用就是对 token信息的防伪作用。"),n("li",null,"JWT的原理， 一个JWT由三个部分组成：公共部分、私有部分、签名部分。最后由这三者组合进行base64编码得到JWT。")],-1),U=n("figure",null,[n("img",{src:"https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.1.5.png",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),D=n("li",null,[n("p",null,"公共部分 主要是该JWT的相关配置参数，比如签名的加密算法、格式类型、过期时间等等。")],-1),V=n("li",null,[n("p",null,"私有部分 用户自定义的内容，根据实际需要真正要封装的信息。")],-1),H=n("li",null,[n("p",null,"签名部分 根据用户信息+盐值+密钥生成的签名。如果想知道JWT是否是真实的只要把JWT的信息取出来，加上盐值和服务器中的密钥就可以验证真伪。所以不管由谁保存JWT，只要没有密钥就无法伪造。")],-1),J={href:"https://so.csdn.net/so/search?q=base64%E7%BC%96%E7%A0%81&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"},B=t('<h4 id="_2、使用开源框架" tabindex="-1"><a class="header-anchor" href="#_2、使用开源框架" aria-hidden="true">#</a> 2、使用开源框架</h4><p>多系统-单点登录业务，适用于多系统的父域名不同</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.0.png" alt="image-20220808152551728" tabindex="0" loading="lazy"><figcaption>image-20220808152551728</figcaption></figure><h5 id="_1、下载" tabindex="-1"><a class="header-anchor" href="#_1、下载" aria-hidden="true">#</a> 1、下载</h5>',4),$=n("code",null,"xxl",-1),W={href:"https://gitee.com/xuxueli0323",target:"_blank",rel:"noopener noreferrer"},K={href:"https://gitee.com/xuxueli0323/xxl-sso",target:"_blank",rel:"noopener noreferrer"},Q=t(`<p>https://gitee.com/xuxueli0323/xxl-sso?_from=gitee_search</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.1.1.gif" alt="GIF 2022-8-8 15-34-35" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 15-34-35</figcaption></figure><p>目录结构</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>doc
xxl-sso-core     核心包
xxl-sso-samples  简单的例子
xxl-sso-server   服务器
.gitignore
LICENSE
pom.xml
README.md
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.1.2.png" alt="image-20220808154616794" tabindex="0" loading="lazy"><figcaption>image-20220808154616794</figcaption></figure><h5 id="_2、启动登录服务" tabindex="-1"><a class="header-anchor" href="#_2、启动登录服务" aria-hidden="true">#</a> 2、启动登录服务</h5><p>在<code>hosts</code>文件里添加如下3个域名，<code>ssoserver.com</code>用作登录服务，<code>client1.com</code>和<code>client2.com</code>表示其他系统</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>127.0.0.1 ssoserver.com
127.0.0.1 client1.com
127.0.0.1 client2.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.2.1.png" alt="image-20220808163921294" tabindex="0" loading="lazy"><figcaption>image-20220808163921294</figcaption></figure><p>在<code>xxl-sso\\xxl-sso-server\\src\\main\\resources</code>的<code>application.properties</code>配置文件里，修改redis的连接地址</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">### web</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8080</span>
<span class="token key attr-name">server.context-path</span><span class="token punctuation">=</span><span class="token value attr-value">/xxl-sso-server</span>

<span class="token comment">### resources</span>
<span class="token key attr-name">spring.mvc.static-path-pattern</span><span class="token punctuation">=</span><span class="token value attr-value">/static/**</span>
<span class="token key attr-name">spring.resources.static-locations</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:/static/</span>

<span class="token comment">### freemarker</span>
<span class="token key attr-name">spring.freemarker.templateLoaderPath</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:/templates/</span>
<span class="token key attr-name">spring.freemarker.suffix</span><span class="token punctuation">=</span><span class="token value attr-value">.ftl</span>
<span class="token key attr-name">spring.freemarker.charset</span><span class="token punctuation">=</span><span class="token value attr-value">UTF-8</span>
<span class="token key attr-name">spring.freemarker.request-context-attribute</span><span class="token punctuation">=</span><span class="token value attr-value">request</span>
<span class="token key attr-name">spring.freemarker.settings.number_format</span><span class="token punctuation">=</span><span class="token value attr-value">0.##########</span>

<span class="token comment">### xxl-sso</span>
<span class="token key attr-name">xxl.sso.redis.address</span><span class="token punctuation">=</span><span class="token value attr-value">redis://192.168.56.10:6379</span>
<span class="token key attr-name">xxl.sso.redis.expire.minute</span><span class="token punctuation">=</span><span class="token value attr-value">1440</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.2.2.png" alt="image-20220808154834016" tabindex="0" loading="lazy"><figcaption>image-20220808154834016</figcaption></figure><p>在<code>xxl-sso</code>文件夹下执行如下命名，打包该项目</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mvn clean package -Dmaven.skip.test=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.2.3.png" alt="image-20220808160221190" tabindex="0" loading="lazy"><figcaption>image-20220808160221190</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary for xxl-sso 1.1.1-SNAPSHOT:
[INFO]
[INFO] xxl-sso ............................................ SUCCESS [  0.147 s]
[INFO] xxl-sso-core ....................................... SUCCESS [  5.561 s]
[INFO] xxl-sso-server ..................................... SUCCESS [ 33.224 s]
[INFO] xxl-sso-samples .................................... SUCCESS [  0.009 s]
[INFO] xxl-sso-web-sample-springboot ...................... SUCCESS [  0.720 s]
[INFO] xxl-sso-token-sample-springboot .................... SUCCESS [  1.147 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  45.392 s
[INFO] Finished at: 2022-08-08T15:59:35+08:00
[INFO] ------------------------------------------------------------------------
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.2.4.png" alt="image-20220808160223642" tabindex="0" loading="lazy"><figcaption>image-20220808160223642</figcaption></figure><p>在<code>xxl-sso\\xxl-sso-server\\target</code>文件夹里执行如下命令，启动<code>xxl-sso-server-1.1.1-SNAPSHOT.jar</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java -jar xxl-sso-server-1.1.1-SNAPSHOT.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.2.5.png" alt="image-20220808160440611" tabindex="0" loading="lazy"><figcaption>image-20220808160440611</figcaption></figure><p>打开 http://ssoserver.com:8080/xxl-sso-server/login 网页，这里用于登录</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.2.6.png" alt="image-20220808161012786" tabindex="0" loading="lazy"><figcaption>image-20220808161012786</figcaption></figure><h5 id="_3、启动其他服务" tabindex="-1"><a class="header-anchor" href="#_3、启动其他服务" aria-hidden="true">#</a> 3、启动其他服务</h5><p>在<code>xxl-sso\\xxl-sso-samples\\xxl-sso-web-sample-springboot\\src\\main\\resources</code>文件夹的<code>application.properties</code>配置文件里，修改<code>xxl.sso.server</code>和<code>xxl.sso.redis.address</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">### web</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8081</span>
<span class="token key attr-name">server.context-path</span><span class="token punctuation">=</span><span class="token value attr-value">/xxl-sso-web-sample-springboot</span>

<span class="token comment">### freemarker</span>
<span class="token key attr-name">spring.freemarker.request-context-attribute</span><span class="token punctuation">=</span><span class="token value attr-value">request</span>
<span class="token key attr-name">spring.freemarker.cache</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>

<span class="token comment">### resource (default: /**  + classpath:/static/ )</span>
<span class="token key attr-name">spring.mvc.static-path-pattern</span><span class="token punctuation">=</span><span class="token value attr-value">/static/**</span>
<span class="token key attr-name">spring.resources.static-locations</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:/static/</span>

<span class="token comment">### xxl-sso</span>
<span class="token key attr-name">xxl.sso.server</span><span class="token punctuation">=</span><span class="token value attr-value">http://ssoserver.com:8080/xxl-sso-server</span>
<span class="token key attr-name">xxl.sso.logout.path</span><span class="token punctuation">=</span><span class="token value attr-value">/logout</span>
<span class="token key attr-name">xxl-sso.excluded.paths</span><span class="token punctuation">=</span>
<span class="token key attr-name">xxl.sso.redis.address</span><span class="token punctuation">=</span><span class="token value attr-value">redis://192.168.56.10:6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.1.png" alt="image-20220808160926998" tabindex="0" loading="lazy"><figcaption>image-20220808160926998</figcaption></figure><p>进入<code>xxl-sso\\xxl-sso-samples\\xxl-sso-web-sample-springboot</code>文件夹，执行如下命令</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mvn clean package -Dmaven.skip.test=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里打包失败了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>A:\\桌面\\xxl-sso\\xxl-sso-samples\\xxl-sso-web-sample-springboot&gt;mvn clean package -Dmaven.skip.test=true
[INFO] Scanning for projects...
[WARNING]
[WARNING] Some problems were encountered while building the effective model for com.xuxueli:xxl-sso-web-sample-springboot:jar:1.1.1-SNAPSHOT
[WARNING] The expression \${parent.version} is deprecated. Please use \${project.parent.version} instead.
[WARNING]
[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.
[WARNING]
[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.
[WARNING]
[INFO]
[INFO] -------------&lt; com.xuxueli:xxl-sso-web-sample-springboot &gt;--------------
[INFO] Building xxl-sso-web-sample-springboot 1.1.1-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[WARNING] The POM for com.xuxueli:xxl-sso-core:jar:1.1.1-SNAPSHOT is missing, no dependency information available
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  0.599 s
[INFO] Finished at: 2022-08-08T16:12:04+08:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal on project xxl-sso-web-sample-springboot: Could not resolve dependencies for project com.xuxueli:xxl-sso-web-sample-springboot:jar:1.1.1-SNAPSHOT: Could not find artifact com.xuxueli:xxl-sso-core:jar:1.1.1-SNAPSHOT -&gt; [Help 1]
[ERROR]
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR]
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/DependencyResolutionException
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.2.png" alt="image-20220808161239078" tabindex="0" loading="lazy"><figcaption>image-20220808161239078</figcaption></figure><p>进入到<code>xxl-sso\\xxl-sso-core</code>文件夹，执行如下命令</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mvn install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.3.png" alt="image-20220808161633658" tabindex="0" loading="lazy"><figcaption>image-20220808161633658</figcaption></figure><p>再进入<code>xxl-sso\\xxl-sso-samples\\xxl-sso-web-sample-springboot</code>文件夹，执行如下命令，执行还是失败了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mvn clean package -Dmaven.skip.test=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.4.png" alt="image-20220808161845005" tabindex="0" loading="lazy"><figcaption>image-20220808161845005</figcaption></figure><p>把刚刚启动的<code>xxl-sso-server</code>关了，重新在<code>xxl-sso</code>里打包</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mvn clean package -Dmaven.skip.test=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.5.png" alt="image-20220808162150355" tabindex="0" loading="lazy"><figcaption>image-20220808162150355</figcaption></figure><p>这次就全部成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.6.png" alt="image-20220808162152659" tabindex="0" loading="lazy"><figcaption>image-20220808162152659</figcaption></figure><p>在<code>xxl-sso\\xxl-sso-server\\target</code>文件夹里执行如下命令，启动<code>xxl-sso-server-1.1.1-SNAPSHOT.jar</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java -jar xxl-sso-server-1.1.1-SNAPSHOT.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.7.png" alt="image-20220808162309292" tabindex="0" loading="lazy"><figcaption>image-20220808162309292</figcaption></figure><p>在<code>xxl-sso\\xxl-sso-samples\\xxl-sso-web-sample-springboot\\target</code>文件夹里使用如下命令，在<code>8081</code>端口启动一个其他系统</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java -jar xxl-sso-web-sample-springboot-1.1.1-SNAPSHOT.jar --server.port=8081
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.8.png" alt="image-20220808162611834" tabindex="0" loading="lazy"><figcaption>image-20220808162611834</figcaption></figure><p>在<code>xxl-sso\\xxl-sso-samples\\xxl-sso-web-sample-springboot\\target</code>文件夹里使用如下命令，再在<code>8082</code>端口启动一个</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java -jar xxl-sso-web-sample-springboot-1.1.1-SNAPSHOT.jar --server.port=8082
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.9.png" alt="image-20220808162822238" tabindex="0" loading="lazy"><figcaption>image-20220808162822238</figcaption></figure><p>一次打开如下网址</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ssoserver.com:8080/xxl-sso-server
client1.com:8081/xxl-sso-web-sample-springboot
client2.com:8082/xxl-sso-web-sample-springboot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到当一个系统登陆后各个系统都登录了，当一个系统退出登陆后，各个系统都退出登录了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.2.3.10.gif" alt="GIF 2022-8-8 16-36-19" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 16-36-19</figcaption></figure><p>原理：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>/xxl-sso-server 登录服务器 8080 ssoserver.com

/xxl-sso-web-sample-springboot 项目1 8081 client1.com
/xxl-sso-web-sample-springboot 项目2 8082 client2.com

127.0.0.1 ssoserver.com
127.0.0.1 client1.com
127.0.0.1 client2.com

核心：三个系统即使域名不一样，想办法给三个系统同步同一个用户的票据；
1)、中央认证服务器；ssoserver.com
2)、其他系统，想要登录去ssoserver.com登录，登录成功跳转回来  
3）、只要有一个登录，其他都不用登录
4）、全系统统一一个sso-sessionid；所有系统可能域名都不相同
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、自己实现单点登录" tabindex="-1"><a class="header-anchor" href="#_3、自己实现单点登录" aria-hidden="true">#</a> 3、自己实现单点登录</h4><h5 id="_1、新建登录服务" tabindex="-1"><a class="header-anchor" href="#_1、新建登录服务" aria-hidden="true">#</a> 1、新建登录服务</h5><p>新建一个模块，<code>Group</code>输入<code>com.atguigu</code>，<code>Artifact</code>输入<code>gulimall-test-sso-server</code>，<code>Type</code>选择<code>Maven</code>，<code>Language</code>选择<code>Java</code>，<code>Packaging</code>选择<code>Jar</code>，<code>Java Version</code>选择<code>8</code>，<code>Version</code>不用管，<code>Name</code>输入<code>gulimall-test-sso-server</code>，<code>Despcription</code>输入<code>单点登录的认证服务器</code>，<code>Package</code>输入<code>com.atguigu.gulimall.ssoserver</code>，然后点击<code>Next</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>com.atguigu
gulimall-test-sso-server
单点登录的认证服务器
com.atguigu.gulimall.ssoserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.1.png" alt="image-20220808164835763" tabindex="0" loading="lazy"><figcaption>image-20220808164835763</figcaption></figure><p>选择<code>Lombox</code>和<code>Spring Web</code>，然后点击<code>Next</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.2.png" alt="image-20220808164915849" tabindex="0" loading="lazy"><figcaption>image-20220808164915849</figcaption></figure><p>点击<code>Finish</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.3.png" alt="image-20220808164933481" tabindex="0" loading="lazy"><figcaption>image-20220808164933481</figcaption></figure><p>如果刚刚新建的<code>gulimall-test-sso-server</code>模块的<code>pom.xml</code>文件为赤橙色，可以选中<code>pom.xml</code>文件，然后右键，选择<code>Add as Maven Project</code>即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.4.png" alt="image-20220808165028477" tabindex="0" loading="lazy"><figcaption>image-20220808165028477</figcaption></figure><p>以下内容不替换</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-test-sso-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>gulimall-test-sso-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>单点登录的认证服务器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了版本统一，<code>&lt;properties&gt;</code>、<code>&lt;build&gt;</code>、<code>&lt;parent&gt;</code>等都要替换</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.5.png" alt="image-20220808165509451" tabindex="0" loading="lazy"><figcaption>image-20220808165509451</figcaption></figure><p><a href="code/5.7.7.3.1.pom.xml">点击查看完整的<code>gulimall-test-sso-server</code>模块的<code>pom.xml</code>文件</a></p><p>修改<code>gulimall-test-sso-server</code>模块的<code>src/test/java/com/atguigu/gulimall/ssoserver/GulimallTestSsoServerApplicationTests.java</code>测试类为junit5相关的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ssoserver</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallTestSsoServerApplicationTests</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.6.png" alt="image-20220808165630258" tabindex="0" loading="lazy"><figcaption>image-20220808165630258</figcaption></figure><p>在<code>gulimall-test-sso-server</code>模块的<code>pom.xml</code>文件里添加如下依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.1.7.png" alt="image-20220808171653464" tabindex="0" loading="lazy"><figcaption>image-20220808171653464</figcaption></figure><h5 id="_2、新建其他系统" tabindex="-1"><a class="header-anchor" href="#_2、新建其他系统" aria-hidden="true">#</a> 2、新建其他系统</h5><p>新建一个模块，<code>Group</code>输入<code>com.atguigu</code>，<code>Artifact</code>输入<code>gulimall-test-sso-client</code>，<code>Type</code>选择<code>Maven</code>，<code>Language</code>选择<code>Java</code>，<code>Packaging</code>选择<code>Jar</code>，<code>Java Version</code>选择<code>8</code>，<code>Version</code>不用管，<code>Name</code>输入<code>gulimall-test-sso-client</code>，<code>Despcription</code>输入<code>单点登录的客户端</code>，<code>Package</code>输入<code>com.atguigu.gulimall.ssoclient</code>，然后点击<code>Next</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>com.atguigu
gulimall-test-sso-client
单点登录的客户端
com.atguigu.gulimall.ssoclient
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.2.1.png" alt="image-20220808170027100" tabindex="0" loading="lazy"><figcaption>image-20220808170027100</figcaption></figure><p>选择<code>Lombox</code>、<code>Spring Web</code>、<code>Thymeleaf</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.2.2.png" alt="image-20220808170030445" tabindex="0" loading="lazy"><figcaption>image-20220808170030445</figcaption></figure><p>点击<code>Finish</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.2.3.png" alt="image-20220808170032561" tabindex="0" loading="lazy"><figcaption>image-20220808170032561</figcaption></figure><p>如果刚刚新建的<code>gulimall-test-sso-client</code>模块的<code>pom.xml</code>文件为赤橙色，可以选中<code>pom.xml</code>文件，然后右键，选择<code>Add as Maven Project</code>即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.2.4.png" alt="image-20220808170214945" tabindex="0" loading="lazy"><figcaption>image-20220808170214945</figcaption></figure><p>同样的为了版本统一，以下内容不替换，<code>&lt;properties&gt;</code>、<code>&lt;build&gt;</code>、<code>&lt;parent&gt;</code>等都要替换</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-test-sso-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>gulimall-test-sso-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>单点登录的客户端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.2.5.png" alt="image-20220808170659953" tabindex="0" loading="lazy"><figcaption>image-20220808170659953</figcaption></figure>`,92),X=n("code",null,"gulimall-test-sso-client",-1),Y=n("code",null,"pom.xml",-1),Z=t(`<p>修改<code>gulimall-test-sso-client</code>模块的<code>src/test/java/com/atguigu/gulimall/ssoclient/GulimallTestSsoClientApplicationTests.java</code>测试类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ssoclient</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallTestSsoClientApplicationTests</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.2.6.png" alt="image-20220808170935951" tabindex="0" loading="lazy"><figcaption>image-20220808170935951</figcaption></figure><h5 id="_3、其他系统添加接口" tabindex="-1"><a class="header-anchor" href="#_3、其他系统添加接口" aria-hidden="true">#</a> 3、其他系统添加接口</h5><p>在<code>gulimall-test-sso-client</code>模块的<code>com.atguigu.gulimall.ssoclient</code>包下新建<code>controller</code>文件夹，在<code>controller</code>文件夹下新建<code>HelloController</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ssoclient<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ui<span class="token punctuation">.</span></span><span class="token class-name">Model</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/8
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 不登录就可以访问
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 必须登录才可访问
     * <span class="token keyword">@param</span> <span class="token parameter">model</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.3.1.png" alt="image-20220808185455496" tabindex="0" loading="lazy"><figcaption>image-20220808185455496</figcaption></figure><p>在<code>gulimall-test-sso-client</code>模块的<code>src/main/resources</code>文件夹下新建<code>templates</code>文件夹，在<code>templates</code>文件夹下新建<code>list.html</code>文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>员工列表<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>欢迎： []<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>emp: \${emps}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>姓名： [[\${emp}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.3.2.png" alt="image-20220808192145135" tabindex="0" loading="lazy"><figcaption>image-20220808192145135</figcaption></figure><p>在<code>gulimall-test-sso-client</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下配置，将端口号改为<code>8081</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8081</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.3.3.png" alt="image-20220808185548331" tabindex="0" loading="lazy"><figcaption>image-20220808185548331</figcaption></figure><p>（我第一次访问的时候用<code>chrome浏览器</code>访问<code>client1.com:8081/hello</code>、<code>localhost:8081/hello</code>、<code>127.0.0.1:8081/hello</code>都访问不了，最后换用<code>Edge浏览器</code>可以访问，再换回<code>chrome浏览器</code>也可以访问了，就很奇怪）</p><p>http://client1.com:8081/employees</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.3.4.png" alt="image-20220808192355709" tabindex="0" loading="lazy"><figcaption>image-20220808192355709</figcaption></figure><p>http://client1.com:8081/hello</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.3.5.png" alt="image-20220808192358289" tabindex="0" loading="lazy"><figcaption>image-20220808192358289</figcaption></figure><p>可以看到都可以访问</p><h5 id="_4、登录系统添加接口" tabindex="-1"><a class="header-anchor" href="#_4、登录系统添加接口" aria-hidden="true">#</a> 4、登录系统添加接口</h5><p>在<code>gulimall-test-sso-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，将端口号修改为<code>8080</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8080</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.4.1.png" alt="image-20220808193333216" tabindex="0" loading="lazy"><figcaption>image-20220808193333216</figcaption></figure><p>在<code>gulimall-test-sso-server</code>模块的<code>src/main/resources</code>文件夹下新建<code>templates</code>文件夹，在<code>templates</code>文件夹下新建<code>login.html</code>文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>登录页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/doLogin<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    用户名： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    密码： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>登录<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.4.2.png" alt="image-20220808193648749" tabindex="0" loading="lazy"><figcaption>image-20220808193648749</figcaption></figure><h5 id="_5、其他系统添加配置" tabindex="-1"><a class="header-anchor" href="#_5、其他系统添加配置" aria-hidden="true">#</a> 5、其他系统添加配置</h5><p>在<code>gulimall-test-sso-client</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，指定登录服务的url</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sso.server.url=http://ssoserver.com:8080/login.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.5.1.png" alt="image-20220808194725231" tabindex="0" loading="lazy"><figcaption>image-20220808194725231</figcaption></figure><p>（不引用<code>spring-session-data-redis</code>，这里没少步骤，后面还会用其他方法的）</p><p>修改<code>gulimall-test-sso-client</code>模块的<code>com.atguigu.gulimall.ssoclient.controller.HelloController</code>类的<code>employees</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 必须登录才可访问
 * <span class="token keyword">@param</span> <span class="token parameter">model</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//如果没登录，就跳转到登录服务器进行登录</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> serverUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.5.2.png" alt="image-20220808194719427" tabindex="0" loading="lazy"><figcaption>image-20220808194719427</figcaption></figure><p>只启动<code>GulimallTestSsoClientApplication</code>服务，不启动<code>GulimallTestSsoServerApplication</code>服务</p><p>可以看到在<code>http://client1.com:8081/employees</code>页面，自动跳转到了<code>http://ssoserver.com:8080/login.html</code></p><p><code>General</code>里的<code>Request URL:</code>为<code>http://client1.com:8081/employees</code>，<code>Response Headers</code>里的<code>Location:</code>为 <code>http://ssoserver.com:8080/login.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.5.3.gif" alt="GIF 2022-8-8 19-58-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 19-58-02</figcaption></figure><h5 id="_6、登录系统添加接口并测试" tabindex="-1"><a class="header-anchor" href="#_6、登录系统添加接口并测试" aria-hidden="true">#</a> 6、登录系统添加接口并测试</h5><p>在<code>gulimall-test-sso-server</code>模块的<code>com.atguigu.gulimall.ssoserver.controller.LoginController</code>类里添加<code> loginPage</code>方法，跳转到登录页</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.6.1.png" alt="image-20220808195103772" tabindex="0" loading="lazy"><figcaption>image-20220808195103772</figcaption></figure><p>启动<code>GulimallTestSsoServerApplication</code>服务</p><p>访问<code>http://client1.com/8081/employees</code>页面，可以看到可以正确跳转到<code>http://ssoserver.com:8080/login.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.6.2.gif" alt="GIF 2022-8-8 20-29-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 20-29-31</figcaption></figure><p>我发现一个很玄学的事情，明明url是对的，但就是访问不了，只有上一个访问成功了才能访问的到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.6.3.gif" alt="GIF 2022-8-8 20-11-42" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 20-11-42</figcaption></figure><p>😰</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.6.4.gif" alt="GIF 2022-8-8 20-18-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 20-18-38</figcaption></figure><h5 id="_7、登录成功后返回" tabindex="-1"><a class="header-anchor" href="#_7、登录成功后返回" aria-hidden="true">#</a> 7、登录成功后返回</h5><p>可以像这样，重定向的时候指定redirect_url告诉登录服务登录成功后要跳转的url，这样登录服务器就知道要返回到哪个地址了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://ssoserver.com:8080/login.html?redirect_url=http://client1.com/8081/employees
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.1.png" alt="image-20220808202029647" tabindex="0" loading="lazy"><figcaption>image-20220808202029647</figcaption></figure><p>修改<code>gulimall-test-sso-client</code>模块的<code>src/main/java/com/atguigu/gulimall/ssoclient/controller/HelloController.java</code>类的<code>employees</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 必须登录才可访问
 * <span class="token keyword">@param</span> <span class="token parameter">model</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//通过该方法获取到的是： http://127.0.0.1:8081/employees</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果没登录，就跳转到登录服务器进行登录</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> serverUrl<span class="token operator">+</span><span class="token string">&quot;?redirect_url=http://client1.com:8081/employees&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.2.png" alt="image-20220808205501228" tabindex="0" loading="lazy"><figcaption>image-20220808205501228</figcaption></figure><p>修改<code>gulimall-test-sso-server</code>模块<code>src/main/java/com/atguigu/gulimall/ssoserver/controller/LoginController.java</code>类的<code>loginPage</code>方法，向<code>model</code>里添加<code>url</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_url&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.3.png" alt="image-20220808204153711" tabindex="0" loading="lazy"><figcaption>image-20220808204153711</figcaption></figure><p>在<code>gulimall-test-sso-server</code>模块的<code>src/main/resources/templates/login.html</code>文件里引入<code>thymeleaf</code>，添加隐藏的<code>&lt;input&gt;</code>框，指定登陆成功跳转的url</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>登录页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/doLogin<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    用户名： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    密码： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${url}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>登录<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.4.png" alt="image-20220808204329424" tabindex="0" loading="lazy"><figcaption>image-20220808204329424</figcaption></figure><p>在<code>gulimall-test-sso-server</code>模块的<code>com.atguigu.gulimall.ssoserver.controller.LoginController</code>类里，添加<code>&quot;/doLogin</code>方法，用于处理表单登录请求</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doLogin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">String</span> password<span class="token punctuation">,</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//如果username、password、url都不为空，就返回之前页</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果其中一个为空，就跳转到登录页</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.5.png" alt="image-20220808204955764" tabindex="0" loading="lazy"><figcaption>image-20220808204955764</figcaption></figure><p>重启<code>gulimall-test-sso-client</code>模块和<code>gulimall-test-sso-server</code>模块，打开如下两个页面，进行测试，发现输入用户名和密码后，貌似没有跳转成功</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://127.0.0.1:8081/employees
http://ssoserver.com:8080/login.html?redirect_url=http://client1.com:8081/employees
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.6.gif" alt="GIF 2022-8-8 20-56-34" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 20-56-34</figcaption></figure><p>以<code>debug</code>的方式启动<code>gulimall-test-sso-server</code>模块，可以看到跳转成功了，只不过判断<code>session</code>里面没有，又跳转过来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.7.7.gif" alt="GIF 2022-8-8 21-02-06" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 21-02-06</figcaption></figure><h5 id="_8、引入redis" tabindex="-1"><a class="header-anchor" href="#_8、引入redis" aria-hidden="true">#</a> 8、引入redis</h5><p>可以在<code>gulimall-test-sso-server</code>模块的<code>pom.xml</code>文件里引入<code>redis</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.8.1.png" alt="image-20220808210826601" tabindex="0" loading="lazy"><figcaption>image-20220808210826601</figcaption></figure><p>在<code>gulimall-test-sso-server</code>模块的<code>src/main/resources/application.properties</code>配置文件里指定redis的host</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.8.2.png" alt="image-20220808210931644" tabindex="0" loading="lazy"><figcaption>image-20220808210931644</figcaption></figure><p>修改<code>gulimall-test-sso-server</code>模块的<code>com.atguigu.gulimall.ssoserver.controller.LoginController</code>类的<code>doLogin</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doLogin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果username、password、url都不为空，就返回之前页</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> url<span class="token operator">+</span><span class="token string">&quot;?token=&quot;</span><span class="token operator">+</span>uuid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果其中一个为空，就跳转到登录页</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.8.3.png" alt="image-20220808211702719" tabindex="0" loading="lazy"><figcaption>image-20220808211702719</figcaption></figure><p>修改<code>gulimall-test-sso-client</code>模块<code>com.atguigu.gulimall.ssoclient.controller.HelloController</code>类的<code> employees</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 必须登录才可访问
 * 只要带了token，就认为这次是在ssoserver登录成功跳回来的。(当然应该在redis里查一下，这里就不做了)
 * <span class="token keyword">@param</span> <span class="token parameter">model</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//去ssoserver登录成功跳回来就会带.上</span>
        <span class="token comment">//TODO 1、去ssoserver获取当前token真正对应的用户信息</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//通过该方法获取到的是： http://127.0.0.1:8081/employees</span>
        <span class="token comment">//HttpServletRequest request=&gt;System.out.println(request.getRequestURL());</span>
        <span class="token comment">//如果没登录，就跳转到登录服务器进行登录</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> serverUrl<span class="token operator">+</span><span class="token string">&quot;?redirect_url=http://client1.com:8081/employees&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.8.4.png" alt="image-20220808213356872" tabindex="0" loading="lazy"><figcaption>image-20220808213356872</figcaption></figure><p>清空cookie 访问 http://client1.com:8081/employees 自动跳转到 http://ssoserver.com:8080/login.html?redirect_url=http://client1.com:8081/employees 页面，登陆成功后返回到了 http://client1.com:8081/employees 页面，并携带了token</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.8.5.gif" alt="GIF 2022-8-8 21-35-59" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-8 21-35-59</figcaption></figure><p>但是这样只能在当前域名下<code>session</code>有效，在另一个域名下还需要再次登录</p><h5 id="_9、多域名登录" tabindex="-1"><a class="header-anchor" href="#_9、多域名登录" aria-hidden="true">#</a> 9、多域名登录</h5><p>复制一个<code>gulimall-test-sso-client</code>模块，起名为<code>gulimall-test-sso-client2</code>，和<code>gulimall-test-sso-client</code>模块差不多，就<code>artifactId</code>和<code>name</code>不一样</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-test-sso-client2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>gulimall-test-sso-client2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>单点登录的客户端<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.1.png" alt="image-20220808214604391" tabindex="0" loading="lazy"><figcaption>image-20220808214604391</figcaption></figure><p>修改<code>gulimall-test-sso-client2</code>模块<code>com.atguigu.gulimall.ssoclient.controller.HelloController</code>类的<code>employees</code>，将映射地址修改为<code>/boss</code>，修改重定向地址<code>redirect_url</code>参数</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 必须登录才可访问
 * 只要带了token，就认为这次是在ssoserver登录成功跳回来的。(当然应该在redis里查一下，这里就不做了)
 * <span class="token keyword">@param</span> <span class="token parameter">model</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/boss&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//去ssoserver登录成功跳回来就会带.上</span>
        <span class="token comment">//TODO 1、去ssoserver获取当前token真正对应的用户信息</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//通过该方法获取到的是： http://127.0.0.1:8081/employees</span>
        <span class="token comment">//HttpServletRequest request=&gt;System.out.println(request.getRequestURL());</span>
        <span class="token comment">//如果没登录，就跳转到登录服务器进行登录</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> serverUrl<span class="token operator">+</span><span class="token string">&quot;?redirect_url=http://client2.com:8082/boss&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.2.png" alt="image-20220809091826538" tabindex="0" loading="lazy"><figcaption>image-20220809091826538</figcaption></figure><p>修改<code>gulimall-test-sso-client2</code>模块的<code>src/main/resources/application.properties</code>配置文件，让其在<code>8082</code>端口启动</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8082</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.3.png" alt="image-20220808214722475" tabindex="0" loading="lazy"><figcaption>image-20220808214722475</figcaption></figure><p>将<code>gulimall-test-sso-client2</code>模块的启动类从<code>GulimallTestSsoClientApplication</code>修改为<code>GulimallTestSsoClient2Application</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.4.png" alt="image-20220808214909403" tabindex="0" loading="lazy"><figcaption>image-20220808214909403</figcaption></figure><p>修改<code>gulimall-test-sso-server</code>模块<code>com.atguigu.gulimall.ssoserver.controller.LoginController</code>类的<code>doLogin</code>方法，只要有人登录了，就给<code>gulimall-test-sso-server</code>服务留一个<code>cookie</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doLogin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果username、password、url都不为空，就返回之前页</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;sso_token&quot;</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> url<span class="token operator">+</span><span class="token string">&quot;?token=&quot;</span><span class="token operator">+</span>uuid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果其中一个为空，就跳转到登录页</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.5.png" alt="image-20220808215406835" tabindex="0" loading="lazy"><figcaption>image-20220808215406835</figcaption></figure><p>可以看到<code>Request URL:</code>请求的url<code>http://ssoserver.com:8080/doLogin</code>，重定向<code>Location:</code>到了<code>http://client1.com:8081/employees?token=9b5fa7861a55409d9d8c6247edcf66a3</code>，还<code>Set-Cookie:</code>了一个<code>sso_token=9b5fa7861a55409d9d8c6247edcf66a3</code>。即在<code>http://ssoserver.com</code>域名下，保存了一个叫<code>sso_token</code>的<code>cookie</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.6.gif" alt="GIF 2022-8-9 9-09-10" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 9-09-10</figcaption></figure><p>在访问<code>http://client2.com:8082/boss</code>的时候，重定向到了<code>http://ssoserver.com:8080/login.html?redirect_url=http://client2.com:8082/employees</code>，在请求<code>http://ssoserver.com:8080/login.html?redirect_url=http://client2.com:8082/employees</code>的时候还带上了<code>cookie</code>为<code>sso_token=4560fbf660304f49b66182214c3ebbd2</code></p><p>那就说明在别的系统下这个用户已经登陆了</p><p>在<code>gulimall-test-sso-server</code>模块的<code>com.atguigu.gulimall.ssoserver.controller.LoginController</code>类的<code>loginPage</code>方法里添加判断，如果有token了，说明已经登陆了，直接重定向到别的系统即可</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_url&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;sso_token&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ssoToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>ssoToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//说明之前有人登录过，浏览器留下了痕迹</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> url<span class="token operator">+</span><span class="token string">&quot;?token=&quot;</span><span class="token operator">+</span>ssoToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.7.png" alt="image-20220809093719928" tabindex="0" loading="lazy"><figcaption>image-20220809093719928</figcaption></figure><p>可以看到，当<code>http://client1.com:8081/employees</code>登录后，<code>http://client2.com:8082/boss</code>就不再需要登陆了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.8.gif" alt="GIF 2022-8-9 9-50-27" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 9-50-27</figcaption></figure><p>在<code>gulimall-test-sso-client</code>模块的<code>src/main/resources/templates/list.html</code>文件里添加欢迎信息</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;h1&gt;欢迎： [[\${session.loginUser}]]&lt;/h1&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.9.png" alt="image-20220809100314882" tabindex="0" loading="lazy"><figcaption>image-20220809100314882</figcaption></figure><p>在<code>gulimall-test-sso-server</code>模块的<code>src/main/java/com/atguigu/gulimall/ssoserver/controller/LoginController.java</code>类里添加如下接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/userInfo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">userInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.10.png" alt="image-20220809100343807" tabindex="0" loading="lazy"><figcaption>image-20220809100343807</figcaption></figure><p>在<code>gulimall-test-sso-client</code>模块的<code>com.atguigu.gulimall.ssoclient.controller.HelloController</code>类里修改<code>employees</code>方法，向<code>gulimall-test-sso-server</code>登录服务根据token查询用户信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 必须登录才可访问
 * 只要带了token，就认为这次是在ssoserver登录成功跳回来的。(当然应该在redis里查一下，这里就不做了)
 * <span class="token keyword">@param</span> <span class="token parameter">model</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/employees&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//去ssoserver登录成功跳回来就会带.上</span>
        <span class="token comment">//TODO 1、去ssoserver获取当前token真正对应的用户信息</span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>
                <span class="token string">&quot;http://ssoserver.com:8080/userInfo?token={token}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> entity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//通过该方法获取到的是： http://127.0.0.1:8081/employees</span>
        <span class="token comment">//HttpServletRequest request=&gt;System.out.println(request.getRequestURL());</span>
        <span class="token comment">//如果没登录，就跳转到登录服务器进行登录</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> serverUrl<span class="token operator">+</span><span class="token string">&quot;?redirect_url=http://client1.com:8081/employees&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.11.png" alt="image-20220809101133644" tabindex="0" loading="lazy"><figcaption>image-20220809101133644</figcaption></figure><p>在<code>gulimall-test-sso-client2</code>模块<code>src/main/resources/templates/list.html</code>文件里添加欢迎信息</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>欢迎： [[\${session.loginUser}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.12.png" alt="image-20220809101348952" tabindex="0" loading="lazy"><figcaption>image-20220809101348952</figcaption></figure><p>在<code>gulimall-test-sso-client2</code>模块的<code>com.atguigu.gulimall.ssoclient.controller.HelloController</code>类里修改<code>employees</code>方法，向<code>gulimall-test-sso-server</code>登录服务根据token查询用户信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 必须登录才可访问
 * 只要带了token，就认为这次是在ssoserver登录成功跳回来的。(当然应该在redis里查一下，这里就不做了)
 * <span class="token keyword">@param</span> <span class="token parameter">model</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/boss&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">employees</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Object</span> loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//去ssoserver登录成功跳回来就会带.上</span>
        <span class="token comment">//TODO 1、去ssoserver获取当前token真正对应的用户信息</span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>
                <span class="token string">&quot;http://ssoserver.com:8080/userInfo?token={token}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> entity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser <span class="token operator">=</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//通过该方法获取到的是： http://127.0.0.1:8081/employees</span>
        <span class="token comment">//HttpServletRequest request=&gt;System.out.println(request.getRequestURL());</span>
        <span class="token comment">//如果没登录，就跳转到登录服务器进行登录</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:&quot;</span> <span class="token operator">+</span> serverUrl<span class="token operator">+</span><span class="token string">&quot;?redirect_url=http://client2.com:8082/boss&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> emps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emps&quot;</span><span class="token punctuation">,</span>emps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.13.png" alt="image-20220809101301993" tabindex="0" loading="lazy"><figcaption>image-20220809101301993</figcaption></figure><p>在<code>http://client1.com:8081/employees</code>网址下登录后</p><p>在<code>ssoserver.com</code>域名留下了一个键为<code>sso_token</code>、值为<code>80d06b51f1fb4fce9e93e2f50e256b38</code>的<code>cookie</code></p><p>访问<code>http://client2.com:8082/boss</code>也无需登录<code>http://client2.com:8082/boss?token=80d06b51f1fb4fce9e93e2f50e256b38</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.7.3.9.14.gif" alt="GIF 2022-8-9 10-15-23" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 10-15-23</figcaption></figure><p>至此就完成了简单的多系统的单点登录功能</p><h3 id="_5-7-8、购物车模块" tabindex="-1"><a class="header-anchor" href="#_5-7-8、购物车模块" aria-hidden="true">#</a> 5.7.8、购物车模块</h3><h4 id="_1、初始化购物车模块" tabindex="-1"><a class="header-anchor" href="#_1、初始化购物车模块" aria-hidden="true">#</a> 1、初始化购物车模块</h4><h5 id="_1、新建购物车模块" tabindex="-1"><a class="header-anchor" href="#_1、新建购物车模块" aria-hidden="true">#</a> 1、新建购物车模块</h5><p>新建一个模块，<code>Group</code>输入<code>com.atguigu</code>，<code>Artifact</code>输入<code>gulimall-cart</code>，<code>Type</code>选择<code>Maven</code>，<code>Language</code>选择<code>Java</code>，<code>Packaging</code>选择<code>Jar</code>，<code>Java Version</code>选择<code>8</code>，<code>Version</code>不用管，<code>Name</code>输入<code>gulimall-cart</code>，<code>Despcription</code>输入<code>购物车</code>，<code>Package</code>输入<code>com.atguigu.gulimall.cart</code>，然后点击<code>Next</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>com.atguigu
gulimall-cart
购物车
com.atguigu.gulimall.cart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.1.1.png" alt="image-20220809102536538" tabindex="0" loading="lazy"><figcaption>image-20220809102536538</figcaption></figure><p>选择<code>Spring Boot DevTools</code>、<code>Spring Web</code>、<code>Thymeleaf</code>、<code>OpenFeign</code>，然后点击<code>Next</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.1.2.png" alt="image-20220809102707386" tabindex="0" loading="lazy"><figcaption>image-20220809102707386</figcaption></figure><p>最后点击<code>Finish</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.1.3.png" alt="image-20220809102724824" tabindex="0" loading="lazy"><figcaption>image-20220809102724824</figcaption></figure><h5 id="_2、修改代码" tabindex="-1"><a class="header-anchor" href="#_2、修改代码" aria-hidden="true">#</a> 2、修改代码</h5><p>同样的，以下内容不替换(<code>properties</code>里面的要替换)（最好先替换，再把它作为maven项目添加到项目，要不然替换的时候上方的文件名会显示<code>pom.xm(&lt;artifactId&gt;里的内容)</code>（并不是<code>pom.xml(模块名)</code>），如果你复制的是<code>gulimall-product</code>模块的，有可能当前模块(<code>gulimall-cart</code>模块)显示为<code>pom.xml(gulimall-product)</code>，然后你就怀疑是不是错把<code>gulimall-product</code>模块的<code>pom.xml</code>文件替换掉了）</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-cart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>gulimall-cart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.2.1.png" alt="image-20220809103832773" tabindex="0" loading="lazy"><figcaption>image-20220809103832773</figcaption></figure><p>修改<code>gulimall-cart</code>模块<code>com.atguigu.gulimall.cart.GulimallCartApplicationTests</code>测试类的代码，并测试看是否报错</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallCartApplicationTests</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.2.2.png" alt="image-20220809104027237" tabindex="0" loading="lazy"><figcaption>image-20220809104027237</figcaption></figure><h5 id="_3、添加配置" tabindex="-1"><a class="header-anchor" href="#_3、添加配置" aria-hidden="true">#</a> 3、添加配置</h5><p>添加<code>cart.gulimall.com</code>域名，将<code>cart.gulimall.com</code>域名的ip设置为虚拟机的ip</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># gulimall</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">search.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">item.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">auth.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">cart.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.3.1.png" alt="image-20220809104147788" tabindex="0" loading="lazy"><figcaption>image-20220809104147788</figcaption></figure><p>将<code>2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\购物车</code>里的<code>cartList.html</code>和<code>success.html</code>复制到<code>gulimall-cart</code>模块的<code>src/main/resources/templates</code>里面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.3.2.png" alt="image-20220809104535897" tabindex="0" loading="lazy"><figcaption>image-20220809104535897</figcaption></figure><p>在<code>linux虚拟机</code>的<code>/mydata/nginx/html/static</code>目录下新建<code>cart</code>目录，把<code>2.分布式高级篇（微服务架构篇）\\资料源码\\代码\\html\\购物车</code>里的文件夹复制到<code>/mydata/nginx/html/static/cart</code>目录下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.3.3.gif" alt="GIF 2022-8-9 10-47-05" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 10-47-05</figcaption></figure><h5 id="_4、修改页面" tabindex="-1"><a class="header-anchor" href="#_4、修改页面" aria-hidden="true">#</a> 4、修改页面</h5><p>修改<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件，将<code>href=&quot;./</code>全部替换为<code>href=&quot;/static/cart/</code>，将<code>src=&quot;./</code>全部替换为<code>src=&quot;/static/cart/</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>href=&quot;./
href=&quot;/static/cart/

src=&quot;./
src=&quot;/static/cart/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,158),nn=t(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.4.1.png" alt="image-20220809105323489" tabindex="0" loading="lazy"><figcaption>image-20220809105323489</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件，将<code>href=&quot;./</code>全部替换为<code>href=&quot;/static/cart/</code>，将<code>src=&quot;./</code>全部替换为<code>src=&quot;/static/cart/</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>href=&quot;./
href=&quot;/static/cart/

src=&quot;./
src=&quot;/static/cart/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),sn=t(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.1.4.2.png" alt="image-20220809105425860" tabindex="0" loading="lazy"><figcaption>image-20220809105425860</figcaption></figure><h4 id="_2、添加配置并完善页面" tabindex="-1"><a class="header-anchor" href="#_2、添加配置并完善页面" aria-hidden="true">#</a> 2、添加配置并完善页面</h4><h5 id="_1、添加配置" tabindex="-1"><a class="header-anchor" href="#_1、添加配置" aria-hidden="true">#</a> 1、添加配置</h5><p>修改<code>gulimall-cart</code>模块的<code>pom.xml</code>文件，添加<code>gulimall-common</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.gulimall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.1.1.png" alt="image-20220809105640009" tabindex="0" loading="lazy"><figcaption>image-20220809105640009</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.GulimallCartApplication</code>类的<code>@SpringBootApplication</code>注解后面添加<code>(exclude = DataSourceAutoConfiguration.class)</code>，排除数据源的自动配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.1.2.png" alt="image-20220809105800301" tabindex="0" loading="lazy"><figcaption>image-20220809105800301</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span>

<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">gulimall-cart</span>
<span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.1.3.png" alt="image-20220809110042486" tabindex="0" loading="lazy"><figcaption>image-20220809110042486</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.GulimallCartApplication</code>类上添加如下注解，开启远程调用和服务发现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.1.4.png" alt="image-20220809110006433" tabindex="0" loading="lazy"><figcaption>image-20220809110006433</figcaption></figure><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加负载均衡到<code>gulimall-cart</code>模块的配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_cart_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>cart
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Host=cart.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.1.5.png" alt="image-20220809110440063" tabindex="0" loading="lazy"><figcaption>image-20220809110440063</figcaption></figure><h5 id="_2、完善页面" tabindex="-1"><a class="header-anchor" href="#_2、完善页面" aria-hidden="true">#</a> 2、完善页面</h5><p>在<code>gulimall-cart</code>模块将<code>src/main/resources/templates/success.html</code>文件里的</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/1999/xhtml<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>修改为</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/1999/xhtml<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>删去<code>thymeleaf</code>，然后把<code>src/main/resources/templates/success.html</code>文件重命名为<code>index.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.1.png" alt="image-20220809111431235" tabindex="0" loading="lazy"><figcaption>image-20220809111431235</figcaption></figure><p>启动<code>GulimallGatewayApplication</code>服务和<code>GulimallCartApplication</code>服务，已经可以成功访问</p><p>http://cart.gulimall.com/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.2.png" alt="image-20220809110921527" tabindex="0" loading="lazy"><figcaption>image-20220809110921527</figcaption></figure><p>在 http://cart.gulimall.com/ 页面里，打开控制台，选择<code>谷粒商城首页</code>所在的<code>&lt;a&gt;</code>标签</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.3.png" alt="image-20220809111724257" tabindex="0" loading="lazy"><figcaption>image-20220809111724257</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/index.html</code>文件里搜索<code>谷粒商城首页</code>，将该<code>&lt;a&gt;</code>标签的<code>href</code>的值修改为<code>http://gulimall.com</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>谷粒商城首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.4.png" alt="image-20220809111752124" tabindex="0" loading="lazy"><figcaption>image-20220809111752124</figcaption></figure><p>在 http://cart.gulimall.com/ 页面里，打开控制台，选择<code>logo</code>所在的<code>&lt;img&gt;</code>标签，复制<code>/static/cart/img/logo1.jpg</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.5.png" alt="image-20220809111822473" tabindex="0" loading="lazy"><figcaption>image-20220809111822473</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/index.html</code>文件里搜索<code>/static/cart/img/logo1.jpg</code>，将该<code>&lt;img&gt;</code>标签外面的<code>&lt;a&gt;</code>标签的<code>href</code>的值修改为<code>http://gulimall.com</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/cart/img/logo1.jpg<span class="token punctuation">&quot;</span></span>  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>180px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>  <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.6.png" alt="image-20220809111906922" tabindex="0" loading="lazy"><figcaption>image-20220809111906922</figcaption></figure><p>重启<code>gulimall-cart</code>模块后，在 http://cart.gulimall.com/ 页面里，点击<code>谷粒商城首页</code>和<code>logo</code>都能跳转到首页</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://cart.gulimall.com/
http://gulimall.com/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.2.2.7.gif" alt="GIF 2022-8-9 11-21-44" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 11-21-44</figcaption></figure><h4 id="_3、购物车需求分析" tabindex="-1"><a class="header-anchor" href="#_3、购物车需求分析" aria-hidden="true">#</a> 3、购物车需求分析</h4><h5 id="_1、购物车需求" tabindex="-1"><a class="header-anchor" href="#_1、购物车需求" aria-hidden="true">#</a> 1、购物车需求</h5><p><strong>1）</strong> <strong>、需求描述：</strong></p><ul><li><p>用户在<strong>登录状态</strong>下</p><ul><li><p>将商品添加到购物车**【用户购物车/在线购物车】**</p></li><li><p><strong>放入数据库</strong></p></li><li><p><strong>mongodb</strong></p></li><li><p>放入<strong>redis</strong>(采用)</p></li><li><p>登录以后，会将<strong>临时购物车</strong>的数据全部合并过来，并清空<strong>临时购物车；</strong></p></li></ul></li><li><p>用户在<strong>未登录状态</strong>下</p><ul><li><p>将商品添加到购物车**【游客购物车/离线购物车/临时购物车】**</p></li><li><p>放入 localstorage（客户端存储，后台不存）</p></li><li><p>cookie</p></li><li><p>WebSQL</p></li><li><p><strong>放入 redis（采用）</strong></p></li><li><p>浏览器即使关闭，下次进入，<strong>临时购物车</strong>数据都在</p></li></ul></li><li><p>其他功能</p><ul><li><p>用户可以使用购物车一起结算下单</p></li><li><p>给购物车<strong>添加商品</strong></p></li><li><p>用户可以<strong>查询自己的购物车</strong></p></li><li><p>用户可以在购物车中<strong>修改购买商品的数量</strong>。</p></li><li><p>用户可以在购物车中<strong>删除商品</strong>。</p></li><li><p>选中/不选中商品</p></li><li><p>在购物车中展示商品优惠信息</p></li><li><p>提示购物车商品价格变化</p></li></ul></li></ul><h5 id="_2、购物车数据结构" tabindex="-1"><a class="header-anchor" href="#_2、购物车数据结构" aria-hidden="true">#</a> 2、购物车数据结构</h5><p>分析：每一个购物项信息，都是一个对象，基本字段包括</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    skuId<span class="token operator">:</span> <span class="token number">2131241</span><span class="token punctuation">,</span>
    check<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token string">&quot;Apple iphone&quot;</span><span class="token punctuation">,</span>
    defaultImage<span class="token operator">:</span> <span class="token string">&quot;	&quot;</span><span class="token punctuation">,</span>
    price<span class="token operator">:</span> <span class="token number">4999</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    totalPrice<span class="token operator">:</span> <span class="token number">4999</span><span class="token punctuation">,</span> 
    skuSaleVO<span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，购物车中不止一条数据，因此最终会是对象的数组。即：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">[</span>
<span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>...<span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>类似于如下结构：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        skuId<span class="token operator">:</span> <span class="token number">2131241</span><span class="token punctuation">,</span>
        check<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> <span class="token string">&quot;Apple iphone&quot;</span><span class="token punctuation">,</span>
        defaultImage<span class="token operator">:</span> <span class="token string">&quot;	&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token number">4999</span><span class="token punctuation">,</span>
        count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        totalPrice<span class="token operator">:</span> <span class="token number">4999</span><span class="token punctuation">,</span> 
        skuSaleVO<span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
    	.....
	<span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis 有 5 种不同数据结构，这里选择哪一种比较合适呢？</p><p>首先不同用户应该有独立的购物车，因此购物车应该以用户的作为<code>key</code>来存储，<code>Value</code>是用户的所有购物车信息。这样看来基本的<code>k-v</code>结构就可以了。</p><ul><li>但是，我们对购物车中的商品进行增、删、改操作，基本都需要根据商品 id 进行判断，为了方便后期处理，我们的购物车也应该是<code>k-v</code>结构，key 是商品<code>id</code>，<code>value</code>才是这个商品的购物车信息。</li></ul><p>综上所述，我们的购物车结构是一个双层 Map：<code>Map&lt;String,Map&lt;String,String&gt;&gt;</code></p><ul><li><p>第一层 Map，Key 是用户 id</p></li><li><p>第二层 Map，Key 是购物车中商品 id，值是购物项数据</p></li></ul><p>在<code>java</code>中，相当于如下结构</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Map&lt;String k1,Map&lt;String k2,CartItemInfo&gt;&gt; 
k1：标识每一个用户的购物车
k2：购物项的商品id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在redis中</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>key:用户标识
value:Hash（k：商品id，v：购物项详情）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.3.2.png" alt="image-20220809115021313" tabindex="0" loading="lazy"><figcaption>image-20220809115021313</figcaption></figure><h4 id="_4、代码实现" tabindex="-1"><a class="header-anchor" href="#_4、代码实现" aria-hidden="true">#</a> 4、代码实现</h4><h5 id="_1、添加vo" tabindex="-1"><a class="header-anchor" href="#_1、添加vo" aria-hidden="true">#</a> 1、添加vo</h5><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart</code>包里新建<code>vo</code>文件夹，在<code>vo</code>文件夹里新建<code>CartItemVo</code>类，用于存储购物车车里每一个商品项的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description: 购物车里的商品项
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartItemVo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * sku的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 是否选中（默认选中）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> check <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品的标题
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品的图片
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * sku的属性（选中的 颜色、内存容量 等）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> skuAttr<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品的价格
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品的数量
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 总价(商品价格*商品数量)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalPrice<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 计算总价
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.1.1.png" alt="image-20220809155425051" tabindex="0" loading="lazy"><figcaption>image-20220809155425051</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.vo</code>包里新建<code>CartVo</code>类，用于存放购物车数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description: 购物车
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartVo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 商品项
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品数量（所有商品的count相加）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> countNum<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品有几种类型（有几种不同的商品）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> countType<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品总价（所有商品总价加起来）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalAmount<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 减免的价格
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> reduce <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setItems</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>items <span class="token operator">=</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCountNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> countNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    countNum<span class="token operator">+=</span>item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> countNum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCountType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> countType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    countType<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> countType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//购物总价</span>
        <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    totalAmount <span class="token operator">=</span> totalAmount<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//减去优惠</span>
        totalAmount <span class="token operator">=</span> totalAmount<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token function">getReduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> totalAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getReduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reduce<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span> reduce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reduce <span class="token operator">=</span> reduce<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.1.2.png" alt="image-20220809155447597" tabindex="0" loading="lazy"><figcaption>image-20220809155447597</figcaption></figure><h5 id="_2、添加redis依赖" tabindex="-1"><a class="header-anchor" href="#_2、添加redis依赖" aria-hidden="true">#</a> 2、添加redis依赖</h5><p>在<code>gulimall-cart</code>模块的<code>pom.xml</code>文件里添加<code>redis</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.2.1.png" alt="image-20220809155645296" tabindex="0" loading="lazy"><figcaption>image-20220809155645296</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/application.properties</code>文件里指定redis的host</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.2.2.png" alt="image-20220809155727842" tabindex="0" loading="lazy"><figcaption>image-20220809155727842</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart</code>包下新建<code>service</code>文件夹，在<code>service</code>文件夹下新建<code>CartService</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.2.3.png" alt="image-20220809155822937" tabindex="0" loading="lazy"><figcaption>image-20220809155822937</figcaption></figure><h5 id="_3、添加spring-session依赖" tabindex="-1"><a class="header-anchor" href="#_3、添加spring-session依赖" aria-hidden="true">#</a> 3、添加Spring Session依赖</h5><p>在<code>gulimall-cart</code>模块的<code>pom.xml</code>文件里添加<code>Spring Session</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入SpringSession--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.3.1.png" alt="image-20220809160358392" tabindex="0" loading="lazy"><figcaption>image-20220809160358392</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart</code>包下新建<code>config</code>文件夹，复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.GulimallSessionConfig</code>文件，到<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.config</code>包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">CookieSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>session<span class="token punctuation">.</span>web<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">DefaultCookieSerializer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSessionConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CookieSerializer</span> <span class="token function">cookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultCookieSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultCookieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// We customize the name of the cookie to be JSESSIONID.</span>
        serializer<span class="token punctuation">.</span><span class="token function">setCookieName</span><span class="token punctuation">(</span><span class="token string">&quot;GULIMALL_JSESSIONID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serializer<span class="token punctuation">.</span><span class="token function">setDomainName</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">////We customize the path of the cookie to be / (rather than the default of the context root).</span>
        <span class="token comment">//serializer.setCookiePath(&quot;/&quot;);</span>
        <span class="token comment">////If the regular expression matches, the first grouping is used as the domain.</span>
        <span class="token comment">////This means that a request to https://child.example.com sets the domain to example.com.</span>
        <span class="token comment">////However, a request to http://localhost:8080/ or https://192.168.1.100:8080/ leaves the cookie unset and,</span>
        <span class="token comment">//// thus, still works in development without any changes being necessary for production.</span>
        <span class="token comment">////亲测不生效</span>
        <span class="token comment">//serializer.setDomainNamePattern(&quot;^.+?\\\\.(\\\\w+\\\\.[a-z]+)$&quot;);</span>
        <span class="token keyword">return</span> serializer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">springSessionDefaultRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.3.2.png" alt="image-20220809160809319" tabindex="0" loading="lazy"><figcaption>image-20220809160809319</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.config.GulimallSessionConfig</code>类上添加如下注解，开启Spring Session功能</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@EnableRedisHttpSession
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.3.3.png" alt="image-20220809161216130" tabindex="0" loading="lazy"><figcaption>image-20220809161216130</figcaption></figure><h5 id="_4、分析功能" tabindex="-1"><a class="header-anchor" href="#_4、分析功能" aria-hidden="true">#</a> 4、分析功能</h5><p>功能描述：</p><ul><li><p>浏览器有一个cookie; user-key; 标识用户身份，一个月后过期;</p></li><li><p>如果第一次使用jd的购物车功能，都会给一个临时的用户身份;</p></li><li><p>浏览器以后保存，每次访问都会带上这个cookie;</p></li><li><p>登录: session有用户数据</p></li><li><p>没登录:按照cookie里面带来user-key来做。</p></li><li><p>第一次:如果没有临时用户，帮忙创建一个临时用户。</p></li></ul><p>京东会给一个<code>user-key</code>的<code>cookie</code>，有效期为一个月</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.4.1.png" alt="image-20220809162152106" tabindex="0" loading="lazy"><figcaption>image-20220809162152106</figcaption></figure><p>登陆后还是会存在<code>user-key</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.4.2.png" alt="image-20220809162541563" tabindex="0" loading="lazy"><figcaption>image-20220809162541563</figcaption></figure><h5 id="_5、添加vo" tabindex="-1"><a class="header-anchor" href="#_5、添加vo" aria-hidden="true">#</a> 5、添加vo</h5><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart</code>包下新建<code>controller</code>文件夹，在<code>controller</code>文件夹下新建<code>CartController</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">AuthServerConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpSession</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartController</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 浏览器有一个cookie; user-key; 标识用户身份，一个月后过期;
     * 如果第一次使用jd的购物车功能，都会给一个临时的用户身份;
     * 浏览器以后保存，每次访问都会带上这个cookie;
     * 登录: session有用户
     * 没登录:按照cookie里面带来user-key来做。
     * 第一次:如果没有临时用户，帮忙创建一个临时用户。
     *
     * 去登录页的请求
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cart.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">cartListPage</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Object</span> attribute <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//获取临时购物车</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取登录过的购物车</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;cartList&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.5.1.png" alt="image-20220809163741299" tabindex="0" loading="lazy"><figcaption>image-20220809163741299</figcaption></figure><p>由于每次都要判断等没登录，所以可以使用拦截器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.5.2.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>包下新建<code>UserInfoTo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoTo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 用户的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 用户的标识
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userKey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.5.3.png" alt="image-20220809190800927" tabindex="0" loading="lazy"><figcaption>image-20220809190800927</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.constant</code>包下新建<code>cart</code>文件夹，在<code>cart</code>文件夹里新建<code>CartConstant</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>cart</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartConstant</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 临时或已登录用户的cookie名
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TEMP_USER_COOKIE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;user-key&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.4.5.4.png" alt="image-20220809194222197" tabindex="0" loading="lazy"><figcaption>image-20220809194222197</figcaption></figure><h4 id="_5、threadlocal" tabindex="-1"><a class="header-anchor" href="#_5、threadlocal" aria-hidden="true">#</a> 5、ThreadLocal</h4><h5 id="_1、添加拦截器" tabindex="-1"><a class="header-anchor" href="#_1、添加拦截器" aria-hidden="true">#</a> 1、添加拦截器</h5><p>ThreadLocal可以在同一个线程之间共享数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.1.1.png" alt="image-20220809195832706" tabindex="0" loading="lazy"><figcaption>image-20220809195832706</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart</code>包先新建<code>interceptor</code>文件夹，在<code>interceptor</code>文件夹下新建<code>CartInterceptor</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>interceptor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">AuthServerConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>cart<span class="token punctuation">.</span></span><span class="token class-name">CartConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span></span><span class="token class-name">MemberEntityTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span></span><span class="token class-name">UserInfoTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">HandlerInterceptor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">Cookie</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpSession</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 把UserInfoTo的信息放到ThreadLocal里
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoTo</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 在执行目标方法之前，判断用户的登录状态。并封装传递给controller目标请求
     * <span class="token keyword">@param</span> <span class="token parameter">request</span>
     * <span class="token keyword">@param</span> <span class="token parameter">response</span>
     * <span class="token keyword">@param</span> <span class="token parameter">handler</span>
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                             <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//根据session判断当前用户是否登录，如果登录了就把用户id赋值给userInfoTo.userId</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MemberEntityTo</span> member <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">MemberEntityTo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>member <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//用户登录</span>
            userInfoTo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//在cookies里寻找key为user-key的cookie，把该cookie的value放到userInfoTo.userKey里</span>
        <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cookies<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_NAME</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果在cookies里没有找到key为user-key的cookie，就证明是第一次来到系统，或删除了cookie</span>
        <span class="token comment">//如果没有临时用户，分配一个临时用户</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//目标方法执行之前</span>
        threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.1.2.png" alt="image-20220809201759825" tabindex="0" loading="lazy"><figcaption>image-20220809201759825</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.config</code>包下新建<code>GulimallWebConfig</code>配置类，指定该拦截器的拦截路径</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">CartInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">InterceptorRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/9
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.1.3.png" alt="image-20220809200741968" tabindex="0" loading="lazy"><figcaption>image-20220809200741968</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类的<code>cartListPage</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 浏览器有一个cookie; user-key; 标识用户身份，一个月后过期;
 * 如果第一次使用jd的购物车功能，都会给一个临时的用户身份;
 * 浏览器以后保存，每次访问都会带上这个cookie;
 * 登录: session有用户
 * 没登录:按照cookie里面带来user-key来做。
 * 第一次:如果没有临时用户，帮忙创建一个临时用户。
 *
 * 去登录页的请求
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cart.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">cartListPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">//从ThreadLocal里得到用户信息</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;cartList&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.1.4.png" alt="image-20220809210807657" tabindex="0" loading="lazy"><figcaption>image-20220809210807657</figcaption></figure><h5 id="_2、添加cookie" tabindex="-1"><a class="header-anchor" href="#_2、添加cookie" aria-hidden="true">#</a> 2、添加Cookie</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.constant.cart.CartConstant</code>类里添加</p><p>如果没有<code>key</code>为<code>user-key</code>的临时用户，还需要再向浏览器返回之前存放一个<code>Cookie</code>，并且指定过期时间<code>TEMP_USER_COOKIE_TIMEOUT</code>字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 临时或已登录用户的cookie的过期时间(30天)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TEMP_USER_COOKIE_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.1.png" alt="image-20220809202235176" tabindex="0" loading="lazy"><figcaption>image-20220809202235176</figcaption></figure><p>双击<code>Shift</code>，搜索<code>Cookie</code>，可以看到<code>javax.servlet.http.Cookie</code>里的<code>Cookie</code>的过期时间以<code>秒</code>为单位</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Sets the maximum age of the cookie in seconds.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * A positive value indicates that the cookie will expire after that many
 * seconds have passed. Note that the value is the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span>maximum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> age when
 * the cookie will expire, not the cookie&#39;s current age.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * A negative value means that the cookie is not stored persistently and
 * will be deleted when the Web browser exits. A zero value causes the
 * cookie to be deleted.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">expiry</span>
 *            an integer specifying the maximum age of the cookie in
 *            seconds; if negative, means the cookie is not stored; if zero,
 *            deletes the cookie
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">getMaxAge</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> expiry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    maxAge <span class="token operator">=</span> expiry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.2.png" alt="image-20220809202547741" tabindex="0" loading="lazy"><figcaption>image-20220809202547741</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to.UserInfoTo</code>类里添加<code>tempUserCookie</code>字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 是否有临时用户的cookie
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> tempUserCookie <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.3.png" alt="image-20220809203431621" tabindex="0" loading="lazy"><figcaption>image-20220809203431621</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>preHandle</code>方法里的<code>breake;</code>上面添加<code>userInfoTo.setTempUserCookie(true);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在执行目标方法之前，判断用户的登录状态。并封装传递给controller目标请求
 *
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@param</span> <span class="token parameter">handler</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                         <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据session判断当前用户是否登录，如果登录了就把用户id赋值给userInfoTo.userId</span>
    <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> member <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberEntityTo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>member <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//用户登录</span>
        userInfoTo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//在cookies里寻找key为user-key的cookie，把该cookie的value放到userInfoTo.userKey里</span>
    <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cookies<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_NAME</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                userInfoTo<span class="token punctuation">.</span><span class="token function">setTempUserCookie</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果在cookies里没有找到key为user-key的cookie，就证明是第一次来到系统，或删除了cookie</span>
    <span class="token comment">//如果没有临时用户，分配一个临时用户</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//目标方法执行之前</span>
    threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.4.png" alt="image-20220809204124231" tabindex="0" loading="lazy"><figcaption>image-20220809204124231</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类里添加<code>postHandle</code>方法，向浏览器端写cookie</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 业务执行完后
 *
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@param</span> <span class="token parameter">handler</span>
 * <span class="token keyword">@param</span> <span class="token parameter">modelAndView</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfoTo<span class="token punctuation">.</span><span class="token function">isTempUserCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_NAME</span><span class="token punctuation">,</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.5.png" alt="image-20220809204043771" tabindex="0" loading="lazy"><figcaption>image-20220809204043771</figcaption></figure><p><code>gulimall-common</code>模块的<code>com.atguigu.common.to.UserInfoTo</code>类里<code>tempUserCookie</code>字段名总感觉那里怪怪的，按<code>shift + f6</code>重新改名为<code>hasTempUserCookie</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 是否有临时用户的cookie
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> hasTempUserCookie <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.6.png" alt="image-20220809204611574" tabindex="0" loading="lazy"><figcaption>image-20220809204611574</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类里获取和修改<code>tempUserCookie</code>字段的代码，这样看就舒服多了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>userInfoTo<span class="token punctuation">.</span><span class="token function">setHasTempUserCookie</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userInfoTo<span class="token punctuation">.</span><span class="token function">isHasTempUserCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.7.png" alt="image-20220809204732994" tabindex="0" loading="lazy"><figcaption>image-20220809204732994</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类里修改<code>postHandle</code>方法，在该方法的最后添加<code>threadLocal.remove();</code>，用于删除ThreadLocal，防止线程复用，获取到别的用户信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 业务执行完后，如果当前用户的cookies里没有user-key为键的cookie，就存放该cookie
 *
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@param</span> <span class="token parameter">handler</span>
 * <span class="token keyword">@param</span> <span class="token parameter">modelAndView</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfoTo<span class="token punctuation">.</span><span class="token function">isHasTempUserCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_NAME</span><span class="token punctuation">,</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//删除ThreadLocal，防止线程复用，获取到别的用户信息</span>
    threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.2.8.png" alt="image-20220809205425490" tabindex="0" loading="lazy"><figcaption>image-20220809205425490</figcaption></figure><h5 id="_3、修改页面-1" tabindex="-1"><a class="header-anchor" href="#_3、修改页面-1" aria-hidden="true">#</a> 3、修改页面</h5><p>在 http://item.gulimall.com/9.html 页面，打开控制台定位到<code>立即预约 </code>所在的<code>&lt;a&gt;</code>标签</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.1.png" alt="image-20220809210002209" tabindex="0" loading="lazy"><figcaption>image-20220809210002209</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里搜索<code>立即预约</code>，找到对应的<code>&lt;a&gt;</code>标签，将<code>&lt;a&gt;</code>标签的<code>href</code>属性的值修改为<code>http://cart.gulimall.com/addToCart</code>。将<code>立即预约</code>修改为<code>加入购物车</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-btns-two<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://cart.gulimall.com/addToCart<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--立即预约--&gt;</span>
      加入购物车
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.2.png" alt="image-20220809210342092" tabindex="0" loading="lazy"><figcaption>image-20220809210342092</figcaption></figure><p>将<code>gulimall-cart</code>模块的<code>src/main/resources/templates/index.html</code>文件重新改名为<code>success.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.3.png" alt="image-20220809210503541" tabindex="0" loading="lazy"><figcaption>image-20220809210503541</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类里添加<code>/addToCart</code>接口，用于添加到购物车</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 添加到购物车
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addToCart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.4.png" alt="image-20220809211130318" tabindex="0" loading="lazy"><figcaption>image-20220809211130318</figcaption></figure><p>在 http://gulimall.com/ 页面，打开控制台，选择<code>我的购物车</code>对应的<code>&lt;a&gt;</code>标签，复制<code>我的购物车</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.5.png" alt="image-20220809211248869" tabindex="0" loading="lazy"><figcaption>image-20220809211248869</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里，搜索<code>我的购物车</code>，将<code>&lt;a&gt;</code>标签的<code>href</code>的值修改为<code>http://cart.gulimall.com/cart.html</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_gw<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/index/img/img_15.png<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://cart.gulimall.com/cart.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.6.png" alt="image-20220809211431472" tabindex="0" loading="lazy"><figcaption>image-20220809211431472</figcaption></figure><p>启动<code>GulimallMemberApplication</code>服务、<code>GulimallSearchApplication</code>服务、<code>GulimallGatewayApplication</code>服务、<code>GulimallProductApplication</code>服务、<code>GulimallAuthServerApplication</code>服务、<code>GulimallCartApplication</code>服务</p><p>可以看到当浏览器中没有<code>key</code>为<code>user-key</code>的<code>cookie</code>时，会向浏览器写一个<code>cookie</code>(但是要放行多次)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.7.gif" alt="GIF 2022-8-9 21-36-28" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 21-36-28</figcaption></figure><p>可以看到当浏览器中有<code>key</code>为<code>user-key</code>的<code>cookie</code>时，不会替换掉原来的<code>key</code>为<code>user-key</code>的<code>cookie</code>(但是要放行多次)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.8.gif" alt="GIF 2022-8-9 21-42-07" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 21-42-07</figcaption></figure><p>放行多次多次就证明有多个请求，应该是<code>拦截器</code>拦截了不该拦截的<code>静态资源</code>请求引起的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.3.9.png" alt="image-20220809214722050" tabindex="0" loading="lazy"><figcaption>image-20220809214722050</figcaption></figure><h5 id="_4、修改代码" tabindex="-1"><a class="header-anchor" href="#_4、修改代码" aria-hidden="true">#</a> 4、修改代码</h5><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>postHandle</code>方法的开头添加如下代码，如果不是拦截器直接返回</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.4.1.png" alt="image-20220809215021156" tabindex="0" loading="lazy"><figcaption>image-20220809215021156</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>preHandle</code>方法的开头也添加类似代码，如果不是拦截器直接放行</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.4.2.png" alt="image-20220809215057482" tabindex="0" loading="lazy"><figcaption>image-20220809215057482</figcaption></figure><p>可以看到还是判断了多次，没有找到这些静态资源，触发了<code>BasicErrorController</code>(这里不用管，后面也用不到)</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>//执行了我们的Controller
public java.lang.String com.atguigu.gulimall.cart.controller.CartController.cartListPage()
//执行了错误视图的Controller
public org.springframework.http.ResponseEntity org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController.error(javax.servlet.http.HttpServletRequest)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.4.3.gif" alt="GIF 2022-8-9 21-55-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-9 21-55-39</figcaption></figure><h5 id="_5、修改页面" tabindex="-1"><a class="header-anchor" href="#_5、修改页面" aria-hidden="true">#</a> 5、修改页面</h5><p>在 http://cart.gulimall.com/cart.html 页面里，打开控制台，选择购物车左边的<code>&lt;img&gt;</code>，复制<code>img/logo1.jpg</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.1.png" alt="image-20220810092737297" tabindex="0" loading="lazy"><figcaption>image-20220810092737297</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里，搜索<code>img/logo1.jpg</code>，找到对应的<code>&lt;img&gt;</code>标签，将<code>&lt;img&gt;</code>标签的<code>src</code>修改为<code>/static/cart/img/logo1.jpg</code>，将<code>&lt;img&gt;</code>标签外面的<code>&lt;a&gt;</code>标签的<code>href</code>属性的值修改为<code>http://gulimall.com</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one_top_left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one_left_logo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/cart/img/logo1.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one_left_link<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.2.png" alt="image-20220810093315148" tabindex="0" loading="lazy"><figcaption>image-20220810093315148</figcaption></figure><p>在 http://cart.gulimall.com/cart.html 页面里，打开控制台，选择<code>首页</code>对应的<code>&lt;a&gt;</code>，复制<code>首页</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.3.png" alt="image-20220810093426039" tabindex="0" loading="lazy"><figcaption>image-20220810093426039</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里，搜索<code>首页</code>,将<code>首页</code>对应的<code>&lt;a&gt;</code>标签的<code> href</code>属性的值修改为<code>http://gulimall.com</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header-left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.4.png" alt="image-20220810092839055" tabindex="0" loading="lazy"><figcaption>image-20220810092839055</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里，修改<code>你好，请登录</code>周围代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>欢迎：[[\${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>li_2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>spacer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>spacer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.5.png" alt="image-20220810093624698" tabindex="0" loading="lazy"><figcaption>image-20220810093624698</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件里，修改<code>你好，请登录</code>周围代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hd_wrap_right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>欢迎：[[\${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>li_2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>spacer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/javascript:;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.6.png" alt="image-20220810093815833" tabindex="0" loading="lazy"><figcaption>image-20220810093815833</figcaption></figure><p>重启<code>gulimall-cart</code>模块，可以看到<code>cartList.html</code>页面跳转没有什么问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.7.gif" alt="GIF 2022-8-10 9-42-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 9-42-31</figcaption></figure><p><code>success.html</code>页面除了<code>您还没有登录！登录后购物车的商品将保存到您账号中 立即登录</code>有问题外，其他的也没什么问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.8.gif" alt="GIF 2022-8-10 9-40-18" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 9-40-18</figcaption></figure><p>在 http://cart.gulimall.com/addToCart 页面里，打开控制台，选择<code>去购物车结算</code>，复制对应<code>&lt;a&gt;</code>标签的<code>id</code>的值<code>GotoShoppingCart</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.9.png" alt="image-20220810094852763" tabindex="0" loading="lazy"><figcaption>image-20220810094852763</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件里搜索<code>GotoShoppingCart</code>，将该该<code>&lt;a&gt;</code>标签的<code>href</code>的值修改为<code>http://cart.gulimall.com/cart.html</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-addtocart<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://cart.gulimall.com/cart.html<span class="token punctuation">&quot;</span></span>
   <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>GotoShoppingCart<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>去购物车结算<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.10.png" alt="image-20220810094915539" tabindex="0" loading="lazy"><figcaption>image-20220810094915539</figcaption></figure><p>重启<code>gulimall-cart</code>模块，访问 http://cart.gulimall.com/addToCart 页面，点击<code>去购物车结算</code>，成功跳转到了 http://cart.gulimall.com/cart.html 页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.11.gif" alt="GIF 2022-8-10 9-50-55" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 9-50-55</figcaption></figure><p>将<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>页面里的<code>th:href=&quot;&#39;http://item.gmall.com:8084/&#39;+\${skuInfo?.id}+&#39;.html&#39;&quot;</code>修改为<code>http://item.gulimall.com/9.html</code>，先让其访问固定的商品</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bg_shop<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-tobback<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://item.gulimall.com/9.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>查看商品详情<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-addtocart<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://cart.gulimall.com/cart.html<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>GotoShoppingCart<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>去购物车结算<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.12.png" alt="image-20220810095409271" tabindex="0" loading="lazy"><figcaption>image-20220810095409271</figcaption></figure><p>重启<code>gulimall-cart</code>模块，访问 http://cart.gulimall.com/addToCart 页面，点击<code>查看商品详情</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.8.5.5.13.gif" alt="GIF 2022-8-10 9-54-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 9-54-54</figcaption></figure><h3 id="_5-7-9、加入购物车" tabindex="-1"><a class="header-anchor" href="#_5-7-9、加入购物车" aria-hidden="true">#</a> 5.7.9、加入购物车</h3><h4 id="_1、点击加入购物车进行跳转" tabindex="-1"><a class="header-anchor" href="#_1、点击加入购物车进行跳转" aria-hidden="true">#</a> 1、点击加入购物车进行跳转</h4><h5 id="_1、前端跳转" tabindex="-1"><a class="header-anchor" href="#_1、前端跳转" aria-hidden="true">#</a> 1、前端跳转</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里，将<code>立即抢购</code>外面的<code>&lt;a href=&quot;http://cart.gulimall.com/addToCart&quot;&gt;</code>修改为<code>&lt;a href=&quot;#&quot; id=&quot;addToCart&quot;&gt;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-btns-two<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addToCart<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--立即预约--&gt;</span>
      加入购物车
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.1.png" alt="image-20220810095941269" tabindex="0" loading="lazy"><figcaption>image-20220810095941269</figcaption></figure><p>在 http://item.gulimall.com/9.html 页面里，选中<code>加入购物车</code>左边的数量输入框，复制<code>value=&quot;1&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.2.png" alt="image-20220810100406207" tabindex="0" loading="lazy"><figcaption>image-20220810100406207</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里，搜索<code>value=&quot;1&quot;</code>，将<code>&lt;input&gt;</code>输入框的<code>id</code>的值修改为<code>numInput</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>numInput<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.3.png" alt="image-20220810100534991" tabindex="0" loading="lazy"><figcaption>image-20220810100534991</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里，搜索<code>加入购物车</code>，将外面的<code>&lt;a&gt;</code>标签添加自定义属性<code>th:attr=&quot;skuId=\${item.info.skuId}&quot;</code>用于获取<code>skuId</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-btns-two<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addToCart<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId=\${item.info.skuId}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--立即预约--&gt;</span>
      加入购物车
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.4.png" alt="image-20220810101119082" tabindex="0" loading="lazy"><figcaption>image-20220810101119082</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下方法，用于点击<code>加入购物车</code>跳转到购物车对应的页面</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#addToCart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> skuId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#numInput&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://cart.gulimall.com/addToCart?skuId=&quot;</span><span class="token operator">+</span>skuId<span class="token operator">+</span><span class="token string">&quot;&amp;num=&quot;</span> <span class="token operator">+</span> num
   <span class="token comment">//禁用默认行为</span>
   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.5.png" alt="image-20220810101406205" tabindex="0" loading="lazy"><figcaption>image-20220810101406205</figcaption></figure><p>重启<code>gulimall-product</code>模块，在<code>http://item.gulimall.com/9.html</code>页面，可以看到已经拼装好数据到<code>http://cart.gulimall.com/addToCart?skuId=9&amp;num=4</code>页面了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.6.gif" alt="GIF 2022-8-10 10-14-28" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 10-14-28</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类的<code>addToCart</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 添加到购物车
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addToCart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">,</span>
                        <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">CartItemVo</span> cartItemVo <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">addToCart</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>cartItemVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.7.png" alt="image-20220810101957590" tabindex="0" loading="lazy"><figcaption>image-20220810101957590</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件里，重新添加<code>thymeleaf</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/1999/xhtml<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.8.png" alt="image-20220810102332592" tabindex="0" loading="lazy"><figcaption>image-20220810102332592</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件里，将<code>th:</code>替换为空，一定要选中<code>W</code>图标（表名这是一个单词，防止把<code>width:60px</code>里的<code>th:</code>替换掉了），然后点击<code>Replace all</code>替换所有</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.9.png" alt="image-20220810102826028" tabindex="0" loading="lazy"><figcaption>image-20220810102826028</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件里，修改<code>商品已成功加入购物车</code>下面的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mc success-cont<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-lcol<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-top<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>succ-icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ftx-02<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>商品已成功加入购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-img<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/javascript:;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>60px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
                                                             <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item?.image}<span class="token punctuation">&quot;</span></span>
                                                             <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://item.gulimall.com/&#39;+\${item?.skuId}+&#39;.html&#39;<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item?.title}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>TCL 55A950C 55英寸32核人工智能 HDR曲面超薄4K电视金属机身（枪色）<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-extra<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txt<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>数量：&#39;+\${item.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  数量：1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-btns success-btns-new<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-ad<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/#none<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bg_shop<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-tobback<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://item.gulimall.com/&#39;+\${item?.skuId}+&#39;.html&#39;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>查看商品详情<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-addtocart<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://cart.gulimall.com/cart.html<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>GotoShoppingCart<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>去购物车结算<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.1.10.png" alt="image-20220810103431907" tabindex="0" loading="lazy"><figcaption>image-20220810103431907</figcaption></figure><h5 id="_2、后端实现功能" tabindex="-1"><a class="header-anchor" href="#_2、后端实现功能" aria-hidden="true">#</a> 2、后端实现功能</h5><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.CartService</code>接口里添加<code>addToCart</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CartItemVo</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.2.1.png" alt="image-20220810103644997" tabindex="0" loading="lazy"><figcaption>image-20220810103644997</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>addToCart</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;gulimall:cart:&quot;</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CartItemVo</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CartItemVo</span> vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取sku基本信息</span>

    <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 获取要操作的购物车
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> cartKey <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// gulimall:cart:1</span>
        cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// gulimall:cart:6a642344-003e-4ac1-bea1-27260c5c75c3</span>
        cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//stringRedisTemplate.opsForHash().get(cartKey,&quot;1&quot;);</span>
    <span class="token keyword">return</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.2.2.png" alt="image-20220810110241522" tabindex="0" loading="lazy"><figcaption>image-20220810110241522</figcaption></figure><p><code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.SkuInfoController#info</code>方法可以获取<code>sku</code>的详细信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token doc-comment comment">/**
   * 信息
   */</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/info/{skuId}&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token class-name">SkuInfoEntity</span> skuInfo <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;skuInfo&quot;</span><span class="token punctuation">,</span> skuInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.2.3.png" alt="image-20220810110023970" tabindex="0" loading="lazy"><figcaption>image-20220810110023970</figcaption></figure><p>在<code>gulimall-cart</code>模块<code>com.atguigu.gulimall.cart</code>包下新建<code>feign</code>文件夹，在<code>feign</code>文件夹里新建<code>ProductFeignService</code>类，用于调用远程的商品模块</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>cart<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/10
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/skuinfo/info/{skuId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.2.4.png" alt="image-20220810110443729" tabindex="0" loading="lazy"><figcaption>image-20220810110443729</figcaption></figure><p>在<code>gulimall-common</code>模块<code>com.atguigu.common.to</code>包下新建<code>SkuInfoEntityTo</code>类</p><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.entity.SkuInfoEntity</code>类的字段，粘贴到<code>SkuInfoEntityTo</code>类里，并实现<code>Serializable</code>、在类上添加<code>@Data</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkuInfoEntityTo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
   <span class="token doc-comment comment">/**
    * skuId
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * spuId
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * sku名称
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> skuName<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * sku介绍描述
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> skuDesc<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 所属分类id
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 品牌id
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 默认图片
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> skuDefaultImg<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 标题
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> skuTitle<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 副标题
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> skuSubtitle<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 价格
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 销量
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> saleCount<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.2.5.png" alt="image-20220810110959180" tabindex="0" loading="lazy"><figcaption>image-20220810110959180</figcaption></figure><h5 id="_3、使用线程池" tabindex="-1"><a class="header-anchor" href="#_3、使用线程池" aria-hidden="true">#</a> 3、使用线程池</h5><p>由于要查<code>sku基本信息</code>和<code>sku组合信息</code>，因此可以使用线程池加快执行速度</p><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.MyThreadConfig</code>类和<code>com.atguigu.gulimall.product.config.ThreadPollConfigProperties</code>类，粘贴到<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.config</code>里</p><p><code>MyThreadConfig</code>类的代码如下：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.3.1.png" alt="image-20220810112208046" tabindex="0" loading="lazy"><figcaption>image-20220810112208046</figcaption></figure><p><code>ThreadPollConfigProperties</code>类的代码如下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.3.2.png" alt="image-20220810112215617" tabindex="0" loading="lazy"><figcaption>image-20220810112215617</figcaption></figure><p>复制<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件里关于线程池的配置，粘贴到<code>gulimall-cart</code>模块的<code>src/main/resources/application.properties</code>里</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">gulimall.thread.core-pool-size</span><span class="token punctuation">=</span><span class="token value attr-value">20</span>
<span class="token key attr-name">gulimall.thread.maximum-pool-size</span><span class="token punctuation">=</span><span class="token value attr-value">200</span>
<span class="token key attr-name">gulimall.thread.keep-alive-time</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.3.3.png" alt="image-20220810112211009" tabindex="0" loading="lazy"><figcaption>image-20220810112211009</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里修改<code>addToCart</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CartItemVo</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CartItemVo</span> cartItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取sku基本信息</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> skuInfoFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> info <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;skuInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SkuInfoEntityTo</span> infoEntityTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuInfoEntityTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> infoEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//第一次添加，默认选中</span>
        cartItemVo<span class="token punctuation">.</span><span class="token function">setCheck</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//第一次添加，数量都为1</span>
        cartItemVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartItemVo<span class="token punctuation">.</span><span class="token function">setImage</span><span class="token punctuation">(</span>infoEntityTo<span class="token punctuation">.</span><span class="token function">getSkuDefaultImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartItemVo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>infoEntityTo<span class="token punctuation">.</span><span class="token function">getSkuTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartItemVo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>infoEntityTo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartItemVo<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>infoEntityTo<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//远程查询sku组合信息</span>

    <span class="token keyword">return</span> cartItemVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.3.4.png" alt="image-20220810144737624" tabindex="0" loading="lazy"><figcaption>image-20220810144737624</figcaption></figure><h5 id="_4、获取销售属性值" tabindex="-1"><a class="header-anchor" href="#_4、获取销售属性值" aria-hidden="true">#</a> 4、获取销售属性值</h5><p>测试将商品模块sku销售属性值使用<code>：</code>符号连接起来的<code>sql</code></p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>select concat(attr_name,&quot;：&quot;,attr_value) from pms_sku_sale_attr_value where sku_id = 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.1.png" alt="image-20220810114148564" tabindex="0" loading="lazy"><figcaption>image-20220810114148564</figcaption></figure><p>在<code>gulimall-product</code>模块<code>com.atguigu.gulimall.product.controller.SkuSaleAttrValueController</code>类里新建<code>getSkuSaleAttrValues</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/stringlist/{skuId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValues</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>  skuSaleAttrValueService<span class="token punctuation">.</span><span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.2.png" alt="image-20220810114330547" tabindex="0" loading="lazy"><figcaption>image-20220810114330547</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.SkuSaleAttrValueService</code>接口里添加<code>getSkuSaleAttrValuesAsStringList</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.3.png" alt="image-20220810114401389" tabindex="0" loading="lazy"><figcaption>image-20220810114401389</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SkuSaleAttrValueServiceImpl</code>类里实现<code>getSkuSaleAttrValuesAsStringList</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.4.png" alt="image-20220810114559675" tabindex="0" loading="lazy"><figcaption>image-20220810114559675</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.dao.SkuSaleAttrValueDao</code>接口里添加<code>getSkuSaleAttrValuesAsStringList</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValuesAsStringList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.5.png" alt="image-20220810114658076" tabindex="0" loading="lazy"><figcaption>image-20220810114658076</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/mapper/product/SkuSaleAttrValueDao.xml</code>文件里添加查询销售属性的sql</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>&lt;select id=&quot;getSkuSaleAttrValuesAsStringList&quot; resultType=&quot;java.lang.String&quot;&gt;
    select concat(attr_name,&quot;：&quot;,attr_value) from gulimall_pms.pms_sku_sale_attr_value where sku_id = #{skuId}
&lt;/select&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.6.png" alt="image-20220810114914847" tabindex="0" loading="lazy"><figcaption>image-20220810114914847</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.feign.ProductFeignService</code>接口里添加方法，远程获取销售属性值</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/skusaleattrvalue/stringlist/{skuId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuSaleAttrValues</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.7.png" alt="image-20220810115041334" tabindex="0" loading="lazy"><figcaption>image-20220810115041334</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>addToCart</code>方法，在后面添加如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//远程查询sku组合信息</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> getSkuSaleAttrValuesFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> skuSaleAttrValues <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSkuSaleAttrValues</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartItemVo<span class="token punctuation">.</span><span class="token function">setSkuAttr</span><span class="token punctuation">(</span>skuSaleAttrValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>skuInfoFuture<span class="token punctuation">,</span>getSkuSaleAttrValuesFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.8.png" alt="image-20220810145118295" tabindex="0" loading="lazy"><figcaption>image-20220810145118295</figcaption></figure><p>向<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>addToCart</code>方法，<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类的<code>addToCart</code>方法声明可能会抛出的异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.4.9.gif" alt="GIF 2022-8-10 14-54-00" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 14-54-00</figcaption></figure><h5 id="_5、解决bug" tabindex="-1"><a class="header-anchor" href="#_5、解决bug" aria-hidden="true">#</a> 5、解决bug</h5><p>将9号商品添加到购物车 来到<code>http://cart.gulimall.com/addToCart?skuId=9&amp;num=1</code>页面，发现报了json转换失败的异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.5.1.png" alt="image-20220810150601590" tabindex="0" loading="lazy"><figcaption>image-20220810150601590</figcaption></figure><p>查看<code>GulimallCartApplication</code>服务的控制台可以看到报了空指针异常，这是因为<code>price</code>有可能没有</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java.lang.NullPointerException: null
	at com.atguigu.gulimall.cart.vo.CartItemVo.getTotalPrice(CartItemVo.java:53) ~[classes/:na]
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_301]
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_301]
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_301]
	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_301]
	at com.alibaba.fastjson.util.FieldInfo.get(FieldInfo.java:484) ~[fastjson-1.2.47.jar:na]
	at com.alibaba.fastjson.serializer.FieldSerializer.getPropertyValue(FieldSerializer.java:148) ~[fastjson-1.2.47.jar:na]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.5.2.png" alt="image-20220810150312584" tabindex="0" loading="lazy"><figcaption>image-20220810150312584</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.vo.CartItemVo</code>类的<code>getTotalPrice</code>方法，当<code>price</code>为空时，返回<code>0</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 计算总价
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> price<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span> <span class="token operator">:</span> price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.5.3.png" alt="image-20220810150416117" tabindex="0" loading="lazy"><figcaption>image-20220810150416117</figcaption></figure><p>重启<code>gulimall-cart</code>模块，刷新 http://cart.gulimall.com/addToCart?skuId=9&amp;num=1 页面，json工具类又报了不能强转为字符串的异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.5.4.png" alt="image-20220810150805090" tabindex="0" loading="lazy"><figcaption>image-20220810150805090</figcaption></figure><p>将<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>addToCart</code>方法里的<code>JSON.toJSON(cartItemVo)</code>修改为<code>JSON.toJSONString(cartItemVo)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.5.5.png" alt="image-20220810150840904" tabindex="0" loading="lazy"><figcaption>image-20220810150840904</figcaption></figure><h5 id="_6、封装数据" tabindex="-1"><a class="header-anchor" href="#_6、封装数据" aria-hidden="true">#</a> 6、封装数据</h5><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>addToCart</code>方法的<code>Object info = r.get(&quot;skuInfo&quot;);</code>、<code>cartItemVo.setSkuAttr(skuSaleAttrValues);</code>、<code>return cartItemVo;</code>上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.1.png" alt="image-20220810152402432" tabindex="0" loading="lazy"><figcaption>image-20220810152402432</figcaption></figure><p>可以看到<code>BeanUtils.copyProperties(info, infoEntityTo);</code>属性对拷，没有拷过来，这是因为<code>info</code>的类型为<code>LinkedHashMap</code>，存放的是<code>键值对</code>，而不是属性，所以没有拷过来</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.2.png" alt="image-20220810151431796" tabindex="0" loading="lazy"><figcaption>image-20220810151431796</figcaption></figure><p>将<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>addToCart</code>方法的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">SkuInfoEntityTo</span> infoEntityTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuInfoEntityTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> infoEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>修改为</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SkuInfoEntityTo</span> infoEntityTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">SkuInfoEntityTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>重启<code>gulimall-cart</code>模块，可以看到此时已经把属性拷过来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.3.png" alt="image-20220810152042784" tabindex="0" loading="lazy"><figcaption>image-20220810152042784</figcaption></figure><p>可以看到<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>addToCart</code>方法返回的<code>cartItemVo</code>对象的数据已经全部封装成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.4.png" alt="image-20220810152851473" tabindex="0" loading="lazy"><figcaption>image-20220810152851473</figcaption></figure><p>查看redis，临时用户保存的<code>key</code>为<code>gulimall:cart:6a642344-003e-4ac1-bea1-27260c5c75c3</code></p><p>在 http://item.gulimall.com/9.html 页面点击加入购物车，再在redis中查看，<code>gulimall:cart</code>里查看，可以发现刚刚加入到购物车的数据已经保存到redis了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.5.gif" alt="GIF 2022-8-10 15-33-04" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 15-33-04</figcaption></figure><p>登录账号，将一个商品添加到购物车，可以看到保存的<code>key</code>为<code>gulimall:cart:7</code>，也就是用户的id</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.6.gif" alt="GIF 2022-8-10 15-40-05" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 15-40-05</figcaption></figure><p>这是购物车没有此商品的情况，还需要在<code>redis</code>里判断购物车是否有此商品，如果有此商品，只需修改其数量就行了</p><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里的<code>addToCart</code>方法里，</p><p><code>BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</code>这一行下面添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> cartOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">CartItemVo</span> cartItemVo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartItemVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//修改count后，重新计算totalPrice（总价）</span>
    cartItemVo<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItemVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cartItemVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在把<code>BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</code>上面的<code>CartItemVo cartItemVo = new CartItemVo();</code>修改到添加的这几行代码的下面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.7.png" alt="image-20220810155647023" tabindex="0" loading="lazy"><figcaption>image-20220810155647023</figcaption></figure><p>重启<code>gulimall-cart</code>模块，在<code>redis</code>里查看，可以看到当一个商品已经加入过购物车后不会再次添加该商品，只会将<code>数量</code>和<code>价格</code>都增加</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.1.6.8.gif" alt="GIF 2022-8-10 16-01-57" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 16-01-57</figcaption></figure><h4 id="_2、向redis里添加购物车数据" tabindex="-1"><a class="header-anchor" href="#_2、向redis里添加购物车数据" aria-hidden="true">#</a> 2、向redis里添加购物车数据</h4><h5 id="_1、防止用户频繁添加商品到购物车" tabindex="-1"><a class="header-anchor" href="#_1、防止用户频繁添加商品到购物车" aria-hidden="true">#</a> 1、防止用户频繁添加商品到购物车</h5><p>为了防止不断刷新购物车，一直增加商品，可以处理完请求后，重定向到购物车页面（不在url上显示<code>加入购物车</code>的接口），这样刷新页面就不会一直增加商品。（当然，如果你把<code>加入购物车</code>的接口复制出来，一直访问这个接口，还是会一直增加商品）</p><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类的<code>addToCart</code>方法，并添加<code>addToCartSuccessPage</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 添加到购物车
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addToCart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">,</span>
                        <span class="token class-name">RedirectAttributes</span> attributes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

    cartService<span class="token punctuation">.</span><span class="token function">addToCart</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    attributes<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">,</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.gulimall.com/addToCartSuccess.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addToCartSuccess.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addToCartSuccessPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//重定向到成功页面。再次查询购物车数据即可</span>
    <span class="token class-name">CartItemVo</span> item <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">getCartItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.1.1.png" alt="image-20220810163354908" tabindex="0" loading="lazy"><figcaption>image-20220810163354908</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.CartService</code>接口里的<code>getCartItem</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 获取购物车中某个购物项
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">CartItemVo</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.1.2.png" alt="image-20220810162620312" tabindex="0" loading="lazy"><figcaption>image-20220810162620312</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>getCartItem</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CartItemVo</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> cartOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token class-name">CartItemVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.1.3.png" alt="image-20220810162829969" tabindex="0" loading="lazy"><figcaption>image-20220810162829969</figcaption></figure><p>将<code>redis</code>里的数据清空，将一个商品添加到购物车，可以看到再次刷新购物车页面( http://cart.gulimall.com/addToCartSuccess.html?skuId=5 ) 就已经不能添加商品了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.1.4.gif" alt="GIF 2022-8-10 16-38-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 16-38-14</figcaption></figure><h5 id="_2、解决bug" tabindex="-1"><a class="header-anchor" href="#_2、解决bug" aria-hidden="true">#</a> 2、解决bug</h5><p>但是，如果没有输入没有的<code>skuId</code>，比如<code>http://cart.gulimall.com/addToCartSuccess.html?skuId=10</code></p><p>就会报<code>thymeleaf</code>相关的错误</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.2.1.png" alt="image-20220810164038312" tabindex="0" loading="lazy"><figcaption>image-20220810164038312</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件的<code>class=&quot;mc success-cont&quot;</code>的<code>&lt;div&gt;</code>上添加<code>th:if=&quot;\${item!=null}&quot;</code>属性，当<code>item</code>不为空时才显示，并添加上<code>item==null</code>时要显示的数据</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m succeed-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item!=null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mc success-cont<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-lcol<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-top<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>succ-icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ftx-02<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>商品已成功加入购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-img<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/javascript:;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>60px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
                                                                 <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item?.image}<span class="token punctuation">&quot;</span></span>
                                                                 <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://item.gulimall.com/&#39;+\${item?.skuId}+&#39;.html&#39;<span class="token punctuation">&quot;</span></span>
                           <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item?.title}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>TCL 55A950C 55英寸32核人工智能 HDR曲面超薄4K电视金属机身（枪色）<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-extra<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txt<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>数量：&#39;+\${item.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  数量：1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-btns success-btns-new<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-ad<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/#none<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bg_shop<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-tobback<span class="token punctuation">&quot;</span></span>
                   <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://item.gulimall.com/&#39;+\${item?.skuId}+&#39;.html&#39;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>查看商品详情<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn-addtocart<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://cart.gulimall.com/cart.html<span class="token punctuation">&quot;</span></span>
                   <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>GotoShoppingCart<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>去购物车结算<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item==null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mc success-cont<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>购物车竟然是空的<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://gulimall.com/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>去购物<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.2.2.png" alt="image-20220810164807495" tabindex="0" loading="lazy"><figcaption>image-20220810164807495</figcaption></figure><p>重启<code>gulimall-cart</code>模块，再次访问<code>http://cart.gulimall.com/addToCartSuccess.html?skuId=10</code>页面，此时就会显示购物车竟然是空的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.2.3.png" alt="image-20220810164833622" tabindex="0" loading="lazy"><figcaption>image-20220810164833622</figcaption></figure><h5 id="_3、获取整个购物车" tabindex="-1"><a class="header-anchor" href="#_3、获取整个购物车" aria-hidden="true">#</a> 3、获取整个购物车</h5><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类的<code>cartListPage</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 浏览器有一个cookie; user-key; 标识用户身份，一个月后过期;
 * 如果第一次使用jd的购物车功能，都会给一个临时的用户身份;
 * 浏览器以后保存，每次访问都会带上这个cookie;
 * 登录: session有用户
 * 没登录:按照cookie里面带来user-key来做。
 * 第一次:如果没有临时用户，帮忙创建一个临时用户。
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 去登录页的请求
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cart.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">cartListPage</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//从ThreadLocal里得到用户信息</span>
    <span class="token comment">//UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();</span>
    <span class="token comment">//System.out.println(userInfoTo);</span>
    <span class="token class-name">CartVo</span> cartVo <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">getCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;cart&quot;</span><span class="token punctuation">,</span>cartVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;cartList&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.1.png" alt="image-20220810165336649" tabindex="0" loading="lazy"><figcaption>image-20220810165336649</figcaption></figure><p>在<code>gulimall-cart</code>模块<code>com.atguigu.gulimall.cart.service.CartService</code>接口里添加<code>getCart</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 获取整个购物车
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">CartVo</span> <span class="token function">getCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.2.png" alt="image-20220810165422521" tabindex="0" loading="lazy"><figcaption>image-20220810165422521</figcaption></figure><p>在<code>gulimall-cart</code>模块<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>getCart</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CartVo</span> <span class="token function">getCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CartVo</span> cartVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CartVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> cartKey <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//已登录</span>
        <span class="token comment">//先判断临时购物车有没有数据</span>
        <span class="token class-name">String</span> tempCartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> tempCartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>tempCartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>tempCartItems<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//临时购物车有数据(合并到用户账户中)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> tempCartItem <span class="token operator">:</span> tempCartItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">addToCart</span><span class="token punctuation">(</span>tempCartItem<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>tempCartItem<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//删除redis里临时购物车的数据</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>tempCartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// gulimall:cart:1</span>
        cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cartVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>cartItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//没登录</span>
        <span class="token comment">// gulimall:cart:6a642344-003e-4ac1-bea1-27260c5c75c3</span>
        cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取临时购物车的所有购物项</span>
        cartVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span><span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cartVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCartItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> cartKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> hashOps <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">CartItemVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.3.png" alt="image-20220810190503779" tabindex="0" loading="lazy"><figcaption>image-20220810190503779</figcaption></figure><p><code>gulimall-cart</code>模块<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里<code>getCart</code>方法，<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类的<code>cartListPage</code>方法 声明要抛出的异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.4.gif" alt="GIF 2022-8-10 19-02-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 19-02-31</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件里<code>你好，请登录</code>周围的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hd_wrap_right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>欢迎：[[\${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>li_2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>spacer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/javascript:;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.5.png" alt="image-20220810185536347" tabindex="0" loading="lazy"><figcaption>image-20220810185536347</figcaption></figure><p>重启<code>gulimall-cart</code>模块，清空<code>redis</code>里的数据，登录后随便将一个商品添加到购物车，此时就可以看到已登录用户<code>redis</code>里购物车的数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.6.gif" alt="GIF 2022-8-10 19-12-25" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 19-12-25</figcaption></figure><p>清空 http://gulimall.com/ 里的<code>cookie</code> ，未登录的情况下随便将一个商品添加到购物车，此时就可以看到未登录的用户<code>redis</code>里也有购物车的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.7.gif" alt="GIF 2022-8-10 19-13-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 19-13-38</figcaption></figure><p>未登录的情况下再将一个不同的商品添加到购物车，此时就可以看到未登录的用户<code>redis</code>里购物车的数据增加了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.8.gif" alt="GIF 2022-8-10 19-19-48" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 19-19-48</figcaption></figure><p>此时再进行登录，再次查看<code>redis</code>里的数据，可以看到此时已经将临时购物车里的商品合并到用户的购物车里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.3.9.gif" alt="GIF 2022-8-10 19-22-53" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 19-22-53</figcaption></figure><h5 id="_4、显示购物车中的数据" tabindex="-1"><a class="header-anchor" href="#_4、显示购物车中的数据" aria-hidden="true">#</a> 4、显示购物车中的数据</h5><p>修改<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件</p>`,387),an=t(`<figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.4.1.png" alt="image-20220810195414544" tabindex="0" loading="lazy"><figcaption>image-20220810195414544</figcaption></figure><p>重启<code>gulimall-cart</code>模块，登录后访问 http://cart.gulimall.com/cart.html 购物车页面，此时购物车数据已经显示出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.2.4.2.png" alt="image-20220810195212654" tabindex="0" loading="lazy"><figcaption>image-20220810195212654</figcaption></figure><h4 id="_3、增删查改商品" tabindex="-1"><a class="header-anchor" href="#_3、增删查改商品" aria-hidden="true">#</a> 3、增删查改商品</h4><h5 id="_1、勾选-取消勾选商品" tabindex="-1"><a class="header-anchor" href="#_1、勾选-取消勾选商品" aria-hidden="true">#</a> 1、<code>勾选</code>/<code>取消勾选</code>商品</h5><p>将<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里选没选中的<code>&lt;input&gt;</code>标签的<code>class=&quot;check&quot;</code>修改为<code> class=&quot;itemCheck&quot;</code>，并添加自定义属性<code>th:attr=&quot;skuId=\${item.skuId}&quot;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId=\${item.skuId}<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>itemCheck<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>checked</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item.check}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.1.1.png" alt="image-20220810195948921" tabindex="0" loading="lazy"><figcaption>image-20220810195948921</figcaption></figure><p>将<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件的<code>&lt;script&gt;</code>标签里添加方法，用于勾选或取消勾选商品</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>$<span class="token punctuation">(</span><span class="token string">&quot;.itemCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> skuId <span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//用prop获取checked属性返回的是true或false</span>
    <span class="token keyword">var</span> check <span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">&quot;checked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://cart.gulimall.com/checkItem?skuId=&quot;</span> <span class="token operator">+</span> skuId <span class="token operator">+</span><span class="token string">&quot;&amp;check=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>check<span class="token operator">?</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.1.2.png" alt="image-20220810204135752" tabindex="0" loading="lazy"><figcaption>image-20220810204135752</figcaption></figure><h5 id="_2、添加checkitem方法" tabindex="-1"><a class="header-anchor" href="#_2、添加checkitem方法" aria-hidden="true">#</a> 2、添加<code>checkItem</code>方法</h5><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类里添加<code>checkItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/checkItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;check&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> check<span class="token punctuation">)</span><span class="token punctuation">{</span>

    cartService<span class="token punctuation">.</span><span class="token function">checkItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>check<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.2.1.png" alt="image-20220810203708568" tabindex="0" loading="lazy"><figcaption>image-20220810203708568</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.CartService</code>接口里添加<code>checkItem</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 勾选购物项
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">check</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">checkItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> check<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.2.2.png" alt="image-20220810201847437" tabindex="0" loading="lazy"><figcaption>image-20220810201847437</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>checkItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 修改购物车中商品的选中状态
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">check</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CartItemVo</span> cartItem <span class="token operator">=</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartItem<span class="token punctuation">.</span><span class="token function">setCheck</span><span class="token punctuation">(</span>check <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存放到redis</span>
    cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.2.3.png" alt="image-20220810203451501" tabindex="0" loading="lazy"><figcaption>image-20220810203451501</figcaption></figure><p>重启<code>gulimall-cart</code>模块，取消选中购物车中的商品，此时<code>redis</code>里对应用户的购物车里该商品的<code>check</code>属性变为了<code>false</code>，再次选中该购物车的该商品，此时<code>redis</code>里对应用户的购物车里该商品的<code>check</code>属性又变为了<code>false</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.2.4.gif" alt="GIF 2022-8-10 20-42-49" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 20-42-49</figcaption></figure><h5 id="_3、修改商品数量" tabindex="-1"><a class="header-anchor" href="#_3、修改商品数量" aria-hidden="true">#</a> 3、修改商品数量</h5><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里，修改购物车里购物项的数量按钮对应的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 80px</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId = \${item.skuId}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>countOpsBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>-<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>countOpsNum<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${item.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>countOpsBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.3.1.png" alt="image-20220810204946862" tabindex="0" loading="lazy"><figcaption>image-20220810204946862</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件的<code>&lt;script&gt;</code>标签里添加如下代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.countOpsBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//$(this).parent()：父元素</span>
   <span class="token keyword">var</span> skuId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//find(&quot;.countOpsNum&quot;)：查找子元素</span>
   <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;.countOpsNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://cart.gulimall.com/countItem?skuId=&quot;</span> <span class="token operator">+</span> skuId <span class="token operator">+</span><span class="token string">&quot;&amp;num=&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.3.2.png" alt="image-20220810205713537" tabindex="0" loading="lazy"><figcaption>image-20220810205713537</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类里添加<code>countItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/countItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">countItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>

    cartService<span class="token punctuation">.</span><span class="token function">changeItemCount</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.3.3.png" alt="image-20220810205938886" tabindex="0" loading="lazy"><figcaption>image-20220810205938886</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.CartService</code>接口里添加<code>changeItemCount</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 修改购物项(购物车里的商品)数量
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">num</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">changeItemCount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.3.4.png" alt="image-20220810210100509" tabindex="0" loading="lazy"><figcaption>image-20220810210100509</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>changeItemCount</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeItemCount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CartItemVo</span> cartItem <span class="token operator">=</span> <span class="token function">getCartItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartItem<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存放到redis</span>
    cartOps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.3.5.png" alt="image-20220810210507186" tabindex="0" loading="lazy"><figcaption>image-20220810210507186</figcaption></figure><p>重启<code>gulimall-cart</code>模块，先查看购物车中第一件商品的数量，然后在 http://cart.gulimall.com/cart.html 页面里点击该商品数量的<code>+</code>号增加该商品数量，此时查看<code>redis</code>就可以看到该商品的数量增加了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.3.6.gif" alt="GIF 2022-8-10 21-05-45" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-10 21-05-45</figcaption></figure><h5 id="_4、删除商品" tabindex="-1"><a class="header-anchor" href="#_4、删除商品" aria-hidden="true">#</a> 4、删除商品</h5><p>在 http://cart.gulimall.com/cart.html 页面里点击一个商品操作中的<code>删除</code>，此时会弹出一个<code>删除商品</code>对话框，，打开控制台，定位到删除商品对话框的删除，复制<code>&lt;button type=&quot;button&quot;&gt;删除&lt;/button&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.1.png" alt="image-20220810210959478" tabindex="0" loading="lazy"><figcaption>image-20220810210959478</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里搜索<code>&lt;button type=&quot;button&quot;&gt;删除&lt;/button&gt;</code>，找到对应的对话框的删除标签，给这个<code>&lt;button&gt;</code>标签添加<code>onclick=&quot;deleteItem()&quot;</code>点击事件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.2.png" alt="image-20220810211209293" tabindex="0" loading="lazy"><figcaption>image-20220810211209293</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里搜索<code>删除</code>，找到对应的点击该删除弹出删除对话框的标签，修改为如下代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deleteItemBtn<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId=\${item.skuId}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.3.png" alt="image-20220810211355262" tabindex="0" loading="lazy"><figcaption>image-20220810211355262</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>文件里的<code>&lt;script&gt;</code>里添加如下代码，用于删除购物项</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> deleteId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//删除购物项</span>
<span class="token keyword">function</span> <span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://cart.gulimall.com/deleteItem?skuId=&quot;</span> <span class="token operator">+</span> deleteId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.deleteItemBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   deleteId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.4.png" alt="image-20220810232920265" tabindex="0" loading="lazy"><figcaption>image-20220810232920265</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类里添加<code>deleteItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/deleteItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    cartService<span class="token punctuation">.</span><span class="token function">deleteItem</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.5.png" alt="image-20220810232413642" tabindex="0" loading="lazy"><figcaption>image-20220810232413642</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.CartService</code>接口里添加<code>deleteItem</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 删除购物项（删除购物车里的一个商品）
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.6.png" alt="image-20220810232550529" tabindex="0" loading="lazy"><figcaption>image-20220810232550529</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>deleteItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cartOps <span class="token operator">=</span> <span class="token function">getCartOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cartOps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>skuId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.7.png" alt="image-20220810232708946" tabindex="0" loading="lazy"><figcaption>image-20220810232708946</figcaption></figure><p>重启<code>gulimall-cart</code>模块，先在<code>redis</code>里查看购物车的数据，再在 http://cart.gulimall.com/cart.html 页面里删除一个商品，再次查看<code>redis</code>，此时刚刚删除的商品已经没有了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.7.9.3.4.8.gif" alt="GIF 2022-8-11 15-32-03" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-11 15-32-03</figcaption></figure><h4 id="_4、" tabindex="-1"><a class="header-anchor" href="#_4、" aria-hidden="true">#</a> 4、</h4><p>redisson的无看门狗</p><p>springcache的加锁</p>`,67);function tn(en,pn){const p=c("RouterLink"),e=c("ExternalLinkIcon");return l(),u("div",null,[d,n("p",null,[s("完整代码："),a(p,{to:"/gulimall/code/5.7.1.1.3.6.login.html"},{default:o(()=>[s("gulimall-auth-server模块的src/main/resources/templates/login.html文件")]),_:1})]),k,n("p",null,[s("完整代码："),a(p,{to:"/gulimall/code/5.7.1.1.3.7.reg.html"},{default:o(()=>[s("gulimall-auth-server模块的src/main/resources/templates/reg.html文件")]),_:1})]),m,n("p",null,[s("完整代码： "),a(p,{to:"/gulimall/code/5.7.2.2.2.1.HttpUtils.html"},{default:o(()=>[s("gulimall-third-party模块的com.atguigu.gulimall.thirdparty.util.HttpUtils类")]),_:1})]),g,n("p",null,[s("参考："),n("a",v,[s("springboot实现邮箱验证_冰咖啡iii的博客-CSDN博客_springboot邮箱验证"),a(e)])]),b,n("ul",null,[f,n("li",null,[n("p",null,[s("注意：如果获取 access_token 返回 403，可能是没有设置User-Agent的原因。 详见："),n("a",h,[s("获取Token时服务端响应状态403是什么情况"),a(e)])])])]),y,n("ul",null,[n("li",null,[s("在 "),n("strong",null,[n("a",w,[s("修改资料"),a(e)])]),s(" -> "),n("strong",null,[n("a",q,[s("第三方应用"),a(e)])]),s("，创建要接入码云的应用。 "),x]),S,z]),j,I,n("p",null,[s("参考地址： "),n("a",_,[s("PropertyNamingStrategy_cn · alibaba/fastjson Wiki (github.com)"),a(e)])]),C,n("p",null,[n("a",T,[s("Java开发里遇到的奇奇怪怪的需求---JSON键值驼峰转下划线的实现 - 知乎 (zhihu.com)"),a(e)])]),R,n("p",null,[s("链接： "),n("a",E,[s("fastjson中的@JSONField注解_y_bccl27的博客-CSDN博客_fastjson jsonfield注解"),a(e)])]),n("p",null,[s("使用"),n("a",O,[s("fastjson"),a(e)]),s("之前需先引入下述依赖，当前版本为1.2.75")]),A,n("p",null,[s("format属性用于规定"),n("a",M,[s("序列化"),a(e)]),s("和反序列化时成员变量的日期格式")]),F,n("p",null,[n("a",N,[s("filter过滤链：Filter链是如何构建的？ (itcast.cn)"),a(e)])]),P,n("p",null,[n("a",G,[s("JWT"),a(e)]),s("工具")]),L,U,n("ol",null,[D,V,H,n("li",null,[n("p",null,[n("a",J,[s("base64编码"),a(e)]),s("，并不是加密，只是把明文信息变成了不可见的字符串。但是其实只要用一些工具就可以吧base64编码解成明文，所以不要在JWT中放入涉及私密的信息，因为实际上JWT并不是加密信息。")])])]),B,n("p",null,[s("在 https://gitee.com/ 里搜索"),$,s("，选择 "),n("a",W,[s("许雪里"),a(e)]),s(" / "),n("a",K,[s("xxl-sso"),a(e)])]),Q,n("p",null,[a(p,{to:"/gulimall/code/"},{default:o(()=>[s("点击查看完整的"),X,s("模块的"),Y,s("文件")]),_:1})]),Z,n("p",null,[a(p,{to:"/gulimall/code/5.7.8.1.4.1.html"},{default:o(()=>[s("点击查看完整页面")]),_:1})]),nn,n("p",null,[a(p,{to:"/gulimall/code/5.7.8.1.4.2.html"},{default:o(()=>[s("点击查看完整页面")]),_:1})]),sn,n("p",null,[a(p,{to:"/gulimall/code/5.7.9.2.4.html"},{default:o(()=>[s("点击查看完整代码")]),_:1})]),an])}const ln=i(r,[["render",tn],["__file","advanced4.html.vue"]]);export{ln as default};
