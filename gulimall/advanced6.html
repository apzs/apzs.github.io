<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.5" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://apzs.github.io/gulimall/advanced6.html"><meta property="og:site_name" content="apzs"><meta property="og:title" content="6.3、支付商品"><meta property="og:description" content="6.3、支付商品 6.3.1、支付 1、相关概念 1、文档 支付宝电脑网站解锁 文档链接：https://opendocs.alipay.com/open/270/105898?ref=api GIF 2022-8-20 15-34-17"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-05T06:05:15.000Z"><meta property="article:author" content="apzs"><meta property="article:modified_time" content="2024-03-05T06:05:15.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"6.3、支付商品","image":[""],"dateModified":"2024-03-05T06:05:15.000Z","author":[{"@type":"Person","name":"apzs","url":"https://apzs.eu.org"}]}</script><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>6.3、支付商品 | apzs</title><meta name="description" content="6.3、支付商品 6.3.1、支付 1、相关概念 1、文档 支付宝电脑网站解锁 文档链接：https://opendocs.alipay.com/open/270/105898?ref=api GIF 2022-8-20 15-34-17">
    <link rel="preload" href="/assets/style-1BJnvNLI.css" as="style"><link rel="stylesheet" href="/assets/style-1BJnvNLI.css">
    <link rel="modulepreload" href="/assets/app-ldxHvpH7.js"><link rel="modulepreload" href="/assets/advanced6.html-7fOhj-hR.js"><link rel="modulepreload" href="/assets/advanced6.html-k5auFwFX.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/assets/index.html-y3g4CpbS.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-gEURi3aX.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-OcxTIOHO.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-XR72c_om.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-ZR4Y_K2h.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-M2icssIB.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-7Kx2gTnc.js" as="script"><link rel="prefetch" href="/assets/7.git.html-qXt_wASp.js" as="script"><link rel="prefetch" href="/assets/advanced1.html-9bBPC8sA.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-ZcYyohxw.js" as="script"><link rel="prefetch" href="/assets/advanced3.html--EENfr4C.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-qON-1HJR.js" as="script"><link rel="prefetch" href="/assets/advanced5.html-x_FAsfet.js" as="script"><link rel="prefetch" href="/assets/base1.html-eTaS1DsU.js" as="script"><link rel="prefetch" href="/assets/base2.html-uamOpGZW.js" as="script"><link rel="prefetch" href="/assets/cluster.html-054M96dh.js" as="script"><link rel="prefetch" href="/assets/1.Nginx的安装部署.html-uYbd2ebL.js" as="script"><link rel="prefetch" href="/assets/10.十分钟快速建站之在线论坛Discuz部署实战.html-QY6HLKuo.js" as="script"><link rel="prefetch" href="/assets/2.Nginx的的目录结构_基本运行原理及基本配置文件.html-Y7mqlMtZ.js" as="script"><link rel="prefetch" href="/assets/3.Nginx 虚拟主机与域名解析.html-sQ96m563.js" as="script"><link rel="prefetch" href="/assets/4.ServerName匹配规则.html-3xXeBzj4.js" as="script"><link rel="prefetch" href="/assets/5.反向代理在系统结构中的应用场景.html-k5aGGu3I.js" as="script"><link rel="prefetch" href="/assets/6.nginx动静分离及Rewrite实战.html-G-FLKxx7.js" as="script"><link rel="prefetch" href="/assets/7.nginx高可用及Keepalived实战.html-zyOteMot.js" as="script"><link rel="prefetch" href="/assets/8.Nginx配置防盗链(详细了解如何配置nginx防盗链).html-ZP_L6pTq.js" as="script"><link rel="prefetch" href="/assets/9.申请阿里云免费SSL证书并配置https访问实战.html-KHpQurCY.js" as="script"><link rel="prefetch" href="/assets/index.html-JHGBtjxR.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-bjBzt6JL.js" as="script"><link rel="prefetch" href="/assets/index.html-0VkVNp2J.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-QAsMGnnc.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-w0753rG7.js" as="script"><link rel="prefetch" href="/assets/index.html-pICozyRy.js" as="script"><link rel="prefetch" href="/assets/index.html-zzfV3qLa.js" as="script"><link rel="prefetch" href="/assets/01. Object类、常用API.html-aILz-SPf.js" as="script"><link rel="prefetch" href="/assets/02. Collection、泛型.html-LtRENtkQ.js" as="script"><link rel="prefetch" href="/assets/03. List、Set.html-jTIndb1X.js" as="script"><link rel="prefetch" href="/assets/04. Map.html-ZYo--4N1.js" as="script"><link rel="prefetch" href="/assets/05. 异常、线程.html-FgqjHGj9.js" as="script"><link rel="prefetch" href="/assets/06. 线程、同步.html-Jusr_H-I.js" as="script"><link rel="prefetch" href="/assets/07. 等待与唤醒案例、线程池、Lambda表达式.html-bZAxifpd.js" as="script"><link rel="prefetch" href="/assets/08. File类、递归.html-dzCncgJ-.js" as="script"><link rel="prefetch" href="/assets/09. 字节流、字符流.html-9nm4yVmk.js" as="script"><link rel="prefetch" href="/assets/10. 缓冲流、转换流、序列化流、打印流.html-aJx7Rt0R.js" as="script"><link rel="prefetch" href="/assets/11. 网络编程.html-ixfBHZIz.js" as="script"><link rel="prefetch" href="/assets/12. 函数式接口.html-aET2xB7v.js" as="script"><link rel="prefetch" href="/assets/13. 方法引用.html-SLa6BGQT.js" as="script"><link rel="prefetch" href="/assets/14. Stream流.html-zExXMgTS.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-S4sR6ceN.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-Kh1eiS8S.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-cnv0S7AD.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-RdX4lj_8.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-Vkoji7Ak.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-Hss7GySa.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-c4I-JYNu.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-uiWCOh_t.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-D3XpIr4T.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-37R9pYDr.js" as="script"><link rel="prefetch" href="/assets/index.html-liiu_EKl.js" as="script"><link rel="prefetch" href="/assets/index.html-IxRk3Ohd.js" as="script"><link rel="prefetch" href="/assets/index.html-qiUusNr1.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-byrPjTkh.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-z3DJu42D.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-vfxkftz5.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-jIXgwym4.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-oiw13F_a.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-n8EepeqG.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-5yv9NEC_.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-nS1PYjhk.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-cBl4nVoH.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-gkZIiZ0O.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-W7g-fbAg.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-zUWuxTai.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-8TaE0Zp1.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-rnTgMrUt.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-rT8S5BXV.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-KO3HDIMu.js" as="script"><link rel="prefetch" href="/assets/1.scss基础.html-Lztop7Sb.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-uhthownJ.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-yV0wPlKP.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-DSnWzAbP.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-x8wQcT1s.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-vPTowO2E.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-Q5gjqvel.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-IkxemcdB.js" as="script"><link rel="prefetch" href="/assets/1.html.html-XP7fLhRZ.js" as="script"><link rel="prefetch" href="/assets/2.css.html-iD5KnMOI.js" as="script"><link rel="prefetch" href="/assets/3.mobile.html-k_6KIzVP.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html-cAJ4q7Ac.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-h6Mn4aXq.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-iXNFvl0G.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-eYCrWOga.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-7nS35Qvf.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html--6DfVamv.js" as="script"><link rel="prefetch" href="/assets/index.html-ANoDwuDF.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-MFo6bo05.js" as="script"><link rel="prefetch" href="/assets/01. Vue3入门.html-_QaNG_Dz.js" as="script"><link rel="prefetch" href="/assets/02. Pinia入门.html-HCgNT7sl.js" as="script"><link rel="prefetch" href="/assets/03. 项目起步.html-H_Uzdquo.js" as="script"><link rel="prefetch" href="/assets/04. Layout页.html-Ofw6qK2g.js" as="script"><link rel="prefetch" href="/assets/05. Home页.html-crUAEJfT.js" as="script"><link rel="prefetch" href="/assets/06. 一级分类页.html-pVJSzqbu.js" as="script"><link rel="prefetch" href="/assets/07. 二级分类页.html-bqYpoqHE.js" as="script"><link rel="prefetch" href="/assets/08. 商品详情.html-VolSpyaS.js" as="script"><link rel="prefetch" href="/assets/09. 登录页.html-AYgm4nmi.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-3aEzp0n4.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-5DT00V7P.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-w9X1oj35.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-SL1kR47w.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-KiZNu1Mv.js" as="script"><link rel="prefetch" href="/assets/00. uni-app前置知识.html-94R5zX1Z.js" as="script"><link rel="prefetch" href="/assets/01. 项目起步.html-r7sUKndc.js" as="script"><link rel="prefetch" href="/assets/02. 首页模块.html-_OzGqhFW.js" as="script"><link rel="prefetch" href="/assets/03. 推荐模块.html-utAtQCID.js" as="script"><link rel="prefetch" href="/assets/04. 分类模块.html-bKecFVa2.js" as="script"><link rel="prefetch" href="/assets/05. 详情模块.html-DVk1JbkT.js" as="script"><link rel="prefetch" href="/assets/06. 登录模块.html-rcIaMrj3.js" as="script"><link rel="prefetch" href="/assets/07. 用户模块.html-7eS_5DsD.js" as="script"><link rel="prefetch" href="/assets/08. 地址模块.html-fs9hAzYf.js" as="script"><link rel="prefetch" href="/assets/09. SKU模块.html-YK1MXHBh.js" as="script"><link rel="prefetch" href="/assets/10. 购物车模块.html-bkhVI477.js" as="script"><link rel="prefetch" href="/assets/11. 订单模块.html-zTJDIbZ2.js" as="script"><link rel="prefetch" href="/assets/12. 项目打包.html-Gy_cUBmf.js" as="script"><link rel="prefetch" href="/assets/index.html-9JBwGe9X.js" as="script"><link rel="prefetch" href="/assets/index.html-EjcBU5lt.js" as="script"><link rel="prefetch" href="/assets/index.html-I4z_CyW1.js" as="script"><link rel="prefetch" href="/assets/index.html-yJjipLz_.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-agnhV7l6.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-bVdW6071.js" as="script"><link rel="prefetch" href="/assets/index.html-nBxbKQIK.js" as="script"><link rel="prefetch" href="/assets/index.html-p166CSk-.js" as="script"><link rel="prefetch" href="/assets/learn.html-BD7CfiUB.js" as="script"><link rel="prefetch" href="/assets/404.html-btkZhlkE.js" as="script"><link rel="prefetch" href="/assets/index.html-T17ErqbF.js" as="script"><link rel="prefetch" href="/assets/index.html-Jib5dSeG.js" as="script"><link rel="prefetch" href="/assets/index.html-JqXNyWB5.js" as="script"><link rel="prefetch" href="/assets/index.html-hY-RGNU1.js" as="script"><link rel="prefetch" href="/assets/index.html-oqCBIS_v.js" as="script"><link rel="prefetch" href="/assets/index.html-AJMwoc2R.js" as="script"><link rel="prefetch" href="/assets/index.html-7nfKGyCc.js" as="script"><link rel="prefetch" href="/assets/index.html-IfBIxRfC.js" as="script"><link rel="prefetch" href="/assets/index.html-muoKEAuh.js" as="script"><link rel="prefetch" href="/assets/index.html-t45lBcxI.js" as="script"><link rel="prefetch" href="/assets/index.html-lAWe1giX.js" as="script"><link rel="prefetch" href="/assets/index.html-kSDPDur8.js" as="script"><link rel="prefetch" href="/assets/index.html-gbNr7hUM.js" as="script"><link rel="prefetch" href="/assets/index.html-6QthmMSB.js" as="script"><link rel="prefetch" href="/assets/index.html-42CY4ac1.js" as="script"><link rel="prefetch" href="/assets/index.html-ueDLoTJ_.js" as="script"><link rel="prefetch" href="/assets/index.html-_LMh2RFh.js" as="script"><link rel="prefetch" href="/assets/index.html-8I_4T32_.js" as="script"><link rel="prefetch" href="/assets/index.html-tzRxRAhM.js" as="script"><link rel="prefetch" href="/assets/index.html-A2W4RlcH.js" as="script"><link rel="prefetch" href="/assets/index.html-G9n0k6L7.js" as="script"><link rel="prefetch" href="/assets/index.html-CrBH0s0U.js" as="script"><link rel="prefetch" href="/assets/index.html-LY4lUlKW.js" as="script"><link rel="prefetch" href="/assets/index.html-mLa21Q4L.js" as="script"><link rel="prefetch" href="/assets/index.html-YOwGpRFB.js" as="script"><link rel="prefetch" href="/assets/index.html-hK44yUtw.js" as="script"><link rel="prefetch" href="/assets/index.html-unBKqZcs.js" as="script"><link rel="prefetch" href="/assets/index.html-XjlmNyCs.js" as="script"><link rel="prefetch" href="/assets/index.html-JK2p7ZfK.js" as="script"><link rel="prefetch" href="/assets/index.html-lzCrPyBd.js" as="script"><link rel="prefetch" href="/assets/index.html-RTbSWDU_.js" as="script"><link rel="prefetch" href="/assets/index.html-dHsCb8RY.js" as="script"><link rel="prefetch" href="/assets/index.html-KlaSRFzG.js" as="script"><link rel="prefetch" href="/assets/index.html-DGX3PCk-.js" as="script"><link rel="prefetch" href="/assets/index.html-Znc0hCnd.js" as="script"><link rel="prefetch" href="/assets/index.html-S6kMG4Fx.js" as="script"><link rel="prefetch" href="/assets/index.html-YqwzmRnM.js" as="script"><link rel="prefetch" href="/assets/index.html-egQ26E2T.js" as="script"><link rel="prefetch" href="/assets/index.html-o564GG_l.js" as="script"><link rel="prefetch" href="/assets/index.html-1somrFyk.js" as="script"><link rel="prefetch" href="/assets/index.html-lK4owPTJ.js" as="script"><link rel="prefetch" href="/assets/index.html-qqrI0K08.js" as="script"><link rel="prefetch" href="/assets/index.html-qAyUJ9W7.js" as="script"><link rel="prefetch" href="/assets/index.html-tehrrtUn.js" as="script"><link rel="prefetch" href="/assets/index.html-mMGauwho.js" as="script"><link rel="prefetch" href="/assets/index.html-m13qsTw5.js" as="script"><link rel="prefetch" href="/assets/index.html-QvL1dW2n.js" as="script"><link rel="prefetch" href="/assets/index.html-dKZ88i_K.js" as="script"><link rel="prefetch" href="/assets/index.html-onTroC3r.js" as="script"><link rel="prefetch" href="/assets/index.html-uBLya5A3.js" as="script"><link rel="prefetch" href="/assets/index.html-nKQ4V-jV.js" as="script"><link rel="prefetch" href="/assets/index.html-SU8Gk36j.js" as="script"><link rel="prefetch" href="/assets/index.html-qzLRUcq5.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-8BYkbvFX.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-N-dziMPp.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-wqjfrlzt.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-o0ueQIzO.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-sHEfsJb4.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-jGXq6psl.js" as="script"><link rel="prefetch" href="/assets/7.git.html-sRCLnPTT.js" as="script"><link rel="prefetch" href="/assets/advanced1.html-pFoXK57F.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-z9LSS4RY.js" as="script"><link rel="prefetch" href="/assets/advanced3.html-p--qF8TW.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-1jkfhWek.js" as="script"><link rel="prefetch" href="/assets/advanced5.html-9KrxzgjV.js" as="script"><link rel="prefetch" href="/assets/base1.html-8GGOsZr4.js" as="script"><link rel="prefetch" href="/assets/base2.html-bUUFTble.js" as="script"><link rel="prefetch" href="/assets/cluster.html-vngr7oy1.js" as="script"><link rel="prefetch" href="/assets/1.Nginx的安装部署.html-wA2ZqiAh.js" as="script"><link rel="prefetch" href="/assets/10.十分钟快速建站之在线论坛Discuz部署实战.html-BT13rPDI.js" as="script"><link rel="prefetch" href="/assets/2.Nginx的的目录结构_基本运行原理及基本配置文件.html-cZT548pN.js" as="script"><link rel="prefetch" href="/assets/3.Nginx 虚拟主机与域名解析.html-6GEoXJQr.js" as="script"><link rel="prefetch" href="/assets/4.ServerName匹配规则.html-XHuYUAjw.js" as="script"><link rel="prefetch" href="/assets/5.反向代理在系统结构中的应用场景.html-He2lmZ9d.js" as="script"><link rel="prefetch" href="/assets/6.nginx动静分离及Rewrite实战.html-QmRYtVk1.js" as="script"><link rel="prefetch" href="/assets/7.nginx高可用及Keepalived实战.html-pyPtz-bF.js" as="script"><link rel="prefetch" href="/assets/8.Nginx配置防盗链(详细了解如何配置nginx防盗链).html-WFeBZqWW.js" as="script"><link rel="prefetch" href="/assets/9.申请阿里云免费SSL证书并配置https访问实战.html-NJw1NzzI.js" as="script"><link rel="prefetch" href="/assets/index.html-q3Hup-XB.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-Ysm7QqOA.js" as="script"><link rel="prefetch" href="/assets/index.html-TaYmJ1Mc.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-Dd17S3i0.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-nxpnzqj9.js" as="script"><link rel="prefetch" href="/assets/index.html-HgE6c4o_.js" as="script"><link rel="prefetch" href="/assets/index.html-Gn4-bFTA.js" as="script"><link rel="prefetch" href="/assets/01. Object类、常用API.html-USVaT7bz.js" as="script"><link rel="prefetch" href="/assets/02. Collection、泛型.html-0tUL0yQS.js" as="script"><link rel="prefetch" href="/assets/03. List、Set.html-gjY9Zyq8.js" as="script"><link rel="prefetch" href="/assets/04. Map.html-wLYd7vRc.js" as="script"><link rel="prefetch" href="/assets/05. 异常、线程.html-S6cPPV-z.js" as="script"><link rel="prefetch" href="/assets/06. 线程、同步.html-Y8l-Z01Y.js" as="script"><link rel="prefetch" href="/assets/07. 等待与唤醒案例、线程池、Lambda表达式.html-UFuOIY-c.js" as="script"><link rel="prefetch" href="/assets/08. File类、递归.html-lj1OEgjx.js" as="script"><link rel="prefetch" href="/assets/09. 字节流、字符流.html-jjEbyw9G.js" as="script"><link rel="prefetch" href="/assets/10. 缓冲流、转换流、序列化流、打印流.html-uNrcg5lu.js" as="script"><link rel="prefetch" href="/assets/11. 网络编程.html-xAeeRwcU.js" as="script"><link rel="prefetch" href="/assets/12. 函数式接口.html-gufrKh-D.js" as="script"><link rel="prefetch" href="/assets/13. 方法引用.html-puDsjEnf.js" as="script"><link rel="prefetch" href="/assets/14. Stream流.html-WR_G__ve.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-AohfHd7k.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-i-8Q4caZ.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-n3TJrGrk.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-Zzq4gVZM.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-5ejTd2ic.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-5_CchCJp.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-R6juoHdG.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-W8k_ECAS.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-AU_jAngx.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-LdL_SQmu.js" as="script"><link rel="prefetch" href="/assets/index.html-ucP6o2IT.js" as="script"><link rel="prefetch" href="/assets/index.html-2MhmdDQX.js" as="script"><link rel="prefetch" href="/assets/index.html-X2fYQvTj.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-sq3YVWus.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-VR6lZFtz.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-RGJjdwQh.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-hdLJYGFh.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-ez6QjtFT.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-aY78OIi0.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-WE_rN9ZK.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-mYapdEoN.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-0RQxXkuv.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-ABxcJ7cu.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-7ppVsmmS.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-Roq_QAd0.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-dEPd7Bj8.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-iMiP5y_v.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-oxWCPuLx.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-0j1ikwu_.js" as="script"><link rel="prefetch" href="/assets/1.scss基础.html-bktT6whe.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-a-ONdAcq.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-YhcD6uuk.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-yrmXCdX1.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-5A9QMqsA.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-Uyyq0Myl.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-wo2_TiBt.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-kiHpDLJK.js" as="script"><link rel="prefetch" href="/assets/1.html.html-BaReecr0.js" as="script"><link rel="prefetch" href="/assets/2.css.html-NSvnsBUV.js" as="script"><link rel="prefetch" href="/assets/3.mobile.html-U6zvLpVW.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html--SOONUHt.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-FQQc_-QY.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-1nwi_H55.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-igbLVeJI.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-42fbq1hg.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html-it2n4o2q.js" as="script"><link rel="prefetch" href="/assets/index.html-PUQrwqCd.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-2l9GvRRA.js" as="script"><link rel="prefetch" href="/assets/01. Vue3入门.html-XOeypHFg.js" as="script"><link rel="prefetch" href="/assets/02. Pinia入门.html-DZSQsijU.js" as="script"><link rel="prefetch" href="/assets/03. 项目起步.html--x-_XaJg.js" as="script"><link rel="prefetch" href="/assets/04. Layout页.html-hrx_8W2t.js" as="script"><link rel="prefetch" href="/assets/05. Home页.html-UOrxMLE0.js" as="script"><link rel="prefetch" href="/assets/06. 一级分类页.html-m2xv6t2q.js" as="script"><link rel="prefetch" href="/assets/07. 二级分类页.html-r8RR2ITi.js" as="script"><link rel="prefetch" href="/assets/08. 商品详情.html-zlvprx8n.js" as="script"><link rel="prefetch" href="/assets/09. 登录页.html-p7cmBJo0.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-9ILNJFcN.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-IqHerk8C.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-CRBRFMVT.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-1UxN9lZo.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-wAepb6-t.js" as="script"><link rel="prefetch" href="/assets/00. uni-app前置知识.html-lPGkhzp9.js" as="script"><link rel="prefetch" href="/assets/01. 项目起步.html-fvqway8x.js" as="script"><link rel="prefetch" href="/assets/02. 首页模块.html-2tGwuO6c.js" as="script"><link rel="prefetch" href="/assets/03. 推荐模块.html-PaJKwB0A.js" as="script"><link rel="prefetch" href="/assets/04. 分类模块.html-kpiojz5x.js" as="script"><link rel="prefetch" href="/assets/05. 详情模块.html-KLCB7l-g.js" as="script"><link rel="prefetch" href="/assets/06. 登录模块.html-sV71prGb.js" as="script"><link rel="prefetch" href="/assets/07. 用户模块.html-RIHBWa-U.js" as="script"><link rel="prefetch" href="/assets/08. 地址模块.html-NCf3dpgV.js" as="script"><link rel="prefetch" href="/assets/09. SKU模块.html-KF_uziMk.js" as="script"><link rel="prefetch" href="/assets/10. 购物车模块.html-4g2XrI0I.js" as="script"><link rel="prefetch" href="/assets/11. 订单模块.html-KrwEaVMK.js" as="script"><link rel="prefetch" href="/assets/12. 项目打包.html-ahR9zRQW.js" as="script"><link rel="prefetch" href="/assets/index.html-sSU7GKD6.js" as="script"><link rel="prefetch" href="/assets/index.html-bDsdzjOB.js" as="script"><link rel="prefetch" href="/assets/index.html-JdLOM6cD.js" as="script"><link rel="prefetch" href="/assets/index.html-_HlUve9c.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-k4n-ze4N.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-vSzjMVLc.js" as="script"><link rel="prefetch" href="/assets/index.html-gokmvgNN.js" as="script"><link rel="prefetch" href="/assets/index.html-2KG1l7Xi.js" as="script"><link rel="prefetch" href="/assets/learn.html-pK6VNcSL.js" as="script"><link rel="prefetch" href="/assets/404.html-6aV2Km_R.js" as="script"><link rel="prefetch" href="/assets/index.html-Ahfkg7Pq.js" as="script"><link rel="prefetch" href="/assets/index.html-GLI__Pcy.js" as="script"><link rel="prefetch" href="/assets/index.html-wnvY1Q9W.js" as="script"><link rel="prefetch" href="/assets/index.html-GhTV7t5h.js" as="script"><link rel="prefetch" href="/assets/index.html-XoKMP5g9.js" as="script"><link rel="prefetch" href="/assets/index.html-821wpM3U.js" as="script"><link rel="prefetch" href="/assets/index.html-ONtIfdmb.js" as="script"><link rel="prefetch" href="/assets/index.html-SIbtgosM.js" as="script"><link rel="prefetch" href="/assets/index.html-U3Eb_DDZ.js" as="script"><link rel="prefetch" href="/assets/index.html-iwFQ5hr2.js" as="script"><link rel="prefetch" href="/assets/index.html-5kp-ypyC.js" as="script"><link rel="prefetch" href="/assets/index.html-M1-YXrN3.js" as="script"><link rel="prefetch" href="/assets/index.html-P-SCHh7k.js" as="script"><link rel="prefetch" href="/assets/index.html-tOt8WSzy.js" as="script"><link rel="prefetch" href="/assets/index.html-Jl98LnXj.js" as="script"><link rel="prefetch" href="/assets/index.html-VZUQyzx_.js" as="script"><link rel="prefetch" href="/assets/index.html-lkltdDTs.js" as="script"><link rel="prefetch" href="/assets/index.html-jfwkMbDU.js" as="script"><link rel="prefetch" href="/assets/index.html-aq9mt2xH.js" as="script"><link rel="prefetch" href="/assets/index.html-6DS22mGM.js" as="script"><link rel="prefetch" href="/assets/index.html-yqYJIM7h.js" as="script"><link rel="prefetch" href="/assets/index.html-Y2OISR-y.js" as="script"><link rel="prefetch" href="/assets/index.html-dugDlBPF.js" as="script"><link rel="prefetch" href="/assets/index.html-B7atuRkp.js" as="script"><link rel="prefetch" href="/assets/index.html-U-zDBm_-.js" as="script"><link rel="prefetch" href="/assets/index.html-DC2SLhEc.js" as="script"><link rel="prefetch" href="/assets/index.html-cEXQ3ClK.js" as="script"><link rel="prefetch" href="/assets/index.html-fu4lT4jf.js" as="script"><link rel="prefetch" href="/assets/index.html-QOi6Q6Cn.js" as="script"><link rel="prefetch" href="/assets/index.html-Mth94uvp.js" as="script"><link rel="prefetch" href="/assets/index.html-Ur1vhStF.js" as="script"><link rel="prefetch" href="/assets/index.html-EuMGmQRA.js" as="script"><link rel="prefetch" href="/assets/index.html-UZRldPsF.js" as="script"><link rel="prefetch" href="/assets/index.html-ZuVV15X9.js" as="script"><link rel="prefetch" href="/assets/index.html-AvuZfipD.js" as="script"><link rel="prefetch" href="/assets/index.html-X3ZREQNk.js" as="script"><link rel="prefetch" href="/assets/index.html-w2hqq4J2.js" as="script"><link rel="prefetch" href="/assets/index.html-6D0HOfav.js" as="script"><link rel="prefetch" href="/assets/index.html-q8kXavbM.js" as="script"><link rel="prefetch" href="/assets/index.html-zgVmmyCU.js" as="script"><link rel="prefetch" href="/assets/index.html-lhT9DzM0.js" as="script"><link rel="prefetch" href="/assets/index.html-Q00I84Z0.js" as="script"><link rel="prefetch" href="/assets/index.html-zxRfarDF.js" as="script"><link rel="prefetch" href="/assets/index.html-S9I6SFg8.js" as="script"><link rel="prefetch" href="/assets/index.html-pyETvKoy.js" as="script"><link rel="prefetch" href="/assets/index.html-qGcm8KBX.js" as="script"><link rel="prefetch" href="/assets/index.html-K_izoJh5.js" as="script"><link rel="prefetch" href="/assets/index.html-RVMxfcDq.js" as="script"><link rel="prefetch" href="/assets/index.html-gr7iB-0Y.js" as="script"><link rel="prefetch" href="/assets/index.html-3mq0fdcQ.js" as="script"><link rel="prefetch" href="/assets/index.html-iocJUBOj.js" as="script"><link rel="prefetch" href="/assets/index.html-NDAlH1zA.js" as="script"><link rel="prefetch" href="/assets/waline-meta-w40geAFS.js" as="script"><link rel="prefetch" href="/assets/component-osShNRyB.js" as="script"><link rel="prefetch" href="/assets/vue-repl-wAAVGaG8.js" as="script"><link rel="prefetch" href="/assets/codemirror-editor-9AKw0UkL.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-i2ohwMnJ.js" as="script"><link rel="prefetch" href="/assets/index-7SG8bi1h.js" as="script"><link rel="prefetch" href="/assets/pageview-9a676BYz.js" as="script"><link rel="prefetch" href="/assets/SearchResult-J8yaxgx-.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" aria-hidden><!----><span class="vp-site-name hide-in-pad">apzs</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="博客主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>html&amp;css</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="html基础" class="vp-link nav-link nav-link" href="/front-base/html_css/1.html.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>html基础<!----></a></li><li class="dropdown-subitem"><a aria-label="css基础" class="vp-link nav-link nav-link" href="/front-base/html_css/2.css.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>css基础<!----></a></li><li class="dropdown-subitem"><a aria-label="移动端布局" class="vp-link nav-link nav-link" href="/front-base/html_css/3.mobile.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>移动端布局<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>js</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="js基础" class="vp-link nav-link nav-link" href="/front-base/js/1.JS%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js基础<!----></a></li><li class="dropdown-subitem"><a aria-label="WebApi" class="vp-link nav-link nav-link" href="/front-base/js/2.WebApi%EF%BC%88BOM%E5%92%8CDOM%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>WebApi<!----></a></li><li class="dropdown-subitem"><a aria-label="Ajax" class="vp-link nav-link nav-link" href="/front-base/js/3.Ajax.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Ajax<!----></a></li><li class="dropdown-subitem"><a aria-label="js高级" class="vp-link nav-link nav-link" href="/front-base/js/4.js%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js高级<!----></a></li><li class="dropdown-subitem"><a aria-label="ECMAScript6" class="vp-link nav-link nav-link" href="/front-base/js/5.ECMAScript6.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ECMAScript6<!----></a></li><li class="dropdown-subitem"><a aria-label="Promise" class="vp-link nav-link nav-link" href="/front-base/js/6.Promise.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Promise<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>前置知识</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="npm基本使用" class="vp-link nav-link nav-link" href="/front-advance/npm/1.npm%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>npm基本使用<!----></a></li><li class="dropdown-subitem"><a aria-label="scss" class="vp-link nav-link nav-link" href="/front-advance/scss/1.scss%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>scss<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>vue</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="vue2" class="vp-link nav-link nav-link" href="/front-advance/vue/1.vue2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue2<!----></a></li><li class="dropdown-subitem"><a aria-label="vue3" class="vp-link nav-link nav-link" href="/front-advance/vue/2.vue3.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue3<!----></a></li><li class="dropdown-subitem"><a aria-label="创建vue项目的几种方式" class="vp-link nav-link nav-link" href="/front-advance/vue/3.%E5%88%9B%E5%BB%BAvue%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>创建vue项目的几种方式<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>react</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="react入门" class="vp-link nav-link nav-link" href="/front-advance/react/01%20%E3%80%90react%E5%85%A5%E9%97%A8%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react入门<!----></a></li><li class="dropdown-subitem"><a aria-label="react脚手架" class="vp-link nav-link nav-link" href="/front-advance/react/02%20%E3%80%90react%E8%84%9A%E6%89%8B%E6%9E%B6%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react脚手架<!----></a></li><li class="dropdown-subitem"><a aria-label="路由" class="vp-link nav-link nav-link" href="/front-advance/react/03%20%E3%80%90%E8%B7%AF%E7%94%B1%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>路由<!----></a></li><li class="dropdown-subitem"><a aria-label="redux" class="vp-link nav-link nav-link" href="/front-advance/react/05%20%E3%80%90redux%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redux<!----></a></li><li class="dropdown-subitem"><a aria-label="hooks" class="vp-link nav-link nav-link" href="/front-advance/react/06%20%E3%80%90hooks%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>hooks<!----></a></li><li class="dropdown-subitem"><a aria-label="react高级" class="vp-link nav-link nav-link" href="/front-advance/react/07%20%E3%80%90react%E9%AB%98%E7%BA%A7%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react高级<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>webpack</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="基础" class="vp-link nav-link nav-link" href="/front-advance/webpack/1.%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>基础<!----></a></li><li class="dropdown-subitem"><a aria-label="高级" class="vp-link nav-link nav-link" href="/front-advance/webpack/2.%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>高级<!----></a></li><li class="dropdown-subitem"><a aria-label="项目配置" class="vp-link nav-link nav-link" href="/front-advance/webpack/3.%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>项目配置<!----></a></li><li class="dropdown-subitem"><a aria-label="原理分析" class="vp-link nav-link nav-link" href="/front-advance/webpack/4.%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>原理分析<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端项目"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>前端项目</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="小兔鲜PC (Vue3+Pinia+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%8F%E5%85%94%E9%B2%9CPC%20(Vue3_Pinia_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜PC (Vue3+Pinia+js)<!----></a></li><li class="dropdown-item"><a aria-label="小兔鲜儿uni-app (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%8F%E5%85%94%E9%B2%9C%E5%84%BFuni-app%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜儿uni-app (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="尚品汇 (Vue2+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%9A%E5%93%81%E6%B1%87%20(Vue2_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>尚品汇 (Vue2+js)<!----></a></li><li class="dropdown-item"><a aria-label="硅谷甄选 (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E7%A1%85%E8%B0%B7%E7%94%84%E9%80%89%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>硅谷甄选 (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="个人博客搭建教程" class="vp-link nav-link nav-link" href="/front-project/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>个人博客搭建教程<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="Java基础语法" class="vp-link nav-link nav-link" href="/back-base/1.Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java基础语法<!----></a></li><li class="dropdown-item"><a aria-label="Java核心" class="vp-link nav-link nav-link" href="/back-base/2.Java%E6%A0%B8%E5%BF%83/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java核心<!----></a></li><li class="dropdown-item"><a aria-label="JavaWeb" class="vp-link nav-link nav-link" href="/back-base/3.JavaWeb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>JavaWeb<!----></a></li><li class="dropdown-item"><a aria-label="mysql" class="vp-link nav-link nav-link" href="/back-base/4.mysql/MySQL.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mysql<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SSM" class="vp-link nav-link nav-link" href="/back-advance/5.SSM/SSM%E7%AC%94%E8%AE%B0.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SSM<!----></a></li><li class="dropdown-item"><a aria-label="redis" class="vp-link nav-link nav-link" href="/back-advance/6.redis/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redis<!----></a></li><li class="dropdown-item"><a aria-label="SpringBoot" class="vp-link nav-link nav-link" href="/back-advance/7.SpringBoot2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringBoot<!----></a></li><li class="dropdown-item"><a aria-label="git" class="vp-link nav-link nav-link" href="/back-advance/9.git/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>git<!----></a></li><li class="dropdown-item"><a aria-label="nginx" class="vp-link nav-link nav-link" href="/back-advance/10.nginx.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>nginx<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端高级"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端高级</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="docker" class="vp-link nav-link nav-link" href="/back-senior/11.docker/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>docker<!----></a></li><li class="dropdown-item"><a aria-label="gitlab+jeckins" class="vp-link nav-link nav-link" href="/back-senior/12.gitlab_jeckins/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>gitlab+jeckins<!----></a></li><li class="dropdown-item"><a aria-label="SpringSecurity" class="vp-link nav-link nav-link" href="/back-senior/13.SpringSecurity/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringSecurity<!----></a></li><li class="dropdown-item"><a aria-label="Netty" class="vp-link nav-link nav-link" href="/back-senior/14.Netty.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Netty<!----></a></li><li class="dropdown-item"><a aria-label="arthas" class="vp-link nav-link nav-link" href="/back-senior/15.arthas.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>arthas<!----></a></li><li class="dropdown-item"><a aria-label="ShardingSphere5" class="vp-link nav-link nav-link" href="/back-senior/16.ShardingSphere5.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ShardingSphere5<!----></a></li><li class="dropdown-item"><a aria-label="mongodb" class="vp-link nav-link nav-link" href="/back-senior/17.mongodb/mongodb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mongodb<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="谷粒商城"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>谷粒商城</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>基础篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="前后端环境搭建" class="vp-link nav-link nav-link" href="/gulimall/base1.html"><!---->前后端环境搭建<!----></a></li><li class="dropdown-subitem"><a aria-label="前后端联调" class="vp-link nav-link nav-link" href="/gulimall/base2.html"><!---->前后端联调<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>高级篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Elasticsearch &amp; nginx" class="vp-link nav-link nav-link" href="/gulimall/advanced1.html"><!---->Elasticsearch &amp; nginx<!----></a></li><li class="dropdown-subitem"><a aria-label="Redisson &amp; SpringCache" class="vp-link nav-link nav-link" href="/gulimall/advanced2.html"><!---->Redisson &amp; SpringCache<!----></a></li><li class="dropdown-subitem"><a aria-label="CompletableFuture" class="vp-link nav-link nav-link" href="/gulimall/advanced3.html"><!---->CompletableFuture<!----></a></li><li class="dropdown-subitem"><a aria-label="Spring Session &amp; OAuth2.0" class="vp-link nav-link nav-link" href="/gulimall/advanced4.html"><!---->Spring Session &amp; OAuth2.0<!----></a></li><li class="dropdown-subitem"><a aria-label="RabbitMQ &amp; Seata" class="vp-link nav-link nav-link" href="/gulimall/advanced5.html"><!---->RabbitMQ &amp; Seata<!----></a></li><li class="dropdown-subitem"><a aria-label="支付 &amp; Sentinel" class="vp-link nav-link active nav-link active" href="/gulimall/advanced6.html"><!---->支付 &amp; Sentinel<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>集群篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="K8s &amp; kubesphere" class="vp-link nav-link nav-link" href="/gulimall/cluster.html"><!---->K8s &amp; kubesphere<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="常用功能"><span class="title"><!---->常用功能</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SpringBoot相关" class="vp-link nav-link nav-link" href="/CommonFunctions/1.SpringBoot.html"><!---->SpringBoot相关<!----></a></li><li class="dropdown-item"><a aria-label="mysql相关" class="vp-link nav-link nav-link" href="/CommonFunctions/2.mysql.html"><!---->mysql相关<!----></a></li><li class="dropdown-item"><a aria-label="docker相关" class="vp-link nav-link nav-link" href="/CommonFunctions/3.docker.html"><!---->docker相关<!----></a></li><li class="dropdown-item"><a aria-label="maven相关" class="vp-link nav-link nav-link" href="/CommonFunctions/4.maven.html"><!---->maven相关<!----></a></li><li class="dropdown-item"><a aria-label="linux相关" class="vp-link nav-link nav-link" href="/CommonFunctions/5.linux.html"><!---->linux相关<!----></a></li><li class="dropdown-item"><a aria-label="windows相关" class="vp-link nav-link nav-link" href="/CommonFunctions/6.windows.html"><!---->windows相关<!----></a></li><li class="dropdown-item"><a aria-label="git相关" class="vp-link nav-link nav-link" href="/CommonFunctions/7.git.html"><!---->git相关<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="阅读源码"><span class="title"><!---->阅读源码</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="搭建SpringBoot源码环境" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/"><!---->搭建SpringBoot源码环境<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot自动配置 &amp; 请求处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%20_%20%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86.html"><!---->SpringBoot自动配置 &amp; 请求处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot异常处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/2.%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"><!---->SpringBoot异常处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/"><!---->SpringSecurity源码阅读<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity基础知识" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/learn.html"><!---->SpringSecurity基础知识<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Tomcat</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Tomcat源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/tomcat.html"><!---->Tomcat源码阅读<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Mybatis</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="MyBatis源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/mybatis/"><!---->MyBatis源码阅读<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/apzs/apzs.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="6.3.1、支付" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced6.html#_6-3-1、支付"><!---->6.3.1、支付<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="6.3.2、完善支付功能" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced6.html#_6-3-2、完善支付功能"><!---->6.3.2、完善支付功能<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="7.1、秒杀" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced6.html#_7-1、秒杀"><!---->7.1、秒杀<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="7.1.1、新增秒杀场次" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-1-1、新增秒杀场次"><!---->7.1.1、新增秒杀场次<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.1.2、秒杀模块" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-1-2、秒杀模块"><!---->7.1.2、秒杀模块<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.1.3、分布式信号量" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-1-3、分布式信号量"><!---->7.1.3、分布式信号量<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="4、测试" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_4、测试-1"><!---->4、测试<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.1.4、显示秒杀商品" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-1-4、显示秒杀商品"><!---->7.1.4、显示秒杀商品<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.1.5、商品页面添加秒杀提醒" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-1-5、商品页面添加秒杀提醒"><!---->7.1.5、商品页面添加秒杀提醒<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="7.2、SpringCloud Alibaba-Sentinel" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced6.html#_7-2、springcloud-alibaba-sentinel"><!---->7.2、SpringCloud Alibaba-Sentinel<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="7.2.1、简介" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-2-1、简介"><!---->7.2.1、简介<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.2.2、整合Sentinel" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-2-2、整合sentinel"><!---->7.2.2、整合Sentinel<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.2.3、Sentinel开启feign链路追踪" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-2-3、sentinel开启feign链路追踪"><!---->7.2.3、Sentinel开启feign链路追踪<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.2.4、自定义受保护资源" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-2-4、自定义受保护资源"><!---->7.2.4、自定义受保护资源<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="7.3、Sleuth+Zipkin 服务链路追踪" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced6.html#_7-3、sleuth-zipkin-服务链路追踪"><!---->7.3、Sleuth+Zipkin 服务链路追踪<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="7.3.1、概述" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-3-1、概述"><!---->7.3.1、概述<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.3.2、整合 Sleuth" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-3-2、整合-sleuth"><!---->7.3.2、整合 Sleuth<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="7.3.3、整合 zipkin 可视化观察" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced6.html#_7-3-3、整合-zipkin-可视化观察"><!---->7.3.3、整合 zipkin 可视化观察<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="高级篇总结" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced6.html#高级篇总结"><!---->高级篇总结<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->6.3、支付商品</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://apzs.eu.org" target="_blank" rel="noopener noreferrer">apzs</a></span><span property="author" content="apzs"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-05T06:05:15.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/gulimall/advanced6.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 125 分钟</span><meta property="timeRequired" content="PT125M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-3-1、支付">6.3.1、支付</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-3-2、完善支付功能">6.3.2、完善支付功能</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_7-1、秒杀">7.1、秒杀</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-1-1、新增秒杀场次">7.1.1、新增秒杀场次</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-1-2、秒杀模块">7.1.2、秒杀模块</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-1-3、分布式信号量">7.1.3、分布式信号量</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_4、测试-1">4、测试</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-1-4、显示秒杀商品">7.1.4、显示秒杀商品</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-1-5、商品页面添加秒杀提醒">7.1.5、商品页面添加秒杀提醒</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_7-2、springcloud-alibaba-sentinel">7.2、SpringCloud Alibaba-Sentinel</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-2-1、简介">7.2.1、简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-2-2、整合sentinel">7.2.2、整合Sentinel</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-2-3、sentinel开启feign链路追踪">7.2.3、Sentinel开启feign链路追踪</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-2-4、自定义受保护资源">7.2.4、自定义受保护资源</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_7-3、sleuth-zipkin-服务链路追踪">7.3、Sleuth+Zipkin 服务链路追踪</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-3-1、概述">7.3.1、概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-3-2、整合-sleuth">7.3.2、整合 Sleuth</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_7-3-3、整合-zipkin-可视化观察">7.3.3、整合 zipkin 可视化观察</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#高级篇总结">高级篇总结</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="_6-3、支付商品" tabindex="-1"><a class="header-anchor" href="#_6-3、支付商品" aria-hidden="true">#</a> 6.3、支付商品</h1><h3 id="_6-3-1、支付" tabindex="-1"><a class="header-anchor" href="#_6-3-1、支付" aria-hidden="true">#</a> 6.3.1、支付</h3><h4 id="_1、相关概念" tabindex="-1"><a class="header-anchor" href="#_1、相关概念" aria-hidden="true">#</a> 1、相关概念</h4><h5 id="_1、文档" tabindex="-1"><a class="header-anchor" href="#_1、文档" aria-hidden="true">#</a> 1、文档</h5><p>支付宝电脑网站解锁</p><p>文档链接：https://opendocs.alipay.com/open/270/105898?ref=api</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.1.1.1.gif" alt="GIF 2022-8-20 15-34-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 15-34-17</figcaption></figure><p>文档链接2：https://opendocs.alipay.com/open/270/105898</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.1.1.2.gif" alt="GIF 2022-8-20 15-36-49" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 15-36-49</figcaption></figure><p>网址： https://open.alipay.com/develop/pm/create</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.1.1.3.gif" alt="GIF 2022-8-20 15-42-24" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 15-42-24</figcaption></figure><h5 id="_2、对称秘钥" tabindex="-1"><a class="header-anchor" href="#_2、对称秘钥" aria-hidden="true">#</a> 2、对称秘钥</h5><p><strong>加密-对称加密</strong></p><p>发送方和接收方都拥有同样的秘钥，当发送方想要发送消息时，使用秘钥将明文进行加密，在网络中传输加密后的密文数据，接收方收到密文数据后使用相同的秘钥进行解密</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.1.2.png" alt="image-20220820160519647" tabindex="0" loading="lazy"><figcaption>image-20220820160519647</figcaption></figure><p><code>DES</code>、<code>3DES</code>（<code>TripleDES</code>）、<code>AES</code>、<code>RC2</code>、<code>RC4</code>、<code>RC5</code>和<code>Blowfish</code>等，加密解密使用同一把钥匙</p><h5 id="_3、非对称秘钥" tabindex="-1"><a class="header-anchor" href="#_3、非对称秘钥" aria-hidden="true">#</a> 3、非对称秘钥</h5><p><strong>加密-非对称加密</strong></p><p>非对称加密的公钥都是公开的，只有自己拥有属于自己的秘钥，当发送方想要发送消息时，使用接收方的公钥进行加密（只有接收方的秘钥才能解开使用接收方的公钥加密的密文），在网络中传输加密后的数据，当接收方接收到消息时，使用接收方自己的秘钥进行解密。同理，当接收方想要发送消息时，使用发送方的公钥进行加密（只有发送方的秘钥才能解开使用发送方的公钥加密的密文），在网络中传输加密后的数据，当发送方接收到消息时，使用发送方自己的秘钥进行解密。（即想要发送数据给谁，就是用对方的公钥进行加密，对方收到数据后，可以通过对方的秘钥进行解密）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.1.3.png" alt="image-20220820160600084" tabindex="0" loading="lazy"><figcaption>image-20220820160600084</figcaption></figure><p><code>RSA</code>、<code>Elgamal</code>等，加密解密使用不同钥匙</p><h4 id="_2、支付宝支付" tabindex="-1"><a class="header-anchor" href="#_2、支付宝支付" aria-hidden="true">#</a> 2、支付宝支付</h4><h5 id="_1、电脑网站支付产品介绍" tabindex="-1"><a class="header-anchor" href="#_1、电脑网站支付产品介绍" aria-hidden="true">#</a> 1、电脑网站支付产品介绍</h5><p>电脑网站支付产品介绍: https://opendocs.alipay.com/open/270</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.2.1.png" alt="image-20220820162411417" tabindex="0" loading="lazy"><figcaption>image-20220820162411417</figcaption></figure><h5 id="_2、sdk-demo" tabindex="-1"><a class="header-anchor" href="#_2、sdk-demo" aria-hidden="true">#</a> 2、SDK &amp; Demo</h5><p>下载demo: https://opendocs.alipay.com/open/270/106291</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.2.2.png" alt="image-20220820162414669" tabindex="0" loading="lazy"><figcaption>image-20220820162414669</figcaption></figure><h5 id="_3、配置使用沙箱进行测试" tabindex="-1"><a class="header-anchor" href="#_3、配置使用沙箱进行测试" aria-hidden="true">#</a> 3、配置使用沙箱进行测试</h5><p>1、使用 RSA 工具生成签名 2、下载沙箱版钱包 3、运行官方 demo 进行测试</p><h5 id="_4、公钥-私钥" tabindex="-1"><a class="header-anchor" href="#_4、公钥-私钥" aria-hidden="true">#</a> 4、公钥 &amp; 私钥</h5><p>什么是公钥、私钥、加密、签名和验签？</p><p>1、公钥私钥 公钥和私钥是一个相对概念 它们的公私性是相对于生成者来说的。 一对密钥生成后，保存在生成者手里的就是私钥， 生成者发布出去大家用的就是公钥</p><h5 id="_5、加密-数字签名" tabindex="-1"><a class="header-anchor" href="#_5、加密-数字签名" aria-hidden="true">#</a> 5、加密 &amp; 数字签名</h5><p>加密和数字签名概念 加密：</p><ul><li>我们使用一对公私钥中的一个密钥来对数据进行加密，而使用另一个密钥来进行解密的技术。</li><li>公钥和私钥都可以用来加密，也都可以用来解密。</li><li>但这个加解密必须是一对密钥之间的互相加解密，否则不能成功。</li><li>加密的目的是： 为了确保数据传输过程中的不可读性，就是不想让别人看到。</li></ul><p>签名：</p><ul><li>给我们将要发送的数据，做上一个唯一签名（类似于指纹）</li><li>用来互相验证接收方和发送方的身份；</li><li>在验证身份的基础上再验证一下传递的数据是否被篡改过。因此使用数字签名可以用来达到数据的明文传输。</li></ul><p>验签</p><ul><li>支付宝为了验证请求的数据是否商户本人发的</li><li>商户为了验证响应的数据是否支付宝发的</li></ul><p>签名是先计算哈希值然后用私钥加密，私钥对外不公开所以不能自己生成签名（下面这个图应该有问题，商户给支付宝发消息应该使用支付宝的公钥进行加密，支付宝收到消息后使用支付宝自己的私钥进行解密；支付宝业务处理完成后，使用商户的公钥对消息进行加密，商户收到消息后使用商户自己的私钥进行解密）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.2.5.png" alt="image-20220820163916589" tabindex="0" loading="lazy"><figcaption>image-20220820163916589</figcaption></figure><h4 id="_3、使用支付宝提供的demo" tabindex="-1"><a class="header-anchor" href="#_3、使用支付宝提供的demo" aria-hidden="true">#</a> 3、使用支付宝提供的demo</h4><h5 id="_1、开启沙箱" tabindex="-1"><a class="header-anchor" href="#_1、开启沙箱" aria-hidden="true">#</a> 1、开启沙箱</h5><p>在 https://open.alipay.com/develop/sandbox/app 页面里开启沙箱 ，开启沙箱后，在<code>开放平台控制台</code> -&gt; <code>沙箱</code> -&gt; <code>控制台</code> -&gt;<code>网页/移动应用</code> -&gt; <code>应用信息</code> -&gt; <code>开发信息</code> 在<code>接口加签方式</code>里选择<code>系统默认秘钥</code>，点击<code>公钥模式</code>右边<code>启用</code>按钮，然后点击<code>查看</code>，即可看到<code>应用公钥</code>、<code>应用私钥</code>、<code>支付宝公钥</code>信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.1.1.gif" alt="GIF 2022-8-20 16-57-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 16-57-39</figcaption></figure><p>在<code>开放平台控制台</code> -&gt; <code>沙箱</code> -&gt; <code>控制台</code> -&gt;<code>网页/移动应用</code> -&gt; <code>应用信息</code> -&gt; <code>基本信息</code> 里复制<code>APPID</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.1.2.png" alt="image-20220820170302186" tabindex="0" loading="lazy"><figcaption>image-20220820170302186</figcaption></figure><h5 id="_2、调试demo" tabindex="-1"><a class="header-anchor" href="#_2、调试demo" aria-hidden="true">#</a> 2、调试demo</h5><p>在 https://opendocs.alipay.com/open/270/106291 页面里下载<code>demo</code>后使用<code>eclipse</code>打开，我这里使用的软件是<code>Spring Tools 4 for Eclipse</code>，粘贴刚刚复制的<code>APPID</code>到<code>com.alipay.config.AlipayConfig</code>的<code>app_id</code>字段里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.1.png" alt="image-20220820170911893" tabindex="0" loading="lazy"><figcaption>image-20220820170911893</figcaption></figure><p>点击<code>控制台</code> -&gt;<code>网页/移动应用</code> -&gt; <code>应用信息</code> -&gt; <code>开发信息</code> -&gt; <code>接口加签方式</code>里选择<code>系统默认秘钥</code>，点击<code>公钥模式</code>的<code>查看</code>按钮，点击<code>应用私钥</code>里的<code>复制私钥</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.2.png" alt="image-20220820170940656" tabindex="0" loading="lazy"><figcaption>image-20220820170940656</figcaption></figure><p>粘贴刚刚复制的<code>应用私钥</code>到<code>com.alipay.config.AlipayConfig</code>类的<code>merchant_private_key</code>字段里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.3.png" alt="image-20220820171012120" tabindex="0" loading="lazy"><figcaption>image-20220820171012120</figcaption></figure><p>点击<code>控制台</code> -&gt;<code>网页/移动应用</code> -&gt; <code>应用信息</code> -&gt; <code>开发信息</code> -&gt; <code>接口加签方式</code>里选择<code>系统默认秘钥</code>，点击<code>公钥模式</code>的<code>查看</code>按钮，点击<code>支付宝公钥</code>的<code>复制公钥</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.4.png" alt="image-20220820171050458" tabindex="0" loading="lazy"><figcaption>image-20220820171050458</figcaption></figure><p>粘贴刚刚复制的<code>支付宝公钥</code>到<code>com.alipay.config.AlipayConfig</code>类的<code>alipay_public_key</code>字段里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.5.png" alt="image-20220820171045983" tabindex="0" loading="lazy"><figcaption>image-20220820171045983</figcaption></figure><p>在<code>开放平台控制台</code> -&gt; <code>沙箱</code> -&gt; <code>控制台</code> -&gt;<code>网页/移动应用</code> -&gt; <code>应用信息</code> -&gt; <code>开发信息</code> 里复制<code>支付宝网关地址</code>的值</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.6.png" alt="image-20220820171327453" tabindex="0" loading="lazy"><figcaption>image-20220820171327453</figcaption></figure><p>粘贴刚刚复制的<code>支付宝网关地址</code>到<code>com.alipay.config.AlipayConfig</code>类的<code>gatewayUrl</code>字段里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.2.7.png" alt="image-20220820171323382" tabindex="0" loading="lazy"><figcaption>image-20220820171323382</figcaption></figure><h5 id="_3、测试" tabindex="-1"><a class="header-anchor" href="#_3、测试" aria-hidden="true">#</a> 3、测试</h5><p>运行demo项目，访问 http://localhost:8080/alipay.trade.page.pay-JAVA-UTF-8 页面，点demo里的<code>付款</code>按钮，然后使用沙箱提供的<code>沙箱账号</code>的<code>买家信息</code>的<code>买家账号</code>去支付，可以看到能够支付成功，但是支付成功的回调url如果要是用户访问的话必须是公网可以访问的。（即支付宝在公网上能够访问的接口）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.3.gif" alt="GIF 2022-8-20 19-03-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 19-03-14</figcaption></figure><h5 id="_4、再次测试" tabindex="-1"><a class="header-anchor" href="#_4、再次测试" aria-hidden="true">#</a> 4、再次测试</h5><p>修改<code>com.alipay.config.AlipayConfig</code>类的<code>notify_url</code>字段和<code>return_url</code>字段，将地址改成本地的，这样使用自己电脑可以跳转页面，但是异步通知会访问不到。（异步通知就是支付成功后，支付宝会不断地向该接口发送支付成功的消息，直到我们的接口返回确认收到后，支付宝才停止通知）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.4.1.png" alt="image-20220820190610688" tabindex="0" loading="lazy"><figcaption>image-20220820190610688</figcaption></figure><p>重启项目，支付成功后即可跳转到我们设置的支付成功回调页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.3.4.2.gif" alt="GIF 2022-8-20 19-08-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 19-08-39</figcaption></figure><h4 id="_4、整合支付宝支付" tabindex="-1"><a class="header-anchor" href="#_4、整合支付宝支付" aria-hidden="true">#</a> 4、整合支付宝支付</h4><h5 id="_1、添加依赖" tabindex="-1"><a class="header-anchor" href="#_1、添加依赖" aria-hidden="true">#</a> 1、添加依赖</h5><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件里添加<code>alipay</code>的依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--支付宝的SDK--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alipay-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.9.28.ALL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.1.png" alt="image-20220820194410081" tabindex="0" loading="lazy"><figcaption>image-20220820194410081</figcaption></figure><h5 id="_2、添加代码" tabindex="-1"><a class="header-anchor" href="#_2、添加代码" aria-hidden="true">#</a> 2、添加代码</h5><p>复制<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\支付</code>里的<code>PayVo.java</code>，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayVo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> out_trade_no<span class="token punctuation">;</span> <span class="token comment">// 商户订单号 必填</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> subject<span class="token punctuation">;</span> <span class="token comment">// 订单名称 必填</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> total_amount<span class="token punctuation">;</span>  <span class="token comment">// 付款金额 必填</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> body<span class="token punctuation">;</span> <span class="token comment">// 商品描述 可空</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.2.1.png" alt="image-20220820194630307" tabindex="0" loading="lazy"><figcaption>image-20220820194630307</figcaption></figure><p>复制<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\支付</code>里的<code>AlipayTemplate.java</code>，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包下，修改<code>AlipayTemplate</code>类里导入的<code>PayVo</code>类的路径</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.2.2.png" alt="image-20220820194859881" tabindex="0" loading="lazy"><figcaption>image-20220820194859881</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.AlipayTemplate</code>类里，修改<code>app_id</code>、<code>merchant_private_key</code>、<code>alipay_public_key</code>、<code>gatewayUrl</code>这些字段的值</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.2.3.png" alt="image-20220820205459867" tabindex="0" loading="lazy"><figcaption>image-20220820205459867</figcaption></figure><p>将<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayVo</code>类里的字段修改为小驼峰命名法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayVo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 商户订单号 必填
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> outTradeNo<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 订单名称 必填
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> subject<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 付款金额 必填
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> totalAmount<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 商品描述 可空
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> body<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.2.4.png" alt="image-20220820204732495" tabindex="0" loading="lazy"><figcaption>image-20220820204732495</figcaption></figure><p>修改后的<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayVo</code>类</p><p><a href="code/6.3.1.4.2.java">点击查看完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.2.5.png" alt="image-20220820205600161" tabindex="0" loading="lazy"><figcaption>image-20220820205600161</figcaption></figure><h5 id="_3、不能调用商品服务" tabindex="-1"><a class="header-anchor" href="#_3、不能调用商品服务" aria-hidden="true">#</a> 3、不能调用商品服务</h5><p>重启<code>GulimallOrderApplication</code>服务，测试时发现<code>GulimallCartApplication</code>模块的控制台报<code>不能成功调用gulimall-product</code>服务的错误</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>com.netflix.client.ClientException: Load balancer does not have available server <span class="token keyword">for</span> client: gulimall-product
	at com.netflix.loadbalancer.LoadBalancerContext.getServerFromLoadBalancer<span class="token punctuation">(</span>LoadBalancerContext.java:483<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>ribbon-loadbalancer-2.3.0.jar:2.3.0<span class="token punctuation">]</span>
	at com.netflix.loadbalancer.reactive.LoadBalancerCommand<span class="token variable">$1</span>.call<span class="token punctuation">(</span>LoadBalancerCommand.java:184<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>ribbon-loadbalancer-2.3.0.jar:2.3.0<span class="token punctuation">]</span>
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
	at com.atguigu.gulimall.cart.service.impl.CartServiceImpl.lambda<span class="token variable">$getUserCartItems</span><span class="token variable">$2</span><span class="token punctuation">(</span>CartServiceImpl.java:170<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at java.util.stream.ReferencePipeline<span class="token variable">$3</span><span class="token variable">$1</span>.accept<span class="token punctuation">(</span>ReferencePipeline.java:193<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.stream.ReferencePipeline<span class="token variable">$2</span><span class="token variable">$1</span>.accept<span class="token punctuation">(</span>ReferencePipeline.java:175<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.ArrayList<span class="token variable">$ArrayListSpliterator</span>.forEachRemaining<span class="token punctuation">(</span>ArrayList.java:1384<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.stream.AbstractPipeline.copyInto<span class="token punctuation">(</span>AbstractPipeline.java:482<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.stream.AbstractPipeline.wrapAndCopyInto<span class="token punctuation">(</span>AbstractPipeline.java:472<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.stream.ReduceOps<span class="token variable">$ReduceOp</span>.evaluateSequential<span class="token punctuation">(</span>ReduceOps.java:708<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.stream.AbstractPipeline.evaluate<span class="token punctuation">(</span>AbstractPipeline.java:234<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.stream.ReferencePipeline.collect<span class="token punctuation">(</span>ReferencePipeline.java:499<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at com.atguigu.gulimall.cart.service.impl.CartServiceImpl.getUserCartItems<span class="token punctuation">(</span>CartServiceImpl.java:175<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.cart.controller.CartController.getCurrentUserCartItems<span class="token punctuation">(</span>CartController.java:31<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at sun.reflect.NativeMethodAccessorImpl.invoke0<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.3.1.png" alt="image-20220820201108997" tabindex="0" loading="lazy"><figcaption>image-20220820201108997</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>文件里添加如下配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gulimall<span class="token punctuation">-</span>product
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.3.2.png" alt="image-20220820201455316" tabindex="0" loading="lazy"><figcaption>image-20220820201455316</figcaption></figure><p>改完后，重启<code>GulimallProductApplication</code>服务，这个<code>GulimallCartApplication</code>服务就不报错了，还有很多别的服务之间相互调用都失败了，查看<code>nacos</code>，可以看到这些服务明明都在</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.3.3.png" alt="image-20220820202047005" tabindex="0" loading="lazy"><figcaption>image-20220820202047005</figcaption></figure><p>重启<code>nacos</code>后，发现所有的页面都访问不了，查看网关报了以下错误，重启一下网关就好了，什么奇葩bug</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>java.lang.NullPointerException: null
	at com.alibaba.nacos.client.naming.core.PushReceiver.getUDPPort<span class="token punctuation">(</span>PushReceiver.java:116<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>nacos-client-1.1.1.jar:na<span class="token punctuation">]</span>
	at com.alibaba.nacos.client.naming.core.HostReactor.updateServiceNow<span class="token punctuation">(</span>HostReactor.java:270<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>nacos-client-1.1.1.jar:na<span class="token punctuation">]</span>
	at com.alibaba.nacos.client.naming.core.HostReactor<span class="token variable">$UpdateTask</span>.run<span class="token punctuation">(</span>HostReactor.java:315<span class="token punctuation">)</span> <span class="token punctuation">[</span>nacos-client-1.1.1.jar:na<span class="token punctuation">]</span>
	at java.util.concurrent.Executors<span class="token variable">$RunnableAdapter</span>.call<span class="token punctuation">(</span>Executors.java:511<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.FutureTask.run<span class="token punctuation">(</span>FutureTask.java:266<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="token variable">$ScheduledFutureTask</span>.access<span class="token variable">$201</span><span class="token punctuation">(</span>ScheduledThreadPoolExecutor.java:180<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="token variable">$ScheduledFutureTask</span>.run<span class="token punctuation">(</span>ScheduledThreadPoolExecutor.java:293<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor.runWorker<span class="token punctuation">(</span>ThreadPoolExecutor.java:1149<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor<span class="token variable">$Worker</span>.run<span class="token punctuation">(</span>ThreadPoolExecutor.java:624<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:748<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>

<span class="token number">2022</span>-08-20 <span class="token number">20</span>:22:48.784 ERROR <span class="token number">11596</span> --- <span class="token punctuation">[</span>.naming.updater<span class="token punctuation">]</span> com.alibaba.nacos.client.naming          <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>NA<span class="token punctuation">]</span> failed to update serviceName: DEFAULT_GROUP@@gulimall-order

java.lang.NullPointerException: null
	at com.alibaba.nacos.client.naming.core.PushReceiver.getUDPPort<span class="token punctuation">(</span>PushReceiver.java:116<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>nacos-client-1.1.1.jar:na<span class="token punctuation">]</span>
	at com.alibaba.nacos.client.naming.core.HostReactor.updateServiceNow<span class="token punctuation">(</span>HostReactor.java:270<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>nacos-client-1.1.1.jar:na<span class="token punctuation">]</span>
	at com.alibaba.nacos.client.naming.core.HostReactor<span class="token variable">$UpdateTask</span>.run<span class="token punctuation">(</span>HostReactor.java:315<span class="token punctuation">)</span> <span class="token punctuation">[</span>nacos-client-1.1.1.jar:na<span class="token punctuation">]</span>
	at java.util.concurrent.Executors<span class="token variable">$RunnableAdapter</span>.call<span class="token punctuation">(</span>Executors.java:511<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.FutureTask.run<span class="token punctuation">(</span>FutureTask.java:266<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="token variable">$ScheduledFutureTask</span>.access<span class="token variable">$201</span><span class="token punctuation">(</span>ScheduledThreadPoolExecutor.java:180<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ScheduledThreadPoolExecutor<span class="token variable">$ScheduledFutureTask</span>.run<span class="token punctuation">(</span>ScheduledThreadPoolExecutor.java:293<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor.runWorker<span class="token punctuation">(</span>ThreadPoolExecutor.java:1149<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.util.concurrent.ThreadPoolExecutor<span class="token variable">$Worker</span>.run<span class="token punctuation">(</span>ThreadPoolExecutor.java:624<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:748<span class="token punctuation">)</span> <span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>

<span class="token number">2022</span>-08-20 <span class="token number">20</span>:22:49.034 ERROR <span class="token number">11596</span> --- <span class="token punctuation">[</span>.naming.updater<span class="token punctuation">]</span> com.alibaba.nacos.client.naming          <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>NA<span class="token punctuation">]</span> failed to update serviceName: DEFAULT_GROUP@@gulimall-product
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.3.4.png" alt="image-20220820202557738" tabindex="0" loading="lazy"><figcaption>image-20220820202557738</figcaption></figure><h5 id="_4、不显示真是应付金额" tabindex="-1"><a class="header-anchor" href="#_4、不显示真是应付金额" aria-hidden="true">#</a> 4、不显示真是应付金额</h5><p>登陆后，点击 http://order.gulimall.com/toTrade 页面的<code>提交订单</code>按钮，来到了 http://order.gulimall.com/submitOrder 页面，在这个页面里突然又不显示真实数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.4.1.png" alt="image-20220820203125417" tabindex="0" loading="lazy"><figcaption>image-20220820203125417</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/pay.html</code>页面里搜索<code>订单号</code>，修改相关的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>订单提交成功，请尽快付款！订单号：[[${submitOrderResp.order.orderSn}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>应付金额<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span><span class="token punctuation">&gt;</span></span>[[${#numbers.formatDecimal(submitOrderResp.order.payAmount,1,2)}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span>元<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.4.2.png" alt="image-20220820203242820" tabindex="0" loading="lazy"><figcaption>image-20220820203242820</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，在 http://order.gulimall.com/submitOrder 页面里刷新一下，现在成功显示了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.4.4.3.png" alt="image-20220820203427654" tabindex="0" loading="lazy"><figcaption>image-20220820203427654</figcaption></figure><h4 id="_5、添加支付逻辑" tabindex="-1"><a class="header-anchor" href="#_5、添加支付逻辑" aria-hidden="true">#</a> 5、添加支付逻辑</h4><h5 id="_1、修改页面" tabindex="-1"><a class="header-anchor" href="#_1、修改页面" aria-hidden="true">#</a> 1、修改页面</h5><p>在 http://order.gulimall.com/submitOrder 页面里，打开控制台，定位到<code>支付宝</code>图标，复制<code>支付宝</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.1.1.png" alt="image-20220820203529433" tabindex="0" loading="lazy"><figcaption>image-20220820203529433</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/pay.html</code>文件里搜索<code>支付宝</code>，修改相关代码。</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Jd_footer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/order/pay/img\weixin.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>微信支付
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/order/pay/img\zhifubao.png<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">weight</span><span class="token punctuation">:</span>auto<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>30px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://order.gulimall.com/payOrder?orderSn=&#39;+${submitOrderResp.order.orderSn}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>支付宝<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.1.2.png" alt="image-20220820203622191" tabindex="0" loading="lazy"><figcaption>image-20220820203622191</figcaption></figure><h5 id="_2、修改代码" tabindex="-1"><a class="header-anchor" href="#_2、修改代码" aria-hidden="true">#</a> 2、修改代码</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web</code>包里新建<code>PayWebController</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayApiException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">AlipayTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">PayVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/20
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayWebController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AlipayTemplate</span> alipayTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payOrder&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">payOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderSn&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>
        <span class="token class-name">PayVo</span> payVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getOrderPay</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> pay <span class="token operator">=</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>payVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.2.1.png" alt="image-20220820210626254" tabindex="0" loading="lazy"><figcaption>image-20220820210626254</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里太内疚<code>getOrderPay</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">PayVo</span> <span class="token function">getOrderPay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.2.2.png" alt="image-20220820210704284" tabindex="0" loading="lazy"><figcaption>image-20220820210704284</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里实现<code>getOrderPay</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PayVo</span> <span class="token function">getOrderPay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PayVo</span> payVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOrderStatusByOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BigDecimal</span> totalAmount <span class="token operator">=</span> orderEntity<span class="token punctuation">.</span><span class="token function">getPayAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>totalAmount<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderItemEntity</span><span class="token operator">::</span><span class="token function">getOrderSn</span><span class="token punctuation">,</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot; limit 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderItemEntity</span> orderItemEntity <span class="token operator">=</span> orderItemService<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payVo<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuAttrsVals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> payVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.2.3.png" alt="image-20220820213319648" tabindex="0" loading="lazy"><figcaption>image-20220820213319648</figcaption></figure><h5 id="_3、测试-1" tabindex="-1"><a class="header-anchor" href="#_3、测试-1" aria-hidden="true">#</a> 3、测试</h5><p>重启<code>GulimallOrderApplication</code>服务，点击 http://order.gulimall.com/toTrade 页面的<code>提交订单</code>按钮，来到了 http://order.gulimall.com/submitOrder 页面，点击<code>支付宝</code>图标就跳转到支付宝的页面了，此时查看<code>GulimallOrderApplication</code>服务的控制台，可以看到已经成功输出了支付宝返回的信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.3.1.png" alt="GIF 2022-8-20 21-35-22" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 21-35-22</figcaption></figure><p>支付宝返回了一个<code>&lt;form&gt;</code>表单和一个<code>&lt;script&gt;</code>用来提交表单，而且是使用<code>&lt;script&gt;</code>直接提交的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>form name<span class="token operator">=</span><span class="token string">&quot;punchout_form&quot;</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;https://openapi.alipaydev.com/gateway.do?charset=utf-8&amp;method=alipay.trade.page.pay&amp;sign=QpWCjWl8avWnIjdrY5RFM8dv6TBjQI3escBJcCml%2B2g6tQaWQCjCtm5EgsnNZvlKVFcGl4oBLzpZEP0fFrlvZsinrLX3uIkka6zumCUT246hbd8rhT4utMS%2Bup%2BtsQwVB5Du16UzkE%2Bsd8WC37EUCg%2F%2Bd5%2FtR%2FoS7f2M8RYd%2B5oo0OgpGqEglOxQINIGyD%2Bg%2FCUeC2GmmK1q0a%2F07c8XCxUbPG0LPj3Opya%2F8V2Bn8PlNaQ25iEh%2BbnFjOhk1GPL3YDe8USR4KAluhylW4eHW9EDvSzEwUe3avub2l3Kt6WSdsJRfV8ux6HyIO7QdYFa3cCB3ZKS0xL1QItCs%2B83OA%3D%3D&amp;version=1.0&amp;app_id=2021000117672941&amp;sign_type=RSA2&amp;timestamp=2022-08-20+21%3A35%3A11&amp;alipay_sdk=alipay-sdk-java-dynamicVersionNo&amp;format=json&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;hidden&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;biz_content&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;{&amp;quot;out_trade_no&amp;quot;:&amp;quot;202208202135096131560983780531920898&amp;quot;,&amp;quot;total_amount&amp;quot;:&amp;quot;47401.00&amp;quot;,&amp;quot;subject&amp;quot;:&amp;quot;华为 HUAWEI Mate30Pro 罗兰紫 8GB+128GB 麒麟990旗舰芯片OLED环幕屏双4000万徕卡电影四摄 4G全网通手机&amp;quot;,&amp;quot;body&amp;quot;:&amp;quot;颜色：罗兰紫;版本：8GB+128GB&amp;quot;,&amp;quot;product_code&amp;quot;:&amp;quot;FAST_INSTANT_TRADE_PAY&amp;quot;}&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;立即支付&quot;</span> style<span class="token operator">=</span><span class="token string">&quot;display:none&quot;</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>script<span class="token punctuation">&gt;</span></span>document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.3.2.png" alt="image-20220820213731759" tabindex="0" loading="lazy"><figcaption>image-20220820213731759</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.PayWebController</code>类里修改<code>payOrder</code>方法，将<code>@GetMapping(&quot;/payOrder&quot;)</code>修改为<code>@GetMapping(value = &quot;/payOrder&quot;,produces = &quot;text/html&quot;)</code></p><p>其实我更推荐使用<code>@GetMapping(value = &quot;/payOrder&quot;,produces = MediaType.TEXT_HTML_VALUE)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.3.3.png" alt="image-20220820214600161" tabindex="0" loading="lazy"><figcaption>image-20220820214600161</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.AlipayTemplate</code>类里的<code>returnUrl</code>字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> returnUrl<span class="token operator">=</span><span class="token string">&quot;http://member.gulimall.com/memberOrder.html&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.3.4.png" alt="image-20220821085200342" tabindex="0" loading="lazy"><figcaption>image-20220821085200342</figcaption></figure><h5 id="_4、添加页面" tabindex="-1"><a class="header-anchor" href="#_4、添加页面" aria-hidden="true">#</a> 4、添加页面</h5><p>将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\订单页</code>里的<code>index.html</code>复制到在<code>gulimall-member</code>模块的<code>src/main/resources/templates</code>文件夹里面，并将刚刚粘贴的<code>index.html</code>重命名为<code>orderList.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.4.1.png" alt="image-20220821085439712" tabindex="0" loading="lazy"><figcaption>image-20220821085439712</figcaption></figure><p>在<code>linux</code>虚拟机里的<code>/mydata/nginx/html/static</code>目录下新建<code>member</code>目录，将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\订单页</code>里的文件夹全部复制到linux虚拟机里的<code>/mydata/nginx/html/static/member</code>目录下（不包括<code>index.html</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.4.2.gif" alt="GIF 2022-8-21 8-59-42" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-21 8-59-42</figcaption></figure><p>修改<code>gulimall-member</code>模块的<code>src/main/resources/templates/orderList.html</code>文件，将<code>href=&quot;</code>全部替换为<code>href=&quot;/static/member/</code>，将<code>src=&quot;</code>全部替换为<code>src=&quot;/static/member/</code></p><p><a href="/gulimall/code/6.3.1.5.4.orderList.html" class="">点击查看完整orderList页面</a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;
href=&quot;</span>/static/member/

<span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;
src=&quot;</span>/static/member/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.4.3.png" alt="image-20220821090509845" tabindex="0" loading="lazy"><figcaption>image-20220821090509845</figcaption></figure><h5 id="_5、添加配置" tabindex="-1"><a class="header-anchor" href="#_5、添加配置" aria-hidden="true">#</a> 5、添加配置</h5><p>在<code>gulimall-member</code>模块的<code>pom.xml</code>文件里添加<code>thymeleaf</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--模板引擎：thymeleaf--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.1.png" alt="image-20220821085558121" tabindex="0" loading="lazy"><figcaption>image-20220821085558121</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下配置，关闭<code>thymeleaf</code>缓存</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.thymeleaf.cache</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.2.png" alt="image-20220821085651323" tabindex="0" loading="lazy"><figcaption>image-20220821085651323</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>src/main/resources/templates/orderList.html</code>文件里，将<code>&lt;html lang=&quot;en&quot;&gt;</code>修改为<code>&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.3.png" alt="image-20220821090621314" tabindex="0" loading="lazy"><figcaption>image-20220821090621314</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member</code>包下新建<code>interceptor</code>文件夹。复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.interceptor.LoginUserInterceptor</code>类，粘贴到<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.interceptor</code>包下。</p><p><a href="code/6.3.1.5.5.LoginUserInterceptor.java">点击查看LoginUserInterceptor类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.4.png" alt="image-20220821091053614" tabindex="0" loading="lazy"><figcaption>image-20220821091053614</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.config</code>包下新建<code>MemberWebConfig</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">LoginUserInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">InterceptorRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/21
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.5.png" alt="image-20220821092255087" tabindex="0" loading="lazy"><figcaption>image-20220821092255087</figcaption></figure><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.GulimallSessionConfig</code>类，粘贴到<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.config</code>包下。</p><p><a href="code/6.3.1.5.5.GulimallSessionConfig.java">点击查看GulimallSessionConfig类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.6.png" alt="image-20220821094007003" tabindex="0" loading="lazy"><figcaption>image-20220821094007003</figcaption></figure><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加如下配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_member_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>member
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Host=member.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.7.png" alt="image-20220821091646118" tabindex="0" loading="lazy"><figcaption>image-20220821091646118</figcaption></figure><p>在<code>hosts</code>文件里添加<code>member.gulimall.com</code>网址对应的<code>ip</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># gulimall</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">search.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">item.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">auth.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">cart.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">order.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">member.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.5.8.png" alt="image-20220821091850027" tabindex="0" loading="lazy"><figcaption>image-20220821091850027</figcaption></figure><h5 id="_6、修改页面和配置" tabindex="-1"><a class="header-anchor" href="#_6、修改页面和配置" aria-hidden="true">#</a> 6、修改页面和配置</h5><p>在 http://gulimall.com/ 页面里，打开控制台，定位到<code>我的订单</code>图标，复制<code>我的订单</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.6.1.png" alt="image-20220821092354913" tabindex="0" loading="lazy"><figcaption>image-20220821092354913</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里，把<code>&lt;a href=&quot;http://order.gulimall.com/list.html&quot;&gt;我的订单&lt;/a&gt;</code>修改为<code>&lt;a href=&quot;http://member.gulimall.com/memberOrder.html&quot;&gt;我的订单&lt;/a&gt;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://member.gulimall.com/memberOrder.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.6.2.png" alt="image-20220821092529782" tabindex="0" loading="lazy"><figcaption>image-20220821092529782</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>pom.xml</code>文件里引入<code>redis</code>和<code>SpringSession</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--引入SpringSession--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.6.3.png" alt="image-20220821093615823" tabindex="0" loading="lazy"><figcaption>image-20220821093615823</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>src/main/resources/application.properties</code>文件里添加<code>redis</code>配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
<span class="token key attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.6.4.png" alt="image-20220821093326466" tabindex="0" loading="lazy"><figcaption>image-20220821093326466</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.GulimallMemberApplication</code>启动文件里添加如下注解，开启<code>Spring Session</code>功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.6.5.png" alt="image-20220821093712051" tabindex="0" loading="lazy"><figcaption>image-20220821093712051</figcaption></figure><h5 id="_7、测试" tabindex="-1"><a class="header-anchor" href="#_7、测试" aria-hidden="true">#</a> 7、测试</h5><p>在 http://gulimall.com/ 页面里点击<code>我的订单</code>，来到了 http://auth.gulimall.com/login.html 登录页面，点击<code>gitee</code>登录，发现<code>GulimallAuthServerApplication</code>服务报错了，提示访问<code>http://gulimall-member/member/member/giteeLogin</code>失败了，这应该是拦截器把请求拦截了，让其跳转到登录页了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.1.gif" alt="GIF 2022-8-21 9-44-18" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-21 9-44-18</figcaption></figure><p><code>GulimallAuthServerApplication</code>服务控制台报的错误如下所示</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>feign.RetryableException: cannot retry due to redirection, <span class="token keyword">in</span> streaming mode executing POST http://gulimall-member/member/member/giteeLogin
	at feign.FeignException.errorExecuting<span class="token punctuation">(</span>FeignException.java:132<span class="token punctuation">)</span>
	at feign.SynchronousMethodHandler.executeAndDecode<span class="token punctuation">(</span>SynchronousMethodHandler.java:113<span class="token punctuation">)</span>
	at feign.SynchronousMethodHandler.invoke<span class="token punctuation">(</span>SynchronousMethodHandler.java:78<span class="token punctuation">)</span>
	at feign.ReflectiveFeign<span class="token variable">$FeignInvocationHandler</span>.invoke<span class="token punctuation">(</span>ReflectiveFeign.java:103<span class="token punctuation">)</span>
	at com.sun.proxy.<span class="token variable">$Proxy95</span>.giteeLogin<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span>
	at com.atguigu.gulimall.auth.service.impl.OAuth2ServiceImpl.giteeRegister<span class="token punctuation">(</span>OAuth2ServiceImpl.java:53<span class="token punctuation">)</span>
	at com.atguigu.gulimall.auth.controller.OAuth2Controller.giteeRegister<span class="token punctuation">(</span>OAuth2Controller.java:34<span class="token punctuation">)</span>
	at sun.reflect.NativeMethodAccessorImpl.invoke0<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
	at sun.reflect.NativeMethodAccessorImpl.invoke<span class="token punctuation">(</span>NativeMethodAccessorImpl.java:62<span class="token punctuation">)</span>
	at sun.reflect.DelegatingMethodAccessorImpl.invoke<span class="token punctuation">(</span>DelegatingMethodAccessorImpl.java:43<span class="token punctuation">)</span>
	at java.lang.reflect.Method.invoke<span class="token punctuation">(</span>Method.java:498<span class="token punctuation">)</span>
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke<span class="token punctuation">(</span>InvocableHandlerMethod.java:190<span class="token punctuation">)</span>
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest<span class="token punctuation">(</span>InvocableHandlerMethod.java:138<span class="token punctuation">)</span>
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle<span class="token punctuation">(</span>ServletInvocableHandlerMethod.java:104<span class="token punctuation">)</span>
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod<span class="token punctuation">(</span>RequestMappingHandlerAdapter.java:892<span class="token punctuation">)</span>
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal<span class="token punctuation">(</span>RequestMappingHandlerAdapter.java:797<span class="token punctuation">)</span>
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle<span class="token punctuation">(</span>AbstractHandlerMethodAdapter.java:87<span class="token punctuation">)</span>
	at org.springframework.web.servlet.DispatcherServlet.doDispatch<span class="token punctuation">(</span>DispatcherServlet.java:1039<span class="token punctuation">)</span>
	at org.springframework.web.servlet.DispatcherServlet.doService<span class="token punctuation">(</span>DispatcherServlet.java:942<span class="token punctuation">)</span>
	at org.springframework.web.servlet.FrameworkServlet.processRequest<span class="token punctuation">(</span>FrameworkServlet.java:1005<span class="token punctuation">)</span>
	at org.springframework.web.servlet.FrameworkServlet.doGet<span class="token punctuation">(</span>FrameworkServlet.java:897<span class="token punctuation">)</span>
	at javax.servlet.http.HttpServlet.service<span class="token punctuation">(</span>HttpServlet.java:634<span class="token punctuation">)</span>
	at org.springframework.web.servlet.FrameworkServlet.service<span class="token punctuation">(</span>FrameworkServlet.java:882<span class="token punctuation">)</span>
	at javax.servlet.http.HttpServlet.service<span class="token punctuation">(</span>HttpServlet.java:741<span class="token punctuation">)</span>
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter<span class="token punctuation">(</span>ApplicationFilterChain.java:231<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.2.png" alt="image-20220821094400481" tabindex="0" loading="lazy"><figcaption>image-20220821094400481</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.interceptor.LoginUserInterceptor</code>类里修改<code>preHandle</code>方法，把<code>boolean match = new AntPathMatcher().match(&quot;/order/order/status/**&quot;, uri);</code>修改为<code>boolean match = new AntPathMatcher().match(&quot;/member/member/giteeLogin&quot;, uri);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> match <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/member/member/giteeLogin&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Object</span> attribute <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberEntityTo</span><span class="token punctuation">)</span> attribute<span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;请先进行登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//没登陆就重定向到登录页面</span>
        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">&quot;http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.3.png" alt="image-20220821094832279" tabindex="0" loading="lazy"><figcaption>image-20220821094832279</figcaption></figure><p>登陆后，在 http://gulimall.com/ 页面里点击<code>我的订单</code>，就跳转到 http://member.gulimall.com/memberOrder.html 页面了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.4.gif" alt="GIF 2022-8-21 9-47-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-21 9-47-15</figcaption></figure><p>访问 http://order.gulimall.com/toTrade 页面，打开控制台，点击<code>Network</code>，查看请求可以发现，以下请求访问失败了</p><div class="language-url line-numbers-mode" data-ext="url"><pre class="language-url"><code><span class="token scheme">http<span class="token scheme-delimiter">:</span></span><span class="token authority"><span class="token authority-delimiter">//</span><span class="token host">gulimall.com</span></span><span class="token path"><span class="token path-separator">/</span>api<span class="token path-separator">/</span>ware<span class="token path-separator">/</span>wareinfo<span class="token path-separator">/</span>fare</span><span class="token query"><span class="token query-delimiter">?</span><span class="token pair"><span class="token key">addrId</span>=<span class="token value">1</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>返回的响应为：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2022-08-21 09-54-39&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token property">&quot;error&quot;</span><span class="token operator">:</span><span class="token string">&quot;Internal Server Error&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;Could not extract response: no suitable HttpMessageConverter found for response type [class com.atguigu.common.utils.R] and content type [text/html;charset=UTF-8]&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;/ware/wareinfo/fare&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.5.gif" alt="GIF 2022-8-21 9-54-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-21 9-54-54</figcaption></figure><p>查看失败的 http://gulimall.com/api/ware/wareinfo/fare?addrId=1 这个请求，可以发现报的是<code>500</code>的错误</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.6.png" alt="image-20220821095545062" tabindex="0" loading="lazy"><figcaption>image-20220821095545062</figcaption></figure><p>查看<code>GulimallWareApplication</code>服务的控制台，报了如下的错误，显示返回的是<code>text/html</code>类型</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-21 09:54:39.338 ERROR <span class="token number">2140</span> --- <span class="token punctuation">[</span>io-11000-exec-5<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is feign.codec.DecodeException: Could not extract response: no suitable HttpMessageConverter found <span class="token keyword">for</span> response <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>class com.atguigu.common.utils.R<span class="token punctuation">]</span> and content <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>text/html<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8<span class="token punctuation">]</span><span class="token punctuation">]</span> with root cause

org.springframework.web.client.RestClientException: Could not extract response: no suitable HttpMessageConverter found <span class="token keyword">for</span> response <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>class com.atguigu.common.utils.R<span class="token punctuation">]</span> and content <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>text/html<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8<span class="token punctuation">]</span>
	at org.springframework.web.client.HttpMessageConverterExtractor.extractData<span class="token punctuation">(</span>HttpMessageConverterExtractor.java:121<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-web-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at org.springframework.cloud.openfeign.support.SpringDecoder.decode<span class="token punctuation">(</span>SpringDecoder.java:59<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-cloud-openfeign-core-2.1.3.RELEASE.jar:2.1.3.RELEASE<span class="token punctuation">]</span>
	at org.springframework.cloud.openfeign.support.ResponseEntityDecoder.decode<span class="token punctuation">(</span>ResponseEntityDecoder.java:62<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-cloud-openfeign-core-2.1.3.RELEASE.jar:2.1.3.RELEASE<span class="token punctuation">]</span>
	at feign.optionals.OptionalDecoder.decode<span class="token punctuation">(</span>OptionalDecoder.java:36<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.decode<span class="token punctuation">(</span>SynchronousMethodHandler.java:176<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.executeAndDecode<span class="token punctuation">(</span>SynchronousMethodHandler.java:140<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.invoke<span class="token punctuation">(</span>SynchronousMethodHandler.java:78<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.ReflectiveFeign<span class="token variable">$FeignInvocationHandler</span>.invoke<span class="token punctuation">(</span>ReflectiveFeign.java:103<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at com.sun.proxy.<span class="token variable">$Proxy111</span>.addrInfo<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.ware.service.impl.WareInfoServiceImpl.getFare<span class="token punctuation">(</span>WareInfoServiceImpl.java:62<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.ware.service.impl.WareInfoServiceImpl<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>55890fdc.invoke
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.7.7.png" alt="image-20220821095653346" tabindex="0" loading="lazy"><figcaption>image-20220821095653346</figcaption></figure><h5 id="_8、修改代码" tabindex="-1"><a class="header-anchor" href="#_8、修改代码" aria-hidden="true">#</a> 8、修改代码</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.feign.MemberFeignService</code>接口里的<code>addrInfo</code>方法调用了<code>gulimall-member</code>模块的<code>/member/memberreceiveaddress/info/{id}</code>返回了<code>text/html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.8.1.png" alt="image-20220821095713343" tabindex="0" loading="lazy"><figcaption>image-20220821095713343</figcaption></figure><p>修改<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.interceptor.LoginUserInterceptor</code>类的<code>preHandle</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">boolean</span> match <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/member/**&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.8.2.png" alt="image-20220821095912000" tabindex="0" loading="lazy"><figcaption>image-20220821095912000</figcaption></figure><p>重启<code>GulimallMemberApplication</code>服务，在 http://order.gulimall.com/toTrade 页面里点击<code>提交订单</code>后，来到 http://order.gulimall.com/submitOrder 页面，然后点击支付宝支付，就跳转到了支付宝的支付页面，支付成功后也能正确跳转到 http://member.gulimall.com/memberOrder.html 我的订单页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.1.5.8.3.gif" alt="GIF 2022-8-21 10-36-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-21 10-36-38</figcaption></figure><h3 id="_6-3-2、完善支付功能" tabindex="-1"><a class="header-anchor" href="#_6-3-2、完善支付功能" aria-hidden="true">#</a> 6.3.2、完善支付功能</h3><h4 id="_1、添加接口" tabindex="-1"><a class="header-anchor" href="#_1、添加接口" aria-hidden="true">#</a> 1、添加接口</h4><h5 id="_1、查询订单项" tabindex="-1"><a class="header-anchor" href="#_1、查询订单项" aria-hidden="true">#</a> 1、查询订单项</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.controller.OrderController</code>类里添加<code>listWithItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/listWithItem&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">listWithItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PageUtils</span> page <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">queryPageWithItem</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.1.png" alt="image-20220821104459980" tabindex="0" loading="lazy"><figcaption>image-20220821104459980</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里添加<code>queryPageWithItem</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">PageUtils</span> <span class="token function">queryPageWithItem</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.2.png" alt="image-20220821104531133" tabindex="0" loading="lazy"><figcaption>image-20220821104531133</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.entity.OrderEntity</code>类里添加<code>itemEntities</code>字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> itemEntities<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.3.png" alt="image-20220821104700619" tabindex="0" loading="lazy"><figcaption>image-20220821104700619</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里添加<code>queryPageWithItem</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PageUtils</span> <span class="token function">queryPageWithItem</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> orderQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span><span class="token operator">::</span><span class="token function">getMemberId</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span>
            orderQueryWrapper
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>orderEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> orderItemQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderItemQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderItemEntity</span><span class="token operator">::</span><span class="token function">getOrderSn</span><span class="token punctuation">,</span> orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderItemService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>orderItemQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    page<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PageUtils</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.4.png" alt="image-20220821105623206" tabindex="0" loading="lazy"><figcaption>image-20220821105623206</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.controller.OrderController</code>类修改<code>listWithItem</code>方法，将<code>@RequestParam</code>修改为<code>@RequestBody</code>，<code>@RequestMapping(&quot;/listWithItem&quot;)</code>修改为<code>@PostMapping(&quot;/listWithItem&quot;)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.5.png" alt="image-20230105162906919" tabindex="0" loading="lazy"><figcaption>image-20230105162906919</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.feign</code>包里新建<code>OrderFeignService</code>接口，用于远程调用订单服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>member<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/21
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order/order/listWithItem&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">listWithItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.6.png" alt="image-20220821111534607" tabindex="0" loading="lazy"><figcaption>image-20220821111534607</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.web.MemberWebController</code>类里修改<code>memberOrderPage</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/memberOrder.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">memberOrderPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//查出当前登录的用户的所有订单列表数据</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    page<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span>pageNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">listWithItem</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orders&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;orderList&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.1.7.png" alt="image-20220821111942297" tabindex="0" loading="lazy"><figcaption>image-20220821111942297</figcaption></figure><h5 id="_2、不能够重定向" tabindex="-1"><a class="header-anchor" href="#_2、不能够重定向" aria-hidden="true">#</a> 2、不能够重定向</h5><p>重启<code>GulimallMemberApplication</code>服务，浏览器打开 http://member.gulimall.com/memberOrder.html 页面，可以看到报了如下的错误</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Whitelabel Error Page
This application has no explicit mapping <span class="token keyword">for</span> /error, so you are seeing this as a fallback.

Sun Aug <span class="token number">21</span> <span class="token number">11</span>:24:28 CST <span class="token number">2022</span>
There was an unexpected error <span class="token punctuation">(</span>type<span class="token operator">=</span>Internal Server Error, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>.
cannot retry due to redirection, <span class="token keyword">in</span> streaming mode executing POST http://gulimall-order/order/order/listWithItem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.2.1.png" alt="image-20220821112441583" tabindex="0" loading="lazy"><figcaption>image-20220821112441583</figcaption></figure><p>查看<code>GulimallMemberApplication</code>服务的控制台，报了如下的错误</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-08-21 11:24:28.500 ERROR 2248 --- [nio-8000-exec-1] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is feign.RetryableException: cannot retry due to redirection, in streaming mode executing POST http://gulimall-order/order/order/listWithItem] with root cause

java.net.HttpRetryException: cannot retry due to redirection, in streaming mode
	at sun.net.www.protocol.http.HttpURLConnection.followRedirect0(HttpURLConnection.java:2665) ~[na:1.8.0_301]
	at sun.net.www.protocol.http.HttpURLConnection.followRedirect(HttpURLConnection.java:2651) ~[na:1.8.0_301]
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1830) ~[na:1.8.0_301]
	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1498) ~[na:1.8.0_301]
	at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480) ~[na:1.8.0_301]
	at feign.Client$Default.convertResponse(Client.java:143) ~[feign-core-10.2.3.jar:na]
	at feign.Client$Default.execute(Client.java:68) ~[feign-core-10.2.3.jar:na]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.2.2.png" alt="image-20220821112600476" tabindex="0" loading="lazy"><figcaption>image-20220821112600476</figcaption></figure><p>调试程序发现<code>template</code>里的<code>target</code>为 http://gulimall-order ，<code>uriTemplate</code>里的<code>template</code>值为<code>/order/order/listWithItem </code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.2.3.png" alt="image-20220821113255095" tabindex="0" loading="lazy"><figcaption>image-20220821113255095</figcaption></figure><p>然后放行<code>response = client.execute(request, options);</code>，显示响应的<code>responseCode</code>为<code>302</code>，<code>detailMessage</code>的值为<code>cannot retry due to redirection, in streaming mode</code>，<code>cause</code> -&gt; <code>location</code>的值为<code>http://auth.gulimall.com/login.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.2.4.png" alt="image-20220821113512193" tabindex="0" loading="lazy"><figcaption>image-20220821113512193</figcaption></figure><p>复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.GuliFeignConfig</code>类，粘贴到<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.config</code>包下。</p><p><a href="code/6.3.2.1.2.GuliFeignConfig.java">点击查看GuliFeignConfig文件</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.2.5.png" alt="image-20220821113652369" tabindex="0" loading="lazy"><figcaption>image-20220821113652369</figcaption></figure><h5 id="_3、内部服务异常" tabindex="-1"><a class="header-anchor" href="#_3、内部服务异常" aria-hidden="true">#</a> 3、内部服务异常</h5><p>重启<code>GulimallMemberApplication</code>服务，浏览器访问 http://member.gulimall.com/memberOrder.html 页面，报了如下的错误。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Whitelabel Error Page
This application has no explicit mapping <span class="token keyword">for</span> /error, so you are seeing this as a fallback.

Sun Aug <span class="token number">21</span> <span class="token number">11</span>:38:34 CST <span class="token number">2022</span>
There was an unexpected error <span class="token punctuation">(</span>type<span class="token operator">=</span>Internal Server Error, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>.
status <span class="token number">500</span> reading OrderFeignService<span class="token comment">#listWithItem(Map)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.3.1.png" alt="image-20220821113907324" tabindex="0" loading="lazy"><figcaption>image-20220821113907324</figcaption></figure><p>查看<code>GulimallMemberApplication</code>服务的控制台，可以看到是远程调用的问题。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-21 <span class="token number">11</span>:38:34.967 ERROR <span class="token number">7032</span> --- <span class="token punctuation">[</span>nio-8000-exec-1<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is feign.FeignException<span class="token variable">$InternalServerError</span><span class="token builtin class-name">:</span> status <span class="token number">500</span> reading OrderFeignService<span class="token comment">#listWithItem(Map)] with root cause</span>

feign.FeignException<span class="token variable">$InternalServerError</span><span class="token builtin class-name">:</span> status <span class="token number">500</span> reading OrderFeignService<span class="token comment">#listWithItem(Map)</span>
	at feign.FeignException.errorStatus<span class="token punctuation">(</span>FeignException.java:114<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.FeignException.errorStatus<span class="token punctuation">(</span>FeignException.java:86<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.codec.ErrorDecoder<span class="token variable">$Default</span>.decode<span class="token punctuation">(</span>ErrorDecoder.java:93<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.executeAndDecode<span class="token punctuation">(</span>SynchronousMethodHandler.java:149<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.invoke<span class="token punctuation">(</span>SynchronousMethodHandler.java:78<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.ReflectiveFeign<span class="token variable">$FeignInvocationHandler</span>.invoke<span class="token punctuation">(</span>ReflectiveFeign.java:103<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at com.sun.proxy.<span class="token variable">$Proxy111</span>.listWithItem<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.member.web.MemberWebController.memberOrderPage<span class="token punctuation">(</span>MemberWebController.java:30<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.3.2.png" alt="image-20220821113954107" tabindex="0" loading="lazy"><figcaption>image-20220821113954107</figcaption></figure><p>查看<code>GulimallOrderApplication</code>服务的控制台，发生了<code>Integer</code>类型不能被强转成<code>String</code>类型的异常</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-21 <span class="token number">11</span>:38:34.902 ERROR <span class="token number">9820</span> --- <span class="token punctuation">[</span>nio-9000-exec-9<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String<span class="token punctuation">]</span> with root cause

java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String
	at com.atguigu.common.utils.Query.getPage<span class="token punctuation">(</span>Query.java:37<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.common.utils.Query.getPage<span class="token punctuation">(</span>Query.java:28<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.queryPageWithItem<span class="token punctuation">(</span>OrderServiceImpl.java:256<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>99092a92.invoke<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at org.springframework.cglib.proxy.MethodProxy.invoke<span class="token punctuation">(</span>MethodProxy.java:218<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-core-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at org.springframework.aop.framework.CglibAopProxy<span class="token variable">$DynamicAdvisedInterceptor</span>.intercept<span class="token punctuation">(</span>CglibAopProxy.java:684<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl<span class="token variable">$$</span>EnhancerBySpringCGLIB<span class="token variable">$$</span>309f4bf3.queryPageWithItem<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.controller.OrderController.listWithItem<span class="token punctuation">(</span>OrderController.java:55<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.3.3.png" alt="image-20220821114139421" tabindex="0" loading="lazy"><figcaption>image-20220821114139421</figcaption></figure><p>修改<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.web.MemberWebController</code>类的<code>memberOrderPage</code>方法，将<code>pageNum</code>修改为<code>pageNum.toString()</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/memberOrder.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">memberOrderPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//查出当前登录的用户的所有订单列表数据</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    page<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span>pageNum<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">listWithItem</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orders&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;orderList&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.3.4.png" alt="image-20220821114438979" tabindex="0" loading="lazy"><figcaption>image-20220821114438979</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.web.MemberWebController</code>类里修改<code>memberOrderPage</code>方法，在<code>R r = orderFeignService.listWithItem(page);</code>这行代码后面添加<code>System.out.println(JSON.toJSON(r));</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/memberOrder.html&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">memberOrderPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pageNum<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//查出当前登录的用户的所有订单列表数据</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    page<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span>pageNum<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">listWithItem</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orders&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;orderList&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.3.5.png" alt="image-20220821114829708" tabindex="0" loading="lazy"><figcaption>image-20220821114829708</figcaption></figure><h5 id="_4、不知道item-entities字段" tabindex="-1"><a class="header-anchor" href="#_4、不知道item-entities字段" aria-hidden="true">#</a> 4、不知道<code>item_entities</code>字段</h5><p>重启<code>GulimallMemberApplication</code>服务，重新测试，报了<code>Unknown column &#39;item_entities&#39; in &#39;field list&#39;</code>异常，这个错误是<code>MybatisPlus</code>找不到<code>Java</code>实体类的某个字段在数据库对应的列</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-21 <span class="token number">11</span>:43:31.542 ERROR <span class="token number">4852</span> --- <span class="token punctuation">[</span>nio-9000-exec-1<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is org.springframework.jdbc.BadSqlGrammarException: 
<span class="token comment">### Error querying database.  Cause: java.sql.SQLSyntaxErrorException: Unknown column &#39;item_entities&#39; in &#39;field list&#39;</span>
<span class="token comment">### The error may exist in com/atguigu/gulimall/order/dao/OrderDao.java (best guess)</span>
<span class="token comment">### The error may involve defaultParameterMap</span>
<span class="token comment">### The error occurred while setting parameters</span>
<span class="token comment">### SQL: SELECT  id,note,delivery_time,integration_amount,order_sn,bill_receiver_email,discount_amount,receiver_province,bill_content,coupon_id,receiver_city,auto_confirm_day,delivery_sn,coupon_amount,modify_time,receiver_phone,pay_type,pay_amount,receiver_region,receiver_post_code,delete_status,member_username,confirm_status,payment_time,bill_header,item_entities,member_id,freight_amount,receiver_name,bill_type,use_integration,receiver_detail_address,delivery_company,comment_time,receive_time,bill_receiver_phone,total_amount,source_type,create_time,integration,growth,promotion_amount,status  FROM oms_order     WHERE (member_id = ?)</span>
<span class="token comment">### Cause: java.sql.SQLSyntaxErrorException: Unknown column &#39;item_entities&#39; in &#39;field list&#39;</span>
<span class="token punctuation">;</span> bad SQL grammar <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> nested exception is java.sql.SQLSyntaxErrorException: Unknown <span class="token function">column</span> <span class="token string">&#39;item_entities&#39;</span> <span class="token keyword">in</span> <span class="token string">&#39;field list&#39;</span><span class="token punctuation">]</span> with root cause

java.sql.SQLSyntaxErrorException: Unknown <span class="token function">column</span> <span class="token string">&#39;item_entities&#39;</span> <span class="token keyword">in</span> <span class="token string">&#39;field list&#39;</span>
	at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException<span class="token punctuation">(</span>SQLError.java:120<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mysql-connector-java-8.0.17.jar:8.0.17<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.4.1.png" alt="image-20220821114548173" tabindex="0" loading="lazy"><figcaption>image-20220821114548173</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.entity.OrderEntity</code>类的<code>itemEntities</code>字段上面添加<code>@TableField(exist = false)</code>注解，告诉<code>MybatisPlus</code>这个字段mysql对应的表里不存在</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> itemEntities<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.4.2.png" alt="image-20220821114644661" tabindex="0" loading="lazy"><figcaption>image-20220821114644661</figcaption></figure><h5 id="_5、添加配置-1" tabindex="-1"><a class="header-anchor" href="#_5、添加配置-1" aria-hidden="true">#</a> 5、添加配置</h5><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.MyBatisConfig</code>类，粘贴到<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.config</code>包下。修改<code>@MapperScan(&quot;com.atguigu.gulimall.product.dao&quot;)</code>为<code>@MapperScan(&quot;com.atguigu.gulimall.member.dao&quot;)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.5.1.png" alt="image-20220821161320706" tabindex="0" loading="lazy"><figcaption>image-20220821161320706</figcaption></figure><p>重新启动<code>GulimallMemberApplication</code>服务，再次测试，这时<code>GulimallMemberApplication</code>服务的控制台就输出了如下的<code>json</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;page&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;totalCount&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;pageSize&quot;</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">&quot;totalPage&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;currPage&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;list&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;memberId&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">&quot;orderSn&quot;</span><span class="token operator">:</span><span class="token string">&quot;202208211151528791561199381468717057&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;memberUsername&quot;</span><span class="token operator">:</span><span class="token string">&quot;无名氏&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;totalAmount&quot;</span><span class="token operator">:</span><span class="token number">47392.0</span><span class="token punctuation">,</span><span class="token property">&quot;payAmount&quot;</span><span class="token operator">:</span><span class="token number">47401.0</span><span class="token punctuation">,</span><span class="token property">&quot;freightAmount&quot;</span><span class="token operator">:</span><span class="token number">9.0</span><span class="token punctuation">,</span><span class="token property">&quot;promotionAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;integrationAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;couponAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;autoConfirmDay&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">&quot;integration&quot;</span><span class="token operator">:</span><span class="token number">47392</span><span class="token punctuation">,</span><span class="token property">&quot;growth&quot;</span><span class="token operator">:</span><span class="token number">47392</span><span class="token punctuation">,</span><span class="token property">&quot;receiverPhone&quot;</span><span class="token operator">:</span><span class="token string">&quot;12345678910&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;receiverProvince&quot;</span><span class="token operator">:</span><span class="token string">&quot;上海市&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;receiverDetailAddress&quot;</span><span class="token operator">:</span><span class="token string">&quot;上海市松江区大厦6层&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;deleteStatus&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;modifyTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2022-08-21T03:51:53.000+0000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">&quot;memberId&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">&quot;orderSn&quot;</span><span class="token operator">:</span><span class="token string">&quot;202208211153075861561199694800003073&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;memberUsername&quot;</span><span class="token operator">:</span><span class="token string">&quot;无名氏&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;totalAmount&quot;</span><span class="token operator">:</span><span class="token number">47392.0</span><span class="token punctuation">,</span><span class="token property">&quot;payAmount&quot;</span><span class="token operator">:</span><span class="token number">47406.0</span><span class="token punctuation">,</span><span class="token property">&quot;freightAmount&quot;</span><span class="token operator">:</span><span class="token number">14.0</span><span class="token punctuation">,</span><span class="token property">&quot;promotionAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;integrationAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;couponAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;autoConfirmDay&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">&quot;integration&quot;</span><span class="token operator">:</span><span class="token number">47392</span><span class="token punctuation">,</span><span class="token property">&quot;growth&quot;</span><span class="token operator">:</span><span class="token number">47392</span><span class="token punctuation">,</span><span class="token property">&quot;receiverPhone&quot;</span><span class="token operator">:</span><span class="token string">&quot;12345678910&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;receiverProvince&quot;</span><span class="token operator">:</span><span class="token string">&quot;北京市&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;receiverDetailAddress&quot;</span><span class="token operator">:</span><span class="token string">&quot;北京市昌平区宏福科技园&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;deleteStatus&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;modifyTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2022-08-21T03:53:08.000+0000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">&quot;memberId&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">&quot;orderSn&quot;</span><span class="token operator">:</span><span class="token string">&quot;202208211154011001561199919253987330&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;memberUsername&quot;</span><span class="token operator">:</span><span class="token string">&quot;无名氏&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;totalAmount&quot;</span><span class="token operator">:</span><span class="token number">47392.0</span><span class="token punctuation">,</span><span class="token property">&quot;payAmount&quot;</span><span class="token operator">:</span><span class="token number">47406.0</span><span class="token punctuation">,</span><span class="token property">&quot;freightAmount&quot;</span><span class="token operator">:</span><span class="token number">14.0</span><span class="token punctuation">,</span><span class="token property">&quot;promotionAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;integrationAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;couponAmount&quot;</span><span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">,</span><span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;autoConfirmDay&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token property">&quot;integration&quot;</span><span class="token operator">:</span><span class="token number">47392</span><span class="token punctuation">,</span><span class="token property">&quot;growth&quot;</span><span class="token operator">:</span><span class="token number">47392</span><span class="token punctuation">,</span><span class="token property">&quot;receiverPhone&quot;</span><span class="token operator">:</span><span class="token string">&quot;12345678910&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;receiverProvince&quot;</span><span class="token operator">:</span><span class="token string">&quot;北京市&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;receiverDetailAddress&quot;</span><span class="token operator">:</span><span class="token string">&quot;北京市昌平区宏福科技园&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;deleteStatus&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;modifyTime&quot;</span><span class="token operator">:</span><span class="token string">&quot;2022-08-21T03:54:01.000+0000&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.5.2.png" alt="image-20220821115628224" tabindex="0" loading="lazy"><figcaption>image-20220821115628224</figcaption></figure><p><a href="code/6.3.2.1.5.1.json">格式化后的<code>json</code>文件</a>如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.5.3.png" alt="image-20220821115815504" tabindex="0" loading="lazy"><figcaption>image-20220821115815504</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里，修改<code>queryPageWithItem</code>方法，忘记把订单项设置给<code>orderEntity</code>了，加上即可。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PageUtils</span> <span class="token function">queryPageWithItem</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> orderQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span><span class="token operator">::</span><span class="token function">getMemberId</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">,</span>
            orderQueryWrapper
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>orderEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> orderItemQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderItemQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderItemEntity</span><span class="token operator">::</span><span class="token function">getOrderSn</span><span class="token punctuation">,</span> orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> orderItemService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>orderItemQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderEntity<span class="token punctuation">.</span><span class="token function">setItemEntities</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    page<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PageUtils</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.5.4.png" alt="image-20220821171411273" tabindex="0" loading="lazy"><figcaption>image-20220821171411273</figcaption></figure><p>重新启动<code>GulimallOrderApplication</code>服务，再次测试，这时<code>GulimallMemberApplication</code>服务的控制台就输出了如下的<code>json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.5.5.png" alt="image-20220821172050128" tabindex="0" loading="lazy"><figcaption>image-20220821172050128</figcaption></figure><p><a href="code/6.3.2.1.5.2.json">格式化后的<code>json</code>文件</a>如下图所示</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.5.6.png" alt="image-20220821171917121" style="zoom:33%;"><h5 id="_6、修改我的订单页" tabindex="-1"><a class="header-anchor" href="#_6、修改我的订单页" aria-hidden="true">#</a> 6、修改我的订单页</h5><p>在 http://member.gulimall.com/memberOrder.html 页面里，打开控制台，定位到一个订单项，复制<code>class=&quot;table&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.6.1.png" alt="image-20220821170704862" tabindex="0" loading="lazy"><figcaption>image-20220821170704862</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>src/main/resources/templates/orderList.html</code>文件里搜索<code>class=&quot;table&quot;</code>，只保留一个<code>&lt;table&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.6.2.png" alt="image-20220821170808432" tabindex="0" loading="lazy"><figcaption>image-20220821170808432</figcaption></figure><p>然后修改这个<code>&lt;table&gt;</code>，将内容修改为动态的数据，<a href="/gulimall/code/6.3.2.2.1.html" class="">代码内容</a>如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.6.3.png" alt="image-20220821195316547" tabindex="0" loading="lazy"><figcaption>image-20220821195316547</figcaption></figure><p>重启<code>GulimallMemberApplication</code>服务，浏览器访问 http://member.gulimall.com/memberOrder.html 页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.1.6.4.png" alt="image-20220821195223053" tabindex="0" loading="lazy"><figcaption>image-20220821195223053</figcaption></figure><h4 id="_2、内网穿透" tabindex="-1"><a class="header-anchor" href="#_2、内网穿透" aria-hidden="true">#</a> 2、内网穿透</h4><h5 id="_1、原理" tabindex="-1"><a class="header-anchor" href="#_1、原理" aria-hidden="true">#</a> 1、原理</h5><p>付款成功后，支付宝会多次向配置的<code>异步通知接口</code>发请求，直到该接口返回<code>success</code>才停止</p><p>查看文档： https://opendocs.alipay.com/open/270/105902</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.1.1.png" alt="image-20220822212951827" tabindex="0" loading="lazy"><figcaption>image-20220822212951827</figcaption></figure><p><code>别人的电脑</code>可以访问公网的<code>京东商城</code>，而<code>别人的电脑</code>不能访问<code>我的电脑</code>，这是因为<code>我的电脑</code>没有公网ip，别人无法通过公网访问。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.1.2.png" alt="image-20220822103936610" tabindex="0" loading="lazy"><figcaption>image-20220822103936610</figcaption></figure><p>两个用户却可以发送<code>QQ</code>消息，这是因为我们都能够访问<code>QQ服务器</code>，<code>别人的电脑</code>发送<code>QQ</code>消息时会发送给<code>QQ服务器</code>，<code>QQ服务器</code>先把消息存着，当我的电脑连接<code>QQ服务器</code>后，<code>QQ服务器</code>就将存着的消息发给我，因此我们可以相互聊天。（相当于我们都可以访问<code>QQ服务器</code>，<code>QQ服务器</code>代理我们发送的消息，当我们连接<code>QQ服务器</code>后，<code>QQ服务器</code>将别的用户想要发送给我们的消息发送给我们）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.1.3.png" alt="image-20220822103955313" tabindex="0" loading="lazy"><figcaption>image-20220822103955313</figcaption></figure><p>内网穿透的原理类似，我们两个电脑不能访问，但是我们都可以访问<code>内网穿透服务商</code>，内网穿透服务商做代理，将消息转发给我们。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.1.4.png" alt="image-20220822104037547" tabindex="0" loading="lazy"><figcaption>image-20220822104037547</figcaption></figure><h5 id="_2、添加异步通知地址" tabindex="-1"><a class="header-anchor" href="#_2、添加异步通知地址" aria-hidden="true">#</a> 2、添加异步通知地址</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.AlipayTemplate</code>类里，修改<code>notifyUrl</code>的值为<code>内网穿透服务商提供的域名</code>+<code>/payed/notify</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token operator">=</span><span class="token string">&quot;http://1661133527191.free.aeert.com/payed/notify&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.2.1.png" alt="image-20220822100221123" tabindex="0" loading="lazy"><figcaption>image-20220822100221123</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener</code>包里新建<code>OrderPayedListener</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/21
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderPayedListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleAlipayed</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> map <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到了支付宝的通知：&quot;</span><span class="token operator">+</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.2.2.png" alt="image-20220822095214928" tabindex="0" loading="lazy"><figcaption>image-20220822095214928</figcaption></figure><p>访问<code>http://order.gulimall.com/payed/notify</code>页面，重定向到了登录页。这一看就是拦截器将这个请求拦截了，在拦截器里将这个请求直接放行即可。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>http://order.gulimall.com/payed/notify
http://auth.gulimall.com/login.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.2.3.png" alt="image-20220822103457122" tabindex="0" loading="lazy"><figcaption>image-20220822103457122</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.interceptor.LoginUserInterceptor</code>类里修改<code>preHandle</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AntPathMatcher</span> antPathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> match <span class="token operator">=</span> antPathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/order/order/status/**&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> match2 <span class="token operator">=</span> antPathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">||</span> match2<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="code/6.3.2.2.2.LoginUserInterceptor.java">点击查看LoginUserInterceptor类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.2.4.png" alt="image-20220822103124588" tabindex="0" loading="lazy"><figcaption>image-20220822103124588</figcaption></figure><p>再次访问 http://order.gulimall.com/payed/notify 页面，这次访问成功了，返回的内容为<code>success</code>，此时的请求的URL为 http://order.gulimall.com/payed/notify ，请求头的Host为<code>order.gulimall.com</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>http://order.gulimall.com/payed/notify
order.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.2.5.png" alt="image-20220822103212900" tabindex="0" loading="lazy"><figcaption>image-20220822103212900</figcaption></figure><p>在内网穿透服务商那里配置要穿透的内网服务为<code>order.gulimall.com:80</code>，也就是我们本地访问的地址。通过此配置公网上访问 http://1661133527191.free.aeert.com/payed/notify 就能访问到我们本地的 http://order.gulimall.com:80</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>order.gulimall.com:80
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.2.6.png" alt="image-20220822101828649" tabindex="0" loading="lazy"><figcaption>image-20220822101828649</figcaption></figure><h5 id="_3、请求头host不匹配" tabindex="-1"><a class="header-anchor" href="#_3、请求头host不匹配" aria-hidden="true">#</a> 3、请求头Host不匹配</h5><p>直接访问内网穿透服务商提供的域名，可以正确访问<code>nginx</code>里设置的访问 http://order.gulimall.com:80 网址的默认页面（文件为<code>/mydata/nginx/html/index.html</code>）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://1661133527191.free.aeert.com/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.3.1.png" alt="image-20220822102146497" tabindex="0" loading="lazy"><figcaption>image-20220822102146497</figcaption></figure><p>访问 http://1661133527191.free.aeert.com/payed/notify 页面，相当于访问 http://order.gulimall.com/payed/notify 页面，此时却显示<code>404 Not Found</code>，这是因为访问 http://1661133527191.free.aeert.com/payed/notify 页面时，请求头的Host为<code>1661133527191.free.aeert.com</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://1661133527191.free.aeert.com/payed/notify
1661133527191.free.aeert.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.3.2.png" alt="image-20220822102718135" tabindex="0" loading="lazy"><figcaption>image-20220822102718135</figcaption></figure><p>而我们直接访问 http://order.gulimall.com/payed/notify 时，请求头的Host为<code>order.gulimall.com</code>，我们在windows系统的<code>C:\Windows\System32\drivers\etc\hosts</code>文件里配置了Host为<code>order.gulimall.com</code>时应访问的ip为<code>192.168.56.10</code>，而并没有配<code>Host</code>为<code>1661133527191.free.aeert.com</code>时应访问的<code>ip</code>，如果<code>nginx</code>不需要转发到<code>192.168.56.10</code>里的服务直接自己处理是可以正常访问的；但是如果<code>C:\Windows\System32\drivers\etc\hosts</code>文件里没有设置<code>1661133527191.free.aeert.com</code>域名应访问的<code>ip</code>，<code>niginx</code>就不知道要转发到<code>192.168.56.10</code>，<code>niginx</code>就会找到<code>DNS</code>里配置的<code>1661133527191.free.aeert.com</code>域名对应的<code>ip</code>，然后将消息转发给其对应的<code>ip</code>，很显然<code>1661133527191.free.aeert.com</code>域名对应<code>ip</code>的机器是没有我们想要访问的<code>tomcat</code>服务（其实如果没有配置代理<code>1661133527191.free.aeert.com</code>域名下的请求时，不会转发给对应的服务，只会在<code>nginx</code>里的文件里查找，在<code>nginx</code>里配置代理<code>1661133527191.free.aeert.com</code>域名下的请求后才会转发给对应的服务。）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.3.3.png" alt="image-20230106095424374" tabindex="0" loading="lazy"><figcaption>image-20230106095424374</figcaption></figure><p>访问失败的原因如下图所示，本质上就是<code>niginx</code>转发请求头<code>Host</code>为<code>order.gulimall.com</code>的请求时，能够正常转发到<code>192.168.56.10</code>，而请求头<code>Host</code>为<code>1661133527191.free.aeert.com</code>时，由于我们本地<code>C:\Windows\System32\drivers\etc\hosts</code>文件没有配置<code>1661133527191.free.aeert.com</code>域名应该访问的<code>ip</code>，此时就只能从<code>DNS</code>里寻找对应的<code>ip</code>，因此就错误的将请求转发给提供<code>1661133527191.free.aeert.com</code>域名的域名服务商的对应<code>ip</code>了，因此访问失败了。（其实如果没有配置代理<code>1661133527191.free.aeert.com</code>域名下的请求时，不会转发给对应的服务，只会在<code>nginx</code>里的文件里查找，在<code>nginx</code>里配置代理<code>1661133527191.free.aeert.com</code>域名下的请求后才会转发给对应的服务。）</p><p>因此根据上面的描述，主要有两种解决办法，一种是修改本地的<code>C:\Windows\System32\drivers\etc\hosts</code>文件，由于优先寻找本地的<code>C:\Windows\System32\drivers\etc\hosts</code>因此能够正确找到我们想要其访问的<code>ip</code>，即<code>192.168.56.10</code>（但是还是要在<code>nginx</code>里配置代理<code>1661133527191.free.aeert.com</code>域名下的服务）；一种是手动更正<code>nginx</code>里转发请求时发送的请求头的<code>Host</code>。第一种方式需要修改本地的<code>C:\Windows\System32\drivers\etc\hosts</code>文件并在<code>nginx</code>里配置代理<code>1661133527191.free.aeert.com</code>域名下的请求；第二种方式需要在<code>nginx</code>里配置手动修改<code>/payed/</code>下的<code>Host</code>为<code>order.gulimall.com</code>并配置代理<code>1661133527191.free.aeert.com</code>域名下的请求。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.3.4.png" alt="image-20220822104128371" tabindex="0" loading="lazy"><figcaption>image-20220822104128371</figcaption></figure><h5 id="_4、修改请求头的host" tabindex="-1"><a class="header-anchor" href="#_4、修改请求头的host" aria-hidden="true">#</a> 4、修改请求头的Host</h5><p>在<code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件里手动修改<code>/payed/</code>下的<code>Host</code>为<code>order.gulimall.com</code>，然后重启<code>noginx</code>服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd /mydata/nginx/conf/</span>
<span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># ls</span>
conf.d  fastcgi_params  koi-utf  koi-win  mime.types  modules  nginx.conf  scgi_params  uwsgi_params  win-utf
<span class="token punctuation">[</span>root@localhost conf<span class="token punctuation">]</span><span class="token comment"># cd conf.d/</span>
<span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># ls</span>
default.conf  gulimall.conf
<span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># vi gulimall.conf </span>
<span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># docker restart nginx </span>
nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.4.1.png" alt="image-20220822094228272" tabindex="0" loading="lazy"><figcaption>image-20220822094228272</figcaption></figure><p>由于<code>Host</code>不匹配，导致没有转给订单服务，因此可以在<code>location / {</code>配置的前面添加如下代码，将<code>/payed/</code>下的所有请求都手动设置<code>Host</code></p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /payed/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Host order.gulimall.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://gulimall</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.4.2.png" alt="image-20220822104539560" tabindex="0" loading="lazy"><figcaption>image-20220822104539560</figcaption></figure><p>重启<code>noginx</code>服务后，再次访问 http://1661133527191.free.aeert.com/payed/notify 页面，此时<code>niginx</code>还是没有正确转发给<code>192.168.56.10</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.4.3.png" alt="image-20220822104730726" tabindex="0" loading="lazy"><figcaption>image-20220822104730726</figcaption></figure><h5 id="_5、添加代理服务" tabindex="-1"><a class="header-anchor" href="#_5、添加代理服务" aria-hidden="true">#</a> 5、添加代理服务</h5><p>查看<code>niginx</code>的日志，可以看到<code>host: &quot;1661133527191.free.aeert.com&quot;</code>访问了<code>http://1661133527191.free.aeert.com/payed/notify</code>页面，而<code>nginx</code>去静态资源<code>/usr/share/nginx/html/payed/notify</code>里面去找了 ，我们想要让<code>nginx</code>转发给<code>192.168.56.10</code>对应的服务，结果却在<code>niginx</code>自己的文件里去找，这是因为我们没有配置代理<code>1661133527191.free.aeert.com</code>域名下的请求。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># cd ../../</span>
<span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># ls</span>
conf  html  logs
<span class="token punctuation">[</span>root@localhost nginx<span class="token punctuation">]</span><span class="token comment"># cd logs/</span>
<span class="token punctuation">[</span>root@localhost logs<span class="token punctuation">]</span><span class="token comment"># ls</span>
access.log  error.log
<span class="token punctuation">[</span>root@localhost logs<span class="token punctuation">]</span><span class="token comment"># cat access.log |grep &#39;payed&#39;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:56:59 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">7</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:56:59 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">946</span> <span class="token string">&quot;http://order.gulimall.com/payed/notify&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:57:01 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">404</span> <span class="token number">571</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;202.103.46.13&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:57:18 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">404</span> <span class="token number">571</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;202.103.46.13&quot;</span>
<span class="token punctuation">[</span>root@localhost logs<span class="token punctuation">]</span><span class="token comment"># cat error.log |grep &#39;payed&#39;</span>
<span class="token number">2022</span>/08/22 02:57:01 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">7</span><span class="token comment">#7: *6 open() &quot;/usr/share/nginx/html/payed/notify&quot; failed (2: No such file or directory), client: 192.168.56.1, server: localhost, request: &quot;GET /payed/notify HTTP/1.1&quot;, host: &quot;1661133527191.free.aeert.com&quot;</span>
<span class="token number">2022</span>/08/22 02:57:18 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">7</span><span class="token comment">#7: *6 open() &quot;/usr/share/nginx/html/payed/notify&quot; failed (2: No such file or directory), client: 192.168.56.1, server: localhost, request: &quot;GET /payed/notify HTTP/1.1&quot;, host: &quot;1661133527191.free.aeert.com&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.5.1.png" alt="image-20220822110122903" tabindex="0" loading="lazy"><figcaption>image-20220822110122903</figcaption></figure><p>在<code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件里的<code>server_name</code>后面再加一个<code>1661133527191.free.aeert.com</code></p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server_name</span>  gulimall.com *.gulimall.com 1661133527191.free.aeert.com</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.5.2.png" alt="image-20220822110624899" tabindex="0" loading="lazy"><figcaption>image-20220822110624899</figcaption></figure><p>再次重启<code>nginx</code>服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost logs<span class="token punctuation">]</span><span class="token comment"># cd ../conf/conf.d/</span>
<span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># ls</span>
default.conf  gulimall.conf
<span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># vi gulimall.conf </span>
<span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># docker restart nginx </span>
nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.5.3.png" alt="image-20220822110805349" tabindex="0" loading="lazy"><figcaption>image-20220822110805349</figcaption></figure><p>再次访问 http://1661133527191.free.aeert.com/payed/notify 页面，可以看到这次<code>nginx</code>成功转发给<code>192.168.56.10</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.5.4.png" alt="image-20220822110942054" tabindex="0" loading="lazy"><figcaption>image-20220822110942054</figcaption></figure><p>查看<code>nginx</code>日志，可以看到访问日志已经显示状态为<code>200</code>了，错误日志也没有打印错误消息了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost conf.d<span class="token punctuation">]</span><span class="token comment"># cd ../../logs/</span>
<span class="token punctuation">[</span>root@localhost logs<span class="token punctuation">]</span><span class="token comment"># cat access.log |grep &#39;payed&#39;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:56:59 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">7</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:56:59 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">946</span> <span class="token string">&quot;http://order.gulimall.com/payed/notify&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:57:01 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">404</span> <span class="token number">571</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;202.103.46.13&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:02:57:18 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">404</span> <span class="token number">571</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;202.103.46.13&quot;</span>
<span class="token number">192.168</span>.56.1 - - <span class="token punctuation">[</span><span class="token number">22</span>/Aug/2022:03:09:18 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /payed/notify HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">7</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36&quot;</span> <span class="token string">&quot;202.103.46.13&quot;</span>
<span class="token punctuation">[</span>root@localhost logs<span class="token punctuation">]</span><span class="token comment"># cat error.log |grep &#39;payed&#39;</span>
<span class="token number">2022</span>/08/22 02:57:01 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">7</span><span class="token comment">#7: *6 open() &quot;/usr/share/nginx/html/payed/notify&quot; failed (2: No such file or directory), client: 192.168.56.1, server: localhost, request: &quot;GET /payed/notify HTTP/1.1&quot;, host: &quot;1661133527191.free.aeert.com&quot;</span>
<span class="token number">2022</span>/08/22 02:57:18 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> <span class="token number">7</span><span class="token comment">#7: *6 open() &quot;/usr/share/nginx/html/payed/notify&quot; failed (2: No such file or directory), client: 192.168.56.1, server: localhost, request: &quot;GET /payed/notify HTTP/1.1&quot;, host: &quot;1661133527191.free.aeert.com&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.5.5.png" alt="image-20220822111211397" tabindex="0" loading="lazy"><figcaption>image-20220822111211397</figcaption></figure><p><a href="code/6.3.2.2.5.gulimall.conf">点击查看完整<code>nginx</code>的<code>gulimall.conf</code>配置</a></p><h4 id="_3、处理支付结果" tabindex="-1"><a class="header-anchor" href="#_3、处理支付结果" aria-hidden="true">#</a> 3、处理支付结果</h4><h5 id="_1、修改支付宝异步通知代码" tabindex="-1"><a class="header-anchor" href="#_1、修改支付宝异步通知代码" aria-hidden="true">#</a> 1、修改支付宝异步通知代码</h5><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener.OrderPayedListener</code>类的<code>handleAlipayed</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 支付宝成功异步回调
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleAlipayed</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功。返回success, 支付宝就再也不通知</span>
    <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> map <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key==&gt;&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span><span class="token string">&quot; value=&gt;&quot;</span><span class="token operator">+</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.1.1.png" alt="image-20220822113816891" tabindex="0" loading="lazy"><figcaption>image-20220822113816891</figcaption></figure><p>重新支付一个商品，控制台输出如下<a href="code/6.3.2.3.1.1.log">内容</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.1.2.png" alt="image-20220822113903714" tabindex="0" loading="lazy"><figcaption>image-20220822113903714</figcaption></figure><p><a href="code/6.3.2.3.1.2.log">格式后的json</a>如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.1.3.png" alt="image-20220822114321604" tabindex="0" loading="lazy"><figcaption>image-20220822114321604</figcaption></figure><h5 id="_2、处理支付结果" tabindex="-1"><a class="header-anchor" href="#_2、处理支付结果" aria-hidden="true">#</a> 2、处理支付结果</h5><p>复制<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\支付</code>里的<code>PayAsyncVo.java</code>文件，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.1.png" alt="image-20220822114640034" tabindex="0" loading="lazy"><figcaption>image-20220822114640034</figcaption></figure><p><code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayAsyncVo</code>类<a href="code/6.3.2.3.2.PayAsyncVo.java">完整代码</a>如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.2.png" alt="image-20220822115552353" tabindex="0" loading="lazy"><figcaption>image-20220822115552353</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener.OrderPayedListener</code>类里修改<code>handleAlipayed</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 支付宝成功异步回调
 * <span class="token keyword">@param</span> <span class="token parameter">vo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleAlipayed</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功。返回success, 支付宝就再也不通知</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">handlePayResult</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.3.png" alt="image-20220822151957993" tabindex="0" loading="lazy"><figcaption>image-20220822151957993</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里添加<code>handlePayResult</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">handlePayResult</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.4.png" alt="image-20220822152030613" tabindex="0" loading="lazy"><figcaption>image-20220822152030613</figcaption></figure><p>首先需要把订单保存到支付宝交易流水里（是<code>gulimall_oms</code>数据库的<code>oms_payment_info</code>表），方便对账</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.5.png" alt="image-20220822152138297" tabindex="0" loading="lazy"><figcaption>image-20220822152138297</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里添加<code>handlePayResult</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handlePayResult</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//保存交易流水</span>
    <span class="token class-name">PaymentInfoEntity</span> infoEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentInfoEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置支付宝流水号</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setAlipayTradeNo</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置订单号</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置交易状态</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setPaymentStatus</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getTradeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置回调时间</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setCallbackTime</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getNotifyTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    paymentInfoService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>infoEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> status <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getTradeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;TRADE_FINISHED&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//支付成功</span>
        <span class="token class-name">String</span> orderSn <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">,</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PAYED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.6.png" alt="image-20220822154012779" tabindex="0" loading="lazy"><figcaption>image-20220822154012779</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayAsyncVo</code>类里将<code>notifyTime</code>字段的类型修改为<code>Date</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.7.png" alt="image-20220822152922368" tabindex="0" loading="lazy"><figcaption>image-20220822152922368</figcaption></figure><p>在<code>gulimall_oms</code>数据库的<code>oms_payment_info</code>表里，给<code>order_sn</code>和<code>alipay_trade_no</code>添加唯一索引</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.8.png" alt="image-20220822153135012" tabindex="0" loading="lazy"><figcaption>image-20220822153135012</figcaption></figure><p>在<code>gulimall_oms</code>数据库的<code>oms_payment_info</code>表里，把<code>order_sn</code>字段的长度从<code>32</code>修改为<code>64</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.2.9.png" alt="image-20220822153536184" tabindex="0" loading="lazy"><figcaption>image-20220822153536184</figcaption></figure><h5 id="_3、更新等单状态" tabindex="-1"><a class="header-anchor" href="#_3、更新等单状态" aria-hidden="true">#</a> 3、更新等单状态</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.dao.OrderDao</code>接口里添加<code>updateOrderStatus</code>抽象方法，注意把<code>Integer code</code>改为<code>Integer status</code>后，再生成<code>@Param(&quot;status&quot;)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;orderSn&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.3.1.png" alt="image-20220822154529589" tabindex="0" loading="lazy"><figcaption>image-20220822154529589</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/mapper/order/OrderDao.xml</code>文件里添加如下<code>sql</code></p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>&lt;update id=&quot;updateOrderStatus&quot;&gt;
    update gulimall_oms.oms_order set `status`=#{status} where order_sn =#{orderSn}
&lt;/update&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.3.2.png" alt="image-20220822154721487" tabindex="0" loading="lazy"><figcaption>image-20220822154721487</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener.OrderPayedListener</code>类里添加验证签名的<code>checkSignVerified</code>方法，并让<code>handleAlipayed</code>方法在执行<code>orderService.handlePayResult(vo)</code>之前调用该方法来验证签名</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">AlipayTemplate</span> alipayTemplate<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 支付宝成功异步回调
 *
 * <span class="token keyword">@param</span> <span class="token parameter">vo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleAlipayed</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> vo<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功。返回success, 支付宝就再也不通知</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> signVerified <span class="token operator">=</span> <span class="token function">checkSignVerified</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//验证签名</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">handlePayResult</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkSignVerified</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">{</span>
    <span class="token comment">//获取支付宝POST过来反馈信息</span>
    <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestParams<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToDelimitedString</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//乱码解决，这段代码在出现乱码时使用</span>
        <span class="token comment">//value = new String(value.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用SDK验证签名</span>
    <span class="token keyword">return</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getAlipayPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getSignType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.3.3.png" alt="image-20220822164100234" tabindex="0" loading="lazy"><figcaption>image-20220822164100234</figcaption></figure><h5 id="_4、数据无法成功封装" tabindex="-1"><a class="header-anchor" href="#_4、数据无法成功封装" aria-hidden="true">#</a> 4、数据无法成功封装</h5><p>重新支付商品后，在<code>GulimallOrderApplication</code>服务的控制台报了下图所示的<a href="code/6.3.2.3.4.1.log">错误</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.4.1.png" alt="image-20220822163832684" tabindex="0" loading="lazy"><figcaption>image-20220822163832684</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>handlePayResult</code>方法的第一行打上断点，可以看到很多都没封装进去，但有些封装成功了（封装成功的都是一个单词的）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.4.2.png" alt="image-20220822170954882" tabindex="0" loading="lazy"><figcaption>image-20220822170954882</figcaption></figure><p>返回的信息的值为数组，如果使用蛇形命名法可以正确处理，但是使用驼峰命名法不能正确处理</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;gmt_create&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2022-08-22 11:36:24&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;charset&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;gmt_payment&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2022-08-22 11:36:39&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;notify_time&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2022-08-22 11:36:41&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;华为 HUAWEI Mate30Pro 罗兰紫 8GB+128GB 麒麟990旗舰芯片OLED环幕屏双4000万徕卡电影四摄 4G全网通手机&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sign&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bHkpXeAUM+egCByULY9b0rHefVrJr/ivJjH5vMVxr+JnJn795JdoaPn7vi8iMBxe674eh0x/dHYzc8WHoZrHGbAKrkkqhxgvbYw3VmMGVATjy2VvdqRjCXksKhCikU+uK6/aPn7xkodvcBokbgpBc4yz+vqRuPw/Paxp6WvofyMRgl3Yi6Zx4HG96yXQP1BgfKyTEHwq8QCUTsnE4UlRgOggTubBEG3Z4oXJIYSbM1pEWT6V065wOYIE4pDXCXo3kLEQdnLmlUK/i4u1CaEhuG6ScUBlRJ8hm6T8TgDHMXMiYUkTHGZg3pC9IH71ZZbSxBoYEVWJBHOs5CEcFKgCCA==&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;buyer_id&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2088622956116255&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;颜色：罗兰紫;版本：8GB+128GB&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;invoice_amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;11807.00&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;notify_id&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2022082200222113640016250520715284&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;fund_bill_list&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;[{\&quot;amount\&quot;:\&quot;11807.00\&quot;,\&quot;fundChannel\&quot;:\&quot;ALIPAYACCOUNT\&quot;}]&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;notify_type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;trade_status_sync&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;out_trade_no&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;202208221136062801561557798993534977&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;total_amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;11807.00&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;trade_status&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;trade_no&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2022082222001416250501868104&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;auth_app_id&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2021000117672941&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;receipt_amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;11807.00&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;point_amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;0.00&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;app_id&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2021000117672941&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;buyer_pay_amount&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;11807.00&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;sign_type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;seller_id&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2088621955944878&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包里新建一个<a href="code/6.3.2.3.4.2.PayAsyncVo2.java"><code>PayAsyncVo2</code>类</a>，修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>handlePayResult</code>方法的参数为<code>PayAsyncVo2</code>类型，然后修改对应的<code>controller</code>、<code>service</code>接口等，都使用<code>PayAsyncVo2</code>类来封装信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.4.3.png" alt="image-20220822192126693" tabindex="0" loading="lazy"><figcaption>image-20220822192126693</figcaption></figure><p>再次调试发现即使全指定别名也不行，多个单词的字段还是封装不进去</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.4.4.png" alt="image-20220822191928493" tabindex="0" loading="lazy"><figcaption>image-20220822191928493</figcaption></figure><p>由于返回的字段的值都是数组，因此修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayAsyncVo2</code>类，<a href="code/6.3.2.3.4.3.PayAsyncVo2.java">全部字段都改用<code>List</code>来接收</a>，然后调试发现使用<code>List</code>来接收也不行</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.4.5.png" alt="image-20220822193007069" tabindex="0" loading="lazy"><figcaption>image-20220822193007069</figcaption></figure><h5 id="_5、最终封装方式" tabindex="-1"><a class="header-anchor" href="#_5、最终封装方式" aria-hidden="true">#</a> 5、最终封装方式</h5><p>最后还是妥协了，还是使用老师的方式接收</p><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener.OrderPayedListener</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">AlipayTemplate</span> alipayTemplate<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 支付宝成功异步回调
 *
 * <span class="token keyword">@param</span> <span class="token parameter">vo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payed/notify&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleAlipayed</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> vo<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//只要我们收到了支付宝给我们异步的通知，告诉我们订单支付成功。返回success, 支付宝就再也不通知</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> signVerified <span class="token operator">=</span> <span class="token function">checkSignVerified</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//验证签名</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">handlePayResult</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkSignVerified</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">{</span>
    <span class="token comment">//获取支付宝POST过来反馈信息</span>
    <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestParams<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToDelimitedString</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//乱码解决，这段代码在出现乱码时使用</span>
        <span class="token comment">//value = new String(value.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用SDK验证签名</span>
    <span class="token keyword">return</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getAlipayPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alipayTemplate<span class="token punctuation">.</span><span class="token function">getSignType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.5.1.png" alt="image-20220822183600466" tabindex="0" loading="lazy"><figcaption>image-20220822183600466</figcaption></figure><p>还是使用<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayAsyncVo</code>类来封装数据，修改该类的<code>notify_time</code>字段的类型为<code>Date</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.5.2.png" alt="image-20220822172111771" tabindex="0" loading="lazy"><figcaption>image-20220822172111771</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>handlePayResult</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handlePayResult</span><span class="token punctuation">(</span><span class="token class-name">PayAsyncVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//保存交易流水</span>
    <span class="token class-name">PaymentInfoEntity</span> infoEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentInfoEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置支付宝流水号</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setAlipayTradeNo</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getTrade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置订单号</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置交易状态</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setPaymentStatus</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getTrade_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置回调时间</span>
    infoEntity<span class="token punctuation">.</span><span class="token function">setCallbackTime</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getNotify_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    paymentInfoService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>infoEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> status <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getTrade_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;TRADE_FINISHED&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//支付成功</span>
        <span class="token class-name">String</span> orderSn <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">,</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">PAYED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.2.5.6.png" alt="image-20220822172149798" tabindex="0" loading="lazy"><figcaption>image-20220822172149798</figcaption></figure><h5 id="_6、notify-time字段无法封装" tabindex="-1"><a class="header-anchor" href="#_6、notify-time字段无法封装" aria-hidden="true">#</a> 6、<code>notify_time</code>字段无法封装</h5><p>测试后，报了<code>payAsyncVo</code>类的<code>notify_time</code>字段无法成功封装</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Field error in object &#39;payAsyncVo&#39; on field &#39;notify_time&#39;: rejected value [2022-08-22 17:19:31]; codes [typeMismatch.payAsyncVo.notify_time,typeMismatch.notify_time,typeMismatch.java.util.Date,typeMismatch]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [payAsyncVo.notify_time,notify_time]; arguments []; default message [notify_time]]; default message [Failed to convert property value of type &#39;java.lang.String&#39; to required type &#39;java.util.Date&#39; for property &#39;notify_time&#39;; nested exception is org.springframework.core.convert.ConversionFailedException: Failed to convert from type [java.lang.String] to type [java.util.Date] for value &#39;2022-08-22 17:19:31&#39;; nested exception is java.lang.IllegalArgumentException]]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.6.1.png" alt="image-20220822172032664" tabindex="0" loading="lazy"><figcaption>image-20220822172032664</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，全局指定使用的日期格式。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>spring.mvc.date-format=yyyy-MM-dd HH:mm:ss
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.6.2.png" alt="image-20220822172836401" tabindex="0" loading="lazy"><figcaption>image-20220822172836401</figcaption></figure><p>或在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.PayAsyncVo</code>类的<code>notify_time</code>字段上添加如下注解，指定该字段使用的日期格式。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Date</span> notify_time<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.6.3.png" alt="image-20220822184613577" tabindex="0" loading="lazy"><figcaption>image-20220822184613577</figcaption></figure><p>再次测试，可以看到数据已经全部封装成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.3.6.4.png" alt="image-20220822173038730" tabindex="0" loading="lazy"><figcaption>image-20220822173038730</figcaption></figure><h4 id="_4、支付时设置收单" tabindex="-1"><a class="header-anchor" href="#_4、支付时设置收单" aria-hidden="true">#</a> 4、支付时设置收单</h4><p>收单（超过允许的时间后不允许用户支付）场景：</p><ol><li><p>订单在支付页，不支付，一直刷新，订单过期了才支付，订单状态改为已支付了，但是库存解锁了。</p><ul><li>使用支付宝自动收单功能解决。只要一段时间不支付，就不能支付了。</li></ul></li><li><p>由于时延等问题，订单解锁完成，正在解锁库存的时候，异步通知才到</p><ul><li>订单解锁，手动调用收单</li></ul></li><li><p>网络阻塞问题，订单支付成功的异步通知一直不到达</p><ul><li>查询订单列表时，ajax获取当前未支付的订单状态，查询订单状态时，再获取一下支付宝此订单的状态</li></ul></li><li><p>其他各种问题</p><ul><li>每天晚上闲时下载支付宝对账单，一 一进行对账</li></ul></li></ol><p>文档地址： https://opendocs.alipay.com/open/028r8t?scene=22</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.4.1.png" alt="image-20220822214039556" tabindex="0" loading="lazy"><figcaption>image-20220822214039556</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.AlipayTemplate</code>文件里添加<code>private String timeout = &quot;1m&quot;;</code>字段，并在<code>alipayRequest.setBizContent</code>方法里添加<code>+ &quot;\&quot;timeout_express\&quot;:\&quot;&quot; + timeout + &quot;\&quot;,&quot;</code></p><p><a href="code/6.3.2.4.java">点击查看完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.4.2.png" alt="image-20220822215150136" tabindex="0" loading="lazy"><figcaption>image-20220822215150136</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务后，再次支付商品，此时就会显示<code>正在使用即时到账交易[?] 交易将在46秒后关闭，请及时付款!</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.4.3.png" alt="image-20220823104711855" tabindex="0" loading="lazy"><figcaption>image-20220823104711855</figcaption></figure><p>超过时间再支付，此时就会显示<code>抱歉，您的交易因超时已失败。</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>抱歉，您的交易因超时已失败。
您订单的最晚付款时间为: 2022-08-23 10:47:16，目前已过期，交易关闭。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.4.4.png" alt="image-20220823104755770" loading="lazy">&#39;</p><h4 id="_5、手动调用收单" tabindex="-1"><a class="header-anchor" href="#_5、手动调用收单" aria-hidden="true">#</a> 5、手动调用收单</h4><p>再<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener.OrderCloseListener</code>类的<code>listener</code>方法里，关闭订单后，手动调用收单接口，防止用户在订单关闭后才支付。（其实我认为应该先<code>手动调用收单接口</code>再<code>关闭订单</code>，因为如果<code>关闭订单</code>后，用户此时支付了，而我们<code>手动调用收单接口</code>的请求还没有发给支付宝，此时就会出现订单关闭了，但是用户成功支付的情况，而先先<code>手动调用收单接口</code>再<code>关闭订单</code>就不会出现这种情况了）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.5.1.png" alt="image-20220822214900198" tabindex="0" loading="lazy"><figcaption>image-20220822214900198</figcaption></figure><p><code>手动调用收单接口</code>如下图所示，叫<a href="https://opendocs.alipay.com/open/028wob" target="_blank" rel="noopener noreferrer">统一收单交易关闭接口<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.5.2.png" alt="image-20220822215254889" tabindex="0" loading="lazy"><figcaption>image-20220822215254889</figcaption></figure><p>相关代码如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.3.2.5.3.png" alt="image-20220822215517613" tabindex="0" loading="lazy"><figcaption>image-20220822215517613</figcaption></figure><h1 id="七、秒杀" tabindex="-1"><a class="header-anchor" href="#七、秒杀" aria-hidden="true">#</a> 七、秒杀</h1><h2 id="_7-1、秒杀" tabindex="-1"><a class="header-anchor" href="#_7-1、秒杀" aria-hidden="true">#</a> 7.1、秒杀</h2><p>秒杀（ 高并发） 系统关注的问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.0.1.png" alt="image-20220824213156518" tabindex="0" loading="lazy"><figcaption>image-20220824213156518</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.0.2.png" alt="image-20220824214655339" tabindex="0" loading="lazy"><figcaption>image-20220824214655339</figcaption></figure><h3 id="_7-1-1、新增秒杀场次" tabindex="-1"><a class="header-anchor" href="#_7-1-1、新增秒杀场次" aria-hidden="true">#</a> 7.1.1、新增秒杀场次</h3><h4 id="_1、添加秒杀场次" tabindex="-1"><a class="header-anchor" href="#_1、添加秒杀场次" aria-hidden="true">#</a> 1、添加秒杀场次</h4><p>1、秒杀业务：秒杀具有瞬间高并发的特点，针对这一特点，必须要做限流 + 异步 + 缓存（页面静态化） + 独立部署。</p><p>限流方式：</p><ol><li>前端限流，一些高并发的网站直接在前端页面开始限流，例如：小米的验证码设计</li><li><code>nginx</code>限流，直接负载部分请求到错误的静态页面：令牌算法 漏斗算法</li><li>网关限流，限流的过滤器</li><li>代码中使用分布式信号量</li><li>rabbitmq 限流（能者多劳：chanel.basicQos(1)），保证发挥所有服务器的性能。</li></ol><h5 id="_1、配置每日秒杀请求" tabindex="-1"><a class="header-anchor" href="#_1、配置每日秒杀请求" aria-hidden="true">#</a> 1、配置每日秒杀请求</h5><p>启动后台管理系统，访问 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，打开控制台，然后点击<code>查询</code>按钮，即可看到请求的接口为： http://localhost:88/api/coupon/seckillsession/list?t=1661218666831&amp;page=1&amp;limit=10&amp;key=</p><div class="language-url line-numbers-mode" data-ext="url"><pre class="language-url"><code><span class="token scheme">http<span class="token scheme-delimiter">:</span></span><span class="token authority"><span class="token authority-delimiter">//</span><span class="token host">localhost</span><span class="token port-segment"><span class="token port-delimiter">:</span><span class="token port">88</span></span></span><span class="token path"><span class="token path-separator">/</span>api<span class="token path-separator">/</span>coupon<span class="token path-separator">/</span>seckillsession<span class="token path-separator">/</span>list</span><span class="token query"><span class="token query-delimiter">?</span><span class="token pair"><span class="token key">t</span>=<span class="token value">1661218666831</span></span><span class="token pair-delimiter">&amp;</span><span class="token pair"><span class="token key">page</span>=<span class="token value">1</span></span><span class="token pair-delimiter">&amp;</span><span class="token pair"><span class="token key">limit</span>=<span class="token value">10</span></span><span class="token pair-delimiter">&amp;</span><span class="token pair"><span class="token key">key</span>=</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.1.1.png" alt="image-20220823093853412" tabindex="0" loading="lazy"><figcaption>image-20220823093853412</figcaption></figure><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>文件里，添加如下配置，将<code>/api/coupon/**</code>开头的请求全部负载均衡到<code>gulimall-coupon</code>模块</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> coupon_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>coupon
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/api/coupon/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># (?&lt;segment&gt;/?.*) 和 $\{segment} 为固定写法</span>
            <span class="token comment">#http://localhost:88/api/coupon/seckillsession/list 变为 http://localhost:7000/coupon/seckillsession/list</span>
            <span class="token punctuation">-</span> RewritePath=/api/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>/<span class="token punctuation">?</span>.<span class="token important">*)</span><span class="token punctuation">,</span>/$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.1.2.png" alt="image-20220823094011610" tabindex="0" loading="lazy"><figcaption>image-20220823094011610</figcaption></figure><p>重启<code>GulimallGatewayApplication</code>服务，在 http://localhost:8001/#/coupon-seckillsession 页面里，打开控制台，刷新页面，可以看到这次请求的状态码为<code>200</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.1.3.png" alt="image-20220823094153725" tabindex="0" loading="lazy"><figcaption>image-20220823094153725</figcaption></figure><h5 id="_2、添加秒杀场次" tabindex="-1"><a class="header-anchor" href="#_2、添加秒杀场次" aria-hidden="true">#</a> 2、添加秒杀场次</h5><p>打开 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，点击新增，添加一个秒杀场次。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.2.1.png" alt="image-20220823094350190" tabindex="0" loading="lazy"><figcaption>image-20220823094350190</figcaption></figure><p>在<code>优惠营销</code> -&gt; <code>每日秒杀</code>页面里，点击新增，再添加一个秒杀场次。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.2.2.png" alt="image-20220823094450252" tabindex="0" loading="lazy"><figcaption>image-20220823094450252</figcaption></figure><p>这里的时区好像不太对，开始时间和结束时间都早了<code>8</code>小时，而且格式不符合国人审美。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.2.3.png" alt="image-20220823094551807" tabindex="0" loading="lazy"><figcaption>image-20220823094551807</figcaption></figure><p>查看<code>gulimall_sms</code>数据库的<code>sms_seckill_session</code>表，可以看到这里的时区有问题。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.2.4.png" alt="image-20220823094831694" tabindex="0" loading="lazy"><figcaption>image-20220823094831694</figcaption></figure><h5 id="_3、关联商品" tabindex="-1"><a class="header-anchor" href="#_3、关联商品" aria-hidden="true">#</a> 3、关联商品</h5><p>在<code>优惠营销</code> -&gt; <code>每日秒杀</code>页面里，点击第一个秒杀场次的操作的<code>关联商品</code>，此时会发一个<code>http://localhost:88/api/coupon/seckillskurelation/list?t=1661219427384&amp;page=1&amp;limit=10&amp;key=&amp;promotionSessionId=1</code>请求， 这个<code>promotionSessionId</code>就是这个秒杀的id</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.3.1.png" alt="image-20220823095118825" tabindex="0" loading="lazy"><figcaption>image-20220823095118825</figcaption></figure><p>在<code>gulimall_sms</code>数据库的<code>sms_seckill_sku_relation</code>表里，给<code>1</code>和<code>2</code>号<code>promotionSessionId</code>都新增一下数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.3.2.png" alt="image-20220823100824094" tabindex="0" loading="lazy"><figcaption>image-20220823100824094</figcaption></figure><p>在<code>优惠营销</code> -&gt; <code>每日秒杀</code>页面里，点击操作的<code>关联商品</code>，这时就能显示这个秒杀id的所有关联的信息了，请求的接口如下</p><p>http://localhost:88/api/coupon/seckillskurelation/list?t=1661220555869&amp;page=1&amp;limit=10&amp;key=&amp;promotionSessionId=1</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.3.3.png" alt="image-20220823100930503" tabindex="0" loading="lazy"><figcaption>image-20220823100930503</figcaption></figure><p>然后点击<code>参数名</code>的输入框，输入<code>1</code>，按回车，此时又发了如下请求，并查询到了相关的关联商品信息</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://localhost:88/api/coupon/seckillskurelation/list?t=1661220676407&amp;page=1&amp;limit=10&amp;key=1&amp;promotionSessionId=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.3.4.png" alt="image-20220823101254572" tabindex="0" loading="lazy"><figcaption>image-20220823101254572</figcaption></figure><p>查看<code>GulimallCouponApplication</code>服务的控制台，可以看到输出了如下的<code>sql</code></p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>SELECT id,seckill_sort,promotion_session_id,seckill_count,seckill_price,seckill_limit,sku_id,promotion_id FROM sms_seckill_sku_relation WHERE (( (id = ? OR promotion_id = ? OR sku_id = ?) ) AND promotion_session_id = ?) 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.3.5.png" alt="image-20220823101248884" tabindex="0" loading="lazy"><figcaption>image-20220823101248884</figcaption></figure><p>在<code>优惠营销</code> -&gt; <code>每日秒杀</code>页面里，点击第2个秒杀场次的操作的<code>关联商品</code>，此时会发如下请求</p><p>http://localhost:88/api/coupon/seckillskurelation/list?t=1661220577315&amp;page=1&amp;limit=10&amp;key=&amp;promotionSessionId=2</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.3.6.png" alt="image-20220823101036682" tabindex="0" loading="lazy"><figcaption>image-20220823101036682</figcaption></figure><h5 id="_4、添加关联商品" tabindex="-1"><a class="header-anchor" href="#_4、添加关联商品" aria-hidden="true">#</a> 4、添加关联商品</h5><p>在<code>优惠营销</code> -&gt; <code>每日秒杀</code>页面里，点击第1个秒杀场次的操作的<code>关联商品</code>，在<code>关联秒杀商品</code>里点击<code>新增</code>，新增如下<code>关联商品</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.4.1.png" alt="image-20220823103632186" tabindex="0" loading="lazy"><figcaption>image-20220823103632186</figcaption></figure><p>然后自动回到在<code>优惠营销</code> -&gt; <code>每日秒杀</code> -&gt; 第1个秒杀场次的操作的<code>关联秒杀商品</code>页面，此时刚刚新增的秒杀商品已经关联进去了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.1.1.4.2.png" alt="image-20220823103650832" tabindex="0" loading="lazy"><figcaption>image-20220823103650832</figcaption></figure><h3 id="_7-1-2、秒杀模块" tabindex="-1"><a class="header-anchor" href="#_7-1-2、秒杀模块" aria-hidden="true">#</a> 7.1.2、秒杀模块</h3><h4 id="_1、新建秒杀模块" tabindex="-1"><a class="header-anchor" href="#_1、新建秒杀模块" aria-hidden="true">#</a> 1、新建秒杀模块</h4><h5 id="_1、新建模块" tabindex="-1"><a class="header-anchor" href="#_1、新建模块" aria-hidden="true">#</a> 1、新建模块</h5><p>选中<code>IDEA</code>里<code>Project</code>的<code>gulimall</code>，右键依次点击<code>New</code>-&gt;<code>Module</code>-&gt;<code>Spring Initializr</code>-&gt;<code>Next</code></p><p>在<code>New Module</code>对话框里<code>Group</code>里输入<code>com.atguigu.gulimall</code>，<code>Artifact</code>里输入<code>gulimall-seckill</code>，<code>Java Version</code>选择<code>8</code>，<code>Description</code>里输入<code>秒杀</code>，<code>Package</code>里输入<code>com.atguigu.gulimall.seckill</code>，然后点击<code>Next</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>com.atguigu.gulimall
gulimall-seckill
秒杀
com.atguigu.gulimall.seckill
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.1.1.png" alt="image-20220823105607877" tabindex="0" loading="lazy"><figcaption>image-20220823105607877</figcaption></figure><p>选择<code>Devloper Tools</code>里的<code>Spring Boot DevTools</code>和<code>Lombox</code>，选择<code>Web</code>里的<code>Spring Web</code>，选择<code>NoSQL</code>里的<code>Spring Data Redis (Access+ Driver)</code>，选择<code>Spring Cloud Routing</code>里的<code>OpenFeign</code>，然后点击<code>Next</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.1.2.png" alt="image-20220823105826059" tabindex="0" loading="lazy"><figcaption>image-20220823105826059</figcaption></figure><p>最后点击<code>Finish</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.1.3.png" alt="image-20220823105828355" tabindex="0" loading="lazy"><figcaption>image-20220823105828355</figcaption></figure><h5 id="_2、修改依赖" tabindex="-1"><a class="header-anchor" href="#_2、修改依赖" aria-hidden="true">#</a> 2、修改依赖</h5><p>复制<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件的<code>dependencies</code>和<code>项目信息</code>的部分，(<code>properties</code>里的不要)</p><p>然后复制<code>gulimall-product</code>模块的<code>pom.xml</code>文件，粘贴到<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里，删除<code>dependencies</code>和<code>项目信息</code>的部分，替换为刚刚复制的<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件的<code>dependencies</code>和<code>项目信息</code></p><p>如果<code>pom.xml</code>文件颜色为赤橙色，可以选中<code>pom.xml</code>文件，右键选择<code>Add as Maven Project</code>就好了(最好先替换文件，再加入到项目)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.2.1.png" alt="image-20220823110055075" tabindex="0" loading="lazy"><figcaption>image-20220823110055075</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里，添加<code>gulimall-common</code>依赖</p><p><a href="code/7.1.2.1.2.pom.xml">点击查看完整pom文件</a></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.gulimall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.2.2.png" alt="image-20220823110311352" tabindex="0" loading="lazy"><figcaption>image-20220823110311352</figcaption></figure><h5 id="_3、修改测试类" tabindex="-1"><a class="header-anchor" href="#_3、修改测试类" aria-hidden="true">#</a> 3、修改测试类</h5><p>修改<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.GulimallSeckillApplicationTests</code>测试类为<code>junit4</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSeckillApplicationTests</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.3.png" alt="image-20220823111158722" tabindex="0" loading="lazy"><figcaption>image-20220823111158722</figcaption></figure><h5 id="_4、修改配置" tabindex="-1"><a class="header-anchor" href="#_4、修改配置" aria-hidden="true">#</a> 4、修改配置</h5><p>修改<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>配置文件</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">gulimall-seckill</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">25000</span>
<span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>
<span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.4.1.png" alt="image-20220823110520190" tabindex="0" loading="lazy"><figcaption>image-20220823110520190</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.GulimallSeckillApplication</code>启动类里添加<code>@EnableDiscoveryClient</code>注解，修改<code>@SpringBootApplication</code>，让其在启动的时候排除<code>DataSourceAutoConfiguration</code></p><p>然后启动<code>GulimallSeckillApplication</code>服务，然后限制内存<code>-Xmx100m</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.1.4.2.png" alt="image-20220823111103762" tabindex="0" loading="lazy"><figcaption>image-20220823111103762</figcaption></figure><h4 id="_2、cron表达式" tabindex="-1"><a class="header-anchor" href="#_2、cron表达式" aria-hidden="true">#</a> 2、cron表达式</h4><p>cron表达式： http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.2.png" alt="image-20220823111922564" tabindex="0" loading="lazy"><figcaption>image-20220823111922564</figcaption></figure><h5 id="crontrigger-tutorial" tabindex="-1"><a class="header-anchor" href="#crontrigger-tutorial" aria-hidden="true">#</a> CronTrigger Tutorial</h5><p><a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html#crontrigger-tutorial" target="_blank" rel="noopener noreferrer">CronTrigger Tutorial<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html#introduction" target="_blank" rel="noopener noreferrer">Introduction<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html#format" target="_blank" rel="noopener noreferrer">Format<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html#special-characters" target="_blank" rel="noopener noreferrer">Special characters<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html#examples" target="_blank" rel="noopener noreferrer">Examples<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html#notes" target="_blank" rel="noopener noreferrer">Notes<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h5 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction" aria-hidden="true">#</a> Introduction</h5><p><code>cron</code> is a UNIX tool that has been around for a long time, so its scheduling capabilities are powerful and proven. The <code>CronTrigger</code> class is based on the scheduling capabilities of cron.</p><p><code>CronTrigger</code> uses “cron expressions”, which are able to create firing schedules such as: “At 8:00am every Monday through Friday” or “At 1:30am every last Friday of the month”.</p><p>Cron expressions are powerful, but can be pretty confusing. This tutorial aims to take some of the mystery out of creating a cron expression, giving users a resource which they can visit before having to ask in a forum or mailing list.</p><h5 id="format" tabindex="-1"><a class="header-anchor" href="#format" aria-hidden="true">#</a> Format</h5><p>A cron expression is a string comprised of 6 or 7 fields separated by white space. Fields can contain any of the allowed values, along with various combinations of the allowed special characters for that field. The fields are as follows:</p><table><thead><tr><th style="text-align:left;">Field Name</th><th style="text-align:left;">Mandatory</th><th style="text-align:left;">Allowed Values</th><th style="text-align:left;">Allowed Special Characters</th></tr></thead><tbody><tr><td style="text-align:left;">Seconds</td><td style="text-align:left;">YES</td><td style="text-align:left;">0-59</td><td style="text-align:left;">, - * /</td></tr><tr><td style="text-align:left;">Minutes</td><td style="text-align:left;">YES</td><td style="text-align:left;">0-59</td><td style="text-align:left;">, - * /</td></tr><tr><td style="text-align:left;">Hours</td><td style="text-align:left;">YES</td><td style="text-align:left;">0-23</td><td style="text-align:left;">, - * /</td></tr><tr><td style="text-align:left;">Day of month</td><td style="text-align:left;">YES</td><td style="text-align:left;">1-31</td><td style="text-align:left;">, - * ? / L W</td></tr><tr><td style="text-align:left;">Month</td><td style="text-align:left;">YES</td><td style="text-align:left;">1-12 or JAN-DEC</td><td style="text-align:left;">, - * /</td></tr><tr><td style="text-align:left;">Day of week</td><td style="text-align:left;">YES</td><td style="text-align:left;">1-7 or SUN-SAT</td><td style="text-align:left;">, - * ? / L #</td></tr><tr><td style="text-align:left;">Year</td><td style="text-align:left;">NO</td><td style="text-align:left;">empty, 1970-2099</td><td style="text-align:left;">, - * /</td></tr></tbody></table><p>So cron expressions can be as simple as this: <code>* * * * ? *</code></p><p>or more complex, like this: <code>0/5 14,18,3-39,52 * ? JAN,MAR,SEP MON-FRI 2002-2010</code></p><h5 id="special-characters" tabindex="-1"><a class="header-anchor" href="#special-characters" aria-hidden="true">#</a> Special characters</h5><ul><li><code>*****</code> (<em>“all values”</em>) - used to select all values within a field. For example, “*****” in the minute field means <em>“every minute”</em>.</li><li><code>**?**</code> (<em>“no specific value”</em>) - useful when you need to specify something in one of the two fields in which the character is allowed, but not the other. For example, if I want my trigger to fire on a particular day of the month (say, the 10th), but don’t care what day of the week that happens to be, I would put “10” in the day-of-month field, and “?” in the day-of-week field. See the examples below for clarification.</li><li><code>**-**</code> - used to specify ranges. For example, “10-12” in the hour field means <em>“the hours 10, 11 and 12”</em>.</li><li><code>**,**</code> - used to specify additional values. For example, “MON,WED,FRI” in the day-of-week field means <em>“the days Monday, Wednesday, and Friday”</em>.</li><li><code>**/**</code> - used to specify increments. For example, “0/15” in the seconds field means <em>“the seconds 0, 15, 30, and 45”</em>. And “5/15” in the seconds field means <em>“the seconds 5, 20, 35, and 50”</em>. You can also specify ‘/’ after the ‘<strong>’ character - in this case ‘</strong>’ is equivalent to having ‘0’ before the ‘/’. ‘1/3’ in the day-of-month field means <em>“fire every 3 days starting on the first day of the month”</em>.</li><li><code>**L**</code> (<em>“last”</em>) - has different meaning in each of the two fields in which it is allowed. For example, the value “L” in the day-of-month field means <em>“the last day of the month”</em> - day 31 for January, day 28 for February on non-leap years. If used in the day-of-week field by itself, it simply means “7” or “SAT”. But if used in the day-of-week field after another value, it means <em>“the last xxx day of the month”</em> - for example “6L” means <em>“the last friday of the month”</em>. You can also specify an offset from the last day of the month, such as “L-3” which would mean the third-to-last day of the calendar month. <em>When using the ‘L’ option, it is important not to specify lists, or ranges of values, as you’ll get confusing/unexpected results.</em></li><li><code>**W**</code> (<em>“weekday”</em>) - used to specify the weekday (Monday-Friday) nearest the given day. As an example, if you were to specify “15W” as the value for the day-of-month field, the meaning is: <em>“the nearest weekday to the 15th of the month”</em>. So if the 15th is a Saturday, the trigger will fire on Friday the 14th. If the 15th is a Sunday, the trigger will fire on Monday the 16th. If the 15th is a Tuesday, then it will fire on Tuesday the 15th. However if you specify “1W” as the value for day-of-month, and the 1st is a Saturday, the trigger will fire on Monday the 3rd, as it will not ‘jump’ over the boundary of a month’s days. The ‘W’ character can only be specified when the day-of-month is a single day, not a range or list of days.</li></ul><blockquote><p>The &#39;L&#39; and &#39;W&#39; characters can also be combined in the day-of-month field to yield &#39;LW&#39;, which translates to <em>&quot;last weekday of the month&quot;</em>.</p></blockquote><ul><li><code>**#**</code> - used to specify “the nth” XXX day of the month. For example, the value of “6#3” in the day-of-week field means <em>“the third Friday of the month”</em> (day 6 = Friday and “#3” = the 3rd one in the month). Other examples: “2#1” = the first Monday of the month and “4#5” = the fifth Wednesday of the month. Note that if you specify “#5” and there is not 5 of the given day-of-week in the month, then no firing will occur that month.</li></ul><blockquote><p>The legal characters and the names of months and days of the week are not case sensitive. <code>MON</code> is the same as <code>mon</code>.</p></blockquote><h5 id="examples" tabindex="-1"><a class="header-anchor" href="#examples" aria-hidden="true">#</a> Examples</h5><p>Here are some full examples:</p><table><thead><tr><th><strong>Expression</strong></th><th><strong>Meaning</strong></th></tr></thead><tbody><tr><td><code>0 0 12 * * ?</code></td><td>Fire at 12pm (noon) every day</td></tr><tr><td><code>0 15 10 ? * *</code></td><td>Fire at 10:15am every day</td></tr><tr><td><code>0 15 10 * * ?</code></td><td>Fire at 10:15am every day</td></tr><tr><td><code>0 15 10 * * ? *</code></td><td>Fire at 10:15am every day</td></tr><tr><td><code>0 15 10 * * ? 2005</code></td><td>Fire at 10:15am every day during the year 2005</td></tr><tr><td><code>0 * 14 * * ?</code></td><td>Fire every minute starting at 2pm and ending at 2:59pm, every day</td></tr><tr><td><code>0 0/5 14 * * ?</code></td><td>Fire every 5 minutes starting at 2pm and ending at 2:55pm, every day</td></tr><tr><td><code>0 0/5 14,18 * * ?</code></td><td>Fire every 5 minutes starting at 2pm and ending at 2:55pm, AND fire every 5 minutes starting at 6pm and ending at 6:55pm, every day</td></tr><tr><td><code>0 0-5 14 * * ?</code></td><td>Fire every minute starting at 2pm and ending at 2:05pm, every day</td></tr><tr><td><code>0 10,44 14 ? 3 WED</code></td><td>Fire at 2:10pm and at 2:44pm every Wednesday in the month of March.</td></tr><tr><td><code>0 15 10 ? * MON-FRI</code></td><td>Fire at 10:15am every Monday, Tuesday, Wednesday, Thursday and Friday</td></tr><tr><td><code>0 15 10 15 * ?</code></td><td>Fire at 10:15am on the 15th day of every month</td></tr><tr><td><code>0 15 10 L * ?</code></td><td>Fire at 10:15am on the last day of every month</td></tr><tr><td><code>0 15 10 L-2 * ?</code></td><td>Fire at 10:15am on the 2nd-to-last last day of every month</td></tr><tr><td><code>0 15 10 ? * 6L</code></td><td>Fire at 10:15am on the last Friday of every month</td></tr><tr><td><code>0 15 10 ? * 6L</code></td><td>Fire at 10:15am on the last Friday of every month</td></tr><tr><td><code>0 15 10 ? * 6L 2002-2005</code></td><td>Fire at 10:15am on every last friday of every month during the years 2002, 2003, 2004 and 2005</td></tr><tr><td><code>0 15 10 ? * 6#3</code></td><td>Fire at 10:15am on the third Friday of every month</td></tr><tr><td><code>0 0 12 1/5 * ?</code></td><td>Fire at 12pm (noon) every 5 days every month, starting on the first day of the month.</td></tr><tr><td><code>0 11 11 11 11 ?</code></td><td>Fire every November 11th at 11:11am.</td></tr></tbody></table><blockquote><p>Pay attention to the effects of &#39;?&#39; and &#39;*&#39; in the day-of-week and day-of-month fields!</p></blockquote><h5 id="解释" tabindex="-1"><a class="header-anchor" href="#解释" aria-hidden="true">#</a> 解释</h5><p>特殊字符： <code>，</code>：枚举； (cron=&quot;7,9,23 * * * * ?&quot;)：任意时刻的 7,9，23 秒启动这个任务； <code>-</code>：范围： (cron=&quot;7-20 * * * * ?&quot;):任意时刻的 7-20 秒之间，每秒启动一次 <code>*</code>：任意； 指定位置的任意时刻都可以 <code>/</code>：步长； (cron=&quot;7/5 * * * * ?&quot;)：第 7 秒启动，每 5 秒一次； (cron=&quot;<em>/5 * * * * ?&quot;)：任意秒启动，每 5 秒一次； <code>？</code>：（出现在日和周几的位置）：为了防止日和周冲突，在周和日上如果要写通配符使 用? (cron=&quot;</em> * * 1 * ?&quot;)：每月的 1 号，启动这个任务； <code>L</code>：（出现在日和周的位置）”， last：最后一个 (cron=&quot;* * * ? * 3L&quot;)：每月的最后一个周二（1L为周日） <code>W</code>： Work Day：工作日 (cron=&quot;* * * W * ?&quot;)：每个月的工作日触发 (cron=&quot;* * * LW * ?&quot;)：每个月的最后一个工作日触发 <code>#</code>：第几个 (cron=&quot;* * * ? * 5#2&quot;)：每个月的第 2 个周</p><h4 id="_3、整合cron表达式" tabindex="-1"><a class="header-anchor" href="#_3、整合cron表达式" aria-hidden="true">#</a> 3、整合cron表达式</h4><h5 id="_1、简单测试" tabindex="-1"><a class="header-anchor" href="#_1、简单测试" aria-hidden="true">#</a> 1、简单测试</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包下，新建<code>scheduled</code>文件夹，在<code>scheduled</code>文件夹里新建<code>HelloSchedule</code>类，用于测试定时任务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>scheduled</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableScheduling</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 * @EnableScheduling 开启定时任务
 * @Scheduled        开启一个定时任务
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloSchedule</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 在Spring中的不同
     * 1、cron由6位组成，不允许第7位的年
     * 2、在周几的位置，1-7代表周一到周日; MON- SUN
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;*/5 * * ? * 2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;hello...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.3.1.1.png" alt="image-20220823114012352" tabindex="0" loading="lazy"><figcaption>image-20220823114012352</figcaption></figure><p>运行<code>GulimallSeckillApplication</code>服务，可以看到这个定时任务每<code>5</code>秒执行一次</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:00.002  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:05.002  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:10.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:15.000  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:20.000  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:25.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:30.002  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:35.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:40.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:45.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:50.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:55.001  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">11</span>:38:00.004  INFO <span class="token number">18428</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.3.1.2.png" alt="image-20220823113937150" tabindex="0" loading="lazy"><figcaption>image-20220823113937150</figcaption></figure><h5 id="_2、测试业务执行时间长" tabindex="-1"><a class="header-anchor" href="#_2、测试业务执行时间长" aria-hidden="true">#</a> 2、测试业务执行时间长</h5><p>修改<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.HelloSchedule</code>类的<code>hello</code>方法和该方法上的<code>@Scheduled</code>注解的<code>cron</code>表达式参数，设置其每一秒执行一次，但是业务执行时间为<code>3s</code></p><p>可以看到定时任务设置每秒执行一次，但该业务需要执行3秒，结果却是近乎每4s执行一次，可见此默认该定时任务是阻塞的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在Spring中的不同
 * 1、cron由6位组成，不允许第7位的年
 * 2、在周几的位置，1-7代表周一到周日; MON- SUN
 * 3、定时任务不应该阻塞。默认是阻塞的
 */</span>
<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;* * * ? * 2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;hello...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启<code>GulimallSeckillApplication</code>服务，控制台的输出如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-23 <span class="token number">15</span>:52:54.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:52:58.000  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:02.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:06.002  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:10.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:14.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:18.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:22.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:26.002  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:30.001  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:34.000  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">15</span>:53:38.002  INFO <span class="token number">8284</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule    <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.3.2.png" alt="image-20220823155437830" tabindex="0" loading="lazy"><figcaption>image-20220823155437830</figcaption></figure><h4 id="_4、解决定时任务阻塞" tabindex="-1"><a class="header-anchor" href="#_4、解决定时任务阻塞" aria-hidden="true">#</a> 4、解决定时任务阻塞</h4><h5 id="_1、手动创建线程池" tabindex="-1"><a class="header-anchor" href="#_1、手动创建线程池" aria-hidden="true">#</a> 1、手动创建线程池</h5><p>方法一：手动创建线程池，修改<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.HelloSchedule</code>类的<code>hello</code>方法如下所示，使用我们自己配置的线程池（这种方法可行，这里我就不测试了，只需将别的线程池的配置粘过来即可使用）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;* * * ? * 2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;hello...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.1.png" alt="image-20220823162502400" tabindex="0" loading="lazy"><figcaption>image-20220823162502400</figcaption></figure><h5 id="_2、指定定时任务线程池大小-不生效" tabindex="-1"><a class="header-anchor" href="#_2、指定定时任务线程池大小-不生效" aria-hidden="true">#</a> 2、指定定时任务线程池大小（不生效）</h5><p>方法二：指定定时任务线程池大小（不生效）</p><p>定时任务有自己的线程池，不过默认大小为<code>1</code>，所以不能异步执行。（在<code>org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration</code>自动配置类里引入了<code>TaskSchedulingProperties</code>配置类）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.2.1.png" alt="image-20220823160902099" tabindex="0" loading="lazy"><figcaption>image-20220823160902099</figcaption></figure><p>查看该<code>org.springframework.boot.autoconfigure.task.TaskSchedulingProperties</code>配置类，定时任务线程池默认设置的大小为<code>1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.2.2.png" alt="image-20220823160904223" tabindex="0" loading="lazy"><figcaption>image-20220823160904223</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，使用此配置不会生效</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.task.scheduling.pool.size</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.2.3.png" alt="image-20220823161015789" tabindex="0" loading="lazy"><figcaption>image-20220823161015789</figcaption></figure><p>重启<code>GulimallSeckillApplication</code>服务，控制台输出如下信息，可以看到还是间隔<code>4s</code>，可见配置了线程池大小定时任务仍然会阻塞</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:03.000  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:07.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:11.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:15.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:19.001  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:23.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:27.001  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:31.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-3<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:35.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-5<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:39.002  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-5<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:43.000  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-5<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:47.001  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-5<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:51.001  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-5<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
<span class="token number">2022</span>-08-23 <span class="token number">16</span>:21:55.000  INFO <span class="token number">22620</span> --- <span class="token punctuation">[</span>   scheduling-5<span class="token punctuation">]</span> c.a.g.seckill.scheduled.HelloSchedule   <span class="token builtin class-name">:</span> hello<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.2.4.png" alt="image-20220823162224491" tabindex="0" loading="lazy"><figcaption>image-20220823162224491</figcaption></figure><h5 id="_3、使用spring自带的异步任务" tabindex="-1"><a class="header-anchor" href="#_3、使用spring自带的异步任务" aria-hidden="true">#</a> 3、使用Spring自带的异步任务</h5><p>方法三：Spring的异步任务</p><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.GulimallSeckillApplication</code>启动类上添加<code>@EnableAsync</code>注解，开启异步任务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableAsync</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.3.1.png" alt="image-20220823161617048" tabindex="0" loading="lazy"><figcaption>image-20220823161617048</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.HelloSchedule</code>类的<code>hello</code>方法上添加<code>@Async</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Async</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.3.2.png" alt="image-20220823161624006" tabindex="0" loading="lazy"><figcaption>image-20220823161624006</figcaption></figure><p>重启<code>GulimallSeckillApplication</code>服务，控制台输出如下信息，可以看到间隔变为<code>1s</code>，可见使用任务后就不会阻塞了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-08-23 16:14:01.003  INFO 16996 --- [         task-1] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:02.002  INFO 16996 --- [         task-2] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:03.001  INFO 16996 --- [         task-3] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:04.001  INFO 16996 --- [         task-4] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:05.001  INFO 16996 --- [         task-5] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:06.000  INFO 16996 --- [         task-6] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:07.001  INFO 16996 --- [         task-7] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:08.001  INFO 16996 --- [         task-8] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:09.001  INFO 16996 --- [         task-1] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:10.001  INFO 16996 --- [         task-2] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:11.001  INFO 16996 --- [         task-3] c.a.g.seckill.scheduled.HelloSchedule   : hello...
2022-08-23 16:14:12.001  INFO 16996 --- [         task-4] c.a.g.seckill.scheduled.HelloSchedule   : hello...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.4.3.3.png" alt="image-20220823161438635" tabindex="0" loading="lazy"><figcaption>image-20220823161438635</figcaption></figure><h4 id="_5、源码" tabindex="-1"><a class="header-anchor" href="#_5、源码" aria-hidden="true">#</a> 5、源码</h4><h5 id="_1、自动配置" tabindex="-1"><a class="header-anchor" href="#_1、自动配置" aria-hidden="true">#</a> 1、自动配置</h5><p>查看<code>TaskExecutionAutoConfiguration</code>类的<code>taskExecutorBuilder</code>方法可以发现，该方法返回的是<code>TaskExecutorBuilder</code>任务执行建造者，在下方的<code>applicationTaskExecutor</code>方法里获取这个<code>TaskExecutorBuilder</code>任务执行建造者，然后调用<code> builder.build()</code>方法，返回<code>ThreadPoolTaskExecutor</code>，因此容器中放的是<code>ThreadPoolTaskExecutor</code>线程池</p><p>（定时任务的自动配置为<code>TaskSchedulingAutoConfiguration</code>任务调度自动配置，异步线程池的自动配置为<code>TaskExecutionAutoConfiguration</code>任务执行自动配置）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">TaskExecutorBuilder</span> <span class="token function">taskExecutorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">TaskExecutionProperties<span class="token punctuation">.</span>Pool</span> pool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">TaskExecutorBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">queueCapacity</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">corePoolSize</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">getCoreSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">maxPoolSize</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">getMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">allowCoreThreadTimeOut</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">isAllowCoreThreadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">keepAlive</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">getKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">threadNamePrefix</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getThreadNamePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">customizers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskExecutorCustomizers<span class="token punctuation">)</span><span class="token punctuation">;</span>
   builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">taskDecorator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskDecorator<span class="token punctuation">.</span><span class="token function">getIfUnique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> builder<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Lazy</span>
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token constant">APPLICATION_TASK_EXECUTOR_BEAN_NAME</span><span class="token punctuation">,</span>
      <span class="token class-name">AsyncAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_TASK_EXECUTOR_BEAN_NAME</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolTaskExecutor</span> <span class="token function">applicationTaskExecutor</span><span class="token punctuation">(</span><span class="token class-name">TaskExecutorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.1.png" alt="image-20220823163150679" tabindex="0" loading="lazy"><figcaption>image-20220823163150679</figcaption></figure><h5 id="_2、threadpooltaskexecutor继承关系" tabindex="-1"><a class="header-anchor" href="#_2、threadpooltaskexecutor继承关系" aria-hidden="true">#</a> 2、<code>ThreadPoolTaskExecutor</code>继承关系</h5><p><code>ThreadPoolTaskExecutor</code>类的继承关系如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.2.1.png" alt="image-20230106161740731" tabindex="0" loading="lazy"><figcaption>image-20230106161740731</figcaption></figure><p>点击<code>ThreadPoolTaskExecutor</code>类可以看到其实现了<code>AsyncListenableTaskExecutor</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolTaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ExecutorConfigurationSupport</span>
		<span class="token keyword">implements</span> <span class="token class-name">AsyncListenableTaskExecutor</span><span class="token punctuation">,</span> <span class="token class-name">SchedulingTaskExecutor</span>
		
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AsyncListenableTaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTaskExecutor</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AsyncTaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">TaskExecutor</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">Executor</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Executor</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.2.2.png" alt="image-20220823163522592" tabindex="0" loading="lazy"><figcaption>image-20220823163522592</figcaption></figure><p>点击<code>AsyncListenableTaskExecutor</code>接口，可以看到其继承了<code>AsyncTaskExecutor</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.2.3.png" alt="image-20220823163532548" tabindex="0" loading="lazy"><figcaption>image-20220823163532548</figcaption></figure><p>点击<code>AsyncTaskExecutor</code>接口，可以看到其继承了<code>TaskExecutor</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.2.4.png" alt="image-20220823163536360" tabindex="0" loading="lazy"><figcaption>image-20220823163536360</figcaption></figure><p>点击<code>TaskExecutor</code>接口，可以看到其继承了<code>Executor</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.2.5.png" alt="image-20220823163541582" tabindex="0" loading="lazy"><figcaption>image-20220823163541582</figcaption></figure><p>点击<code>Executor</code>接口，可以看到这个接口是<code>jdk</code>自带的<code>java.util.concurrent.Executor</code>类</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.2.6.png" alt="image-20220823163544520" tabindex="0" loading="lazy"><figcaption>image-20220823163544520</figcaption></figure><h5 id="_3、修改配置" tabindex="-1"><a class="header-anchor" href="#_3、修改配置" aria-hidden="true">#</a> 3、修改配置</h5><p>默认核心线程大小是<code>8</code>，但是最大线程数和队列长度都是<code>Integer.MAX_VALUE</code>，这样的话到时候并发上来了肯定撑不住这么多线程的。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.3.1.png" alt="image-20220823164048721" tabindex="0" loading="lazy"><figcaption>image-20220823164048721</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>配置文件里，修改<code>核心线程数</code>和<code>最大线程数</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.task.execution.pool.core-size</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token key attr-name">spring.task.execution.pool.max-size</span><span class="token punctuation">=</span><span class="token value attr-value">50</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.3.2.png" alt="image-20220823164333075" tabindex="0" loading="lazy"><figcaption>image-20220823164333075</figcaption></figure><p>删除<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.GulimallSeckillApplication</code>类上的<code>@EnableAsync</code>注解</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.3.3.png" alt="image-20220823164821069" tabindex="0" loading="lazy"><figcaption>image-20220823164821069</figcaption></figure><p>删除<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.HelloSchedule</code>类上的<code>@EnableScheduling</code>注解</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.5.3.4.png" alt="image-20220823164823629" tabindex="0" loading="lazy"><figcaption>image-20220823164823629</figcaption></figure><h4 id="_6、执行定时任务" tabindex="-1"><a class="header-anchor" href="#_6、执行定时任务" aria-hidden="true">#</a> 6、执行定时任务</h4><h5 id="_1、将最近3天需要秒杀的商品添加到redis" tabindex="-1"><a class="header-anchor" href="#_1、将最近3天需要秒杀的商品添加到redis" aria-hidden="true">#</a> 1、将最近3天需要秒杀的商品添加到redis</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包里新建<code>config</code>文件夹，在<code>config</code>文件夹里新建<code>ScheduledConfig</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableAsync</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableScheduling</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableScheduling</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.1.1.png" alt="image-20220823165012347" tabindex="0" loading="lazy"><figcaption>image-20220823165012347</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled</code>包里新建<code>SeckillSkuScheduled</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>scheduled</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 * 秒杀商品的定时上架;
 * 每天晚上3点;上架最近三天需要秒杀的商品。
 *   当天00:00:00 - 23:59:59
 *   明天00:00:00 - 23:59:59
 *   后天00:00:00 - 23:59:59
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSkuScheduled</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">SeckillService</span> seckillService<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 每天晚上3点,上架最近3天需要秒杀的商品
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 0 3 * * ?&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1、重复上架无需处理</span>
        seckillService<span class="token punctuation">.</span><span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.1.2.png" alt="image-20220823165846917" tabindex="0" loading="lazy"><figcaption>image-20220823165846917</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包里新建<code>service</code>文件夹，在<code>service</code>文件夹里新建<code>SeckillService</code>接口，在该接口里添加<code>uploadSeckillSkuLatest3Days</code>抽象方法用户获取最近<code>3</code>天需要秒杀的商品</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 上架最近3天需要秒杀的商品
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.1.3.png" alt="image-20220823165941772" tabindex="0" loading="lazy"><figcaption>image-20220823165941772</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service</code>包里新建<code>impl</code>文件夹，在<code>impl</code>文件夹里新建<code>SeckillServiceImpl</code>类，在该类里实现<code>uploadSeckillSkuLatest3Days</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SeckillService</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.扫描需要参与秒杀的活动</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.1.4.png" alt="image-20220823170120090" tabindex="0" loading="lazy"><figcaption>image-20220823170120090</figcaption></figure><h5 id="_2、远程获取秒杀活动场次" tabindex="-1"><a class="header-anchor" href="#_2、远程获取秒杀活动场次" aria-hidden="true">#</a> 2、远程获取秒杀活动场次</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.GulimallSeckillApplication</code>类上添加<code>@EnableFeignClients</code>注解，用于开启<code>Feign</code>的远程调用功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.2.1.png" alt="image-20220823170152658" tabindex="0" loading="lazy"><figcaption>image-20220823170152658</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包里新建<code>feign</code>文件夹，在<code>feign</code>文件夹里新建<code>CouponFeignService</code>接口，用于远程调用优惠模块</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-coupon&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponFeignService</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.2.2.png" alt="image-20220823185509399" tabindex="0" loading="lazy"><figcaption>image-20220823185509399</figcaption></figure><p>在<code>gulimall-coupon</code>模块的<code>com.atguigu.gulimall.coupon.controller.SeckillSessionController</code>类里添加<code>getLatest3DaySession</code>方法，用于获取最近3天的秒杀活动场次信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/latest3DaySession&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> seckillSessionService<span class="token punctuation">.</span><span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>sessions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.2.3.png" alt="image-20220823170817519" tabindex="0" loading="lazy"><figcaption>image-20220823170817519</figcaption></figure><p>在<code>gulimall-coupon</code>模块的<code>com.atguigu.gulimall.coupon.service.SeckillSessionService</code>接口里添加<code>getLatest3DaySession</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.2.4.png" alt="image-20220823170900023" tabindex="0" loading="lazy"><figcaption>image-20220823170900023</figcaption></figure><p>在<code>gulimall_sms</code>数据库里执行如下sql，可以看到已经成功获取到最近3天的秒杀场次信息了</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>select * from sms_seckill_session where start_time between &#39;2022-08-23 00:00:00&#39; and &#39;2022-08-25 23:59:59&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.2.5.png" alt="image-20220823171438483" tabindex="0" loading="lazy"><figcaption>image-20220823171438483</figcaption></figure><h5 id="_3、测试日期" tabindex="-1"><a class="header-anchor" href="#_3、测试日期" aria-hidden="true">#</a> 3、测试日期</h5><p>修改<code>gulimall-coupon</code>模块的<code>com.atguigu.gulimall.coupon.GulimallCouponApplicationTests</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>coupon</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalTime</span></span><span class="token punctuation">;</span>

<span class="token comment">//@RunWith(SpringRunner.class)</span>
<span class="token comment">//@SpringBootTest(classes = GulimallCouponApplication.class)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallCouponApplicationTests</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">LocalDate</span> now <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">LocalDate</span> plus2 <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>plus2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=============================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">LocalTime</span> min <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token constant">MIN</span><span class="token punctuation">;</span>
      <span class="token class-name">LocalTime</span> max <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token constant">MAX</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>min<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=============================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">LocalDateTime</span> nowDateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">LocalDateTime</span> plus2DateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>plus2<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>nowDateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>plus2DateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=============================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.3.1.png" alt="image-20220823172547340" tabindex="0" loading="lazy"><figcaption>image-20220823172547340</figcaption></figure><p>执行该类的<code>contextLoads</code>测试方法，可以看到如下输出，这里已经成功计算了时间范围，只是时间格式不符合国人审美，如果不要紧，反正又不用看这时间，只要秒杀的活动场次日期在这两个日期的范围之内即可。当然格式化也行，反正也不难。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-23
<span class="token number">2022</span>-08-25
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
00:00
<span class="token number">23</span>:59:59.999999999
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">2022</span>-08-23T00:00
<span class="token number">2022</span>-08-25T23:59:59.999999999
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.3.2.png" alt="image-20220823172550405" tabindex="0" loading="lazy"><figcaption>image-20220823172550405</figcaption></figure><h5 id="_4、实现getlatest3daysession" tabindex="-1"><a class="header-anchor" href="#_4、实现getlatest3daysession" aria-hidden="true">#</a> 4、实现getLatest3DaySession</h5><p>在<code>gulimall-coupon</code>模块的<code>com.atguigu.gulimall.coupon.service.impl.SeckillSessionServiceImpl</code>类里，添加<code>startTime</code>方法和<code>endTime</code>方法，修改<code>getLatest3DaySession</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">SeckillSessionEntity</span><span class="token operator">::</span><span class="token function">getStartTime</span><span class="token punctuation">,</span><span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">endTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">LocalDateTime</span> start <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token constant">MIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> start<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">endTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">LocalDateTime</span> endTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token constant">MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> endTime<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.4.1.png" alt="image-20220823184155523" tabindex="0" loading="lazy"><figcaption>image-20220823184155523</figcaption></figure><p>在<code>gulimall-coupon</code>模块的<code>com.atguigu.gulimall.coupon.entity.SeckillSessionEntity</code>类里添加如下字段。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRelationEntity</span><span class="token punctuation">&gt;</span></span> relationSkus<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.4.2.png" alt="image-20220823184504005" tabindex="0" loading="lazy"><figcaption>image-20220823184504005</figcaption></figure><p>在<code>gulimall-coupon</code>模块的<code>com.atguigu.gulimall.coupon.service.impl.SeckillSessionServiceImpl</code>类里，修改<code>getLatest3DaySession</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">SeckillSkuRelationService</span> seckillSkuRelationService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">SeckillSessionEntity</span><span class="token operator">::</span><span class="token function">getStartTime</span><span class="token punctuation">,</span><span class="token function">startTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">endTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>seckillSessionEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> seckillSessionEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRelationEntity</span><span class="token punctuation">&gt;</span></span> skuRelationQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuRelationQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SeckillSkuRelationEntity</span><span class="token operator">::</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRelationEntity</span><span class="token punctuation">&gt;</span></span> skuRelationEntities <span class="token operator">=</span> seckillSkuRelationService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>skuRelationQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillSessionEntity<span class="token punctuation">.</span><span class="token function">setRelationSkus</span><span class="token punctuation">(</span>skuRelationEntities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> seckillSessionEntity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.4.3.png" alt="image-20220823185300381" tabindex="0" loading="lazy"><figcaption>image-20220823185300381</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.feign.CouponFeignService</code>接口里，添加<code>getLatest3DaySession</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/coupon/seckillsession/latest3DaySession&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.4.4.png" alt="image-20220823185608694" tabindex="0" loading="lazy"><figcaption>image-20220823185608694</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包里新建<code>vo</code>文件夹，在<code>vo</code>文件夹里添加<code>SeckillSessionSkusVo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSessionSkusVo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 场次名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 每日开始时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> startTime<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 每日结束时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> endTime<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 启用状态
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 创建时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRelationVo</span><span class="token punctuation">&gt;</span></span> relationSkus<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSkuRelationVo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 活动id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> promotionId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 活动场次id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> promotionSessionId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 商品id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 秒杀价格
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> seckillPrice<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 秒杀总量
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> seckillCount<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 每人限购数量
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> seckillLimit<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 排序
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Integer</span> seckillSort<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.4.5.png" alt="image-20220823191307090" tabindex="0" loading="lazy"><figcaption>image-20220823191307090</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.utils.R</code>类里添加如下代码</p><p><a href="code/7.1.2.6.4.R.java">点击查看R类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDataArray</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> tTypeReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>tTypeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.4.6.png" alt="image-20220823193539875" tabindex="0" loading="lazy"><figcaption>image-20220823193539875</figcaption></figure><h5 id="_5、添加savesessioninfos" tabindex="-1"><a class="header-anchor" href="#_5、添加savesessioninfos" aria-hidden="true">#</a> 5、添加<code>saveSessionInfos</code></h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里添加<code>saveSessionInfos</code>方法，修改<code>uploadSeckillSkuLatest3Days</code>方法</p><p><a href="code/7.1.2.6.5.SeckillServiceImpl.java">点击查看完整SeckillServiceImpl类代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.扫描需要参与秒杀的活动</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> couponFeignService<span class="token punctuation">.</span><span class="token function">getLatest3DaySession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//上架商品</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionSkusVo</span><span class="token punctuation">&gt;</span></span> sessionSkusVos <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getDataArray</span><span class="token punctuation">(</span><span class="token class-name">SeckillSessionSkusVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓存活动信息</span>
        <span class="token function">saveSessionInfos</span><span class="token punctuation">(</span>sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓存活动的关联商品信息</span>
        <span class="token function">saveSessionSkuInfos</span><span class="token punctuation">(</span>sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSessionInfos</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionSkusVo</span><span class="token punctuation">&gt;</span></span> sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sessionSkusVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>session<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">SESSIONS_CACHE_PREFIX</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> end<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓存活动信息</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.5.1.png" alt="image-20220823203841311" tabindex="0" loading="lazy"><figcaption>image-20220823203841311</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包里新建<code>to</code>文件夹，在<code>to</code>文件夹里新建<code>SeckillSkuRedisTo</code>类</p><p><a href="code/7.1.2.6.5.SeckillSkuRedisTo.java">点击查看完整SeckillSkuRedisTo类代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.5.2.png" alt="image-20220824102402560" tabindex="0" loading="lazy"><figcaption>image-20220824102402560</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.SkuInfoController</code>类里，已经有一个查询商品信息的<code>info</code>方法了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.5.3.png" alt="image-20220823210922935" tabindex="0" loading="lazy"><figcaption>image-20220823210922935</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.feign</code>包里新建<code>ProductFeignService</code>接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/23
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/skuinfo/info/{skuId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.5.4.png" alt="image-20220823211310200" tabindex="0" loading="lazy"><figcaption>image-20220823211310200</figcaption></figure><p>修改<code>gulimall-common</code>模块的<code>com.atguigu.common.utils.R</code>类，添加<code>get(String key,Class&lt;T&gt; clazz)</code>、<code>getArray(String key,Class&lt;T&gt; clazz)</code>、<code>getObjectStr(String key)</code>等方法，修改<code>getData(Class&lt;T&gt; clazz)</code>、<code>getDataArray(Class&lt;T&gt; clazz)</code>、<code>getData(TypeReference&lt;T&gt; tTypeReference)</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.5.5.png" alt="image-20220824100038799" tabindex="0" loading="lazy"><figcaption>image-20220824100038799</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里修改<code>saveSessionSkuInfos</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ProductFeignService</span> productFeignService<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SKUKILL_CACHE_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;seckill:skus:&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSessionSkuInfos</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionSkusVo</span><span class="token punctuation">&gt;</span></span> sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> seckillSkuInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionSkusVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>session<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
                seckillSkuRelationVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>seckillSkuRelationVo<span class="token punctuation">,</span>seckillSkuRedisTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSkuInfo</span><span class="token punctuation">(</span>seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token class-name">SeckillSkuRedisTo<span class="token punctuation">.</span>SkuInfoVo</span> skuInfoVo <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;skuInfo&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo<span class="token punctuation">.</span>SkuInfoVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setSkuInfoVo</span><span class="token punctuation">(</span>skuInfoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//设置开始和结束时间</span>
                    seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//设置随机码（只有秒杀开始的那一刻，才暴露随机码）（防止活动还没开始就准备好脚本，开始时直接抢购）</span>
                    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setRandomCode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> seckillSkuRedisTo<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token operator">::</span><span class="token function">toJSONString</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillSkuInfos<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>seckillSkuInfos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.2.6.5.6.png" alt="image-20220824103400442" tabindex="0" loading="lazy"><figcaption>image-20220824103400442</figcaption></figure><h3 id="_7-1-3、分布式信号量" tabindex="-1"><a class="header-anchor" href="#_7-1-3、分布式信号量" aria-hidden="true">#</a> 7.1.3、分布式信号量</h3><h4 id="_1、引入redisson" tabindex="-1"><a class="header-anchor" href="#_1、引入redisson" aria-hidden="true">#</a> 1、引入<code>redisson</code></h4><h5 id="_1、添加依赖和配置" tabindex="-1"><a class="header-anchor" href="#_1、添加依赖和配置" aria-hidden="true">#</a> 1、添加依赖和配置</h5><p>由于秒杀的请求量大，不可能查数据库，因此可以使用分布式信号量机制。</p><p>在<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里添加如下依赖，引入<code>redisson</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 引入redisson，做分布式锁和分布式对象 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.12.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.1.1.png" alt="image-20220824103639370" tabindex="0" loading="lazy"><figcaption>image-20220824103639370</figcaption></figure><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.MyRedissonConfig</code>类，到<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.config</code>包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span></span><span class="token class-name">Redisson</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Config</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedissonConfig</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 所有对Redisson的使用都是通过RedissonClient对象
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod<span class="token operator">=</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、创建配置</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Redis url should start with redis:// or rediss:// (for SSL connection)</span>
        <span class="token comment">//config.useSingleServer().setAddress(&quot;192.168.56.10:6379&quot;).setPassword(&quot;&quot;);</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.56.10:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2、根据Config创建出RedissonClient示例</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.1.2.png" alt="image-20220824103755664" tabindex="0" loading="lazy"><figcaption>image-20220824103755664</figcaption></figure><h5 id="_2、使用redisson" tabindex="-1"><a class="header-anchor" href="#_2、使用redisson" aria-hidden="true">#</a> 2、使用<code>redisson</code></h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里修改<code>saveSessionSkuInfos</code>方法，在<code>seckillSkuRedisTo.setRandomCode(token);</code>这行下面加上<code>使用分布式信号量限流</code>的相关代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SKUKILL_CACHE_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;seckill:skus:&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//使用分布式信号量限流</span>
<span class="token comment">//信号量的key为`前缀+token`    value为商品的库存</span>
<span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token constant">SKU_STOCK_SEMAPHORE</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
semaphore<span class="token punctuation">.</span><span class="token function">trySetPermits</span><span class="token punctuation">(</span>seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSeckillSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.2.png" alt="image-20220824105240671" tabindex="0" loading="lazy"><figcaption>image-20220824105240671</figcaption></figure><h5 id="_3、准备测试" tabindex="-1"><a class="header-anchor" href="#_3、准备测试" aria-hidden="true">#</a> 3、准备测试</h5><p>修改<code>gulimall_sms</code>数据库的<code>sms_seckill_session</code>表，修改这两场秒杀商品的开始时间和结束时间，将第一个秒杀场次设为当前时间之后的近三天的时间，第二个秒杀场次设为当前时间之前的时间</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.3.1.png" alt="image-20220824105137257" tabindex="0" loading="lazy"><figcaption>image-20220824105137257</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.SeckillSkuScheduled</code>类里修改<code>uploadSeckillSkuLatest3Days</code>方法，将<code>@Scheduled(cron = &quot;0 0 3 * * ?&quot;)</code>修改为<code>@Scheduled(cron = &quot;0 * * * * ?&quot;)</code>（秒为<code>0</code>时执行一次，即每分钟执行一次），并添加<code>log.info(&quot;上架秒杀的商品信息...&quot;);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 每天晚上3点,上架最近3天需要秒杀的商品
 */</span>
<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 * * * * ?&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//1、重复上架无需处理</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;上架秒杀的商品信息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillService<span class="token punctuation">.</span><span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.3.2.png" alt="image-20220824110210600" tabindex="0" loading="lazy"><figcaption>image-20220824110210600</figcaption></figure><p>修改<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.HelloSchedule</code>类的<code>hello</code>方法上的注解，将<code>@Scheduled(cron = &quot;* * * ? * 2&quot;)</code>里的<code>2</code>修改为<code>*</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Async</span>
<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;* * * ? * *&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;hello...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.3.3.png" alt="image-20220824110516106" tabindex="0" loading="lazy"><figcaption>image-20220824110516106</figcaption></figure><h5 id="_4、测试" tabindex="-1"><a class="header-anchor" href="#_4、测试" aria-hidden="true">#</a> 4、测试</h5><p>重启<code>GulimallSeckillApplication</code>服务和<code>GulimallCouponApplication</code>服务</p><p>提示<code>SeckillSkuScheduled</code>类里注入<code>SeckillService</code>失败，在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类上加个<code>@Service</code>注解就好了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Error starting ApplicationContext. To display the conditions report re-run your application with <span class="token string">&#39;debug&#39;</span> enabled.
<span class="token number">2022</span>-08-24 <span class="token number">10</span>:58:56.436 ERROR <span class="token number">9896</span> --- <span class="token punctuation">[</span>  restartedMain<span class="token punctuation">]</span> o.s.b.d.LoggingFailureAnalysisReporter   <span class="token builtin class-name">:</span> 

***************************
APPLICATION FAILED TO START
***************************

Description:

Field seckillService <span class="token keyword">in</span> com.atguigu.gulimall.seckill.scheduled.SeckillSkuScheduled required a bean of <span class="token builtin class-name">type</span> <span class="token string">&#39;com.atguigu.gulimall.seckill.service.SeckillService&#39;</span> that could not be found.

The injection point has the following annotations:
	- @org.springframework.beans.factory.annotation.Autowired<span class="token punctuation">(</span>required<span class="token operator">=</span>true<span class="token punctuation">)</span>


Action:

Consider defining a bean of <span class="token builtin class-name">type</span> <span class="token string">&#39;com.atguigu.gulimall.seckill.service.SeckillService&#39;</span> <span class="token keyword">in</span> your configuration.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.4.1.png" alt="image-20220824110044069" tabindex="0" loading="lazy"><figcaption>image-20220824110044069</figcaption></figure><p>重启<code>GulimallSeckillApplication</code>服务，只让<code>上架秒杀的商品信息</code>的定时任务执行一次，然后立马关掉<code>GulimallSeckillApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.4.2.png" alt="image-20220824111122825" tabindex="0" loading="lazy"><figcaption>image-20220824111122825</figcaption></figure><p>查看<code>redis</code>里<code>seckill:sessions:</code>的信息，可以看到<code>2022-08-26 00:00:00</code>点秒杀场次的<code>商品id</code>已经显示出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.4.3.png" alt="image-20220824111233658" tabindex="0" loading="lazy"><figcaption>image-20220824111233658</figcaption></figure><p>打开 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，点击开始时间为<code>2022-08-26 00:00:00</code>的这个场次的操作里的<code>关联商品</code>，在<code>关联秒杀商品</code>弹出框里可以看到<code>商品id</code>与<code>redis</code>里的存储的秒杀商品的值一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.4.4.png" alt="image-20220824112717946" tabindex="0" loading="lazy"><figcaption>image-20220824112717946</figcaption></figure><p>查看<code>redis</code>里<code>seckill:skus:</code>的信息，成功查询到了2个促销信息和关联的商品信息（这里应该有3个促销信息的，因为2个活动总共有3款促销，但其中两款促销是同一种商品，由于使用的是<code>seckill:skus:</code>+<code>SkuId</code>作为<code>key</code>，因此这两款相同商品的促销信息只保存了一份，因此只有两个促销信息）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.4.5.png" alt="image-20220824111236341" tabindex="0" loading="lazy"><figcaption>image-20220824111236341</figcaption></figure><p>查看<code>redis</code>里<code>seckill:stock:</code>的信息，发现这个库存有问题，所有的库存都为<code>1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.4.6.png" alt="image-20220824111238837" tabindex="0" loading="lazy"><figcaption>image-20220824111238837</figcaption></figure><h5 id="_5、修改代码重新测试" tabindex="-1"><a class="header-anchor" href="#_5、修改代码重新测试" aria-hidden="true">#</a> 5、修改代码重新测试</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类的<code>saveSessionSkuInfos</code>方法里，把<code>semaphore.trySetPermits(seckillSkuRelationVo.getSeckillSort()):</code>修改为<code>semaphore.trySetPermits(seckillSkuRelationVo.getSeckillCount().intValue());</code>。应该设为商品库存的，这里不小心设成排序字段了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.1.png" alt="image-20220824113333439" tabindex="0" loading="lazy"><figcaption>image-20220824113333439</figcaption></figure><p>删除删除<code>redis</code>里前缀为<code>seckill</code>的数据，重新运行<code>GulimallSeckillApplication</code>服务，只让<code>上架秒杀的商品信息</code>的定时任务执行一次，然后关闭<code>GulimallSeckillApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.2.png" alt="image-20220824113140143" tabindex="0" loading="lazy"><figcaption>image-20220824113140143</figcaption></figure><p>查看<code>redis</code>里<code>seckill:stock:</code>的信息，可以看到秒杀总量已经正常了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.3.png" alt="image-20220824113434386" tabindex="0" loading="lazy"><figcaption>image-20220824113434386</figcaption></figure><p>打开 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，点击开始时间为<code>2022-08-26 00:00:00</code>的这个场次的操作里的<code>关联商品</code>，在<code>关联秒杀商品</code>弹出框里可以看到<code>秒杀总量</code>与<code>redis</code>里存储的秒杀总量的值一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.4.png" alt="image-20220824113456618" tabindex="0" loading="lazy"><figcaption>image-20220824113456618</figcaption></figure><p>如果让<code>上架秒杀的商品信息</code>的定时任务执行两次，可以看到在<code>redis</code>里的<code>seckill:sessions:</code>里，<code>seckill:sessions:1661472000000_1661479200000</code>里有<code>4</code>条数据，而其实多次上架应该也还是<code>2</code>条，应该覆盖旧的数据而不是添加新的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.5.png" alt="image-20220824113932773" tabindex="0" loading="lazy"><figcaption>image-20220824113932773</figcaption></figure><p>而在<code>redis</code>里的<code>seckill:skus:</code>里，使用的是<code>map</code>，所以没啥影响</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.6.png" alt="image-20220824113953199" tabindex="0" loading="lazy"><figcaption>image-20220824113953199</figcaption></figure><p>在<code>redis</code>里的<code>seckill:stock:</code>里有<code>6</code>条数据，而其实应该有<code>3</code>条数据，商品库存信息也应该是覆盖而不是添加</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.1.5.7.png" alt="image-20220824113934918" tabindex="0" loading="lazy"><figcaption>image-20220824113934918</figcaption></figure><h4 id="_2、定时任务-分布式下的问题" tabindex="-1"><a class="header-anchor" href="#_2、定时任务-分布式下的问题" aria-hidden="true">#</a> 2、定时任务-分布式下的问题</h4><p>有可能多台机器同时执行定时任务，因此可以加一个分布式锁，只让一个机器执行，执行完后，别的机器判断该定时任务是否已经完成，如果已经做了，就不再向<code>redis</code>里保存数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.0.png" alt="image-20220824114752543" tabindex="0" loading="lazy"><figcaption>image-20220824114752543</figcaption></figure><h5 id="_1、修改代码" tabindex="-1"><a class="header-anchor" href="#_1、修改代码" aria-hidden="true">#</a> 1、修改代码</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.SeckillSkuScheduled</code>类里修改<code>uploadSeckillSkuLatest3Days</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> upload_lock <span class="token operator">=</span> <span class="token string">&quot;seckill:upload:lock&quot;</span><span class="token punctuation">;</span>


<span class="token doc-comment comment">/**
 * 每天晚上3点,上架最近3天需要秒杀的商品
 */</span>
<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 * * * * ?&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//1、重复上架无需处理</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;上架秒杀的商品信息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>upload_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        seckillService<span class="token punctuation">.</span><span class="token function">uploadSeckillSkuLatest3Days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.1.1.png" alt="image-20220824115401241" tabindex="0" loading="lazy"><figcaption>image-20220824115401241</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里，修改<code>saveSessionInfos</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSessionInfos</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionSkusVo</span><span class="token punctuation">&gt;</span></span> sessionSkusVos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sessionSkusVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>session <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">SESSIONS_CACHE_PREFIX</span> <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> end<span class="token punctuation">;</span>
        <span class="token comment">//缓存活动信息</span>
        <span class="token class-name">Boolean</span> hasKey <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>hasKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leftPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.1.2.png" alt="image-20220824153409609" tabindex="0" loading="lazy"><figcaption>image-20220824153409609</figcaption></figure><p>（但是我感觉这有问题，有可能2个活动都上架了该商品，这两个都应该设置不同的促销信息和库存，而这个库存是判断skuId存不存在 因此不同活动不能上架同一款商品，我觉得应该放skuId+活动时间/随机码，这样才能区分是哪个活动，才能让不同的活动上架同一款商品，保证每个活动的促销信息和库存不一样）</p><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里，再次修改<code>saveSessionInfos</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSessionSkuInfos</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSessionSkusVo</span><span class="token punctuation">&gt;</span></span> sessionSkusVos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>sessionSkusVos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sessionSkusVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>session <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>seckillSkuRelationVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> skuKey <span class="token operator">=</span> seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Boolean</span> hasSkuKey <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>skuKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasSkuKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>hasSkuKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>seckillSkuRelationVo<span class="token punctuation">,</span> seckillSkuRedisTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSkuInfo</span><span class="token punctuation">(</span>seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SeckillSkuRedisTo<span class="token punctuation">.</span>SkuInfoVo</span> skuInfoVo <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;skuInfo&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo<span class="token punctuation">.</span>SkuInfoVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setSkuInfoVo</span><span class="token punctuation">(</span>skuInfoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//设置开始和结束时间</span>
                seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置随机码（只有秒杀开始的那一刻，才暴露随机码）（防止活动还没开始就准备好脚本，开始时直接抢购）</span>
                <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setRandomCode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                operations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>seckillSkuRedisTo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//使用分布式信号量限流（只有上架了商品，才有库存信息）</span>
                <span class="token comment">//（但是我感觉这有问题，有可能2个活动都上架了该商品，这两个都应该设置不同的促销信息和库存，而这个库存是判断skuId存不存在</span>
                <span class="token comment">// 因此不同活动不能上架同一款商品，我觉得应该放skuId+活动时间/随机码，这样才能区分是哪个活动，才能让不同的活动上架同一款商品，保证每个活动的促销信息和库存不一样）</span>
                <span class="token comment">//信号量的key为`前缀+token`    value为商品的库存</span>
                <span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token constant">SKU_STOCK_SEMAPHORE</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                semaphore<span class="token punctuation">.</span><span class="token function">trySetPermits</span><span class="token punctuation">(</span>seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSeckillCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.1.3.png" alt="image-20220824155345831" tabindex="0" loading="lazy"><figcaption>image-20220824155345831</figcaption></figure><h5 id="_2、测试" tabindex="-1"><a class="header-anchor" href="#_2、测试" aria-hidden="true">#</a> 2、测试</h5><p>删除<code>redis</code>里以<code>seckill</code>开头的数据，重启<code>GulimallSeckillApplication</code>服务，让<code>上架秒杀的商品信息</code>的定时任务执行多次</p><p>可以看到<code>seckill:sessions:</code>里多次执行<code>上架秒杀的商品信息</code>的定时任务后并没有多次添加了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.2.1.png" alt="image-20220824155611328" tabindex="0" loading="lazy"><figcaption>image-20220824155611328</figcaption></figure><p><code>seckill:skus:</code>里还是两个商品数据（这里应该有3个促销信息的，因为2个活动总共有3款促销，但其中两款促销是同一种商品，由于使用的是<code>seckill:skus:</code>+<code>SkuId</code>作为<code>key</code>，因此这两款相同商品的促销信息只保存了一份，因此只有两个促销信息）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.2.2.png" alt="image-20220824155603814" tabindex="0" loading="lazy"><figcaption>image-20220824155603814</figcaption></figure><p>在<code>seckill:stock:</code>里多次执行<code>上架秒杀的商品信息</code>的定时任务后也没有多次添加了，但此时只有<code>2</code>条数据了，而原本应该有3条的。原先由于多次促销信息的<code>randomCode</code>随机码不一样，因此可以保存多次。而现在使用的是<code>seckill:skus:</code>+<code>SkuId</code>作为<code>key</code>，即使是不同的促销活动的相同sku，如果该key存在了也不执行向<code>redis</code>里添加库存的操作了，因此<code>seckill:skus:</code>和<code>seckill:stock:</code>里的数据数量是一样的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.2.3.png" alt="image-20220824155606181" tabindex="0" loading="lazy"><figcaption>image-20220824155606181</figcaption></figure><h5 id="_3、修改代码后再次测试" tabindex="-1"><a class="header-anchor" href="#_3、修改代码后再次测试" aria-hidden="true">#</a> 3、修改代码后再次测试</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里，修改<code>saveSessionInfos</code>方法</p><p>将</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> skuKey <span class="token operator">=</span> seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>替换为</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> skuKey <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>用于区分不同活动的促销信息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.3.1.png" alt="image-20230109100345358" tabindex="0" loading="lazy"><figcaption>image-20230109100345358</figcaption></figure><p>可以看到<code>seckill:sessions:</code>里多次执行<code>上架秒杀的商品信息</code>的定时任务后并没有多次添加了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.3.2.png" alt="image-20220824161802227" tabindex="0" loading="lazy"><figcaption>image-20220824161802227</figcaption></figure><p><code>seckill:skus:</code>里变为了<code>3</code>个商品数据（因为使用<code>session.getStartTime().getTime() +&quot;_&quot;+ seckillSkuRelationVo.getSkuId().toString();</code>作为<code>key</code>即<code>开始时间id+商品id</code>，即使这两款是相同商品，只要场次不一样，还是分开保存的）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.3.3.png" alt="image-20220824161804685" tabindex="0" loading="lazy"><figcaption>image-20220824161804685</figcaption></figure><p>在<code>seckill:stock:</code>里多次执行<code>上架秒杀的商品信息</code>的定时任务后也没有多次添加了，而且也是正确的<code>3</code>条数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.3.4.png" alt="image-20220824161806803" tabindex="0" loading="lazy"><figcaption>image-20220824161806803</figcaption></figure><h5 id="_4、修改为老师所用的id" tabindex="-1"><a class="header-anchor" href="#_4、修改为老师所用的id" aria-hidden="true">#</a> 4、修改为老师所用的id</h5><p>我用的是<code>开始时间id+商品id</code>，老师用的是<code>场次id+商品id</code></p><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里，修改<code>saveSessionInfos</code>方法</p><p>把</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> skuKey <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>改为</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> skuKey <span class="token operator">=</span> seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> seckillSkuRelationVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>效果都一样，不过老师讲的方法显得更清晰一些</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.4.1.png" alt="image-20220824162159051" tabindex="0" loading="lazy"><figcaption>image-20220824162159051</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里，修改<code>saveSessionInfos</code>方法</p><p>把</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>List&lt;String&gt; values = session.getRelationSkus().stream()
	.map(item -&gt; item.getSkuId().toString()).collect(Collectors.toList());
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>改为，为了更好区分一下</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>List&lt;String&gt; values = session.getRelationSkus().stream()
	.map(item -&gt;item.getPromotionSessionId().toString()+&quot;_&quot;+ item.getSkuId().toString())
	.collect(Collectors.toList());
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="code/7.1.3.2.4.SeckillServiceImpl.java">点击查看SeckillServiceImpl类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.4.2.png" alt="image-20220824162740947" tabindex="0" loading="lazy"><figcaption>image-20220824162740947</figcaption></figure><p>删除<code>redis</code>里以<code>seckill</code>开头的数据，重启<code>GulimallSeckillApplication</code>服务，再让<code>上架秒杀的商品信息</code>的定时任务执行多次</p><p>可以看到<code>seckill:sessions:</code>里多次执行<code>上架秒杀的商品信息</code>的定时任务后并没有多次添加了，而且也更容易区分场次信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.4.3.png" alt="image-20220824163040808" tabindex="0" loading="lazy"><figcaption>image-20220824163040808</figcaption></figure><p><code>seckill:skus:</code>里变为了<code>3</code>个商品数据（因为使用<code>seckillSkuRelationVo.getPromotionSessionId().toString() +&quot;_&quot;+ seckillSkuRelationVo.getSkuId().toString();</code>作为<code>key</code>即<code>场次id+商品id</code>，即使这两款是相同商品，只要场次不一样，还是分开保存的）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.4.4.png" alt="image-20220824163042716" tabindex="0" loading="lazy"><figcaption>image-20220824163042716</figcaption></figure><p>在<code>seckill:stock:</code>里多次执行<code>上架秒杀的商品信息</code>的定时任务后也没有多次添加了，而且也是正确的<code>3</code>条数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.2.4.5.png" alt="image-20220824163045199" tabindex="0" loading="lazy"><figcaption>image-20220824163045199</figcaption></figure><p>都设置好了，不过好像都没设置过期时间</p><h4 id="_3、获取当前秒杀商品" tabindex="-1"><a class="header-anchor" href="#_3、获取当前秒杀商品" aria-hidden="true">#</a> 3、获取当前秒杀商品</h4><h5 id="_1、添加getcurrentseckillskus方法" tabindex="-1"><a class="header-anchor" href="#_1、添加getcurrentseckillskus方法" aria-hidden="true">#</a> 1、添加getCurrentSeckillSkus方法</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包里添加<code>controller</code>文件夹，在<code>controller</code>文件夹里新建<code>SeckillController</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SeckillService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>to<span class="token punctuation">.</span></span><span class="token class-name">SeckillSkuRedisTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/24
 * @Description:
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">SeckillService</span> seckillService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 返回当前时间可以参与的秒杀商品信息
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/currentSeckillSkus&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> vos <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.1.1.png" alt="image-20220824163641496" tabindex="0" loading="lazy"><figcaption>image-20220824163641496</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.SeckillService</code>接口里添加<code>getCurrentSeckillSkus</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.1.2.png" alt="image-20220824163717457" tabindex="0" loading="lazy"><figcaption>image-20220824163717457</figcaption></figure><h5 id="_2、查看文档" tabindex="-1"><a class="header-anchor" href="#_2、查看文档" aria-hidden="true">#</a> 2、查看文档</h5><p>可以看到<code>org.springframework.data.redis.core.ListOperations</code>接口的<code>List&lt;V&gt; range(K key, long start, long end);</code>方法相当于<code>redis</code>里的<code>lrange</code>命令（从左开始查找指定范围的数据）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.2.1.png" alt="image-20220824165909399" tabindex="0" loading="lazy"><figcaption>image-20220824165909399</figcaption></figure><p>redis文档： <a href="https://redis.io/commands/lrange/" target="_blank" rel="noopener noreferrer">LRANGE | Redis<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> RPUSH mylist <span class="token string">&quot;one&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
redis<span class="token operator">&gt;</span> RPUSH mylist <span class="token string">&quot;two&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
redis<span class="token operator">&gt;</span> RPUSH mylist <span class="token string">&quot;three&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token number">0</span> <span class="token number">0</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-3</span> <span class="token number">2</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;two&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-100</span> <span class="token number">100</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;two&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token number">5</span> <span class="token number">10</span>
<span class="token punctuation">(</span>empty array<span class="token punctuation">)</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token number">0</span> <span class="token parameter variable">-1</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;two&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token number">0</span> <span class="token parameter variable">-2</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;two&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-1</span> <span class="token number">0</span>
<span class="token punctuation">(</span>empty array<span class="token punctuation">)</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-1</span> <span class="token number">1</span>
<span class="token punctuation">(</span>empty array<span class="token punctuation">)</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-1</span> <span class="token number">2</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-1</span> <span class="token number">3</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-1</span> <span class="token number">100</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-2</span> <span class="token number">10</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;two&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>
redis<span class="token operator">&gt;</span> LRANGE mylist <span class="token parameter variable">-3</span> <span class="token number">0</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.2.2.png" alt="image-20220824170028012" tabindex="0" loading="lazy"><figcaption>image-20220824170028012</figcaption></figure><h5 id="_3、修改代码" tabindex="-1"><a class="header-anchor" href="#_3、修改代码" aria-hidden="true">#</a> 3、修改代码</h5><p>修改<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类的<code>getCurrentSeckillSkus</code>方法</p><p>我发现一个奇怪的事情，<code>operations.multiGet();</code>方法参数类型为<code>Collection&lt;HK&gt; keys</code>，不能传<code>List&lt;String&gt;</code>类型的<code>range</code>我能理解；但是<code>Collections.singleton(range)</code>这个就很奇怪，其类型明明为<code>Set&lt;List&lt;String&gt;&gt;</code>，直接传不报错，接收成一个变量再传竟然就报错了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>range<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> singleton <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.3.1.png" alt="image-20220824172757088" tabindex="0" loading="lazy"><figcaption>image-20220824172757088</figcaption></figure><p>这是使用<code>Alt+Enter</code>快捷键提示的解决报错的建议</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.3.2.png" alt="image-20220824185200928" tabindex="0" loading="lazy"><figcaption>image-20220824185200928</figcaption></figure><p>这是使用<code>range.</code>后的提示，看来使用<code>.</code>比<code>报错提示</code>有效些😛</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.3.3.3.png" alt="image-20220824185234350" tabindex="0" loading="lazy"><figcaption>image-20220824185234350</figcaption></figure><h3 id="_4、测试-1" tabindex="-1"><a class="header-anchor" href="#_4、测试-1" aria-hidden="true">#</a> 4、测试</h3><h5 id="_1、使用collections-singleton-range" tabindex="-1"><a class="header-anchor" href="#_1、使用collections-singleton-range" aria-hidden="true">#</a> 1、使用<code>Collections.singleton(range)</code></h5><p>修改<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类的<code>getCurrentSeckillSkus</code>方法，先使用<code>Collections.singleton(range)</code>测试看看</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token constant">SESSIONS_CACHE_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> replace <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">SESSIONS_CACHE_PREFIX</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> replace<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> start <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> end <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time<span class="token operator">&gt;=</span>start <span class="token operator">&amp;&amp;</span> time <span class="token operator">&lt;=</span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//这里的 -1相当于length-1，即最后一个元素。取出的结果为[0,length-1] 包含开始和最后的元素，即所有元素</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//秒杀开始后可以查看到随机码</span>
                        <span class="token comment">//seckillSkuRedisTo.setRandomCode(null);</span>
                        <span class="token keyword">return</span> seckillSkuRedisTo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//只要找到了在当前时间范围内的秒杀，不管range是否为null都退出循环(当然如果range不为null,直接就return了)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.1.png" alt="image-20220824183720157" tabindex="0" loading="lazy"><figcaption>image-20220824183720157</figcaption></figure><h5 id="_2、添加秒杀场次-1" tabindex="-1"><a class="header-anchor" href="#_2、添加秒杀场次-1" aria-hidden="true">#</a> 2、添加秒杀场次</h5><p>打开 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，点击新增，添加一个最近的正在秒杀的秒杀场次。（即现在的时间在新建的秒杀场次的开始时间和结束时间之内）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.2.1.png" alt="image-20220824184307893" tabindex="0" loading="lazy"><figcaption>image-20220824184307893</figcaption></figure><p>在<code>优惠营销</code> -&gt; <code>每日秒杀</code>页面里，点击刚刚创建的秒杀场次里的操作的<code>关联商品</code>，在<code>关联秒杀商品</code>里点击<code>新增</code>，新增如下<code>关联商品</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.2.2.png" alt="image-20220824184401833" tabindex="0" loading="lazy"><figcaption>image-20220824184401833</figcaption></figure><p>点击确定后，就看看到关联的秒杀商品已经添加进来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.2.3.png" alt="image-20220824184426043" tabindex="0" loading="lazy"><figcaption>image-20220824184426043</figcaption></figure><h5 id="_3、arraylist不能强转成string" tabindex="-1"><a class="header-anchor" href="#_3、arraylist不能强转成string" aria-hidden="true">#</a> 3、<code>ArrayList</code>不能强转成<code>String</code></h5><p>然后启动<code>GulimallSeckillApplication</code>服务，等待刚刚创建的秒杀活动保存到<code>redis</code>，访问 http://localhost:25000/currentSeckillSkus 页面，报了强转的错误</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.3.1.png" alt="image-20220824184642047" tabindex="0" loading="lazy"><figcaption>image-20220824184642047</figcaption></figure><p>打开<code>GulimallSeckillApplication</code>服务的控制台，报了<code>ArrayList</code>不能强转成<code>String</code>的错误</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-24 <span class="token number">18</span>:46:30.998 ERROR <span class="token number">5916</span> --- <span class="token punctuation">[</span>io-25000-exec-1<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is java.lang.ClassCastException: java.util.ArrayList cannot be cast to java.lang.String<span class="token punctuation">]</span> with root cause

java.lang.ClassCastException: java.util.ArrayList cannot be cast to java.lang.String
	at org.springframework.data.redis.serializer.StringRedisSerializer.serialize<span class="token punctuation">(</span>StringRedisSerializer.java:36<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-data-redis-2.1.10.RELEASE.jar:2.1.10.RELEASE<span class="token punctuation">]</span>
	at org.springframework.data.redis.core.AbstractOperations.rawHashKey<span class="token punctuation">(</span>AbstractOperations.java:165<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-data-redis-2.1.10.RELEASE.jar:2.1.10.RELEASE<span class="token punctuation">]</span>
	at org.springframework.data.redis.core.DefaultHashOperations.multiGet<span class="token punctuation">(</span>DefaultHashOperations.java:172<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-data-redis-2.1.10.RELEASE.jar:2.1.10.RELEASE<span class="token punctuation">]</span>
	at org.springframework.data.redis.core.DefaultBoundHashOperations.multiGet<span class="token punctuation">(</span>DefaultBoundHashOperations.java:74<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-data-redis-2.1.10.RELEASE.jar:2.1.10.RELEASE<span class="token punctuation">]</span>
	at com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl.getCurrentSeckillSkus<span class="token punctuation">(</span>SeckillServiceImpl.java:75<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.seckill.controller.SeckillController.getCurrentSeckillSkus<span class="token punctuation">(</span>SeckillController.java:29<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.3.2.png" alt="image-20220824184721715" tabindex="0" loading="lazy"><figcaption>image-20220824184721715</figcaption></figure><h5 id="_4、方法一" tabindex="-1"><a class="header-anchor" href="#_4、方法一" aria-hidden="true">#</a> 4、方法一</h5><p>可以将<code>Collections.singleton(range)</code>修改为<code>Arrays.asList(range.toArray())</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.4.1.png" alt="image-20220824184931379" tabindex="0" loading="lazy"><figcaption>image-20220824184931379</figcaption></figure><p>重启<code>GulimallSeckillApplication</code>服务后，再次访问 http://localhost:25000/currentSeckillSkus 页面，可以看到如下json</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;msg&quot;</span><span class="token operator">:</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;code&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;promotionId&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">&quot;promotionSessionId&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;randomCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;bdc4f396f9ac49539bd1668d908488da&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;seckillPrice&quot;</span><span class="token operator">:</span><span class="token number">999</span><span class="token punctuation">,</span><span class="token property">&quot;seckillCount&quot;</span><span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token property">&quot;seckillLimit&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;seckillSort&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;startTime&quot;</span><span class="token operator">:</span><span class="token number">1661335200000</span><span class="token punctuation">,</span><span class="token property">&quot;endTime&quot;</span><span class="token operator">:</span><span class="token number">1661346000000</span><span class="token punctuation">,</span><span class="token property">&quot;skuInfoVo&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;skuName&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为 HUAWEI Mate30Pro 星河银 8GB+128GB&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;skuDesc&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span><span class="token number">225</span><span class="token punctuation">,</span><span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;skuDefaultImg&quot;</span><span class="token operator">:</span><span class="token string">&quot;https://gulimall-anonymous.oss-cn-beijing.aliyuncs.com/2022-05-21//b90b1cb4-edd9-4c91-8418-18594da32471_0d40c24b264aa511.jpg&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span><span class="token string">&quot;华为 HUAWEI Mate30Pro 星河银 8GB+128GB 麒麟990旗舰芯片OLED环幕屏双4000万徕卡电影四摄 4G全网通手机&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;skuSubtitle&quot;</span><span class="token operator">:</span><span class="token string">&quot;[现货抢购！享白条12期免息！]麒麟990， OLED环幕屏双4000万徕卡电影四摄：Mate30系列享12期免息》&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token number">5799.0</span><span class="token punctuation">,</span><span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.4.2.png" alt="image-20220824184846694" tabindex="0" loading="lazy"><figcaption>image-20220824184846694</figcaption></figure><h5 id="_5、方法二-推荐" tabindex="-1"><a class="header-anchor" href="#_5、方法二-推荐" aria-hidden="true">#</a> 5、方法二（推荐）</h5><p>修改<code>BoundHashOperations</code>的泛型，把<code>BoundHashOperations&lt;String, Object, Object&gt; operations</code>改为<code>BoundHashOperations&lt;String, String, Object&gt; operations</code>。把<code>operations.multiGet(Arrays.asList(range.toArray()));</code>改为<code>operations.multiGet(range);</code></p><p><a href="code/7.1.3.4.6.SeckillServiceImpl.java">点击查看<code>SeckillServiceImpl</code>类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token constant">SESSIONS_CACHE_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> replace <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">SESSIONS_CACHE_PREFIX</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> replace<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> start <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> end <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time<span class="token operator">&gt;=</span>start <span class="token operator">&amp;&amp;</span> time <span class="token operator">&lt;=</span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//这里的 -1相当于length-1，即最后一个元素。取出的结果为[0,length-1] 包含开始和最后的元素，即所有元素</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//秒杀开始后可以查看到随机码</span>
                        <span class="token comment">//seckillSkuRedisTo.setRandomCode(null);</span>
                        <span class="token keyword">return</span> seckillSkuRedisTo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//只要找到了在当前时间范围内的秒杀，不管range是否为null都退出循环(当然如果range不为null,直接就return了)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.5.1.png" alt="image-20220824185523332" tabindex="0" loading="lazy"><figcaption>image-20220824185523332</figcaption></figure><p>删除<code>reids</code>里<code>seckill</code>开头的<code>key</code>，重新启动<code>GulimallSeckillApplication</code>服务，等待刚刚创建的秒杀活动保存到<code>redis</code></p><p>可以看到这样也可以保存成功 http://localhost:25000/currentSeckillSkus</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.5.2.png" alt="image-20220824190053736" tabindex="0" loading="lazy"><figcaption>image-20220824190053736</figcaption></figure><h5 id="_6、原因" tabindex="-1"><a class="header-anchor" href="#_6、原因" aria-hidden="true">#</a> 6、原因</h5><p>鼠标放到<code>operations.multiGet();</code>的方法的括号里，使用<code>ctrl+p</code>快捷键查看参数的类型，此时类型为<code>Collection&lt;Object&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.6.1.png" alt="image-20220824190222468" tabindex="0" loading="lazy"><figcaption>image-20220824190222468</figcaption></figure><p>这是因为我们最开始使用的<code>BoundHashOperations</code>的泛型是<code>BoundHashOperations&lt;String, Object, Object&gt; operations</code>，此时的<code>HK</code>为<code>Object</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">,</span> HK<span class="token punctuation">,</span> HV<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BoundKeyOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Delete given hash <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">keys</span></span><span class="token punctuation">}</span> at the bound key.
    *
    * <span class="token keyword">@param</span> <span class="token parameter">keys</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
    * <span class="token keyword">@return</span> <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span> when used in pipeline / transaction.
    */</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token class-name">Long</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Determine if given hash <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">key</span></span><span class="token punctuation">}</span> exists at the bound key.
    *
    * <span class="token keyword">@param</span> <span class="token parameter">key</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
    * <span class="token keyword">@return</span> <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span> when used in pipeline / transaction.
    */</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token class-name">Boolean</span> <span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Get value for given <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">key</span></span><span class="token punctuation">}</span> from the hash at the bound key.
    *
    * <span class="token keyword">@param</span> <span class="token parameter">member</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
    * <span class="token keyword">@return</span> <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span> when member does not exist or when used in pipeline / transaction.
    */</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token class-name">HV</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Get values for given <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">keys</span></span><span class="token punctuation">}</span> from the hash at the bound key.
    *
    * <span class="token keyword">@param</span> <span class="token parameter">keys</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
    * <span class="token keyword">@return</span> <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span> when used in pipeline / transaction.
    */</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>HV<span class="token punctuation">&gt;</span></span> <span class="token function">multiGet</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span>HK<span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.6.2.png" alt="image-20220824190224762" tabindex="0" loading="lazy"><figcaption>image-20220824190224762</figcaption></figure><p><code> List&lt;HV&gt; multiGet(Collection&lt;HK&gt; keys);</code>方法的参数类型为<code>Collection&lt;HK&gt;</code>，由于我们使用的<code>HK</code>为<code>Object</code>，所以该方法的参数的类型为<code>Collection&lt;Object&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.6.3.png" alt="image-20220824190226691" tabindex="0" loading="lazy"><figcaption>image-20220824190226691</figcaption></figure><p>而修改<code>BoundHashOperations</code>的泛型为<code>BoundHashOperations&lt;String, String, Object&gt; operations</code>后，<code> List&lt;HV&gt; multiGet(Collection&lt;HK&gt; keys);</code>方法的参数类型就为<code>Collection&lt;String&gt;</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.6.4.png" alt="image-20220824190305321" tabindex="0" loading="lazy"><figcaption>image-20220824190305321</figcaption></figure><p>我们可以将<code>BoundHashOperations</code>的泛型全改为<code>String</code>，即<code>BoundHashOperations&lt;String, String, String&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.3.4.6.5.png" alt="image-20220824190516456" tabindex="0" loading="lazy"><figcaption>image-20220824190516456</figcaption></figure><h3 id="_7-1-4、显示秒杀商品" tabindex="-1"><a class="header-anchor" href="#_7-1-4、显示秒杀商品" aria-hidden="true">#</a> 7.1.4、显示秒杀商品</h3><h4 id="_1、添加配置" tabindex="-1"><a class="header-anchor" href="#_1、添加配置" aria-hidden="true">#</a> 1、添加配置</h4><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加如下配置，将<code>seckill.gulimall.com</code>域名的请求全部负载均衡到<code>gulimall-seckill</code>模块</p><p><a href="code/7.1.4.1.application.yml">点击查看application.yml配置文件完整配置</a></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_seckill_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>seckill
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Host=seckill.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.1.1.png" alt="image-20220824190755730" tabindex="0" loading="lazy"><figcaption>image-20220824190755730</figcaption></figure><p>打开<code>SwitchHosts</code>软件，依次点击<code>hosts</code>-&gt;<code>本地方案</code>-&gt;<code>gulimall</code>，在后面添加<code>192.168.56.10 seckill.gulimall.com</code>，然后点击<code>对勾</code>图标</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># gulimall</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">search.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">item.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">auth.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">cart.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">order.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">member.gulimall.com</span>
<span class="token key attr-name">192.168.56.10</span> <span class="token value attr-value">seckill.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.1.2.png" alt="image-20220824190957079" tabindex="0" loading="lazy"><figcaption>image-20220824190957079</figcaption></figure><p>重启<code>GulimallGatewayApplication</code>服务，访问 http://seckill.gulimall.com/currentSeckillSkus ，可以看到通过网关也可以访问了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.1.3.png" alt="image-20220824191117496" tabindex="0" loading="lazy"><figcaption>image-20220824191117496</figcaption></figure><h4 id="_2、显示秒杀商品" tabindex="-1"><a class="header-anchor" href="#_2、显示秒杀商品" aria-hidden="true">#</a> 2、显示秒杀商品</h4><p>在 http://gulimall.com/ 页面里，打开控制台，定位到<code>秒杀的某个图片</code>位置，复制<code>/static/index/img/section_second_list_img1.jpg</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.2.1.png" alt="image-20220824191521071" tabindex="0" loading="lazy"><figcaption>image-20220824191521071</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件夹搜索<code>/static/index/img/section_second_list_img1.jpg</code>，复制第一个<code>&lt;li&gt;</code>标签，将四个<code>&lt;li&gt;</code>标签全部删掉，一个也不保留，并给其父<code>&lt;ul&gt;</code>标签加上<code>id=&quot;seckillContent&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.2.2.png" alt="image-20220824191802504" tabindex="0" loading="lazy"><figcaption>image-20220824191802504</figcaption></figure><p>修改后的代码如下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.2.3.png" alt="image-20220824191922056" tabindex="0" loading="lazy"><figcaption>image-20220824191922056</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/detail.html</code>文件里的<code>&lt;script&gt;</code>标签里，添加如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>$<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://seckill.gulimall.com/currentSeckillSkus&quot;</span><span class="token punctuation">,</span>function <span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>code<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $<span class="token punctuation">(</span><span class="token string">&quot;&lt;li&gt;&lt;/li&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;img style=&#39;width: 130px;height: 130px;&#39; src=&#39;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuInfoVo<span class="token punctuation">.</span>skuDefaultImg<span class="token operator">+</span><span class="token string">&quot;&#39;/&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;p&gt;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuInfoVo<span class="token punctuation">.</span>skuTitle<span class="token operator">+</span><span class="token string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;span&gt;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>seckillPrice<span class="token operator">+</span><span class="token string">&quot;&lt;/span&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;s&gt;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuInfoVo<span class="token punctuation">.</span>price<span class="token operator">+</span><span class="token string">&quot;&lt;/s&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">appendTo</span><span class="token punctuation">(</span><span class="token string">&quot;#seckillContent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.2.4.png" alt="image-20220824193416056" tabindex="0" loading="lazy"><figcaption>image-20220824193416056</figcaption></figure><p>打开 http://gulimall.com/ 页面，可以看到秒杀的商品已经显示出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.2.5.png" alt="image-20220824193317275" tabindex="0" loading="lazy"><figcaption>image-20220824193317275</figcaption></figure><h4 id="_3、查询当前sku是否参与秒杀优惠" tabindex="-1"><a class="header-anchor" href="#_3、查询当前sku是否参与秒杀优惠" aria-hidden="true">#</a> 3、查询当前sku是否参与秒杀优惠</h4><h5 id="_1、获取sku秒杀信息" tabindex="-1"><a class="header-anchor" href="#_1、获取sku秒杀信息" aria-hidden="true">#</a> 1、获取sku秒杀信息</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SkuInfoServiceImpl</code>类的<code>item</code>方法添加<code>查询当前sku是否参与秒杀优惠</code>功能，这个等会再做</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.1.1.png" alt="image-20220824193616733" tabindex="0" loading="lazy"><figcaption>image-20220824193616733</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类里添加<code>getSkuSeckillInfo</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sku/seckill/{skuId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SeckillSkuRedisTo</span> <span class="token keyword">to</span> <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.1.2.png" alt="image-20220824194402058" tabindex="0" loading="lazy"><figcaption>image-20220824194402058</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.SeckillService</code>接口里添加<code>getSkuSeckillInfo</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">SeckillSkuRedisTo</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.1.3.png" alt="image-20220824194404672" tabindex="0" loading="lazy"><figcaption>image-20220824194404672</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里实现<code>getSkuSeckillInfo</code>方法</p><p>（这里有问题，因为只查询了一个活动的该商品信息，如果一个包含该商品的秒杀活动已经过去了，而新的还未开始的活动又包含该商品，有可能查询到已经过去的秒杀活动，导致没有出现秒杀信息）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 查询指定sku的一个秒杀信息
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SeckillSkuRedisTo</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashOps <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> regx <span class="token operator">=</span> <span class="token string">&quot;\\d_&quot;</span> <span class="token operator">+</span> skuId<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>regx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> s <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> now <span class="token operator">&gt;</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//不返回随机码</span>
                    seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">setRandomCode</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> seckillSkuRedisTo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.1.4.png" alt="image-20220824195711178" tabindex="0" loading="lazy"><figcaption>image-20220824195711178</figcaption></figure><h5 id="_2、远程调用秒杀模块" tabindex="-1"><a class="header-anchor" href="#_2、远程调用秒杀模块" aria-hidden="true">#</a> 2、远程调用秒杀模块</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign</code>包里新建<code>SearchFeignService</code>接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/24
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-seckill&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sku/seckill/{skuId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.2.1.png" alt="image-20220824201857677" tabindex="0" loading="lazy"><figcaption>image-20220824201857677</figcaption></figure><p>复制<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.to.SeckillSkuRedisTo</code>类里除<code>private SkuInfoVo skuInfoVo;</code>的字段，粘贴到<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.vo</code>包里</p><p><a href="code/7.1.4.3.2.SeckillInfoVo.java">点击查看SeckillInfoVo类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.2.2.png" alt="image-20220824200357390" tabindex="0" loading="lazy"><figcaption>image-20220824200357390</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.vo.SkuItemVo</code>类里添加<code>seckillInfo</code>字段（不是刚刚新添加的<code>seckillInfo</code>类，别添加错了）</p><p><a href="code/7.1.4.3.2.SkuItemVo.java">点击查看SkuItemVo类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 当前商品的秒杀优惠信息
 */</span>
<span class="token class-name">SeckillInfoVo</span> seckillInfo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.2.3.png" alt="image-20220824200619492" tabindex="0" loading="lazy"><figcaption>image-20220824200619492</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SkuInfoServiceImpl</code>类里，修改<code>item</code>方法，在<code>CompletableFuture.allOf(saleAttrFuture,descFuture,baseAttrFuture,imageFuture).get();</code>上面添加如下异步执行的请求，并将其添加到<code>CompletableFuture.allOf</code>的参数里面</p><p><a href="code/7.1.4.3.2.SkuInfoServiceImpl.java">点击查看<code>SkuInfoServiceImpl</code>类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">SeckillFeignService</span> seckillFeignService<span class="token punctuation">;</span>

<span class="token comment">//查询当前sku是否参与秒杀优惠</span>
<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> seckillFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> seckillFeignService<span class="token punctuation">.</span><span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SeckillInfoVo</span> seckillInfoVo <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">SeckillInfoVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuItemVo<span class="token punctuation">.</span><span class="token function">setSeckillInfo</span><span class="token punctuation">(</span>seckillInfoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>saleAttrFuture<span class="token punctuation">,</span>descFuture<span class="token punctuation">,</span>baseAttrFuture<span class="token punctuation">,</span>imageFuture<span class="token punctuation">,</span>seckillFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.4.3.2.4.png" alt="image-20220824201018390" tabindex="0" loading="lazy"><figcaption>image-20220824201018390</figcaption></figure><h3 id="_7-1-5、商品页面添加秒杀提醒" tabindex="-1"><a class="header-anchor" href="#_7-1-5、商品页面添加秒杀提醒" aria-hidden="true">#</a> 7.1.5、商品页面添加秒杀提醒</h3><h4 id="_1、商品页添加秒杀信息" tabindex="-1"><a class="header-anchor" href="#_1、商品页添加秒杀信息" aria-hidden="true">#</a> 1、商品页添加秒杀信息</h4><h5 id="_1、商品页添加秒杀开始时间" tabindex="-1"><a class="header-anchor" href="#_1、商品页添加秒杀开始时间" aria-hidden="true">#</a> 1、商品页添加秒杀开始时间</h5><p>在 http://gulimall.com/5.html 页面里，打开控制台，定位到<code>预约享资格</code>位置，复制<code>预约享资格</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.1.1.png" alt="image-20220824201253539" tabindex="0" loading="lazy"><figcaption>image-20220824201253539</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>配置文件里搜索<code>预约享资格</code>，将<code>预约享资格</code>修改为<code>[[${item.seckillInfo.startTime}]]</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${item.seckillInfo!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--预约享资格--&gt;</span>
   [[${item.seckillInfo.startTime}]]
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.1.2.png" alt="image-20220824201631421" tabindex="0" loading="lazy"><figcaption>image-20220824201631421</figcaption></figure><p>找一个有秒杀的<code>sku</code>的商品，访问其url，例如 http://item.gulimall.com/1.html ，此时已经显示开始时间了，只不过显示的是时间戳</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.1.3.png" alt="image-20220824202224602" tabindex="0" loading="lazy"><figcaption>image-20220824202224602</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>配置文件里，将<code>[[${item.seckillInfo.startTime}]]</code>修改为<code> [[${#dates.format(new java.util.Date(item.seckillInfo.startTime),&quot;yyyy-MM-dd HH:mm:ss&quot;)}]]</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${item.seckillInfo!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--预约享资格--&gt;</span>
   [[${#dates.format(new java.util.Date(item.seckillInfo.startTime),&quot;yyyy-MM-dd HH:mm:ss&quot;)}]]
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.1.4.png" alt="image-20220824204454541" tabindex="0" loading="lazy"><figcaption>image-20220824204454541</figcaption></figure><p>刷新 http://item.gulimall.com/1.html 页面，此时已经显示正常格式的开始时间了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.1.5.png" alt="image-20220824204506239" tabindex="0" loading="lazy"><figcaption>image-20220824204506239</figcaption></figure><h5 id="_2、商品页添加秒杀价" tabindex="-1"><a class="header-anchor" href="#_2、商品页添加秒杀价" aria-hidden="true">#</a> 2、商品页添加秒杀价</h5><p>打开 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，点击前面创建的<code>2022-08-24 18:00:00</code>点场的秒杀场次里的操作的<code>关联商品</code>，在<code>关联秒杀商品</code>里可以看到商品的id为<code>1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.2.1.png" alt="image-20220824204647496" tabindex="0" loading="lazy"><figcaption>image-20220824204647496</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>配置文件里搜索<code>预约享资格</code>，修改<code>预约享资格</code>对应的<code>&lt;li&gt;</code>标签对应的代码，以显示秒杀价格</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${item.seckillInfo!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#dates.createNow().getTime() &lt; item.seckillInfo.startTime}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--预约享资格--&gt;</span>
       商品将会在[[${#dates.format(new java.util.Date(item.seckillInfo.startTime),&quot;yyyy-MM-dd HH:mm:ss&quot;)}]]进行秒杀
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#dates.createNow().getTime() &gt;= item.seckillInfo.startTime &amp;&amp; #dates.createNow().getTime() &lt;= item.seckillInfo.endTime}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      秒杀价：[[${#numbers.formatDecimal(item.seckillInfo.seckillPrice,1,2)}]]
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.2.2.png" alt="image-20220824205419223" tabindex="0" loading="lazy"><figcaption>image-20220824205419223</figcaption></figure><p>这里显示秒杀价了（不过这里有问题，因为只查询了一个活动的该商品信息，如果一个包含该商品的秒杀活动已经过去了，而新的还未开始的活动又包含该商品，有可能查询到已经过去的秒杀活动，导致没有出现新的秒杀信息）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.2.3.png" alt="image-20220824205448268" tabindex="0" loading="lazy"><figcaption>image-20220824205448268</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里的<code>&lt;script&gt;</code>标签里，添加如下代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">to_href</span><span class="token punctuation">(</span><span class="token parameter">skuId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://item.gulimall.com/&quot;</span><span class="token operator">+</span>skuId<span class="token operator">+</span><span class="token string">&quot;.html&quot;</span>
<span class="token punctuation">}</span>
$<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://seckill.gulimall.com/currentSeckillSkus&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>code<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> href <span class="token operator">=</span> <span class="token string">&quot;http://item.gulimall.com/&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuId<span class="token operator">+</span><span class="token string">&quot;.html&quot;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;li onclick=&#39;to_href(&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuId<span class="token operator">+</span><span class="token string">&quot;)&#39;&gt;&lt;/li&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;img style=&#39;width: 130px;height: 130px;&#39; src=&#39;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuInfoVo<span class="token punctuation">.</span>skuDefaultImg<span class="token operator">+</span><span class="token string">&quot;&#39;/&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;p&gt;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuInfoVo<span class="token punctuation">.</span>skuTitle<span class="token operator">+</span><span class="token string">&quot;&lt;/p&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;span&gt;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>seckillPrice<span class="token operator">+</span><span class="token string">&quot;&lt;/span&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;s&gt;&quot;</span><span class="token operator">+</span>item<span class="token punctuation">.</span>skuInfoVo<span class="token punctuation">.</span>price<span class="token operator">+</span><span class="token string">&quot;&lt;/s&gt;&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">appendTo</span><span class="token punctuation">(</span><span class="token string">&quot;#seckillContent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.2.4.png" alt="image-20220824211447192" tabindex="0" loading="lazy"><figcaption>image-20220824211447192</figcaption></figure><p>在 http://gulimall.com/ 页面里，点击一个秒杀商品，来到了 http://item.gulimall.com/1.html 页面，此时页面已经显示<code>秒杀价</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.1.2.5.gif" alt="GIF 2022-8-24 21-12-30" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-24 21-12-30</figcaption></figure><h4 id="_2、处理秒杀逻辑" tabindex="-1"><a class="header-anchor" href="#_2、处理秒杀逻辑" aria-hidden="true">#</a> 2、处理秒杀逻辑</h4><h5 id="_1、高并发系统关注的问题" tabindex="-1"><a class="header-anchor" href="#_1、高并发系统关注的问题" aria-hidden="true">#</a> 1、高并发系统关注的问题</h5><p>秒杀（ 高并发） 系统应关注以下问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.1.1.png" alt="image-20220824213156518" tabindex="0" loading="lazy"><figcaption>image-20220824213156518</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.1.2.png" alt="image-20220824214655339" tabindex="0" loading="lazy"><figcaption>image-20220824214655339</figcaption></figure><h5 id="_2、修改秒杀场次时间" tabindex="-1"><a class="header-anchor" href="#_2、修改秒杀场次时间" aria-hidden="true">#</a> 2、修改秒杀场次时间</h5><p>在 http://item.gulimall.com/1.html 页面里，打开控制台，定位到<code>加入购物车</code>位置，复制<code>加入购物车</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.2.1.png" alt="image-20220824215059692" tabindex="0" loading="lazy"><figcaption>image-20220824215059692</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里搜索<code>加入购物车</code>，修改相关代码，如果该商品正在秒杀了就显示<code>立即抢购</code>，如果该商品没有正在秒杀就显示<code>加入购物车</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-btns-two<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${item.seckillInfo!=null &amp;&amp; #dates.createNow().getTime() &gt;= item.seckillInfo.startTime &amp;&amp; #dates.createNow().getTime() &lt;= item.seckillInfo.endTime}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>secKillA<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId=${item.info.skuId},sessionId=${item.seckillInfo.promotionSessionId},code=${item.seckillInfo.randomCode}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--立即预约--&gt;</span>
      立即抢购
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box-btns-two<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${item.seckillInfo==null || #dates.createNow().getTime() &lt; item.seckillInfo.startTime || #dates.createNow().getTime() &gt; item.seckillInfo.endTime}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addToCart<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId=${item.info.skuId}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--立即预约--&gt;</span>
      加入购物车
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.2.2.png" alt="image-20220828184609122" tabindex="0" loading="lazy"><figcaption>image-20220828184609122</figcaption></figure><p>重启<code>GulimallProductApplication</code>服务和<code>GulimallSeckillApplication</code>服务，打开 http://item.gulimall.com/1.html 页面，此时显示的是<code>加入购物车</code>，这是因为此时已经过了秒杀时间了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.2.3.png" alt="image-20220828150556457" tabindex="0" loading="lazy"><figcaption>image-20220828150556457</figcaption></figure><p>打开 http://localhost:8001/#/coupon-seckillsession 页面，在<code>优惠营销</code> -&gt; <code>每日秒杀</code>里，点击前面创建的<code>2022-08-24 18:00:00</code>秒杀场次里的操作的<code>修改</code>，在<code>修改</code>对话框里修改为最近的正在秒杀的秒杀场次。（即现在的时间在修改的秒杀场次的开始时间和结束时间之内）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.2.4.png" alt="image-20220828150953013" tabindex="0" loading="lazy"><figcaption>image-20220828150953013</figcaption></figure><p>点击刚刚修改为<code>2022-08-28 15:00:00</code>的秒杀场次里的操作的<code>关联商品</code>，在<code>关联秒杀商品</code>对话框里点击<code>新增</code>，新增如下商品。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.2.5.png" alt="image-20220828151021501" tabindex="0" loading="lazy"><figcaption>image-20220828151021501</figcaption></figure><p>点击<code>确定</code>后即可看到刚刚新关联的商品已经显示到<code>关联秒杀商品</code>里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.2.6.png" alt="image-20220828151023910" tabindex="0" loading="lazy"><figcaption>image-20220828151023910</figcaption></figure><h5 id="_3、值不能为空" tabindex="-1"><a class="header-anchor" href="#_3、值不能为空" aria-hidden="true">#</a> 3、值不能为空</h5><p>重启<code>GulimallProductApplication</code>服务和<code>GulimallSeckillApplication</code>服务，在<code>GulimallSeckillApplication</code>服务的控制台报了如下的错误。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-28 <span class="token number">15</span>:10:00.056 ERROR <span class="token number">3008</span> --- <span class="token punctuation">[</span>   scheduling-1<span class="token punctuation">]</span> o.s.s.s.TaskUtils<span class="token variable">$LoggingErrorHandler</span>    <span class="token builtin class-name">:</span> Unexpected error occurred <span class="token keyword">in</span> scheduled task.

java.lang.IllegalArgumentException: Values must not be <span class="token string">&#39;null&#39;</span> or empty.
	at org.springframework.util.Assert.notEmpty<span class="token punctuation">(</span>Assert.java:464<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-core-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at org.springframework.data.redis.core.AbstractOperations.rawValues<span class="token punctuation">(</span>AbstractOperations.java:147<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-data-redis-2.1.10.RELEASE.jar:2.1.10.RELEASE<span class="token punctuation">]</span>
	at org.springframework.data.redis.core.DefaultListOperations.leftPushAll<span class="token punctuation">(</span>DefaultListOperations.java:122<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-data-redis-2.1.10.RELEASE.jar:2.1.10.RELEASE<span class="token punctuation">]</span>
	at com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl.lambda<span class="token variable">$saveSessionInfos</span><span class="token variable">$2</span><span class="token punctuation">(</span>SeckillServiceImpl.java:139<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at java.util.ArrayList.forEach<span class="token punctuation">(</span>ArrayList.java:1259<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	at com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl.saveSessionInfos<span class="token punctuation">(</span>SeckillServiceImpl.java:129<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl.uploadSeckillSkuLatest3Days<span class="token punctuation">(</span>SeckillServiceImpl.java:56<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.seckill.scheduled.SeckillSkuScheduled.uploadSeckillSkuLatest3Days<span class="token punctuation">(</span>SeckillSkuScheduled.java:46<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.3.1.png" alt="image-20220828151400315" tabindex="0" loading="lazy"><figcaption>image-20220828151400315</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里，修改<code>saveSessionInfos</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>hasKey <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>hasKey <span class="token operator">&amp;&amp;</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getRelationSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.3.2.png" alt="image-20220828151556751" tabindex="0" loading="lazy"><figcaption>image-20220828151556751</figcaption></figure><p>重启<code>GulimallSeckillApplication</code>服务，打开 http://item.gulimall.com/1.html 页面，此时已经显示<code>立即抢购</code>了，打开控制台，定位到<code>立即抢购</code>这，可以看到该标签已经有<code>skuid</code>（商品id）、<code>sessionid</code>（秒杀场次id）、<code>code</code>（令牌随机码）信息了</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>secKillA<span class="token punctuation">&quot;</span></span> <span class="token attr-name">skuid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sessionid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">code</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0b41ce397be0476c9cfd604924546a56<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立即抢购<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.3.3.png" alt="image-20220828185401770" tabindex="0" loading="lazy"><figcaption>image-20220828185401770</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#secKillA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> killId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sessionid&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;skuid&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#numInput&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://seckill.gulimall.com/kill?killId=&quot;</span><span class="token operator">+</span>killId<span class="token operator">+</span><span class="token string">&quot;&amp;key=&quot;</span><span class="token operator">+</span>key<span class="token operator">+</span><span class="token string">&quot;&amp;num=&quot;</span><span class="token operator">+</span>num
   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.3.4.png" alt="image-20220828190301580" tabindex="0" loading="lazy"><figcaption>image-20220828190301580</figcaption></figure><p>在 http://item.gulimall.com/1.html 页面里，点击<code>立即抢购</code>， 此时跳转到了 http://seckill.gulimall.com/kill?killId=4_1&amp;key=0b41ce397be0476c9cfd604924546a56&amp;num=1 页面，不过报了<code>404</code>的错误，这是正常的，因为这个接口还没写。但是没有登录页跳转了，应该登陆后才能进行跳转。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.3.5.gif" alt="GIF 2022-8-28 19-16-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-16-39</figcaption></figure><h5 id="_4、登录后才能抢购" tabindex="-1"><a class="header-anchor" href="#_4、登录后才能抢购" aria-hidden="true">#</a> 4、登录后才能抢购</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/item.html</code>文件里的<code>&lt;script&gt;</code>标签里添加如下代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#secKillA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> isLogin <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>session<span class="token punctuation">.</span>loginUser<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>isLogin<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> killId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;sessionid&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;skuid&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#numInput&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://seckill.gulimall.com/kill?killId=&quot;</span><span class="token operator">+</span>killId<span class="token operator">+</span><span class="token string">&quot;&amp;key=&quot;</span><span class="token operator">+</span>key<span class="token operator">+</span><span class="token string">&quot;&amp;num=&quot;</span><span class="token operator">+</span>num
   <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀前请先登录&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.4.1.png" alt="image-20220828191809849" tabindex="0" loading="lazy"><figcaption>image-20220828191809849</figcaption></figure><p>在 http://item.gulimall.com/1.html 页面里，点击<code>立即抢购</code> ，此时如果没有登录就会弹出<code>秒杀前请先登录</code>的提示，登录后在 http://item.gulimall.com/1.html 页面里，再次点击<code>立即抢购</code> ，就会来到 http://seckill.gulimall.com/kill?killId=4_1&amp;key=0b41ce397be0476c9cfd604924546a56&amp;num=1 页面，不过报了<code>404</code>的错误，这是正常的，因为这个接口还没写。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.2.4.2.gif" alt="GIF 2022-8-28 19-14-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-14-15</figcaption></figure><h4 id="_3、引入springsession" tabindex="-1"><a class="header-anchor" href="#_3、引入springsession" aria-hidden="true">#</a> 3、引入SpringSession</h4><h5 id="_1、引入springsession" tabindex="-1"><a class="header-anchor" href="#_1、引入springsession" aria-hidden="true">#</a> 1、引入SpringSession</h5><p>在<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里引入<code>SpringSession</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入SpringSession--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.1.png" alt="image-20220828192835324" tabindex="0" loading="lazy"><figcaption>image-20220828192835324</figcaption></figure><h5 id="_2、添加配置" tabindex="-1"><a class="header-anchor" href="#_2、添加配置" aria-hidden="true">#</a> 2、添加配置</h5><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下配置，指定使用<code>redis</code>来存储<code>SpringSession</code>的信息</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.1.png" alt="image-20220828193007418" tabindex="0" loading="lazy"><figcaption>image-20220828193007418</figcaption></figure><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.GulimallSessionConfig</code>类，粘贴到<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.config</code>包下。</p><p><a href="code/7.1.5.3.2.GulimallSessionConfig.java">点击查看<code>GulimallSessionConfig</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.2.png" alt="image-20220828193203195" tabindex="0" loading="lazy"><figcaption>image-20220828193203195</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.config.GulimallSessionConfig</code>配置类上添加如下注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.3.png" alt="image-20220828193248078" tabindex="0" loading="lazy"><figcaption>image-20220828193248078</figcaption></figure><p>复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>里的<code>interceptor</code>文件夹(里面有<code>LoginUserInterceptor</code>类)，粘贴到<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill</code>包下。</p><p><a href="code/7.1.5.3.2.LoginUserInterceptor.java">点击查看<code>LoginUserInterceptor</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.4.png" alt="image-20220828193600420" tabindex="0" loading="lazy"><figcaption>image-20220828193600420</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.interceptor.LoginUserInterceptor</code>类里，修改<code>preHandle</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AntPathMatcher</span> antPathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//只有`/kill`接口需要登录</span>
    <span class="token keyword">boolean</span> match <span class="token operator">=</span> antPathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;/kill&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Object</span> attribute <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">MemberEntityTo</span> memberEntityTo<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberEntityTo</span><span class="token punctuation">)</span> attribute<span class="token punctuation">;</span>
            loginUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;请先进行登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//没登陆就重定向到登录页面</span>
            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">&quot;http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.5.png" alt="image-20220828193912831" tabindex="0" loading="lazy"><figcaption>image-20220828193912831</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.config</code>包里新建<code>SeckillWebConfig</code>类，用于添加刚刚的拦截器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">LoginUserInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">InterceptorRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/28
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.6.png" alt="image-20220828194329439" tabindex="0" loading="lazy"><figcaption>image-20220828194329439</figcaption></figure><p>在 http://item.gulimall.com/1.html 页面里，点击<code>立即抢购</code> ，此时如果没有登录就会弹出<code>秒杀前请先登录</code>的提示，没有登录直接访问 http://seckill.gulimall.com/kill?killId=4_1&amp;key=0b41ce397be0476c9cfd604924546a56&amp;num=1 页面，此时会跳转到 http://auth.gulimall.com/login.html 登录页面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.2.7.gif" alt="GIF 2022-8-28 19-47-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-47-15</figcaption></figure><h5 id="_3、添加秒杀接口" tabindex="-1"><a class="header-anchor" href="#_3、添加秒杀接口" aria-hidden="true">#</a> 3、添加秒杀接口</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类里添加<code>seckill</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 秒杀接口
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/kill&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">seckill</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;killId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> killId<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//判断用户是否登录</span>
    <span class="token comment">//创建订单号</span>
    <span class="token class-name">String</span> orderSn <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>killId<span class="token punctuation">,</span>key<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.3.1.png" alt="image-20220828211356212" tabindex="0" loading="lazy"><figcaption>image-20220828211356212</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.SeckillService</code>接口里添加<code>kill</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">String</span> killId<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.3.2.png" alt="image-20220828202027388" tabindex="0" loading="lazy"><figcaption>image-20220828202027388</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类里实现<code>kill</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">String</span> killId<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取秒杀商品的详细信息</span>
    <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashOps <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4_1  (sessionId_skuId)</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> hashOps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>killId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//校验合法性</span>
    <span class="token comment">//1、校验开始时间和结束时间</span>
    <span class="token class-name">Long</span> startTime <span class="token operator">=</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> endTime <span class="token operator">=</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> startTime <span class="token operator">||</span> now <span class="token operator">&gt;</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//2、校验随机码、商品id、购买数量（我感觉商品id没必要校验）</span>
    <span class="token class-name">String</span> randomCode <span class="token operator">=</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getRandomCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> skuCode <span class="token operator">=</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getPromotionSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> limitNum <span class="token operator">=</span> seckillSkuRedisTo<span class="token punctuation">.</span><span class="token function">getSeckillLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>randomCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>skuCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>killId<span class="token punctuation">)</span> <span class="token operator">||</span> num <span class="token operator">&gt;</span> limitNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//3、校验该用户是否已经购买过，防止无限次购买(幂等性)  userId_sessionId_skuId</span>
    <span class="token class-name">String</span> userKey <span class="token operator">=</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> killId<span class="token punctuation">;</span>
    <span class="token keyword">long</span> ttl <span class="token operator">=</span> endTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> firstBuy <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span> num<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用户已经买过了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstBuy<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>firstBuy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//占位成功，用户从未购买该商品</span>
    <span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token constant">SKU_STOCK_SEMAPHORE</span> <span class="token operator">+</span> randomCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//阻塞获取信号量，一直等待别人释放信号量（不能使用此方式获取信号量）</span>
    <span class="token comment">//semaphore.acquire();</span>
    <span class="token comment">//100毫秒内试一下，看是否能获取指定数量的信号量</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> b <span class="token operator">=</span> semaphore<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//秒杀成功，快速生成订单,给mq发送一个消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> orderSn <span class="token operator">=</span> <span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getTimeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> orderSn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.3.3.png" alt="image-20220828211147911" tabindex="0" loading="lazy"><figcaption>image-20220828211147911</figcaption></figure><h5 id="_4、setnx只能一个抢到" tabindex="-1"><a class="header-anchor" href="#_4、setnx只能一个抢到" aria-hidden="true">#</a> 4、<code>SETNX</code>只能一个抢到</h5><p>在<code>org.springframework.data.redis.core.ValueOperations</code>接口里有个<code>Boolean setIfAbsent(K key, V value);</code>方法，只能有一个人能够抢到该<code>key</code>，并将值设置进去。抢到了返回<code>true</code>（<code>redis</code>里返回<code>1</code>），没抢到返回<code>false</code>（<code>redis</code>里返回<code>0</code>）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Set <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">key</span></span><span class="token punctuation">}</span> to hold the string <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">value</span></span><span class="token punctuation">}</span> if <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">key</span></span><span class="token punctuation">}</span> is absent.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">key</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
 * <span class="token keyword">@param</span> <span class="token parameter">value</span> must not be <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span>.
 * <span class="token keyword">@return</span> <span class="token punctuation">{</span><span class="token keyword">@literal</span> null<span class="token punctuation">}</span> when used in pipeline / transaction.
 * <span class="token keyword">@see</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://redis.io/commands/setnx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Redis Documentation: SETNX<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
 */</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token class-name">Boolean</span> <span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.4.1.png" alt="image-20220828204711411" tabindex="0" loading="lazy"><figcaption>image-20220828204711411</figcaption></figure><p><strong>SETNX</strong></p><p>Syntax</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>SETNX key value
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>Available since:</p><p>1.0.0</p></li><li><p>Time complexity:</p><p>O(1)</p></li><li><p>ACL categories:</p><p><code>@write</code>, <code>@string</code>, <code>@fast</code></p></li></ul><p>Set <code>key</code> to hold string <code>value</code> if <code>key</code> does not exist. In that case, it is equal to <a href="https://redis.io/commands/set" target="_blank" rel="noopener noreferrer"><code>SET</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. When <code>key</code> already holds a value, no operation is performed. <code>SETNX</code> is short for &quot;<strong>SET</strong> if <strong>N</strong>ot e<strong>X</strong>ists&quot;.</p><p><strong>Return</strong></p><p><a href="https://redis.io/docs/reference/protocol-spec#resp-integers" target="_blank" rel="noopener noreferrer">Integer reply<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, specifically:</p><ul><li><code>1</code> if the key was set</li><li><code>0</code> if the key was not set</li></ul><p><strong>Examples</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SETNX mykey <span class="token string">&quot;Hello&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
redis<span class="token operator">&gt;</span> SETNX mykey <span class="token string">&quot;World&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
redis<span class="token operator">&gt;</span> GET mykey
<span class="token string">&quot;Hello&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.3.4.2.png" alt="image-20220828204930892" tabindex="0" loading="lazy"><figcaption>image-20220828204930892</figcaption></figure><h4 id="_4、秒杀中使用rabbitmq" tabindex="-1"><a class="header-anchor" href="#_4、秒杀中使用rabbitmq" aria-hidden="true">#</a> 4、秒杀中使用<code>RabbitMQ</code></h4><h5 id="_1、秒杀架构图" tabindex="-1"><a class="header-anchor" href="#_1、秒杀架构图" aria-hidden="true">#</a> 1、秒杀架构图</h5><p>秒杀业务的<code>RabbitMQ</code>架构图如下图红色方框圈住的部分所示。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.1.png" alt="秒杀业务" tabindex="0" loading="lazy"><figcaption>秒杀业务</figcaption></figure><h5 id="_2、引入rabbitmq" tabindex="-1"><a class="header-anchor" href="#_2、引入rabbitmq" aria-hidden="true">#</a> 2、引入<code>RabbitMQ</code></h5><p>在<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里引入<code>amqp</code>场景，使用<code>RabbitMQ</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入amqp场景，使用RabbitMQ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.2.1.png" alt="image-20220828211534829" tabindex="0" loading="lazy"><figcaption>image-20220828211534829</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下依赖</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
<span class="token key attr-name">spring.rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token value attr-value">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.2.2.png" alt="image-20220828212135844" tabindex="0" loading="lazy"><figcaption>image-20220828212135844</figcaption></figure><p>复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类，粘贴到<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.config</code>包里。</p><p><a href="code/7.1.5.4.2.MyRabbitConfig.java">点击查看<code>MyRabbitConfig</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.2.3.png" alt="image-20220828212503641" tabindex="0" loading="lazy"><figcaption>image-20220828212503641</figcaption></figure><p>删掉该类的<code>initRabbitTemplate</code>方法和<code>setReturnCallback</code>方法、以及<code>rabbitTemplate</code>字段。只保留<code>messageConverter</code>方法。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.2.4.png" alt="image-20220828212608587" tabindex="0" loading="lazy"><figcaption>image-20220828212608587</figcaption></figure><p>如果<code>gulimall-seckill</code>模块不监听队列，只向<code>Rabblt MQ</code>发送消息，不需要在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.GulimallSeckillApplication</code>主类上添加<code>@EnableRabbit</code>注解，因此这里可以什么都不做</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.2.5.png" alt="image-20220828213121570" tabindex="0" loading="lazy"><figcaption>image-20220828213121570</figcaption></figure><h5 id="_3、接收消息" tabindex="-1"><a class="header-anchor" href="#_3、接收消息" aria-hidden="true">#</a> 3、接收消息</h5><p>复制<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.to.SeckillSkuRedisTo</code>类的部分字段(<code>skuInfoVo</code>字段不复制，删除一些字段)，添加<code>orderSn</code>、<code>memberId</code>字段</p><p><a href="code/7.1.5.4.3.SecKillOrderTo.java">点击查看<code>SecKillOrderTo</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.3.1.png" alt="image-20220828215201406" tabindex="0" loading="lazy"><figcaption>image-20220828215201406</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类的<code>kill</code>方法里的<code>String orderSn = IdWorker.getTimeId();</code>下面添加如下代码，向<code>RabbitMq</code>发送消息。</p><p><a href="code/7.1.5.4.3.SeckillServiceImpl.kill.java">点击查看<code>kill</code>方法完整代码</a></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>SecKillOrderTo secKillOrderTo = new SecKillOrderTo();
secKillOrderTo.setMemberId(memberEntityTo.getId());
secKillOrderTo.setOrderSn(orderSn);
secKillOrderTo.setSkuId(seckillSkuRedisTo.getSkuId());
secKillOrderTo.setNum(num);
secKillOrderTo.setPromotionSessionId(seckillSkuRedisTo.getPromotionSessionId());
secKillOrderTo.setSeckillPrice(seckillSkuRedisTo.getSeckillPrice());
rabbitTemplate.convertAndSend(&quot;order-event-exchange&quot;,&quot;order.seckill.order&quot;,secKillOrderTo);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.3.2.png" alt="image-20220828215724392" tabindex="0" loading="lazy"><figcaption>image-20220828215724392</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类里添加如下两个方法，创建<code>order.seckill.order.queue</code>队列和绑定关系</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">orderSeckillOrderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//String name, boolean durable, boolean exclusive, boolean autoDelete</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;order.seckill.order.queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderSeckillOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//String destination, DestinationType destinationType, String exchange, String routingKey,Map&lt;String, Object&gt; arguments</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;order.seckill.order.queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
            <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.seckill.order&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.3.3.png" alt="image-20220828220548675" tabindex="0" loading="lazy"><figcaption>image-20220828220548675</figcaption></figure><h5 id="_4、创建订单" tabindex="-1"><a class="header-anchor" href="#_4、创建订单" aria-hidden="true">#</a> 4、创建订单</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener</code>包里新建<code>OrderSeckillListener</code>类，用于监听秒杀的消息并创建订单。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span></span><span class="token class-name">SecKillOrderTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/28
 * @Description:
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.seckill.order.queue&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSeckillListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">SecKillOrderTo</span> secKillOrderTo<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;准备创建秒杀单的详细信息...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderService<span class="token punctuation">.</span><span class="token function">createSeckillOrder</span><span class="token punctuation">(</span>secKillOrderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//手动ack</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.4.1.png" alt="image-20220828221412545" tabindex="0" loading="lazy"><figcaption>image-20220828221412545</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.listener.OrderSeckillListener</code>接口的<code>createSeckillOrder</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">createSeckillOrder</span><span class="token punctuation">(</span><span class="token class-name">SecKillOrderTo</span> secKillOrderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.4.2.png" alt="image-20220828221443166" tabindex="0" loading="lazy"><figcaption>image-20220828221443166</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里实现<code>createSeckillOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 简略的创建秒杀单
 * <span class="token keyword">@param</span> <span class="token parameter">secKillOrderTo</span> 秒杀单数据
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createSeckillOrder</span><span class="token punctuation">(</span><span class="token class-name">SecKillOrderTo</span> secKillOrderTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>secKillOrderTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setMemberId</span><span class="token punctuation">(</span>secKillOrderTo<span class="token punctuation">.</span><span class="token function">getMemberId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> payAmount <span class="token operator">=</span> secKillOrderTo<span class="token punctuation">.</span><span class="token function">getSeckillPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> secKillOrderTo<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setPayAmount</span><span class="token punctuation">(</span>payAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CREATE_NEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//保存订单项信息(秒杀的订单只有一个订单项)</span>
    <span class="token class-name">OrderItemEntity</span> orderItemEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItemEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItemEntity<span class="token punctuation">.</span><span class="token function">setRealAmount</span><span class="token punctuation">(</span>payAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuQuantity</span><span class="token punctuation">(</span>secKillOrderTo<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 获取当前sku的详细信息</span>
    <span class="token comment">//productFeignService.getSpuInfoBySkuId(secKillOrderTo.getSkuId());</span>

    orderItemService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.4.3.png" alt="image-20220828223052656" tabindex="0" loading="lazy"><figcaption>image-20220828223052656</figcaption></figure><h5 id="_5、测试" tabindex="-1"><a class="header-anchor" href="#_5、测试" aria-hidden="true">#</a> 5、测试</h5><p>重启<code>GulimallOrderApplication</code>订单服务和<code>GulimallSeckillApplication</code>秒杀服务，可以看到创建秒杀活动后，点击<code>立即抢购</code>已经可以获得<code>订单号</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.4.5.gif" alt="GIF 2022-8-28 22-51-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 22-51-54</figcaption></figure><h4 id="_5、完善功能" tabindex="-1"><a class="header-anchor" href="#_5、完善功能" aria-hidden="true">#</a> 5、完善功能</h4><h5 id="_1、修改页面-1" tabindex="-1"><a class="header-anchor" href="#_1、修改页面-1" aria-hidden="true">#</a> 1、修改页面</h5><p>将<code>gulimall-cart</code>模块的<code>src/main/resources/templates/success.html</code>文件复制到<code>gulimall-seckill</code>模块的<code>src/main/resources/templates</code>文件夹里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.1.png" alt="image-20220829190725053" tabindex="0" loading="lazy"><figcaption>image-20220829190725053</figcaption></figure><h5 id="_2、修改代码-1" tabindex="-1"><a class="header-anchor" href="#_2、修改代码-1" aria-hidden="true">#</a> 2、修改代码</h5><p>将<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类上的<code>@RestController</code>注解修改为<code>@Controller</code>，然后在<code>getCurrentSeckillSkus</code>和<code>getSkuSeckillInfo</code>方法上添加<code>@ResponseBody</code>注解</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.2.1.png" alt="image-20220829190944312" tabindex="0" loading="lazy"><figcaption>image-20220829190944312</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类里修改<code>seckill</code>方法，将返回类型修改为<code>String</code>，然后修改返回值为<code>return &quot;success&quot;;</code></p><p><a href="code/7.1.5.5.SeckillController.java">点击查看<code>SeckillController</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.2.2.png" alt="image-20220829191413653" tabindex="0" loading="lazy"><figcaption>image-20220829191413653</figcaption></figure><h5 id="_3、使用thymeleaf" tabindex="-1"><a class="header-anchor" href="#_3、使用thymeleaf" aria-hidden="true">#</a> 3、使用<code>thymeleaf</code></h5><p>在<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里，引入<code>thymeleaf</code>模板引擎</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--模板引擎：thymeleaf--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.3.1.png" alt="image-20220829191534012" tabindex="0" loading="lazy"><figcaption>image-20220829191534012</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下配置，经用<code>thymeleaf</code>缓存</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.thymeleaf.cache</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.3.2.png" alt="image-20220829191646309" tabindex="0" loading="lazy"><figcaption>image-20220829191646309</figcaption></figure><h5 id="_4、修改页面" tabindex="-1"><a class="header-anchor" href="#_4、修改页面" aria-hidden="true">#</a> 4、修改页面</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类里，修改<code>seckill</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 秒杀接口
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/kill&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">seckill</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;killId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> killId<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">,</span>
                      <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//判断用户是否登录</span>
    <span class="token comment">//创建订单号</span>
    <span class="token class-name">String</span> orderSn <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span>killId<span class="token punctuation">,</span>key<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderSn&quot;</span><span class="token punctuation">,</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.4.1.png" alt="image-20220829191905363" tabindex="0" loading="lazy"><figcaption>image-20220829191905363</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/templates/success.html</code>文件里，将<code>src=&quot;</code>全部替换为<code>src=&quot;http://cart.gulimall.com/</code>，将<code>href=&quot;</code>部分替换为<code>href=&quot;http://cart.gulimall.com/</code>（<code> href=&quot;/javascript:;&quot;</code>和<code>href=&quot;/#none&quot;</code>这些不替换）</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>src=&quot;/
src=&quot;http://cart.gulimall.com/

href=&quot;/
href=&quot;http://cart.gulimall.com/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.4.2.png" alt="image-20220829192734285" tabindex="0" loading="lazy"><figcaption>image-20220829192734285</figcaption></figure><p>在<code>http://search.gulimall.com/list.html</code>里随便挑选一个商品，把它加入购物车，然后打开控制台，定位带这个商品，然后复制<code>m succeed-box</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.4.3.png" alt="image-20220829192627147" tabindex="0" loading="lazy"><figcaption>image-20220829192627147</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/templates/success.html</code>文件里搜索<code>m succeed-box</code>，替换里面的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>w<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>m succeed-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${orderSn!=null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mc success-cont<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>恭喜，秒杀成功。订单号:[[${orderSn}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>正在准备订单数据，10秒后自动跳转到支付页面
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${&#39;http://order.gulimall.com/payOrder?orderSn=&#39;+orderSn}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>去支付<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${orderSn==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>手气不好，秒杀失败，请下次再来<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.4.4.png" alt="image-20220828194851830" tabindex="0" loading="lazy"><figcaption>image-20220828194851830</figcaption></figure><h5 id="_5、测试-1" tabindex="-1"><a class="header-anchor" href="#_5、测试-1" aria-hidden="true">#</a> 5、测试</h5><p>重启<code>GulimallSeckillApplication</code>服务，刷新 http://item.gulimall.com/1.html 页面，可以看到由于秒杀时间过了，又变成<code>加入购物车</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.5.1.png" alt="image-20220828195003525" tabindex="0" loading="lazy"><figcaption>image-20220828195003525</figcaption></figure><p>秒杀时间又过了，可以在<code>Windows</code>系统里面设置一下系统时间为秒杀范围内的时间即可以解决这个问题。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.5.2.png" alt="image-20220828194328641" tabindex="0" loading="lazy"><figcaption>image-20220828194328641</figcaption></figure><p>再次刷新 http://item.gulimall.com/1.html 页面，可以看到已经变成<code>立即抢购</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.5.3.png" alt="image-20220828194444601" tabindex="0" loading="lazy"><figcaption>image-20220828194444601</figcaption></figure><p>测试以下<code>立即抢购</code>的完整流程，可以看到逻辑都没啥问题</p><p>其实上线秒杀后，应该把秒杀上架的库存提前在库存服务锁定住，等秒杀结束后如果<code>redis</code>里还有库存，再解锁<code>redis</code>里剩余数量的库存</p><p>上架秒杀商品的时候，每一个数据都有过期时间。 秒杀后续的流程，简化了收货地址等信息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.1.5.5.5.4.png" alt="GIF 2022-8-28 19-53-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-53-13</figcaption></figure><h2 id="_7-2、springcloud-alibaba-sentinel" tabindex="-1"><a class="header-anchor" href="#_7-2、springcloud-alibaba-sentinel" aria-hidden="true">#</a> 7.2、SpringCloud Alibaba-Sentinel</h2><h3 id="_7-2-1、简介" tabindex="-1"><a class="header-anchor" href="#_7-2-1、简介" aria-hidden="true">#</a> 7.2.1、简介</h3><h4 id="_1、熔断降级限流" tabindex="-1"><a class="header-anchor" href="#_1、熔断降级限流" aria-hidden="true">#</a> 1、熔断降级限流</h4><h5 id="什么是熔断" tabindex="-1"><a class="header-anchor" href="#什么是熔断" aria-hidden="true">#</a> <strong>什么是熔断</strong></h5><p>A 服务调用 B 服务的某个功能，由于网络不稳定问题，或者 B 服务卡机，导致功能时间超长。如果这样子的次数太多。我们就可以直接将 B 断路了（A 不再请求 B 接口），凡是调用 B 的直接返回降级数据，不必等待 B 的超长执行。 这样 B 的故障问题，就不会级联影响到 A。</p><h5 id="什么是降级" tabindex="-1"><a class="header-anchor" href="#什么是降级" aria-hidden="true">#</a> <strong>什么是降级</strong></h5><p>整个网站处于流量高峰期，服务器压力剧增，根据当前业务情况及流量，对一些服务和页面进行有策略的降级[停止服务，所有的调用直接返回降级数据]。以此缓解服务器资源的的压力，以保证核心业务的正常运行，同时也保持了客户和大部分客户的得到正确的相应。</p><h5 id="熔断与降级异同" tabindex="-1"><a class="header-anchor" href="#熔断与降级异同" aria-hidden="true">#</a> 熔断与降级异同</h5><p>相同点：</p><p>1、为了保证集群大部分服务的可用性和可靠性，防止崩溃，牺牲小我</p><p>2、用户最终都是体验到某个功能不可用不同点：</p><p>异同点</p><p>1、熔断是被调用方故障，触发的系统主动规则</p><p>2、降级是基于全局考虑，停止一些正常服务，释放资源</p><h5 id="什么是限流" tabindex="-1"><a class="header-anchor" href="#什么是限流" aria-hidden="true">#</a> 什么是限流</h5><p>对打入服务的请求流量进行控制，使服务能够承担不超过自己能力的流量压力</p><p>项目地址：https://github.com/alibaba/Sentinel</p><p>官方文档：<code>https://github.com/alibaba/Sentinel/wiki/介绍</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.1.1.png" alt="image-20220828204432369" tabindex="0" loading="lazy"><figcaption>image-20220828204432369</figcaption></figure><p>官方网址：https://sentinelguard.io/zh-cn/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.1.2.png" alt="image-20220828204441371" tabindex="0" loading="lazy"><figcaption>image-20220828204441371</figcaption></figure><h4 id="_2、sentinel-分布式系统的流量防卫兵" tabindex="-1"><a class="header-anchor" href="#_2、sentinel-分布式系统的流量防卫兵" aria-hidden="true">#</a> 2、Sentinel: 分布式系统的流量防卫兵</h4><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.2.1.png" alt="Sentinel Logo" tabindex="0" loading="lazy"><figcaption>Sentinel Logo</figcaption></figure><h5 id="sentinel-是什么" tabindex="-1"><a class="header-anchor" href="#sentinel-是什么" aria-hidden="true">#</a> Sentinel 是什么？</h5><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。<a href="https://sentinelguard.io/" target="_blank" rel="noopener noreferrer">Sentinel<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 以流量为切入点，从流量控制、流量路由、熔断降级、系统自适应过载保护、热点流量防护等多个维度保护服务的稳定性。</p><h5 id="sentinel-特征" tabindex="-1"><a class="header-anchor" href="#sentinel-特征" aria-hidden="true">#</a> Sentinel 特征</h5><ul><li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li><li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li><li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。</li><li><strong>完善的 SPI 扩展机制</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul><p>Sentinel 的主要特性：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.2.2.png" alt="Sentinel-features-overview" tabindex="0" loading="lazy"><figcaption>Sentinel-features-overview</figcaption></figure><p>Sentinel 的开源生态：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.2.3.png" alt="Sentinel-opensource-eco" tabindex="0" loading="lazy"><figcaption>Sentinel-opensource-eco</figcaption></figure><p>Sentinel 分为两个部分:</p><ul><li>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li><li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li></ul><h5 id="sentinel-基本概念" tabindex="-1"><a class="header-anchor" href="#sentinel-基本概念" aria-hidden="true">#</a> Sentinel 基本概念</h5><p>资源</p><p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码。在接下来的文档中，我们都会用资源来描述代码块。</p><p><strong>只要通过</strong> <strong>Sentinel API</strong> <strong>定义的代码，就是资源，能够被</strong> <strong>Sentinel</strong> <strong>保护起来</strong>。大部分情况下， 可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p><p>规则</p><p>围绕资源的实时状态设定的规则，可以包括<strong>流量控制规则</strong>、<strong>熔断降级规则</strong>以及<strong>系统保护规</strong> <strong>则</strong>。所有规则可以动态实时调整。</p><h5 id="hystrix-与-sentinel-比较" tabindex="-1"><a class="header-anchor" href="#hystrix-与-sentinel-比较" aria-hidden="true">#</a> Hystrix 与 Sentinel 比较</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.2.4.png" alt="image-20220828205909056" tabindex="0" loading="lazy"><figcaption>image-20220828205909056</figcaption></figure><h4 id="_3、使用sentinel文档" tabindex="-1"><a class="header-anchor" href="#_3、使用sentinel文档" aria-hidden="true">#</a> 3、使用Sentinel文档</h4><p>使用Sentinel在线文档：<code>https://github.com/alibaba/Sentinel/wiki/如何使用</code></p><p>使用Sentinel离线文档： <a href="code/7.2.1.3.Sentinel使用.md">Sentinel使用</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.3.png" alt="image-20220828221835525" tabindex="0" loading="lazy"><figcaption>image-20220828221835525</figcaption></figure><h4 id="_4、整合文档" tabindex="-1"><a class="header-anchor" href="#_4、整合文档" aria-hidden="true">#</a> 4、整合文档</h4><p>整合SpringBoot在线文档：https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel</p><p>整合SpringBoot离线文档：<a href="code/7.2.1.4.Sentinel整合.md">整合SpringBoot</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.1.4.png" alt="image-20220828222732748" tabindex="0" loading="lazy"><figcaption>image-20220828222732748</figcaption></figure><h3 id="_7-2-2、整合sentinel" tabindex="-1"><a class="header-anchor" href="#_7-2-2、整合sentinel" aria-hidden="true">#</a> 7.2.2、整合Sentinel</h3><h4 id="_1、添加配置-1" tabindex="-1"><a class="header-anchor" href="#_1、添加配置-1" aria-hidden="true">#</a> 1、添加配置</h4><h5 id="_1、引入依赖" tabindex="-1"><a class="header-anchor" href="#_1、引入依赖" aria-hidden="true">#</a> 1、引入依赖</h5><p>在<code>gulimall-common</code>模块的<code>pom.xml</code>文件里添加<code>sentinel</code>依赖</p><p>由于主流框架的默认适配，因此可以不配置受保护的资源，默认都是受保护的的</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.1.png" alt="image-20220828223407840" tabindex="0" loading="lazy"><figcaption>image-20220828223407840</figcaption></figure><h5 id="_2、下载仪表盘" tabindex="-1"><a class="header-anchor" href="#_2、下载仪表盘" aria-hidden="true">#</a> 2、下载仪表盘</h5><p>点击<code>1.Project</code>，让其展开，直接输入<code>sentinel</code>即可搜索，可以看到<code>com. alibaba.csp:sentinel-core</code>的版本为<code>1.6.3</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.2.1.png" alt="image-20220828223650514" tabindex="0" loading="lazy"><figcaption>image-20220828223650514</figcaption></figure><p>在 https://github.com/alibaba/Sentinel/releases?page=1 页面里找到与该版本对应的<code>jar</code>包，然后下载</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.2.2.png" alt="image-20220828224058293" tabindex="0" loading="lazy"><figcaption>image-20220828224058293</figcaption></figure><p>使用如下命令，启动<code>sentinel</code>仪表盘</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> sentinel-dashboard-1.6.3.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.2.3.png" alt="image-20220828224415756" tabindex="0" loading="lazy"><figcaption>image-20220828224415756</figcaption></figure><h5 id="_3、添加配置" tabindex="-1"><a class="header-anchor" href="#_3、添加配置" aria-hidden="true">#</a> 3、添加配置</h5><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>文件里添加如下配置，指定<code>sentinel</code>仪表盘的<code>域名+端口</code>，然后随便配一个本服务与sentinel控制台建立连接所用端口(随便指定一个端口，只要没被占用就行，默认为8719)</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#dashboard所用端口</span>
<span class="token key attr-name">spring.cloud.sentinel.transport.dashboard</span><span class="token punctuation">=</span><span class="token value attr-value">localhost:8080</span>
<span class="token comment">#本服务与sentinel控制台建立连接所用端口(随便指定一个端口，只要没被占用就行，默认为8719)</span>
<span class="token key attr-name">spring.cloud.sentinel.transport.port</span><span class="token punctuation">=</span><span class="token value attr-value">8719</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.3.png" alt="image-20220830190847834" tabindex="0" loading="lazy"><figcaption>image-20220830190847834</figcaption></figure><h5 id="_4、添加代码" tabindex="-1"><a class="header-anchor" href="#_4、添加代码" aria-hidden="true">#</a> 4、添加代码</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类的<code>getCurrentSeckillSkus</code>方法的开头添加<code>log.info(&quot;currentSeckillSkus正在执行...&quot;);</code>，用于测试是否访问了该方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/currentSeckillSkus&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;currentSeckillSkus正在执行...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> vos <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.4.1.png" alt="image-20220830191851586" tabindex="0" loading="lazy"><figcaption>image-20220830191851586</figcaption></figure><p>将<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.scheduled.HelloSchedule</code>类的<code>hello</code>方法注释掉，以取消这个定时任务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.4.2.png" alt="image-20220830192311228" tabindex="0" loading="lazy"><figcaption>image-20220830192311228</figcaption></figure><h5 id="_5、测试-2" tabindex="-1"><a class="header-anchor" href="#_5、测试-2" aria-hidden="true">#</a> 5、测试</h5><p>启动<code>GulimallGatewayApplication</code>服务和<code>GulimallSeckillApplication</code>服务，打开 http://localhost:8080 页面，可以看到已经进入到了<code>Sentinel</code>的登录页面了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.5.1.png" alt="image-20220828224602517" tabindex="0" loading="lazy"><figcaption>image-20220828224602517</figcaption></figure><p>用户名和密码都为<code>sentinel</code>，输入用户名和密码后，进入到了 http://localhost:8080/#/dashboard/home 页面，可以看到什么都没有，因为这是懒加载方式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.5.2.png" alt="image-20220828224740812" tabindex="0" loading="lazy"><figcaption>image-20220828224740812</figcaption></figure><p>访问 http://seckill.gulimall.com/currentSeckillSkus 请求并不断刷新，刷新 http://localhost:8080/#/dashboard/home 页面，可以看待已经显示<code>gulimall-seckill</code>模块了，点击<code>gulimall-seckill</code>模块，再点击<code>簇点电路</code>，即可看到<code>/currentSeckillSkus</code>这个请求了。给该请求添加<code>单机阈值</code>为<code>1</code>，再次访问 http://seckill.gulimall.com/currentSeckillSkus 请求并不断刷新，可以看到只有一次请求成功了。（一个资源可以同时有多个限流规则，检查规则时会依次检查。）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.1.5.3.gif" alt="GIF 2022-8-30 19-32-27" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-30 19-32-27</figcaption></figure><h5 id="_6、流量控制" tabindex="-1"><a class="header-anchor" href="#_6、流量控制" aria-hidden="true">#</a> 6、流量控制</h5><p><a href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E8%A7%84%E5%88%99-flowrule" target="_blank" rel="noopener noreferrer">点击查看流量控制规则<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><table><thead><tr><th>Field</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>resource</td><td>资源名，资源名是限流规则的作用对象</td><td></td></tr><tr><td>count</td><td>限流阈值</td><td></td></tr><tr><td>grade</td><td>限流阈值类型，QPS 模式（1）或并发线程数模式（0）</td><td>QPS 模式</td></tr><tr><td>limitApp</td><td>流控针对的调用来源</td><td><code>default</code>，代表不区分调用来源</td></tr><tr><td>strategy</td><td>调用关系限流策略：直接、链路、关联</td><td>根据资源本身（直接）</td></tr><tr><td>controlBehavior</td><td>流控效果（直接拒绝/WarmUp/匀速+排队等待），不支持按调用关系限流</td><td>直接拒绝</td></tr><tr><td>clusterMode</td><td>是否集群限流</td><td>否</td></tr></tbody></table><h4 id="_2、添加健康管理" tabindex="-1"><a class="header-anchor" href="#_2、添加健康管理" aria-hidden="true">#</a> 2、添加健康管理</h4><h5 id="_1、数据的实时监控、审计、健康及指标信息" tabindex="-1"><a class="header-anchor" href="#_1、数据的实时监控、审计、健康及指标信息" aria-hidden="true">#</a> 1、数据的实时监控、审计、健康及指标信息</h5><p>查看文档： <a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel" target="_blank" rel="noopener noreferrer">Endpoint 支持<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.1.1.gif" alt="GIF 2022-8-31 20-41-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-31 20-41-38</figcaption></figure><p>在使用 Endpoint 特性之前需要在 Maven 中添加 <code>spring-boot-starter-actuator</code> 依赖，并在配置中允许 Endpoints 的访问。</p><ul><li>Spring Boot 1.x 中添加配置 <code>management.security.enabled=false</code>。暴露的 endpoint 路径为 <code>/sentinel</code></li><li>Spring Boot 2.x 中添加配置 <code>management.endpoints.web.exposure.include=*</code>。暴露的 endpoint 路径为 <code>/actuator/sentinel</code></li></ul><p>Sentinel Endpoint 里暴露的信息非常有用。包括当前应用的所有规则信息、日志目录、当前实例的 IP，Sentinel Dashboard 地址，Block Page，应用与 Sentinel Dashboard 的心跳频率等等信息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.1.2.png" alt="image-20220830194520683" tabindex="0" loading="lazy"><figcaption>image-20220830194520683</figcaption></figure><h5 id="_2、启用springboot健康管理" tabindex="-1"><a class="header-anchor" href="#_2、启用springboot健康管理" aria-hidden="true">#</a> 2、启用SpringBoot健康管理</h5><p>在<code>gulimall-seckill</code>模块的<code>pom.xml</code>文件里添加<code>actuator</code>健康管理依赖</p><p>(如果在<code>gulimall-order</code>设置会循环依赖，后面会说)</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--健康管理--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.2.1.png" alt="image-20220830194553967" tabindex="0" loading="lazy"><figcaption>image-20220830194553967</figcaption></figure><p>以<code>jmx</code>方式暴露健康信息（即在<code>JConsole</code>、<code>jvisualvm</code>等扩展上可以看到健康信息，默认只使用这种方式暴露健康信息。还可以配置以<code>web</code>方式暴露健康信息，这样不仅可以在扩展上看到这些信息，也可以通过浏览器看到这些健康信息）</p><blockquote><p>参见：<a href="https://zh.wikipedia.org/wiki/JMX" target="_blank" rel="noopener noreferrer">Java Management Extensions<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>JMX</strong>（英语：Java Management Extensions，即Java管理扩展）是<a href="https://zh.wikipedia.org/wiki/Java" target="_blank" rel="noopener noreferrer">Java<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>平台上为应用程序、设备、系统等植入管理功能的框架。JMX可以跨越一系列异构<a href="https://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener noreferrer">操作系统<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>平台、系统<a href="https://zh.wikipedia.org/wiki/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">体系结构<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>和<a href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener noreferrer">网络传输协议<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，灵活的开发无缝集成的系统、网络和服务管理应用。</p></blockquote><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#健康管理暴露所有端点</span>
<span class="token key attr-name">management.endpoints.jmx.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">&#39;*&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.2.2.png" alt="image-20220830195321824" tabindex="0" loading="lazy"><figcaption>image-20220830195321824</figcaption></figure><h5 id="_3、修改限流后返回的数据" tabindex="-1"><a class="header-anchor" href="#_3、修改限流后返回的数据" aria-hidden="true">#</a> 3、修改限流后返回的数据</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加如下枚举，用于返回限流数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 同一个接口QPS每秒发送的请求数过多
 */</span>
<span class="token function">TOO_MANY_REQUEST</span><span class="token punctuation">(</span><span class="token number">10003</span><span class="token punctuation">,</span><span class="token string">&quot;请求流量过大异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.3.1.png" alt="image-20220830200955651" tabindex="0" loading="lazy"><figcaption>image-20220830200955651</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.config</code>包里添加<code>SeckillSentinelConfig</code>配置类，用于定制<code>Sentinel</code>限流后返回的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">UrlBlockHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">WebCallbackManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span></span><span class="token class-name">BlockException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BizCodeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/30
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSentinelConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">SeckillSentinelConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">WebCallbackManager</span><span class="token punctuation">.</span><span class="token function">setUrlBlockHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UrlBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blocked</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token class-name">R</span> error <span class="token operator">=</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                httpServletResponse<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                httpServletResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                httpServletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.3.2.png" alt="image-20220830203705864" tabindex="0" loading="lazy"><figcaption>image-20220830203705864</figcaption></figure><p>访问 http://seckill.gulimall.com/currentSeckillSkus 请求，然后在 http://localhost:8080/#/dashboard/home 里点击<code>gulimall-seckill</code>里的<code>流控规则</code>，点击<code>新增流控规则</code>，在<code>新增流控规则</code>里<code>资源名</code>输入<code>/currentSeckillSkus</code>，<code>单机阈值</code>输入<code>1</code>,点<code>新建</code>，多刷新 http://seckill.gulimall.com/currentSeckillSkus 请求，已经返回了自定义的流控后请求失败的结果了， 返回<code>Sentinel</code>仪表盘可以看到实时监控等信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.2.3.3.gif" alt="GIF 2022-8-30 20-41-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-30 20-41-54</figcaption></figure><h4 id="_3、其他模块添加健康管理" tabindex="-1"><a class="header-anchor" href="#_3、其他模块添加健康管理" aria-hidden="true">#</a> 3、其他模块添加健康管理</h4><h5 id="_1、订单模块添加健康管理" tabindex="-1"><a class="header-anchor" href="#_1、订单模块添加健康管理" aria-hidden="true">#</a> 1、订单模块添加健康管理</h5><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件里添加<code>actuator</code>健康管理依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--健康管理--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.1.1.png" alt="image-20220830205407446" tabindex="0" loading="lazy"><figcaption>image-20220830205407446</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里，添加<code>Sentinel dashboard</code>配置和<code>健康管理</code>配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#dashboard所用端口</span>
<span class="token key attr-name">spring.cloud.sentinel.transport.dashboard</span><span class="token punctuation">=</span><span class="token value attr-value">localhost:8080</span>
<span class="token comment">#本服务与sentinel控制台建立连接所用端口(随便指定一个端口，只要没被占用就行，默认为8719)</span>
<span class="token key attr-name">spring.cloud.sentinel.transport.port</span><span class="token punctuation">=</span><span class="token value attr-value">8719</span>
<span class="token comment">#健康管理暴露所有端点</span>
<span class="token key attr-name">management.endpoints.jmx.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">&#39;*&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.1.2.png" alt="image-20220830205414524" tabindex="0" loading="lazy"><figcaption>image-20220830205414524</figcaption></figure><h5 id="_2、循环依赖" tabindex="-1"><a class="header-anchor" href="#_2、循环依赖" aria-hidden="true">#</a> 2、循环依赖</h5><p>重启<code>GulimallOrderApplication</code>模块，报了<code>The dependencies of some of the beans in the application context form a cycle</code>（<code>应用上下文中的一些bean的依赖关系形成了一个循环</code>），也就是循环依赖。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Error starting ApplicationContext. To display the conditions report re-run your application with <span class="token string">&#39;debug&#39;</span> enabled.
<span class="token number">2022</span>-08-30 <span class="token number">20</span>:53:52.664 ERROR <span class="token number">14640</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> o.s.b.d.LoggingFailureAnalysisReporter   <span class="token builtin class-name">:</span> 

***************************
APPLICATION FAILED TO START
***************************

Description:

The dependencies of some of the beans <span class="token keyword">in</span> the application context form a cycle:

   servletEndpointRegistrar defined <span class="token keyword">in</span> class path resource <span class="token punctuation">[</span>org/springframework/boot/actuate/autoconfigure/endpoint/web/ServletEndpointManagementContextConfiguration<span class="token variable">$WebMvcServletEndpointManagementContextConfiguration</span>.class<span class="token punctuation">]</span>
      ↓
   healthEndpoint defined <span class="token keyword">in</span> class path resource <span class="token punctuation">[</span>org/springframework/boot/actuate/autoconfigure/health/HealthEndpointConfiguration.class<span class="token punctuation">]</span>
      ↓
   healthIndicatorRegistry defined <span class="token keyword">in</span> class path resource <span class="token punctuation">[</span>org/springframework/boot/actuate/autoconfigure/health/HealthIndicatorAutoConfiguration.class<span class="token punctuation">]</span>
      ↓
   org.springframework.boot.actuate.autoconfigure.amqp.RabbitHealthIndicatorAutoConfiguration
┌─────┐
<span class="token operator">|</span>  rabbitTemplate defined <span class="token keyword">in</span> class path resource <span class="token punctuation">[</span>org/springframework/boot/autoconfigure/amqp/RabbitAutoConfiguration<span class="token variable">$RabbitTemplateConfiguration</span>.class<span class="token punctuation">]</span>
↑     ↓
<span class="token operator">|</span>  myRabbitConfig <span class="token punctuation">(</span>field org.springframework.amqp.rabbit.core.RabbitTemplate com.atguigu.gulimall.order.config.MyRabbitConfig.rabbitTemplate<span class="token punctuation">)</span>
└─────┘
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.2.1.png" alt="image-20220830205546089" tabindex="0" loading="lazy"><figcaption>image-20220830205546089</figcaption></figure><p>上面可能不够明显，让其本来是同一行的信息都一行显示(一行显示不下，不显示到下一行)后，可以看到如下依赖关系，很明显<code>rabbitTemplate</code>和<code>myRabbitConfig</code>形成了一个循环</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.2.2.png" alt="image-20220830210226251" tabindex="0" loading="lazy"><figcaption>image-20220830210226251</figcaption></figure><p>这是因为我们在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类里，注入了<code>RabbitTemplate</code>，还定制了<code>MessageConverter</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.2.3.png" alt="image-20220830211036893" tabindex="0" loading="lazy"><figcaption>image-20220830211036893</figcaption></figure><p>而在<code>org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration</code>自动配置类里，向容器中放<code>RabbitTemplate</code>的方法中使用了<code>MessageConverter</code>，这样就导致，我们注入<code>RabbitTemplate</code>时向容器中找该类，然后调用该<code>rabbitTemplate(ConnectionFactory connectionFactory)</code>方法向容器中存放<code>RabbitTemplate</code>，而在该类里向容器中要<code>MessageConverter</code>，而<code>MessageConverter</code>被我们定制化为了<code>Jackson2JsonMessageConverter</code>，于是我们写的<code>MyRabbitConfig</code>类和别框架写的<code>RabbitAutoConfiguration</code>类就产生了循环依赖。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.2.4.png" alt="image-20220830211221193" tabindex="0" loading="lazy"><figcaption>image-20220830211221193</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类里添加<code>rabbitTemplate(ConnectionFactory connectionFactory)</code>方法，我们自己向容器中存放<code>RabbitTemplate</code>，自己设置我们定制的<code>MessageConverter</code></p><p>删除<code>RabbitTemplate rabbitTemplate;</code>字段上的<code>@Autowired</code>注解，和<code>initRabbitTemplate</code>方法上的<code>@PostConstruct</code>注解</p><p><a href="code/7.2.2.3.2.MyRabbitConfig.java">点击查看<code>MyRabbitConfig</code>类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Primary</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMessageConverter</span><span class="token punctuation">(</span><span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initRabbitTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.2.5.png" alt="image-20220830211601054" tabindex="0" loading="lazy"><figcaption>image-20220830211601054</figcaption></figure><h5 id="_3、其他模块添加配置" tabindex="-1"><a class="header-anchor" href="#_3、其他模块添加配置" aria-hidden="true">#</a> 3、其他模块添加配置</h5><p>给其他模块(<code>gulimall-auth-server</code>、<code>gulimall-cart</code>、<code>gulimall-coupon</code>、<code>gulimall-gateway</code>、<code>gulimall-member</code>、<code>gulimall-product</code>、<code>gulimall-search</code>、<code>gulimall-third-party</code>、<code>gulimall-ware</code>)添加配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.1.png" alt="image-20220830213210941" tabindex="0" loading="lazy"><figcaption>image-20220830213210941</figcaption></figure><p>在其他模块的<code>pom.xml</code>文件里添加<code>actuator</code>健康管理依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--健康管理--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.2.png" alt="image-20220830212542596" tabindex="0" loading="lazy"><figcaption>image-20220830212542596</figcaption></figure><p>在其他模块的<code>src/main/resources/application.properties</code>配置文件里，添加<code>Sentinel dashboard</code>配置和<code>健康管理</code>配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#dashboard所用端口</span>
<span class="token key attr-name">spring.cloud.sentinel.transport.dashboard</span><span class="token punctuation">=</span><span class="token value attr-value">localhost:8080</span>
<span class="token comment">#本服务与sentinel控制台建立连接所用端口(随便指定一个端口，只要没被占用就行，默认为8719)</span>
<span class="token key attr-name">spring.cloud.sentinel.transport.port</span><span class="token punctuation">=</span><span class="token value attr-value">8719</span>

<span class="token comment">#健康管理暴露所有端点</span>
<span class="token key attr-name">management.endpoints.jmx.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">&#39;*&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.3.png" alt="image-20230110095623813" tabindex="0" loading="lazy"><figcaption>image-20230110095623813</figcaption></figure><p>走一遍下单流程，在<code>Sentinel</code>的控制台里，可以看到这些服务都显示出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.4.png" alt="image-20220830214931962" tabindex="0" loading="lazy"><figcaption>image-20220830214931962</figcaption></figure><p>重启<code>GulimallThirdPartyApplication</code>服务，报了如下异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-08-31 17:22:01.689 ERROR 13128 --- [           main] o.s.boot.SpringApplication               : Application run failed

org.springframework.beans.factory.BeanDefinitionStoreException: Failed to process import candidates for configuration class [com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplication]; nested exception is java.lang.IllegalStateException: Error processing condition on org.springframework.boot.actuate.autoconfigure.audit.AuditEventsEndpointAutoConfiguration
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.5.png" alt="image-20220831172712413" tabindex="0" loading="lazy"><figcaption>image-20220831172712413</figcaption></figure><p><a href="https://stackoverflow.com/questions/32758000/java-lang-illegalstateexception-error-processing-condition-on-org-springframewo" target="_blank" rel="noopener noreferrer">这是由不匹配的 Spring Boot 依赖项引起的<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>这是由于版本不匹配导致的，将<code>gulimall-third-party</code>模块的<code>pom.xml</code>文件里的<code>project -&gt; parent -&gt; version</code>父依赖的版本修改为<code>2.1.8.RELEASE</code>，将<code>project -&gt; properties -&gt; spring-cloud.version</code>微服务的版本修改为<code>Greenwich.SR3</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;version&gt;2.1.8.RELEASE&lt;/version&gt;
&lt;spring-cloud.version&gt;Greenwich.SR3&lt;/spring-cloud.version&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.6.png" alt="image-20220831173123968" tabindex="0" loading="lazy"><figcaption>image-20220831173123968</figcaption></figure><p>打开<code>gulimall-third-party</code>模块的<code>com.atguigu.gulimall.thirdparty.GulimallThirdPartyApplicationTests</code>测试类，可以看到该类报错了，这是因为<code>2.2.1.RELEASE</code>版本的<code>Spring Boot</code>使用的是<code>junit5</code>，而<code>2.1.8.RELEASE</code>版本使用的是<code>junit4</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.7.png" alt="image-20220831173247604" tabindex="0" loading="lazy"><figcaption>image-20220831173247604</figcaption></figure><p>将该测试类修改为<code>junit4</code>即可</p><p><a href="code/7.2.2.3.3.GulimallThirdPartyApplicationTests.java">点击查看<code>GulimallThirdPartyApplicationTests</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.3.3.8.png" alt="image-20220831173330424" tabindex="0" loading="lazy"><figcaption>image-20220831173330424</figcaption></figure><h4 id="_4、流控规则" tabindex="-1"><a class="header-anchor" href="#_4、流控规则" aria-hidden="true">#</a> 4、流控规则</h4><h5 id="_1、集群阈值模式-单机均摊" tabindex="-1"><a class="header-anchor" href="#_1、集群阈值模式-单机均摊" aria-hidden="true">#</a> 1、集群阈值模式--单机均摊</h5><p>单机均摊：该模式下配置的阈值等同于单机能够承受的限额，token server 会根据客户端对应的 namespace（默认为 project.name 定义的应用名）下的连接数来计算总的阈值（比如独立模式下有 3 个 client 连接到了 token server，然后配的单机均摊阈值为 10，则计算出的集群总量就为 30）；</p><p>设置的阈值为<code>10</code>，则每台机器的阈值都为<code>10</code></p><p>全局模式：配置的阈值等同于整个集群的总阈值。</p><p>每台机器分得的<code>QPS/线程数</code>不一样，但这些机器分得的总数为配置的阈值。</p><p>参考链接：https://zhuanlan.zhihu.com/p/364009386</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.1.png" alt="image-20220831174304830" tabindex="0" loading="lazy"><figcaption>image-20220831174304830</figcaption></figure><h5 id="_2、流控模式-直连" tabindex="-1"><a class="header-anchor" href="#_2、流控模式-直连" aria-hidden="true">#</a> 2、流控模式--直连</h5><p><a href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener noreferrer">流量控制<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ：只对该服务进行流控</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.2.png" alt="image-20220831201155540" tabindex="0" loading="lazy"><figcaption>image-20220831201155540</figcaption></figure><h5 id="_3、流控模式-关联" tabindex="-1"><a class="header-anchor" href="#_3、流控模式-关联" aria-hidden="true">#</a> 3、流控模式--关联</h5><p>假设<code>a</code>是读数据，<code>b</code>是写数据。假设<code>a</code>和<code>b</code>的并发都很大。此时设置<code>a</code>的阈值为<code>100</code>。并设置<code>a</code>关联<code>b</code>，则<code>b</code>的并发大了就对<code>a</code>限流，<code>b</code>并发不大就不对<code>a</code>限流</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.3.png" alt="image-20220831195328836" tabindex="0" loading="lazy"><figcaption>image-20220831195328836</figcaption></figure><h5 id="_4、流控模式-链路" tabindex="-1"><a class="header-anchor" href="#_4、流控模式-链路" aria-hidden="true">#</a> 4、流控模式--链路</h5><p><code>c1</code>设置<code>入口资源</code>为<code>a</code>，则只有从<code>a</code>经过一系列链路到达<code>c</code>，对<code>c</code>的流控才生效，从<code>b2</code>(或其他链路)访问到<code>c</code>则不生效</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>     a
   /   \
  b1     b2
 /        \
c          c
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.4.png" alt="image-20220831200325381" tabindex="0" loading="lazy"><figcaption>image-20220831200325381</figcaption></figure><h5 id="_5、流控效果-快速失败" tabindex="-1"><a class="header-anchor" href="#_5、流控效果-快速失败" aria-hidden="true">#</a> 5、流控效果--快速失败</h5><p>达到阈值后，直接失败。假设设置阈值为<code>500</code>，有<code>700</code>个请求，则多出的<code>200</code>个请求直接丢弃。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.5.png" alt="image-20220831201522214" tabindex="0" loading="lazy"><figcaption>image-20220831201522214</figcaption></figure><h5 id="_6、流控效果-warm-up" tabindex="-1"><a class="header-anchor" href="#_6、流控效果-warm-up" aria-hidden="true">#</a> 6、流控效果--Warm Up</h5><p>设置阈值是<code>500</code>，预热时间是<code>10s</code>，则在<code>10s</code>内缓慢增加流量，直到<code>10s</code>后才达到峰值<code>500</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.6.png" alt="image-20220831201259563" tabindex="0" loading="lazy"><figcaption>image-20220831201259563</figcaption></figure><h5 id="_7、流控效果-排队等待" tabindex="-1"><a class="header-anchor" href="#_7、流控效果-排队等待" aria-hidden="true">#</a> 7、流控效果--排队等待</h5><p>达到阈值后，排队等待。假设设置阈值为<code>500</code>，有<code>700</code>个请求，则多出的<code>200</code>个请求排队进行等待。同时可以设置超时时间，到达超时时间的请求还是丢弃。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.7.png" alt="image-20220831201759316" tabindex="0" loading="lazy"><figcaption>image-20220831201759316</figcaption></figure><h5 id="_8、参考文档" tabindex="-1"><a class="header-anchor" href="#_8、参考文档" aria-hidden="true">#</a> 8、参考文档</h5><p>在线文档： https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6</p><p>离线文档： <a href="/gulimall/code/7.2.2.4.8.%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0.html" class="">流量控制概述</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.2.4.8.png" alt="image-20220831182009572" tabindex="0" loading="lazy"><figcaption>image-20220831182009572</figcaption></figure><h3 id="_7-2-3、sentinel开启feign链路追踪" tabindex="-1"><a class="header-anchor" href="#_7-2-3、sentinel开启feign链路追踪" aria-hidden="true">#</a> 7.2.3、Sentinel开启feign链路追踪</h3><h4 id="_1、添加feign-支持" tabindex="-1"><a class="header-anchor" href="#_1、添加feign-支持" aria-hidden="true">#</a> 1、添加Feign 支持</h4><h5 id="_1、添加feign-支持参考文档" tabindex="-1"><a class="header-anchor" href="#_1、添加feign-支持参考文档" aria-hidden="true">#</a> 1、添加Feign 支持参考文档</h5><p>整个调用链只发现了这个请求，并没有发现通过<code>feign</code>远程调用的这些链路。而我们更要做的是对被调用方的熔断、保护、降级。</p><p>参考文档： <a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel#feign-%E6%94%AF%E6%8C%81" target="_blank" rel="noopener noreferrer">Feign 支持<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.1.1.gif" alt="GIF 2022-8-31 20-42-59" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-31 20-42-59</figcaption></figure><h5 id="_2、sentinel开启feign链路追踪" tabindex="-1"><a class="header-anchor" href="#_2、sentinel开启feign链路追踪" aria-hidden="true">#</a> 2、Sentinel开启feign链路追踪</h5><p>秒杀时间又过了，可以在<code>Windows</code>系统里面设置一下系统时间为秒杀范围内的时间即可以解决这个问题。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.1.2.1.png" alt="image-20220828205444897" tabindex="0" loading="lazy"><figcaption>image-20220828205444897</figcaption></figure><p>打开 http://item.gulimall.com/1.html 页面，可以看到已经显示<code>秒杀价</code>和<code>立即抢购</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.1.2.2.png" alt="image-20220828205535540" tabindex="0" loading="lazy"><figcaption>image-20220828205535540</figcaption></figure><p>给调用方的配置文件里添加<code>feign.sentinel.enabled=true</code>配置，使Sentinel开启feign链路追踪</p><p>这里的调用方是<code>gulimall-product</code>模块，该模块调用其他模块，因此在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，指定Sentinel开启feign链路追踪</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#Sentinel开启feign链路追踪</span>
<span class="token key attr-name">feign.sentinel.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.1.2.3.png" alt="image-20220829143201917" tabindex="0" loading="lazy"><figcaption>image-20220829143201917</figcaption></figure><h5 id="_3、测试-2" tabindex="-1"><a class="header-anchor" href="#_3、测试-2" aria-hidden="true">#</a> 3、测试</h5><p>再走一遍有秒杀信息的商品的下单流程，然后在<code>Sentinel</code>的控制台里点击<code>gulimall-product</code>，可以看到已经有远程调用的<code>GET:http://gulimall-seckill/sku/seckill/{skuId}</code>这个请求了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET:http://gulimall-seckill/sku/seckill/{skuId}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.1.3.png" alt="image-20220828151418451" tabindex="0" loading="lazy"><figcaption>image-20220828151418451</figcaption></figure><h4 id="_2、消费方定制远程调用失败返回结果" tabindex="-1"><a class="header-anchor" href="#_2、消费方定制远程调用失败返回结果" aria-hidden="true">#</a> 2、消费方定制远程调用失败返回结果</h4><h5 id="_1、停掉生产方" tabindex="-1"><a class="header-anchor" href="#_1、停掉生产方" aria-hidden="true">#</a> 1、停掉生产方</h5><p>由于是<code>gulimall-product</code>模块调用<code>gulimall-seckill</code>模块，因此我们可以停掉<code>GulimallSeckillApplication</code>服务，模拟生产方宕机，不能提供服务。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.1.png" alt="image-20220828151118808" tabindex="0" loading="lazy"><figcaption>image-20220828151118808</figcaption></figure><h5 id="_2、查看异常" tabindex="-1"><a class="header-anchor" href="#_2、查看异常" aria-hidden="true">#</a> 2、查看异常</h5><p>此时刷新 http://item.gulimall.com/1.html 页面，可以看到报了不能负载均衡到<code>gulimall-seckill</code>服务，这样系统的服务自治能力就很差，如果秒杀服务宕机此时就影响到了商品服务；我们应该做的是秒杀服务宕机后不影响商品服务，商品服务继续提供服务，商品服务此时不能调用秒杀服务，应该不显示商品的秒杀信息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.2.png" alt="image-20220828205956889" tabindex="0" loading="lazy"><figcaption>image-20220828205956889</figcaption></figure><h5 id="_3、消费方自定义远程调用失败返回结果" tabindex="-1"><a class="header-anchor" href="#_3、消费方自定义远程调用失败返回结果" aria-hidden="true">#</a> 3、消费方自定义远程调用失败返回结果</h5><p>可以对消费方的远程调用方法做一些限制，如果远程调用失败就返回我们自定义的返回结果。</p><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign</code>包里新建<code>fallback</code>文件夹，在<code>fallback</code>文件夹里新建<code>SeckillFeignServiceFallBack</code>类，用于设置远程调用失败后返回的默认结果。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BizCodeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">SeckillFeignService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/28
 * @Description:
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillFeignServiceFallBack</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.3.1.png" alt="image-20220828151929580" tabindex="0" loading="lazy"><figcaption>image-20220828151929580</figcaption></figure><p>然后在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign.SeckillFeignService</code>接口上，将<code>@FeignClient(&quot;gulimall-seckill&quot;)</code>修改为<code>@FeignClient(value = &quot;gulimall-seckill&quot;,fallback = SeckillFeignServiceFallBack.class)</code>，指明远程调用失败后使用<code>SeckillFeignServiceFallBack</code>来处理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;gulimall-seckill&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">SeckillFeignServiceFallBack</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.3.2.png" alt="image-20220828152430564" tabindex="0" loading="lazy"><figcaption>image-20220828152430564</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign.fallback.SeckillFeignServiceFallBack</code>类里添加日志信息，用于查看是否调用了该方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BizCodeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">SeckillFeignService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/28
 * @Description:
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillFeignServiceFallBack</span> <span class="token keyword">implements</span> <span class="token class-name">SeckillFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;熔断方法被调用...getSkuSeckillInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.3.3.png" alt="image-20220828152949670" tabindex="0" loading="lazy"><figcaption>image-20220828152949670</figcaption></figure><h5 id="_4、测试-2" tabindex="-1"><a class="header-anchor" href="#_4、测试-2" aria-hidden="true">#</a> 4、测试</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件里，将<code>com.atguigu.gulimall</code>包下的<code>error</code>级别修改为<code>info</code>级别</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.atguigu.gulimall</span><span class="token punctuation">:</span> info
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.4.1.png" alt="image-20220828152754109" tabindex="0" loading="lazy"><figcaption>image-20220828152754109</figcaption></figure><p>重启<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.4.2.png" alt="image-20220828153102628" tabindex="0" loading="lazy"><figcaption>image-20220828153102628</figcaption></figure><p>刷新 http://item.gulimall.com/1.html 页面，这次就不报错了，并且没有显示秒杀信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.4.3.png" alt="image-20220828153155146" tabindex="0" loading="lazy"><figcaption>image-20220828153155146</figcaption></figure><p>此时<code>GulimallProductApplication</code>服务的控制台已经显示<code>熔断方法被调用...getSkuSeckillInfo</code>，表明刚刚写的<code>SeckillFeignServiceFallBack</code>远程调用失败处理类已经生效了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-08-28 15:33:44.029  INFO 14668 --- [ool-2-thread-15] c.a.g.p.f.f.SeckillFeignServiceFallBack  : 熔断方法被调用...getSkuSeckillInfo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.4.4.png" alt="image-20220828153403769" tabindex="0" loading="lazy"><figcaption>image-20220828153403769</figcaption></figure><h5 id="_5、设置远程调用熔断等待时间" tabindex="-1"><a class="header-anchor" href="#_5、设置远程调用熔断等待时间" aria-hidden="true">#</a> 5、设置远程调用熔断等待时间</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.controller.SeckillController</code>类里，修改<code>getSkuSeckillInfo</code>方法，让其睡眠<code>300</code>毫秒，模拟生产方逻辑复杂，执行时间长。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 查询指定sku的一个秒杀信息
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sku/seckill/{skuId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SeckillSkuRedisTo</span> <span class="token keyword">to</span> <span class="token operator">=</span> seckillService<span class="token punctuation">.</span><span class="token function">getSkuSeckillInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.5.1.png" alt="image-20220828154723077" tabindex="0" loading="lazy"><figcaption>image-20220828154723077</figcaption></figure><p>启动<code>GulimallSeckillApplication</code>服务，没设置降级前，刷新页面，然后疯狂按<code>f5</code>刷新，可用看到怎么都不会调用降级方法。</p><p>设置<code>RT</code>(响应时间)为<code>1ms</code>，时间窗口为<code>10s</code>后，当在<code>10s</code>内的请求响应时间超过<code>1ms</code>的次数大于<code>最小请求数目</code>(默认为<code>5</code>)后，在这个<code>10s</code>内的后面的请求都会被熔断。当超过这个<code>10s</code>的时间段后又会再次恢复访问，又重新进行计数。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.5.2.gif" alt="GIF 2022-8-28 16-17-12" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 16-17-12</figcaption></figure><h5 id="_6、熔断降级策略" tabindex="-1"><a class="header-anchor" href="#_6、熔断降级策略" aria-hidden="true">#</a> 6、<a href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7" target="_blank" rel="noopener noreferrer">熔断降级策略<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h5><p>Sentinel 提供以下几种熔断策略：</p><ul><li>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</li><li>异常比例 (<code>ERROR_RATIO</code>)：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</li><li>异常数 (<code>ERROR_COUNT</code>)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li></ul><p><strong>熔断降级规则说明</strong></p><p>熔断降级规则（DegradeRule）包含下面几个重要的属性：</p><table><thead><tr><th>Field</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>resource</td><td>资源名，即规则的作用对象</td><td></td></tr><tr><td>grade</td><td>熔断策略，支持慢调用比例/异常比例/异常数策略</td><td>慢调用比例</td></tr><tr><td>count</td><td>慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例/异常数模式下为对应的阈值</td><td></td></tr><tr><td>timeWindow</td><td>熔断时长，单位为 s</td><td></td></tr><tr><td>minRequestAmount</td><td>熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）</td><td>5</td></tr><tr><td>statIntervalMs</td><td>统计时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）</td><td>1000 ms</td></tr><tr><td>slowRatioThreshold</td><td>慢调用比例阈值，仅慢调用比例模式有效（1.8.0 引入）</td><td></td></tr></tbody></table><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.6.png" alt="image-20220828162939048" tabindex="0" loading="lazy"><figcaption>image-20220828162939048</figcaption></figure><h5 id="_7、总结" tabindex="-1"><a class="header-anchor" href="#_7、总结" aria-hidden="true">#</a> 7、总结</h5><p>使用Sentinel来保护feign远程调用:熔断; 1)、调用方的熔断保护: feign.sentinel.enabled=true 2)、调用方手动指定远程服务的降级策略。远程服务被降级处理。触发我们的熔断回调方法 3)、超大流量的时候，必须牺牲一 些远程服务。在服务的提供方(远程服务)指定降级策略; 提供方是在运行。但是不运行自己的业务逻辑，返回的是默认的降级数据(限流的数据)，即<code>SeckillSentinelConfig</code>类配置的返回的降级后的数据(发送方是熔断，远程服务是降级)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSentinelConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">SeckillSentinelConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">WebCallbackManager</span><span class="token punctuation">.</span><span class="token function">setUrlBlockHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UrlBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blocked</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token class-name">R</span> error <span class="token operator">=</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                httpServletResponse<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                httpServletResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                httpServletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.7.1.png" alt="image-20220828163157492" tabindex="0" loading="lazy"><figcaption>image-20220828163157492</figcaption></figure><p>为每个服务(<code>gulimall-auth-server</code>、<code>gulimall-cart</code>、<code>gulimall-coupon</code>、<code>gulimall-member</code>、<code>gulimall-order</code>、<code>gulimall-search</code>、<code>gulimall-seckill</code>、<code>gulimall-third-party</code>、<code>gulimall-ware</code>)都配置Sentinel开启feign链路追踪</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#sentinel开启feign链路追踪</span>
<span class="token key attr-name">feign.sentinel.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.7.2.png" alt="image-20220828164648978" tabindex="0" loading="lazy"><figcaption>image-20220828164648978</figcaption></figure><p>为每个服务(<code>gulimall-auth-server</code>、<code>gulimall-cart</code>、<code>gulimall-coupon</code>、<code>gulimall-member</code>、<code>gulimall-order</code>、<code>gulimall-product</code>、<code>gulimall-search</code>、<code>gulimall-third-party</code>、<code>gulimall-ware</code>)都加上<code>SeckillSentinelConfig</code>配置类</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.3.2.7.3.png" alt="image-20220828164701564" tabindex="0" loading="lazy"><figcaption>image-20220828164701564</figcaption></figure><h3 id="_7-2-4、自定义受保护资源" tabindex="-1"><a class="header-anchor" href="#_7-2-4、自定义受保护资源" aria-hidden="true">#</a> 7.2.4、<a href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8#%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90" target="_blank" rel="noopener noreferrer">自定义受保护资源<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><h4 id="_1、方法内受保护" tabindex="-1"><a class="header-anchor" href="#_1、方法内受保护" aria-hidden="true">#</a> 1、方法内受保护</h4><p>使用<code>try(Entry entry = SphU.entry(&quot;seckillSkus&quot;)) </code>尝试调用<code>SphU.entry(&quot;seckillSkus&quot;)</code>获取<code>seckillSkus</code>，如果获取不到就捕获异常。（用try-with-resources代替try-catch-finally，即根据资源，而不是根据try里的代码）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//try(需要释放的资源){}   ==&gt; 用try-with-resources代替try-catch-finally</span>
    <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;seckillSkus&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token constant">SESSIONS_CACHE_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> replace <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">SESSIONS_CACHE_PREFIX</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> replace<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> start <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> end <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&gt;=</span> start <span class="token operator">&amp;&amp;</span> time <span class="token operator">&lt;=</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//这里的 -1相当于length-1，即最后一个元素。取出的结果为[0,length-1] 包含开始和最后的元素，即所有元素</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BoundHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SKUKILL_CACHE_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            <span class="token class-name">SeckillSkuRedisTo</span> seckillSkuRedisTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//秒杀开始后可以查看到随机码</span>
                            <span class="token comment">//seckillSkuRedisTo.setRandomCode(null);</span>
                            <span class="token keyword">return</span> seckillSkuRedisTo<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//只要找到了在当前时间范围内的秒杀，不管range是否为null都退出循环(当然如果range不为null,直接就return了)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;资源被限流:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.1.1.png" alt="image-20220828150816611" tabindex="0" loading="lazy"><figcaption>image-20220828150816611</figcaption></figure><p>在<code>Sentinel 控制台</code>的<code>gulimall-seckill</code>模块里的<code> /currentSeckillSkus</code>里已经显示<code>seckillSkus</code>了，可以对<code>seckillSkus</code>进行流控，指定单机阈值等信息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.1.2.png" alt="image-20220828150520984" tabindex="0" loading="lazy"><figcaption>image-20220828150520984</figcaption></figure><p>在没对<code>seckillSkus</code>流控前，不断刷新 http://seckill.gulimall.com/currentSeckillSkus 都可以访问，对<code>seckillSkus</code>流控后，再次频繁访问 http://seckill.gulimall.com/currentSeckillSkus 页面，就开始报错了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.1.3.gif" alt="GIF 2022-8-28 15-24-52" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 15-24-52</figcaption></figure><h4 id="_2、对方法进行保护" tabindex="-1"><a class="header-anchor" href="#_2、对方法进行保护" aria-hidden="true">#</a> 2、对方法进行保护</h4><h5 id="_1、对方法进行保护" tabindex="-1"><a class="header-anchor" href="#_1、对方法进行保护" aria-hidden="true">#</a> 1、对方法进行保护</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类的<code>getCurrentSeckillSkus</code>方法上添加如下注解，即可使用<code>getCurrentSeckillSkusResource</code>资源对该方法进行保护。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@SentinelResource(&quot;getCurrentSeckillSkusResource&quot;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.2.1.1.png" alt="image-20220828151904605" tabindex="0" loading="lazy"><figcaption>image-20220828151904605</figcaption></figure><p>刷新 http://seckill.gulimall.com/currentSeckillSkus 页面，在<code>Sentinel 控制台</code>的<code>gulimall-seckill</code>模块已经显示<code>getCurrentSeckillSkusResource</code>和对应方法里的<code>seckillSkus</code>了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.2.1.2.png" alt="image-20220828152932141" tabindex="0" loading="lazy"><figcaption>image-20220828152932141</figcaption></figure><p>给<code>getCurrentSeckillSkusResource</code>和<code>seckillSkus</code>都添加流控，可以看到可以正常生效，但是<code>getCurrentSeckillSkusResource</code>的流控返回的不够友好，我们可以自定义流控后返回的页面。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.2.1.3.gif" alt="GIF 2022-8-28 15-38-12" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 15-38-12</figcaption></figure><h5 id="_2、自定义流控响应" tabindex="-1"><a class="header-anchor" href="#_2、自定义流控响应" aria-hidden="true">#</a> 2、自定义流控响应</h5><p>在<code>gulimall-seckill</code>模块的<code>com.atguigu.gulimall.seckill.service.impl.SeckillServiceImpl</code>类的<code>getCurrentSeckillSkus</code>方法上修改<code>@SentinelResource</code>注解，添加<code>,blockHandler = &quot;blockHandler&quot;</code>，指定流控后的处理。在该类添加同名、同返回类型的方法，并多添加一个<code>BlockException e</code>参数，该参数用于获取出错的信息，然后自定义流控后的处理。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 5、自定义受保护的资源
 * 1)、代码
 *      try(Entry entry = SphU. entry( &quot;seckillSkus&quot;))<span class="token punctuation">{</span>
 *      //业务逻辑
 *      <span class="token punctuation">}</span>catch(Execption e)<span class="token punctuation">{</span><span class="token punctuation">}</span>
 * 2)、基于注解。
 *      @SentineLResource(vaLue = &quot;getCurrentSeckillSkusResource&quot;, blockHandler = &quot;blockHandler&quot;)
 * 无论是1, 2方式一定要配置被限流以后的默认返回.
 * url请求可以设置统一返回WebCallbackManager
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuRedisTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentSeckillSkus</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;getCurrentSeckillSkus被限流了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;getCurrentSeckillSkusResource&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandler&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.2.2.png" alt="image-20220828154638997" tabindex="0" loading="lazy"><figcaption>image-20220828154638997</figcaption></figure><h4 id="_3、网关限流" tabindex="-1"><a class="header-anchor" href="#_3、网关限流" aria-hidden="true">#</a> 3、<a href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81" target="_blank" rel="noopener noreferrer">网关限流<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h4><h5 id="_1、添加依赖-1" tabindex="-1"><a class="header-anchor" href="#_1、添加依赖-1" aria-hidden="true">#</a> 1、添加依赖</h5><p>整合网关需要引入<code>spring-cloud-starter-alibaba-sentinel</code>和<code>spring-cloud-alibaba-sentinel-gateway</code>，由于<code>common</code>已经引入<code>spring-cloud-starter-alibaba-sentinel</code>了，因此只需引入<code>spring-cloud-alibaba-sentinel-gateway</code>就行了</p><p>在<code>gulimall-gateway</code>网关模块的<code>pom.xml</code>文件里添加<code>spring-cloud-alibaba-sentinel-gateway</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-sentinel-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.1.png" alt="image-20220828160121708" tabindex="0" loading="lazy"><figcaption>image-20220828160121708</figcaption></figure><h5 id="_2、基于qps限流" tabindex="-1"><a class="header-anchor" href="#_2、基于qps限流" aria-hidden="true">#</a> 2、基于QPS限流</h5><p>关闭<code>sentinel-dashboard-1.6.3</code>版本的<code>Sentinel仪表板</code>，启动<code>sentinel-dashboard-1.7.1.jar</code>版本的<code>sentinel仪表板</code>，首先刷新 http://seckill.gulimall.com/currentSeckillSkus 页面，让懒加载的<code>Sentinel</code>加载到该请求，然后复制在网关模块里配置的该请求对应的模块的<code>id</code>，然后打开<code>Sentinel仪表板</code>点击<code>新增网关流控规则</code>，在<code>API名称</code>输入在网关模块里配置的<code>gulimall-seckill</code>模块的<code>id</code>，即<code>gulimall_seckill_route</code>，然后在<code>QPS 阈值</code>里输入<code>1</code>，然后点击<code>新增</code>接口新增流控规则，频繁刷新 http://seckill.gulimall.com/currentSeckillSkus 页面，可以看到已经返回自定义的结果了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.2.gif" alt="GIF 2022-8-28 19-20-58" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-20-58</figcaption></figure><h5 id="_3、基于请求头限流" tabindex="-1"><a class="header-anchor" href="#_3、基于请求头限流" aria-hidden="true">#</a> 3、基于请求头限流</h5><p>还可以争对各种属性进行限流，比如<code>Client IP</code>、<code>Remote Host</code>、<code>Header</code>、<code>URL参数</code>、<code>Cookie</code>。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.3.gif" alt="GIF 2022-8-28 19-29-08" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-29-08</figcaption></figure><h5 id="_4、分组限流" tabindex="-1"><a class="header-anchor" href="#_4、分组限流" aria-hidden="true">#</a> 4、分组限流</h5><p>可以在<code>API 管理</code>里<code>新增自定义API</code>，然后对<code>API 分组</code>进行流控。</p><p>(如果没成功，需要修改<code>pom</code>文件里<code>sentinel</code>的版本号)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.4.gif" alt="GIF 2022-8-28 19-36-50" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 19-36-50</figcaption></figure><h5 id="_5、自定义限流返回数据" tabindex="-1"><a class="header-anchor" href="#_5、自定义限流返回数据" aria-hidden="true">#</a> 5、自定义限流返回数据</h5><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，重启<code>sentinel仪表板</code>和<code>所有微服务</code>，定制限流后返回的数据并未生效</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#定制限流后返回的数据(亲测不生效)</span>
<span class="token key attr-name">spring.cloud.sentinel.scg.fallback.content-type</span><span class="token punctuation">=</span><span class="token value attr-value">application/json</span>
<span class="token key attr-name">spring.cloud.sentinel.scg.fallback.response-status</span><span class="token punctuation">=</span><span class="token value attr-value">400</span>
<span class="token key attr-name">spring.cloud.sentinel.scg.fallback.response-body</span><span class="token punctuation">=</span><span class="token value attr-value">请求过多，请稍后重试</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.5.1.png" alt="image-20220828195129017" tabindex="0" loading="lazy"><figcaption>image-20220828195129017</figcaption></figure><p>在<code>gulimall-gateway</code>模块的<code>com.atguigu.gulimall.gateway.config</code>包里添加<code>SentinelGatewayConfig</code>类，用于自定义限流后返回的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>sc<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">BlockRequestHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>sc<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">GatewayCallbackManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BizCodeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>function<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/28
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelGatewayConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">SentinelGatewayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">GatewayCallbackManager</span><span class="token punctuation">.</span><span class="token function">setBlockHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BlockRequestHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//网关限流后，就会调用该回调</span>
            <span class="token comment">//Mono(单个对象) Flux(集合) 响应式编程</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> serverWebExchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">R</span> error <span class="token operator">=</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> errorJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>errorJson<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> body<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.5.2.png" alt="image-20220828213513731" tabindex="0" loading="lazy"><figcaption>image-20220828213513731</figcaption></figure><p>不断请求 http://seckill.gulimall.com/currentSeckillSkus ，可以看到已经返回自定义的数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.2.4.3.5.3.gif" alt="GIF 2022-8-28 21-38-15" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-28 21-38-15</figcaption></figure><h2 id="_7-3、sleuth-zipkin-服务链路追踪" tabindex="-1"><a class="header-anchor" href="#_7-3、sleuth-zipkin-服务链路追踪" aria-hidden="true">#</a> 7.3、Sleuth+Zipkin 服务链路追踪</h2><h3 id="_7-3-1、概述" tabindex="-1"><a class="header-anchor" href="#_7-3-1、概述" aria-hidden="true">#</a> 7.3.1、概述</h3><h4 id="_1、为什么用" tabindex="-1"><a class="header-anchor" href="#_1、为什么用" aria-hidden="true">#</a> 1、为什么用</h4><p>微服务架构是一个分布式架构，它按业务划分服务单元，一个分布式系统往往有很多个服务单元。由于服务单元数量众多，业务的复杂性，<strong>如果出现了错误和异常，很难去定位</strong>。主要体现在，<strong>一个请求可能需要调用很多个服务</strong>，而内部服务的调用复杂性，决定了问题难以定位。所以微服务架构中，必须实现分布式链路追踪，去跟进一个请求到底有哪些服务参与， 参与的顺序又是怎样的，从而达到<strong>每个请求的步骤清晰可见，出了问题，很快定位</strong>。 链路追踪组件有 Google 的 Dapper，Twitter 的 Zipkin，以及阿里的 Eagleeye （鹰眼）等，它们都是非常优秀的链路追踪开源组件。</p><h4 id="_2、基本术语" tabindex="-1"><a class="header-anchor" href="#_2、基本术语" aria-hidden="true">#</a> 2、基本术语</h4><ul><li><p>Span（跨度）：基本工作单元，发送一个远程调度任务 就会产生一个 Span，Span 是一个 64 位 ID 唯一标识的，Trace 是用另一个 64 位 ID 唯一标识的，Span 还有其他数据信息，比如摘要、时间戳事件、Span 的 ID、以及进度 ID。</p></li><li><p>Trace（跟踪）：一系列 Span 组成的一个树状结构。请求一个微服务系统的 API 接口， 这个 API 接口，需要调用多个微服务，调用每个微服务都会产生一个新的 Span，所有由这个请求产生的 Span 组成了这个 Trace。</p></li><li><p>Annotation（标注）：用来及时记录一个事件的，一些核心注解用来定义一个请求的开 始和结束 。这些注解包括以下：</p><ul><li><p>cs - Client Sent -客户端发送一个请求，这个注解描述了这个 Span 的开始</p></li><li><p>sr - Server Received -服务端获得请求并准备开始处理它，如果将其 sr 减去 cs 时间戳便可得到网络传输的时间。</p></li><li><p>ss - Server Sent （服务端发送响应）–该注解表明请求处理的完成(当请求返回客户端)，如果 ss 的时间戳减去 sr 时间戳，就可以得到服务器请求的时间。</p></li><li><p>cr - Client Received（客户端接收响应）此时 Span 的结束，如果 cr 的时间戳减去cs 时间戳便可以得到整个请求所消耗的时间。</p></li></ul></li></ul><p>(假设A-&gt;B-&gt;C，此时就会有3个Span。而Trace就只有一个，用于追踪整个链路。Annotation（标注）就相当于给Span打一个标签)</p><p>如果服务调用顺序如下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.1.2.1.png" alt="image-20220829091448319" tabindex="0" loading="lazy"><figcaption>image-20220829091448319</figcaption></figure><p>那么用以上概念完整的表示出来如下：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.1.2.2.png" alt="image-20220829091500261" tabindex="0" loading="lazy"><figcaption>image-20220829091500261</figcaption></figure><p>Span 之间的父子关系如下：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.1.2.3.png" alt="image-20220829091526049" tabindex="0" loading="lazy"><figcaption>image-20220829091526049</figcaption></figure><h3 id="_7-3-2、整合-sleuth" tabindex="-1"><a class="header-anchor" href="#_7-3-2、整合-sleuth" aria-hidden="true">#</a> 7.3.2、整合 Sleuth</h3><h4 id="_1、添加依赖-2" tabindex="-1"><a class="header-anchor" href="#_1、添加依赖-2" aria-hidden="true">#</a> 1、添加依赖</h4><p>在<code>gulimall-common</code>模块的<code>pom.xml</code>文件里的<code>project -&gt; dependencyManagement -&gt; dependencies</code>里添加如下依赖，用于对<code>spring-cloud</code>进行版本约束。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>gulimall-common</code>模块的<code>pom.xml</code>文件里的<code>project -&gt; dependencies</code>里添加<code>spring-cloud-starter-sleuth</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-sleuth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.2.1.png" alt="image-20220829092228462" tabindex="0" loading="lazy"><figcaption>image-20220829092228462</figcaption></figure><h4 id="_2、添加配置-1" tabindex="-1"><a class="header-anchor" href="#_2、添加配置-1" aria-hidden="true">#</a> 2、添加配置</h4><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，指定<code>logging.level.org.springframework.cloud.openfeign</code>包和<code>logging.level.org.springframework.cloud.sleuth</code>包下的日志级别为<code>debug</code></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">logging.level.org.springframework.cloud.openfeign</span><span class="token punctuation">:</span> <span class="token value attr-value">debug</span>
<span class="token key attr-name">logging.level.org.springframework.cloud.sleuth</span><span class="token punctuation">:</span> <span class="token value attr-value">debug</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.2.2.1.png" alt="image-20220829093736984" tabindex="0" loading="lazy"><figcaption>image-20220829093736984</figcaption></figure><p>在<code>gulimall-seckill</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加同样的配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.2.2.2.png" alt="image-20220829093740953" tabindex="0" loading="lazy"><figcaption>image-20220829093740953</figcaption></figure><p>重启各个模块，刷新 https://item.gulimall.com/1.html 页面，查看<code>GulimallProductApplication</code>服务的控制台，打印了如下日志</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>DEBUG <span class="token punctuation">[</span>gulimall-product,4333ca18c611f553,cc74b65e5467a683,false<span class="token punctuation">]</span>

gulimall-product：服务名
4333ca18c611f553：是 TranceId一条链路中，只有一个TranceId 
cc74b65e5467a683：是 spanId，链路中的基本工作单元 <span class="token function">id</span>
false：表示是否将数据输出到其他服务，true 则会把信息输出到其他可视化的服务上观察
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.2.2.3.gif" alt="GIF 2022-8-29 9-39-47" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-29 9-39-47</figcaption></figure><h3 id="_7-3-3、整合-zipkin-可视化观察" tabindex="-1"><a class="header-anchor" href="#_7-3-3、整合-zipkin-可视化观察" aria-hidden="true">#</a> 7.3.3、<strong>整合</strong> <strong>zipkin</strong> 可视化观察</h3><h4 id="_1、概述" tabindex="-1"><a class="header-anchor" href="#_1、概述" aria-hidden="true">#</a> 1、概述</h4><p>通过 Sleuth 产生的调用链监控信息，可以得知微服务之间的调用链路，但监控信息只输出到控制台不方便查看。我们需要一个图形化的工具-zipkin。Zipkin 是 Twitter 开源的分布式跟踪系统，主要用来收集系统的时序数据，从而追踪系统的调用问题。zipkin 官网地址如下： https://zipkin.io/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.1.png" alt="image-20220829105134089" tabindex="0" loading="lazy"><figcaption>image-20220829105134089</figcaption></figure><h4 id="_2、docker-安装-zipkin-服务器" tabindex="-1"><a class="header-anchor" href="#_2、docker-安装-zipkin-服务器" aria-hidden="true">#</a> 2、docker 安装 zipkin 服务器</h4><p>使用如下命令，安装 zipkin 服务器</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker run -d -p 9411:9411 openzipkin/zipkin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.2.png" alt="image-20220829095100126" tabindex="0" loading="lazy"><figcaption>image-20220829095100126</figcaption></figure><h4 id="_3、添加依赖" tabindex="-1"><a class="header-anchor" href="#_3、添加依赖" aria-hidden="true">#</a> 3、添加依赖</h4><p>在<code>gulimall-common</code>模块的<code>pom.xml</code>文件里添加<code>zipkin</code>的依赖，并删除<code>sleuth</code>的依赖（zipkin 依赖也同时包含了 sleuth，可以省略 sleuth 的引用）</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.3.png" alt="image-20220829095416340" tabindex="0" loading="lazy"><figcaption>image-20220829095416340</figcaption></figure><h4 id="_4、添加配置" tabindex="-1"><a class="header-anchor" href="#_4、添加配置" aria-hidden="true">#</a> 4、添加配置</h4><p>文档里提示我们需要进行如下配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
    <span class="token comment"># zipkin 服务器的地址</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.56.10<span class="token punctuation">:</span>9411/
    <span class="token comment">#关闭服务发现,否则Spring Cloud 会把 zipkin 的 url 当做服务名称</span>
    <span class="token key atrule">discoveryClientEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">sender</span><span class="token punctuation">:</span>
      <span class="token comment">#设置使用 http 的方式传输数据</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> web    
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
      <span class="token comment">#设置抽样采集率为100%，默认为0.1，即10%</span>
      <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此，我们可以给所有微服务的<code>src/main/resources/application.properties</code>文件里都加上如下配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># zipkin 服务器的地址</span>
<span class="token key attr-name">spring.zipkin.base-url</span><span class="token punctuation">=</span><span class="token value attr-value">http://192.168.56.10:9411/</span>
<span class="token comment">#关闭服务发现,否则Spring Cloud 会把 zipkin 的 url 当做服务名称</span>
<span class="token key attr-name">spring.zipkin.discovery-client-enabled</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token comment">##设置使用 http 的方式传输数据 (可选值：rabbit、kafka、web)</span>
<span class="token key attr-name">spring.zipkin.sender.type</span><span class="token punctuation">=</span><span class="token value attr-value">web</span>
<span class="token comment">#设置抽样采集率为100%，默认为0.1，即10%</span>
<span class="token key attr-name">spring.sleuth.sampler.probability</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.4.1.png" alt="image-20220829100727550" tabindex="0" loading="lazy"><figcaption>image-20220829100727550</figcaption></figure><p>走一遍下单的流程，访问： http://192.168.56.10:9411/ 页面。可以看到这些链路都显示出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.4.2.gif" alt="GIF 2022-8-29 10-47-31" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-29 10-47-31</figcaption></figure><p>还能显示这些链路的流向等信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.4.3.gif" alt="GIF 2022-8-29 10-58-29" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-29 10-58-29</figcaption></figure><h4 id="_5、zipkin-数据持久化" tabindex="-1"><a class="header-anchor" href="#_5、zipkin-数据持久化" aria-hidden="true">#</a> 5、Zipkin 数据持久化</h4><p>Zipkin 默认是将监控数据存储在内存的，如果 Zipkin 挂掉或重启的话，那么监控数据就会丢失。所以如果想要搭建生产可用的 Zipkin，就需要实现监控数据的持久化。而想要实现数据持久化，自然就是得将数据存储至数据库。好在 Zipkin 支持将数据存储至：</p><ul><li><p>内存（默认）</p></li><li><p>MySQL</p></li><li><p>Elasticsearch</p></li><li><p>Cassandra</p></li></ul><p>Zipkin 数据持久化相关的官方文档地址如下： https://github.com/openzipkin/zipkin#storage-component</p><p>Zipkin 支持的这几种存储方式中，内存显然是不适用于生产的，这一点开始也说了。而使用MySQL 的话，当数据量大时，查询较为缓慢，也不建议使用。Twitter 官方使用的是 Cassandra 作为 Zipkin 的存储数据库，但国内大规模用 Cassandra 的公司较少，而且 Cassandra 相关文档也不多。</p><p>综上，故采用 Elasticsearch 是个比较好的选择，关于使用 Elasticsearch 作为 Zipkin 的存储数据库的官方文档如下：</p><p><a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-server#elasticsearch-storage" target="_blank" rel="noopener noreferrer">elasticsearch-storage<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>、<a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/elasticsearch" target="_blank" rel="noopener noreferrer">zipkin-storage/elasticsearch<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>通过 docker 的方式将Zipkin 数据持久化到<code>elasticsearch</code>的命令如下</p><div class="language-docker line-numbers-mode" data-ext="docker"><pre class="language-docker"><code>docker run 
--env STORAGE_TYPE=elasticsearch 
--env ES_HOSTS=192.168.56.10:9200 
openzipkin/zipkin-dependencies
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.5.1.png" alt="image-20220829114726137" tabindex="0" loading="lazy"><figcaption>image-20220829114726137</figcaption></figure><p>使用 es 时<code>Zipkin Dependencies</code>支持的环境变量</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.3.3.5.2.png" alt="image-20220829114745615" tabindex="0" loading="lazy"><figcaption>image-20220829114745615</figcaption></figure><h2 id="高级篇总结" tabindex="-1"><a class="header-anchor" href="#高级篇总结" aria-hidden="true">#</a> 高级篇总结</h2><p>高并发有三宝：<code>缓存</code>、<code>异步</code>、<code>队排好</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/7.4.png" alt="image-20220829115133200" tabindex="0" loading="lazy"><figcaption>image-20220829115133200</figcaption></figure></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/apzs/apzs.github.io/edit/master/src/gulimall/advanced6.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: apzs@foxmaill.com">zhaoshuo</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.0.0-alpha.8</div></div></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2024 apzs</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-ldxHvpH7.js" defer></script>
  </body>
</html>
