<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.5" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://apzs.github.io/gulimall/advanced1.html"><meta property="og:site_name" content="apzs"><meta property="og:title" content="5、高级篇"><meta property="og:description" content="5、高级篇 5.1、整合Elasticsearch ElasticSearch概念-基础概念 ElasticSearch概念-倒排索引 词 记录 红海 1,2,3,4,5 行动 1,2,3 探索 2,5 特别 3,5 记录篇 4 特工 5"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-05T06:05:15.000Z"><meta property="article:author" content="apzs"><meta property="article:modified_time" content="2024-03-05T06:05:15.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"5、高级篇","image":[""],"dateModified":"2024-03-05T06:05:15.000Z","author":[{"@type":"Person","name":"apzs","url":"https://apzs.eu.org"}]}</script><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>5、高级篇 | apzs</title><meta name="description" content="5、高级篇 5.1、整合Elasticsearch ElasticSearch概念-基础概念 ElasticSearch概念-倒排索引 词 记录 红海 1,2,3,4,5 行动 1,2,3 探索 2,5 特别 3,5 记录篇 4 特工 5">
    <link rel="preload" href="/assets/style-1BJnvNLI.css" as="style"><link rel="stylesheet" href="/assets/style-1BJnvNLI.css">
    <link rel="modulepreload" href="/assets/app-ldxHvpH7.js"><link rel="modulepreload" href="/assets/advanced1.html-9bBPC8sA.js"><link rel="modulepreload" href="/assets/advanced1.html-pFoXK57F.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/assets/index.html-y3g4CpbS.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-gEURi3aX.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-OcxTIOHO.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-XR72c_om.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-ZR4Y_K2h.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-M2icssIB.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-7Kx2gTnc.js" as="script"><link rel="prefetch" href="/assets/7.git.html-qXt_wASp.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-ZcYyohxw.js" as="script"><link rel="prefetch" href="/assets/advanced3.html--EENfr4C.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-qON-1HJR.js" as="script"><link rel="prefetch" href="/assets/advanced5.html-x_FAsfet.js" as="script"><link rel="prefetch" href="/assets/advanced6.html-7fOhj-hR.js" as="script"><link rel="prefetch" href="/assets/base1.html-eTaS1DsU.js" as="script"><link rel="prefetch" href="/assets/base2.html-uamOpGZW.js" as="script"><link rel="prefetch" href="/assets/cluster.html-054M96dh.js" as="script"><link rel="prefetch" href="/assets/1.Nginx的安装部署.html-uYbd2ebL.js" as="script"><link rel="prefetch" href="/assets/10.十分钟快速建站之在线论坛Discuz部署实战.html-QY6HLKuo.js" as="script"><link rel="prefetch" href="/assets/2.Nginx的的目录结构_基本运行原理及基本配置文件.html-Y7mqlMtZ.js" as="script"><link rel="prefetch" href="/assets/3.Nginx 虚拟主机与域名解析.html-sQ96m563.js" as="script"><link rel="prefetch" href="/assets/4.ServerName匹配规则.html-3xXeBzj4.js" as="script"><link rel="prefetch" href="/assets/5.反向代理在系统结构中的应用场景.html-k5aGGu3I.js" as="script"><link rel="prefetch" href="/assets/6.nginx动静分离及Rewrite实战.html-G-FLKxx7.js" as="script"><link rel="prefetch" href="/assets/7.nginx高可用及Keepalived实战.html-zyOteMot.js" as="script"><link rel="prefetch" href="/assets/8.Nginx配置防盗链(详细了解如何配置nginx防盗链).html-ZP_L6pTq.js" as="script"><link rel="prefetch" href="/assets/9.申请阿里云免费SSL证书并配置https访问实战.html-KHpQurCY.js" as="script"><link rel="prefetch" href="/assets/index.html-JHGBtjxR.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-bjBzt6JL.js" as="script"><link rel="prefetch" href="/assets/index.html-0VkVNp2J.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-QAsMGnnc.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-w0753rG7.js" as="script"><link rel="prefetch" href="/assets/index.html-pICozyRy.js" as="script"><link rel="prefetch" href="/assets/index.html-zzfV3qLa.js" as="script"><link rel="prefetch" href="/assets/01. Object类、常用API.html-aILz-SPf.js" as="script"><link rel="prefetch" href="/assets/02. Collection、泛型.html-LtRENtkQ.js" as="script"><link rel="prefetch" href="/assets/03. List、Set.html-jTIndb1X.js" as="script"><link rel="prefetch" href="/assets/04. Map.html-ZYo--4N1.js" as="script"><link rel="prefetch" href="/assets/05. 异常、线程.html-FgqjHGj9.js" as="script"><link rel="prefetch" href="/assets/06. 线程、同步.html-Jusr_H-I.js" as="script"><link rel="prefetch" href="/assets/07. 等待与唤醒案例、线程池、Lambda表达式.html-bZAxifpd.js" as="script"><link rel="prefetch" href="/assets/08. File类、递归.html-dzCncgJ-.js" as="script"><link rel="prefetch" href="/assets/09. 字节流、字符流.html-9nm4yVmk.js" as="script"><link rel="prefetch" href="/assets/10. 缓冲流、转换流、序列化流、打印流.html-aJx7Rt0R.js" as="script"><link rel="prefetch" href="/assets/11. 网络编程.html-ixfBHZIz.js" as="script"><link rel="prefetch" href="/assets/12. 函数式接口.html-aET2xB7v.js" as="script"><link rel="prefetch" href="/assets/13. 方法引用.html-SLa6BGQT.js" as="script"><link rel="prefetch" href="/assets/14. Stream流.html-zExXMgTS.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-S4sR6ceN.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-Kh1eiS8S.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-cnv0S7AD.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-RdX4lj_8.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-Vkoji7Ak.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-Hss7GySa.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-c4I-JYNu.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-uiWCOh_t.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-D3XpIr4T.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-37R9pYDr.js" as="script"><link rel="prefetch" href="/assets/index.html-liiu_EKl.js" as="script"><link rel="prefetch" href="/assets/index.html-IxRk3Ohd.js" as="script"><link rel="prefetch" href="/assets/index.html-qiUusNr1.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-byrPjTkh.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-z3DJu42D.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-vfxkftz5.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-jIXgwym4.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-oiw13F_a.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-n8EepeqG.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-5yv9NEC_.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-nS1PYjhk.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-cBl4nVoH.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-gkZIiZ0O.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-W7g-fbAg.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-zUWuxTai.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-8TaE0Zp1.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-rnTgMrUt.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-rT8S5BXV.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-KO3HDIMu.js" as="script"><link rel="prefetch" href="/assets/1.scss基础.html-Lztop7Sb.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-uhthownJ.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-yV0wPlKP.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-DSnWzAbP.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-x8wQcT1s.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-vPTowO2E.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-Q5gjqvel.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-IkxemcdB.js" as="script"><link rel="prefetch" href="/assets/1.html.html-XP7fLhRZ.js" as="script"><link rel="prefetch" href="/assets/2.css.html-iD5KnMOI.js" as="script"><link rel="prefetch" href="/assets/3.mobile.html-k_6KIzVP.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html-cAJ4q7Ac.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-h6Mn4aXq.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-iXNFvl0G.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-eYCrWOga.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-7nS35Qvf.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html--6DfVamv.js" as="script"><link rel="prefetch" href="/assets/index.html-ANoDwuDF.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-MFo6bo05.js" as="script"><link rel="prefetch" href="/assets/01. Vue3入门.html-_QaNG_Dz.js" as="script"><link rel="prefetch" href="/assets/02. Pinia入门.html-HCgNT7sl.js" as="script"><link rel="prefetch" href="/assets/03. 项目起步.html-H_Uzdquo.js" as="script"><link rel="prefetch" href="/assets/04. Layout页.html-Ofw6qK2g.js" as="script"><link rel="prefetch" href="/assets/05. Home页.html-crUAEJfT.js" as="script"><link rel="prefetch" href="/assets/06. 一级分类页.html-pVJSzqbu.js" as="script"><link rel="prefetch" href="/assets/07. 二级分类页.html-bqYpoqHE.js" as="script"><link rel="prefetch" href="/assets/08. 商品详情.html-VolSpyaS.js" as="script"><link rel="prefetch" href="/assets/09. 登录页.html-AYgm4nmi.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-3aEzp0n4.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-5DT00V7P.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-w9X1oj35.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-SL1kR47w.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-KiZNu1Mv.js" as="script"><link rel="prefetch" href="/assets/00. uni-app前置知识.html-94R5zX1Z.js" as="script"><link rel="prefetch" href="/assets/01. 项目起步.html-r7sUKndc.js" as="script"><link rel="prefetch" href="/assets/02. 首页模块.html-_OzGqhFW.js" as="script"><link rel="prefetch" href="/assets/03. 推荐模块.html-utAtQCID.js" as="script"><link rel="prefetch" href="/assets/04. 分类模块.html-bKecFVa2.js" as="script"><link rel="prefetch" href="/assets/05. 详情模块.html-DVk1JbkT.js" as="script"><link rel="prefetch" href="/assets/06. 登录模块.html-rcIaMrj3.js" as="script"><link rel="prefetch" href="/assets/07. 用户模块.html-7eS_5DsD.js" as="script"><link rel="prefetch" href="/assets/08. 地址模块.html-fs9hAzYf.js" as="script"><link rel="prefetch" href="/assets/09. SKU模块.html-YK1MXHBh.js" as="script"><link rel="prefetch" href="/assets/10. 购物车模块.html-bkhVI477.js" as="script"><link rel="prefetch" href="/assets/11. 订单模块.html-zTJDIbZ2.js" as="script"><link rel="prefetch" href="/assets/12. 项目打包.html-Gy_cUBmf.js" as="script"><link rel="prefetch" href="/assets/index.html-9JBwGe9X.js" as="script"><link rel="prefetch" href="/assets/index.html-EjcBU5lt.js" as="script"><link rel="prefetch" href="/assets/index.html-I4z_CyW1.js" as="script"><link rel="prefetch" href="/assets/index.html-yJjipLz_.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-agnhV7l6.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-bVdW6071.js" as="script"><link rel="prefetch" href="/assets/index.html-nBxbKQIK.js" as="script"><link rel="prefetch" href="/assets/index.html-p166CSk-.js" as="script"><link rel="prefetch" href="/assets/learn.html-BD7CfiUB.js" as="script"><link rel="prefetch" href="/assets/404.html-btkZhlkE.js" as="script"><link rel="prefetch" href="/assets/index.html-T17ErqbF.js" as="script"><link rel="prefetch" href="/assets/index.html-Jib5dSeG.js" as="script"><link rel="prefetch" href="/assets/index.html-JqXNyWB5.js" as="script"><link rel="prefetch" href="/assets/index.html-hY-RGNU1.js" as="script"><link rel="prefetch" href="/assets/index.html-oqCBIS_v.js" as="script"><link rel="prefetch" href="/assets/index.html-AJMwoc2R.js" as="script"><link rel="prefetch" href="/assets/index.html-7nfKGyCc.js" as="script"><link rel="prefetch" href="/assets/index.html-IfBIxRfC.js" as="script"><link rel="prefetch" href="/assets/index.html-muoKEAuh.js" as="script"><link rel="prefetch" href="/assets/index.html-t45lBcxI.js" as="script"><link rel="prefetch" href="/assets/index.html-lAWe1giX.js" as="script"><link rel="prefetch" href="/assets/index.html-kSDPDur8.js" as="script"><link rel="prefetch" href="/assets/index.html-gbNr7hUM.js" as="script"><link rel="prefetch" href="/assets/index.html-6QthmMSB.js" as="script"><link rel="prefetch" href="/assets/index.html-42CY4ac1.js" as="script"><link rel="prefetch" href="/assets/index.html-ueDLoTJ_.js" as="script"><link rel="prefetch" href="/assets/index.html-_LMh2RFh.js" as="script"><link rel="prefetch" href="/assets/index.html-8I_4T32_.js" as="script"><link rel="prefetch" href="/assets/index.html-tzRxRAhM.js" as="script"><link rel="prefetch" href="/assets/index.html-A2W4RlcH.js" as="script"><link rel="prefetch" href="/assets/index.html-G9n0k6L7.js" as="script"><link rel="prefetch" href="/assets/index.html-CrBH0s0U.js" as="script"><link rel="prefetch" href="/assets/index.html-LY4lUlKW.js" as="script"><link rel="prefetch" href="/assets/index.html-mLa21Q4L.js" as="script"><link rel="prefetch" href="/assets/index.html-YOwGpRFB.js" as="script"><link rel="prefetch" href="/assets/index.html-hK44yUtw.js" as="script"><link rel="prefetch" href="/assets/index.html-unBKqZcs.js" as="script"><link rel="prefetch" href="/assets/index.html-XjlmNyCs.js" as="script"><link rel="prefetch" href="/assets/index.html-JK2p7ZfK.js" as="script"><link rel="prefetch" href="/assets/index.html-lzCrPyBd.js" as="script"><link rel="prefetch" href="/assets/index.html-RTbSWDU_.js" as="script"><link rel="prefetch" href="/assets/index.html-dHsCb8RY.js" as="script"><link rel="prefetch" href="/assets/index.html-KlaSRFzG.js" as="script"><link rel="prefetch" href="/assets/index.html-DGX3PCk-.js" as="script"><link rel="prefetch" href="/assets/index.html-Znc0hCnd.js" as="script"><link rel="prefetch" href="/assets/index.html-S6kMG4Fx.js" as="script"><link rel="prefetch" href="/assets/index.html-YqwzmRnM.js" as="script"><link rel="prefetch" href="/assets/index.html-egQ26E2T.js" as="script"><link rel="prefetch" href="/assets/index.html-o564GG_l.js" as="script"><link rel="prefetch" href="/assets/index.html-1somrFyk.js" as="script"><link rel="prefetch" href="/assets/index.html-lK4owPTJ.js" as="script"><link rel="prefetch" href="/assets/index.html-qqrI0K08.js" as="script"><link rel="prefetch" href="/assets/index.html-qAyUJ9W7.js" as="script"><link rel="prefetch" href="/assets/index.html-tehrrtUn.js" as="script"><link rel="prefetch" href="/assets/index.html-mMGauwho.js" as="script"><link rel="prefetch" href="/assets/index.html-m13qsTw5.js" as="script"><link rel="prefetch" href="/assets/index.html-QvL1dW2n.js" as="script"><link rel="prefetch" href="/assets/index.html-dKZ88i_K.js" as="script"><link rel="prefetch" href="/assets/index.html-onTroC3r.js" as="script"><link rel="prefetch" href="/assets/index.html-uBLya5A3.js" as="script"><link rel="prefetch" href="/assets/index.html-nKQ4V-jV.js" as="script"><link rel="prefetch" href="/assets/index.html-SU8Gk36j.js" as="script"><link rel="prefetch" href="/assets/index.html-qzLRUcq5.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-8BYkbvFX.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-N-dziMPp.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-wqjfrlzt.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-o0ueQIzO.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-sHEfsJb4.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-jGXq6psl.js" as="script"><link rel="prefetch" href="/assets/7.git.html-sRCLnPTT.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-z9LSS4RY.js" as="script"><link rel="prefetch" href="/assets/advanced3.html-p--qF8TW.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-1jkfhWek.js" as="script"><link rel="prefetch" href="/assets/advanced5.html-9KrxzgjV.js" as="script"><link rel="prefetch" href="/assets/advanced6.html-k5auFwFX.js" as="script"><link rel="prefetch" href="/assets/base1.html-8GGOsZr4.js" as="script"><link rel="prefetch" href="/assets/base2.html-bUUFTble.js" as="script"><link rel="prefetch" href="/assets/cluster.html-vngr7oy1.js" as="script"><link rel="prefetch" href="/assets/1.Nginx的安装部署.html-wA2ZqiAh.js" as="script"><link rel="prefetch" href="/assets/10.十分钟快速建站之在线论坛Discuz部署实战.html-BT13rPDI.js" as="script"><link rel="prefetch" href="/assets/2.Nginx的的目录结构_基本运行原理及基本配置文件.html-cZT548pN.js" as="script"><link rel="prefetch" href="/assets/3.Nginx 虚拟主机与域名解析.html-6GEoXJQr.js" as="script"><link rel="prefetch" href="/assets/4.ServerName匹配规则.html-XHuYUAjw.js" as="script"><link rel="prefetch" href="/assets/5.反向代理在系统结构中的应用场景.html-He2lmZ9d.js" as="script"><link rel="prefetch" href="/assets/6.nginx动静分离及Rewrite实战.html-QmRYtVk1.js" as="script"><link rel="prefetch" href="/assets/7.nginx高可用及Keepalived实战.html-pyPtz-bF.js" as="script"><link rel="prefetch" href="/assets/8.Nginx配置防盗链(详细了解如何配置nginx防盗链).html-WFeBZqWW.js" as="script"><link rel="prefetch" href="/assets/9.申请阿里云免费SSL证书并配置https访问实战.html-NJw1NzzI.js" as="script"><link rel="prefetch" href="/assets/index.html-q3Hup-XB.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-Ysm7QqOA.js" as="script"><link rel="prefetch" href="/assets/index.html-TaYmJ1Mc.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-Dd17S3i0.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-nxpnzqj9.js" as="script"><link rel="prefetch" href="/assets/index.html-HgE6c4o_.js" as="script"><link rel="prefetch" href="/assets/index.html-Gn4-bFTA.js" as="script"><link rel="prefetch" href="/assets/01. Object类、常用API.html-USVaT7bz.js" as="script"><link rel="prefetch" href="/assets/02. Collection、泛型.html-0tUL0yQS.js" as="script"><link rel="prefetch" href="/assets/03. List、Set.html-gjY9Zyq8.js" as="script"><link rel="prefetch" href="/assets/04. Map.html-wLYd7vRc.js" as="script"><link rel="prefetch" href="/assets/05. 异常、线程.html-S6cPPV-z.js" as="script"><link rel="prefetch" href="/assets/06. 线程、同步.html-Y8l-Z01Y.js" as="script"><link rel="prefetch" href="/assets/07. 等待与唤醒案例、线程池、Lambda表达式.html-UFuOIY-c.js" as="script"><link rel="prefetch" href="/assets/08. File类、递归.html-lj1OEgjx.js" as="script"><link rel="prefetch" href="/assets/09. 字节流、字符流.html-jjEbyw9G.js" as="script"><link rel="prefetch" href="/assets/10. 缓冲流、转换流、序列化流、打印流.html-uNrcg5lu.js" as="script"><link rel="prefetch" href="/assets/11. 网络编程.html-xAeeRwcU.js" as="script"><link rel="prefetch" href="/assets/12. 函数式接口.html-gufrKh-D.js" as="script"><link rel="prefetch" href="/assets/13. 方法引用.html-puDsjEnf.js" as="script"><link rel="prefetch" href="/assets/14. Stream流.html-WR_G__ve.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-AohfHd7k.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-i-8Q4caZ.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-n3TJrGrk.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-Zzq4gVZM.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-5ejTd2ic.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-5_CchCJp.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-R6juoHdG.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-W8k_ECAS.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-AU_jAngx.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-LdL_SQmu.js" as="script"><link rel="prefetch" href="/assets/index.html-ucP6o2IT.js" as="script"><link rel="prefetch" href="/assets/index.html-2MhmdDQX.js" as="script"><link rel="prefetch" href="/assets/index.html-X2fYQvTj.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-sq3YVWus.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-VR6lZFtz.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-RGJjdwQh.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-hdLJYGFh.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-ez6QjtFT.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-aY78OIi0.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-WE_rN9ZK.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-mYapdEoN.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-0RQxXkuv.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-ABxcJ7cu.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-7ppVsmmS.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-Roq_QAd0.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-dEPd7Bj8.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-iMiP5y_v.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-oxWCPuLx.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-0j1ikwu_.js" as="script"><link rel="prefetch" href="/assets/1.scss基础.html-bktT6whe.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-a-ONdAcq.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-YhcD6uuk.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-yrmXCdX1.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-5A9QMqsA.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-Uyyq0Myl.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-wo2_TiBt.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-kiHpDLJK.js" as="script"><link rel="prefetch" href="/assets/1.html.html-BaReecr0.js" as="script"><link rel="prefetch" href="/assets/2.css.html-NSvnsBUV.js" as="script"><link rel="prefetch" href="/assets/3.mobile.html-U6zvLpVW.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html--SOONUHt.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-FQQc_-QY.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-1nwi_H55.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-igbLVeJI.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-42fbq1hg.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html-it2n4o2q.js" as="script"><link rel="prefetch" href="/assets/index.html-PUQrwqCd.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-2l9GvRRA.js" as="script"><link rel="prefetch" href="/assets/01. Vue3入门.html-XOeypHFg.js" as="script"><link rel="prefetch" href="/assets/02. Pinia入门.html-DZSQsijU.js" as="script"><link rel="prefetch" href="/assets/03. 项目起步.html--x-_XaJg.js" as="script"><link rel="prefetch" href="/assets/04. Layout页.html-hrx_8W2t.js" as="script"><link rel="prefetch" href="/assets/05. Home页.html-UOrxMLE0.js" as="script"><link rel="prefetch" href="/assets/06. 一级分类页.html-m2xv6t2q.js" as="script"><link rel="prefetch" href="/assets/07. 二级分类页.html-r8RR2ITi.js" as="script"><link rel="prefetch" href="/assets/08. 商品详情.html-zlvprx8n.js" as="script"><link rel="prefetch" href="/assets/09. 登录页.html-p7cmBJo0.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-9ILNJFcN.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-IqHerk8C.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-CRBRFMVT.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-1UxN9lZo.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-wAepb6-t.js" as="script"><link rel="prefetch" href="/assets/00. uni-app前置知识.html-lPGkhzp9.js" as="script"><link rel="prefetch" href="/assets/01. 项目起步.html-fvqway8x.js" as="script"><link rel="prefetch" href="/assets/02. 首页模块.html-2tGwuO6c.js" as="script"><link rel="prefetch" href="/assets/03. 推荐模块.html-PaJKwB0A.js" as="script"><link rel="prefetch" href="/assets/04. 分类模块.html-kpiojz5x.js" as="script"><link rel="prefetch" href="/assets/05. 详情模块.html-KLCB7l-g.js" as="script"><link rel="prefetch" href="/assets/06. 登录模块.html-sV71prGb.js" as="script"><link rel="prefetch" href="/assets/07. 用户模块.html-RIHBWa-U.js" as="script"><link rel="prefetch" href="/assets/08. 地址模块.html-NCf3dpgV.js" as="script"><link rel="prefetch" href="/assets/09. SKU模块.html-KF_uziMk.js" as="script"><link rel="prefetch" href="/assets/10. 购物车模块.html-4g2XrI0I.js" as="script"><link rel="prefetch" href="/assets/11. 订单模块.html-KrwEaVMK.js" as="script"><link rel="prefetch" href="/assets/12. 项目打包.html-ahR9zRQW.js" as="script"><link rel="prefetch" href="/assets/index.html-sSU7GKD6.js" as="script"><link rel="prefetch" href="/assets/index.html-bDsdzjOB.js" as="script"><link rel="prefetch" href="/assets/index.html-JdLOM6cD.js" as="script"><link rel="prefetch" href="/assets/index.html-_HlUve9c.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-k4n-ze4N.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-vSzjMVLc.js" as="script"><link rel="prefetch" href="/assets/index.html-gokmvgNN.js" as="script"><link rel="prefetch" href="/assets/index.html-2KG1l7Xi.js" as="script"><link rel="prefetch" href="/assets/learn.html-pK6VNcSL.js" as="script"><link rel="prefetch" href="/assets/404.html-6aV2Km_R.js" as="script"><link rel="prefetch" href="/assets/index.html-Ahfkg7Pq.js" as="script"><link rel="prefetch" href="/assets/index.html-GLI__Pcy.js" as="script"><link rel="prefetch" href="/assets/index.html-wnvY1Q9W.js" as="script"><link rel="prefetch" href="/assets/index.html-GhTV7t5h.js" as="script"><link rel="prefetch" href="/assets/index.html-XoKMP5g9.js" as="script"><link rel="prefetch" href="/assets/index.html-821wpM3U.js" as="script"><link rel="prefetch" href="/assets/index.html-ONtIfdmb.js" as="script"><link rel="prefetch" href="/assets/index.html-SIbtgosM.js" as="script"><link rel="prefetch" href="/assets/index.html-U3Eb_DDZ.js" as="script"><link rel="prefetch" href="/assets/index.html-iwFQ5hr2.js" as="script"><link rel="prefetch" href="/assets/index.html-5kp-ypyC.js" as="script"><link rel="prefetch" href="/assets/index.html-M1-YXrN3.js" as="script"><link rel="prefetch" href="/assets/index.html-P-SCHh7k.js" as="script"><link rel="prefetch" href="/assets/index.html-tOt8WSzy.js" as="script"><link rel="prefetch" href="/assets/index.html-Jl98LnXj.js" as="script"><link rel="prefetch" href="/assets/index.html-VZUQyzx_.js" as="script"><link rel="prefetch" href="/assets/index.html-lkltdDTs.js" as="script"><link rel="prefetch" href="/assets/index.html-jfwkMbDU.js" as="script"><link rel="prefetch" href="/assets/index.html-aq9mt2xH.js" as="script"><link rel="prefetch" href="/assets/index.html-6DS22mGM.js" as="script"><link rel="prefetch" href="/assets/index.html-yqYJIM7h.js" as="script"><link rel="prefetch" href="/assets/index.html-Y2OISR-y.js" as="script"><link rel="prefetch" href="/assets/index.html-dugDlBPF.js" as="script"><link rel="prefetch" href="/assets/index.html-B7atuRkp.js" as="script"><link rel="prefetch" href="/assets/index.html-U-zDBm_-.js" as="script"><link rel="prefetch" href="/assets/index.html-DC2SLhEc.js" as="script"><link rel="prefetch" href="/assets/index.html-cEXQ3ClK.js" as="script"><link rel="prefetch" href="/assets/index.html-fu4lT4jf.js" as="script"><link rel="prefetch" href="/assets/index.html-QOi6Q6Cn.js" as="script"><link rel="prefetch" href="/assets/index.html-Mth94uvp.js" as="script"><link rel="prefetch" href="/assets/index.html-Ur1vhStF.js" as="script"><link rel="prefetch" href="/assets/index.html-EuMGmQRA.js" as="script"><link rel="prefetch" href="/assets/index.html-UZRldPsF.js" as="script"><link rel="prefetch" href="/assets/index.html-ZuVV15X9.js" as="script"><link rel="prefetch" href="/assets/index.html-AvuZfipD.js" as="script"><link rel="prefetch" href="/assets/index.html-X3ZREQNk.js" as="script"><link rel="prefetch" href="/assets/index.html-w2hqq4J2.js" as="script"><link rel="prefetch" href="/assets/index.html-6D0HOfav.js" as="script"><link rel="prefetch" href="/assets/index.html-q8kXavbM.js" as="script"><link rel="prefetch" href="/assets/index.html-zgVmmyCU.js" as="script"><link rel="prefetch" href="/assets/index.html-lhT9DzM0.js" as="script"><link rel="prefetch" href="/assets/index.html-Q00I84Z0.js" as="script"><link rel="prefetch" href="/assets/index.html-zxRfarDF.js" as="script"><link rel="prefetch" href="/assets/index.html-S9I6SFg8.js" as="script"><link rel="prefetch" href="/assets/index.html-pyETvKoy.js" as="script"><link rel="prefetch" href="/assets/index.html-qGcm8KBX.js" as="script"><link rel="prefetch" href="/assets/index.html-K_izoJh5.js" as="script"><link rel="prefetch" href="/assets/index.html-RVMxfcDq.js" as="script"><link rel="prefetch" href="/assets/index.html-gr7iB-0Y.js" as="script"><link rel="prefetch" href="/assets/index.html-3mq0fdcQ.js" as="script"><link rel="prefetch" href="/assets/index.html-iocJUBOj.js" as="script"><link rel="prefetch" href="/assets/index.html-NDAlH1zA.js" as="script"><link rel="prefetch" href="/assets/waline-meta-w40geAFS.js" as="script"><link rel="prefetch" href="/assets/component-osShNRyB.js" as="script"><link rel="prefetch" href="/assets/vue-repl-wAAVGaG8.js" as="script"><link rel="prefetch" href="/assets/codemirror-editor-9AKw0UkL.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-i2ohwMnJ.js" as="script"><link rel="prefetch" href="/assets/index-7SG8bi1h.js" as="script"><link rel="prefetch" href="/assets/pageview-9a676BYz.js" as="script"><link rel="prefetch" href="/assets/SearchResult-J8yaxgx-.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" aria-hidden><!----><span class="vp-site-name hide-in-pad">apzs</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="博客主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>html&amp;css</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="html基础" class="vp-link nav-link nav-link" href="/front-base/html_css/1.html.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>html基础<!----></a></li><li class="dropdown-subitem"><a aria-label="css基础" class="vp-link nav-link nav-link" href="/front-base/html_css/2.css.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>css基础<!----></a></li><li class="dropdown-subitem"><a aria-label="移动端布局" class="vp-link nav-link nav-link" href="/front-base/html_css/3.mobile.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>移动端布局<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>js</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="js基础" class="vp-link nav-link nav-link" href="/front-base/js/1.JS%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js基础<!----></a></li><li class="dropdown-subitem"><a aria-label="WebApi" class="vp-link nav-link nav-link" href="/front-base/js/2.WebApi%EF%BC%88BOM%E5%92%8CDOM%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>WebApi<!----></a></li><li class="dropdown-subitem"><a aria-label="Ajax" class="vp-link nav-link nav-link" href="/front-base/js/3.Ajax.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Ajax<!----></a></li><li class="dropdown-subitem"><a aria-label="js高级" class="vp-link nav-link nav-link" href="/front-base/js/4.js%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js高级<!----></a></li><li class="dropdown-subitem"><a aria-label="ECMAScript6" class="vp-link nav-link nav-link" href="/front-base/js/5.ECMAScript6.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ECMAScript6<!----></a></li><li class="dropdown-subitem"><a aria-label="Promise" class="vp-link nav-link nav-link" href="/front-base/js/6.Promise.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Promise<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>前置知识</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="npm基本使用" class="vp-link nav-link nav-link" href="/front-advance/npm/1.npm%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>npm基本使用<!----></a></li><li class="dropdown-subitem"><a aria-label="scss" class="vp-link nav-link nav-link" href="/front-advance/scss/1.scss%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>scss<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>vue</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="vue2" class="vp-link nav-link nav-link" href="/front-advance/vue/1.vue2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue2<!----></a></li><li class="dropdown-subitem"><a aria-label="vue3" class="vp-link nav-link nav-link" href="/front-advance/vue/2.vue3.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue3<!----></a></li><li class="dropdown-subitem"><a aria-label="创建vue项目的几种方式" class="vp-link nav-link nav-link" href="/front-advance/vue/3.%E5%88%9B%E5%BB%BAvue%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>创建vue项目的几种方式<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>react</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="react入门" class="vp-link nav-link nav-link" href="/front-advance/react/01%20%E3%80%90react%E5%85%A5%E9%97%A8%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react入门<!----></a></li><li class="dropdown-subitem"><a aria-label="react脚手架" class="vp-link nav-link nav-link" href="/front-advance/react/02%20%E3%80%90react%E8%84%9A%E6%89%8B%E6%9E%B6%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react脚手架<!----></a></li><li class="dropdown-subitem"><a aria-label="路由" class="vp-link nav-link nav-link" href="/front-advance/react/03%20%E3%80%90%E8%B7%AF%E7%94%B1%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>路由<!----></a></li><li class="dropdown-subitem"><a aria-label="redux" class="vp-link nav-link nav-link" href="/front-advance/react/05%20%E3%80%90redux%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redux<!----></a></li><li class="dropdown-subitem"><a aria-label="hooks" class="vp-link nav-link nav-link" href="/front-advance/react/06%20%E3%80%90hooks%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>hooks<!----></a></li><li class="dropdown-subitem"><a aria-label="react高级" class="vp-link nav-link nav-link" href="/front-advance/react/07%20%E3%80%90react%E9%AB%98%E7%BA%A7%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react高级<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>webpack</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="基础" class="vp-link nav-link nav-link" href="/front-advance/webpack/1.%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>基础<!----></a></li><li class="dropdown-subitem"><a aria-label="高级" class="vp-link nav-link nav-link" href="/front-advance/webpack/2.%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>高级<!----></a></li><li class="dropdown-subitem"><a aria-label="项目配置" class="vp-link nav-link nav-link" href="/front-advance/webpack/3.%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>项目配置<!----></a></li><li class="dropdown-subitem"><a aria-label="原理分析" class="vp-link nav-link nav-link" href="/front-advance/webpack/4.%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>原理分析<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端项目"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>前端项目</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="小兔鲜PC (Vue3+Pinia+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%8F%E5%85%94%E9%B2%9CPC%20(Vue3_Pinia_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜PC (Vue3+Pinia+js)<!----></a></li><li class="dropdown-item"><a aria-label="小兔鲜儿uni-app (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%8F%E5%85%94%E9%B2%9C%E5%84%BFuni-app%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜儿uni-app (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="尚品汇 (Vue2+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%9A%E5%93%81%E6%B1%87%20(Vue2_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>尚品汇 (Vue2+js)<!----></a></li><li class="dropdown-item"><a aria-label="硅谷甄选 (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E7%A1%85%E8%B0%B7%E7%94%84%E9%80%89%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>硅谷甄选 (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="个人博客搭建教程" class="vp-link nav-link nav-link" href="/front-project/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>个人博客搭建教程<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="Java基础语法" class="vp-link nav-link nav-link" href="/back-base/1.Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java基础语法<!----></a></li><li class="dropdown-item"><a aria-label="Java核心" class="vp-link nav-link nav-link" href="/back-base/2.Java%E6%A0%B8%E5%BF%83/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java核心<!----></a></li><li class="dropdown-item"><a aria-label="JavaWeb" class="vp-link nav-link nav-link" href="/back-base/3.JavaWeb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>JavaWeb<!----></a></li><li class="dropdown-item"><a aria-label="mysql" class="vp-link nav-link nav-link" href="/back-base/4.mysql/MySQL.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mysql<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SSM" class="vp-link nav-link nav-link" href="/back-advance/5.SSM/SSM%E7%AC%94%E8%AE%B0.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SSM<!----></a></li><li class="dropdown-item"><a aria-label="redis" class="vp-link nav-link nav-link" href="/back-advance/6.redis/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redis<!----></a></li><li class="dropdown-item"><a aria-label="SpringBoot" class="vp-link nav-link nav-link" href="/back-advance/7.SpringBoot2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringBoot<!----></a></li><li class="dropdown-item"><a aria-label="git" class="vp-link nav-link nav-link" href="/back-advance/9.git/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>git<!----></a></li><li class="dropdown-item"><a aria-label="nginx" class="vp-link nav-link nav-link" href="/back-advance/10.nginx.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>nginx<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端高级"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端高级</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="docker" class="vp-link nav-link nav-link" href="/back-senior/11.docker/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>docker<!----></a></li><li class="dropdown-item"><a aria-label="gitlab+jeckins" class="vp-link nav-link nav-link" href="/back-senior/12.gitlab_jeckins/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>gitlab+jeckins<!----></a></li><li class="dropdown-item"><a aria-label="SpringSecurity" class="vp-link nav-link nav-link" href="/back-senior/13.SpringSecurity/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringSecurity<!----></a></li><li class="dropdown-item"><a aria-label="Netty" class="vp-link nav-link nav-link" href="/back-senior/14.Netty.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Netty<!----></a></li><li class="dropdown-item"><a aria-label="arthas" class="vp-link nav-link nav-link" href="/back-senior/15.arthas.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>arthas<!----></a></li><li class="dropdown-item"><a aria-label="ShardingSphere5" class="vp-link nav-link nav-link" href="/back-senior/16.ShardingSphere5.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ShardingSphere5<!----></a></li><li class="dropdown-item"><a aria-label="mongodb" class="vp-link nav-link nav-link" href="/back-senior/17.mongodb/mongodb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mongodb<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="谷粒商城"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>谷粒商城</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>基础篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="前后端环境搭建" class="vp-link nav-link nav-link" href="/gulimall/base1.html"><!---->前后端环境搭建<!----></a></li><li class="dropdown-subitem"><a aria-label="前后端联调" class="vp-link nav-link nav-link" href="/gulimall/base2.html"><!---->前后端联调<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>高级篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Elasticsearch &amp; nginx" class="vp-link nav-link active nav-link active" href="/gulimall/advanced1.html"><!---->Elasticsearch &amp; nginx<!----></a></li><li class="dropdown-subitem"><a aria-label="Redisson &amp; SpringCache" class="vp-link nav-link nav-link" href="/gulimall/advanced2.html"><!---->Redisson &amp; SpringCache<!----></a></li><li class="dropdown-subitem"><a aria-label="CompletableFuture" class="vp-link nav-link nav-link" href="/gulimall/advanced3.html"><!---->CompletableFuture<!----></a></li><li class="dropdown-subitem"><a aria-label="Spring Session &amp; OAuth2.0" class="vp-link nav-link nav-link" href="/gulimall/advanced4.html"><!---->Spring Session &amp; OAuth2.0<!----></a></li><li class="dropdown-subitem"><a aria-label="RabbitMQ &amp; Seata" class="vp-link nav-link nav-link" href="/gulimall/advanced5.html"><!---->RabbitMQ &amp; Seata<!----></a></li><li class="dropdown-subitem"><a aria-label="支付 &amp; Sentinel" class="vp-link nav-link nav-link" href="/gulimall/advanced6.html"><!---->支付 &amp; Sentinel<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>集群篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="K8s &amp; kubesphere" class="vp-link nav-link nav-link" href="/gulimall/cluster.html"><!---->K8s &amp; kubesphere<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="常用功能"><span class="title"><!---->常用功能</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SpringBoot相关" class="vp-link nav-link nav-link" href="/CommonFunctions/1.SpringBoot.html"><!---->SpringBoot相关<!----></a></li><li class="dropdown-item"><a aria-label="mysql相关" class="vp-link nav-link nav-link" href="/CommonFunctions/2.mysql.html"><!---->mysql相关<!----></a></li><li class="dropdown-item"><a aria-label="docker相关" class="vp-link nav-link nav-link" href="/CommonFunctions/3.docker.html"><!---->docker相关<!----></a></li><li class="dropdown-item"><a aria-label="maven相关" class="vp-link nav-link nav-link" href="/CommonFunctions/4.maven.html"><!---->maven相关<!----></a></li><li class="dropdown-item"><a aria-label="linux相关" class="vp-link nav-link nav-link" href="/CommonFunctions/5.linux.html"><!---->linux相关<!----></a></li><li class="dropdown-item"><a aria-label="windows相关" class="vp-link nav-link nav-link" href="/CommonFunctions/6.windows.html"><!---->windows相关<!----></a></li><li class="dropdown-item"><a aria-label="git相关" class="vp-link nav-link nav-link" href="/CommonFunctions/7.git.html"><!---->git相关<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="阅读源码"><span class="title"><!---->阅读源码</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="搭建SpringBoot源码环境" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/"><!---->搭建SpringBoot源码环境<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot自动配置 &amp; 请求处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%20_%20%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86.html"><!---->SpringBoot自动配置 &amp; 请求处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot异常处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/2.%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"><!---->SpringBoot异常处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/"><!---->SpringSecurity源码阅读<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity基础知识" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/learn.html"><!---->SpringSecurity基础知识<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Tomcat</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Tomcat源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/tomcat.html"><!---->Tomcat源码阅读<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Mybatis</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="MyBatis源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/mybatis/"><!---->MyBatis源码阅读<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/apzs/apzs.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="5.1、整合Elasticsearch" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced1.html#_5-1、整合elasticsearch"><!---->5.1、整合Elasticsearch<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="5.1.1、简介" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-1-1、简介"><!---->5.1.1、简介<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.1.2、安装Elasticsearch" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-1-2、安装elasticsearch"><!---->5.1.2、安装Elasticsearch<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.1.3、Elasticsearch入门" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-1-3、elasticsearch入门"><!---->5.1.3、Elasticsearch入门<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.1.4、Elasticsearch进阶" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-1-4、elasticsearch进阶"><!---->5.1.4、Elasticsearch进阶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.1.5、Elasticsearch映射" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-1-5、elasticsearch映射"><!---->5.1.5、Elasticsearch映射<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.1.6、ElasticSearch整合SpringBoot" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-1-6、elasticsearch整合springboot"><!---->5.1.6、ElasticSearch整合SpringBoot<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="5.2、商城业务-商品上架" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced1.html#_5-2、商城业务-商品上架"><!---->5.2、商城业务-商品上架<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="5.2.1、sku在es中存储模型分析" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-1、sku在es中存储模型分析"><!---->5.2.1、sku在es中存储模型分析<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.2、扁平化处理" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-2、扁平化处理"><!---->5.2.2、扁平化处理<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.3、构造基本数据" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-3、构造基本数据"><!---->5.2.3、构造基本数据<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.4、远程查询库存&amp;泛型结果封装" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-4、远程查询库存-泛型结果封装"><!---->5.2.4、远程查询库存&amp;泛型结果封装<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.5、调用远程库存服务" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-5、调用远程库存服务"><!---->5.2.5、调用远程库存服务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.6、使用ES远程上架" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-6、使用es远程上架"><!---->5.2.6、使用ES远程上架<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.7、测试（1）Product服务" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-7、测试-1-product服务"><!---->5.2.7、测试（1）Product服务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.8、测试（2）Ware服务" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-8、测试-2-ware服务"><!---->5.2.8、测试（2）Ware服务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.9、测试（3）" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-9、测试-3"><!---->5.2.9、测试（3）<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2.10、解决bug" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-2-10、解决bug"><!---->5.2.10、解决bug<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="5.3、商城业务-首页&amp;nginx" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced1.html#_5-3、商城业务-首页-nginx"><!---->5.3、商城业务-首页&amp;nginx<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="5.3.1、打开首页" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-1、打开首页"><!---->5.3.1、打开首页<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.2、查询所有一级分类" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-2、查询所有一级分类"><!---->5.3.2、查询所有一级分类<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.3、渲染二级三级分类数据" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-3、渲染二级三级分类数据"><!---->5.3.3、渲染二级三级分类数据<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.4、nginx反向代理" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-4、nginx反向代理"><!---->5.3.4、nginx反向代理<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.5、nginx负载均衡到网关" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-5、nginx负载均衡到网关"><!---->5.3.5、nginx负载均衡到网关<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.6、压力测试" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-6、压力测试"><!---->5.3.6、压力测试<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.7、性能监控" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-7、性能监控"><!---->5.3.7、性能监控<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3.8、配置nginx" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced1.html#_5-3-8、配置nginx"><!---->5.3.8、配置nginx<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->5、高级篇</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://apzs.eu.org" target="_blank" rel="noopener noreferrer">apzs</a></span><span property="author" content="apzs"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-05T06:05:15.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/gulimall/advanced1.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 136 分钟</span><meta property="timeRequired" content="PT136M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_5-1、整合elasticsearch">5.1、整合Elasticsearch</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-1、简介">5.1.1、简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-2、安装elasticsearch">5.1.2、安装Elasticsearch</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-3、elasticsearch入门">5.1.3、Elasticsearch入门</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-4、elasticsearch进阶">5.1.4、Elasticsearch进阶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-5、elasticsearch映射">5.1.5、Elasticsearch映射</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-6、elasticsearch整合springboot">5.1.6、ElasticSearch整合SpringBoot</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_5-2、商城业务-商品上架">5.2、商城业务-商品上架</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-1、sku在es中存储模型分析">5.2.1、sku在es中存储模型分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-2、扁平化处理">5.2.2、扁平化处理</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-3、构造基本数据">5.2.3、构造基本数据</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-4、远程查询库存-泛型结果封装">5.2.4、远程查询库存&amp;泛型结果封装</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-5、调用远程库存服务">5.2.5、调用远程库存服务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-6、使用es远程上架">5.2.6、使用ES远程上架</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-7、测试-1-product服务">5.2.7、测试（1）Product服务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-8、测试-2-ware服务">5.2.8、测试（2）Ware服务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-9、测试-3">5.2.9、测试（3）</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-10、解决bug">5.2.10、解决bug</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_5-3、商城业务-首页-nginx">5.3、商城业务-首页&amp;nginx</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-1、打开首页">5.3.1、打开首页</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-2、查询所有一级分类">5.3.2、查询所有一级分类</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-3、渲染二级三级分类数据">5.3.3、渲染二级三级分类数据</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-4、nginx反向代理">5.3.4、nginx反向代理</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-5、nginx负载均衡到网关">5.3.5、nginx负载均衡到网关</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-6、压力测试">5.3.6、压力测试</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-7、性能监控">5.3.7、性能监控</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-8、配置nginx">5.3.8、配置nginx</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="_5、高级篇" tabindex="-1"><a class="header-anchor" href="#_5、高级篇" aria-hidden="true">#</a> 5、高级篇</h1><h2 id="_5-1、整合elasticsearch" tabindex="-1"><a class="header-anchor" href="#_5-1、整合elasticsearch" aria-hidden="true">#</a> 5.1、整合Elasticsearch</h2><p><strong>ElasticSearch概念-基础概念</strong></p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.0.png" alt="image-20220721203321516" style="zoom:50%;"><p><strong>ElasticSearch概念-倒排索引</strong></p><table><thead><tr><th>词</th><th>记录</th></tr></thead><tbody><tr><td>红海</td><td>1,2,3,4,5</td></tr><tr><td>行动</td><td>1,2,3</td></tr><tr><td>探索</td><td>2,5</td></tr><tr><td>特别</td><td>3,5</td></tr><tr><td>记录篇</td><td>4</td></tr><tr><td>特工</td><td>5</td></tr></tbody></table><p><code>分词</code>：将整句分拆为单词</p><p><code>保存的记录</code></p><ol><li><p>红海行动</p></li><li><p>探索红海行动</p></li><li><p>红海特别行动</p></li><li><p>红海记录篇</p></li><li><p>特工红海特别探索</p></li></ol><p><code>检索：</code></p><p>1、红海特工行动？</p><p>2、红海行动？</p><p>相关性得分：</p><p><strong>ElasticSearch7-去掉type概念</strong></p><ul><li><p>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但ES 中不是这样的。elasticsearch是基于Lucene开发的搜索引擎，而ES中不同type下名称相同 的filed最终在Lucene中的处理方式是一样的。</p><ul><li><p>两个不同type下的两个user_name，在ES同一个索引下其实被认为是同一个filed，你必 须在两个不同的type中定义相同的filed映射。否则，不同type中的相同字段名称就会在 处理中出现冲突的情况，导致Lucene处理效率下降。</p></li><li><p>去掉type就是为了提高ES处理数据的效率。</p></li></ul></li><li><p>Elasticsearch 7.x</p><ul><li>URL中的type参数为可选。比如，索引一个文档不再要求提供文档类型。</li></ul></li><li><p>Elasticsearch 8.x</p><ul><li>不再支持URL中的type参数。</li></ul></li><li><p>解决：将索引从多类型迁移到单类型，每种类型文档一个独立索引</p></li></ul><h3 id="_5-1-1、简介" tabindex="-1"><a class="header-anchor" href="#_5-1-1、简介" aria-hidden="true">#</a> 5.1.1、简介</h3><h4 id="_1、elasticsearch-是什么" tabindex="-1"><a class="header-anchor" href="#_1、elasticsearch-是什么" aria-hidden="true">#</a> 1、Elasticsearch 是什么？</h4><blockquote><p>Elasticsearch 是一个分布式的免费开源搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。Elasticsearch 以其简单的 REST 风格 API、分布式特性、速度和可扩展性而闻名，是 Elastic Stack 的核心组件；Elastic Stack 是一套适用于数据采集、扩充、存储、分析和可视化的免费开源工具。人们通常将 Elastic Stack 称为 ELK Stack（代指 Elasticsearch、Logstash 和 Kibana），目前 Elastic Stack 包括一系列丰富的轻量型数据采集代理，这些代理统称为 Beats，可用来向 Elasticsearch 发送数据。</p></blockquote><h4 id="_2、elasticsearch-的用途是什么" tabindex="-1"><a class="header-anchor" href="#_2、elasticsearch-的用途是什么" aria-hidden="true">#</a> 2、Elasticsearch 的用途是什么？</h4><p>Elasticsearch 在速度和可扩展性方面都表现出色，而且还能够索引多种类型的内容，这意味着其可用于多种用例：</p><ul><li>应用程序搜索</li><li>网站搜索</li><li>企业搜索</li><li>日志处理和分析</li><li>基础设施指标和容器监测</li><li>应用程序性能监测</li><li>地理空间数据分析和可视化</li><li>安全分析</li><li>业务分析</li></ul><h4 id="_3、elasticsearch-的工作原理是什么" tabindex="-1"><a class="header-anchor" href="#_3、elasticsearch-的工作原理是什么" aria-hidden="true">#</a> 3、Elasticsearch 的工作原理是什么？</h4><p>原始数据会从多个来源（包括日志、系统指标和网络应用程序）输入到 Elasticsearch 中。<em>数据采集</em>指在 Elasticsearch 中进行<em>索引</em>之前解析、标准化并充实这些原始数据的过程。这些数据在 Elasticsearch 中索引完成之后，用户便可针对他们的数据运行复杂的查询，并使用聚合来检索自身数据的复杂汇总。在 Kibana 中，用户可以基于自己的数据创建强大的可视化，分享仪表板，并对 Elastic Stack 进行管理。</p><h4 id="_4、elasticsearch-索引是什么" tabindex="-1"><a class="header-anchor" href="#_4、elasticsearch-索引是什么" aria-hidden="true">#</a> 4、Elasticsearch 索引是什么？</h4><p>Elasticsearch <em>索引</em>指相互关联的文档集合。Elasticsearch 会以 JSON 文档的形式存储数据。每个文档都会在一组<em>键</em>（字段或属性的名称）和它们对应的值（字符串、数字、布尔值、日期、<em>数值</em>组、地理位置或其他类型的数据）之间建立联系。</p><p>Elasticsearch 使用的是一种名为<em>倒排索引</em>的数据结构，这一结构的设计可以允许十分快速地进行全文本搜索。倒排索引会列出在所有文档中出现的每个特有词汇，并且可以找到包含每个词汇的全部文档。</p><p>在索引过程中，Elasticsearch 会存储文档并构建倒排索引，这样用户便可以近实时地对文档数据进行搜索。索引过程是在索引 API 中启动的，通过此 API 您既可向特定索引中添加 JSON 文档，也可更改特定索引中的 JSON 文档。</p><h4 id="_5、logstash-的用途是什么" tabindex="-1"><a class="header-anchor" href="#_5、logstash-的用途是什么" aria-hidden="true">#</a> 5、Logstash 的用途是什么？</h4><p>Logstash 是 Elastic Stack 的核心产品之一，可用来对数据进行聚合和处理，并将数据发送到 Elasticsearch。Logstash 是一个开源的服务器端数据处理管道，允许您在将数据索引到 Elasticsearch 之前同时从多个来源采集数据，并对数据进行充实和转换。</p><h4 id="_6、kibana-的用途是什么" tabindex="-1"><a class="header-anchor" href="#_6、kibana-的用途是什么" aria-hidden="true">#</a> 6、Kibana 的用途是什么？</h4><p>Kibana 是一款适用于 Elasticsearch 的数据可视化和管理工具，可以提供实时的直方图、线形图、饼状图和地图。Kibana 同时还包括诸如 Canvas 和 Elastic Maps 等高级应用程序；Canvas 允许用户基于自身数据创建定制的动态信息图表，而 Elastic Maps 则可用来对地理空间数据进行可视化。</p><h4 id="_7、为何使用-elasticsearch" tabindex="-1"><a class="header-anchor" href="#_7、为何使用-elasticsearch" aria-hidden="true">#</a> 7、为何使用 Elasticsearch？</h4><p>**Elasticsearch 很快。**由于 Elasticsearch 是在 Lucene 基础上构建而成的，所以在全文本搜索方面表现十分出色。Elasticsearch 同时还是一个近实时的搜索平台，这意味着从文档索引操作到文档变为可搜索状态之间的延时很短，一般只有一秒。因此，Elasticsearch 非常适用于对时间有严苛要求的用例，例如安全分析和基础设施监测。</p><p>**Elasticsearch 具有分布式的本质特征。**Elasticsearch 中存储的文档分布在不同的容器中，这些容器称为<em>分片</em>，可以进行复制以提供数据冗余副本，以防发生硬件故障。Elasticsearch 的分布式特性使得它可以扩展至数百台（甚至数千台）服务器，并处理 PB 量级的数据。</p><p>**Elasticsearch 包含一系列广泛的功能。**除了速度、可扩展性和弹性等优势以外，Elasticsearch 还有大量强大的内置功能（例如数据汇总和索引生命周期管理），可以方便用户更加高效地存储和搜索数据。</p><p>**Elastic Stack 简化了数据采集、可视化和报告过程。**通过与 Beats 和 Logstash 进行集成，用户能够在向 Elasticsearch 中索引数据之前轻松地处理数据。同时，Kibana 不仅可针对 Elasticsearch 数据提供实时可视化，同时还提供 UI 以便用户快速访问应用程序性能监测 (APM)、日志和基础设施指标等数据。</p><h3 id="_5-1-2、安装elasticsearch" tabindex="-1"><a class="header-anchor" href="#_5-1-2、安装elasticsearch" aria-hidden="true">#</a> 5.1.2、安装Elasticsearch</h3><h4 id="_1、准备工作" tabindex="-1"><a class="header-anchor" href="#_1、准备工作" aria-hidden="true">#</a> 1、准备工作</h4><p>先把要使用的<a href="https://www.baidu.com/link?url=kt_064YgvH_qiIkWW_ekzAXDLKK6oDD_ftrlywBWyT8Jrtrbde8UVk2bGDtiAx8T&amp;wd=&amp;eqid=dfa91a1e000cf93a0000000662bec7af" target="_blank" rel="noopener noreferrer">Oracle VM <em>VirtualBox</em><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>虚拟机内存调大，这里我调到1G</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.1.1.png" alt="image-20220701180534099" style="zoom:67%;"><p>然后在<code>VirtualBox VMs的安装目录</code>使用<code>vagrant up</code>命令启动<a href="https://www.baidu.com/link?url=kt_064YgvH_qiIkWW_ekzAXDLKK6oDD_ftrlywBWyT8Jrtrbde8UVk2bGDtiAx8T&amp;wd=&amp;eqid=dfa91a1e000cf93a0000000662bec7af" target="_blank" rel="noopener noreferrer">Oracle VM <em>VirtualBox</em><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>虚拟机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.1.2.png" alt="image-20220701180734638" tabindex="0" loading="lazy"><figcaption>image-20220701180734638</figcaption></figure><p>然后在<code>VirtualBox VMs的安装目录</code>使用<code>vagrant ssh</code>连接虚拟机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.1.3.png" alt="image-20220701181323041" tabindex="0" loading="lazy"><figcaption>image-20220701181323041</figcaption></figure><p>使用<code>sudo docker ps</code>命令查看正在运行的镜像</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.1.4.png" alt="image-20220701182742826" tabindex="0" loading="lazy"><figcaption>image-20220701182742826</figcaption></figure><p>使用<code>sudo docker images</code>命令查看已下载的镜像</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.1.5.png" alt="image-20220701182951384" tabindex="0" loading="lazy"><figcaption>image-20220701182951384</figcaption></figure><h4 id="_2、下载" tabindex="-1"><a class="header-anchor" href="#_2、下载" aria-hidden="true">#</a> 2、下载</h4><h5 id="_1、下载elasticsearch" tabindex="-1"><a class="header-anchor" href="#_1、下载elasticsearch" aria-hidden="true">#</a> 1、下载<code>elasticsearch</code></h5><p>使用<code>sudo docker pull elasticsearch:7.4.2</code>命令下载<code>elasticsearch</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.2.1.png" alt="image-20220701190332635" tabindex="0" loading="lazy"><figcaption>image-20220701190332635</figcaption></figure><h5 id="_2、下载kibana" tabindex="-1"><a class="header-anchor" href="#_2、下载kibana" aria-hidden="true">#</a> 2、下载<code>kibana</code></h5><p>使用<code>sudo docker pull kibana:7.4.2</code>下载<code>kibana</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.2.2.1.png" alt="image-20220701224139239" tabindex="0" loading="lazy"><figcaption>image-20220701224139239</figcaption></figure><p>使用<code>sudo docker images</code>命令查看已下载的镜像</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.2.2.2.png" alt="image-20220701224312508" tabindex="0" loading="lazy"><figcaption>image-20220701224312508</figcaption></figure><p>使用<code>free -m</code>查看内存使用情况，可以看到内存还剩<code>403</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.2.2.3.png" alt="image-20220701224457369" tabindex="0" loading="lazy"><figcaption>image-20220701224457369</figcaption></figure><h4 id="_3、运行" tabindex="-1"><a class="header-anchor" href="#_3、运行" aria-hidden="true">#</a> 3、运行</h4><h5 id="_1、运行elasticsearch" tabindex="-1"><a class="header-anchor" href="#_1、运行elasticsearch" aria-hidden="true">#</a> 1、运行<code>elasticsearch</code></h5><p><strong>完整命令</strong>(<code>-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx128m&quot;</code>这里推荐修改为<code>-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot;</code>)</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">su</span> root
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/config
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/data
<span class="token builtin class-name">echo</span> <span class="token string">&quot;http.host: 0.0.0.0&quot;</span> <span class="token operator">&gt;&gt;</span> /mydata/elasticsearch/config/elasticsearch.yml
<span class="token builtin class-name">cd</span> /mydata/elasticsearch/config
<span class="token function">ls</span>
<span class="token function">cat</span> elasticsearch.yml
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> /mydata/elasticsearch

<span class="token function">docker</span> run <span class="token parameter variable">--name</span> elasticsearch <span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token string">&quot;discovery.type=single-node&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xms64m -Xmx128m&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> elasticsearch:7.4.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是对命令的解释</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">su</span> root     <span class="token comment">#提升至管理员权限，密码默认为 vagrant</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/config <span class="token comment">#在linux虚拟机里创建/mydata/elasticsearch/config目录，-p允许创建目录及子目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /mydata/elasticsearch/data  <span class="token comment">#在linux虚拟机里创建/mydata/elasticsearch/data目录，-p允许创建目录及子目录</span>
<span class="token comment">#在/mydata/elasticsearch/config/elasticsearch.yml文件里写入数据 http.host: 0.0.0.0</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;http.host: 0.0.0.0&quot;</span> <span class="token operator">&gt;&gt;</span> /mydata/elasticsearch/config/elasticsearch.yml <span class="token comment">#注意第二个&quot;冒号后面有个空格</span>
<span class="token builtin class-name">cd</span> /mydata/elasticsearch/config <span class="token comment">#进入到/mydata/elasticsearch/config目录</span>
<span class="token function">ls</span> <span class="token comment">#查看当前目录的文件及文件夹</span>
<span class="token function">cat</span> elasticsearch.yml <span class="token comment">#查看elasticsearch.yml文件的内容</span>

<span class="token comment">#9200是发送REST API类型的http请求所用的端口，9300是elasticsearch在分布式集群状态下节点之间通讯所用的端口</span>
<span class="token comment">#  \ 斜杠表示当前行没写完，下一行接着写</span>
<span class="token comment">#-e &quot;discovery.type=single-node&quot; 单节点运行</span>
<span class="token comment">#-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx128m&quot; 初始占用64m，最大占用128m. 这个配置非常重要，如果不配置会占用虚拟机的全部内存，最后直   接卡死了</span>
<span class="token comment">#-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml 将    docker容器的/usr/share/elasticsearch/config/elasticsearch.yml文件与linux虚拟机                      的/mydata/elasticsearch/config/elasticsearch.yml文件进行关联</span>
<span class="token comment">#-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data 将docker的/usr/share/elasticsearch/data目录与   linux虚拟机的/mydata/elasticsearch/data目录进行关联</span>
<span class="token comment">#-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins 将docker的/usr/share/elasticsearch/plugins   目录与linux虚拟机的/mydata/elasticsearch/plugins目录进行关联，以后装插件就不用进入docker容器内部了</span>
<span class="token comment">#-d elasticsearch:7.4.2 用elasticsearch:7.4.2这个镜像后台启动elasticsearch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到<code>elasticsearch</code>并没有运行起来</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.1.1.png" alt="image-20220701234224018" tabindex="0" loading="lazy"><figcaption>image-20220701234224018</figcaption></figure><p>使用<code>docker logs elasticsearch</code>命令，查看<code>elasticsearch</code>的日志</p><p>可以发现出现了<strong>拒绝访问异常</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;Caused by: java.nio.file.AccessDeniedException: /usr/share/elasticsearch/data/nodes&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.1.2.png" alt="image-20220701234549824" tabindex="0" loading="lazy"><figcaption>image-20220701234549824</figcaption></figure><p>修改<code>/mydata/elasticsearch</code>目录下的所有子目录和文件的权限，让所有用户都有可执行权限</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">ls</span>
ll
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> /mydata/elasticsearh/
<span class="token builtin class-name">pwd</span>
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> /mydata/elasticsearch
ll
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最开始只有管理员用户有写权限</p><p>将<code>/mydata/elasticsearch</code>目录下的所有子目录和文件的权限都修改为777，即可读可写可执行</p><p>可以看到所有用户都有<code>可读可写可执行</code>权限</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.1.3.png" alt="image-20220701235943734" tabindex="0" loading="lazy"><figcaption>image-20220701235943734</figcaption></figure><p>启动<code>elasticsearch</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token function">ps</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
<span class="token function">docker</span> start elasticsearch
<span class="token function">docker</span> <span class="token function">ps</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.1.4.png" alt="image-20220702000749152" tabindex="0" loading="lazy"><figcaption>image-20220702000749152</figcaption></figure><p>浏览器输入 http://192.168.56.10:9200/ 可以看到已经访问成功了</p><p>(记得要修改成自己在<code>VirtualBox VMs\Vagrantfile</code>文件里配置的ip)</p><p>在<code>VirtualBox VMs\Vagrantfile</code>文件里的<code> config.vm.network &quot;private_network&quot;, ip: &quot;192.168.56.10&quot;</code>这个位置，这里的ip即为自己配置的ip</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.1.5.png" alt="image-20220702000924757" tabindex="0" loading="lazy"><figcaption>image-20220702000924757</figcaption></figure><h5 id="_2、运行kibana" tabindex="-1"><a class="header-anchor" href="#_2、运行kibana" aria-hidden="true">#</a> 2、运行<code>kibana</code></h5><p>这里的<code>http://192.168.56.10:9200</code>要改为自己配置的地址</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">--name</span> kibana <span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_HOSTS</span><span class="token operator">=</span>http://192.168.56.10:9200 <span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601 <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> kibana:7.4.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.2.1.png" alt="image-20220702002326782" tabindex="0" loading="lazy"><figcaption>image-20220702002326782</figcaption></figure><p>使用<code>docker ps</code>命令，查看正在运行的镜像，可以看到<code>kibana</code>已经运行起来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.2.2.png" alt="image-20220702002505163" tabindex="0" loading="lazy"><figcaption>image-20220702002505163</figcaption></figure><p>浏览器输入： http://192.168.56.10:5601/ ，即可看到欢迎界面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.2.3.png" alt="image-20220702002611726" tabindex="0" loading="lazy"><figcaption>image-20220702002611726</figcaption></figure><p>选择<code>No</code> -&gt;<code>Explore on my own</code>即可进入到主界面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.3.2.4.png" alt="GIF 2022-7-2 9-59-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-2 9-59-46</figcaption></figure><h4 id="_3、发送请求" tabindex="-1"><a class="header-anchor" href="#_3、发送请求" aria-hidden="true">#</a> 3、发送请求</h4><p>url： http://192.168.56.10:9200/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.15.png" alt="image-20220702001534510" tabindex="0" loading="lazy"><figcaption>image-20220702001534510</figcaption></figure><p>输入url： http://192.168.56.10:9200/_cat/nodes</p><p>查看所有节点信息，返回的结果中有<code>*</code>表明该节点是主节点，<code>104b52df3ff1</code>即为节点的名字</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.16.png" alt="image-20220702001615401" tabindex="0" loading="lazy"><figcaption>image-20220702001615401</figcaption></figure><h4 id="_4、常用命令" tabindex="-1"><a class="header-anchor" href="#_4、常用命令" aria-hidden="true">#</a> 4、常用命令</h4><h5 id="_1、启动elasticsearch" tabindex="-1"><a class="header-anchor" href="#_1、启动elasticsearch" aria-hidden="true">#</a> 1、启动<code>elasticsearch</code></h5><p>使用<code>docker start elasticsearch</code>命令启动<code>elasticsearch</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>  <span class="token comment">#显示所有的容器，包括未运行的</span>
<span class="token function">docker</span> start elasticsearch   <span class="token comment">#启动elasticsearch</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.4.1.png" alt="image-20220702091750024" tabindex="0" loading="lazy"><figcaption>image-20220702091750024</figcaption></figure><h5 id="_2、重启elasticsearch" tabindex="-1"><a class="header-anchor" href="#_2、重启elasticsearch" aria-hidden="true">#</a> 2、重启<code>elasticsearch</code></h5><p>使用<code>docker restart elasticsearch</code>命令，重启<code>elasticsearch</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart elasticsearch
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.4.2.png" alt="image-20220702091841635" tabindex="0" loading="lazy"><figcaption>image-20220702091841635</figcaption></figure><h5 id="_3、关闭elasticsearch" tabindex="-1"><a class="header-anchor" href="#_3、关闭elasticsearch" aria-hidden="true">#</a> 3、关闭<code>elasticsearch</code></h5><p>使用<code>docker stop elasticsearch</code>命令，关闭<code>elasticsearch</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> stop elasticsearch
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.4.3.png" alt="image-20220702092211629" tabindex="0" loading="lazy"><figcaption>image-20220702092211629</figcaption></figure><h5 id="_4、设置开机自启" tabindex="-1"><a class="header-anchor" href="#_4、设置开机自启" aria-hidden="true">#</a> 4、设置开机自启</h5><p>设置<code>elasticsearch</code>开机自启</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code> <span class="token function">sudo</span> <span class="token function">docker</span> update  elasticsearch  <span class="token parameter variable">--restart</span><span class="token operator">=</span>always
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.4.4.1.png" alt="image-20220702093130552" tabindex="0" loading="lazy"><figcaption>image-20220702093130552</figcaption></figure><p>设置<code>kibana</code>开机自启</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">docker</span> update  kibana <span class="token parameter variable">--restart</span><span class="token operator">=</span>always
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.4.4.2.png" alt="image-20220702093445535" tabindex="0" loading="lazy"><figcaption>image-20220702093445535</figcaption></figure><p>重启<code>linux</code>虚拟机，可以看到<code>elasticsearch</code>和<code>kibana</code>都已经自启了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>vagrant <span class="token function">ssh</span>
<span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">ps</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.2.4.4.3.png" alt="image-20220702094640010" tabindex="0" loading="lazy"><figcaption>image-20220702094640010</figcaption></figure><h3 id="_5-1-3、elasticsearch入门" tabindex="-1"><a class="header-anchor" href="#_5-1-3、elasticsearch入门" aria-hidden="true">#</a> 5.1.3、Elasticsearch入门</h3><h4 id="_1、查看elasticsearch信息" tabindex="-1"><a class="header-anchor" href="#_1、查看elasticsearch信息" aria-hidden="true">#</a> 1、查看<code>Elasticsearch</code>信息</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /_cat/nodes：查看所有节点
GET /_cat/health：查看 es 健康状况
GET /_cat/master：查看主节点
GET /_cat/indices：查看所有索引 相当于数据库的“show databases”
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1、查看所有节点" tabindex="-1"><a class="header-anchor" href="#_1、查看所有节点" aria-hidden="true">#</a> 1、查看所有节点</h5><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.56.10:9200/_cat/nodes</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>*表示的是主节点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.1.1.png" alt="image-20220702095116507" tabindex="0" loading="lazy"><figcaption>image-20220702095116507</figcaption></figure><h5 id="_2、查看健康状况" tabindex="-1"><a class="header-anchor" href="#_2、查看健康状况" aria-hidden="true">#</a> 2、查看健康状况</h5><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.56.10:9200/_cat/health</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>green表示健康</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.1.2.png" alt="image-20220702095359565" tabindex="0" loading="lazy"><figcaption>image-20220702095359565</figcaption></figure><h5 id="_3、查看主节点" tabindex="-1"><a class="header-anchor" href="#_3、查看主节点" aria-hidden="true">#</a> 3、查看主节点</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.1.3.png" alt="image-20220702095546106" tabindex="0" loading="lazy"><figcaption>image-20220702095546106</figcaption></figure><h5 id="_4、查看所有索引" tabindex="-1"><a class="header-anchor" href="#_4、查看所有索引" aria-hidden="true">#</a> 4、查看所有索引</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.1.4.png" alt="image-20220702095645415" tabindex="0" loading="lazy"><figcaption>image-20220702095645415</figcaption></figure><h4 id="_2、简单增查改" tabindex="-1"><a class="header-anchor" href="#_2、简单增查改" aria-hidden="true">#</a> 2、简单增查改</h4><h5 id="_1、put方式添加或修改数据" tabindex="-1"><a class="header-anchor" href="#_1、put方式添加或修改数据" aria-hidden="true">#</a> 1、<code>put</code>方式添加或修改数据</h5><h6 id="_1、put方式发送请求" tabindex="-1"><a class="header-anchor" href="#_1、put方式发送请求" aria-hidden="true">#</a> 1、<code>put</code>方式发送请求</h6><p>在Postman中发送请求</p><ol><li><p>输入<code>http://192.168.56.10:9200/customer/external/1</code></p></li><li><p>选择请求方式为PUT</p></li><li><p>点击Body</p></li><li><p>点击raw</p></li><li><p>选择JSON</p></li><li><p>点击Send</p></li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> 
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John Doe&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回的数据信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些带<code>_</code>的都称为元数据</p><p><code>&quot;_index&quot;: &quot;customer&quot;,</code> -&gt; 在<code>customer</code>索引下，相当于mysql中的数据库</p><p><code>&quot;_type&quot;: &quot;external&quot;,</code> -&gt; 在<code>external</code>类型下，相当于mysql中的表 （新版本已经没有<code>_type</code>了，统一为<code>_doc</code>）</p><p><code>&quot;_id&quot;: &quot;1&quot;,</code> -&gt; id为1</p><p><code>&quot;_version&quot;: 1,</code> -&gt; 版本号为1</p><p><code>&quot;result&quot;: &quot;created&quot;,</code> -&gt; _result为新建状态</p><p>_shards是集群信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.1.1.png" alt="image-20220702101433134" tabindex="0" loading="lazy"><figcaption>image-20220702101433134</figcaption></figure><h6 id="_2、再次发送数据" tabindex="-1"><a class="header-anchor" href="#_2、再次发送数据" aria-hidden="true">#</a> 2、再次发送数据</h6><p>再次点击Send</p><p>版本号就变为了2</p><p>状态就变为了<code>updated</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.1.2.png" alt="image-20220702102235280" tabindex="0" loading="lazy"><figcaption>image-20220702102235280</figcaption></figure><h6 id="_3、put方式添加数据不允许不带id" tabindex="-1"><a class="header-anchor" href="#_3、put方式添加数据不允许不带id" aria-hidden="true">#</a> 3、<code>put</code>方式添加数据不允许不带<code>id</code></h6><p>uri [/customer/external] 和方法 [PUT] 的 HTTP 方法不正确，允许：[POST]</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Incorrect HTTP method for uri [/customer/external] and method [PUT], allowed: [POST]&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">405</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.1.3.png" alt="image-20220702104750494" tabindex="0" loading="lazy"><figcaption>image-20220702104750494</figcaption></figure><h5 id="_2、post方式添加或修改数据" tabindex="-1"><a class="header-anchor" href="#_2、post方式添加或修改数据" aria-hidden="true">#</a> 2、<code>post</code>方式添加或修改数据</h5><blockquote><p>新增: 不带id;带id但之前没数据 修改: 带id,并且有数据</p></blockquote><h6 id="_1、不带id用post方式发送请求" tabindex="-1"><a class="header-anchor" href="#_1、不带id用post方式发送请求" aria-hidden="true">#</a> 1、不带id用<code>post</code>方式发送请求</h6><ol><li><p>修改请求： http://192.168.56.10:9200/customer/external ，这次不指定id</p></li><li><p>请求方式改为<code>Post</code></p></li><li><p>再次点击Send</p></li></ol><p>返回的数据</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fUi6vIEBNNJSS-0BII0-&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>这时会自动创建一个唯一id</p></li><li><p>版本号为1</p></li><li><p>状态为新建</p></li></ol><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.2.1.png" alt="image-20220702102758892" tabindex="0" loading="lazy"><figcaption>image-20220702102758892</figcaption></figure><h6 id="_2、再次发送数据-1" tabindex="-1"><a class="header-anchor" href="#_2、再次发送数据-1" aria-hidden="true">#</a> 2、再次发送数据</h6><p>再次点击Send，又重新新建了一个数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.2.2.png" alt="image-20220702103620791" tabindex="0" loading="lazy"><figcaption>image-20220702103620791</figcaption></figure><h6 id="_3、带id用post方式发送请求" tabindex="-1"><a class="header-anchor" href="#_3、带id用post方式发送请求" aria-hidden="true">#</a> 3、带id用<code>post</code>方式发送请求</h6><p>这次指定id，输入 http://192.168.56.10:9200/customer/external/2 ，点击Send</p><p>这时状态为新建</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.2.3.png" alt="image-20220702103844999" tabindex="0" loading="lazy"><figcaption>image-20220702103844999</figcaption></figure><h6 id="_4、再次发送数据" tabindex="-1"><a class="header-anchor" href="#_4、再次发送数据" aria-hidden="true">#</a> 4、再次发送数据</h6><p>这时状态为更新</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.2.2.4.png" alt="image-20220702103858795" tabindex="0" loading="lazy"><figcaption>image-20220702103858795</figcaption></figure><h4 id="_3、查询和修改数据" tabindex="-1"><a class="header-anchor" href="#_3、查询和修改数据" aria-hidden="true">#</a> 3、查询和修改数据</h4><h5 id="_1、基础查询数据" tabindex="-1"><a class="header-anchor" href="#_1、基础查询数据" aria-hidden="true">#</a> 1、基础查询数据</h5><ol><li><p>输入<code>http://192.168.56.10:9200/customer/external/1</code></p></li><li><p>请求方式选择<code>GET</code></p></li><li><p>点击<code>Send</code></p></li></ol><p>返回的数据</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;found&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John Doe&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><code>&quot;_index&quot;: &quot;customer&quot;,</code> -&gt; 在<code>customer</code>索引下，相当于mysql中的数据库</p></li><li><p><code>&quot;_type&quot;: &quot;external&quot;,</code> -&gt; 在<code>external</code>类型下，相当于mysql中的表 （新版本已经没有<code>_type</code>了，统一为<code>_doc</code>）</p></li><li><p><code>&quot;_id&quot;: &quot;2&quot;,</code> -&gt; id为2</p></li><li><p><code>&quot;_version&quot;: 1,</code> -&gt; 版本号为1</p></li><li><p><code>&quot;_seq_no&quot;: 1,</code> -&gt; 做乐观锁操作的，只有数据一有改动<code>_seq_no</code>相当于序列号，就会往上加</p></li><li><p><code>&quot;_primary_term&quot;: 1,</code> -&gt; 分片发生了变化<code>_primary_term</code>也会往上加</p></li><li><p><code>&quot;found&quot;: true,</code> -&gt; 表明找到了数据</p></li><li><p><code>_source</code> -&gt; 内容在<code>_source</code>里面</p></li></ol><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.1.png" alt="image-20220702110104049" tabindex="0" loading="lazy"><figcaption>image-20220702110104049</figcaption></figure><h5 id="_2、乐观锁修改数据" tabindex="-1"><a class="header-anchor" href="#_2、乐观锁修改数据" aria-hidden="true">#</a> 2、乐观锁修改数据</h5><p>开两个请求窗口</p><p>请求url都输入： http://192.168.56.10:9200/customer/external/1?if_seq_no=1&amp;if_primary_term=1</p><p>请求方式都为<code>PUT</code></p><p>第一个请求里输入以下json，然后点击Send</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是响应内容，可以看到修改成功了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.2.1.png" alt="image-20220702111413505" tabindex="0" loading="lazy"><figcaption>image-20220702111413505</figcaption></figure><p>第二个请求里输入以下json，然后点击Send</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以下是响应内容，可以看到修改失败了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;root_cause&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;version_conflict_engine_exception&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;reason&quot;</span><span class="token operator">:</span> <span class="token string">&quot;[1]: version conflict, required seqNo [1], primary term [1]. current document has seqNo [6] and primary term [1]&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;index_uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;M5lWculHRVWJOSy2fVN_3Q&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;shard&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;version_conflict_engine_exception&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;reason&quot;</span><span class="token operator">:</span> <span class="token string">&quot;[1]: version conflict, required seqNo [1], primary term [1]. current document has seqNo [6] and primary term [1]&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index_uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;M5lWculHRVWJOSy2fVN_3Q&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;shard&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">409</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.2.2.png" alt="image-20220702111717240" tabindex="0" loading="lazy"><figcaption>image-20220702111717240</figcaption></figure><p>这时需要再次查询<code>_seq_no</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.2.3.png" alt="image-20220702112151904" tabindex="0" loading="lazy"><figcaption>image-20220702112151904</figcaption></figure><p>修改<code>_seq_no</code>为刚才查到的<code>_seq_no</code>的值，再次发送数据，可以看到这次查询成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.2.4.png" alt="image-20220702112206983" tabindex="0" loading="lazy"><figcaption>image-20220702112206983</figcaption></figure><h5 id="_3、带-update修改数据" tabindex="-1"><a class="header-anchor" href="#_3、带-update修改数据" aria-hidden="true">#</a> 3、带<code>_update</code>修改数据</h5><blockquote><p>带<code>_update</code>方式会对比原来数据，与原来一样就什么都不做，version, seq_no都不变</p></blockquote><blockquote><p>适用于 对于大并发查询偶尔更新，带 update；对比更新，重新计算分配规则</p></blockquote><p>请求的url： http://192.168.56.10:9200/customer/external/1/_update</p><p>请求方式为<code>POST</code>，输入以下json</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> 
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> 
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不管发送多少次，只要内容不变响应数据都为以下内容</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;noop&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.3.png" alt="image-20220702113337585" tabindex="0" loading="lazy"><figcaption>image-20220702113337585</figcaption></figure><h5 id="_4、不带-update修改数据" tabindex="-1"><a class="header-anchor" href="#_4、不带-update修改数据" aria-hidden="true">#</a> 4、不带<code>_update</code>修改数据</h5><p>put和post (不带_update) 都会直接更新数据, 对于大并发更新，不带 update</p><p>请求的url： http://192.168.56.10:9200/customer/external/1</p><p>请求方式为<code>POST</code>，输入以下json</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> 
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每发送一次请求，<code>_version</code>都会加一</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.4.1.png" alt="image-20220702113952287" tabindex="0" loading="lazy"><figcaption>image-20220702113952287</figcaption></figure><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.4.2.png" alt="image-20220702114008010" tabindex="0" loading="lazy"><figcaption>image-20220702114008010</figcaption></figure><p><code>put</code>请求也一样不比较，直接更新</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.4.3.png" alt="image-20220702114356777" tabindex="0" loading="lazy"><figcaption>image-20220702114356777</figcaption></figure><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.3.4.4.png" alt="image-20220702114411621" tabindex="0" loading="lazy"><figcaption>image-20220702114411621</figcaption></figure><h4 id="_4、更新同时增加属性" tabindex="-1"><a class="header-anchor" href="#_4、更新同时增加属性" aria-hidden="true">#</a> 4、更新同时增加属性</h4><h5 id="_1、不带-update使用put方式添加属性" tabindex="-1"><a class="header-anchor" href="#_1、不带-update使用put方式添加属性" aria-hidden="true">#</a> 1、不带<code>_update</code>使用<code>PUT</code>方式添加属性</h5><ol><li><p>url输入：http://192.168.56.10:9200/customer/external/1</p></li><li><p>请求方式选择<code>PUT</code></p></li><li><p>请求体输入以下json</p></li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> 
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">20</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>点击Send</li></ol><p>可以看到请求成功了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.4.1.1.png" alt="image-20220702232217493" tabindex="0" loading="lazy"><figcaption>image-20220702232217493</figcaption></figure><ol><li><p>url输入：http://192.168.56.10:9200/customer/external/1</p></li><li><p>请求方式选择<code>GET</code></p></li></ol><p>可以看到更新成功了</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;found&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">20</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.4.1.2.png" alt="image-20220702232336089" tabindex="0" loading="lazy"><figcaption>image-20220702232336089</figcaption></figure><h5 id="_2、带-update使用post方式添加属性" tabindex="-1"><a class="header-anchor" href="#_2、带-update使用post方式添加属性" aria-hidden="true">#</a> 2、带<code>_update</code>使用<code>POST</code>方式添加属性</h5><ol><li><p>url输入： http://192.168.56.10:9200/customer/external/1/_update</p></li><li><p>请求方式选择<code>POST</code></p></li><li><p>输入以下json，带<code>_update</code>方式需要使用&quot;doc&quot;</p></li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> 
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> 
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">20</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>点击Send</li></ol><p>响应为以下内容</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;noop&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.4.2.png" alt="image-20220702232645909" tabindex="0" loading="lazy"><figcaption>image-20220702232645909</figcaption></figure><p>📝PUT 和 POST 不带_updat</p><h4 id="_5、删除数据" tabindex="-1"><a class="header-anchor" href="#_5、删除数据" aria-hidden="true">#</a> 5、删除数据</h4><h5 id="_1、删除某个数据" tabindex="-1"><a class="header-anchor" href="#_1、删除某个数据" aria-hidden="true">#</a> 1、删除某个数据</h5><ol><li><p>url输入： http://192.168.56.10:9200/customer/external/1</p></li><li><p>请求方式选择<code>DELETE</code></p></li><li><p>点击Send</p></li></ol><p>可以看到删除成功了，响应数据为以下内容</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_version&quot;</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
    <span class="token property">&quot;result&quot;</span><span class="token operator">:</span> <span class="token string">&quot;deleted&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_seq_no&quot;</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_primary_term&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.5.1.1.png" alt="image-20220702233438018" tabindex="0" loading="lazy"><figcaption>image-20220702233438018</figcaption></figure><p>查询数据可以发现，响应状态为<code>404</code>， &quot;found&quot;为<strong>false</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;found&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.5.1.2.png" alt="image-20220702233900700" tabindex="0" loading="lazy"><figcaption>image-20220702233900700</figcaption></figure><h5 id="_2、删除索引" tabindex="-1"><a class="header-anchor" href="#_2、删除索引" aria-hidden="true">#</a> 2、删除索引</h5><ol><li><p>url输入： http://192.168.56.10:9200/customer</p></li><li><p>请求方式选择<code>DELETE</code></p></li><li><p>点击Send</p></li></ol><p>响应的数据为以下内容</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;acknowledged&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.5.2.1.png" alt="image-20220702234147259" tabindex="0" loading="lazy"><figcaption>image-20220702234147259</figcaption></figure><p>再次查询索引为<code>1</code>的数据，可以看到这次直接说<strong>索引没有找到</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;root_cause&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index_not_found_exception&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;reason&quot;</span><span class="token operator">:</span> <span class="token string">&quot;no such index [customer]&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;resource.type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index_expression&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;resource.id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;index_uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_na_&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index_not_found_exception&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;reason&quot;</span><span class="token operator">:</span> <span class="token string">&quot;no such index [customer]&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;resource.type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index_expression&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;resource.id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index_uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;_na_&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">404</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.5.2.2.png" alt="image-20220702234516077" tabindex="0" loading="lazy"><figcaption>image-20220702234516077</figcaption></figure><h4 id="_6、批量添加数据" tabindex="-1"><a class="header-anchor" href="#_6、批量添加数据" aria-hidden="true">#</a> 6、批量添加数据</h4><h5 id="_1、打开dev-tools" tabindex="-1"><a class="header-anchor" href="#_1、打开dev-tools" aria-hidden="true">#</a> 1、打开<code>Dev Tools</code></h5><p>浏览器输入url： http://192.168.56.10:5601/ ，在菜单栏点击<code>Dev Tools</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.6.1.png" alt="GIF 2022-7-2 23-50-24" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-2 23-50-24</figcaption></figure><h5 id="_2、发送简单请求" tabindex="-1"><a class="header-anchor" href="#_2、发送简单请求" aria-hidden="true">#</a> 2、发送简单请求</h5><p>批量添加数据格式</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> action<span class="token operator">:</span> <span class="token punctuation">{</span> metadata <span class="token punctuation">}</span><span class="token punctuation">}</span>\n
<span class="token punctuation">{</span> request body <span class="token punctuation">}</span>\n
<span class="token punctuation">{</span> action<span class="token operator">:</span> <span class="token punctuation">{</span> metadata <span class="token punctuation">}</span><span class="token punctuation">}</span>\n
<span class="token punctuation">{</span> request body <span class="token punctuation">}</span>\n
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行以下语句，这些批量操作都是独立的，上一个失败并不会影响下一个的执行</p><p><code>index</code>表示的是<code>新增</code>或<code>修改</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST customer/external/_bulk
<span class="token punctuation">{</span><span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John Doe&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Jane Doe&quot;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应的结果为</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#! Deprecation<span class="token operator">:</span> <span class="token punctuation">[</span>types removal<span class="token punctuation">]</span> Specifying types in bulk requests is deprecated.
<span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">427</span><span class="token punctuation">,</span>
  <span class="token property">&quot;errors&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;items&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">201</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">201</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.6.2.png" alt="image-20220702235847512" tabindex="0" loading="lazy"><figcaption>image-20220702235847512</figcaption></figure><h5 id="_3、发送复杂请求" tabindex="-1"><a class="header-anchor" href="#_3、发送复杂请求" aria-hidden="true">#</a> 3、发送复杂请求</h5><p>发送以下复杂请求</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST /_bulk
<span class="token punctuation">{</span> <span class="token property">&quot;delete&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;My first blog post&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;My second blog post&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;update&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;retry_on_conflict&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;doc&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;My updated blog post&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应的内容为</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#! Deprecation<span class="token operator">:</span> <span class="token punctuation">[</span>types removal<span class="token punctuation">]</span> Specifying types in bulk requests is deprecated.
<span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">286</span><span class="token punctuation">,</span>
  <span class="token property">&quot;errors&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;items&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;delete&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;not_found&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">404</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;create&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">201</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;f0hgvYEBNNJSS-0BkY3i&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">201</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;update&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;website&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_version&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token property">&quot;result&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;updated&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_seq_no&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_primary_term&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token number">200</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.6.3.png" alt="image-20220703000443542" tabindex="0" loading="lazy"><figcaption>image-20220703000443542</figcaption></figure><h5 id="_4、批量添加测试数据" tabindex="-1"><a class="header-anchor" href="#_4、批量添加测试数据" aria-hidden="true">#</a> 4、批量添加测试数据</h5><p>输入以下数据，然后点击运行</p><p><a href="code/5.1.3.6.4.txt">点击查看完整数据</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.6.4.png" alt="image-20220703001418445" tabindex="0" loading="lazy"><figcaption>image-20220703001418445</figcaption></figure><h5 id="_5、查看索引" tabindex="-1"><a class="header-anchor" href="#_5、查看索引" aria-hidden="true">#</a> 5、查看索引</h5><p>url输入： http://192.168.56.10:9200/_cat/indices</p><p>请求方式选择<code>GET</code></p><p>点击Send</p><p>可以看到添加了以下索引</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>yellow open website                  wXyluvLtRWike6KwFEsecw 1 1    2 2   8.6kb   8.6kb
yellow open bank                     NP_JYORgQlSTFQyh1b3TzA 1 1 1000 0 427.9kb 427.9kb
green  open .kibana_task_manager_1   sl-lzQgzRF2K2l6P5FmlFQ 1 0    2 0  30.4kb  30.4kb
green  open .apm-agent-configuration pG-exF26R4yCs2jJOSwAcA 1 0    0 0    283b    283b
green  open .kibana_1                SSGlLaInQl-tlmJqLJA6Fw 1 0    8 0  25.3kb  25.3kb
yellow open customer                 EKZizrVgRfGj8NP-mDH3qw 1 1    2 0   3.5kb   3.5kb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.3.6.5.png" alt="image-20220703001608270" tabindex="0" loading="lazy"><figcaption>image-20220703001608270</figcaption></figure><h3 id="_5-1-4、elasticsearch进阶" tabindex="-1"><a class="header-anchor" href="#_5-1-4、elasticsearch进阶" aria-hidden="true">#</a> 5.1.4、Elasticsearch进阶</h3><p>参考文档：https://www.elastic.co/guide/en/elasticsearch/reference/7.5/getting-started-search.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.0.png" alt="GIF 2022-7-3 9-55-34" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 9-55-34</figcaption></figure><h4 id="_1、基本方式检索" tabindex="-1"><a class="header-anchor" href="#_1、基本方式检索" aria-hidden="true">#</a> 1、基本方式检索</h4><p>ES 支持两种基本方式检索 :</p><ul><li><p>一个是通过使用 REST request URI 发送搜索参数（uri+检索参数）</p></li><li><p>另一个是通过使用 REST request body 来发送它们（uri+请求体)</p></li></ul><p>请求命令</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应格式</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">63</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timed_out&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skipped&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">16623</span><span class="token punctuation">,</span><span class="token property">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Bradshaw&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Mckenzie&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;244 Columbus Place&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Euron&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;bradshawmckenzie@euron.com&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Hobucken&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;CO&quot;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span><span class="token number">39225</span><span class="token punctuation">,</span><span class="token property">&quot;firstname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Amber&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span><span class="token string">&quot;Duke&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token property">&quot;gender&quot;</span><span class="token operator">:</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;880 Holmes Lane&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;employer&quot;</span><span class="token operator">:</span><span class="token string">&quot;Pyrami&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;email&quot;</span><span class="token operator">:</span><span class="token string">&quot;amberduke@pyrami.com&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token string">&quot;Brogan&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;state&quot;</span><span class="token operator">:</span><span class="token string">&quot;IL&quot;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> ...
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>The response also provides the following information about the search request:</p><ul><li><code>took</code> – how long it took Elasticsearch to run the query, in milliseconds</li><li><code>timed_out</code> – whether or not the search request timed out</li><li><code>_shards</code> – how many shards were searched and a breakdown of how many shards succeeded, failed, or were skipped.</li><li><code>max_score</code> – the score of the most relevant document found</li><li><code>hits.total.value</code> - how many matching documents were found</li><li><code>hits.sort</code> - the document’s sort position (when not sorting by relevance score)</li><li><code>hits._score</code> - the document’s relevance score (not applicable when using <code>match_all</code>)</li></ul></blockquote><p>该响应还提供有关搜索请求的以下信息：</p><ul><li><code>took</code>– Elasticsearch 运行查询需要多长时间，以毫秒为单位</li><li><code>timed_out</code>– 搜索请求是否超时</li><li><code>_shards</code>– 搜索了多少分片，以及多少分片成功、失败或被跳过的细分。</li><li><code>max_score</code>– 找到的最相关文档的分数</li><li><code>hits.total.value</code>- 找到了多少匹配的文档</li><li><code>hits.sort</code>- 文档的排序位置（不按相关性分数排序时）</li><li><code>hits._score</code>- 文档的相关性分数（使用时不适用<code>match_all</code>）</li></ul><h5 id="_1、使用uri-检索参数检索" tabindex="-1"><a class="header-anchor" href="#_1、使用uri-检索参数检索" aria-hidden="true">#</a> 1、使用<code>uri+检索参数</code>检索</h5><blockquote><p>通过使用 REST request URI 发送搜索参数（uri+检索参数）</p></blockquote><p>在<code>kibana</code>中输入以下命令</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET bank/_search?q=*&amp;sort=account_number:asc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>q=*</code>表示查询所有</p><p><code>sort=account_number:asc</code>表示按照<code>account_number</code>升序排列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.1.1.png" alt="image-20220703101549411" tabindex="0" loading="lazy"><figcaption>image-20220703101549411</figcaption></figure><h5 id="_2、使用uri-请求体检索" tabindex="-1"><a class="header-anchor" href="#_2、使用uri-请求体检索" aria-hidden="true">#</a> 2、使用<code>uri+请求体</code>检索</h5><blockquote><p>通过使用 REST request body 来发送它们（uri+请求体)</p></blockquote><p>在<code>kibana</code>中输入以下命令</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.1.2.png" alt="image-20220703101733219" tabindex="0" loading="lazy"><figcaption>image-20220703101733219</figcaption></figure><h5 id="_3、排序查询" tabindex="-1"><a class="header-anchor" href="#_3、排序查询" aria-hidden="true">#</a> 3、排序查询</h5><p>也可以先按<code>account_number</code>升序，再按<code>balance</code>降序</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
    
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token property">&quot;balance&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="code/5.1.4.1.3.json">点击查看完整响应内容</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.1.3.png" alt="image-20220703102151722" tabindex="0" loading="lazy"><figcaption>image-20220703102151722</figcaption></figure><h5 id="_4、分页查询某些字段" tabindex="-1"><a class="header-anchor" href="#_4、分页查询某些字段" aria-hidden="true">#</a> 4、分页查询某些字段</h5><p><code>&quot;from&quot;: 5,&quot;size&quot;: 5,</code> ：从第5条数据开始，查询5条数据</p><p><code>&quot;_source&quot;: [&quot;balance&quot;, &quot;firstname&quot;]</code> ：查询<strong>balance</strong>和 <strong>firstname</strong>字段</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;balance&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;firstname&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.1.4.png" alt="image-20220703103445049" tabindex="0" loading="lazy"><figcaption>image-20220703103445049</figcaption></figure><h4 id="_2、match匹配查询" tabindex="-1"><a class="header-anchor" href="#_2、match匹配查询" aria-hidden="true">#</a> 2、<code>match</code>匹配查询</h4><ul><li><p><strong>基本类型（非字符串），精确匹配</strong> -&gt; <code>&quot;account_number&quot;: &quot;20&quot;</code>match 返回 account_number=20 的</p></li><li><p><strong>字符串，全文检索</strong> -&gt; <code>&quot;address&quot;: &quot;mill&quot;</code>match 当搜索字符串类型的时候，会进行全文检索，并且每条记录有相关性得分。</p></li><li><p><strong>字符串，多个单词（分词+全文检索）</strong>-&gt; <code>&quot;address&quot;: &quot;mill road&quot;</code>最终查询出 address 中包含 mill 或者 road 或者 mill road 的所有记录，并给出相关性得分</p></li></ul><h5 id="_1、精确匹配" tabindex="-1"><a class="header-anchor" href="#_1、精确匹配" aria-hidden="true">#</a> 1、精确匹配</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;account_number&quot;</span><span class="token operator">:</span> <span class="token number">20</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.2.1.png" alt="image-20220703104726893" tabindex="0" loading="lazy"><figcaption>image-20220703104726893</figcaption></figure><h5 id="_2、模糊匹配1" tabindex="-1"><a class="header-anchor" href="#_2、模糊匹配1" aria-hidden="true">#</a> 2、模糊匹配1</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Kings&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到<code>address</code>中包含有<code>Kings</code>的都检索出来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.2.2.png" alt="image-20220703105131244" tabindex="0" loading="lazy"><figcaption>image-20220703105131244</figcaption></figure><h5 id="_3、模糊匹配2" tabindex="-1"><a class="header-anchor" href="#_3、模糊匹配2" aria-hidden="true">#</a> 3、模糊匹配2</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill lane&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，只要包含了<code>mill</code>或<code>lane</code>的都能查出来，其中<code>198 Mill Lane</code>的得分最高，默认按照<strong>评分</strong>由高到低排列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.2.3.png" alt="image-20220703114129813" tabindex="0" loading="lazy"><figcaption>image-20220703114129813</figcaption></figure><h4 id="_3、match-phrase短语-不分词-匹配" tabindex="-1"><a class="header-anchor" href="#_3、match-phrase短语-不分词-匹配" aria-hidden="true">#</a> 3、<code>match_phrase</code>短语（不分词）匹配</h4><p>将需要匹配的值当成一个整体单词（不分词）进行检索 -&gt; <code>&quot;address&quot;: &quot;mill</code> 查出 address 中包含 mill road 的所有记录，并给出相关性得</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_phrase&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill lane&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时只能查询出多个单词全存在的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.3.1.png" alt="image-20220703115548296" tabindex="0" loading="lazy"><figcaption>image-20220703115548296</figcaption></figure><p>使用<code>match_phrase</code>匹配时必须指定字段包含该不分词的短语，但该字段不必须只包含该短语</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_phrase&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;789 Madison&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.3.2.png" alt="image-20220703163827063" tabindex="0" loading="lazy"><figcaption>image-20220703163827063</figcaption></figure><p>使用<code>FIELD.keyword</code>匹配必须指定字段为该不分词的短语</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address.keyword&quot;</span><span class="token operator">:</span> <span class="token string">&quot;789 Madison&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.3.3.png" alt="image-20220703164459194" tabindex="0" loading="lazy"><figcaption>image-20220703164459194</figcaption></figure><h4 id="_4、multi-match多字段匹配" tabindex="-1"><a class="header-anchor" href="#_4、multi-match多字段匹配" aria-hidden="true">#</a> 4、<code>multi_match</code>多字段匹配</h4><p>多个字段其中有任何一个字段匹配</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;multi_match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.4.1.png" alt="image-20220703120032455" tabindex="0" loading="lazy"><figcaption>image-20220703120032455</figcaption></figure><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;multi_match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill movico&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到多字段匹配用的也是<code>match匹配查询</code>,也查询出了包含<strong>分词</strong>的所有数据；包含的分词越多，得分越高</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.4.2.png" alt="image-20220703120314378" tabindex="0" loading="lazy"><figcaption>image-20220703120314378</figcaption></figure><h4 id="_5、bool复合查询" tabindex="-1"><a class="header-anchor" href="#_5、bool复合查询" aria-hidden="true">#</a> 5、<code>bool</code>复合查询</h4><blockquote><p>To construct more complex queries, you can use a <code>bool</code> query to combine multiple query criteria. You can designate criteria as required (must match), desirable (should match), or undesirable (must not match).</p></blockquote><p>要构造更复杂的查询，您可以使用一个<code>bool</code>查询来组合多个查询条件。您可以根据需要（必须匹配）、需要（应该匹配）或不需要（必须不匹配）指定条件。</p><p>bool 用来做复合查询： 复合语句可以合并任何 其它查询语句，包括复合语句，了解这一点是很重要的。这就意味着，复合语句之间可以互相嵌套，可以表达非常复杂的逻辑。</p><blockquote><p>Each <code>must</code>, <code>should</code>, and <code>must_not</code> element in a Boolean query is referred to as a query clause. How well a document meets the criteria in each <code>must</code> or <code>should</code> clause contributes to the document’s <em>relevance score</em>. The higher the score, the better the document matches your search criteria. By default, Elasticsearch returns documents ranked by these relevance scores.</p><p>The criteria in a <code>must_not</code> clause is treated as a <em>filter</em>. It affects whether or not the document is included in the results, but does not contribute to how documents are scored. You can also explicitly specify arbitrary filters to include or exclude documents based on structured data.</p></blockquote><p>布尔查询中的每个<code>must</code>、<code>should</code>和<code>must_not</code>元素都称为查询子句。文档满足每个**<code>must</code>或 <code>should</code><strong>子句中的标准的程度会</strong>影响文档的<em>相关性评分</em>**。分数越高，文档越符合您的搜索条件。默认情况下，Elasticsearch 返回按这些相关性分数排序的文档。</p><p>子句中的条件**<code>must_not</code><strong>被视为<em>过滤器</em>。它影响文档是否包含在结果中，但</strong>不影响文档的评分**方式。您还可以显式指定任意过滤器以根据结构化数据包含或排除文档。</p><h5 id="_1、必须满足-必须不满足" tabindex="-1"><a class="header-anchor" href="#_1、必须满足-必须不满足" aria-hidden="true">#</a> 1、必须满足&amp;必须不满足</h5><blockquote><p>must：必须达到 must 列举的所有条件</p></blockquote><p>必须满足<code>&quot;gender&quot;: &quot;M&quot;</code>和<code> &quot;address&quot;: &quot;mill&quot;</code> 必须不满足 <code>&quot;age&quot;: &quot;38&quot; </code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;gender&quot;</span><span class="token operator">:</span> <span class="token string">&quot;M&quot;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;38&quot;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.5.1.png" alt="image-20220703121320710" tabindex="0" loading="lazy"><figcaption>image-20220703121320710</figcaption></figure><h5 id="_2、应该匹配" tabindex="-1"><a class="header-anchor" href="#_2、应该匹配" aria-hidden="true">#</a> 2、应该匹配</h5><blockquote><p>should：应该达到 should 列举的条件，如果达到会增加相关文档的评分，并不会改变查询的结果。如果 query 中只有 should 且只有一种匹配规则，那么 should 的条件就会被作为默认匹配条件而去改变查询结果</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;gender&quot;</span><span class="token operator">:</span> <span class="token string">&quot;M&quot;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;18&quot;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;should&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;lastname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Wallace&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.5.2.png" alt="image-20220703122030654" tabindex="0" loading="lazy"><figcaption>image-20220703122030654</figcaption></figure><h4 id="_6、filter结果过滤" tabindex="-1"><a class="header-anchor" href="#_6、filter结果过滤" aria-hidden="true">#</a> 6、<code>filter</code>结果过滤</h4><p>可以看到使用<code>must</code>会有相关性得分</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
              <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">30</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.6.1.png" alt="image-20220703160839346" tabindex="0" loading="lazy"><figcaption>image-20220703160839346</figcaption></figure><p>而使用<code>filter</code>没有相关性得分</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
              <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">30</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.6.2.png" alt="image-20220703161056920" tabindex="0" loading="lazy"><figcaption>image-20220703161056920</figcaption></figure><h4 id="_7、term-query" tabindex="-1"><a class="header-anchor" href="#_7、term-query" aria-hidden="true">#</a> 7、<code>Term query</code></h4><p><code>term</code>和<code>match</code>一样。匹配某个属性的值。全文检索字段用 match，其他非 text 字段匹配(精确的字段匹配)用 term。</p><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl-term-query.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.7.0.png" alt="GIF 2022-7-3 16-16-22" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 16-16-22</figcaption></figure><p><strong>Term query</strong></p><blockquote><p>Returns documents that contain an <strong>exact</strong> term in a provided field.</p><p>You can use the <code>term</code> query to find documents based on a precise value such as a price, a product ID, or a username.</p><p>Avoid using the <code>term</code> query for <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/text.html" target="_blank" rel="noopener noreferrer"><code>text</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> fields.</p><p>By default, Elasticsearch changes the values of <code>text</code> fields as part of <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis.html" target="_blank" rel="noopener noreferrer">analysis<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. This can make finding exact matches for <code>text</code> field values difficult.</p><p>To search <code>text</code> field values, use the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl-match-query.html" target="_blank" rel="noopener noreferrer"><code>match</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> query instead.</p></blockquote><p><strong>Term查询</strong></p><p>返回在提供的字段中包含<strong>确切术语的文档。</strong></p><p>您可以使用<code>term</code>查询根据价格、产品 ID 或用户名等精确值查找文档。</p><p>避免使用字段<code>term</code>查询<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/text.html" target="_blank" rel="noopener noreferrer"><code>text</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>默认情况下，Elasticsearch 会在<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis.html" target="_blank" rel="noopener noreferrer">分析<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>text</code>过程中更改字段的值。这会使查找字段值的精确匹配变得困难<code>text</code></p><p>要搜索<code>text</code>字段值，请改用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/query-dsl-match-query.html" target="_blank" rel="noopener noreferrer"><code>match</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>查询。</p><p>使用<code>match</code>可以查询<code>&quot;age&quot;: &quot;28&quot;</code>的数据</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;28&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.7.1.png" alt="image-20220703162602367" tabindex="0" loading="lazy"><figcaption>image-20220703162602367</figcaption></figure><p>使用<code>term</code>也可以查询<code>&quot;age&quot;: &quot;28&quot;</code>的数据，推荐使用<code>term</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;28&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.7.2.png" alt="image-20220703162642804" tabindex="0" loading="lazy"><figcaption>image-20220703162642804</figcaption></figure><p>使用<code>term</code>查询多字段<code>text</code>会查询不到</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;789 Madison Street&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.7.3.png" alt="image-20220703163023175" tabindex="0" loading="lazy"><figcaption>image-20220703163023175</figcaption></figure><h4 id="_8、aggregations执行聚合" tabindex="-1"><a class="header-anchor" href="#_8、aggregations执行聚合" aria-hidden="true">#</a> 8、<code>aggregations</code>执行聚合</h4><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.0.png" alt="GIF 2022-7-3 21-44-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 21-44-17</figcaption></figure><blockquote><p>The aggregations framework helps provide aggregated data based on a search query. It is based on simple building blocks called aggregations, that can be composed in order to build complex summaries of the data.</p><p>An aggregation can be seen as a <em>unit-of-work</em> that builds analytic information over a set of documents. The context of the execution defines what this document set is (e.g. a top-level aggregation executes within the context of the executed query/filters of the search request).</p><p>There are many different types of aggregations, each with its own purpose and output. To better understand these types, it is often easier to break them into four main families:</p><ul><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-bucket.html" target="_blank" rel="noopener noreferrer">*Bucketing*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>A family of aggregations that build buckets, where each bucket is associated with a <em>key</em> and a document criterion. When the aggregation is executed, all the buckets criteria are evaluated on every document in the context and when a criterion matches, the document is considered to &quot;fall in&quot; the relevant bucket. By the end of the aggregation process, we’ll end up with a list of buckets - each one with a set of documents that &quot;belong&quot; to it.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-metrics.html" target="_blank" rel="noopener noreferrer">*Metric*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>Aggregations that keep track and compute metrics over a set of documents.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-matrix.html" target="_blank" rel="noopener noreferrer">*Matrix*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>A family of aggregations that operate on multiple fields and produce a matrix result based on the values extracted from the requested document fields. Unlike metric and bucket aggregations, this aggregation family does not yet support scripting.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-pipeline.html" target="_blank" rel="noopener noreferrer">*Pipeline*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>Aggregations that aggregate the output of other aggregations and their associated metrics</p></li></ul><p>The interesting part comes next. Since each bucket effectively defines a document set (all documents belonging to the bucket), one can potentially associate aggregations on the bucket level, and those will execute within the context of that bucket. This is where the real power of aggregations kicks in: <strong>aggregations can be nested!</strong></p></blockquote><p>聚合框架有助于提供基于搜索查询的聚合数据。它基于称为聚合的简单构建块，可以组合这些块以构建复杂的数据摘要。</p><p>聚合可以看作是在一组文档上构建分析信息*的工作单元。*执行的上下文定义了该文档集是什么（例如，顶级聚合在搜索请求的已执行查询/过滤器的上下文中执行）。</p><p>有许多不同类型的聚合，每种都有自己的目的和输出。为了更好地理解这些类型，通常更容易将它们分为四个主要系列：</p><ul><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-bucket.html" target="_blank" rel="noopener noreferrer">*分桶*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：构建存储桶的聚合系列，其中每个存储桶都与一个<em>键</em>和一个文档标准相关联。执行聚合时，将对上下文中的每个文档评估所有存储桶标准，并且当标准匹配时，该文档被认为“落入”相关存储桶中。在聚合过程结束时，我们将得到一个桶列表——每个桶都有一组“属于”它的文档。</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-metrics.html" target="_blank" rel="noopener noreferrer">*公制*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：跟踪和计算一组文档的指标的聚合。</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-matrix.html" target="_blank" rel="noopener noreferrer">*矩阵*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：对多个字段进行操作并根据从请求的文档字段中提取的值生成矩阵结果的聚合系列。与度量和桶聚合不同，这个聚合系列还不支持脚本。</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-aggregations-pipeline.html" target="_blank" rel="noopener noreferrer">*管道*<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：聚合其他聚合及其相关指标的输出的聚合</li></ul><p>接下来是有趣的部分。由于每个存储桶有效地定义了一个文档集（属于该存储桶的所有文档），因此可以潜在地将存储桶级别的聚合关联起来，并且这些聚合将在该存储桶的上下文中执行。这就是聚合真正强大的地方：<strong>聚合可以嵌套！</strong></p><p>分桶聚合可以有子聚合（分桶或度量）。将为它们的父聚合生成的桶计算子聚合。嵌套聚合的级别/深度没有硬性限制（可以将聚合嵌套在“父”聚合下，该聚合本身是另一个更高级别聚合的子聚合）。</p><p>聚合对<code>double</code>数据的表示进行操作。因此，在绝对值大于 的 long 上运行时，结果可能是近似的<code>2^53</code>。</p><p><strong>结构化聚合</strong></p><p>以下代码片段捕获了聚合的基本结构：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token string-property property">&quot;aggregations&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;&lt;aggregation_name&gt;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;&lt;aggregation_type&gt;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token operator">&lt;</span>aggregation_body<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token string-property property">&quot;meta&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token punctuation">[</span><span class="token operator">&lt;</span>meta_data_body<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token operator">?</span>
        <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token string-property property">&quot;aggregations&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>sub_aggregation<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">+</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token operator">?</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token string-property property">&quot;&lt;aggregation_name_2&gt;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token operator">*</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JSON 中的<code>aggregations</code>对象（<code>aggs</code>也可以使用键）保存要计算的聚合。每个聚合都与用户定义的逻辑名称相关联（例如，如果聚合计算平均价格，那么命名它是有意义的<code>avg_price</code>）。这些逻辑名称也将用于唯一标识响应中的聚合。每个聚合都有一个特定的类型（<code>&lt;aggregation_type&gt;</code>在上面的代码片段中），并且通常是命名聚合体中的第一个键。每种类型的聚合都定义了自己的主体，具体取决于聚合的性质（例如<code>avg</code>特定字段的聚合将定义计算平均值的字段）。在聚合类型定义的同一级别，可以选择定义一组附加聚合，尽管这仅在您定义的聚合具有分桶性质时才有意义。在这种情况下，您在桶聚合级别上定义的子聚合将为桶聚合构建的所有桶计算。例如，如果您在聚合下定义了一组<code>range</code>聚合，则将为定义的范围存储桶计算子聚合。</p><p><strong>解释：</strong></p><p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于 SQL GROUP BY 和 SQL 聚合函数。在 Elasticsearch 中，您有执行搜索返回 hits（命中结果），并且同时返 回聚合结果，把一个响应中的所有 hits（命中结果）分隔开的能力。这是非常强大且有效的， 您可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用 一次简洁和简化的 API 来避免网络往返。</p><h5 id="_1、简单聚合" tabindex="-1"><a class="header-anchor" href="#_1、简单聚合" aria-hidden="true">#</a> 1、简单聚合</h5><p><strong>搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情。</strong></p><ol><li>搜索 address 中包含 mill的</li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span> 
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.1.1.png" alt="image-20220703165619560" tabindex="0" loading="lazy"><figcaption>image-20220703165619560</figcaption></figure><ol start="2"><li>搜索 address 中包含 mill 的所有人的年龄分布</li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span> 
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;age_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.1.2.png" alt="image-20220703165758939" tabindex="0" loading="lazy"><figcaption>image-20220703165758939</figcaption></figure><ol start="3"><li>搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄</li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span> 
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;age_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;avg_age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.1.3.png" alt="image-20220703165931194" tabindex="0" loading="lazy"><figcaption>image-20220703165931194</figcaption></figure><ol start="4"><li>搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情。</li></ol><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span> 
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;age_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;avg_age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.1.4.png" alt="image-20220703170051207" tabindex="0" loading="lazy"><figcaption>image-20220703170051207</figcaption></figure><p>size：0 不显示搜索数据</p><p>aggs：执行聚合。</p><p>聚合语法如下</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code> <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
 	<span class="token property">&quot;aggs_name 这次聚合的名字，方便展示在结果集中&quot;</span><span class="token operator">:</span> 
 		<span class="token punctuation">{</span> <span class="token property">&quot;AGG_TYPE 聚合的类型（avg,term,terms）&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
 		<span class="token punctuation">}</span> 
 	<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2、复杂聚合1" tabindex="-1"><a class="header-anchor" href="#_2、复杂聚合1" aria-hidden="true">#</a> 2、复杂聚合1</h5><p>按照年龄聚合，并且请求这些年龄段的这些人的平均薪资</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/account/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;age_avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1000</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;banlances_avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">,</span><span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">1000</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.2.png" alt="image-20220703212016653" tabindex="0" loading="lazy"><figcaption>image-20220703212016653</figcaption></figure><h5 id="_3、复杂聚合2" tabindex="-1"><a class="header-anchor" href="#_3、复杂聚合2" aria-hidden="true">#</a> 3、复杂聚合2</h5><p>查出<strong>所有年龄分布</strong>，并且这些年龄段中<strong>性别为 M 的平均薪资</strong>和 <strong>性别为F 的平均薪资</strong>以及<strong>这个年龄段的总体平均薪资</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;age_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;balance_agg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gender.keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;balance_avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;balance_agg2&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.4.8.3.png" alt="image-20220703213723229" tabindex="0" loading="lazy"><figcaption>image-20220703213723229</figcaption></figure><h3 id="_5-1-5、elasticsearch映射" tabindex="-1"><a class="header-anchor" href="#_5-1-5、elasticsearch映射" aria-hidden="true">#</a> 5.1.5、Elasticsearch映射</h3><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.0.png" alt="GIF 2022-7-3 21-45-43" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 21-45-43</figcaption></figure><blockquote><p>Mapping is the process of defining how a document, and the fields it contains, are stored and indexed. For instance, use mappings to define:</p><ul><li>which string fields should be treated as full text fields.</li><li>which fields contain numbers, dates, or geolocations.</li><li>the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-date-format.html" target="_blank" rel="noopener noreferrer">format<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> of date values.</li><li>custom rules to control the mapping for <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/dynamic-mapping.html" target="_blank" rel="noopener noreferrer">dynamically added fields<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li></ul><p>A mapping definition has:</p><ul><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-fields.html" target="_blank" rel="noopener noreferrer">Meta-fields<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>Meta-fields are used to customize how a document’s metadata associated is treated. Examples of meta-fields include the document’s <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-index-field.html" target="_blank" rel="noopener noreferrer"><code>_index</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-id-field.html" target="_blank" rel="noopener noreferrer"><code>_id</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-source-field.html" target="_blank" rel="noopener noreferrer"><code>_source</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> fields.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-types.html" target="_blank" rel="noopener noreferrer">Fields<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> or *properties*</strong></p><p>A mapping contains a list of fields or <code>properties</code> pertinent to the document.</p></li></ul><p>Each field has a data <code>type</code> which can be:</p><ul><li>a simple type like <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/text.html" target="_blank" rel="noopener noreferrer"><code>text</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/keyword.html" target="_blank" rel="noopener noreferrer"><code>keyword</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/date.html" target="_blank" rel="noopener noreferrer"><code>date</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/number.html" target="_blank" rel="noopener noreferrer"><code>long</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/number.html" target="_blank" rel="noopener noreferrer"><code>double</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/boolean.html" target="_blank" rel="noopener noreferrer"><code>boolean</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ip.html" target="_blank" rel="noopener noreferrer"><code>ip</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li><li>a type which supports the hierarchical nature of JSON such as <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/object.html" target="_blank" rel="noopener noreferrer"><code>object</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/nested.html" target="_blank" rel="noopener noreferrer"><code>nested</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li><li>or a specialised type like <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/geo-point.html" target="_blank" rel="noopener noreferrer"><code>geo_point</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/geo-shape.html" target="_blank" rel="noopener noreferrer"><code>geo_shape</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-suggesters.html#completion-suggester" target="_blank" rel="noopener noreferrer"><code>completion</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li></ul><p>It is often useful to index the same field in different ways for different purposes. For instance, a <code>string</code> field could be <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-index.html" target="_blank" rel="noopener noreferrer">indexed<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> as a <code>text</code> field for full-text search, and as a <code>keyword</code> field for sorting or aggregations. Alternatively, you could index a string field with the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-standard-analyzer.html" target="_blank" rel="noopener noreferrer"><code>standard</code> analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html#english-analyzer" target="_blank" rel="noopener noreferrer"><code>english</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> analyzer, and the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html#french-analyzer" target="_blank" rel="noopener noreferrer"><code>french</code> analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><p>This is the purpose of <em>multi-fields</em>. Most datatypes support multi-fields via the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/multi-fields.html" target="_blank" rel="noopener noreferrer"><code>fields</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> parameter.</p></blockquote><p>映射是定义文档及其包含的字段如何存储和索引的过程。例如，使用映射来定义：</p><ul><li>哪些字符串字段应被视为全文字段。</li><li>哪些字段包含数字、日期或地理位置。</li><li>日期值的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-date-format.html" target="_blank" rel="noopener noreferrer">格式<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li><li>自定义规则来控制 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/dynamic-mapping.html" target="_blank" rel="noopener noreferrer">动态添加字段<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>的映射。</li></ul><p>映射定义具有：</p><ul><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-fields.html" target="_blank" rel="noopener noreferrer">元字段<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：元字段用于自定义如何处理文档的相关元数据。元字段的示例包括文档的 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-index-field.html" target="_blank" rel="noopener noreferrer"><code>_index</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-id-field.html" target="_blank" rel="noopener noreferrer"><code>_id</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>和 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-source-field.html" target="_blank" rel="noopener noreferrer"><code>_source</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>字段。</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-types.html" target="_blank" rel="noopener noreferrer">字段<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>或属性</strong>：映射包含<code>properties</code>与文档相关的字段列表。</li></ul><p>每个字段都有一个数据<code>type</code>，可以是：</p><ul><li>一个简单的类型，如<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/text.html" target="_blank" rel="noopener noreferrer"><code>text</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/keyword.html" target="_blank" rel="noopener noreferrer"><code>keyword</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/date.html" target="_blank" rel="noopener noreferrer"><code>date</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/number.html" target="_blank" rel="noopener noreferrer"><code>long</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/number.html" target="_blank" rel="noopener noreferrer"><code>double</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>,<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/boolean.html" target="_blank" rel="noopener noreferrer"><code>boolean</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>或<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ip.html" target="_blank" rel="noopener noreferrer"><code>ip</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li><li>一种支持 JSON 分层特性的类型，例如 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/object.html" target="_blank" rel="noopener noreferrer"><code>object</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>或<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/nested.html" target="_blank" rel="noopener noreferrer"><code>nested</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li><li>或特殊类型，如<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/geo-point.html" target="_blank" rel="noopener noreferrer"><code>geo_point</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/geo-shape.html" target="_blank" rel="noopener noreferrer"><code>geo_shape</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>或<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-suggesters.html#completion-suggester" target="_blank" rel="noopener noreferrer"><code>completion</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</li></ul><p>出于不同目的以不同方式索引同一字段通常很有用。例如，一个<code>string</code>字段可以被<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-index.html" target="_blank" rel="noopener noreferrer">索引<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>为一个<code>text</code>用于全文搜索的字段，也可以作为一个<code>keyword</code>用于排序或聚合的字段。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-standard-analyzer.html" target="_blank" rel="noopener noreferrer"><code>standard</code>或者，您可以使用分析器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>、 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html#english-analyzer" target="_blank" rel="noopener noreferrer"><code>english</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>分析器和 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html#french-analyzer" target="_blank" rel="noopener noreferrer"><code>french</code>分析器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>索引字符串字段。</p><p>这就是<em>多领域</em>的目的。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/multi-fields.html" target="_blank" rel="noopener noreferrer"><code>fields</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>大多数数据类型通过参数支持多字段。</p><h4 id="_1、查询映射" tabindex="-1"><a class="header-anchor" href="#_1、查询映射" aria-hidden="true">#</a> 1、查询映射</h4><blockquote><p><strong>View the mapping of an index</strong></p><p>You can use the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/indices-get-mapping.html" target="_blank" rel="noopener noreferrer">get mapping<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> API to view the mapping of an existing index.</p></blockquote><div class="language-console line-numbers-mode" data-ext="console"><pre class="language-console"><code>GET bank/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.1.png" alt="image-20220703220410069" tabindex="0" loading="lazy"><figcaption>image-20220703220410069</figcaption></figure><h4 id="_2、创建索引" tabindex="-1"><a class="header-anchor" href="#_2、创建索引" aria-hidden="true">#</a> 2、创建索引</h4><p>新特性：Es7 及以上移除了 type 的概念。</p><p>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用， 但 ES 中不是这样的。elasticsearch 是基于 Lucene 开发的搜索引擎，而 ES 中不同 type 下名称相同的 filed 最终在 Lucene 中的处理方式是一样的。</p><ul><li>两个不同 type 下的两个 user_name，在 ES 同一个索引下其实被认为是同一个 filed， 你必须在两个不同的 type 中定义相同的 filed 映射。否则，不同 type 中的相同字段 名称就会在处理中出现冲突的情况，导致 Lucene 处理效率下降。</li><li>去掉 type 就是为了提高 ES 处理数据的效率。</li></ul><p>数据类型参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-types.html</p><p><strong>Core datatypes</strong></p><ul><li><strong>string</strong>：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/text.html" target="_blank" rel="noopener noreferrer"><code>text</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/keyword.html" target="_blank" rel="noopener noreferrer"><code>keyword</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/number.html" target="_blank" rel="noopener noreferrer">Numeric<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>long</code>, <code>integer</code>, <code>short</code>, <code>byte</code>, <code>double</code>, <code>float</code>, <code>half_float</code>, <code>scaled_float</code></li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/date.html" target="_blank" rel="noopener noreferrer">Date<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>date</code></li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/date_nanos.html" target="_blank" rel="noopener noreferrer">Date nanoseconds<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>date_nanos</code></li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/boolean.html" target="_blank" rel="noopener noreferrer">Boolean<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>boolean</code></li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/binary.html" target="_blank" rel="noopener noreferrer">Binary<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>binary</code></li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/range.html" target="_blank" rel="noopener noreferrer">Range<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>integer_range</code>, <code>float_range</code>, <code>long_range</code>, <code>double_range</code>, <code>date_range</code></li></ul><p><strong>Complex datatypes</strong></p><ul><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/object.html" target="_blank" rel="noopener noreferrer">Object<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>object</code> for single JSON objects</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/nested.html" target="_blank" rel="noopener noreferrer">Nested<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>nested</code> for arrays of JSON objects</li></ul><p><strong>Geo datatypes</strong></p><ul><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/geo-point.html" target="_blank" rel="noopener noreferrer">Geo-point<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>geo_point</code> for lat/lon points</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/geo-shape.html" target="_blank" rel="noopener noreferrer">Geo-shape<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>geo_shape</code> for complex shapes like polygons</li></ul><p><strong>Specialised datatypes</strong></p><ul><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ip.html" target="_blank" rel="noopener noreferrer">IP<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>ip</code> for IPv4 and IPv6 addresses</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-suggesters.html#completion-suggester" target="_blank" rel="noopener noreferrer">Completion datatype<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>completion</code> to provide auto-complete suggestions</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/token-count.html" target="_blank" rel="noopener noreferrer">Token count<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>token_count</code> to count the number of tokens in a string</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.5/mapper-murmur3.html" target="_blank" rel="noopener noreferrer"><code>mapper-murmur3</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>murmur3</code> to compute hashes of values at index-time and store them in the index</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.5/mapper-annotated-text.html" target="_blank" rel="noopener noreferrer"><code>mapper-annotated-text</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>annotated-text</code> to index text containing special markup (typically used for identifying named entities)</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/percolator.html" target="_blank" rel="noopener noreferrer">Percolator<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Accepts queries from the query-dsl</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/parent-join.html" target="_blank" rel="noopener noreferrer">Join<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Defines parent/child relation for documents within the same index</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/rank-feature.html" target="_blank" rel="noopener noreferrer">Rank feature<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Record numeric feature to boost hits at query time.</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/rank-features.html" target="_blank" rel="noopener noreferrer">Rank features<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Record numeric features to boost hits at query time.</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/dense-vector.html" target="_blank" rel="noopener noreferrer">Dense vector<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Record dense vectors of float values.</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/sparse-vector.html" target="_blank" rel="noopener noreferrer">Sparse vector<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Record sparse vectors of float values.</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/search-as-you-type.html" target="_blank" rel="noopener noreferrer">Search-as-you-type<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：A text-like field optimized for queries to implement as-you-type completion</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/alias.html" target="_blank" rel="noopener noreferrer">Alias<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Defines an alias to an existing field.</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/flattened.html" target="_blank" rel="noopener noreferrer">Flattened<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：Allows an entire JSON object to be indexed as a single field.</li><li><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/shape.html" target="_blank" rel="noopener noreferrer">Shape<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong>：<code>shape</code> for arbitrary cartesian geometries.</li></ul><p><strong>Arrays</strong></p><p>In Elasticsearch, arrays do not require a dedicated field datatype. Any field can contain zero or more values by default, however, all values in the array must be of the same datatype. See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/array.html" target="_blank" rel="noopener noreferrer">Arrays<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><p><strong>Multi-fields</strong></p><p>It is often useful to index the same field in different ways for different purposes. For instance, a <code>string</code> field could be mapped as a <code>text</code> field for full-text search, and as a <code>keyword</code> field for sorting or aggregations. Alternatively, you could index a text field with the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-standard-analyzer.html" target="_blank" rel="noopener noreferrer"><code>standard</code> analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html#english-analyzer" target="_blank" rel="noopener noreferrer"><code>english</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> analyzer, and the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html#french-analyzer" target="_blank" rel="noopener noreferrer"><code>french</code> analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><p>This is the purpose of <em>multi-fields</em>. Most datatypes support multi-fields via the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/multi-fields.html" target="_blank" rel="noopener noreferrer"><code>fields</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> parameter.</p><blockquote><p>Create an index with an explicit mapping</p><p>You can use the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/indices-create-index.html" target="_blank" rel="noopener noreferrer">create index<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> API to create a new index with an explicit mapping.</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;age&quot;</span><span class="token operator">:</span>    <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  
      <span class="token property">&quot;email&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span>   <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>  <span class="token punctuation">}</span>     
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.2.png" alt="image-20220703221239036" tabindex="0" loading="lazy"><figcaption>image-20220703221239036</figcaption></figure><h4 id="_3、添加新的字段映射" tabindex="-1"><a class="header-anchor" href="#_3、添加新的字段映射" aria-hidden="true">#</a> 3、添加新的字段映射</h4><blockquote><p><strong>Add a field to an existing mapping</strong></p><p>You can use the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/indices-put-mapping.html" target="_blank" rel="noopener noreferrer">put mapping<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> API to add one or more new fields to an existing index.</p><p>The following example adds <code>employee-id</code>, a <code>keyword</code> field with an <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-index.html" target="_blank" rel="noopener noreferrer"><code>index</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> mapping parameter value of <code>false</code>. This means values for the <code>employee-id</code> field are stored but not indexed or available for search.</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT /my_index/_mapping
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;employee-id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.3.png" alt="image-20220703221529151" tabindex="0" loading="lazy"><figcaption>image-20220703221529151</figcaption></figure><h4 id="_4、更新映射" tabindex="-1"><a class="header-anchor" href="#_4、更新映射" aria-hidden="true">#</a> 4、更新映射</h4><blockquote><p><strong>Update the mapping of a field</strong></p><p>Except for supported <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/mapping-params.html" target="_blank" rel="noopener noreferrer">mapping parameters<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, you can’t change the mapping or field type of an existing field. Changing an existing field could invalidate data that’s already indexed.</p><p>If you need to change the mapping of a field, create a new index with the correct mapping and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docs-reindex.html" target="_blank" rel="noopener noreferrer">reindex<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> your data into that index.</p><p>Renaming a field would invalidate data already indexed under the old field name. Instead, add an <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/alias.html" target="_blank" rel="noopener noreferrer"><code>alias</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> field to create an alternate field name.</p></blockquote><p>对于已经存在的映射字段，我们不能更新。更新必须创建新的索引进行数据迁移</p><h4 id="_5、数据迁移" tabindex="-1"><a class="header-anchor" href="#_5、数据迁移" aria-hidden="true">#</a> 5、数据迁移</h4><h5 id="_1、创建新的索引" tabindex="-1"><a class="header-anchor" href="#_1、创建新的索引" aria-hidden="true">#</a> 1、创建新的索引</h5><p>可以使用<code>GET bank/_mapping</code>查看<code>bank</code>的映射信息，把结果复制下来，输入<code>PUT newbank</code>，并粘贴刚刚复制的结果，再删除<code>粘贴过来的结果</code>里的<code>&quot;product&quot; :{ }</code>(右括号随便在最后删除一个就行了)。然后点击<code>工具</code>图标，选择<code>Auto indent</code>格式化一下代码，再在里面修改映射信息</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT newbank
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;account_number&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;address&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;balance&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;city&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;email&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;employer&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;firstname&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;gender&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;lastname&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;ignore_above&quot;</span> <span class="token operator">:</span> <span class="token number">256</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.5.1.png" alt="image-20220703223510809" tabindex="0" loading="lazy"><figcaption>image-20220703223510809</figcaption></figure><h5 id="_2、迁移数据" tabindex="-1"><a class="header-anchor" href="#_2、迁移数据" aria-hidden="true">#</a> 2、迁移数据</h5><p>可以不用<code>&quot;type&quot;: &quot;account&quot;</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _reindex
<span class="token punctuation">{</span>
  <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bank&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;account&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;newbank&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.5.2.png" alt="image-20220703223839058" tabindex="0" loading="lazy"><figcaption>image-20220703223839058</figcaption></figure><h5 id="_3、查询迁移的数据" tabindex="-1"><a class="header-anchor" href="#_3、查询迁移的数据" aria-hidden="true">#</a> 3、查询迁移的数据</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET newbank/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到都把数据放到<code>&quot;_type&quot; : &quot;_doc&quot;</code>默认类型上了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.5.3.png" alt="image-20220703224129345" tabindex="0" loading="lazy"><figcaption>image-20220703224129345</figcaption></figure><h4 id="_6、分词器" tabindex="-1"><a class="header-anchor" href="#_6、分词器" aria-hidden="true">#</a> 6、分词器</h4><h5 id="_1、内置分词器" tabindex="-1"><a class="header-anchor" href="#_1、内置分词器" aria-hidden="true">#</a> 1、内置分词器</h5><p><strong>Built-in analyzer reference</strong></p><p>Elasticsearch ships with a wide range of built-in analyzers, which can be used in any index without further configuration:</p><ul><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-standard-analyzer.html" target="_blank" rel="noopener noreferrer">Standard Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>standard</code> analyzer divides text into terms on word boundaries, as defined by the Unicode Text Segmentation algorithm. It removes most punctuation, lowercases terms, and supports removing stop words.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-simple-analyzer.html" target="_blank" rel="noopener noreferrer">Simple Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>simple</code> analyzer divides text into terms whenever it encounters a character which is not a letter. It lowercases all terms.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-whitespace-analyzer.html" target="_blank" rel="noopener noreferrer">Whitespace Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>whitespace</code> analyzer divides text into terms whenever it encounters any whitespace character. It does not lowercase terms.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-stop-analyzer.html" target="_blank" rel="noopener noreferrer">Stop Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>stop</code> analyzer is like the <code>simple</code> analyzer, but also supports removal of stop words.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-keyword-analyzer.html" target="_blank" rel="noopener noreferrer">Keyword Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>keyword</code> analyzer is a “noop” analyzer that accepts whatever text it is given and outputs the exact same text as a single term.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-pattern-analyzer.html" target="_blank" rel="noopener noreferrer">Pattern Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>pattern</code> analyzer uses a regular expression to split the text into terms. It supports lower-casing and stop words.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-lang-analyzer.html" target="_blank" rel="noopener noreferrer">Language Analyzers<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>Elasticsearch provides many language-specific analyzers like <code>english</code> or <code>french</code>.</p></li><li><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-fingerprint-analyzer.html" target="_blank" rel="noopener noreferrer">Fingerprint Analyzer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></strong></p><p>The <code>fingerprint</code> analyzer is a specialist analyzer which creates a fingerprint which can be used for duplicate detection.</p></li></ul><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/7.5/analysis-analyzers.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.1.png" alt="GIF 2022-7-3 23-05-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 23-05-38</figcaption></figure><h5 id="_2、测试分词器" tabindex="-1"><a class="header-anchor" href="#_2、测试分词器" aria-hidden="true">#</a> 2、测试分词器</h5><p>参考文档： https://www.elastic.co/guide/en/elasticsearch/reference/7.5/test-analyzer.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.2.1.png" alt="GIF 2022-7-3 23-03-51" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 23-03-51</figcaption></figure><p>英文使用默认分词器可以正常分词</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;whitespace&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>     <span class="token string">&quot;The quick brown fox.&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.2.2.png" alt="image-20220703230840934" tabindex="0" loading="lazy"><figcaption>image-20220703230840934</figcaption></figure><p>中文使用默认分词器进行分词会出现问题，每个字会分成一个词</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>     <span class="token string">&quot;尚硅谷电商项目&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.2.3.png" alt="image-20220703231203124" tabindex="0" loading="lazy"><figcaption>image-20220703231203124</figcaption></figure><h5 id="_3、安装ik分词器" tabindex="-1"><a class="header-anchor" href="#_3、安装ik分词器" aria-hidden="true">#</a> 3、安装ik分词器</h5><h6 id="_1、下载地址" tabindex="-1"><a class="header-anchor" href="#_1、下载地址" aria-hidden="true">#</a> 1、下载地址</h6><p>7.4.2版本的<code>elasticsearch</code>下载地址为： https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.1.1.png" alt="GIF 2022-7-3 23-52-04" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-3 23-52-04</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.1.2.png" alt="GIF 2022-7-4 0-05-10" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-4 0-05-10</figcaption></figure><h6 id="_2、下载插件" tabindex="-1"><a class="header-anchor" href="#_2、下载插件" aria-hidden="true">#</a> 2、下载插件</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>vagrant <span class="token function">ssh</span>
<span class="token function">su</span> root <span class="token comment">#使用root用户，密码默认为vagrant</span>
<span class="token function">docker</span> <span class="token function">ps</span>	<span class="token comment">#查看docker运行的容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> elasticsearch  /bin/bash <span class="token comment">#以交互模式进入容器内部</span>
<span class="token builtin class-name">pwd</span>	<span class="token comment">#查看当前当前路径的完整路径</span>
<span class="token function">ls</span>	<span class="token comment">#查看当前目录的子目录和文件</span>
<span class="token builtin class-name">cd</span> plugins/ <span class="token comment">#进入到plugins目录</span>
<span class="token function">ls</span>	<span class="token comment">#查看当前目录的子目录和文件，可以看到什么都没有</span>
<span class="token function">wget</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip <span class="token comment">#下载插件</span>
<span class="token builtin class-name">exit</span> <span class="token comment">#退出elasticsearch容器</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下载插件提示<code>bash: wget: command not found</code>，这是因为容器内部非常纯净，没有这些命令</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.2.1.png" alt="image-20220704082240023" tabindex="0" loading="lazy"><figcaption>image-20220704082240023</figcaption></figure><p>由于设置了<code>elasticsearch容器</code>和外部<code>linux虚拟机</code>进行了关联，因此可以在<code>linux虚拟机</code>里下载插件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">pwd</span>
<span class="token builtin class-name">cd</span> /mydata/elasticsearch/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> plugins/
<span class="token function">wget</span>
yum <span class="token function">install</span> <span class="token function">wget</span>	<span class="token comment">#安装wget</span>
<span class="token function">ls</span>
<span class="token function">wget</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip
<span class="token function">wget</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip –no-check-certificate  <span class="token comment">#添加参数 --no-check-certificate</span>
systemctl stop firewalld		<span class="token comment">#关闭防火墙</span>
<span class="token function">wget</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip -no-check-certificate	<span class="token comment">#重新下载插件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.2.2.png" alt="image-20220704092450119" tabindex="0" loading="lazy"><figcaption>image-20220704092450119</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ls</span>	<span class="token comment">#elasticsearch-analysis-ik-7.4.2.zip</span>
<span class="token builtin class-name">pwd</span>	<span class="token comment">#/mydata/elasticsearch/plugins</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> elasticsearch  /bin/bash
<span class="token builtin class-name">pwd</span>  <span class="token comment">#/usr/share/elasticsearch</span>
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> plugins/
<span class="token function">ls</span>	<span class="token comment">#elasticsearch-analysis-ik-7.4.2.zip</span>
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.2.3.png" alt="image-20220704094426265" tabindex="0" loading="lazy"><figcaption>image-20220704094426265</figcaption></figure><h6 id="_3、安装插件" tabindex="-1"><a class="header-anchor" href="#_3、安装插件" aria-hidden="true">#</a> 3、安装插件</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ll
<span class="token function">unzip</span> elasticsearch-analysis-ik-7.4.2.zip <span class="token parameter variable">-d</span> ./ik	<span class="token comment">#解压到当前目录的下的ik目录下，没有ik目录会自动创建</span>
ll	<span class="token comment">#有elasticsearch-analysis-ik-7.4.2.zip 和 ik</span>
<span class="token builtin class-name">cd</span> ik	<span class="token comment">#进入ik目录</span>
ll		<span class="token comment">#可以看到以成功解压到ik目录下了</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>	<span class="token comment">#退回到上级目录</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> elasticsearch-analysis-ik-7.4.2.zip <span class="token comment">#删除elasticsearch-analysis-ik-7.4.2.zip压缩包</span>
ll		<span class="token comment"># ik目录的权限为 drwxr-xr-x.</span>
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> ik/ <span class="token comment">#改变uk目录及子目录的权限</span>
ll		<span class="token comment">#此时ik目录的权限为 drwxrwxrwx.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.3.1.png" alt="image-20220704110259788" tabindex="0" loading="lazy"><figcaption>image-20220704110259788</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> elasticsearch  /bin/bash <span class="token comment">#进入bash控制台</span>
<span class="token builtin class-name">pwd</span>
<span class="token builtin class-name">cd</span> plugins/
ll
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> bin/
<span class="token function">ls</span>	<span class="token comment">#查看可执行文件</span>
elasticsearch-plugin	<span class="token comment">#直接打出该可执行文件名，会提示一些信息</span>
elasticsearch-plugin <span class="token parameter variable">-h</span>	<span class="token comment">#加 -h 显示帮助信息</span>
<span class="token comment">#如果这一步报错，删掉 elasticsearch-analysis-ik-7.4.2.zip 压缩包</span>
elasticsearch-plugin list <span class="token comment">#列出已安装的elasticsearch插件，可以看到ik分词器已经安装成功了</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.3.2.png" alt="image-20220704111821204" tabindex="0" loading="lazy"><figcaption>image-20220704111821204</figcaption></figure><h6 id="_4、测试" tabindex="-1"><a class="header-anchor" href="#_4、测试" aria-hidden="true">#</a> 4、测试</h6><p>发送以下数据</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>     <span class="token string">&quot;尚硅谷电商项目&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应了错误信息，<code>failed to find global analyzer [ik_smart]</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;root_cause&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;remote_transport_exception&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;reason&quot;</span><span class="token operator">:</span> <span class="token string">&quot;[104b52df3ff1][127.0.0.1:9300][indices:admin/analyze[s]]&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;illegal_argument_exception&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;reason&quot;</span><span class="token operator">:</span> <span class="token string">&quot;failed to find global analyzer [ik_smart]&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">400</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.4.1.png" alt="image-20220704154257454" tabindex="0" loading="lazy"><figcaption>image-20220704154257454</figcaption></figure><p>查看正在运行的dorcker容器，可以看到<code>elasticsearch</code>并没有停止运行</p><p>重启<code>elasticsearch</code>，再次发送请求看看还报不报错</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.4.2.png" alt="image-20220704154601415" tabindex="0" loading="lazy"><figcaption>image-20220704154601415</figcaption></figure><p>打开<code>kibana</code>可以看到报了以下错误，这个不用管，等一会就能加载出来了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Cannot connect to the Elasticsearch cluster
See the Kibana logs for details and try reloading the page.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.4.3.png" alt="image-20220704154525819" tabindex="0" loading="lazy"><figcaption>image-20220704154525819</figcaption></figure><p>重新发送请求，可以看到已经可以分词了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.3.4.4.png" alt="image-20220704154658284" tabindex="0" loading="lazy"><figcaption>image-20220704154658284</figcaption></figure><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tokens&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;尚&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;硅&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;谷&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;电&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;商&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;项&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;目&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">6</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4、使用xshell连接linux虚拟机" tabindex="-1"><a class="header-anchor" href="#_4、使用xshell连接linux虚拟机" aria-hidden="true">#</a> 4、使用<code>Xshell</code>连接linux虚拟机</h5><h6 id="_1、设置可以使用root用户登录" tabindex="-1"><a class="header-anchor" href="#_1、设置可以使用root用户登录" aria-hidden="true">#</a> 1、设置可以使用root用户登录</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#注意要在管理员方式修改</span>
<span class="token function">vi</span> /etc/ssh/sshd_config <span class="token comment">#修改 PasswordAuthentication no 这一行为 PasswordAuthentication yes</span>
<span class="token comment">#如果是生产环境可以先执行 service sshd reload ，不行再执行以下命令</span>
<span class="token function">service</span> sshd restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.4.1.png" alt="GIF 2022-7-4 10-16-49" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-4 10-16-49</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.4.2.png" alt="image-20220704112850026" tabindex="0" loading="lazy"><figcaption>image-20220704112850026</figcaption></figure><h6 id="_2、使用xshell连接" tabindex="-1"><a class="header-anchor" href="#_2、使用xshell连接" aria-hidden="true">#</a> 2、使用<code>Xshell</code>连接</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.4.3.png" alt="GIF 2022-7-4 11-37-44" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-4 11-37-44</figcaption></figure><h6 id="_3、如果ping不通" tabindex="-1"><a class="header-anchor" href="#_3、如果ping不通" aria-hidden="true">#</a> 3、如果<code>ping</code>不通</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ping</span> baidu.com	<span class="token comment">#ping百度</span>
<span class="token builtin class-name">cd</span> /etc/sysconfig/network-scripts/
<span class="token function">ls</span>
<span class="token function">ip</span> addr	<span class="token comment">#查看ip配置</span>
<span class="token function">vi</span> ifcfg-eth1 <span class="token comment">#编辑eth1网卡配置，内容在后面</span>
<span class="token function">service</span> network restart <span class="token comment">#重启服务</span>
<span class="token function">ping</span> baidu.com <span class="token comment">#再次ping百度</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.4.4.png" alt="image-20220704164200697" tabindex="0" loading="lazy"><figcaption>image-20220704164200697</figcaption></figure><p>修改<code>ifcfg-eth1</code>为以下内容</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
NM_CONTROLLED=yes
BOOTPROTO=none
ONBOOT=yes
IPADDR=192.168.56.10
NETMASK=255.255.255.0
GATEWAY=192.168.56.1
DNS1=114.114.114.114
DNS2=8.8.8.8
DEVICE=eth1
PEERDNS=no
#VAGRANT-END
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.4.5.png" alt="image-20220704163508579" tabindex="0" loading="lazy"><figcaption>image-20220704163508579</figcaption></figure><h6 id="_4、修改yum源" tabindex="-1"><a class="header-anchor" href="#_4、修改yum源" aria-hidden="true">#</a> 4、修改yum源</h6><p>如果不能正常使用yum，可以修改yum源 如果可以正常使用就不用修改</p><p><strong>老师提供的方法</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#备份原 yum 源，如果失败了也不要紧，直接使用新 yum 源</span>
<span class="token function">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
<span class="token comment">#使用新 yum 源</span>
<span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo
yum makecach <span class="token comment">#生成缓存</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>我的方法</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果找不到<code>yum-config-manager</code>可以先安装<code>yum-utils</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>yum install -y yum-utils
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_5、使用ik分词器" tabindex="-1"><a class="header-anchor" href="#_5、使用ik分词器" aria-hidden="true">#</a> 5、使用<code>ik分词器</code></h5><h6 id="_1、ik-smart" tabindex="-1"><a class="header-anchor" href="#_1、ik-smart" aria-hidden="true">#</a> 1、<code>ik_smart</code></h6><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST _analyze
{
  &quot;analyzer&quot;: &quot;ik_smart&quot;,
  &quot;text&quot;:     &quot;我是中国人&quot;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应内容为</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tokens&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;我&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_CHAR&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;是&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_CHAR&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;中国人&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.5.1.png" alt="image-20220704155931269" tabindex="0" loading="lazy"><figcaption>image-20220704155931269</figcaption></figure><h6 id="_2、ik-max-word" tabindex="-1"><a class="header-anchor" href="#_2、ik-max-word" aria-hidden="true">#</a> 2、<code>ik_max_word</code></h6><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>POST _analyze
<span class="token punctuation">{</span>
  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>     <span class="token string">&quot;我是中国人&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应内容为</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tokens&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;我&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_CHAR&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;是&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_CHAR&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;中国人&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;中国&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;token&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;国人&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start_offset&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end_offset&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;CN_WORD&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;position&quot;</span> <span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.6.5.2.png" alt="image-20220704160053774" tabindex="0" loading="lazy"><figcaption>image-20220704160053774</figcaption></figure><h5 id="_7-、自定义分词" tabindex="-1"><a class="header-anchor" href="#_7-、自定义分词" aria-hidden="true">#</a> 7 、自定义分词</h5><h6 id="_1、修改docker启动参数" tabindex="-1"><a class="header-anchor" href="#_1、修改docker启动参数" aria-hidden="true">#</a> 1、修改docker启动参数</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token function">ps</span>	<span class="token comment">#查看elasticsearch的id  也可以使用 docker ps -a 命令</span>
systemctl stop docker.socket <span class="token comment">#停止这个服务，否则docker是没办法停止的</span>
systemctl stop <span class="token function">docker</span>	<span class="token comment">#停止docker</span>
<span class="token function">docker</span>  <span class="token function">ps</span>	<span class="token comment">#再次查看是否有启动的docker容器</span>
<span class="token builtin class-name">cd</span> /var/lib/docker/containers/ <span class="token comment">#进入到该目录</span>
ll
<span class="token builtin class-name">cd</span> 104b52df3ff1fe34c3373deab5c2b4248accd8113ab302092124b8e33abd1936/ <span class="token comment">#进入到elasticsearch的配置目录</span>
ll
<span class="token function">vi</span> config.v2.json	<span class="token comment">#修改该文件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.1.1.png" alt="image-20220704180359012" tabindex="0" loading="lazy"><figcaption>image-20220704180359012</figcaption></figure><p>在<code>命令模式</code>下输入<code>/Env</code>,即可找到<code>Env</code>的配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.1.2.png" alt="image-20220704180417552" tabindex="0" loading="lazy"><figcaption>image-20220704180417552</figcaption></figure><p>将</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;Env&quot;:[&quot;discovery.type=single-node&quot;,&quot;ES_JAVA_OPTS=-Xms64m -Xmx128m&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>中的第二个<code>-Xmx128m</code>修改为<code>-Xmx512m</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;Env&quot;:[&quot;discovery.type=single-node&quot;,&quot;ES_JAVA_OPTS=-Xms64m -Xmx512m&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.1.3.png" alt="image-20220704180434186" tabindex="0" loading="lazy"><figcaption>image-20220704180434186</figcaption></figure><p>启动docker</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl start <span class="token function">docker</span>
<span class="token function">docker</span> <span class="token function">ps</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.1.4.png" alt="image-20220704180514500" tabindex="0" loading="lazy"><figcaption>image-20220704180514500</figcaption></figure><p><strong>方法二</strong>：删掉容器，重新运行(设置目录挂载后，linux虚拟机保存的有elasticsearch的数据)</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> stop elasticsearch
<span class="token function">docker</span> <span class="token function">rm</span> elasticsearch

<span class="token function">docker</span> run <span class="token parameter variable">--name</span> elasticsearch <span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token string">&quot;discovery.type=single-node&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xms64m -Xmx512m&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> elasticsearch:7.4.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_2、安装nginx" tabindex="-1"><a class="header-anchor" href="#_2、安装nginx" aria-hidden="true">#</a> 2、安装nginx</h6><ol><li>随便启动一个 nginx 实例，只是为了复制出配置</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /mydata/
<span class="token builtin class-name">pwd</span>
<span class="token function">mkdir</span> nginx
<span class="token function">ls</span>
<span class="token function">docker</span> images
<span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx <span class="token parameter variable">-d</span> nginx:1.10
<span class="token function">docker</span> <span class="token function">ps</span>
<span class="token function">docker</span> container <span class="token function">cp</span> nginx:/etc/nginx <span class="token builtin class-name">.</span>
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> nginx/
<span class="token function">ls</span>
<span class="token function">docker</span> stop nginx
<span class="token function">docker</span> <span class="token function">rm</span> nginx
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
<span class="token function">ls</span>
<span class="token function">mv</span> nginx conf
<span class="token function">ls</span>
<span class="token function">mkdir</span> nginx
<span class="token function">mv</span> conf nginx/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> nginx/
<span class="token function">ls</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.2.1.png" alt="image-20220704214746137" tabindex="0" loading="lazy"><figcaption>image-20220704214746137</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 <span class="token parameter variable">--name</span> nginx <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/nginx/html:/usr/share/nginx/html <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/nginx/logs:/var/log/nginx <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /mydata/nginx/conf:/etc/nginx <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> nginx:1.10
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.2.2.png" alt="image-20220704215810549" tabindex="0" loading="lazy"><figcaption>image-20220704215810549</figcaption></figure><p>直接访问成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.2.3.png" alt="image-20220704215856601" tabindex="0" loading="lazy"><figcaption>image-20220704215856601</figcaption></figure><p>可以新建个<code>index.html</code>页面，<code>nginx</code>会默认展示</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> html/
<span class="token function">ls</span>
<span class="token function">vi</span> index.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.2.4.png" alt="image-20220704220228317" tabindex="0" loading="lazy"><figcaption>image-20220704220228317</figcaption></figure><p><code>index.html</code>内容如下</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Gulimall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.2.5.png" alt="image-20220704220241956" tabindex="0" loading="lazy"><figcaption>image-20220704220241956</figcaption></figure><p>刷新网页，可以看到已经访问成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.2.6.png" alt="image-20220704220348395" tabindex="0" loading="lazy"><figcaption>image-20220704220348395</figcaption></figure><h6 id="_3、创建文件" tabindex="-1"><a class="header-anchor" href="#_3、创建文件" aria-hidden="true">#</a> 3、创建文件</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> es
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> es
<span class="token function">ls</span>
<span class="token function">vi</span> fenci.txt	<span class="token comment">#修改的内容在下面</span>
<span class="token function">ls</span>
<span class="token builtin class-name">pwd</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.3.1.png" alt="image-20220704221232608" tabindex="0" loading="lazy"><figcaption>image-20220704221232608</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>尚硅谷
乔碧罗
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.3.2.png" alt="image-20220704220825269" tabindex="0" loading="lazy"><figcaption>image-20220704220825269</figcaption></figure><p>通过浏览器已经访问到了，就是会乱码</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://192.168.56.10/es/fenci.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.3.3.png" alt="image-20220704221010673" tabindex="0" loading="lazy"><figcaption>image-20220704221010673</figcaption></figure><h6 id="_4、修改分词器设置" tabindex="-1"><a class="header-anchor" href="#_4、修改分词器设置" aria-hidden="true">#</a> 4、修改分词器设置</h6><ol><li>修改配置</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /mydata/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> elasticsearch/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> plugins/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> ik/
<span class="token builtin class-name">cd</span> config/
<span class="token function">ls</span>
<span class="token function">vi</span> IKAnalyzer.cfg.xml	<span class="token comment">#修改的内容在下面</span>
<span class="token function">docker</span> <span class="token function">ps</span>
<span class="token function">docker</span> restart elasticsearch
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.4.1.png" alt="image-20220704222141745" tabindex="0" loading="lazy"><figcaption>image-20220704222141745</figcaption></figure><ol start="2"><li>修改以下配置</li></ol><p>将<code>IKAnalyzer.cfg.xml</code>文件的以下配置</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
         <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_stopwords<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span>
        <span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span>
        <span class="token comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span>
        <span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改为：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
         <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_stopwords<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remote_ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http://192.168.56.10/es/fenci.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span>
        <span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.4.2.png" alt="image-20220704223849920" tabindex="0" loading="lazy"><figcaption>image-20220704223849920</figcaption></figure><ol start="3"><li>设置<code>nginx</code>开机自启</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> update nginx <span class="token parameter variable">--restart</span><span class="token operator">=</span>always
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.4.3.png" alt="image-20220704222845488" tabindex="0" loading="lazy"><figcaption>image-20220704222845488</figcaption></figure><p>4、发送请求测试</p><p>在<code>kibana</code>里发送请求</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>POST _analyze
{
  &quot;analyzer&quot;: &quot;ik_max_word&quot;,
  &quot;text&quot;:     &quot;尚硅谷电商项目&quot;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应了以下内容，可以看到<code>尚硅谷</code>已经变为一个词了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{
  &quot;tokens&quot; : [
    {
      &quot;token&quot; : &quot;尚硅谷&quot;,
      &quot;start_offset&quot; : 0,
      &quot;end_offset&quot; : 3,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 0
    },
    {
      &quot;token&quot; : &quot;硅谷&quot;,
      &quot;start_offset&quot; : 1,
      &quot;end_offset&quot; : 3,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 1
    },
    {
      &quot;token&quot; : &quot;电&quot;,
      &quot;start_offset&quot; : 3,
      &quot;end_offset&quot; : 4,
      &quot;type&quot; : &quot;CN_CHAR&quot;,
      &quot;position&quot; : 2
    },
    {
      &quot;token&quot; : &quot;商&quot;,
      &quot;start_offset&quot; : 4,
      &quot;end_offset&quot; : 5,
      &quot;type&quot; : &quot;CN_CHAR&quot;,
      &quot;position&quot; : 3
    },
    {
      &quot;token&quot; : &quot;项目&quot;,
      &quot;start_offset&quot; : 5,
      &quot;end_offset&quot; : 7,
      &quot;type&quot; : &quot;CN_WORD&quot;,
      &quot;position&quot; : 4
    }
  ]
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.5.7.4.4.png" alt="image-20220704223544598" tabindex="0" loading="lazy"><figcaption>image-20220704223544598</figcaption></figure><h3 id="_5-1-6、elasticsearch整合springboot" tabindex="-1"><a class="header-anchor" href="#_5-1-6、elasticsearch整合springboot" aria-hidden="true">#</a> 5.1.6、ElasticSearch整合SpringBoot</h3><h4 id="_1、创建模块" tabindex="-1"><a class="header-anchor" href="#_1、创建模块" aria-hidden="true">#</a> 1、创建模块</h4><h5 id="_1、新建模块" tabindex="-1"><a class="header-anchor" href="#_1、新建模块" aria-hidden="true">#</a> 1、新建模块</h5><p>使用<code>Spring Initializr</code>新建<code>gulimall-search</code>模块</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>com.atguigu.gulimall
gulimall-search
ElasticSearch检索服务
com.atguigu.gulimall.search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.1.1.1.png" alt="image-20220704225014605" tabindex="0" loading="lazy"><figcaption>image-20220704225014605</figcaption></figure><p>勾选<code>Web</code>里的<code>Spring Web</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.1.1.2.png" alt="image-20220704225155092" tabindex="0" loading="lazy"><figcaption>image-20220704225155092</figcaption></figure><p>点击<code>Finish</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.1.1.3.png" alt="image-20220704225216664" tabindex="0" loading="lazy"><figcaption>image-20220704225216664</figcaption></figure><h5 id="_2、修改pom文件" tabindex="-1"><a class="header-anchor" href="#_2、修改pom文件" aria-hidden="true">#</a> 2、修改<code>pom</code>文件</h5><p>删除刚刚新建的<code>gulimall-search</code>模块，只保留以下内容</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.gulimall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>gulimall-search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>gulimall-search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>ElasticSearch检索服务<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>复制别的模块的<code>pom</code>文件，粘贴到此模块，并用刚刚复制到本模块的部分替换掉复制的别的<code>pom</code>文件的以上部分</p><p><a href="code/5.1.6.1.2.pom.xml">点击查看完整<code>pom</code>文件</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.1.4.png" alt="image-20220704225703934" tabindex="0" loading="lazy"><figcaption>image-20220704225703934</figcaption></figure><h5 id="_3、修改gulimallsearchapplicationtests" tabindex="-1"><a class="header-anchor" href="#_3、修改gulimallsearchapplicationtests" aria-hidden="true">#</a> 3、修改<code>GulimallSearchApplicationTests</code></h5><p>复制别的模块的测试类，替换掉本模块的<code>gulimall-search</code>的测试类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSearchApplicationTests</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.1.5.png" alt="image-20220704225713936" tabindex="0" loading="lazy"><figcaption>image-20220704225713936</figcaption></figure><h4 id="_2、添加依赖" tabindex="-1"><a class="header-anchor" href="#_2、添加依赖" aria-hidden="true">#</a> 2、添加依赖</h4><h5 id="_1、添加elasticsearch依赖" tabindex="-1"><a class="header-anchor" href="#_1、添加elasticsearch依赖" aria-hidden="true">#</a> 1、添加<code>elasticsearch</code>依赖</h5><p>方法一：可以添加以下依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.2.1.1.png" alt="image-20220704231617067" tabindex="0" loading="lazy"><figcaption>image-20220704231617067</figcaption></figure><p>方法二：也可以添加以下依赖(老师的做法)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>elasticsearch<span class="token operator">-</span>rest<span class="token operator">-</span>high<span class="token operator">-</span>level<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.4</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加这个依赖时，<code>elasticsearch</code>的版本不对，这是因为父工程(<code>spring-boot-starter-parent</code>工程)指定了版本</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.2.1.2.png" alt="image-20220704232041878" tabindex="0" loading="lazy"><figcaption>image-20220704232041878</figcaption></figure><p>可以在<code>properties</code>标签内添加如下配置，可以看到版本已经为<code>7.4.2</code>了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>elasticsearch<span class="token punctuation">.</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.4</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>elasticsearch<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.2.1.3.png" alt="image-20220704232238992" tabindex="0" loading="lazy"><figcaption>image-20220704232238992</figcaption></figure><h5 id="_2、添加gulimall-common依赖" tabindex="-1"><a class="header-anchor" href="#_2、添加gulimall-common依赖" aria-hidden="true">#</a> 2、添加<code>gulimall-common</code>依赖</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
   <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>gulimall<span class="token operator">-</span>common<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
   <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.2.2.png" alt="image-20220704232349073" tabindex="0" loading="lazy"><figcaption>image-20220704232349073</figcaption></figure><h4 id="_3、整合nacos" tabindex="-1"><a class="header-anchor" href="#_3、整合nacos" aria-hidden="true">#</a> 3、整合<code>nacos</code></h4><p>在<code>src/main/resources/application.properties</code>文件内添加如下配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>

<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">gulimall-search</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.3.1.png" alt="image-20220705000055994" tabindex="0" loading="lazy"><figcaption>image-20220705000055994</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplication</code>启动类上添加如下注解</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@EnableDiscoveryClient
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.3.2.png" alt="image-20220705094129895" tabindex="0" loading="lazy"><figcaption>image-20220705094129895</figcaption></figure><h4 id="_4、添加配置类" tabindex="-1"><a class="header-anchor" href="#_4、添加配置类" aria-hidden="true">#</a> 4、添加配置类</h4><p>参考文档：[Java REST Client <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/index.html" target="_blank" rel="noopener noreferrer">7.17] | Elastic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>在<code>com.atguigu.gulimall.search</code>包下新建<code>config</code>文件夹，在<code>config</code>文件夹下新建<code>GulimallElasticSearchConfig</code>配置类</p><p>配置类写以下代码：</p><p>参考文档：[Initialization | Java REST Client <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-initialization.html" target="_blank" rel="noopener noreferrer">7.17] | Elastic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHost</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/5
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallElasticSearchConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">esRestClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>
                <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.56.10&quot;</span><span class="token punctuation">,</span><span class="token number">9200</span><span class="token punctuation">,</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.4.1.png" alt="image-20220705094725899" tabindex="0" loading="lazy"><figcaption>image-20220705094725899</figcaption></figure><p>查看官方文档：[Initialization | Java REST Client <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-initialization.html" target="_blank" rel="noopener noreferrer">7.17] | Elastic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.4.2.gif" alt="GIF 2022-7-5 11-03-00" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-5 11-03-00</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.4.3.gif" alt="GIF 2022-7-5 11-04-49" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-5 11-04-49</figcaption></figure><h4 id="_5、测试resthighlevelclient" tabindex="-1"><a class="header-anchor" href="#_5、测试resthighlevelclient" aria-hidden="true">#</a> 5、测试<code>RestHighLevelClient</code></h4><p>在<code>com.atguigu.gulimall.search.GulimallSearchApplicationTests</code>里对<code>RestHighLevelClient</code>进行测试</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSearchApplicationTests</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Test</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>报了以下错误</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [com.zaxxer.hikari.HikariDataSource]: Factory method &#39;dataSource&#39; threw exception; nested exception is org.springframework.boot.autoconfigure.jdbc

Caused by: org.springframework.boot.autoconfigure.jdbc.DataSourceProperties$DataSourceBeanCreationException: Failed to determine a suitable driver class at org.springframework.boot.autoconfigure.jdbc.DataSourceProperties.determineDriverClassName(DataSourceProperties.java:233)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.5.1.png" alt="image-20220705095233329" tabindex="0" loading="lazy"><figcaption>image-20220705095233329</figcaption></figure><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplication</code>启动类里排除数据源</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.5.2.png" alt="image-20220705095714653" tabindex="0" loading="lazy"><figcaption>image-20220705095714653</figcaption></figure><p>再次测试，就成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.5.3.png" alt="image-20220705095918284" tabindex="0" loading="lazy"><figcaption>image-20220705095918284</figcaption></figure><h4 id="_6、测试requestoptions" tabindex="-1"><a class="header-anchor" href="#_6、测试requestoptions" aria-hidden="true">#</a> 6、测试<code>RequestOptions</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RequestOptions</span> <span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token class-name">RequestOptions<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//builder.addHeader(&quot;Authorization&quot;, &quot;Bearer&quot;, TOCKEN);</span>
    <span class="token comment">//builder.setHttpAsyncResponseConsumerFactory(</span>
    <span class="token comment">//        new HttpAsyncResponseConsumerFactory</span>
    <span class="token comment">//                .HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024)</span>
    <span class="token comment">//);</span>
    <span class="token constant">COMMON_OPTIONS</span> <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.6.1.png" alt="image-20220705103750458" tabindex="0" loading="lazy"><figcaption>image-20220705103750458</figcaption></figure><p>查看官方文档：[Performing requests | Elasticsearch Java API Client <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/java-rest-low-usage-requests.html#java-rest-low-usage-request-options" target="_blank" rel="noopener noreferrer">7.17] | Elastic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.6.2.gif" alt="GIF 2022-7-5 11-15-07" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-5 11-15-07</figcaption></figure><h4 id="_7、存储或更新数据到es" tabindex="-1"><a class="header-anchor" href="#_7、存储或更新数据到es" aria-hidden="true">#</a> 7、存储或更新数据到es</h4><p>先使用<code>kibana</code>发送请求查询<code>users</code>，可以看到没有查到数据</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET users/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.7.1.png" alt="image-20220705115436492" tabindex="0" loading="lazy"><figcaption>image-20220705115436492</figcaption></figure><p>添加测试方法，然后运行测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 存储或更新数据到es
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">indexData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//数据的id</span>
   indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//indexRequest.source(&quot;userName&quot;,&quot;zhangsan&quot;,&quot;age&quot;,18,&quot;gender&quot;,&quot;男&quot;);</span>
   <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//要保存的内容</span>
   indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//执行操作</span>
   <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//提取有用的响应信息</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>indexResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> gender<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.7.2.png" alt="image-20220705115450695" tabindex="0" loading="lazy"><figcaption>image-20220705115450695</figcaption></figure><p>再次发送请求，可以看到已经查到数据了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET users/_search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.7.3.png" alt="image-20220705115539967" tabindex="0" loading="lazy"><figcaption>image-20220705115539967</figcaption></figure><p>查看官方文档：[Index API | Java REST Client <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html" target="_blank" rel="noopener noreferrer">7.17] | Elastic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.7.4.gif" alt="GIF 2022-7-5 11-27-50" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-5 11-27-50</figcaption></figure><p>完整<code>GulimallSearchApplicationTests</code>类代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">GulimallElasticSearchConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xcontent<span class="token punctuation">.</span></span><span class="token class-name">XContentType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallSearchApplicationTests</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">indexData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//数据的id</span>
      indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//indexRequest.source(&quot;userName&quot;,&quot;zhangsan&quot;,&quot;age&quot;,18,&quot;gender&quot;,&quot;男&quot;);</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//要保存的内容</span>
      indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//执行操作</span>
      <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//提取有用的响应信息</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>indexResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Data</span>
   <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> gender<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


   <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8、从es中查询数据" tabindex="-1"><a class="header-anchor" href="#_8、从es中查询数据" aria-hidden="true">#</a> 8、从es中查询数据</h4><p>查看官方文档：https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.0.png" alt="GIF 2022-7-5 15-35-51" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-5 15-35-51</figcaption></figure><h5 id="_1、想要完成的请求" tabindex="-1"><a class="header-anchor" href="#_1、想要完成的请求" aria-hidden="true">#</a> 1、想要完成的请求</h5><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;ageAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ageAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;balanceAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2、添加searchdata方法" tabindex="-1"><a class="header-anchor" href="#_2、添加searchdata方法" aria-hidden="true">#</a> 2、添加<code>searchData</code>方法</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplicationTests</code>测试类中添加以下方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">searchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token comment">//1、创建检索请求</span>
   <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//指定索引</span>
   searchRequest<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//指定DSL，检索条件</span>
   <span class="token class-name">SearchSourceBuilder</span> sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//sourceBuilder.query();</span>
   <span class="token comment">//sourceBuilder.from();</span>
   <span class="token comment">//sourceBuilder.size();</span>
   <span class="token comment">//sourceBuilder.aggregation()</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;mill&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">TermsAggregationBuilder</span> ageAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>ageAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AvgAggregationBuilder</span> ageAvg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;ageAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>ageAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AvgAggregationBuilder</span> balanceAvg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>balanceAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>

   sourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

   searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//2、执行检索</span>
   <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span><span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//3、分析结果</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.1.png" alt="image-20220705163443871" tabindex="0" loading="lazy"><figcaption>image-20220705163443871</figcaption></figure><h5 id="_3、对比请求" tabindex="-1"><a class="header-anchor" href="#_3、对比请求" aria-hidden="true">#</a> 3、对比请求</h5><h6 id="_1、想要完成的请求-1" tabindex="-1"><a class="header-anchor" href="#_1、想要完成的请求-1" aria-hidden="true">#</a> 1、想要完成的请求</h6><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code># 搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情。
GET bank/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;ageAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ageAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;balanceAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.2.png" alt="image-20220705163319010" tabindex="0" loading="lazy"><figcaption>image-20220705163319010</figcaption></figure><h6 id="_2、实际发送的请求" tabindex="-1"><a class="header-anchor" href="#_2、实际发送的请求" aria-hidden="true">#</a> 2、实际发送的请求</h6><p>可以看到，除了 添加了一些 <strong>默认查询条件</strong> 和 <strong>顺序</strong> 不同外其他想要的查询条件都正确</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET bank/_search
<span class="token punctuation">{</span>
	<span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mill&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;operator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;prefix_length&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;max_expansions&quot;</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
				<span class="token property">&quot;fuzzy_transpositions&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
				<span class="token property">&quot;lenient&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
				<span class="token property">&quot;zero_terms_query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NONE&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;auto_generate_synonyms_phrase_query&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
				<span class="token property">&quot;boost&quot;</span><span class="token operator">:</span> <span class="token number">1.0</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;ageAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
				<span class="token property">&quot;min_doc_count&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
				<span class="token property">&quot;shard_min_doc_count&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;show_term_doc_count_error&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
				<span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
					<span class="token property">&quot;_count&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
					<span class="token property">&quot;_key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;ageAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;balanceAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;avg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balance&quot;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.3.png" alt="image-20220705163214803" tabindex="0" loading="lazy"><figcaption>image-20220705163214803</figcaption></figure><h5 id="_4、响应的数据" tabindex="-1"><a class="header-anchor" href="#_4、响应的数据" aria-hidden="true">#</a> 4、响应的数据</h5><p>可以看到 <strong>想要的响应</strong> 和 <strong>实际接收的响应</strong> 一样</p><h6 id="_1、想要的响应" tabindex="-1"><a class="header-anchor" href="#_1、想要的响应" aria-hidden="true">#</a> 1、想要的响应</h6><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timed_out&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skipped&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">&quot;relation&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggregations&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;ageAgg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;doc_count_error_upper_bound&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sum_other_doc_count&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;buckets&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;key&quot;</span> <span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
          <span class="token property">&quot;doc_count&quot;</span> <span class="token operator">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;key&quot;</span> <span class="token operator">:</span> <span class="token number">28</span><span class="token punctuation">,</span>
          <span class="token property">&quot;doc_count&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;key&quot;</span> <span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
          <span class="token property">&quot;doc_count&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ageAvg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">34.0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;balanceAvg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">25208.0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_2、实际接收的响应" tabindex="-1"><a class="header-anchor" href="#_2、实际接收的响应" aria-hidden="true">#</a> 2、实际接收的响应</h6><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;took&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
	<span class="token property">&quot;timed_out&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	<span class="token property">&quot;_shards&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token property">&quot;successful&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token property">&quot;skipped&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token property">&quot;failed&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;total&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
			<span class="token property">&quot;relation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;max_score&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
		<span class="token property">&quot;hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;aggregations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;lterms#ageAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;doc_count_error_upper_bound&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token property">&quot;sum_other_doc_count&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token property">&quot;buckets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
				<span class="token property">&quot;doc_count&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token number">28</span><span class="token punctuation">,</span>
				<span class="token property">&quot;doc_count&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
				<span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
				<span class="token property">&quot;doc_count&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;avg#ageAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">34.0</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token property">&quot;avg#balanceAvg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">25208.0</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5、获取响应的实体类信息" tabindex="-1"><a class="header-anchor" href="#_5、获取响应的实体类信息" aria-hidden="true">#</a> 5、获取响应的实体类信息</h5><h6 id="_1、修改代码" tabindex="-1"><a class="header-anchor" href="#_1、修改代码" aria-hidden="true">#</a> 1、修改代码</h6><p>修改<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplicationTests</code>测试类中<code>searchData</code>方法</p><p>将<code>sourceBuilder.size(0);</code>注释掉，并添加获取响应信息的代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">searchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token comment">//1、创建检索请求</span>
   <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//指定索引</span>
   searchRequest<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">&quot;bank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//指定DSL，检索条件</span>
   <span class="token class-name">SearchSourceBuilder</span> sourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//sourceBuilder.query();</span>
   <span class="token comment">//sourceBuilder.from();</span>
   <span class="token comment">//sourceBuilder.size();</span>
   <span class="token comment">//sourceBuilder.aggregation()</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;mill&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">TermsAggregationBuilder</span> ageAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>ageAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AvgAggregationBuilder</span> ageAvg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;ageAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>ageAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AvgAggregationBuilder</span> balanceAvg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;balance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   sourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>balanceAvg<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//sourceBuilder.size(0);</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

   searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>sourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//2、执行检索</span>
   <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span><span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//3、分析结果</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">/*
    {&quot;_index&quot; : &quot;bank&quot;,
       &quot;_type&quot; : &quot;account&quot;,
       &quot;_id&quot; : &quot;472&quot;,
       &quot;_score&quot; : 5.4032025,
       &quot;_source&quot; : {}}
    */</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> string <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;account:&quot;</span><span class="token operator">+</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ToString</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Account</span><span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token keyword">int</span> account_number<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token keyword">int</span> balance<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> firstname<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> lastname<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> gender<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> employer<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">String</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.5.1.png" alt="image-20220705173535957" tabindex="0" loading="lazy"><figcaption>image-20220705173535957</figcaption></figure><h6 id="_2、测试" tabindex="-1"><a class="header-anchor" href="#_2、测试" aria-hidden="true">#</a> 2、测试</h6><p>可以看到已经封装到<code>Account</code>类里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.5.2.png" alt="image-20220705174229410" tabindex="0" loading="lazy"><figcaption>image-20220705174229410</figcaption></figure><h5 id="_6、获取响应的分析数据" tabindex="-1"><a class="header-anchor" href="#_6、获取响应的分析数据" aria-hidden="true">#</a> 6、获取响应的分析数据</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplicationTests</code>测试类中<code>searchData</code>方法里添加如下代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//3.2、获取这次检索的分析信息</span>
<span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Terms</span> ageAgg1 <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ageAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> ageAgg1<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">String</span> keyAsString <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;年龄：&quot;</span><span class="token operator">+</span>keyAsString<span class="token operator">+</span><span class="token string">&quot;==&gt;&quot;</span><span class="token operator">+</span>bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Avg</span> balanceAvg1 <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;balanceAvg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;平均薪资：&quot;</span><span class="token operator">+</span>balanceAvg1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进行测试，可以发现已经打印出数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.1.6.8.6.png" alt="image-20220705175850431" tabindex="0" loading="lazy"><figcaption>image-20220705175850431</figcaption></figure><h5 id="_7、完整代码" tabindex="-1"><a class="header-anchor" href="#_7、完整代码" aria-hidden="true">#</a> 7、完整代码</h5><p><code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.GulimallSearchApplicationTests</code>测试类的完整代码</p><p><a href="code/5.1.6.8.7.java">点击查看<code>GulimallSearchApplicationTests</code>类完整代码</a></p><h2 id="_5-2、商城业务-商品上架" tabindex="-1"><a class="header-anchor" href="#_5-2、商城业务-商品上架" aria-hidden="true">#</a> 5.2、商城业务-商品上架</h2><h3 id="_5-2-1、sku在es中存储模型分析" tabindex="-1"><a class="header-anchor" href="#_5-2-1、sku在es中存储模型分析" aria-hidden="true">#</a> 5.2.1、sku在es中存储模型分析</h3><p><code>&quot;index&quot;: false,</code> 不可以被检索，但可以查询(可以通过<code>skuTitle</code>检索查出<code>skuImg</code>，但不可以通过<code>skuImg</code>检索)</p><p><code>&quot;doc_values&quot;: false</code> 不可以做聚合、排序、脚本等操作，这样会省一些内存</p><p><code> &quot;type&quot;: &quot;nested&quot;,</code> 该字段是集合，防止扁平化处理</p><p><span style="color:red;"><s>这里的<code>skuPrice</code>的<code>type</code>不要设置为<code>double</code>，在<code>SkuEsModel</code>类里的<code>skuPrice</code>设置的类型为<code>BigDecimal</code>，<code>Elasticsearch</code>不支持<code>java</code>里的<code>BigDecimal</code>转换为<code>Elasticsearch</code>里的<code>double</code></s>(在<code>Elasticsearch</code>里，<s>设置的<code>skuPrice</code>的属性类型为<code>keyword</code>也不行</s>，设置的<code>skuPrice</code>的属性类型为<code>keyword</code>可以，我代码里没有设置<code>skuImg</code>和<code>skuPrice</code>所以不行)</span></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT product
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.1.png" alt="image-20220705230422564" tabindex="0" loading="lazy"><figcaption>image-20220705230422564</figcaption></figure><h3 id="_5-2-2、扁平化处理" tabindex="-1"><a class="header-anchor" href="#_5-2-2、扁平化处理" aria-hidden="true">#</a> 5.2.2、扁平化处理</h3><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.0.png" alt="image-20220721204015448" style="zoom:50%;"><p>查看官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/8.3/nested.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.0.gif" alt="5.2.1.1.2.0" tabindex="0" loading="lazy"><figcaption>5.2.1.1.2.0</figcaption></figure><h4 id="_1、不加入nested" tabindex="-1"><a class="header-anchor" href="#_1、不加入nested" aria-hidden="true">#</a> 1、不加入<code>nested</code></h4><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT my_index2/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> 
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在索引index中，存入user的数据，最终 es 会将上述数据，扁平化处理，实际存储如下这样子：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span>        <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user.first&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;john&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user.last&quot;</span> <span class="token operator">:</span>  <span class="token punctuation">[</span> <span class="token string">&quot;smith&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;white&quot;</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>很明显，数据存储成这样子，丢失了first 和 last 之间关系。从这样的存储中，我们无法确定，first 为 “alice” ，对应的 last 是 “smith” 还是 “white”。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.1.1.png" alt="image-20220705224912521" tabindex="0" loading="lazy"><figcaption>image-20220705224912521</figcaption></figure><p>执行如下查询：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET my_index2/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询到的结果：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timed_out&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skipped&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;relation&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token number">0.5753642</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">0.5753642</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Smith&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;White&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询到一条数据，而这样的数据并不是我们想要的。因为通过 <code>&quot;first&quot; 为 &quot;Alice&quot;</code> 和 <code>&quot;last&quot; 为 &quot;Smith&quot;</code>，不应该查询到数据。之所以查询到数据，是因为数组中存储的对象被扁平化处理了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.1.2.png" alt="image-20220705225031662" tabindex="0" loading="lazy"><figcaption>image-20220705225031662</figcaption></figure><p>获取映射信息</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET my_index2/_mapping
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;my_index2&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;ignore_above&quot;</span> <span class="token operator">:</span> <span class="token number">256</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;ignore_above&quot;</span> <span class="token operator">:</span> <span class="token number">256</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;keyword&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;ignore_above&quot;</span> <span class="token operator">:</span> <span class="token number">256</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.1.3.png" alt="image-20220705225410269" tabindex="0" loading="lazy"><figcaption>image-20220705225410269</figcaption></figure><h4 id="_2、加入nested" tabindex="-1"><a class="header-anchor" href="#_2、加入nested" aria-hidden="true">#</a> 2、加入<code>nested</code></h4><p>如果数组里存储的是对象，那么数组的类型应该是 nested，这样，再将对象数据存入数组中时，对象便不会被扁平化处理。</p><p>修改索引的mapping信息，将user数组的类型定义为 nested 并存入数据，重新执行检索。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT my_index3
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT my_index3/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> 
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.2.1.png" alt="image-20220705225805398" tabindex="0" loading="lazy"><figcaption>image-20220705225805398</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.2.2.png" alt="image-20220705225821166" tabindex="0" loading="lazy"><figcaption>image-20220705225821166</figcaption></figure><p>执行同样查询：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET my_index3/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>获取到的结果为空：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;took&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timed_out&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;_shards&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;successful&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skipped&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;failed&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;relation&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样的结果才是我们想要的，这样防止了 frist 和 last 之间关系的丢失。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.2.2.3.png" alt="image-20220705225914304" tabindex="0" loading="lazy"><figcaption>image-20220705225914304</figcaption></figure><h4 id="_3、neated增删查改" tabindex="-1"><a class="header-anchor" href="#_3、neated增删查改" aria-hidden="true">#</a> 3、<code>neated</code>增删查改</h4><p>ES的Nested数据类型允许我们存储一对多的数据，例如一个文章可以对应多个评论等，在正式开始之前，我们先生成一个用于测试的索引：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">PUT</span> <span class="token operator">/</span>test_article
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;test_article&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;whitespace&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>    # 注意要指定type值
          <span class="token string-property property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;whitespace&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一个简化的文章表，data字段就是一个nested嵌套类型，存储不同平台（system_type）的标注数据（在一个文章内，system_type的值是唯一的），如倾向性（affections）、主题（themes）等。如果需要，nested类型是可以进行嵌套的。</p><p>然后插入一些测试数据：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;标题1&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tag1 tag2 tag3&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article<span class="token operator">/</span><span class="token number">2</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;标题2&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tag1 tag2 tag3&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;正面&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1 2&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中性&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;标题4&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tag1 tag3&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中性&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1 2&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;负面&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;标题5&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tag1 tag3&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;正面&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3 1&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;标题6&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tag2&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_01-删除数据" tabindex="-1"><a class="header-anchor" href="#_01-删除数据" aria-hidden="true">#</a> <strong>01 删除数据</strong></h5><p>这是比较简单的：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article<span class="token operator">/</span><span class="token number">2</span><span class="token operator">/</span>_update
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>&quot;
    ctx<span class="token punctuation">.</span>_source<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>item <span class="token operator">-</span><span class="token operator">&gt;</span> item<span class="token punctuation">.</span>system_type <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token string">&quot;&quot;</span>&quot;
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用脚本删除满足特定条件的数据，主要就是removeIf函数，该函数的参数应该是一个匿名函数（比较接近JS的匿名函数写法，就是一个语法糖），表示成python大概是这样：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>lambda item<span class="token operator">:</span> item<span class="token punctuation">.</span>system_type <span class="token operator">==</span> <span class="token number">4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>item就是data中的元素，removeIf会把每个item都调用该匿名函数，如果得到true值就删除该元素。</p><h5 id="_02-修改数据" tabindex="-1"><a class="header-anchor" href="#_02-修改数据" aria-hidden="true">#</a> <strong>02 修改数据</strong></h5><p>修改数据应该先判断数据是否已经存在：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article<span class="token operator">/</span><span class="token number">2</span><span class="token operator">/</span>_update
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>&quot;
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_source<span class="token punctuation">.</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>e <span class="token keyword">in</span> ctx<span class="token punctuation">.</span>_source<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>system_type <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span>affections <span class="token operator">=</span> <span class="token string">&quot;正面&quot;</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token string">&quot;&quot;</span>&quot;
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的语句会删除data数据里，system_type值为2的记录。</p><p>修改数据成功之后，数据的版本号（_version）就会加1。</p><h5 id="_03-增加数据" tabindex="-1"><a class="header-anchor" href="#_03-增加数据" aria-hidden="true">#</a> <strong>03 增加数据</strong></h5><p>增加数据的时候，先判断数据是否已经存在，不存在才执行增加，如果已经存在了，则执行修改：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">POST</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>test_article<span class="token operator">/</span><span class="token number">2</span><span class="token operator">/</span>_update
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>&quot;
    def is_in <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>_source<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      List ls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>e <span class="token keyword">in</span> ctx<span class="token punctuation">.</span>_source<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>system_type <span class="token operator">==</span> params<span class="token punctuation">.</span>article<span class="token punctuation">.</span>system_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          is_in <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>String key<span class="token operator">:</span> params<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token string">&quot;system_type&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              e<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> params<span class="token punctuation">.</span>article<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is_in <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>_source<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token string">&quot;&quot;</span>&quot;<span class="token punctuation">,</span>
    <span class="token string-property property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;article&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;system_type&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;负面&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;themes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3 2&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;lang&quot;</span><span class="token operator">:</span> <span class="token string">&quot;painless&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里比较特别的语法是：for (String key: params.article.keySet())</p><p>找了半天才发现对象可以使用keySet方法来获取key值，类似python中的dict.keys()。</p><p>另外，脚本中有参数需要使用的时候，比较好的实现应该是通过params进行传递，而不是硬编码到脚本中。</p><h5 id="_04-查询" tabindex="-1"><a class="header-anchor" href="#_04-查询" aria-hidden="true">#</a> <strong>04 查询</strong></h5><p>nested数据的查询跟普通的查询有点不一样：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">GET</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用使用nested，并指定对应的path。但是要注意，这个查询只会对外层的记录进行过滤，并不会对nested内部的数据进行过滤。例如对于&quot;data.system_type&quot;: 1，则data字段里有一条记录满足这个条件的，这个文章就会整体返回（当然可以通过_source命令进行筛选）。</p><p>如果说只想得到命中的nested数据，则可以使用inner_hits：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">GET</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;inner_hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    # 返回满足条件的查询
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这时返回数据里就会增加一个inner_hits的字段：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_article&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_article&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;aqjGXH4BZeFFYagKZU_i&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;标题5&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;tag1 tag3&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;data&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>       # 这里可以使用_source命令进行过滤掉
            <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;system_type&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;affections&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;正面&quot;</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;themes&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3 1&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token operator">...</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;inner_hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>   # 这里只会返回命中的记录
          <span class="token string-property property">&quot;data&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
              <span class="token string-property property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_article&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;test_article&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;aqjGXH4BZeFFYagKZU_i&quot;</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;_nested&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
                    <span class="token string-property property">&quot;offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                  <span class="token string-property property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;system_type&quot;</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token string-property property">&quot;affections&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;正面&quot;</span><span class="token punctuation">,</span>
                    <span class="token string-property property">&quot;themes&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3 1&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_05-聚合统计" tabindex="-1"><a class="header-anchor" href="#_05-聚合统计" aria-hidden="true">#</a> <strong>05 聚合统计</strong></h5><p>在我们的场景中，场景的一个需要是，统计某个平台（system_type）下文章的倾向性的分布情况。开始的实现是这样：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">GET</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;positive&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;正面&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;negative&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;负面&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;neutral&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中性&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;sensitive&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&quot;data.affections&quot;</span><span class="token operator">:</span> <span class="token string">&quot;敏感&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的语句是可以工作的，但是很罗嗦，差不多有100行，很多重复的代码，现在倾向性只有4个还勉强可以，如果有10个呢，那就这个语句就有两三百行。。。</p><p>于是优化成这样：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">GET</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;system_type_value&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data.system_type&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;affections_value&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data.affections&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>思路是先按data.system_type进行分桶，然后再按data.affections进行分桶，简洁了很多，但是这样的弊端是，我们本来只想统计某个平台下的数据，这里却会把所有平台的数据都进行统计了，浪费资源。</p><p>再优化：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token constant">GET</span> <span class="token operator">/</span>test_article<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;nested_data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;filter_data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;data.system_type&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;affections_value&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data.affections&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>聚合里有一个filter的类型，之前居然没有注意到。通过filter过滤出满足条件的数据，再对data.affections进行分桶，完美解决。</p><h3 id="_5-2-3、构造基本数据" tabindex="-1"><a class="header-anchor" href="#_5-2-3、构造基本数据" aria-hidden="true">#</a> 5.2.3、构造基本数据</h3><h4 id="_1、查看接口" tabindex="-1"><a class="header-anchor" href="#_1、查看接口" aria-hidden="true">#</a> 1、查看接口</h4><p>请求url： http://localhost:88/api/product/spuinfo/1/up</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.1.1.png" alt="image-20220705230841294" tabindex="0" loading="lazy"><figcaption>image-20220705230841294</figcaption></figure><p>接口文档： https://easydoc.net/s/78237135/ZUqEdvA4/DhOtFr4A</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.1.2.png" alt="image-20220705230924173" tabindex="0" loading="lazy"><figcaption>image-20220705230924173</figcaption></figure><h4 id="_2、添加spuup方法" tabindex="-1"><a class="header-anchor" href="#_2、添加spuup方法" aria-hidden="true">#</a> 2、添加<code>spuUp</code>方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.SpuInfoController</code>类里添加<code>spuUp</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{spuId}/up&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">spuUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spuInfoService<span class="token punctuation">.</span><span class="token function">up</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.2.png" alt="image-20220705231758105" tabindex="0" loading="lazy"><figcaption>image-20220705231758105</figcaption></figure><h4 id="_3、添加up抽象方法" tabindex="-1"><a class="header-anchor" href="#_3、添加up抽象方法" aria-hidden="true">#</a> 3、添加<code>up</code>抽象方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.SpuInfoService</code>抽象接口里添加<code>up</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 商品上架
 * <span class="token keyword">@param</span> <span class="token parameter">spuId</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.3.png" alt="image-20220705231628130" tabindex="0" loading="lazy"><figcaption>image-20220705231628130</figcaption></figure><h4 id="_4、新建skuesmodel类" tabindex="-1"><a class="header-anchor" href="#_4、新建skuesmodel类" aria-hidden="true">#</a> 4、新建<code>SkuEsModel</code>类</h4><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>包下新建<code>es</code>文件夹，在<code>es</code>文件夹下新建<code>SkuEsModel</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/5
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkuEsModel</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> skuTitle<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> skuPrice<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> skuImg<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> saleCount<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 是否还有库存
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> hasStock<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 热度评分
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> hotScore<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 品牌id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 分类id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 品牌名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brandName<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 品牌图片
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brandImg<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 分类名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> catalogName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Attr</span><span class="token punctuation">&gt;</span></span> attrs<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Attr</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> attrName<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> attrValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.4.png" alt="image-20220705233742597" tabindex="0" loading="lazy"><figcaption>image-20220705233742597</figcaption></figure><h4 id="_5、实现up抽象方法" tabindex="-1"><a class="header-anchor" href="#_5、实现up抽象方法" aria-hidden="true">#</a> 5、实现<code>up</code>抽象方法</h4><h5 id="_1、修改up方法" tabindex="-1"><a class="header-anchor" href="#_1、修改up方法" aria-hidden="true">#</a> 1、修改<code>up</code>方法</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> upProducts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//组装需要的数据</span>
    <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、查出当前spuId对应的所有sku信息,包括品牌的名字。</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> skuInfoEntities <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.5.1.png" alt="image-20220705234605785" tabindex="0" loading="lazy"><figcaption>image-20220705234605785</figcaption></figure><h5 id="_2、添加getskusbyspuid抽象方法" tabindex="-1"><a class="header-anchor" href="#_2、添加getskusbyspuid抽象方法" aria-hidden="true">#</a> 2、添加<code>getSkusBySpuId</code>抽象方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.SkuInfoService</code>抽象类里添加<code>getSkusBySpuId</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.5.2.png" alt="image-20220705235515679" tabindex="0" loading="lazy"><figcaption>image-20220705235515679</figcaption></figure><h5 id="_3、实现getskusbyspuid抽象方法" tabindex="-1"><a class="header-anchor" href="#_3、实现getskusbyspuid抽象方法" aria-hidden="true">#</a> 3、实现<code>getSkusBySpuId</code>抽象方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SkuInfoServiceImpl</code>类里实现<code>getSkusBySpuId</code>抽象方法</p><p>(这里的<code>lambdaQueryWrapper.eq(SkuInfoEntity::getSKuId,spuId);</code>写错了，应该为<code>lambdaQueryWrapper.eq(SkuInfoEntity::getSpuId,spuId);</code>)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SkuInfoEntity</span><span class="token operator">::</span><span class="token function">getSKuId</span><span class="token punctuation">,</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.5.3.png" alt="image-20220705235432613" tabindex="0" loading="lazy"><figcaption>image-20220705235432613</figcaption></figure><h5 id="_4、对比skuesmodel类与skuinfoentity类" tabindex="-1"><a class="header-anchor" href="#_4、对比skuesmodel类与skuinfoentity类" aria-hidden="true">#</a> 4、对比<code>SkuEsModel</code>类与<code>SkuInfoEntity</code>类</h5><p><code>SkuEsModel</code>类与<code>SkuInfoEntity</code>类共同有的属性，但属性名不一样的数据的对比</p><table><thead><tr><th>SkuEsModel类中的属性名</th><th>SkuInfoEntity类中的属性名</th></tr></thead><tbody><tr><td>skuPrice</td><td>price</td></tr><tr><td>skuImg</td><td>skuDefaultImg</td></tr></tbody></table><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.5.4.1.png" alt="image-20220706000315389" tabindex="0" loading="lazy"><figcaption>image-20220706000315389</figcaption></figure><p><code>SkuEsModel</code>类有的属性，而<code>SkuInfoEntity</code>类没有的属性</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>hasStock    <span class="token comment">//是否还有库存</span>
hotScore 	<span class="token comment">//热度评分</span>
brandName 	<span class="token comment">//品牌名</span>
<span class="token class-name">BrandImg</span> 	<span class="token comment">//品牌图片</span>
catalogName <span class="token comment">//分类名</span>
attrs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.5.4.2.png" alt="image-20220706001019094" tabindex="0" loading="lazy"><figcaption>image-20220706001019094</figcaption></figure><h4 id="_6、修改up方法" tabindex="-1"><a class="header-anchor" href="#_6、修改up方法" aria-hidden="true">#</a> 6、修改<code>up</code>方法</h4><h5 id="_1、修改up方法-1" tabindex="-1"><a class="header-anchor" href="#_1、修改up方法-1" aria-hidden="true">#</a> 1、修改<code>up</code>方法</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">BrandService</span> brandService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">CategoryService</span> categoryService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//attrs</span>
    <span class="token comment">//TODO 4、查询当前sku的所有可以被用来检索的规格属性。</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductAttrValueEntity</span><span class="token punctuation">&gt;</span></span> productAttrValueEntities <span class="token operator">=</span> productAttrValueService<span class="token punctuation">.</span><span class="token function">baseAttrlistforspu</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds <span class="token operator">=</span> productAttrValueEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ProductAttrValueEntity</span><span class="token operator">::</span><span class="token function">getAttrId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> searchAttrIds <span class="token operator">=</span> attrService<span class="token punctuation">.</span><span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>searchAttrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attr</span><span class="token punctuation">&gt;</span></span> attrList <span class="token operator">=</span> productAttrValueEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> idSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attr</span> attr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> attr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1、查出当前spuId对应的所有sku信息,包括品牌的名字。</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> skuInfoEntities <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuInfoEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>skuInfoEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//组装需要的数据</span>
        <span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">,</span> skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//skuPrice</span>
        <span class="token comment">//skuImg</span>
        <span class="token comment">//hasStock      是否还有库存</span>
        <span class="token comment">//TODO 1、发送远程调用，在库存系统中查询是否有库存，并不用知道库存是多少</span>
        <span class="token comment">//hotScore      热度评分</span>
        <span class="token comment">//TODO 2、热度评分，默认为 0</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setHotScore</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//brandName：品牌名   BrandImg：品牌图片</span>
        <span class="token comment">//TODO 3、查询品牌和分类的名字信息</span>
        <span class="token class-name">BrandEntity</span> brandEntity <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//catalogName   分类名</span>
        <span class="token class-name">CategoryEntity</span> categoryEntity <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置检索属性</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuEsModel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 5、将数据发送给es进行保存</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.6.1.png" alt="image-20220706161633908" tabindex="0" loading="lazy"><figcaption>image-20220706161633908</figcaption></figure><h5 id="_2、添加selectsearchattrids抽象方法" tabindex="-1"><a class="header-anchor" href="#_2、添加selectsearchattrids抽象方法" aria-hidden="true">#</a> 2、添加<code>selectSearchAttrIds</code>抽象方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.AttrService</code>抽象类里添加<code>selectSearchAttrIds</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在指定的所有属性集合里面挑出检索属性
 * <span class="token keyword">@param</span> <span class="token parameter">attrIds</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.6.2.png" alt="image-20220706165307712" tabindex="0" loading="lazy"><figcaption>image-20220706165307712</figcaption></figure><h5 id="_3、添加selectsearchattrids方法" tabindex="-1"><a class="header-anchor" href="#_3、添加selectsearchattrids方法" aria-hidden="true">#</a> 3、添加<code>selectSearchAttrIds</code>方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.AttrServiceImpl</code>类里添加<code>selectSearchAttrIds</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//select attr_id from `pms_attr` where attr_id in(?) and search_type = 1</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.6.3.png" alt="image-20220706165811051" tabindex="0" loading="lazy"><figcaption>image-20220706165811051</figcaption></figure><h5 id="_4、添加selectsearchattrids抽象方法" tabindex="-1"><a class="header-anchor" href="#_4、添加selectsearchattrids抽象方法" aria-hidden="true">#</a> 4、添加<code>selectSearchAttrIds</code>抽象方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.dao.AttrDao</code>接口里添加<code>selectSearchAttrIds</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;attrIds&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.6.4.gif" alt="GIF 2022-7-6 17-02-34" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-6 17-02-34</figcaption></figure><h5 id="_5、修改attrdao-xml文件" tabindex="-1"><a class="header-anchor" href="#_5、修改attrdao-xml文件" aria-hidden="true">#</a> 5、修改<code>AttrDao.xml</code>文件</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/mapper/product/AttrDao.xml</code>文件里添加如下代码</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectSearchAttrIds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.Long<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select attr_id from gulimall_pms.pms_attr
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>where</span><span class="token punctuation">&gt;</span></span>
        attr_id in
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foreach</span> <span class="token attr-name">collection</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attrIds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">item</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attrId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">separator</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>,<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(<span class="token punctuation">&quot;</span></span> <span class="token attr-name">close</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            #{attrId}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foreach</span><span class="token punctuation">&gt;</span></span>
        and search_type = 1
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>where</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.3.6.5.png" alt="image-20220706172352803" tabindex="0" loading="lazy"><figcaption>image-20220706172352803</figcaption></figure><h3 id="_5-2-4、远程查询库存-泛型结果封装" tabindex="-1"><a class="header-anchor" href="#_5-2-4、远程查询库存-泛型结果封装" aria-hidden="true">#</a> 5.2.4、远程查询库存&amp;泛型结果封装</h3><h4 id="_1、新建skuhasstock类" tabindex="-1"><a class="header-anchor" href="#_1、新建skuhasstock类" aria-hidden="true">#</a> 1、新建<code>SkuHasStock</code>类</h4><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo</code>里新建<code>SkuHasStock</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/6
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkuHasStock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> hasStock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.1.png" alt="image-20220706204144858" tabindex="0" loading="lazy"><figcaption>image-20220706204144858</figcaption></figure><h4 id="_2、添加getskuhasstock方法" tabindex="-1"><a class="header-anchor" href="#_2、添加getskuhasstock方法" aria-hidden="true">#</a> 2、添加<code>getSkuHasStock</code>方法</h4><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类里添加<code>getSkuHasStock</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.2.png" alt="image-20220706204431570" tabindex="0" loading="lazy"><figcaption>image-20220706204431570</figcaption></figure><h4 id="_3、添加getskuhasstock抽象方法" tabindex="-1"><a class="header-anchor" href="#_3、添加getskuhasstock抽象方法" aria-hidden="true">#</a> 3、添加<code>getSkuHasStock</code>抽象方法</h4><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareSkuService</code>接口里添加<code>getSkuHasStock</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStock</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.3.png" alt="image-20220706204552037" tabindex="0" loading="lazy"><figcaption>image-20220706204552037</figcaption></figure><h4 id="_4、添加getskuhasstock方法" tabindex="-1"><a class="header-anchor" href="#_4、添加getskuhasstock方法" aria-hidden="true">#</a> 4、添加<code>getSkuHasStock</code>方法</h4><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类里添加<code>getSkuHasStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStock</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStock</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>skuId <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuHasStock</span> vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//SELECT SUM (stock) FROM、 wms ware skui WHERE sku id=1</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">getSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.4.png" alt="image-20220706231637733" tabindex="0" loading="lazy"><figcaption>image-20220706231637733</figcaption></figure><h4 id="_5、添加getskustock方法" tabindex="-1"><a class="header-anchor" href="#_5、添加getskustock方法" aria-hidden="true">#</a> 5、添加<code>getSkuStock</code>方法</h4><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.dao.WareSkuDao</code>类里添加<code>getSkuStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">long</span> <span class="token function">getSkuStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.5.png" alt="GIF 2022-7-6 23-30-39" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-6 23-30-39</figcaption></figure><h4 id="_6、添加getskustock" tabindex="-1"><a class="header-anchor" href="#_6、添加getskustock" aria-hidden="true">#</a> 6、添加<code>getSkuStock</code></h4><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件里添加<code>getSkuStock</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>   库存数 <span class="token operator">=</span> 剩余库存 <span class="token operator">-</span> 已被锁定的件数<span class="token punctuation">(</span>已生成订单但未付款，已下单等<span class="token punctuation">)</span>    <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;getSkuStock&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;java.lang.Long&quot;</span><span class="token operator">&gt;</span>
    select <span class="token function">sum</span><span class="token punctuation">(</span>stock<span class="token operator">-</span>stock_locked<span class="token punctuation">)</span> from gulimall_wms<span class="token punctuation">.</span>wms_ware_sku where sku_id<span class="token operator">=</span>#<span class="token punctuation">{</span>skuId<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.6.png" alt="image-20220706233740914" tabindex="0" loading="lazy"><figcaption>image-20220706233740914</figcaption></figure><h4 id="_7、重命名skuhasstock" tabindex="-1"><a class="header-anchor" href="#_7、重命名skuhasstock" aria-hidden="true">#</a> 7、重命名<code>SkuHasStock</code></h4><p>重新将<code>SkuHasStock</code>重命名为<code>SkuHasStockVo</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.4.7.png" alt="GIF 2022-7-6 23-56-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-6 23-56-02</figcaption></figure><h3 id="_5-2-5、调用远程库存服务" tabindex="-1"><a class="header-anchor" href="#_5-2-5、调用远程库存服务" aria-hidden="true">#</a> 5.2.5、调用远程库存服务</h3><h4 id="_1、导入依赖" tabindex="-1"><a class="header-anchor" href="#_1、导入依赖" aria-hidden="true">#</a> 1、导入依赖</h4><p>在<code>gulimall-product</code>模块的<code>pom</code>文件里添加如下依赖(已经添加过了)</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.1.png" alt="image-20220706234121762" tabindex="0" loading="lazy"><figcaption>image-20220706234121762</figcaption></figure><h4 id="_2、开启远程调用" tabindex="-1"><a class="header-anchor" href="#_2、开启远程调用" aria-hidden="true">#</a> 2、开启远程调用</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.GulimallProductApplication</code>启动类上添加如下注解(已经添加过了)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.atguigu.gulimall.product.feign&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.2.png" alt="image-20220706234719448" tabindex="0" loading="lazy"><figcaption>image-20220706234719448</figcaption></figure><h4 id="_3、添加getskuhasstock抽象方法-1" tabindex="-1"><a class="header-anchor" href="#_3、添加getskuhasstock抽象方法-1" aria-hidden="true">#</a> 3、添加<code>getSkuHasStock</code>抽象方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign</code>包下新建<code>WareFelginService</code>接口,在<code>WareFelginService</code>接口里添加<code>getSkuHasStock</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-ware&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WareFelginService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/waresku/hasStock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.3.png" alt="image-20220707092550014" tabindex="0" loading="lazy"><figcaption>image-20220707092550014</figcaption></figure><h4 id="_4、修改rs" tabindex="-1"><a class="header-anchor" href="#_4、修改rs" aria-hidden="true">#</a> 4、修改RS</h4><h5 id="方法一-不推荐" tabindex="-1"><a class="header-anchor" href="#方法一-不推荐" aria-hidden="true">#</a> 方法一：（不推荐）</h5><p>可以在<code>gulimall-common</code>模块的<code>com.atguigu.common.utils.R</code>类里添加泛型，用于封装数据(但我不想用这种方式)</p><p><a href="code/5.2.5.4.R.java">点击查看<code>R</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.4.1.png" alt="image-20220707093749873" tabindex="0" loading="lazy"><figcaption>image-20220707093749873</figcaption></figure><h5 id="方法二-推荐" tabindex="-1"><a class="header-anchor" href="#方法二-推荐" aria-hidden="true">#</a> 方法二：（推荐）</h5><p>重新在<code>gulimall-common</code>模块的<code>com.atguigu.common.utils</code>包里新建<code>RS</code>类用于后端数据传输</p><p><a href="code/5.2.5.4.RS.java">点击查看<code>RS</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.4.2.png" alt="image-20220707101501139" tabindex="0" loading="lazy"><figcaption>image-20220707101501139</figcaption></figure><h4 id="_5、修改getskuhasstock方法" tabindex="-1"><a class="header-anchor" href="#_5、修改getskuhasstock方法" aria-hidden="true">#</a> 5、修改<code>getSkuHasStock</code>方法</h4><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 查询sku是否有库存
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hasStock&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">&gt;</span></span> skuHasStocks <span class="token operator">=</span>  wareSkuService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>skuHasStocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.5.png" alt="image-20220707101542828" tabindex="0" loading="lazy"><figcaption>image-20220707101542828</figcaption></figure><h4 id="_6、移动并重命名skuhasstockvo类" tabindex="-1"><a class="header-anchor" href="#_6、移动并重命名skuhasstockvo类" aria-hidden="true">#</a> 6、移动并重命名<code>SkuHasStockVo</code>类</h4><p>把<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo.SkuHasStockVo</code>移动到<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>类下，并将<code>SkuHasStockVo</code>重命名为<code>SkuHasStockTo</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.6.png" alt="GIF 2022-7-7 10-29-00" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-7 10-29-00</figcaption></figure><h4 id="_7、修改getskuhasstock抽象方法" tabindex="-1"><a class="header-anchor" href="#_7、修改getskuhasstock抽象方法" aria-hidden="true">#</a> 7、修改<code>getSkuHasStock</code>抽象方法</h4><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign.WareFelginService</code>接口的<code>getSkuHasStock</code>抽象方法</p><p>(这里的<code>@PostMapping(&quot;/hasStock&quot;)</code>写错了，应该为<code>@PostMapping(&quot;/ware/waresku/hasStock&quot;)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hasStock&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.7.png" alt="image-20220707103934138" tabindex="0" loading="lazy"><figcaption>image-20220707103934138</figcaption></figure><h4 id="_8、修改up方法" tabindex="-1"><a class="header-anchor" href="#_8、修改up方法" aria-hidden="true">#</a> 8、修改<code>up</code>方法</h4><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、查出当前spuId对应的所有sku信息,包括品牌的名字。</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> skuInfoEntities <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//attrs</span>
    <span class="token comment">//TODO 4、查询当前sku的所有可以被用来检索的规格属性。</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductAttrValueEntity</span><span class="token punctuation">&gt;</span></span> productAttrValueEntities <span class="token operator">=</span> productAttrValueService<span class="token punctuation">.</span><span class="token function">baseAttrlistforspu</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> attrIds <span class="token operator">=</span> productAttrValueEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ProductAttrValueEntity</span><span class="token operator">::</span><span class="token function">getAttrId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> searchAttrIds <span class="token operator">=</span> attrService<span class="token punctuation">.</span><span class="token function">selectSearchAttrIds</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>searchAttrIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attr</span><span class="token punctuation">&gt;</span></span> attrList <span class="token operator">=</span> productAttrValueEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> idSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attr</span> attr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> attr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//TODO 1、发送远程调用，在库存系统中查询是否有库存，并不用知道库存是多少</span>
    <span class="token comment">//hotScore      热度评分</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> isSkuStock <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIdList <span class="token operator">=</span> skuInfoEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SkuInfoEntity</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> skuHasStock <span class="token operator">=</span> wareFelginService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isSkuStock <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockTo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> <span class="token class-name">SkuHasStockTo</span><span class="token operator">::</span><span class="token function">getHasStock</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;库存服务查询异常：原因{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> finalIsSkuStock <span class="token operator">=</span> isSkuStock<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuInfoEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>skuInfoEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//组装需要的数据</span>
        <span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">,</span> skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO 1、发送远程调用，在库存系统中查询是否有库存，并不用知道库存是多少</span>
        <span class="token comment">//hotScore      热度评分</span>
        <span class="token keyword">boolean</span> hasStock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//设置库存信息</span>
        <span class="token comment">//如果远程调用失败，则默认有库存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finalIsSkuStock <span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>finalIsSkuStock<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           skuEsModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            skuEsModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>finalIsSkuStock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//skuPrice</span>
        <span class="token comment">//skuImg</span>
        <span class="token comment">//hasStock      是否还有库存</span>
        <span class="token comment">//TODO 2、热度评分，默认为 0</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setHotScore</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//brandName：品牌名   BrandImg：品牌图片</span>
        <span class="token comment">//TODO 3、查询品牌和分类的名字信息</span>
        <span class="token class-name">BrandEntity</span> brandEntity <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//catalogName   分类名</span>
        <span class="token class-name">CategoryEntity</span> categoryEntity <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置检索属性</span>
        skuEsModel<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuEsModel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 5、将数据发送给es进行保存</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.5.8.png" alt="image-20220707165101191" tabindex="0" loading="lazy"><figcaption>image-20220707165101191</figcaption></figure><h3 id="_5-2-6、使用es远程上架" tabindex="-1"><a class="header-anchor" href="#_5-2-6、使用es远程上架" aria-hidden="true">#</a> 5.2.6、使用ES远程上架</h3><h4 id="_1、新建elasticsavecontroller类" tabindex="-1"><a class="header-anchor" href="#_1、新建elasticsavecontroller类" aria-hidden="true">#</a> 1、新建<code>ElasticSaveController</code>类</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search</code>包下新建<code>controller</code>文件夹，在<code>controller</code>文件夹下新建<code>ElasticSaveController</code>类，在<code>ElasticSaveController</code>里新建<code>productStatusUp</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es<span class="token punctuation">.</span></span><span class="token class-name">SkuEsModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticSaveController</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 上架商品
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.1.png" alt="image-20220707171329608" tabindex="0" loading="lazy"><figcaption>image-20220707171329608</figcaption></figure><h4 id="_2、新建productsaveservice类" tabindex="-1"><a class="header-anchor" href="#_2、新建productsaveservice类" aria-hidden="true">#</a> 2、新建<code>ProductSaveService</code>类</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search</code>包下新建<code>service</code>文件夹，在<code>service</code>文件夹下新建<code>ProductSaveService</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductSaveService</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.2.png" alt="image-20220707171915086" tabindex="0" loading="lazy"><figcaption>image-20220707171915086</figcaption></figure><h4 id="_3、修改productstatusup方法" tabindex="-1"><a class="header-anchor" href="#_3、修改productstatusup方法" aria-hidden="true">#</a> 3、修改<code>productStatusUp</code>方法</h4><p>修改<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.ElasticSaveController</code>类的<code>productStatusUp</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ProductSaveService</span> productSaveService<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 上架商品
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    productSaveService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.3.png" alt="image-20220707172125640" tabindex="0" loading="lazy"><figcaption>image-20220707172125640</figcaption></figure><h4 id="_4、添加productstatusup抽象方法" tabindex="-1"><a class="header-anchor" href="#_4、添加productstatusup抽象方法" aria-hidden="true">#</a> 4、添加<code>productStatusUp</code>抽象方法</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.ProductSaveService</code>接口里添加<code>productStatusUp</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.4.png" alt="image-20220707193842609" tabindex="0" loading="lazy"><figcaption>image-20220707193842609</figcaption></figure><h4 id="_5、新建esconstant常量类" tabindex="-1"><a class="header-anchor" href="#_5、新建esconstant常量类" aria-hidden="true">#</a> 5、新建<code>EsConstant</code>常量类</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search</code>包里新建<code>constant</code>文件夹，在<code>constant</code>文件夹里新建<code>EsConstant</code>常量类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsConstant</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * sku数据在es中的索引
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PRODUCT_INDEX</span> <span class="token operator">=</span> <span class="token string">&quot;product&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.5.png" alt="image-20220707194908231" tabindex="0" loading="lazy"><figcaption>image-20220707194908231</figcaption></figure><h4 id="_6、新建productsaveserviceimpl类" tabindex="-1"><a class="header-anchor" href="#_6、新建productsaveserviceimpl类" aria-hidden="true">#</a> 6、新建<code>ProductSaveServiceImpl</code>类</h4><h5 id="_1、向上抛出异常" tabindex="-1"><a class="header-anchor" href="#_1、向上抛出异常" aria-hidden="true">#</a> 1、向上抛出异常</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service</code>包里新建<code>impl</code>文件夹，在<code>impl</code>文件夹里新建<code>ProductSaveServiceImpl</code>类，实现<code>ProductSaveService</code>接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es<span class="token punctuation">.</span></span><span class="token class-name">SkuEsModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">GulimallElasticSearchConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">EsConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ProductSaveService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>bulk<span class="token punctuation">.</span></span><span class="token class-name">BulkRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xcontent<span class="token punctuation">.</span></span><span class="token class-name">XContentType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductSaveServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ProductSaveService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//保存到es</span>
        <span class="token comment">//1、给es中建立索引，product，建立好映射关系。</span>

        <span class="token comment">//2、给es中保存这些数据</span>
        <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">:</span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_INDEX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        restHighLevelClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.6.1.gif" alt="GIF 2022-7-7 20-00-48" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-7 20-00-48</figcaption></figure><h5 id="_2、修改返回类型" tabindex="-1"><a class="header-anchor" href="#_2、修改返回类型" aria-hidden="true">#</a> 2、修改返回类型</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es<span class="token punctuation">.</span></span><span class="token class-name">SkuEsModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">GulimallElasticSearchConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">EsConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ProductSaveService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>bulk<span class="token punctuation">.</span></span><span class="token class-name">BulkItemResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>bulk<span class="token punctuation">.</span></span><span class="token class-name">BulkRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>bulk<span class="token punctuation">.</span></span><span class="token class-name">BulkResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xcontent<span class="token punctuation">.</span></span><span class="token class-name">XContentType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductSaveServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ProductSaveService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">//保存到es</span>
        <span class="token comment">//1、给es中建立索引，product，建立好映射关系。(kibana里已经建立过了)</span>

        <span class="token comment">//2、给es中保存这些数据</span>
        <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">:</span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_INDEX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">BulkResponse</span> bulk <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span><span class="token constant">COMMON_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 如果批量操作有错误</span>
        <span class="token keyword">boolean</span> b <span class="token operator">=</span> bulk<span class="token punctuation">.</span><span class="token function">hasFailures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>bulk<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">BulkItemResponse</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;商品上架错误：{}&quot;</span><span class="token punctuation">,</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.6.2.png" alt="GIF 2022-7-7 20-12-55" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-7 20-12-55</figcaption></figure><h5 id="_3、完整代码" tabindex="-1"><a class="header-anchor" href="#_3、完整代码" aria-hidden="true">#</a> 3、完整代码</h5><p><a href="code/5.2.6.6.3.ProductSaveServiceImpl.java">点击查看<code>ProductSaveServiceImpl</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.6.3.png" alt="image-20220707201345098" tabindex="0" loading="lazy"><figcaption>image-20220707201345098</figcaption></figure><h4 id="_7、修改严重性级别-解决resthighlevelclient报红" tabindex="-1"><a class="header-anchor" href="#_7、修改严重性级别-解决resthighlevelclient报红" aria-hidden="true">#</a> 7、修改<code>严重性</code>级别(解决<code>restHighLevelClient</code>报红)</h4><p>依次点击<code>File</code> -&gt; <code>Settings</code> -&gt; <code>Editor</code> -&gt; <code>Inspections</code> -&gt; <code>Spring</code> -&gt; <code>Spring Core</code> -&gt; <code>Autowiring for bean class</code></p><p>在右侧 <code>Severity</code> 里选择 <code>Warining</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.7.png" alt="GIF 2022-7-7 20-20-29" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-7 20-20-29</figcaption></figure><h4 id="_8、在bizcodeexception枚举类里添加实例" tabindex="-1"><a class="header-anchor" href="#_8、在bizcodeexception枚举类里添加实例" aria-hidden="true">#</a> 8、在<code>BizCodeException</code>枚举类里添加实例</h4><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加实例</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 商品上架异常（向ElasticSearch里保存数据出错）
 */</span>
<span class="token function">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">11000</span><span class="token punctuation">,</span><span class="token string">&quot;商品上架异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.8.png" alt="image-20220707203236682" tabindex="0" loading="lazy"><figcaption>image-20220707203236682</figcaption></figure><p>完整代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/5/7
 * @Description:
 * 错误码和错误信息定义类
 * 1. 错误码定义规则为 5 为数字
 * 2. 前两位表示业务场景，最后三位表示错误码。例如：100001。10:通用 001:系统未知异常
 * 3. 维护错误码后需要维护错误描述，将他们定义为枚举形式
 * 错误码列表：
 * 10: 通用
 * 001：参数格式校验
 * 11: 商品
 * 12: 订单
 * 13: 购物车
 * 14: 物流
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">BizCodeException</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 系统未知异常
     */</span>
    <span class="token function">UNKNOW_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span><span class="token string">&quot;系统未知异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 参数格式校验失败
     */</span>
    <span class="token function">VALID_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span><span class="token string">&quot;参数格式校验失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 商品上架异常（向ElasticSearch里保存数据出错）
     */</span>
    <span class="token function">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">11000</span><span class="token punctuation">,</span><span class="token string">&quot;商品上架异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

    <span class="token class-name">BizCodeException</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9、修改productstatusup方法" tabindex="-1"><a class="header-anchor" href="#_9、修改productstatusup方法" aria-hidden="true">#</a> 9、修改<code>productStatusUp</code>方法</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.ElasticSaveController</code>类里修改<code>productStatusUp</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BizCodeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es<span class="token punctuation">.</span></span><span class="token class-name">SkuEsModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ProductSaveService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticSaveController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ProductSaveService</span> productSaveService<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 上架商品
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> productSaveService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;ElasticSaveController商品上架错误：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_UP_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.9.png" alt="image-20220707204343751" tabindex="0" loading="lazy"><figcaption>image-20220707204343751</figcaption></figure><h4 id="_10、修改-requestmapping注解" tabindex="-1"><a class="header-anchor" href="#_10、修改-requestmapping注解" aria-hidden="true">#</a> 10、修改<code>@RequestMapping</code>注解</h4><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.ElasticSaveController</code>类上修改<code>@RequestMapping(&quot;/search&quot;)</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search/save&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.10.png" alt="image-20220707205228319" tabindex="0" loading="lazy"><figcaption>image-20220707205228319</figcaption></figure><h4 id="_11、修改productstatusup方法的返回值" tabindex="-1"><a class="header-anchor" href="#_11、修改productstatusup方法的返回值" aria-hidden="true">#</a> 11、修改<code>productStatusUp</code>方法的返回值</h4><p>修改<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.ProductSaveServiceImpl</code>类的<code>productStatusUp</code>方法的返回值，<code>bulk.hasFailures()</code>方法有错误了才返回<code>true</code>，而<code>productStatusUp</code>方法没有错误了才返回<code>true</code>，所以返回值应取反</p><p><a href="code/5.2.6.11.ProductSaveServiceImpl.java">点击查看<code>ProductSaveServiceImpl</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.11.png" alt="image-20220707204429879" tabindex="0" loading="lazy"><figcaption>image-20220707204429879</figcaption></figure><h4 id="_12、新建searchfeignservice类" tabindex="-1"><a class="header-anchor" href="#_12、新建searchfeignservice类" aria-hidden="true">#</a> 12、新建<code>SearchFeignService</code>类</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign</code>包里新建<code>SearchFeignService</code>类，在<code>SearchFeignService</code>类里添加<code>productStatusUp</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>es<span class="token punctuation">.</span></span><span class="token class-name">SkuEsModel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/7
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-search&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchFeignService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search/save/product&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.12.png" alt="image-20220707205546053" tabindex="0" loading="lazy"><figcaption>image-20220707205546053</figcaption></figure><h4 id="_13、新建statusenum枚举类" tabindex="-1"><a class="header-anchor" href="#_13、新建statusenum枚举类" aria-hidden="true">#</a> 13、新建<code>StatusEnum</code>枚举类</h4><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.constant.product</code>包里新建<code>StatusEnum</code>枚举类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>product</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/5/17
 * @Description: spu的状态
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">StatusEnum</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 新建商品
     */</span>
    <span class="token function">NEW_SPU</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;新建商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 上架商品
     */</span>
    <span class="token function">SPU_UP</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;上架商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token doc-comment comment">/**
     * 下架商品
     */</span>
    <span class="token function">SPU_DOWN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;下架商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

    <span class="token class-name">StatusEnum</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.13.png" alt="image-20220707211525454" tabindex="0" loading="lazy"><figcaption>image-20220707211525454</figcaption></figure><h4 id="_14、修改up方法" tabindex="-1"><a class="header-anchor" href="#_14、修改up方法" aria-hidden="true">#</a> 14、修改<code>up</code>方法</h4><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//TODO 5、将数据发送给es进行保存</span>
<span class="token class-name">R</span> r <span class="token operator">=</span> searchFeignService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//远程调用成功</span>
    <span class="token comment">//TODO 6、修改当前spu的状态(变为上架状态)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">updateSpuStatus</span><span class="token punctuation">(</span>spuId<span class="token punctuation">,</span> <span class="token class-name">StatusEnum</span><span class="token punctuation">.</span><span class="token constant">SPU_UP</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//远程调用失败</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.14.png" alt="image-20220707211853172" tabindex="0" loading="lazy"><figcaption>image-20220707211853172</figcaption></figure><h4 id="_15、添加updatespustatus" tabindex="-1"><a class="header-anchor" href="#_15、添加updatespustatus" aria-hidden="true">#</a> 15、添加<code>updateSpuStatus</code></h4><p>在<code>gulimall-product</code>模块的<code>src/main/resources/mapper/product/SpuInfoDao.xml</code>文件里添加<code>updateSpuStatus</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>update id<span class="token operator">=</span><span class="token string">&quot;updateSpuStatus&quot;</span><span class="token operator">&gt;</span>
    update gulimall_pms<span class="token punctuation">.</span>pms_spu_info set publish_status<span class="token operator">=</span>#<span class="token punctuation">{</span>code<span class="token punctuation">}</span><span class="token punctuation">,</span>update_time <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> where id <span class="token operator">=</span> #<span class="token punctuation">{</span>spuId<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>update<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.15.png" alt="image-20220707212648115" tabindex="0" loading="lazy"><figcaption>image-20220707212648115</figcaption></figure><h4 id="_16、完整spuinfoserviceimpl类代码" tabindex="-1"><a class="header-anchor" href="#_16、完整spuinfoserviceimpl类代码" aria-hidden="true">#</a> 16、完整<code>SpuInfoServiceImpl</code>类代码</h4><p><a href="code/5.2.6.16.SpuInfoServiceImpl.java">点击查看<code>SpuInfoServiceImpl</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.16.png" alt="image-20220707213102930" tabindex="0" loading="lazy"><figcaption>image-20220707213102930</figcaption></figure><h4 id="_17、设置端口" tabindex="-1"><a class="header-anchor" href="#_17、设置端口" aria-hidden="true">#</a> 17、设置端口</h4><p>在<code>gulimall-search</code>模块的<code>src/main/resources</code>文件夹里新建<code>application.yml</code>文件，在<code>application.yml</code>配置文件里添加配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>server<span class="token operator">:</span>
  port<span class="token operator">:</span> <span class="token number">12000</span>
spring<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> gulimall<span class="token operator">-</span>search
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.6.17.png" alt="image-20220709080010877" tabindex="0" loading="lazy"><figcaption>image-20220709080010877</figcaption></figure><h3 id="_5-2-7、测试-1-product服务" tabindex="-1"><a class="header-anchor" href="#_5-2-7、测试-1-product服务" aria-hidden="true">#</a> 5.2.7、测试（1）<code>Product</code>服务</h3><h4 id="_1、准备工作-1" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-1" aria-hidden="true">#</a> 1、准备工作</h4><h5 id="_1、添加gulimallsearchapplication服务到unnamed" tabindex="-1"><a class="header-anchor" href="#_1、添加gulimallsearchapplication服务到unnamed" aria-hidden="true">#</a> 1、添加<code>GulimallSearchApplication</code>服务到<code>Unnamed</code></h5><p>添加<code>GulimallSearchApplication</code>服务到<code>Unnamed</code>，并指定<code>GulimallSearchApplication</code>服务的最大占用为<code>100m</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-Xmx100m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.1.1.gif" alt="GIF 2022-7-7 21-32-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-7 21-32-14</figcaption></figure><h5 id="_2、启动各个模块" tabindex="-1"><a class="header-anchor" href="#_2、启动各个模块" aria-hidden="true">#</a> 2、启动各个模块</h5><p>启动<code>gulimall-coupon</code> 、<code>gulimall-gateway</code> 、<code>gulimall-member</code> 、<code>gulimall-product</code> 、<code>gulimall-third-party</code> 、 <code>gulimall-ware</code> 、<code>renren-fast</code> 、<code>gulimall-search</code>模块</p><p>其中<code>gulimall-product</code> 、 <code>gulimall-ware</code> 、<code>gulimall-search</code>模块以<code>debug</code>方式启动</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.1.2.png" alt="image-20220707214419078" tabindex="0" loading="lazy"><figcaption>image-20220707214419078</figcaption></figure><h5 id="_3、在spuinfoserviceimpl类的up方法里打断点" tabindex="-1"><a class="header-anchor" href="#_3、在spuinfoserviceimpl类的up方法里打断点" aria-hidden="true">#</a> 3、在<code>SpuInfoServiceImpl</code>类的<code>up</code>方法里打断点</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法有效的第一行<code>List&lt;SkuInfoEntity&gt; skuInfoEntities = skuInfoService.getSkusBySpuId(spuId);</code>上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.1.3.png" alt="image-20220707215149382" tabindex="0" loading="lazy"><figcaption>image-20220707215149382</figcaption></figure><h5 id="_4、在elasticsavecontroller类的productstatusup方法里打断点" tabindex="-1"><a class="header-anchor" href="#_4、在elasticsavecontroller类的productstatusup方法里打断点" aria-hidden="true">#</a> 4、在<code>ElasticSaveController</code>类的<code>productStatusUp</code>方法里打断点</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.ElasticSaveController</code>类的<code>productStatusUp</code>方法有效的第一行<code>boolean b = false;</code>上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.1.4.png" alt="image-20220707215412247" tabindex="0" loading="lazy"><figcaption>image-20220707215412247</figcaption></figure><h5 id="_5、在wareskucontroller类的getskuhasstock方法里打断点" tabindex="-1"><a class="header-anchor" href="#_5、在wareskucontroller类的getskuhasstock方法里打断点" aria-hidden="true">#</a> 5、在<code>WareSkuController</code>类的<code>getSkuHasStock</code>方法里打断点</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法有效的第一行<code>List&lt;SkuHasStockTo&gt; skuHasStocks = wareSkuService.getSkuHasStock(skuIds);</code>上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.1.5.png" alt="image-20220707215543039" tabindex="0" loading="lazy"><figcaption>image-20220707215543039</figcaption></figure><h4 id="_2、进行测试" tabindex="-1"><a class="header-anchor" href="#_2、进行测试" aria-hidden="true">#</a> 2、进行测试</h4><h5 id="_1、点击上架" tabindex="-1"><a class="header-anchor" href="#_1、点击上架" aria-hidden="true">#</a> 1、点击上架</h5><p>运行前端项目，然后在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.2.1.png" alt="image-20220707224251073" tabindex="0" loading="lazy"><figcaption>image-20220707224251073</figcaption></figure><h5 id="_2、点击step-over" tabindex="-1"><a class="header-anchor" href="#_2、点击step-over" aria-hidden="true">#</a> 2、点击<code>Step Over</code></h5><p>切换到<code>IDEA</code>，点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>可以看到<code>List&lt;SkuInfoEntity&gt; skuInfoEntities = skuInfoService.getSkusBySpuId(spuId);</code>这一行只查出了一行数据，应该是有8行数据的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.2.2.1.png" alt="image-20220707224607006" tabindex="0" loading="lazy"><figcaption>image-20220707224607006</figcaption></figure><p>可以看到，<code>gulimall_pms</code>数据库的<code>pms_sku_info</code>表中的<code>spu_id</code>为<code>1</code>的有8条数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.2.2.2.png" alt="image-20220709075336050" tabindex="0" loading="lazy"><figcaption>image-20220709075336050</figcaption></figure><h5 id="_3、修改getskusbyspuid方法" tabindex="-1"><a class="header-anchor" href="#_3、修改getskusbyspuid方法" aria-hidden="true">#</a> 3、修改<code>getSkusBySpuId</code>方法</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SkuInfoServiceImpl</code>类的<code>getSkusBySpuId</code>方法</p><p>这里错把<code>SkuInfoEntity::getSpuId</code>写成<code>SkuInfoEntity::getSkuId</code>了，改过来就行了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkusBySpuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SkuInfoEntity</span><span class="token operator">::</span><span class="token function">getSpuId</span><span class="token punctuation">,</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.2.3.png" alt="image-20220707224727168" tabindex="0" loading="lazy"><figcaption>image-20220707224727168</figcaption></figure><h4 id="_3、重新测试" tabindex="-1"><a class="header-anchor" href="#_3、重新测试" aria-hidden="true">#</a> 3、重新测试</h4><h5 id="_1、重启product服务" tabindex="-1"><a class="header-anchor" href="#_1、重启product服务" aria-hidden="true">#</a> 1、重启<code>product</code>服务</h5><p>重新以debug方式启动<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.1.png" alt="image-20220707224919708" tabindex="0" loading="lazy"><figcaption>image-20220707224919708</figcaption></figure><h5 id="_2、再次点击上架" tabindex="-1"><a class="header-anchor" href="#_2、再次点击上架" aria-hidden="true">#</a> 2、再次点击<code>上架</code></h5><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.2.png" alt="image-20220707224947688" tabindex="0" loading="lazy"><figcaption>image-20220707224947688</figcaption></figure><h5 id="_3、根据spuid查询所有sku" tabindex="-1"><a class="header-anchor" href="#_3、根据spuid查询所有sku" aria-hidden="true">#</a> 3、根据<code>spuId</code>查询所有<code>sku</code></h5><p>切换到<code>IDEA</code>，点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>List&lt;SkuInfoEntity&gt; skuInfoEntities = skuInfoService.getSkusBySpuId(spuId);</code></p><p>根据<code>spuId</code>查询所有<code>sku</code>数据（共8条），还差品牌的名字没有查出来。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.3.1.png" alt="image-20220707225203812" tabindex="0" loading="lazy"><figcaption>image-20220707225203812</figcaption></figure><p>与<code>gulimall_pms</code>数据库的<code>pms_sku_info</code>表中的<code>spu_id</code>为<code>1</code>的8条数据相同</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.3.2.png" alt="image-20220707225229746" tabindex="0" loading="lazy"><figcaption>image-20220707225229746</figcaption></figure><h5 id="_4、查出所有的规格属性" tabindex="-1"><a class="header-anchor" href="#_4、查出所有的规格属性" aria-hidden="true">#</a> 4、查出所有的规格属性</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>List&lt;ProductAttrValueEntity&gt; productAttrValueEntities = productAttrValueService.baseAttrlistforspu(spuId);</code></p><p>根据<code>spuId</code>查询出该该<code>spu</code>的所有基础属性</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.4.png" alt="image-20220707230047913" tabindex="0" loading="lazy"><figcaption>image-20220707230047913</figcaption></figure><h5 id="_5、获取attrid集合" tabindex="-1"><a class="header-anchor" href="#_5、获取attrid集合" aria-hidden="true">#</a> 5、获取<code>attrId</code>集合</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>List&lt;Long&gt; attrIds = productAttrValueEntities.stream().map(ProductAttrValueEntity::getAttrId).collect(Collectors.toList());</code></p><p>根据<code>ProductAttrValueEntity</code>集合获取<code>attrId</code>集合</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.5.png" alt="image-20220707225718094" tabindex="0" loading="lazy"><figcaption>image-20220707225718094</figcaption></figure><h5 id="_6、筛选出可检索规格属性" tabindex="-1"><a class="header-anchor" href="#_6、筛选出可检索规格属性" aria-hidden="true">#</a> 6、筛选出可检索规格属性</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>List&lt;Long&gt; searchAttrIds = attrService.selectSearchAttrIds(attrIds);</code></p><p>根据<code>attrIds</code>(当前<code>spuId</code>的所有规格属性的集合)过滤出所有可以被用来检索的规格属性</p><p>可以看到查询到了一条<code>attrId</code>为<code>1</code>的一条数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.6.1.png" alt="image-20220707230418606" tabindex="0" loading="lazy"><figcaption>image-20220707230418606</figcaption></figure><p>与<code>gulimall_pms</code>数据库的<code>pms_attr</code>表的指定<code>attr_id</code>集合的<code>search_type</code>为<code>1</code>的数据一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.6.2.png" alt="image-20220707231007884" tabindex="0" loading="lazy"><figcaption>image-20220707231007884</figcaption></figure><h5 id="_7、把list-long-转为set-long" tabindex="-1"><a class="header-anchor" href="#_7、把list-long-转为set-long" aria-hidden="true">#</a> 7、把<code>List&lt;Long&gt;</code>转为<code>Set&lt;Long&gt;</code></h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>Set&lt;Long&gt; idSet = new HashSet&lt;&gt;(searchAttrIds);</code></p><p>把查出的可检索的规格属性放到了<code>HashSet</code>集合里，方便查询(这样查询的效率为<code>O(1)</code>)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.7.png" alt="image-20220707231340731" tabindex="0" loading="lazy"><figcaption>image-20220707231340731</figcaption></figure><h5 id="_8、打断点" tabindex="-1"><a class="header-anchor" href="#_8、打断点" aria-hidden="true">#</a> 8、打断点</h5><p>在<code>SkuEsModel.Attr attr = new SkuEsModel.Attr();</code>这里打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.8.png" alt="image-20220707231612897" tabindex="0" loading="lazy"><figcaption>image-20220707231612897</figcaption></figure><h5 id="_9、点击三次step-over" tabindex="-1"><a class="header-anchor" href="#_9、点击三次step-over" aria-hidden="true">#</a> 9、点击三次<code>Step Over</code></h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮三次，执行当前方法的下三个语句，跳到<code>SkuEsModel.Attr attr = new SkuEsModel.Attr();</code>这里，可以看到当前遍历的元素就是一个<code>规格属性</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.9.png" alt="image-20220707231856962" tabindex="0" loading="lazy"><figcaption>image-20220707231856962</figcaption></figure><h5 id="_10、点击两次step-over" tabindex="-1"><a class="header-anchor" href="#_10、点击两次step-over" aria-hidden="true">#</a> 10、点击两次<code>Step Over</code></h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮两次，执行当前方法的下两个语句，跳到<code>return attr;</code>语句</p><p>这时已经把<code>attrId</code>、<code>attrName</code>、<code>attrValue</code>封装到<code>gulimall-common</code>模块的<code>com.atguigu.common.to.es.SkuEsModel.Attr</code>内部类里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.10.png" alt="image-20220707231952723" tabindex="0" loading="lazy"><figcaption>image-20220707231952723</figcaption></figure><h5 id="_11、执行完该stream" tabindex="-1"><a class="header-anchor" href="#_11、执行完该stream" aria-hidden="true">#</a> 11、执行完该<code>stream</code></h5><p>一直点击<code>GulimallProductApplication</code>项目的<code>Step Over</code>(步过)按钮，直到执行完该<code>stream</code>，准备执行<code>Map&lt;Long, Boolean&gt; isSkuStock = null;</code>语句</p><p>这时已经处理完所有<code>attrId</code>，并把他们放到<code>attrList</code>集合里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.11.png" alt="image-20220707232202207" tabindex="0" loading="lazy"><figcaption>image-20220707232202207</figcaption></figure><h5 id="_12、打断点" tabindex="-1"><a class="header-anchor" href="#_12、打断点" aria-hidden="true">#</a> 12、打断点</h5><p>在<code>Map&lt;Long, Boolean&gt; finalIsSkuStock = isSkuStock;</code>这里打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.12.png" alt="image-20220707232349889" tabindex="0" loading="lazy"><figcaption>image-20220707232349889</figcaption></figure><h5 id="_13、准备调用ware模块" tabindex="-1"><a class="header-anchor" href="#_13、准备调用ware模块" aria-hidden="true">#</a> 13、准备调用<code>ware</code>模块</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮两次，执行当前方法的下两个语句，跳到<code>RS&lt;List&lt;SkuHasStockTo&gt;&gt; skuHasStock = wareFelginService.getSkuHasStock(skuIdList);</code>这里</p><p>准备远程调用<code>GulimallWareApplication</code>服务，在库存系统里查询这些<code>sku</code>是否还有库存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.7.3.13.png" alt="image-20220707232827958" tabindex="0" loading="lazy"><figcaption>image-20220707232827958</figcaption></figure><h3 id="_5-2-8、测试-2-ware服务" tabindex="-1"><a class="header-anchor" href="#_5-2-8、测试-2-ware服务" aria-hidden="true">#</a> 5.2.8、测试（2）<code>Ware</code>服务</h3><h4 id="_1、准备转到ware模块" tabindex="-1"><a class="header-anchor" href="#_1、准备转到ware模块" aria-hidden="true">#</a> 1、准备转到<code>ware</code>模块</h4><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句，准备跳转到<code>GulimallWareApplication</code>服务</p><h5 id="_1、没有跳转到ware模块" tabindex="-1"><a class="header-anchor" href="#_1、没有跳转到ware模块" aria-hidden="true">#</a> 1、没有跳转到<code>ware</code>模块</h5><p>并没有按预想的跳转到<code>GulimallWareApplication</code>服务，而是跳转到了异常里面，可以看到是没有找到<code>WareFelginService</code>模块</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>detailMessage = &quot;status 404 reading WareFelginService#getSkuHasStock(List)&quot;
详细信息 = &quot;状态 404 读取 WareFelginService#getSkuHasStock(List)&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.1.1.png" alt="image-20220707233207756" tabindex="0" loading="lazy"><figcaption>image-20220707233207756</figcaption></figure><h5 id="_2、修改注解" tabindex="-1"><a class="header-anchor" href="#_2、修改注解" aria-hidden="true">#</a> 2、修改注解</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.feign.WareFelginService</code>类的<code>getSkuHasStock</code>方法</p><p>把<code>@PostMapping(&quot;/hasStock&quot;)</code>注解修改成<code>@PostMapping(&quot;/ware/waresku/hasStock&quot;)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/waresku/hasStock&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.1.2.png" alt="image-20220707233513049" tabindex="0" loading="lazy"><figcaption>image-20220707233513049</figcaption></figure><h4 id="_2、再次测试" tabindex="-1"><a class="header-anchor" href="#_2、再次测试" aria-hidden="true">#</a> 2、再次测试</h4><p>再次以debug方式启动<code>GulimallProductApplication</code>服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><h5 id="_1、跳转到ware模块" tabindex="-1"><a class="header-anchor" href="#_1、跳转到ware模块" aria-hidden="true">#</a> 1、跳转到<code>ware</code>模块</h5><p>这次就成功跳转到<code>GulimallWareApplication</code>服务了</p><p>就来到了<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>List&lt;SkuHasStockTo&gt; skuHasStocks = wareSkuService.getSkuHasStock(skuIds);</code>这条语句</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.1.png" alt="image-20220707234330247" tabindex="0" loading="lazy"><figcaption>image-20220707234330247</figcaption></figure><h5 id="_2、跳转到异常了" tabindex="-1"><a class="header-anchor" href="#_2、跳转到异常了" aria-hidden="true">#</a> 2、跳转到异常了</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>List&lt;SkuHasStockTo&gt; skuHasStocks = wareSkuService.getSkuHasStock(skuIds);</code></p><p>这次就到了一个异常类里，很明显这行代码出错了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.2.png" alt="image-20220707234432664" tabindex="0" loading="lazy"><figcaption>image-20220707234432664</figcaption></figure><h5 id="_3、试图从具有原始返回类型-long-的方法返回-null" tabindex="-1"><a class="header-anchor" href="#_3、试图从具有原始返回类型-long-的方法返回-null" aria-hidden="true">#</a> 3、试图从具有原始返回类型（long）的方法返回 null</h5><p>点击<code>Pause Program</code>按钮，执行完这些异常处理类</p><p>可以看到<code>ibatis</code>报错，这应该就是<code>mybatis</code>相关的错误了</p><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.dao.WareSkuDao.getSkuStock</code>方法应该返回<code>long</code>类型，而实际返回<code>null</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>org.apache.ibatis.binding.BindingException: Mapper method &#39;com.atguigu.gulimall.ware.dao.WareSkuDao.getSkuStock attempted to return null from a method with a primitive return type (long).

org.apache.ibatis.binding.BindingException：映射器方法 &#39;com.atguigu.gulimall.ware.dao.WareSkuDao.getSkuStock 试图从具有原始返回类型（long）的方法返回 null。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.3.1.png" alt="image-20220707234720373" tabindex="0" loading="lazy"><figcaption>image-20220707234720373</figcaption></figure><p>是<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件的如下代码报错</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;getSkuStock&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;java.lang.Long&quot;</span><span class="token operator">&gt;</span>
    select <span class="token function">sum</span><span class="token punctuation">(</span>stock<span class="token operator">-</span>stock_locked<span class="token punctuation">)</span> from gulimall_wms<span class="token punctuation">.</span>wms_ware_sku where sku_id<span class="token operator">=</span>#<span class="token punctuation">{</span>skuId<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.3.2.png" alt="image-20220707234846728" tabindex="0" loading="lazy"><figcaption>image-20220707234846728</figcaption></figure><p>查看<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表，可以看到这里没有<code>skuId</code>为<code>5</code>的库存信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.3.3.png" alt="image-20220707235311735" tabindex="0" loading="lazy"><figcaption>image-20220707235311735</figcaption></figure><p>执行如下<code>sql</code>语句，由于查不到<code>skuId</code>为<code>5</code>的库存信息，所以就返回了<code>null</code>，而<code>long</code>基本类型不能接收<code>null</code></p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>select sum(stock-stock_locked) from gulimall_wms.wms_ware_sku where sku_id=5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.3.4.png" alt="image-20220707235407324" tabindex="0" loading="lazy"><figcaption>image-20220707235407324</figcaption></figure><h5 id="_4、换成包装类型" tabindex="-1"><a class="header-anchor" href="#_4、换成包装类型" aria-hidden="true">#</a> 4、换成包装类型</h5><p>将<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>getSkuHasStock</code>方法的<code>long count = this.baseMapper.getSkuStock(skuId);</code>替换为<code>Long count = this.baseMapper.getSkuStock(skuId);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> skuIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>skuId <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuHasStockTo</span> vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuHasStockTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//SELECT SUM (stock) FROM、 wms ware skui WHERE sku id=1</span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">getSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.4.1.png" alt="image-20220707235623317" tabindex="0" loading="lazy"><figcaption>image-20220707235623317</figcaption></figure><p>将<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.dao.WareSkuDao</code>接口的<code>getSkuStock</code>抽象方法的<code>long getSkuStock(Long skuId);</code>替换为<code>Long getSkuStock(Long skuId);</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.4.2.png" alt="image-20220707235655755" tabindex="0" loading="lazy"><figcaption>image-20220707235655755</figcaption></figure><h5 id="_5、超时异常" tabindex="-1"><a class="header-anchor" href="#_5、超时异常" aria-hidden="true">#</a> 5、超时异常</h5><p>这时如果点击<code>GulimallProductApplication</code>服务，这时 报的是超时异常而不是原本的异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>detailMessage = &quot;Read timed out executing POST http://gulimall-ware/ware/waresku/hasStock&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.2.5.png" alt="image-20220707235900319" tabindex="0" loading="lazy"><figcaption>image-20220707235900319</figcaption></figure><h4 id="_3、再次测试" tabindex="-1"><a class="header-anchor" href="#_3、再次测试" aria-hidden="true">#</a> 3、再次测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><h5 id="_1、打断点" tabindex="-1"><a class="header-anchor" href="#_1、打断点" aria-hidden="true">#</a> 1、打断点</h5><p>取消<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法的<code>List&lt;Long&gt; skuIdList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</code>前面的断点，并在<code>List&lt;Long&gt; skuIdList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</code>这里打一个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.1.png" alt="image-20220708093113446" tabindex="0" loading="lazy"><figcaption>image-20220708093113446</figcaption></figure><h5 id="_2、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_2、点击resume-program" aria-hidden="true">#</a> 2、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>List&lt;Long&gt; skuIdList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</code>这个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.2.png" alt="image-20220708093411154" tabindex="0" loading="lazy"><figcaption>image-20220708093411154</figcaption></figure><h5 id="_3、点击step-over-步过-按钮" tabindex="-1"><a class="header-anchor" href="#_3、点击step-over-步过-按钮" aria-hidden="true">#</a> 3、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>List&lt;Long&gt; skuIdList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</code></p><p>把<code>SkuInfoEntity</code>集合的<code>skuId</code>收集起来，准备发送给远程的<code>GulimallWareApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.3.png" alt="image-20220708093446974" tabindex="0" loading="lazy"><figcaption>image-20220708093446974</figcaption></figure><h5 id="_4、跳转到gulimall-ware模块" tabindex="-1"><a class="header-anchor" href="#_4、跳转到gulimall-ware模块" aria-hidden="true">#</a> 4、跳转到<code>gulimall-ware</code>模块</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，就来到了<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>List&lt;SkuHasStockTo&gt; skuHasStocks = wareSkuService.getSkuHasStock(skuIds);</code>这条语句</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.4.png" alt="image-20220708093542485" tabindex="0" loading="lazy"><figcaption>image-20220708093542485</figcaption></figure><h5 id="_5、又跳转到异常了" tabindex="-1"><a class="header-anchor" href="#_5、又跳转到异常了" aria-hidden="true">#</a> 5、又跳转到异常了</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句，又跳转到异常了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.5.png" alt="image-20220708093714853" tabindex="0" loading="lazy"><figcaption>image-20220708093714853</figcaption></figure><h5 id="_6、空指针异常" tabindex="-1"><a class="header-anchor" href="#_6、空指针异常" aria-hidden="true">#</a> 6、空指针异常</h5><p>再次点点击<code>Resume Program</code>或按<code>F9</code>放行这些异常处理类，可以看到报了空指针异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span><span class="token operator">:</span> <span class="token keyword">null</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>WareSkuServiceImpl</span><span class="token punctuation">.</span>lambda$getSkuHasStock$<span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">WareSkuServiceImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">114</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.6.png" alt="image-20220708093842030" tabindex="0" loading="lazy"><figcaption>image-20220708093842030</figcaption></figure><h5 id="_7、修改getskuhasstock方法" tabindex="-1"><a class="header-anchor" href="#_7、修改getskuhasstock方法" aria-hidden="true">#</a> 7、修改<code>getSkuHasStock</code>方法</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>getSkuHasStock</code>方法里</p><p><code>vo.setHasStock(count &gt; 0);</code>这条语句，由于刚刚没有查询到库存信息，所以<code>null &gt; 0</code>由于<code>null</code>不能和<code>0</code>相比，所以就报异常了</p><p>修改<code>vo.setHasStock(count &gt; 0);</code>为<code>vo.setHasStock(count != null &amp;&amp; count &gt; 0);</code>即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.3.7.png" alt="image-20220708094222616" tabindex="0" loading="lazy"><figcaption>image-20220708094222616</figcaption></figure><h4 id="_4、重新测试" tabindex="-1"><a class="header-anchor" href="#_4、重新测试" aria-hidden="true">#</a> 4、重新测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><h5 id="_1、运行到getskuhasstock方法" tabindex="-1"><a class="header-anchor" href="#_1、运行到getskuhasstock方法" aria-hidden="true">#</a> 1、运行到<code>getSkuHasStock</code>方法</h5><p>不断点击<code>Resume Program</code>和<code>Step Over</code>按钮，一直运行到<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>List&lt;SkuHasStockTo&gt; skuHasStocks = wareSkuService.getSkuHasStock(skuIds);</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.1.png" alt="image-20220708094834762" tabindex="0" loading="lazy"><figcaption>image-20220708094834762</figcaption></figure><h5 id="_2、打两个断点" tabindex="-1"><a class="header-anchor" href="#_2、打两个断点" aria-hidden="true">#</a> 2、打两个断点</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>getSkuHasStock</code>方法的<code>List&lt;SkuHasStockTo&gt; collect = skuIds.stream().map(skuId -&gt; {</code>和<code>vo.setHasStock(count != null &amp;&amp; count &gt; 0);</code>这里共打两个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.2.png" alt="image-20220708094940007" tabindex="0" loading="lazy"><figcaption>image-20220708094940007</figcaption></figure><h5 id="_3、点击step-over按钮" tabindex="-1"><a class="header-anchor" href="#_3、点击step-over按钮" aria-hidden="true">#</a> 3、点击<code>Step Over</code>按钮</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>可以看到，已经运行到<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>getSkuHasStock</code>方法的<code>List&lt;SkuHasStockTo&gt; collect = skuIds.stream().map(skuId -&gt; {</code>这里了</p><p><code>skuIds</code>的数据也正确传过来了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.3.png" alt="image-20220708095122328" tabindex="0" loading="lazy"><figcaption>image-20220708095122328</figcaption></figure><h5 id="_4、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_4、点击resume-program" aria-hidden="true">#</a> 4、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>vo.setHasStock(count != null &amp;&amp; count &gt; 0);</code>这里</p><p>此时<code>vo</code>的<code>skuId</code>已赋值进去了，<code>hasStock</code>还为<code>null</code>(这里的<code>vo</code>其实应该改名为<code>to</code>)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.4.png" alt="image-20220708095418795" tabindex="0" loading="lazy"><figcaption>image-20220708095418795</figcaption></figure><h5 id="_5、点击step-over按钮" tabindex="-1"><a class="header-anchor" href="#_5、点击step-over按钮" aria-hidden="true">#</a> 5、点击<code>Step Over</code>按钮</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>这时<code>vo</code>的<code>hasStock</code>已经正确赋值了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.5.png" alt="image-20220708095438279" tabindex="0" loading="lazy"><figcaption>image-20220708095438279</figcaption></figure><h5 id="_6、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_6、点击resume-program" aria-hidden="true">#</a> 6、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>skuId</code>为<code>2</code>的<code>SkuHasStockTo vo = new SkuHasStockTo();</code>这里</p><p>再次点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>skuId</code>为<code>2</code>的<code>vo.setHasStock(count != null &amp;&amp; count &gt; 0);</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.6.png" alt="image-20220708095724506" tabindex="0" loading="lazy"><figcaption>image-20220708095724506</figcaption></figure><h5 id="_7、点击step-over按钮" tabindex="-1"><a class="header-anchor" href="#_7、点击step-over按钮" aria-hidden="true">#</a> 7、点击<code>Step Over</code>按钮</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>这时<code>skuId</code>为<code>2</code>的<code>vo</code>的<code>hasStock</code>已经正确赋值了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.7.png" alt="image-20220708095645706" tabindex="0" loading="lazy"><figcaption>image-20220708095645706</figcaption></figure><h5 id="_8、取消断点并打新断点" tabindex="-1"><a class="header-anchor" href="#_8、取消断点并打新断点" aria-hidden="true">#</a> 8、取消断点并打新断点</h5><p>取消<code>vo.setHasStock(count != null &amp;&amp; count &gt; 0);</code>上的断点，并在<code>return vo;</code>上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.8.png" alt="image-20220708095851633" tabindex="0" loading="lazy"><figcaption>image-20220708095851633</figcaption></figure><h5 id="_9、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_9、点击resume-program" aria-hidden="true">#</a> 9、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>skuId</code>为<code>3</code>的<code>return vo;</code>这里</p><p>这时<code>skuId</code>为<code>3</code>的<code>vo</code>的<code>skuId</code>和<code>hasStock</code>已经正确赋值了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.9.png" alt="image-20220708100126026" tabindex="0" loading="lazy"><figcaption>image-20220708100126026</figcaption></figure><h5 id="_10、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_10、点击resume-program" aria-hidden="true">#</a> 10、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>skuId</code>为<code>4</code>的<code>return vo;</code>这里</p><p>这时<code>skuId</code>为<code>4</code>的<code>vo</code>的<code>skuId</code>和<code>hasStock</code>已经正确赋值了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.10.png" alt="image-20220708100204156" tabindex="0" loading="lazy"><figcaption>image-20220708100204156</figcaption></figure><h5 id="_11、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_11、点击resume-program" aria-hidden="true">#</a> 11、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>skuId</code>为<code>4</code>的<code>return vo;</code>这里</p><p>这时<code>skuId</code>为<code>4</code>的<code>vo</code>的<code>skuId</code>和<code>hasStock</code>已经正确赋值了，此时的<code>hasStock</code>的值为<code>false</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.11.png" alt="image-20220708100302122" tabindex="0" loading="lazy"><figcaption>image-20220708100302122</figcaption></figure><h5 id="_12、取消wareskuserviceimpl类的断点" tabindex="-1"><a class="header-anchor" href="#_12、取消wareskuserviceimpl类的断点" aria-hidden="true">#</a> 12、取消<code>WareSkuServiceImpl</code>类的断点</h5><p>取消<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>getSkuHasStock</code>方法的<code>return vo;</code>这个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.12.png" alt="image-20220708101101798" tabindex="0" loading="lazy"><figcaption>image-20220708101101798</figcaption></figure><h5 id="_13、在wareskucontroller类打断点" tabindex="-1"><a class="header-anchor" href="#_13、在wareskucontroller类打断点" aria-hidden="true">#</a> 13、在<code>WareSkuController</code>类打断点</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>return new RS&lt;&gt;(skuHasStocks);</code>这里打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.13.png" alt="image-20220708100911243" tabindex="0" loading="lazy"><figcaption>image-20220708100911243</figcaption></figure><h5 id="_14、对比数据" tabindex="-1"><a class="header-anchor" href="#_14、对比数据" aria-hidden="true">#</a> 14、对比数据</h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>skuId</code>为<code>4</code>的<code>return new RS&lt;&gt;(skuHasStocks);</code>这里</p><p>可以看到<code>skuHasStocks</code>对象的<code>elementData</code>里已经封装了这些数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.14.1.png" alt="image-20220708101241138" tabindex="0" loading="lazy"><figcaption>image-20220708101241138</figcaption></figure><p>这些数据与<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表里数据一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.14.2.png" alt="image-20220708100724041" tabindex="0" loading="lazy"><figcaption>image-20220708100724041</figcaption></figure><h5 id="_15、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_15、点击resume-program" aria-hidden="true">#</a> 15、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，放行<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法，准备跳转到<code>gulimall-product</code>模块</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.8.4.15.png" alt="image-20220708101546784" tabindex="0" loading="lazy"><figcaption>image-20220708101546784</figcaption></figure><h3 id="_5-2-9、测试-3" tabindex="-1"><a class="header-anchor" href="#_5-2-9、测试-3" aria-hidden="true">#</a> 5.2.9、测试（3）</h3><h4 id="_1、准备工作-2" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-2" aria-hidden="true">#</a> 1、准备工作</h4><h5 id="_1、超时异常" tabindex="-1"><a class="header-anchor" href="#_1、超时异常" aria-hidden="true">#</a> 1、超时异常</h5><p>点击<code>Services</code>里的<code>GulimallProductApplication</code>服务，这时已经报了超时异常</p><p>这是因为刚刚调试用了很多时间，所以出现了超时异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>detailMessage =&quot;Read timed out executing POST http://gulimall-ware/ware/waresku/hasStock&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.1.1.png" alt="image-20220708101743116" tabindex="0" loading="lazy"><figcaption>image-20220708101743116</figcaption></figure><h5 id="_2、去掉ware模块的所有断点" tabindex="-1"><a class="header-anchor" href="#_2、去掉ware模块的所有断点" aria-hidden="true">#</a> 2、去掉<code>ware</code>模块的所有断点</h5><p>去掉<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法上的全部断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.1.2.1.png" alt="image-20220708102010977" tabindex="0" loading="lazy"><figcaption>image-20220708102010977</figcaption></figure><p>去掉<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>getSkuHasStock</code>方法的所有断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.1.2.2.png" alt="image-20220708102029537" tabindex="0" loading="lazy"><figcaption>image-20220708102029537</figcaption></figure><h4 id="_2、再次测试-1" tabindex="-1"><a class="header-anchor" href="#_2、再次测试-1" aria-hidden="true">#</a> 2、再次测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><h5 id="_1、准备远程调用" tabindex="-1"><a class="header-anchor" href="#_1、准备远程调用" aria-hidden="true">#</a> 1、准备远程调用</h5><p>这次直接来到了<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法的<code>List&lt;Long&gt; skuIdList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</code>上</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.1.png" alt="image-20220708111049704" tabindex="0" loading="lazy"><figcaption>image-20220708111049704</figcaption></figure><h5 id="_2、isskustock还是为null" tabindex="-1"><a class="header-anchor" href="#_2、isskustock还是为null" aria-hidden="true">#</a> 2、<code>isSkuStock</code>还是为<code>null</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行完远程调用，来到<code>Map&lt;Long, Boolean&gt; finalIsSkuStock = isSkuStock;</code>这里，可以看到<code>isSkuStock</code>还是为<code>null</code>，很明显写的还是有问题，这里先不管，继续向后执行</p><p>在<code>SkuEsModel skuEsModel = new SkuEsModel();</code>上打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.2.png" alt="image-20220708111244017" tabindex="0" loading="lazy"><figcaption>image-20220708111244017</figcaption></figure><h5 id="_3、打个断点" tabindex="-1"><a class="header-anchor" href="#_3、打个断点" aria-hidden="true">#</a> 3、打个断点</h5><p>点击<code>Resume Program</code>或按<code>F9</code>，来到<code>SkuEsModel skuEsModel = new SkuEsModel();</code>这里</p><p>在<code>return skuEsModel;</code>这行打个断点（不要点击放行）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.3.png" alt="image-20220708111748174" tabindex="0" loading="lazy"><figcaption>image-20220708111748174</figcaption></figure><h5 id="_4、点击两次step-over-步过-按钮" tabindex="-1"><a class="header-anchor" href="#_4、点击两次step-over-步过-按钮" aria-hidden="true">#</a> 4、点击两次<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮两次，执行当前方法的下两个语句</p><p>来到<code>boolean hasStock = false;</code>这里，可以看到<code>skuInfoEntity</code>里与<code>skuEsModel</code>相同名称的属性已经拷到<code>skuEsModel</code>里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.4.1.png" alt="image-20220708153005034" tabindex="0" loading="lazy"><figcaption>image-20220708153005034</figcaption></figure><p>这与<code>gulimall_pms</code>数据库的<code>pms_sku_info</code>表的<code>sku_id</code>为<code>1</code>的数据一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.4.2.png" alt="image-20220708175924627" tabindex="0" loading="lazy"><figcaption>image-20220708175924627</figcaption></figure><h5 id="_5、finalisskustock也为null" tabindex="-1"><a class="header-anchor" href="#_5、finalisskustock也为null" aria-hidden="true">#</a> 5、<code>finalIsSkuStock</code>也为<code>null</code></h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>由于<code>isSkuStock</code>为<code>null</code>，所以<code>finalIsSkuStock</code>也为<code>null</code>，因此<code>if (finalIsSkuStock ==null || !finalIsSkuStock.containsKey(skuInfoEntity.getSkuId())){</code>的第一的条件成立，默认被设置成了有库存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.5.png" alt="image-20220708153339881" tabindex="0" loading="lazy"><figcaption>image-20220708153339881</figcaption></figure><h5 id="_6、hasstock属性已修改为true" tabindex="-1"><a class="header-anchor" href="#_6、hasstock属性已修改为true" aria-hidden="true">#</a> 6、<code>hasStock</code>属性已修改为<code>true</code></h5><p>一直点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的后面语句</p><p>执行到<code>skuEsModel.setHotScore(0L);</code>这里可以看到，<code>skuEsModel</code>的<code>hasStock</code>属性已修改为<code>true</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.6.png" alt="image-20220708153624248" tabindex="0" loading="lazy"><figcaption>image-20220708153624248</figcaption></figure><h5 id="_7、点击step-over" tabindex="-1"><a class="header-anchor" href="#_7、点击step-over" aria-hidden="true">#</a> 7、点击<code>Step Over</code></h5><p>一直点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的后面语句</p><p>执行到<code>CategoryEntity categoryEntity = categoryService.getById(skuInfoEntity.getCatalogId());</code>这里</p><p>可以看到<code>BrandEntity brandEntity = brandService.getById(skuInfoEntity.getBrandId());</code>这行语句已经查询出数据了，到这里已经正确把<code>brandEntity</code>对象的<code>name</code>属性和<code>logo</code>属性赋值给<code>skuEsModel</code>的<code>brandName</code>属性和<code>brandImg</code>属性</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.7.png" alt="image-20220708153826145" tabindex="0" loading="lazy"><figcaption>image-20220708153826145</figcaption></figure><h5 id="_8、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_8、点击resume-program" aria-hidden="true">#</a> 8、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>return skuEsModel;</code>这里</p><p>可以看到<code>skuEsModel</code>对象的<code>catalogName</code>属性和<code>attrs</code>属性也正确赋值了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.8.png" alt="image-20220708175616139" tabindex="0" loading="lazy"><figcaption>image-20220708175616139</figcaption></figure><h5 id="_9、重新打断点" tabindex="-1"><a class="header-anchor" href="#_9、重新打断点" aria-hidden="true">#</a> 9、重新打断点</h5><p>取消<code>SkuEsModel skuEsModel = new SkuEsModel();</code>这个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.9.1.png" alt="image-20220708203000435" tabindex="0" loading="lazy"><figcaption>image-20220708203000435</figcaption></figure><p>取消<code>return skuEsModel;</code>这个断点，并在<code>R r = searchFeignService.productStatusUp(collect);</code>这里打上断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.9.2.png" alt="image-20220708203031998" tabindex="0" loading="lazy"><figcaption>image-20220708203031998</figcaption></figure><h5 id="_10、点击resume-program-1" tabindex="-1"><a class="header-anchor" href="#_10、点击resume-program-1" aria-hidden="true">#</a> 10、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>R r = searchFeignService.productStatusUp(collect);</code>这里</p><p>可以看到已经把<code>SkuEsModel</code>集合收集到<code>collect</code>里了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.2.10.png" alt="image-20220708203518101" tabindex="0" loading="lazy"><figcaption>image-20220708203518101</figcaption></figure><h4 id="_3、进入feign源码" tabindex="-1"><a class="header-anchor" href="#_3、进入feign源码" aria-hidden="true">#</a> 3、进入<code>feign</code>源码</h4><h5 id="_1、点击step-into" tabindex="-1"><a class="header-anchor" href="#_1、点击step-into" aria-hidden="true">#</a> 1、点击<code>Step Into</code></h5><p>点击<code>Step Into</code>或按<code> F7</code>，进入<code>R r = searchFeignService.productStatusUp(collect);</code>方法内部，查看<code>feign</code>的调用过程</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.1.png" alt="image-20220708203549286" tabindex="0" loading="lazy"><figcaption>image-20220708203549286</figcaption></figure><h5 id="_2、判断方法名称" tabindex="-1"><a class="header-anchor" href="#_2、判断方法名称" aria-hidden="true">#</a> 2、判断方法名称</h5><p>在<code>feign-core-10.2.3</code>jar包的<code>feign.ReflectiveFeign</code>类里的<code>invoke</code>方法里面</p><p>首先判断这个方法是不是<code>equals</code>、 <code>hashCode</code> 、<code>toString</code>，如果是这些方法直接调用本类(<code>feign.ReflectiveFeign</code>类)的这些方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.2.1.png" alt="image-20220708203837672" tabindex="0" loading="lazy"><figcaption>image-20220708203837672</figcaption></figure><p>传入的<code>Method</code>方法的完整内容如下所示，可以看到<code>name</code>属性的值为<code>productStatusUp</code>，并不是这些方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.2.2.png" alt="image-20220709154435437" tabindex="0" loading="lazy"><figcaption>image-20220709154435437</figcaption></figure><h5 id="_3、准备跳到同步方法处理器" tabindex="-1"><a class="header-anchor" href="#_3、准备跳到同步方法处理器" aria-hidden="true">#</a> 3、准备跳到同步方法处理器</h5><p>一直点击<code>Step Over</code>按钮步过，到<code>return &quot;toString&quot;.equals(method.getName()) ? this.toString() : ((MethodHandler)this.dispatch.get(method)).invoke(args);</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.3.png" alt="image-20220708204842140" tabindex="0" loading="lazy"><figcaption>image-20220708204842140</figcaption></figure><h5 id="_4、跳到同步方法处理器" tabindex="-1"><a class="header-anchor" href="#_4、跳到同步方法处理器" aria-hidden="true">#</a> 4、跳到同步方法处理器</h5><p>点击<code>Step Into</code>或按<code> F7</code>，进入<code>((MethodHandler)this.dispatch.get(method)).invoke(args);</code>里面</p><p>这是跳到了<code>SynchronousMethodHandler</code>类的内部(同步方法处理器)</p><p>传入的<code>Object[] argv</code>参数的<code>argv[0]</code>的数据为远程调用的<code>collect</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.4.png" alt="image-20220708205331533" tabindex="0" loading="lazy"><figcaption>image-20220708205331533</figcaption></figure><h5 id="_5、构造请求模块" tabindex="-1"><a class="header-anchor" href="#_5、构造请求模块" aria-hidden="true">#</a> 5、构造请求模块</h5><p>在<code>feign-core-10.2.3</code>jar包的<code>feign.SynchronousMethodHandler</code>类的<code>invoke</code>方法里的</p><p><code>RequestTemplate template = this.buildTemplateFromArgs.create(argv);</code></p><p>这里构造了一个请求模板，用于封装发送请求的信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.5.png" alt="image-20220708205636852" tabindex="0" loading="lazy"><figcaption>image-20220708205636852</figcaption></figure><h5 id="_6、template对象属性" tabindex="-1"><a class="header-anchor" href="#_6、template对象属性" aria-hidden="true">#</a> 6、<code>template</code>对象属性</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句,跳到<code>Retryer retryer = this.retryer.clone();</code>这里</p><p><code>template</code>对象含有以下属性</p><p><code>uriTemplate = &quot;/search/save/product&quot;</code> 指出要请求的路径</p><p><code>method = &quot;POST&quot;</code> 指出请求方式为<code>POST</code></p><p><code>charset = &quot;UTF-8&quot;</code> 设置字符编码为<code>UTF-8</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.6.png" alt="image-20220708205926976" tabindex="0" loading="lazy"><figcaption>image-20220708205926976</figcaption></figure><h5 id="_7、查看template对象的data字段" tabindex="-1"><a class="header-anchor" href="#_7、查看template对象的data字段" aria-hidden="true">#</a> 7、查看<code>template</code>对象的<code>data</code>字段</h5><p>点击<code>template</code> -&gt; <code>body</code> -&gt; <code>data</code> 右键选择<code>View as</code> -&gt; <code>String</code>，即可查看<code>template</code>对象的<code>body</code>属性的<code>data</code>字段的数据</p><p>可以发现<code>feign</code>在底层会将数据转成<code>json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.7.1.png" alt="GIF 2022-7-8 21-02-23" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-8 21-02-23</figcaption></figure><p>点击<code>data</code>属性右侧的<code>...View</code>，即可查看详细<code>json</code>，以下是这个<code>json</code>的详细数据</p><p><a href="code/5.2.9.3.7.json">点击查看完整json</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.7.2.png" alt="image-20220708210554513" tabindex="0" loading="lazy"><figcaption>image-20220708210554513</figcaption></figure><h5 id="_8、拿到重试器" tabindex="-1"><a class="header-anchor" href="#_8、拿到重试器" aria-hidden="true">#</a> 8、拿到重试器</h5><p><code>Retryer retryer = this.retryer.clone();</code>这里拿到了一个重试器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.8.png" alt="image-20220708210754661" tabindex="0" loading="lazy"><figcaption>image-20220708210754661</figcaption></figure><h5 id="_9、准备执行和解码" tabindex="-1"><a class="header-anchor" href="#_9、准备执行和解码" aria-hidden="true">#</a> 9、准备执行和解码</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>return this.executeAndDecode(template);</code> 执行和解码</p><p>这行代码会远程执行请求，然后将响应拿过来，将响应数据解码</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.9.png" alt="image-20220708211052256" tabindex="0" loading="lazy"><figcaption>image-20220708211052256</figcaption></figure><h5 id="_10、点击step-into" tabindex="-1"><a class="header-anchor" href="#_10、点击step-into" aria-hidden="true">#</a> 10、点击<code>Step Into</code></h5><p>点击<code>Step Into</code>或按<code> F7</code>，进入<code>return this.executeAndDecode(template);</code>这个调用的方法内部</p><p><code>Request request = this.targetRequest(template);</code></p><p>使用刚刚创建的<code>template</code>构造一个目标请求</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.10.png" alt="image-20220708211538439" tabindex="0" loading="lazy"><figcaption>image-20220708211538439</figcaption></figure><h5 id="_11、有日志时会记录日志" tabindex="-1"><a class="header-anchor" href="#_11、有日志时会记录日志" aria-hidden="true">#</a> 11、有日志时会记录日志</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>if (this.logLevel != Level.NONE) {</code></p><p>这里如果有日志的话，也会记录日志</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.11.png" alt="image-20220708211656257" tabindex="0" loading="lazy"><figcaption>image-20220708211656257</figcaption></figure><h5 id="_12、点击step-over-步过-按钮" tabindex="-1"><a class="header-anchor" href="#_12、点击step-over-步过-按钮" aria-hidden="true">#</a> 12、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>long start = System.nanoTime();</code></p><p>获取开始时间</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>返回正在运行的Java虚拟机的高分辨率时间源的当前值，以纳秒为单位。

此方法只能用于测量经过的时间，并且与系统或挂钟时间的任何其他概念无关。返回的值表示纳秒，因为某些固定的任意原点时间 （可能在将来，因此值可能为负）。

在Java虚拟机的实例中，所有对此方法的调用都使用相同的原点;其他虚拟机实例可能使用不同的来源。 此方法提供纳秒级精度，但不一定是纳秒级分辨率（即，值的变化频率） - 除了分辨率至少与currentTimeMillis（）的分辨率一样好之外，不做任何保证。

连续调用的差异超过大约292年（2^63纳秒）将无法正确计算由于数值溢出而导致的经过时间。 只有在计算在Java虚拟机的同一实例中获得的两个此类值之间的差异时，此方法返回的值才有意义。

例如，要测量某些代码执行所需的时间：

long startTime = System.nanoTime（）; 
// ...正在测量的代码...... 
long estimatedTime = System.nanoTime（） -  startTime; 
比较两个nanoTime值 
long t0 = System.nanoTime（）; ... long t1 = System.nanoTime（）;

一个应该使用t1 - t0 &lt;0，而不是t1 &lt;t0，因为数字溢出的可能性.

Returns：正在运行的Java虚拟机的高分辨率时间源的当前值，以纳秒为单位

从以下版本开始：1.5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.12.png" alt="image-20220708211852923" tabindex="0" loading="lazy"><figcaption>image-20220708211852923</figcaption></figure><h5 id="_13、负载均衡的feign客户端" tabindex="-1"><a class="header-anchor" href="#_13、负载均衡的feign客户端" aria-hidden="true">#</a> 13、负载均衡的<code>feign</code>客户端</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>response = this.client.execute(request, this.options);</code>这里就是正真的执行</p><p><code>this.client</code>为<code>LoadBalancerFeignClient</code> 负载均衡的<code>feign</code>客户端，会正真负载均衡的执行这个请求，该调用哪个服务就调用那个服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.13.png" alt="image-20220708212126573" tabindex="0" loading="lazy"><figcaption>image-20220708212126573</figcaption></figure><h5 id="_14、发送http请求" tabindex="-1"><a class="header-anchor" href="#_14、发送http请求" aria-hidden="true">#</a> 14、发送http请求</h5><p>这个执行请求的过程就是发送http请求的过程，这里就不看了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.3.14.png" alt="image-20220708212437193" tabindex="0" loading="lazy"><figcaption>image-20220708212437193</figcaption></figure><h4 id="_4、来到search项目" tabindex="-1"><a class="header-anchor" href="#_4、来到search项目" aria-hidden="true">#</a> 4、来到<code>search</code>项目</h4><h5 id="_1、进入elasticsavecontroller类" tabindex="-1"><a class="header-anchor" href="#_1、进入elasticsavecontroller类" aria-hidden="true">#</a> 1、进入<code>ElasticSaveController</code>类</h5><p>直接点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句，由于<code>response = this.client.execute(request, this.options);</code>方法会调用<code>GulimallSearchApplication</code>服务</p><p>所以就来到了<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.ElasticSaveController</code>类的<code>productStatusUp</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.1.1.png" alt="image-20220708212722260" tabindex="0" loading="lazy"><figcaption>image-20220708212722260</figcaption></figure><p>可以看到<code>skuEsModels</code>已经封装好了数据，这里封装的数据得益于<code>Spring MVC</code></p><p>而发送<code>htpp</code>请求时发送的数据得益于<code>felgn</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.1.2.png" alt="image-20220708213014072" tabindex="0" loading="lazy"><figcaption>image-20220708213014072</figcaption></figure><h5 id="_2、打两个断点-1" tabindex="-1"><a class="header-anchor" href="#_2、打两个断点-1" aria-hidden="true">#</a> 2、打两个断点</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.service.impl.ProductSaveServiceImpl</code>类的<code>productStatusUp</code>方法的<code>BulkRequest bulkRequest = new BulkRequest();</code>和<code>BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);</code>各打一个断点，共打两个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.2.png" alt="image-20220708213547286" tabindex="0" loading="lazy"><figcaption>image-20220708213547286</figcaption></figure><h5 id="_3、点击step-over-步过-按钮-1" tabindex="-1"><a class="header-anchor" href="#_3、点击step-over-步过-按钮-1" aria-hidden="true">#</a> 3、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallSearchApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p><code>b = productSaveService.productStatusUp(skuEsModels);</code></p><p>这里准备调用<code>ProductSaveServiceImpl</code>类的<code>productStatusUp</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.3.png" alt="image-20220708213426117" tabindex="0" loading="lazy"><figcaption>image-20220708213426117</figcaption></figure><h5 id="_4、点击step-into" tabindex="-1"><a class="header-anchor" href="#_4、点击step-into" aria-hidden="true">#</a> 4、点击<code>Step Into</code></h5><p>点击<code>Step Into</code>或按<code> F7</code>，进入<code>b = productSaveService.productStatusUp(skuEsModels);</code>调用的方法内部</p><p>然后就进入<code>ProductSaveServiceImpl</code> 类的<code>productStatusUp</code>方法，这里比较简单就不看了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.4.png" alt="image-20220709192049280" tabindex="0" loading="lazy"><figcaption>image-20220709192049280</figcaption></figure><h5 id="_5、productstatusup方法里打断点" tabindex="-1"><a class="header-anchor" href="#_5、productstatusup方法里打断点" aria-hidden="true">#</a> 5、<code>productStatusUp</code>方法里打断点</h5><p>在<code>gulimall-search</code>模块的<code>com.atguigu.gulimall.search.controller.ElasticSaveController</code>类的<code>productStatusUp</code>方法的<code>if (b){</code>这里打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.5.png" alt="image-20220708213732998" tabindex="0" loading="lazy"><figcaption>image-20220708213732998</figcaption></figure><h5 id="_6、点击resume-program-1" tabindex="-1"><a class="header-anchor" href="#_6、点击resume-program-1" aria-hidden="true">#</a> 6、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，执行到<code>if (b){</code>这里，可以看到此时的<code>b</code>的值为<code>true</code>，证明执行成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.6.png" alt="image-20220709192347080" tabindex="0" loading="lazy"><figcaption>image-20220709192347080</figcaption></figure><h5 id="_7、read-timed-out" tabindex="-1"><a class="header-anchor" href="#_7、read-timed-out" aria-hidden="true">#</a> 7、<code>Read timed out</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，切换到<code>GulimallProductApplication</code>服务，点击控制台就可以看到抛出了读取超时异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Caused by: java.net.SocketTimeoutException: Read timed out
	at java.net.SocketInputStream.socketRead0(Native Method) ~[na:1.8.0_301]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.7.png" alt="image-20220709193327500" tabindex="0" loading="lazy"><figcaption>image-20220709193327500</figcaption></figure><h5 id="_8、总结" tabindex="-1"><a class="header-anchor" href="#_8、总结" aria-hidden="true">#</a> 8、总结</h5><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Feign调用流程
1、构造请求数据，将对象转为json
    RequestTemplate template = buildTemplateFromArgs.create(argv);
2、发送请求进行执行(执行成功会解码响应数据)
    executeAndDecode(template); 
3、执行请求会有重试机制
    while(true){
        try{
            executeAndDecode(template);
        }catch(){
            try{retryer.continueOrPropagate(e);}catch(){throw ex;}
            continue;
        }
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.9.4.8.png" alt="image-20220708215353412" tabindex="0" loading="lazy"><figcaption>image-20220708215353412</figcaption></figure><h3 id="_5-2-10、解决bug" tabindex="-1"><a class="header-anchor" href="#_5-2-10、解决bug" aria-hidden="true">#</a> 5.2.10、解决bug</h3><h4 id="_1、准备工作-3" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-3" aria-hidden="true">#</a> 1、准备工作</h4><h5 id="_1、重新打断点" tabindex="-1"><a class="header-anchor" href="#_1、重新打断点" aria-hidden="true">#</a> 1、重新打断点</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.1.1.1.png" alt="GIF 2022-7-9 19-40-46" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-9 19-40-46</figcaption></figure><p>随便右击一个断点，也可以来到断点管理界面</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.1.1.2.png" alt="GIF 2022-7-9 19-42-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-9 19-42-17</figcaption></figure><h5 id="_2、点击上架" tabindex="-1"><a class="header-anchor" href="#_2、点击上架" aria-hidden="true">#</a> 2、点击<code>上架</code></h5><p>刷新前端项目，然后在<code>商品系统/商品维护/spu管理</code>里的id为<code>2</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.1.2.png" alt="image-20220709194455644" tabindex="0" loading="lazy"><figcaption>image-20220709194455644</figcaption></figure><h4 id="_2、开始测试" tabindex="-1"><a class="header-anchor" href="#_2、开始测试" aria-hidden="true">#</a> 2、开始测试</h4><h5 id="_1、切换到idea" tabindex="-1"><a class="header-anchor" href="#_1、切换到idea" aria-hidden="true">#</a> 1、切换到<code>IDEA</code></h5><p>切换到<code>IDEA</code>，来到<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法</p><p><code>List&lt;SkuInfoEntity&gt; skuInfoEntities = skuInfoService.getSkusBySpuId(spuId);</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.2.1.png" alt="image-20220709194626563" tabindex="0" loading="lazy"><figcaption>image-20220709194626563</figcaption></figure><h5 id="_2、点击resume-program-1" tabindex="-1"><a class="header-anchor" href="#_2、点击resume-program-1" aria-hidden="true">#</a> 2、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，来到<code>RS&lt;List&lt;SkuHasStockTo&gt;&gt; skuHasStock = wareFelginService.getSkuHasStock(skuIdList);</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.2.2.png" alt="image-20220709195040644" tabindex="0" loading="lazy"><figcaption>image-20220709195040644</figcaption></figure><h5 id="_3、点击step-over-步过-按钮-2" tabindex="-1"><a class="header-anchor" href="#_3、点击step-over-步过-按钮-2" aria-hidden="true">#</a> 3、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallSearchApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>可以看到<code>skuHasStock</code>的<code>size = 0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.2.3.1.png" alt="image-20220709195500014" tabindex="0" loading="lazy"><figcaption>image-20220709195500014</figcaption></figure><p>可以看到<code>skuHasStock</code>对象的值为<code>null</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.2.3.2.png" alt="image-20220709194928495" tabindex="0" loading="lazy"><figcaption>image-20220709194928495</figcaption></figure><h5 id="_4、打断点" tabindex="-1"><a class="header-anchor" href="#_4、打断点" aria-hidden="true">#</a> 4、打断点</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>return new RS&lt;&gt;(skuHasStocks);</code>这里打上断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.2.4.png" alt="image-20220709211336697" tabindex="0" loading="lazy"><figcaption>image-20220709211336697</figcaption></figure><h4 id="_3、重新测试-1" tabindex="-1"><a class="header-anchor" href="#_3、重新测试-1" aria-hidden="true">#</a> 3、重新测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><h5 id="_1、点击resume-program" tabindex="-1"><a class="header-anchor" href="#_1、点击resume-program" aria-hidden="true">#</a> 1、点击<code>Resume Program</code></h5><p>点击<code>Resume Program</code>或按<code>F9</code>，来到<code>RS&lt;List&lt;SkuHasStockTo&gt;&gt; skuHasStock = wareFelginService.getSkuHasStock(skuIdList);</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.1.png" alt="image-20220709211517850" tabindex="0" loading="lazy"><figcaption>image-20220709211517850</figcaption></figure><h5 id="_2、点击step-over-步过-按钮" tabindex="-1"><a class="header-anchor" href="#_2、点击step-over-步过-按钮" aria-hidden="true">#</a> 2、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallProductApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>来到<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>return new RS&lt;&gt;(skuHasStocks);</code>这里</p><p>可以看到<code>skuHasStocks</code>已经正确查询出数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.2.png" alt="image-20220709211545815" tabindex="0" loading="lazy"><figcaption>image-20220709211545815</figcaption></figure><h5 id="_3、点击step-into" tabindex="-1"><a class="header-anchor" href="#_3、点击step-into" aria-hidden="true">#</a> 3、点击<code>Step Into</code></h5><p>点击<code>Step Into</code>或按<code> F7</code>，进入<code> return new RS&lt;&gt;(skuHasStocks);</code>调用的方法内部</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.3.png" alt="image-20220709211734493" tabindex="0" loading="lazy"><figcaption>image-20220709211734493</figcaption></figure><h5 id="_4、来到rs类" tabindex="-1"><a class="header-anchor" href="#_4、来到rs类" aria-hidden="true">#</a> 4、来到<code>RS</code>类</h5><p>可以看到来到了<code>gulimall-common</code>模块的<code>com.atguigu.common.utils.RS</code>类的<code>public R2(T t) {</code>这里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.4.png" alt="image-20220709211755779" tabindex="0" loading="lazy"><figcaption>image-20220709211755779</figcaption></figure><h5 id="_5、点击step-over-步过-按钮" tabindex="-1"><a class="header-anchor" href="#_5、点击step-over-步过-按钮" aria-hidden="true">#</a> 5、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句，可以看到<code>this.setData(data);</code></p><p>这里写错了，应该先调用<code>ok()</code>方法，不过这也不影响结果，只是不符合规范，也不会导致获取不到<code>data</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token function">R2</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.5.png" alt="image-20220709211818135" tabindex="0" loading="lazy"><figcaption>image-20220709211818135</figcaption></figure><h5 id="_6、点击step-over-步过-按钮" tabindex="-1"><a class="header-anchor" href="#_6、点击step-over-步过-按钮" aria-hidden="true">#</a> 6、点击<code>Step Over</code>(步过)按钮</h5><p>点击<code>GulimallWareApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句</p><p>执行完<code>public R2(T t) {</code>这个构造器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.6.1.png" alt="image-20220709211832308" tabindex="0" loading="lazy"><figcaption>image-20220709211832308</figcaption></figure><p>可以看到此时该对象的<code>size = 0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.6.2.png" alt="image-20220709211937754" tabindex="0" loading="lazy"><figcaption>image-20220709211937754</figcaption></figure><p>这里没用是因为Jackson对于HashMap类型会有特殊的处理方式，具体来说就是会对类进行向上转型为Map，导致子类的私有属性消失，IDEA以<code>debug</code>方式也看不到这些属性的信息</p><p>父类实现序列化，子类就不需要实现序列化（也相当于实现了序列化），这里存不进去值是因为R的保存属性是一个复杂类型，这个类型（SkuHasStockTo）没有实现序列化接口</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>类继承于map或者list或者set后，在其他对于这个类的操作时需要特别注意，比如，使用fastjson等工具类进行转换成json时将不会转换map、list、set之外的属性。举例，A类继承list后，又在A类中添加了一个name属性，如果将A类转换成json将不会包含A类的属性，就是json中不包含name属性，只会调用list的中的比如迭代器进行遍历list的方式查询list中的数据。如果A类是自己set属性后自己get属性，那么没有影响。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.6.3.png" alt="image-20220709212036439" tabindex="0" loading="lazy"><figcaption>image-20220709212036439</figcaption></figure><h5 id="_7、修改返回的对象" tabindex="-1"><a class="header-anchor" href="#_7、修改返回的对象" aria-hidden="true">#</a> 7、修改返回的对象</h5><h6 id="方法一-不继承hashmap-推荐" tabindex="-1"><a class="header-anchor" href="#方法一-不继承hashmap-推荐" aria-hidden="true">#</a> 方法一：不继承HashMap(推荐)</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.7.1.png" alt="image-20220709223734632" tabindex="0" loading="lazy"><figcaption>image-20220709223734632</figcaption></figure><h6 id="方法二-写get和set方法" tabindex="-1"><a class="header-anchor" href="#方法二-写get和set方法" aria-hidden="true">#</a> 方法二：写<code>get</code>和<code>set</code>方法</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Copyright (c) 2016-2019 人人开源 All rights reserved.
 *
 * https://www.renren.io
 *
 * 版权所有，侵权必究！
 */</span>

<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">TypeReference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">BizCodeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">R2</span> <span class="token keyword">extends</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> tTypeReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> data <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>tTypeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> t<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token function">R2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token punctuation">}</span>

   
   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">SC_INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;未知异常，请联系管理员&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">SC_INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span> bizCodeException<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span>bizCodeException<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bizCodeException<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">R2</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


   <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.7.2.png" alt="image-20220709224139491" tabindex="0" loading="lazy"><figcaption>image-20220709224139491</figcaption></figure><h5 id="_8、修改getskuhasstock方法" tabindex="-1"><a class="header-anchor" href="#_8、修改getskuhasstock方法" aria-hidden="true">#</a> 8、修改<code>getSkuHasStock</code>方法</h5><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法</p><p>并在<code>RS&lt;List&lt;SkuHasStockTo&gt;&gt; rs = new RS&lt;List&lt;SkuHasStockTo&gt;&gt;();</code>打上断点</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hasStock&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span></span> skuHasStocks <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ok <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ok<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>skuHasStocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.3.8.png" alt="image-20220709223901636" tabindex="0" loading="lazy"><figcaption>image-20220709223901636</figcaption></figure><h4 id="_4、重新测试-1" tabindex="-1"><a class="header-anchor" href="#_4、重新测试-1" aria-hidden="true">#</a> 4、重新测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><h5 id="_1、执行到wareskucontroller类" tabindex="-1"><a class="header-anchor" href="#_1、执行到wareskucontroller类" aria-hidden="true">#</a> 1、执行到<code>WareSkuController</code>类</h5><p>不断执行断点，直到执行到<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法的<code>return rs;</code>这里</p><p>可以看到已经正确封装对象了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.4.1.png" alt="image-20220709222958826" tabindex="0" loading="lazy"><figcaption>image-20220709222958826</figcaption></figure><h5 id="_2、超时异常" tabindex="-1"><a class="header-anchor" href="#_2、超时异常" aria-hidden="true">#</a> 2、超时异常</h5><p>点击<code>Services</code>里的<code>GulimallProductApplication</code>服务，这时已经报了超时异常</p><p>这是因为刚刚调试用了很多时间，所以出现了超时异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>detailMessage =&quot;Read timed out executing POST http://gulimall-ware/ware/waresku/hasStock&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.4.2.png" alt="image-20220709223056739" tabindex="0" loading="lazy"><figcaption>image-20220709223056739</figcaption></figure><h5 id="_3、取消ware模块的断点" tabindex="-1"><a class="header-anchor" href="#_3、取消ware模块的断点" aria-hidden="true">#</a> 3、取消<code>ware</code>模块的断点</h5><p>取消<code>RS&lt;List&lt;SkuHasStockTo&gt;&gt; rs = new RS&lt;List&lt;SkuHasStockTo&gt;&gt;();</code>上的断点</p><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类的<code>getSkuHasStock</code>方法，变为更加精简的方式</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hasStock&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span></span> skuHasStocks <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rs<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>skuHasStocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.4.3.png" alt="image-20220709225243977" tabindex="0" loading="lazy"><figcaption>image-20220709225243977</figcaption></figure><h4 id="_5、再次测试" tabindex="-1"><a class="header-anchor" href="#_5、再次测试" aria-hidden="true">#</a> 5、再次测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端页面，再次在<code>商品系统/商品维护/spu管理</code>里的id为<code>1</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类的<code>up</code>方法</p><p>执行完<code>RS&lt;List&lt;SkuHasStockTo&gt;&gt; skuHasStock = wareFelginService.getSkuHasStock(skuIdList);</code></p><p>来到<code>isSkuStock = skuHasStock.getData().stream().collect(Collectors.toMap(SkuHasStockTo::getSkuId, SkuHasStockTo::getHasStock));</code>这里可以看到以成功封装数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.5.png" alt="image-20220709223602905" tabindex="0" loading="lazy"><figcaption>image-20220709223602905</figcaption></figure><h4 id="_6、-整体测试" tabindex="-1"><a class="header-anchor" href="#_6、-整体测试" aria-hidden="true">#</a> 6、 整体测试</h4><p>重新以<code>debug</code>方式启动<code>GulimallProductApplication</code>商品服务和<code>GulimallWareApplication</code>库存服务</p><p>刷新前端项目，然后在<code>商品系统/商品维护/spu管理</code>里的id为<code>2</code>的商品里点击右侧<code>操作</code>里的<code>上架</code></p><p>然后不断点击点击<code>Resume Program</code>或按<code>F9</code>，直到运行结束</p><p>切换到前端，可以看到在<code>商品系统/商品维护/spu管理</code>里的id为<code>2</code>的商品里<code>上架状</code>态已变为<code>已上架</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.2.10.6.gif" alt="GIF 2022-7-9 22-52-19" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-9 22-52-19</figcaption></figure><h2 id="_5-3、商城业务-首页-nginx" tabindex="-1"><a class="header-anchor" href="#_5-3、商城业务-首页-nginx" aria-hidden="true">#</a> 5.3、商城业务-首页&amp;nginx</h2><h3 id="_5-3-1、打开首页" tabindex="-1"><a class="header-anchor" href="#_5-3-1、打开首页" aria-hidden="true">#</a> 5.3.1、打开首页</h3><h4 id="_1、引入依赖" tabindex="-1"><a class="header-anchor" href="#_1、引入依赖" aria-hidden="true">#</a> 1、引入依赖</h4><h5 id="_1、引入thymeleaf依赖" tabindex="-1"><a class="header-anchor" href="#_1、引入thymeleaf依赖" aria-hidden="true">#</a> 1、引入<code>thymeleaf</code>依赖</h5><p>在<code>gulimall-product</code>模块的<code>pom.xml</code>文件里引入<code>thymeleaf</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--模板引擎：thymeleaf--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.1.png" alt="image-20220709230519121" tabindex="0" loading="lazy"><figcaption>image-20220709230519121</figcaption></figure><h5 id="_2、引入devtools依赖" tabindex="-1"><a class="header-anchor" href="#_2、引入devtools依赖" aria-hidden="true">#</a> 2、引入<code>devtools</code>依赖</h5><p>在<code>gulimall-product</code>模块的<code>pom.xml</code>文件里引入<code>devtools</code>依赖，该依赖可以在不重启服务的情况下动态刷新静态资源</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>devtools<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.1</span><span class="token number">.5</span><span class="token punctuation">.</span><span class="token constant">RELEASE</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>optional<span class="token punctuation">&gt;</span></span><span class="token boolean">true</span><span class="token operator">&lt;</span><span class="token operator">/</span>optional<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.2.1.png" alt="image-20220710213439204" tabindex="0" loading="lazy"><figcaption>image-20220710213439204</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Build Project</code> 或按快捷键<code>Ctrl+F9</code>，可以刷新<code>gulimall-product</code>项目的静态文件</p><p>(刷新java代码会有一些问题，修改代码后建议重新运行项目)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.2.2.png" alt="image-20220713152927981" tabindex="0" loading="lazy"><figcaption>image-20220713152927981</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &quot;index.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，可以重新编译当前静态文件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.2.3.png" alt="image-20220713152941970" tabindex="0" loading="lazy"><figcaption>image-20220713152941970</figcaption></figure><h5 id="_3、去掉版本后报错" tabindex="-1"><a class="header-anchor" href="#_3、去掉版本后报错" aria-hidden="true">#</a> 3、去掉版本后报错</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--模板引擎：thymeleaf--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>去掉<code>thymeleaf</code>依赖和<code>devtools</code>依赖的<code>&lt;version&gt;2.1.5.RELEASE&lt;/version&gt;</code>后保存</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Failed to read artifact descriptor for org.springframework.boot:spring-boot-starter-thymeleaf:jar:2.1.8.RELEASE

无法读取 org.springframework.boot:spring-boot-starter-thymeleaf:jar:2.1.8.RELEASE 的工件描述符
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.3.png" alt="image-20220710213937773" tabindex="0" loading="lazy"><figcaption>image-20220710213937773</figcaption></figure><h5 id="_4、clean-install" tabindex="-1"><a class="header-anchor" href="#_4、clean-install" aria-hidden="true">#</a> 4、<code>clean</code>&amp;<code>install</code></h5><h6 id="_1、点击clean" tabindex="-1"><a class="header-anchor" href="#_1、点击clean" aria-hidden="true">#</a> 1、点击<code>clean</code></h6><p>点击<code>IDEA</code>右侧的<code>Maven</code>，选择<code>gulimall-product</code>，点击<code>Lifecycle</code>(生命周期)，点击<code>clean</code>删除由项目编译创建的target文件夹</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.1.png" alt="image-20220710214543669" tabindex="0" loading="lazy"><figcaption>image-20220710214543669</figcaption></figure><h6 id="_2、点击install" tabindex="-1"><a class="header-anchor" href="#_2、点击install" aria-hidden="true">#</a> 2、点击<code>install</code></h6><p>点击<code>IDEA</code>右侧的<code>Maven</code>，选择<code>gulimall-product</code>，点击<code>Lifecycle</code>(生命周期)，点击<code>install</code></p><p>将当前项目jar包安装（放置）至Maven的本地仓库中。供其他项目使用</p><p>此时报了一个错</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Error:(5,32) java: 程序包com.atguigu.common.valid不存在
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.2.png" alt="image-20220710214556143" tabindex="0" loading="lazy"><figcaption>image-20220710214556143</figcaption></figure><h6 id="_3、查看依赖" tabindex="-1"><a class="header-anchor" href="#_3、查看依赖" aria-hidden="true">#</a> 3、查看依赖</h6><p>点击<code>IDEA</code>右侧的<code>Maven</code>，选择<code>gulimall-product</code>，点击<code>Dependencies</code>，可以看到<code>com.atquiqu.qulimall:qulimall-common:0.0.1-SNAPSHOT</code>报红了，所有找不到<code>com.atguigu.common.valid</code>包</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.3.png" alt="image-20220710214807199" tabindex="0" loading="lazy"><figcaption>image-20220710214807199</figcaption></figure><h6 id="_4、重新加载" tabindex="-1"><a class="header-anchor" href="#_4、重新加载" aria-hidden="true">#</a> 4、重新加载</h6><p>点击<code>IDEA</code>右侧的<code>Maven</code>，点击刷新按钮<code>Reload All Maven Projects</code>重新加载所有<code>maven</code>项目</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.4.png" alt="image-20220710214849781" tabindex="0" loading="lazy"><figcaption>image-20220710214849781</figcaption></figure><h6 id="_5、再次点击install" tabindex="-1"><a class="header-anchor" href="#_5、再次点击install" aria-hidden="true">#</a> 5、再次点击<code>install</code></h6><p>点击<code>IDEA</code>右侧的<code>Maven</code>，选择<code>gulimall-product</code>，点击<code>Lifecycle</code>(生命周期)，点击<code>install</code></p><p>又报了同样的错误</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Error:(6,32) java: 程序包com.atguigu.common.valid不存在
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.5.png" alt="image-20220710215013118" tabindex="0" loading="lazy"><figcaption>image-20220710215013118</figcaption></figure><h6 id="_6、clean-installcommon模块" tabindex="-1"><a class="header-anchor" href="#_6、clean-installcommon模块" aria-hidden="true">#</a> 6、<code>clean</code>&amp;<code>install</code>common模块</h6><p>如果安装的有<code>Maven Helper</code>插件，可以选择<code>Project</code>里的<code>gulimall-common</code>模块，然后右键选择<code>Run Maven</code> -&gt; <code>clean install</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.6.1.png" alt="image-20220710215207383" tabindex="0" loading="lazy"><figcaption>image-20220710215207383</figcaption></figure><p>该插件如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.6.2.png" alt="image-20220710221643210" tabindex="0" loading="lazy"><figcaption>image-20220710221643210</figcaption></figure><p>或者点击<code>IDEA</code>右侧的<code>Maven</code>，选择<code>gulimall-common</code>，点击<code>Lifecycle</code>(生命周期)，点击<code>clean</code>删除由项目编译创建的target文件夹</p><p>点击<code>install</code>将当前项目jar包安装（放置）至Maven的本地仓库中。供其他项目使用</p><p>这样也可以</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.6.3.png" alt="image-20220710222049450" tabindex="0" loading="lazy"><figcaption>image-20220710222049450</figcaption></figure><h6 id="_7、再次点击install" tabindex="-1"><a class="header-anchor" href="#_7、再次点击install" aria-hidden="true">#</a> 7、再次点击<code>install</code></h6><p>点击<code>IDEA</code>右侧的<code>Maven</code>，选择<code>gulimall-product</code>，点击<code>Lifecycle</code>(生命周期)，点击<code>install</code>，这样就成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.7.png" alt="image-20220710215122624" tabindex="0" loading="lazy"><figcaption>image-20220710215122624</figcaption></figure><h6 id="_8、dependencies报红" tabindex="-1"><a class="header-anchor" href="#_8、dependencies报红" aria-hidden="true">#</a> 8、<code>Dependencies</code>报红</h6><p><code>ponx.ml</code>不报错了，<code>install</code>也成功了，但点击<code>IDEA</code>右侧的<code>Maven</code>可以看到<code>gulimall-product</code>模块的<code>Dependencies</code>里的<code>org.springframework. boot:spring-boot-starter-thymeleaf:2.1 .8.RELEASE</code>和<code>org.springframework.boot:spring-boot-devtools:2.1.8.RELEASE</code>还是报红</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.4.8.png" alt="image-20220710215305153" tabindex="0" loading="lazy"><figcaption>image-20220710215305153</figcaption></figure><h5 id="_5、清除缓存" tabindex="-1"><a class="header-anchor" href="#_5、清除缓存" aria-hidden="true">#</a> 5、清除缓存</h5><p>点击<code>File</code> -&gt; <code>invalidate caches/restart...</code> 清除缓存并重新打开项目</p><p>当<code>maven</code>项目依赖问题怎么都解决不了的时候，这种方式时最有效的</p><p>(还有一种方式是手动安装<code>maven</code>依赖)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.1.5.png" alt="image-20220710220126569" tabindex="0" loading="lazy"><figcaption>image-20220710220126569</figcaption></figure><h4 id="_2、导入资源" tabindex="-1"><a class="header-anchor" href="#_2、导入资源" aria-hidden="true">#</a> 2、导入资源</h4><p>在<code>gulimall-product</code>模块的<code>src/main/resources</code>目录下新建<code>static</code>文件夹和<code>templates</code>文件夹</p><p>把<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\首页资源</code>里的<code>index</code>文件夹及其子文件复制到<code>gulimall-product</code>模块的<code>src/main/resources/static</code>目录里</p><p>把<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\首页资源</code>里的<code>index.html</code>复制到<code>gulimall-product</code>模块的<code>src/main/resources/templates</code>目录里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.2.1.png" alt="image-20220710204122840" tabindex="0" loading="lazy"><figcaption>image-20220710204122840</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.2.2.png" alt="image-20220709230436074" tabindex="0" loading="lazy"><figcaption>image-20220709230436074</figcaption></figure><h4 id="_3、关闭thymeleaf的缓存" tabindex="-1"><a class="header-anchor" href="#_3、关闭thymeleaf的缓存" aria-hidden="true">#</a> 3、关闭thymeleaf的缓存</h4><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加配置，关闭thymeleaf的缓存</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token comment">#关闭thymeleaf的缓存</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/templates/
    <span class="token key atrule">suffix</span><span class="token punctuation">:</span> .html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.3.png" alt="image-20220710204407021" tabindex="0" loading="lazy"><figcaption>image-20220710204407021</figcaption></figure><h4 id="_4、查看前端页面" tabindex="-1"><a class="header-anchor" href="#_4、查看前端页面" aria-hidden="true">#</a> 4、查看前端页面</h4><p>直接通过浏览器访问： http://localhost:10000/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.1.4.png" alt="image-20220710212123458" tabindex="0" loading="lazy"><figcaption>image-20220710212123458</figcaption></figure><h3 id="_5-3-2、查询所有一级分类" tabindex="-1"><a class="header-anchor" href="#_5-3-2、查询所有一级分类" aria-hidden="true">#</a> 5.3.2、查询所有一级分类</h3><h4 id="_1、新建indexcontroller类" tabindex="-1"><a class="header-anchor" href="#_1、新建indexcontroller类" aria-hidden="true">#</a> 1、新建<code>IndexController</code>类</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product</code>包下新建<code>web</code>文件夹，在<code>web</code>文件夹里新建<code>IndexController</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">CategoryEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CategoryService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ui<span class="token punctuation">.</span></span><span class="token class-name">Model</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/10
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CategoryService</span> categoryService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;index.html&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">indexPage</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//查出所有的一级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;categories&quot;</span><span class="token punctuation">,</span>categoryEntities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//classpath:/templates/  + index +   .html</span>
        <span class="token keyword">return</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.1.png" alt="image-20220710210549773" tabindex="0" loading="lazy"><figcaption>image-20220710210549773</figcaption></figure><h4 id="_2、新建getlevel1categories抽象方法" tabindex="-1"><a class="header-anchor" href="#_2、新建getlevel1categories抽象方法" aria-hidden="true">#</a> 2、新建<code>getLevel1Categories</code>抽象方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.CategoryService</code>接口里新建<code>getLevel1Categories</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.2.png" alt="image-20220710210605517" tabindex="0" loading="lazy"><figcaption>image-20220710210605517</figcaption></figure><h4 id="_3、实现getlevel1categories抽象方法" tabindex="-1"><a class="header-anchor" href="#_3、实现getlevel1categories抽象方法" aria-hidden="true">#</a> 3、实现<code>getLevel1Categories</code>抽象方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里实现<code>getLevel1Categories</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getParentCid</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getCatId</span><span class="token punctuation">,</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> categoryEntities<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.3.png" alt="image-20220710225914651" tabindex="0" loading="lazy"><figcaption>image-20220710225914651</figcaption></figure><h4 id="_4、修改ndex-html文件" tabindex="-1"><a class="header-anchor" href="#_4、修改ndex-html文件" aria-hidden="true">#</a> 4、修改<code>ndex.html</code>文件</h4><h5 id="_1、修改ndex-html文件" tabindex="-1"><a class="header-anchor" href="#_1、修改ndex-html文件" aria-hidden="true">#</a> 1、修改<code>ndex.html</code>文件</h5><p>修改<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件</p><p><a href="/gulimall/code/5.3.2.4.1.index.html" class="">点击查看完整<code>index.html</code>代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.4.1.png" alt="image-20220710230624609" tabindex="0" loading="lazy"><figcaption>image-20220710230624609</figcaption></figure><h5 id="_2、使用thymeleaf步骤" tabindex="-1"><a class="header-anchor" href="#_2、使用thymeleaf步骤" aria-hidden="true">#</a> 2、使用<code>thymeleaf</code>步骤</h5><h6 id="_1、引入命名空间" tabindex="-1"><a class="header-anchor" href="#_1、引入命名空间" aria-hidden="true">#</a> 1、引入命名空间</h6><p>把</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>替换为</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.4.2.1.1.png" alt="image-20220710231051879" tabindex="0" loading="lazy"><figcaption>image-20220710231051879</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.4.2.1.2.png" alt="image-20220710231517507" tabindex="0" loading="lazy"><figcaption>image-20220710231517507</figcaption></figure><h6 id="_2、使用th标签" tabindex="-1"><a class="header-anchor" href="#_2、使用th标签" aria-hidden="true">#</a> 2、使用<code>th</code>标签</h6><p>把</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_main_left_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ctg-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>家用电器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_li2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_main_left_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ctg-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2,4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>手机<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> / <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>运营商<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> / <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>数码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_li2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_main_left_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ctg-data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>电脑<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> / <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>办公<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>替换为</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>category : ${categories}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>header_main_left_a<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ctg-data=${category.catId}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${category.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>家用电器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.4.2.2.1.png" alt="image-20220710231249788" tabindex="0" loading="lazy"><figcaption>image-20220710231249788</figcaption></figure><p><code>th:each=&quot;category : ${categories}&quot;</code> 遍历集合<code>categories</code>，每次遍历的单个对象命名为<code>category</code></p><p><code>th:text=&quot;${category.name}&quot;</code>获取<code>category</code>对象的<code>name</code>属性的值，并相当于<code>value</code>属性，替换掉原本标签的内容</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.4.2.2.2.png" alt="image-20220710231657605" tabindex="0" loading="lazy"><figcaption>image-20220710231657605</figcaption></figure><p><code>th:attr=&quot;ctg-data=${category.catId}</code>自定义<code>ctg-data</code>属性，其值为动态获取的<code>category.catId</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.4.2.2.3.png" alt="image-20220710232148285" tabindex="0" loading="lazy"><figcaption>image-20220710232148285</figcaption></figure><h4 id="_5、浏览器访问" tabindex="-1"><a class="header-anchor" href="#_5、浏览器访问" aria-hidden="true">#</a> 5、浏览器访问</h4><p>浏览器访问：http://localhost:10000</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.2.5.png" alt="image-20220710230810485" tabindex="0" loading="lazy"><figcaption>image-20220710230810485</figcaption></figure><h3 id="_5-3-3、渲染二级三级分类数据" tabindex="-1"><a class="header-anchor" href="#_5-3-3、渲染二级三级分类数据" aria-hidden="true">#</a> 5.3.3、渲染二级三级分类数据</h3><h4 id="_1、查看数据的结构" tabindex="-1"><a class="header-anchor" href="#_1、查看数据的结构" aria-hidden="true">#</a> 1、查看数据的结构</h4><h5 id="_1、模拟数据" tabindex="-1"><a class="header-anchor" href="#_1、模拟数据" aria-hidden="true">#</a> 1、模拟数据</h5><p>模拟的数据在<code>gulimall-product</code>模块的<code>src/main/resources/static/index/json/catalog.json</code>文件里，复制该模拟数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.1.1.png" alt="image-20220711084836072" tabindex="0" loading="lazy"><figcaption>image-20220711084836072</figcaption></figure><h5 id="_2、发送请求的文件" tabindex="-1"><a class="header-anchor" href="#_2、发送请求的文件" aria-hidden="true">#</a> 2、发送请求的文件</h5><p>发送请求的文件在<code>gulimall-product</code>模块的在<code>src/main/resources/static/index/js/catalogLoader.js</code>里面。把第二行的<code>$.getJSON(&quot;index/json/catalog.json&quot;,function (data) {</code>修改为<code>$.getJSON(&quot;index/catalog.json&quot;,function (data) {</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.1.2.png" alt="image-20220711085421407" tabindex="0" loading="lazy"><figcaption>image-20220711085421407</figcaption></figure><h5 id="_3、格式化后数据的结构" tabindex="-1"><a class="header-anchor" href="#_3、格式化后数据的结构" aria-hidden="true">#</a> 3、格式化后数据的结构</h5><p>粘贴刚刚复制的模拟数据，粘贴到 www.json.cn 这个网站，查看json的结构</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.1.3.png" alt="image-20220711084956532" tabindex="0" loading="lazy"><figcaption>image-20220711084956532</figcaption></figure><h4 id="_2、新建catelog2vo类" tabindex="-1"><a class="header-anchor" href="#_2、新建catelog2vo类" aria-hidden="true">#</a> 2、新建<code>Catelog2Vo</code>类</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.vo</code>包下，新建<code>Catelog2Vo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>product<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/7/11
 * @Description: 二级分类vo
 */</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Catelog2Vo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 该二级分类对应的一级分类的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> catalog1Id<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 当前二级分类的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 当前二级分类的名字
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 该二级分类对应的所有三级分类
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catalog3List<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 三级分类vo
     */</span>
    <span class="token annotation punctuation">@NoArgsConstructor</span>
    <span class="token annotation punctuation">@AllArgsConstructor</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Catelog3Vo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 该三级分类对应的二级分类
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> catalog2Id<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 该三级分类的id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 该三级分类的名字
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.2.png" alt="image-20220711090742035" tabindex="0" loading="lazy"><figcaption>image-20220711090742035</figcaption></figure><h4 id="_3、添加getcatalogjson方法" tabindex="-1"><a class="header-anchor" href="#_3、添加getcatalogjson方法" aria-hidden="true">#</a> 3、添加<code>getCatalogJson</code>方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.web.IndexController</code>类里添加<code>getCatalogJson</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/index/catalog.json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> categoryService<span class="token punctuation">.</span><span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.3.png" alt="image-20220711091703531" tabindex="0" loading="lazy"><figcaption>image-20220711091703531</figcaption></figure><h4 id="_4、添加getcatalogjson抽象方法" tabindex="-1"><a class="header-anchor" href="#_4、添加getcatalogjson抽象方法" aria-hidden="true">#</a> 4、添加<code>getCatalogJson</code>抽象方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.CategoryService</code>接口里添加<code>getCatalogJson</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 查出所有的分类
 * <span class="token keyword">@return</span> k为一级分类的id，v为二级分类及其子分类的信息
 */</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.4.png" alt="image-20220711091617944" tabindex="0" loading="lazy"><figcaption>image-20220711091617944</figcaption></figure><h4 id="_5、实现getcatalogjson抽象方法" tabindex="-1"><a class="header-anchor" href="#_5、实现getcatalogjson抽象方法" aria-hidden="true">#</a> 5、实现<code>getCatalogJson</code>抽象方法</h4><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里实现<code>getCatalogJson</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1、查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l1 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、该一级分类的所有二级分类</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2QueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        category2QueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getParentCid</span><span class="token punctuation">,</span> l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2Entities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>category2QueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span></span> catelog2VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>category2Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catelog2VoList <span class="token operator">=</span> category2Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog1Id</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//3、当前二级分类的所有三级分类</span>
                <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3QueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                category3QueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getParentCid</span><span class="token punctuation">,</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3Entities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>category3QueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catelog3VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>category3Entities<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    catelog3VoList <span class="token operator">=</span> category3Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span> catelog3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setCatalog2Id</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> catelog3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>catelog3VoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catelog2VoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.5.png" alt="image-20220711100836334" tabindex="0" loading="lazy"><figcaption>image-20220711100836334</figcaption></figure><h4 id="_6、测试" tabindex="-1"><a class="header-anchor" href="#_6、测试" aria-hidden="true">#</a> 6、测试</h4><p>重启<code>GulimallProductApplication</code>服务，访问： http://localhost:10000/index/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.6.1.png" alt="image-20220711100109956" tabindex="0" loading="lazy"><figcaption>image-20220711100109956</figcaption></figure><p>可以看到返回的结构与模拟数据的结构一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.6.2.png" alt="image-20220711100125256" tabindex="0" loading="lazy"><figcaption>image-20220711100125256</figcaption></figure><p>首页已经显示数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.6.3.png" alt="image-20220711101310665" tabindex="0" loading="lazy"><figcaption>image-20220711101310665</figcaption></figure><p>测试以下是不是重数据库中查询来的</p><p>修改<code>gulimall_pms</code>数据库的<code>pms_category</code>表的<code>name</code>为<code>电子书</code>的字段，修改其为<code>电子书11</code>。刷新首页，可以看到已经更新了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.6.4.gif" alt="GIF 2022-7-11 10-05-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 10-05-40</figcaption></figure><p>如果没有更新，可以清除浏览器的缓存，再次刷新页面</p><p>依次点击 <code>chrome</code>浏览器右侧的竖着的三个点 -&gt; 设置 -&gt; 隐私设置和安全性 -&gt; 清除浏览数据 -&gt; 清除数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.3.6.5.gif" alt="GIF 2022-7-11 10-16-55" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 10-16-55</figcaption></figure><h3 id="_5-3-4、nginx反向代理" tabindex="-1"><a class="header-anchor" href="#_5-3-4、nginx反向代理" aria-hidden="true">#</a> 5.3.4、nginx反向代理</h3><p><strong>正向代理</strong>：如科学上网，隐藏客户端信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.0.1.png" alt="image-20220721204940910" tabindex="0" loading="lazy"><figcaption>image-20220721204940910</figcaption></figure><p><strong>反向代理</strong>：屏蔽内网服务器信息，负载均衡访问</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.0.2.png" alt="image-20220721205010885" tabindex="0" loading="lazy"><figcaption>image-20220721205010885</figcaption></figure><h4 id="_1、hsot文件添加域名" tabindex="-1"><a class="header-anchor" href="#_1、hsot文件添加域名" aria-hidden="true">#</a> 1、<code>hsot</code>文件添加域名</h4><h5 id="_1、可修改host文件的方式" tabindex="-1"><a class="header-anchor" href="#_1、可修改host文件的方式" aria-hidden="true">#</a> 1、可修改<code>host</code>文件的方式</h5><p>可以在<code>C:\Windows\System32\drivers\etc</code>目录下的<code>hosts</code>文件进行修改</p><p>第一次使用<code>记事本</code>会无法修改，可以使用<code>sublime text</code>或<code>notepad++</code>进行修改</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.1.1.1.png" alt="image-20220711104753942" tabindex="0" loading="lazy"><figcaption>image-20220711104753942</figcaption></figure><p>也可以使用<code>SwitchHosts</code>工具修改</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.1.1.2.png" alt="image-20220711104920953" tabindex="0" loading="lazy"><figcaption>image-20220711104920953</figcaption></figure><h5 id="_2、使用自定义方案" tabindex="-1"><a class="header-anchor" href="#_2、使用自定义方案" aria-hidden="true">#</a> 2、使用自定义方案</h5><p>打开<code>SwitchHosts</code>工具</p><ol><li><p>选择<code>本地方案</code></p></li><li><p>点击<code>+</code>号</p></li><li><p>在弹出的对话框的<code>本地方案</code>的<code>方案名</code>里输入<code>gulimall</code></p></li><li><p>点击<code>OK</code></p></li></ol><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.1.2.1.png" alt="image-20220711105655475" tabindex="0" loading="lazy"><figcaption>image-20220711105655475</figcaption></figure><ol><li><p>选择本地方案里的<code>gulimall</code></p></li><li><p>在里面输入<code>192.168.56.10 gulimall.com</code></p></li><li><p>点击<code>对勾</code>即可使用当前方案</p></li></ol><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.1.2.2.png" alt="image-20220711105753312" tabindex="0" loading="lazy"><figcaption>image-20220711105753312</figcaption></figure><h5 id="_3、访问" tabindex="-1"><a class="header-anchor" href="#_3、访问" aria-hidden="true">#</a> 3、访问</h5><p>访问虚拟机： http://gulimall.com:9200/</p><p>可以看到访问成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.1.3.png" alt="image-20220711110258412" tabindex="0" loading="lazy"><figcaption>image-20220711110258412</figcaption></figure><h4 id="_2、查看niginx配置" tabindex="-1"><a class="header-anchor" href="#_2、查看niginx配置" aria-hidden="true">#</a> 2、查看niginx配置</h4><h5 id="_1、nginx配置的目录结构" tabindex="-1"><a class="header-anchor" href="#_1、nginx配置的目录结构" aria-hidden="true">#</a> 1、nginx配置的目录结构</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.2.1.png" alt="image-20220711151115776" tabindex="0" loading="lazy"><figcaption>image-20220711151115776</figcaption></figure><h5 id="_2、查看ngix配置" tabindex="-1"><a class="header-anchor" href="#_2、查看ngix配置" aria-hidden="true">#</a> 2、查看ngix配置</h5><h6 id="_1、总配置" tabindex="-1"><a class="header-anchor" href="#_1、总配置" aria-hidden="true">#</a> 1、总配置</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token function">ps</span>
<span class="token builtin class-name">cd</span> /mydata/nginx/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> conf/
<span class="token function">ls</span>
<span class="token function">vi</span> nginx.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.2.2.1.1.png" alt="image-20220711153127308" tabindex="0" loading="lazy"><figcaption>image-20220711153127308</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.2.2.1.2.png" alt="image-20220711152851338" tabindex="0" loading="lazy"><figcaption>image-20220711152851338</figcaption></figure><h6 id="_2、server块配置" tabindex="-1"><a class="header-anchor" href="#_2、server块配置" aria-hidden="true">#</a> 2、server块配置</h6><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> conf.d/
<span class="token function">ls</span>
<span class="token function">vi</span> default.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.2.2.2.1.png" alt="image-20220711154239877" tabindex="0" loading="lazy"><figcaption>image-20220711154239877</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.2.2.2.2.png" alt="image-20220711154258555" tabindex="0" loading="lazy"><figcaption>image-20220711154258555</figcaption></figure><h4 id="_3、修改nginx配置" tabindex="-1"><a class="header-anchor" href="#_3、修改nginx配置" aria-hidden="true">#</a> 3、修改nginx配置</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cp</span> default.conf gulimall.conf
<span class="token function">ls</span>
<span class="token function">vi</span> gulimall.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.3.1.png" alt="image-20220711155146105" tabindex="0" loading="lazy"><figcaption>image-20220711155146105</figcaption></figure><p>配置所有请求都到商品服务</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    listen</span> <span class="token value attr-value">      80;</span>
<span class="token key attr-name">    server_name</span> <span class="token value attr-value"> gulimall.com;</span>

<span class="token comment">    #charset koi8-r;</span>
<span class="token comment">    #access_log  /var/log/nginx/log/host.access.log  main;</span>

<span class="token key attr-name">    location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">        proxy_pass</span> <span class="token value attr-value">http://192.168.56.1:10000;</span>
    }

<span class="token comment">    #error_page  404              /404.html;</span>

<span class="token comment">    # redirect server error pages to the static page /50x.html</span>
<span class="token comment">    #</span>
<span class="token key attr-name">    error_page</span> <span class="token value attr-value">  500 502 503 504  /50x.html;</span>
<span class="token key attr-name">    location</span> <span class="token punctuation">=</span> <span class="token value attr-value">/50x.html {</span>
<span class="token key attr-name">        root</span> <span class="token value attr-value">  /usr/share/nginx/html;</span>
    }

<span class="token comment">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ \.php$ {</span>
<span class="token comment">    #    proxy_pass   http://127.0.0.1;</span>
<span class="token comment">    #}</span>

<span class="token comment">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ \.php$ {</span>
<span class="token comment">    #    root           html;</span>
<span class="token comment">    #    fastcgi_pass   127.0.0.1:9000;</span>
<span class="token comment">    #    fastcgi_index  index.php;</span>
<span class="token comment">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
<span class="token comment">    #    include        fastcgi_params;</span>
<span class="token comment">    #}</span>

<span class="token comment">    # deny access to .htaccess files, if Apache&#39;s document root</span>
<span class="token comment">    # concurs with nginx&#39;s one</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ /\.ht {</span>
<span class="token comment">    #    deny  all;</span>
<span class="token comment">    #}</span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.3.2.png" alt="image-20220711154831136" tabindex="0" loading="lazy"><figcaption>image-20220711154831136</figcaption></figure><p><code>server_name</code>配置的就是通过浏览器访问的请求的<code>Request Headers</code>请求头的<code>nama</code>属性</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.3.3.png" alt="image-20220711155751038" tabindex="0" loading="lazy"><figcaption>image-20220711155751038</figcaption></figure><h4 id="_4、重启nginx" tabindex="-1"><a class="header-anchor" href="#_4、重启nginx" aria-hidden="true">#</a> 4、重启nginx</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.4.png" alt="image-20220711155515047" tabindex="0" loading="lazy"><figcaption>image-20220711155515047</figcaption></figure><h4 id="_5、查看配置是否生效" tabindex="-1"><a class="header-anchor" href="#_5、查看配置是否生效" aria-hidden="true">#</a> 5、查看配置是否生效</h4><p>浏览器访问： http://gulimall.com/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.4.5.png" alt="image-20220711155529343" tabindex="0" loading="lazy"><figcaption>image-20220711155529343</figcaption></figure><h3 id="_5-3-5、nginx负载均衡到网关" tabindex="-1"><a class="header-anchor" href="#_5-3-5、nginx负载均衡到网关" aria-hidden="true">#</a> 5.3.5、<code>nginx</code>负载均衡到网关</h3><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.0.1.png" alt="image-20220721204304167" style="zoom:67%;"><p>动静分离静：图片，js、css等静态资源（以实际文件存在的方式） 动：服务器需要处理的请求</p><p>每一个微服务都可以独立部署、运行、升级、独立自治;技术，架构，业务</p><p><strong>Nginx+Windows搭建域名访问环境</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.0.2.png" alt="image-20220721204535110" tabindex="0" loading="lazy"><figcaption>image-20220721204535110</figcaption></figure><p>让nginx帮我们进行反向代理，所有来自原<code>gulimall.com</code>的请求，都转到商品服务</p><p>nginx代理给网关的时候，会丢失请求的host信息，需要在<code>location</code>里添加 <code>proxy_set_header Host $host;</code></p><h4 id="_1、查看文档" tabindex="-1"><a class="header-anchor" href="#_1、查看文档" aria-hidden="true">#</a> 1、查看文档</h4><p>收购前网址： https://nginx.org/</p><p>收购后网址： https://www.nginx.com/</p><blockquote><p>The simplest configuration for load balancing with nginx may look like the following:</p></blockquote><p>使用 nginx 进行负载平衡的最简单配置可能如下所示：(添加上游服务器)</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">http</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    upstream</span> <span class="token value attr-value">myapp1 {</span>
<span class="token key attr-name">        server</span> <span class="token value attr-value">srv1.example.com;</span>
<span class="token key attr-name">        server</span> <span class="token value attr-value">srv2.example.com;</span>
<span class="token key attr-name">        server</span> <span class="token value attr-value">srv3.example.com;</span>
    }

<span class="token key attr-name">    server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">        listen</span> <span class="token value attr-value">80;</span>

<span class="token key attr-name">        location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">            proxy_pass</span> <span class="token value attr-value">http://myapp1;</span>
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.1.png" alt="GIF 2022-7-11 16-06-13" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 16-06-13</figcaption></figure><h4 id="_2、上游服务器配置" tabindex="-1"><a class="header-anchor" href="#_2、上游服务器配置" aria-hidden="true">#</a> 2、上游服务器配置</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
<span class="token function">ls</span>
<span class="token function">vi</span> nginx.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.2.1.png" alt="image-20220711161629988" tabindex="0" loading="lazy"><figcaption>image-20220711161629988</figcaption></figure><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">user</span> <span class="token value attr-value"> nginx;</span>
<span class="token key attr-name">worker_processes</span> <span class="token value attr-value"> 1;</span>

<span class="token key attr-name">error_log</span> <span class="token value attr-value"> /var/log/nginx/error.log warn;</span>
<span class="token key attr-name">pid</span> <span class="token value attr-value">       /var/run/nginx.pid;</span>


<span class="token key attr-name">events</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    worker_connections</span> <span class="token value attr-value"> 1024;</span>
}


<span class="token key attr-name">http</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    include</span> <span class="token value attr-value">      /etc/nginx/mime.types;</span>
<span class="token key attr-name">    default_type</span> <span class="token value attr-value"> application/octet-stream;</span>

<span class="token key attr-name">    log_format</span> <span class="token value attr-value"> main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
<span class="token key attr-name">                      &#39;$status</span> <span class="token value attr-value">$body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<span class="token key attr-name">                      &#39;&quot;$http_user_agent&quot;</span> <span class="token value attr-value">&quot;$http_x_forwarded_for&quot;&#39;;</span>

<span class="token key attr-name">    access_log</span> <span class="token value attr-value"> /var/log/nginx/access.log  main;</span>

<span class="token key attr-name">    sendfile</span> <span class="token value attr-value">       on;</span>
<span class="token comment">    #tcp_nopush     on;</span>

<span class="token key attr-name">    keepalive_timeout</span> <span class="token value attr-value"> 65;</span>

<span class="token comment">    #gzip  on;</span>
<span class="token key attr-name">    upstream</span> <span class="token value attr-value">gulimall{</span>
<span class="token key attr-name">      server</span> <span class="token value attr-value">192.168.56.1:88;</span>
    }
<span class="token key attr-name">    include</span> <span class="token value attr-value">/etc/nginx/conf.d/*.conf;</span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.2.2.png" alt="image-20220711161508940" tabindex="0" loading="lazy"><figcaption>image-20220711161508940</figcaption></figure><h4 id="_3、负载均衡到上游服务器" tabindex="-1"><a class="header-anchor" href="#_3、负载均衡到上游服务器" aria-hidden="true">#</a> 3、负载均衡到上游服务器</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> conf.d/
<span class="token function">ls</span>
<span class="token function">vi</span> gulimall.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.3.1.png" alt="image-20220711162244887" tabindex="0" loading="lazy"><figcaption>image-20220711162244887</figcaption></figure><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    listen</span> <span class="token value attr-value">      80;</span>
<span class="token key attr-name">    server_name</span> <span class="token value attr-value"> gulimall.com;</span>

<span class="token comment">    #charset koi8-r;</span>
<span class="token comment">    #access_log  /var/log/nginx/log/host.access.log  main;</span>

<span class="token key attr-name">    location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">        proxy_pass</span> <span class="token value attr-value">http://gulimall;</span>
    }

<span class="token comment">    #error_page  404              /404.html;</span>

<span class="token comment">    # redirect server error pages to the static page /50x.html</span>
<span class="token comment">    #</span>
<span class="token key attr-name">    error_page</span> <span class="token value attr-value">  500 502 503 504  /50x.html;</span>
<span class="token key attr-name">    location</span> <span class="token punctuation">=</span> <span class="token value attr-value">/50x.html {</span>
<span class="token key attr-name">        root</span> <span class="token value attr-value">  /usr/share/nginx/html;</span>
    }

<span class="token comment">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ \.php$ {</span>
<span class="token comment">    #    proxy_pass   http://127.0.0.1;</span>
<span class="token comment">    #}</span>

<span class="token comment">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ \.php$ {</span>
<span class="token comment">    #    root           html;</span>
<span class="token comment">    #    fastcgi_pass   127.0.0.1:9000;</span>
<span class="token comment">    #    fastcgi_index  index.php;</span>
<span class="token comment">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
<span class="token comment">    #    include        fastcgi_params;</span>
<span class="token comment">    #}</span>

<span class="token comment">    # deny access to .htaccess files, if Apache&#39;s document root</span>
<span class="token comment">    # concurs with nginx&#39;s one</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ /\.ht {</span>
<span class="token comment">    #    deny  all;</span>
<span class="token comment">    #}</span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.3.2.png" alt="image-20220711162027759" tabindex="0" loading="lazy"><figcaption>image-20220711162027759</figcaption></figure><h4 id="_4、重启nginx-1" tabindex="-1"><a class="header-anchor" href="#_4、重启nginx-1" aria-hidden="true">#</a> 4、重启nginx</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.4.png" alt="image-20220711162423730" tabindex="0" loading="lazy"><figcaption>image-20220711162423730</figcaption></figure><h4 id="_5、浏览器访问首页" tabindex="-1"><a class="header-anchor" href="#_5、浏览器访问首页" aria-hidden="true">#</a> 5、浏览器访问首页</h4><p>浏览器访问首页：http://gulimall.com/</p><p>访问失败的原因是<code>nginx</code>转给了后端的网关，而网关没有配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.5.png" alt="image-20220711162506688" tabindex="0" loading="lazy"><figcaption>image-20220711162506688</figcaption></figure><h4 id="_6、配置网关" tabindex="-1"><a class="header-anchor" href="#_6、配置网关" aria-hidden="true">#</a> 6、配置网关</h4><h5 id="_1、官方文档" tabindex="-1"><a class="header-anchor" href="#_1、官方文档" aria-hidden="true">#</a> 1、官方文档</h5><p>官方文档：https://spring.io/projects/spring-cloud-gateway/</p><p>域名配置文档：https://docs.spring.io/spring-cloud-gateway/docs/2.2.9.RELEASE/reference/html/#the-host-route-predicate-factory</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.6.1.png" alt="GIF 2022-7-11 16-33-25" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 16-33-25</figcaption></figure><h5 id="_2、配置网关" tabindex="-1"><a class="header-anchor" href="#_2、配置网关" aria-hidden="true">#</a> 2、配置网关</h5><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件中配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_host_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>product
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Host=<span class="token important">**.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.6.2.png" alt="image-20220711170519941" tabindex="0" loading="lazy"><figcaption>image-20220711170519941</figcaption></figure><h4 id="_7、查看首页是否显示" tabindex="-1"><a class="header-anchor" href="#_7、查看首页是否显示" aria-hidden="true">#</a> 7、查看首页是否显示</h4><p>重启<code>GulimallGatewayApplication</code>服务，刷新前端页面</p><h5 id="_1、浏览器访问" tabindex="-1"><a class="header-anchor" href="#_1、浏览器访问" aria-hidden="true">#</a> 1、浏览器访问</h5><p>打开 http://gulimall.com/ 页面，可以看到没有访问成功</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.1.png" alt="image-20220711165903388" tabindex="0" loading="lazy"><figcaption>image-20220711165903388</figcaption></figure><h5 id="_2、以debug方式启动网关" tabindex="-1"><a class="header-anchor" href="#_2、以debug方式启动网关" aria-hidden="true">#</a> 2、以<code>debug</code>方式启动网关</h5><p>以<code>debug</code>方式重新启动<code>GulimallGatewayApplication</code>服务，此时报了一个错</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>javax.management.InstanceNotFoundException: org.springframework.boot:type=Admin,name=SpringApplication
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.2.png" alt="image-20220711165952509" tabindex="0" loading="lazy"><figcaption>image-20220711165952509</figcaption></figure><h5 id="_3、取消勾选enable-jmx-agent" tabindex="-1"><a class="header-anchor" href="#_3、取消勾选enable-jmx-agent" aria-hidden="true">#</a> 3、取消勾选<code>Enable JMX agent</code></h5><p>点击<code>Unnamed</code>，点击<code>Edit Configurations...</code>选择<code>GulimallGatewayApplication</code>服务，点击<code>编辑</code>按钮,在<code>Configuration</code>的<code>Spring boot</code>里取消勾选<code>Enable JMX agent</code></p><p>再次以<code>debug</code>方式重新启动<code>GulimallGatewayApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.3.gif" alt="GIF 2022-7-11 16-58-11" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 16-58-11</figcaption></figure><h5 id="_4、又报了个错" tabindex="-1"><a class="header-anchor" href="#_4、又报了个错" aria-hidden="true">#</a> 4、又报了个错</h5><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Positive matches:
-----------------

   ArchaiusAutoConfiguration matched:
      - @ConditionalOnClass found required classes &#39;com.netflix.config.ConcurrentCompositeConfiguration&#39;, &#39;org.apache.commons.configuration.ConfigurationBuilder&#39; (OnClassCondition)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.4.png" alt="image-20220711170159408" tabindex="0" loading="lazy"><figcaption>image-20220711170159408</figcaption></figure><h5 id="_5、向左缩进两格" tabindex="-1"><a class="header-anchor" href="#_5、向左缩进两格" aria-hidden="true">#</a> 5、向左缩进两格</h5><p>修改<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件的<code>id</code>为<code>gulimall_host_route</code>的配置</p><p>让其相关配置向左缩进两格</p><p><a href="code/5.3.5.7.5.application.yml">点击查看网关完整配置</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.5.png" alt="image-20220711170903534" tabindex="0" loading="lazy"><figcaption>image-20220711170903534</figcaption></figure><h5 id="_6、路径匹配" tabindex="-1"><a class="header-anchor" href="#_6、路径匹配" aria-hidden="true">#</a> 6、路径匹配</h5><p>重新以<code>debug</code>方式重新启动<code>GulimallGatewayApplication</code>服务，刷新 http://gulimall.com/ 页面</p><p>可以看到匹配了<code>id</code>为<code>gulimall_host_route</code>的规则，但是还是无法访问</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.6.1.png" alt="image-20220711171140290" tabindex="0" loading="lazy"><figcaption>image-20220711171140290</figcaption></figure><p>这是因为<code>nginx</code>在转发的时候，没有把<code>Request Headers</code>里的<code>Host: gulimall.com</code>带上</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.7.6.2.png" alt="image-20220711212405663" tabindex="0" loading="lazy"><figcaption>image-20220711212405663</figcaption></figure><h4 id="_8、nginx添加头信息" tabindex="-1"><a class="header-anchor" href="#_8、nginx添加头信息" aria-hidden="true">#</a> 8、nginx添加头信息</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ls</span>
<span class="token function">vi</span> gulimall.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.8.1.png" alt="image-20220711164727203" tabindex="0" loading="lazy"><figcaption>image-20220711164727203</figcaption></figure><p>在<code>location / {</code>里添加配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">proxy_set_header</span> <span class="token value attr-value">Host $host;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.8.2.png" alt="image-20220711164409484" tabindex="0" loading="lazy"><figcaption>image-20220711164409484</figcaption></figure><h4 id="_9、重启nginx" tabindex="-1"><a class="header-anchor" href="#_9、重启nginx" aria-hidden="true">#</a> 9、重启nginx</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.9.png" alt="image-20220711164548923" tabindex="0" loading="lazy"><figcaption>image-20220711164548923</figcaption></figure><h4 id="_10、刷新页面" tabindex="-1"><a class="header-anchor" href="#_10、刷新页面" aria-hidden="true">#</a> 10、刷新页面</h4><p>刷新 http://gulimall.com/ 页面，已经可以正常访问了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.5.10.png" alt="image-20220711213107065" tabindex="0" loading="lazy"><figcaption>image-20220711213107065</figcaption></figure><h3 id="_5-3-6、压力测试" tabindex="-1"><a class="header-anchor" href="#_5-3-6、压力测试" aria-hidden="true">#</a> 5.3.6、压力测试</h3><blockquote><p>压力测试考察当前软硬件环境下系统所能承受的最大负荷并帮助找出系统瓶颈所在。压测都 是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数。</p></blockquote><p>使用压力测试，我们有希望找到很多种用其他测试方法更难发现的错误。有两种错误类型是: <strong>内存泄漏</strong>，<strong>并发与同步</strong>。</p><p>有效的压力测试系统将应用以下这些关键条件:<strong>重复</strong>，<strong>并发</strong>，<strong>量级</strong>，<strong>随机变化</strong>。</p><h4 id="_1、性能指标" tabindex="-1"><a class="header-anchor" href="#_1、性能指标" aria-hidden="true">#</a> 1、性能指标</h4><ul><li><p><strong>响应时间</strong>（Response Time: RT）</p><p>响应时间指用户从客户端发起一个请求开始，到客户端接收到从服务器端返回的响应结束，整个过程所耗费的时间。</p></li><li><p><strong>HPS</strong>（Hits Per Second） ：每秒点击次数，单位是次/秒。</p></li><li><p><strong>TPS</strong>（Transaction per Second）：系统每秒处理交易数，单位是笔/秒。</p></li><li><p><strong>QPS</strong>（Query per Second）：系统每秒处理查询次数，单位是次/秒。</p><p>对于互联网业务中，如果某些业务有且仅有一个请求连接，那么 TPS=QPS=HPS，一般情况下用 TPS 来衡量整个业务流程，用 QPS 来衡量接口查询次数，用 HPS 来表示对服务器单击请求。</p></li><li><p>无论 TPS、QPS、HPS,此指标是衡量系统处理能力非常重要的指标，越大越好，根据经验，一般情况下：</p><ul><li>金融行业：1000TPS~50000TPS，不包括互联网化的活动</li><li>保险行业：100TPS~100000TPS，不包括互联网化的活动</li><li>制造行业：10TPS~5000TPS</li><li>互联网电子商务：10000TPS~1000000TPS</li><li>互联网中型网站：1000TPS~50000TPS</li><li>互联网小型网站：500TPS~10000TPS</li></ul></li><li><p><strong>最大响应时间</strong>（Max Response Time） 指用户发出请求或者指令到系统做出反应（响应）的最大时间。</p></li><li><p><strong>最少响应时间</strong>（Mininum ResponseTime） 指用户发出请求或者指令到系统做出反应（响应）的最少时间。</p></li><li><p><strong>90%响应时间</strong>（90% Response Time） 是指所有用户的响应时间进行排序，第 90%的响应时间。</p></li><li><p>从外部看，性能测试主要关注如下三个指标</p><ul><li><p>吞吐量：每秒钟系统能够处理的请求数、任务数。</p></li><li><p>响应时间：服务处理一个请求或一个任务的耗时。</p></li><li><p>错误率：一批请求中结果出错的请求所占比例。</p></li></ul></li></ul><h4 id="_2、安装jmeter" tabindex="-1"><a class="header-anchor" href="#_2、安装jmeter" aria-hidden="true">#</a> 2、安装JMeter</h4><p>官方网址：https://jmeter.apache.org/download_jmeter.cgi</p><p>点击<code>Download</code>里的<code>Download Releases</code>，在<code>Binaries</code>里选择<a href="https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.5.zip" target="_blank" rel="noopener noreferrer">apache-jmeter-5.5.zip<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 即可下载</p><p>历史版本下载地址： <a href="https://archive.apache.org/dist/jmeter/binaries/" target="_blank" rel="noopener noreferrer">Index of /dist/jmeter/binaries (apache.org)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.2.1.png" alt="image-20220711215721546" tabindex="0" loading="lazy"><figcaption>image-20220711215721546</figcaption></figure><p>解压后，在<code>apache-jmeter-5.2.1\bin</code>目录下，点击<code>jmeter.bat</code>可执行文件即可打开<code>JMeter</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.2.2.png" alt="image-20220711220237900" tabindex="0" loading="lazy"><figcaption>image-20220711220237900</figcaption></figure><p>中文显示</p><p>依次点击<code>Options</code> -&gt; <code>Choose Language</code> -&gt; <code>Chinese (Simplified)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.2.3.gif" alt="GIF 2022-7-11 22-05-07" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 22-05-07</figcaption></figure><p>设置背景色为白色</p><p>依次点击<code>选项</code> -&gt; <code>外观</code> -&gt; <code>Nimbus</code> -&gt; <code>Yes</code> ，然后重新打开即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.2.4.gif" alt="GIF 2022-7-11 22-09-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 22-09-17</figcaption></figure><p>可以看到再次打开后还是英文显示，这是因为<code>JMeter</code>使用界面设置中文下次打开<code>JMeter</code>仍然会显示为英文</p><p>在<code>apache-jmeter-5.2.1\bin</code>目录的<code>jmeter.properties</code>配置文件里添加如下配置</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>language=zh_CN
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.2.5.png" alt="image-20220711222534132" tabindex="0" loading="lazy"><figcaption>image-20220711222534132</figcaption></figure><h4 id="_3、添加线程组" tabindex="-1"><a class="header-anchor" href="#_3、添加线程组" aria-hidden="true">#</a> 3、添加线程组</h4><h5 id="_1、添加取样器" tabindex="-1"><a class="header-anchor" href="#_1、添加取样器" aria-hidden="true">#</a> 1、添加取样器</h5><p>选中<code>测试计划</code>，右键依次选择<code>添加</code> -&gt; <code>线程（用户）</code> -&gt; <code>线程组</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.1.1.gif" alt="GIF 2022-7-11 22-44-23" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 22-44-23</figcaption></figure><p>在<code>线程属性</code>里的<code>线程数</code>里输入<code>200</code>，表示<strong>启动200个线程</strong></p><p>在<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>循环次数</code>里输入<code>100</code>，<strong>表示每个线程循环100次</strong>，共发送200x100 =20000个请求</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.1.2.png" alt="image-20220711224938665" tabindex="0" loading="lazy"><figcaption>image-20220711224938665</figcaption></figure><h5 id="_2、添加察看结果树" tabindex="-1"><a class="header-anchor" href="#_2、添加察看结果树" aria-hidden="true">#</a> 2、添加<code>察看结果树</code></h5><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>监听器</code> -&gt; <code>察看结果树</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.2.gif" alt="GIF 2022-7-11 22-55-24" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 22-55-24</figcaption></figure><h5 id="_3、添加汇总报告" tabindex="-1"><a class="header-anchor" href="#_3、添加汇总报告" aria-hidden="true">#</a> 3、添加<code>汇总报告</code></h5><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>监听器</code> -&gt; <code>汇总报告</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.3.gif" alt="GIF 2022-7-11 22-58-08" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 22-58-08</figcaption></figure><h5 id="_4、添加汇总图" tabindex="-1"><a class="header-anchor" href="#_4、添加汇总图" aria-hidden="true">#</a> 4、添加<code>汇总图</code></h5><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>监听器</code> -&gt; <code>汇总图</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.4.gif" alt="GIF 2022-7-11 23-01-11" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 23-01-11</figcaption></figure><h5 id="_5、添加http请求" tabindex="-1"><a class="header-anchor" href="#_5、添加http请求" aria-hidden="true">#</a> 5、添加<code>http请求</code></h5><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>取样器</code> -&gt; <code>http请求</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.5.1.gif" alt="GIF 2022-7-11 23-07-08" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 23-07-08</figcaption></figure><p>在<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>www.baidu.com</code>，<code>端口号：</code>输入<code>80</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.3.5.2.png" alt="image-20220711230817728" tabindex="0" loading="lazy"><figcaption>image-20220711230817728</figcaption></figure><h4 id="_4、对百度进行测试" tabindex="-1"><a class="header-anchor" href="#_4、对百度进行测试" aria-hidden="true">#</a> 4、对百度进行测试</h4><h5 id="_1、执行测试" tabindex="-1"><a class="header-anchor" href="#_1、执行测试" aria-hidden="true">#</a> 1、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.4.1.gif" alt="GIF 2022-7-11 23-12-14" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-11 23-12-14</figcaption></figure><h5 id="_2、察看结果树" tabindex="-1"><a class="header-anchor" href="#_2、察看结果树" aria-hidden="true">#</a> 2、察看结果树</h5><p>可以看到都请求成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.4.2.png" alt="image-20220711231548203" tabindex="0" loading="lazy"><figcaption>image-20220711231548203</figcaption></figure><h5 id="_3、汇总报告" tabindex="-1"><a class="header-anchor" href="#_3、汇总报告" aria-hidden="true">#</a> 3、汇总报告</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.4.3.png" alt="image-20220711231603497" tabindex="0" loading="lazy"><figcaption>image-20220711231603497</figcaption></figure><h5 id="_4、汇总图" tabindex="-1"><a class="header-anchor" href="#_4、汇总图" aria-hidden="true">#</a> 4、汇总图</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.4.4.png" alt="image-20220711231616166" tabindex="0" loading="lazy"><figcaption>image-20220711231616166</figcaption></figure><h4 id="_5、对本项目进行测试" tabindex="-1"><a class="header-anchor" href="#_5、对本项目进行测试" aria-hidden="true">#</a> 5、对本项目进行测试</h4><h5 id="_1、执行测试-1" tabindex="-1"><a class="header-anchor" href="#_1、执行测试-1" aria-hidden="true">#</a> 1、执行测试</h5><p>在<code>http请求</code>里的<code>服务器名称或IP:</code>修改为<code>gulimall.com</code>，点击工具栏的<code>清除全部</code>按钮，然后点击<code>启动</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.5.1.png" alt="image-20220712180117360" tabindex="0" loading="lazy"><figcaption>image-20220712180117360</figcaption></figure><h5 id="_2、察看结果树-1" tabindex="-1"><a class="header-anchor" href="#_2、察看结果树-1" aria-hidden="true">#</a> 2、察看结果树</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.5.2.png" alt="image-20220712180511761" tabindex="0" loading="lazy"><figcaption>image-20220712180511761</figcaption></figure><h5 id="_3、汇总报告-1" tabindex="-1"><a class="header-anchor" href="#_3、汇总报告-1" aria-hidden="true">#</a> 3、汇总报告</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.5.3.png" alt="image-20220712180555607" tabindex="0" loading="lazy"><figcaption>image-20220712180555607</figcaption></figure><h5 id="_4、汇总图-1" tabindex="-1"><a class="header-anchor" href="#_4、汇总图-1" aria-hidden="true">#</a> 4、汇总图</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.5.4.1.png" alt="image-20220712180626237" tabindex="0" loading="lazy"><figcaption>image-20220712180626237</figcaption></figure><p>想要显示图像，可以在设置中勾选想要显示的<code>列显示</code>，点击<code>显示图表</code>即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.5.4.2.gif" alt="GIF 2022-7-12 18-08-50" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 18-08-50</figcaption></figure><h4 id="_6、重新测试" tabindex="-1"><a class="header-anchor" href="#_6、重新测试" aria-hidden="true">#</a> 6、重新测试</h4><h5 id="_1、调大内存" tabindex="-1"><a class="header-anchor" href="#_1、调大内存" aria-hidden="true">#</a> 1、调大内存</h5><p>在<code>GulimallGatewayApplication</code>模块的运行配置里的<code>Environment</code>栏的<code>VM options</code>里的右方框里输入<code>-Xmx100m</code>，限制<code>GulimallGatewayApplication</code>模块的最大内存占用为<code>100m</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-Xmx500m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.1.1.png" alt="image-20220712182036988" tabindex="0" loading="lazy"><figcaption>image-20220712182036988</figcaption></figure><p>在<code>GulimallProductApplication</code>模块的运行配置里的<code>Environment</code>栏的<code>VM options</code>里的右方框里输入<code>-Xmx100m</code>，限制<code>GulimallProductApplication</code>模块的最大内存占用为<code>100m</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-Xmx500m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.1.2.png" alt="image-20220712182102801" tabindex="0" loading="lazy"><figcaption>image-20220712182102801</figcaption></figure><h5 id="_2、执行测试" tabindex="-1"><a class="header-anchor" href="#_2、执行测试" aria-hidden="true">#</a> 2、执行测试</h5><p>点击工具栏的<code>清除全部</code>按钮，然后点击<code>启动</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.2.png" alt="image-20220712182422350" tabindex="0" loading="lazy"><figcaption>image-20220712182422350</figcaption></figure><h5 id="_3、察看结果树" tabindex="-1"><a class="header-anchor" href="#_3、察看结果树" aria-hidden="true">#</a> 3、察看结果树</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.3.png" alt="image-20220712182544730" tabindex="0" loading="lazy"><figcaption>image-20220712182544730</figcaption></figure><h5 id="_4、汇总报告" tabindex="-1"><a class="header-anchor" href="#_4、汇总报告" aria-hidden="true">#</a> 4、汇总报告</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.4.png" alt="image-20220712182603933" tabindex="0" loading="lazy"><figcaption>image-20220712182603933</figcaption></figure><h5 id="_5、汇总图" tabindex="-1"><a class="header-anchor" href="#_5、汇总图" aria-hidden="true">#</a> 5、汇总图</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.5.png" alt="image-20220712182627440" tabindex="0" loading="lazy"><figcaption>image-20220712182627440</figcaption></figure><p>可以看到除了执行时间，其他性能并没有明显的改善</p><h5 id="_6、jmeter-address-already-in-use" tabindex="-1"><a class="header-anchor" href="#_6、jmeter-address-already-in-use" aria-hidden="true">#</a> 6、JMeter Address Already in use</h5><h6 id="_1、问题描述" tabindex="-1"><a class="header-anchor" href="#_1、问题描述" aria-hidden="true">#</a> 1、问题描述</h6><p>在<code>windows</code>系统访问有可能报<code>Address Already in use</code>异常（我的没报这个异常）</p><p>在<code>线程组</code>里的<code>线程属性</code>里，将<code>线程数</code>修改为<code>50</code>，<code>循环次数</code>勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.1.1.png" alt="image-20220712184123934" tabindex="0" loading="lazy"><figcaption>image-20220712184123934</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>服务器名称或IP:</code>修改为<code>127.0.0.1</code>，<code>端口号：</code>修改为<code>10000</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.1.2.png" alt="image-20220712184336692" tabindex="0" loading="lazy"><figcaption>image-20220712184336692</figcaption></figure><p>点击工具栏的<code>清除全部</code>按钮，然后点击<code>启动</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.1.3.png" alt="5.3.6.6.6.3" tabindex="0" loading="lazy"><figcaption>5.3.6.6.6.3</figcaption></figure><p>进行测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.1.4.gif" alt="GIF 2022-7-12 18-33-56" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 18-33-56</figcaption></figure><p>有可能出现大量异常请求</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.1.5.png" alt="image-20220712184728011" tabindex="0" loading="lazy"><figcaption>image-20220712184728011</figcaption></figure><p>在<code>察看结果树</code>里可以看到报的是<code>Address Already in use</code>错误</p><p>这是windows 本身提供的端口访问机制的问题。 Windows 提供给 TCP/IP 链接的端口为 1024-5000，并且要四分钟来循环回收他们。就导致 我们在短时间内跑大量的请求时将端口占满了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.1.6.png" alt="image-20220712183805060" tabindex="0" loading="lazy"><figcaption>image-20220712183805060</figcaption></figure><h6 id="_2、解决方案" tabindex="-1"><a class="header-anchor" href="#_2、解决方案" aria-hidden="true">#</a> 2、解决方案</h6><ol><li><p>cmd 中，用 regedit 命令打开注册表</p></li><li><p>在 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters 下，</p><ol><li><p>右击 parameters，添加一个新的 DWORD，名字为<code>MaxUserPort</code></p></li><li><p>然后双击 MaxUserPort，基数选择十进制，输入数值数据为 <code>65534</code>（如果是分布式运 行的话，控制机器和负载机器都需要这样操作哦）</p></li><li><p>右击 parameters，添加一个新的 DWORD，名字为<code>TCPTimedWaitDelay</code></p></li><li><p>然后双击<code>TCPTimedWaitDelay</code>，基数选择十进制，输入数值数据为 <code>30</code></p></li></ol></li><li><p>修改配置完毕之后记得重启机器才会生效</p></li></ol><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.2.1.png" alt="image-20220712185322027" tabindex="0" loading="lazy"><figcaption>image-20220712185322027</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.2.2.gif" alt="GIF 2022-7-12 18-57-57" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 18-57-57</figcaption></figure><p>官方文档：<a href="https://docs.microsoft.com/zh-CN/troubleshoot/windows-client/networking/connect-tcp-greater-than-5000-error-wsaenobufs-10055" target="_blank" rel="noopener noreferrer">错误 WSAENOBUFS (10055) - Windows Client | Microsoft Docs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.6.6.6.2.3.png" alt="image-20220712190300746" style="zoom:67%;"><h3 id="_5-3-7、性能监控" tabindex="-1"><a class="header-anchor" href="#_5-3-7、性能监控" aria-hidden="true">#</a> 5.3.7、性能监控</h3><h4 id="_1、jvm-内存模型" tabindex="-1"><a class="header-anchor" href="#_1、jvm-内存模型" aria-hidden="true">#</a> 1、jvm 内存模型</h4><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.1.1.png" alt="image-20220712193526455" tabindex="0" loading="lazy"><figcaption>image-20220712193526455</figcaption></figure><ul><li>程序计数器 Program Counter Register： <ul><li>记录的是正在执行的虚拟机字节码指令的地址，</li><li>此内存区域是唯一一个在 JAVA 虚拟机规范中没有规定任何OutOfMemoryError 的区域</li></ul></li><li>虚拟机：VM Stack <ul><li>描述的是 JAVA 方法执行的内存模型，每个方法在执行的时候都会创建一个栈帧，用于存储局部变量表，操作数栈，动态链接，方法接口等信息</li><li>局部变量表存储了编译期可知的各种基本数据类型、对象引用</li><li>线程请求的栈深度不够会报 StackOverflowError 异常</li><li>栈动态扩展的容量不够会报 OutOfMemoryError 异常</li><li>虚拟机栈是线程隔离的，即每个线程都有自己独立的虚拟机栈</li></ul></li><li>本地方法：Native Stack <ul><li>本地方法栈类似于虚拟机栈，只不过本地方法栈使用的是本地方法</li></ul></li><li>堆：Heap <ul><li>几乎所有的对象实例都在堆上分配内存</li></ul></li></ul><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.1.2.png" alt="image-20220712193817010" tabindex="0" loading="lazy"><figcaption>image-20220712193817010</figcaption></figure><h4 id="_2、堆" tabindex="-1"><a class="header-anchor" href="#_2、堆" aria-hidden="true">#</a> 2、堆</h4><p>所有的对象实例以及数组都要在堆上分配。堆是垃圾收集器管理的主要区域，也被称为“GC 堆”；也是我们优化最多考虑的地方。</p><p>堆可以细分为：</p><ul><li>新生代 <ul><li>Eden 空间</li><li>From Survivor 空间</li><li>To Survivor 空间</li></ul></li><li>老年代</li><li>永久代/元空间 <ul><li>Java8 以前永久代，受 jvm 管理，java8 以后元空间，直接使用物理内存。因此，默认情况下，元空间的大小仅受本地内存限制。</li></ul></li></ul><p>垃圾回收</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.2.1.png" alt="image-20220712193955078" tabindex="0" loading="lazy"><figcaption>image-20220712193955078</figcaption></figure><p>从 Java8 开始，HotSpot 已经完全将永久代（Permanent Generation）移除，取而代之的是一个新的区域—元空间（MetaSpace）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.2.2.png" alt="image-20220712194019094" tabindex="0" loading="lazy"><figcaption>image-20220712194019094</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.2.3.png" alt="image-20220712194034323" tabindex="0" loading="lazy"><figcaption>image-20220712194034323</figcaption></figure><h4 id="_3、jconsole-与-jvisualvm" tabindex="-1"><a class="header-anchor" href="#_3、jconsole-与-jvisualvm" aria-hidden="true">#</a> 3、jconsole 与 jvisualvm</h4><p>Jdk 的两个小工具 jconsole、jvisualvm（升级版的 jconsole）;通过命令行启动，可监控本地和</p><p>远程应用。远程应用需要配置</p><h5 id="_1、jconsole使用" tabindex="-1"><a class="header-anchor" href="#_1、jconsole使用" aria-hidden="true">#</a> 1、jconsole使用</h5><h6 id="_1、打开" tabindex="-1"><a class="header-anchor" href="#_1、打开" aria-hidden="true">#</a> 1、打开</h6><p>打开<code>cmd</code>，输入<code>jconsole</code>，选择一个服务后即可查看<code>内存</code>、<code>线程</code>、<code>类</code>、<code>vm</code>等信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.1.gif" alt="GIF 2022-7-12 19-28-56" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 19-28-56</figcaption></figure><h6 id="_2、概要" tabindex="-1"><a class="header-anchor" href="#_2、概要" aria-hidden="true">#</a> 2、概要</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.2.png" alt="image-20220712195023839" tabindex="0" loading="lazy"><figcaption>image-20220712195023839</figcaption></figure><h6 id="_3、内存" tabindex="-1"><a class="header-anchor" href="#_3、内存" aria-hidden="true">#</a> 3、内存</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.3.png" alt="image-20220712195050101" tabindex="0" loading="lazy"><figcaption>image-20220712195050101</figcaption></figure><h6 id="_4、线程" tabindex="-1"><a class="header-anchor" href="#_4、线程" aria-hidden="true">#</a> 4、线程</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.4.png" alt="image-20220712195130378" tabindex="0" loading="lazy"><figcaption>image-20220712195130378</figcaption></figure><h6 id="_5、类" tabindex="-1"><a class="header-anchor" href="#_5、类" aria-hidden="true">#</a> 5、类</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.5.png" alt="image-20220712195153804" tabindex="0" loading="lazy"><figcaption>image-20220712195153804</figcaption></figure><h6 id="_6、vm-概要" tabindex="-1"><a class="header-anchor" href="#_6、vm-概要" aria-hidden="true">#</a> 6、VM 概要</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.6.png" alt="image-20220712195233679" tabindex="0" loading="lazy"><figcaption>image-20220712195233679</figcaption></figure><h6 id="_7、mbean" tabindex="-1"><a class="header-anchor" href="#_7、mbean" aria-hidden="true">#</a> 7、MBean</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.1.7.png" alt="image-20220712195314522" tabindex="0" loading="lazy"><figcaption>image-20220712195314522</figcaption></figure><h5 id="_2、jvisualvm使用" tabindex="-1"><a class="header-anchor" href="#_2、jvisualvm使用" aria-hidden="true">#</a> 2、<code>jvisualvm</code>使用</h5><h6 id="_1、打开-1" tabindex="-1"><a class="header-anchor" href="#_1、打开-1" aria-hidden="true">#</a> 1、打开</h6><p>开<code>cmd</code>，输入<code>jvisualvm</code>，选择一个服务后即可查看各种信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.2.1.gif" alt="GIF 2022-7-12 19-56-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 19-56-54</figcaption></figure><h6 id="_2、概要-1" tabindex="-1"><a class="header-anchor" href="#_2、概要-1" aria-hidden="true">#</a> 2、概要</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.2.2.png" alt="image-20220712195808985" tabindex="0" loading="lazy"><figcaption>image-20220712195808985</figcaption></figure><h6 id="_3、监视" tabindex="-1"><a class="header-anchor" href="#_3、监视" aria-hidden="true">#</a> 3、监视</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.2.3.png" alt="image-20220712195838543" tabindex="0" loading="lazy"><figcaption>image-20220712195838543</figcaption></figure><h6 id="_4、线程-1" tabindex="-1"><a class="header-anchor" href="#_4、线程-1" aria-hidden="true">#</a> 4、线程</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.2.4.png" alt="image-20220712195904085" tabindex="0" loading="lazy"><figcaption>image-20220712195904085</figcaption></figure><h6 id="_5、抽样器" tabindex="-1"><a class="header-anchor" href="#_5、抽样器" aria-hidden="true">#</a> 5、抽样器</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.2.5.png" alt="image-20220712195946392" tabindex="0" loading="lazy"><figcaption>image-20220712195946392</figcaption></figure><h6 id="_6、profiler" tabindex="-1"><a class="header-anchor" href="#_6、profiler" aria-hidden="true">#</a> 6、Profiler</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.2.6.png" alt="image-20220712200011690" tabindex="0" loading="lazy"><figcaption>image-20220712200011690</figcaption></figure><h5 id="_3、安装visual-gc" tabindex="-1"><a class="header-anchor" href="#_3、安装visual-gc" aria-hidden="true">#</a> 3、安装<code>Visual GC</code></h5><h6 id="_1、下载插件" tabindex="-1"><a class="header-anchor" href="#_1、下载插件" aria-hidden="true">#</a> 1、下载插件</h6><p>点击<code>工具</code>，选择<code>插件</code>，在<code>可用插件</code>里点击<code>检查最新版本(F)</code>，然后选中<code>Visual GC</code>点击<code>安装(I)</code>即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.1.1.gif" alt="GIF 2022-7-12 20-02-45" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 20-02-45</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.1.2.png" alt="image-20220712200832207" tabindex="0" loading="lazy"><figcaption>image-20220712200832207</figcaption></figure><h6 id="_2、检查最新版本错误" tabindex="-1"><a class="header-anchor" href="#_2、检查最新版本错误" aria-hidden="true">#</a> 2、检查最新版本错误</h6><p>如果点击<code>检查最新版本</code>出现了错误，可以在<code>cmd</code>输入以下命令，查看jdk详细版本</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java -version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>进入该网站：https://visualvm.github.io/pluginscenters.html ，查询该版本对应的更新地址</p><p>例如我的java版本为<code>java version &quot;1.8.0_301&quot;</code>，后面的小版本为<code>301</code>因此对应该网站显示的<code>JDK 8 Update 131 - 331</code></p><p>点进去，复制里面显示的url即可(url以<code>xml.gz</code>结尾)</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>https://visualvm.github.io/uc/8u131/updates.xml.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.2.png" alt="GIF 2022-7-12 20-19-35" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 20-19-35</figcaption></figure><h6 id="_3、下载插件错误" tabindex="-1"><a class="header-anchor" href="#_3、下载插件错误" aria-hidden="true">#</a> 3、下载插件错误</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.3.1.png" alt="image-20220712200858240" tabindex="0" loading="lazy"><figcaption>image-20220712200858240</figcaption></figure><blockquote><p>https://github.com/visualvm/visualvm.src/releases/download/1.3.9/com-sun-tools-visualvm-modules-visualgc.nbm中出现网络问题</p></blockquote><blockquote><p>检查代理设置或稍后重试。服务器目前可能不可用。 您可能还需要确保防火墙不会阻塞网络通信。 您的高速缓存可能已过期。请单击“检查更新”以刷新内容。</p></blockquote><p>这种是githu的这个网址访问不了了，可以换个时间下载，或者使用某些方法下载，也可以通过迅雷下载</p><p>依次点击<code>工具(T)</code> -&gt; <code>插件(G)</code> -&gt; <code>已下载</code> -&gt; <code>添加插件(A)..</code>即可添加离线插件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.3.2.png" alt="image-20220712202618328" tabindex="0" loading="lazy"><figcaption>image-20220712202618328</figcaption></figure><p>可以在刚刚那个网址 https://visualvm.github.io/pluginscenters.html 里点击对应版本的链接后，在下面即可看到各个工具的下载地址</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.3.3.gif" alt="GIF 2022-7-12 20-31-27" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 20-31-27</figcaption></figure><h6 id="_4、查看visual-gc" tabindex="-1"><a class="header-anchor" href="#_4、查看visual-gc" aria-hidden="true">#</a> 4、查看<code>Visual GC</code></h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.3.3.3.4.png" alt="image-20220712203426598" tabindex="0" loading="lazy"><figcaption>image-20220712203426598</figcaption></figure><h4 id="_4、测试nginx" tabindex="-1"><a class="header-anchor" href="#_4、测试nginx" aria-hidden="true">#</a> 4、测试Nginx</h4><h5 id="_1、准备工作-4" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-4" aria-hidden="true">#</a> 1、准备工作</h5><h6 id="_1、查看docker资源使用情况" tabindex="-1"><a class="header-anchor" href="#_1、查看docker资源使用情况" aria-hidden="true">#</a> 1、查看docker资源使用情况</h6><p>使用<code>docker stats</code>命令可以查看<code>docker</code>里，各容器的<code>cpu</code>、内存等的占用情况</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>docker stats
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.1.1.png" alt="image-20220712204640177" tabindex="0" loading="lazy"><figcaption>image-20220712204640177</figcaption></figure><h6 id="_2、设置线程数" tabindex="-1"><a class="header-anchor" href="#_2、设置线程数" aria-hidden="true">#</a> 2、设置线程数</h6><p>选中<code>测试计划</code>，右键依次选择<code>添加</code> -&gt; <code>线程（用户）</code> -&gt; <code>线程组</code></p><p>点击刚刚创建的<code>线程组</code>，在<code>线程属性</code>里的<code>线程数</code>里输入<code>50</code>，表示<strong>启动50个线程</strong></p><p>在<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>循环次数</code>里勾选<code>永远</code>，表示如果不点击<code>停止</code>按钮，就一直执行</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.1.2.png" alt="image-20220712204257142" tabindex="0" loading="lazy"><figcaption>image-20220712204257142</figcaption></figure><h6 id="_3、修改http请求信息" tabindex="-1"><a class="header-anchor" href="#_3、修改http请求信息" aria-hidden="true">#</a> 3、修改<code>http</code>请求信息</h6><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>取样器</code> -&gt; <code>http请求</code>，</p><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>192.168.56.10</code>，<code>端口号：</code>输入<code>80</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.1.3.png" alt="image-20220712204511116" tabindex="0" loading="lazy"><figcaption>image-20220712204511116</figcaption></figure><h6 id="_4、查看要压测的页面" tabindex="-1"><a class="header-anchor" href="#_4、查看要压测的页面" aria-hidden="true">#</a> 4、查看要压测的页面</h6><p>http://192.168.56.10/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.1.4.png" alt="image-20220712205325631" tabindex="0" loading="lazy"><figcaption>image-20220712205325631</figcaption></figure><h6 id="_5、添加察看结果树、汇总报告、聚合报告" tabindex="-1"><a class="header-anchor" href="#_5、添加察看结果树、汇总报告、聚合报告" aria-hidden="true">#</a> 5、添加<code>察看结果树</code>、<code>汇总报告</code>、<code>聚合报告</code></h6><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>监听器</code> -&gt; <code>察看结果树</code></p><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>监听器</code> -&gt; <code>汇总报告</code></p><p>选中<code>线程组</code>，右键依次选择 <code>添加</code> -&gt; <code>监听器</code> -&gt; <code>聚合报告</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.1.5.png" alt="image-20220712204615385" tabindex="0" loading="lazy"><figcaption>image-20220712204615385</figcaption></figure><h5 id="_2、执行测试-1" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-1" aria-hidden="true">#</a> 2、执行测试</h5><p>先打开<code>docker</code>资源页面查看<code>nginx</code>的资源占用情况，然后点击工具栏的<code>清除全部</code>按钮，然后点击<code>启动</code>按钮，切换到docker容器资源页面，查看<code>nginx</code>的资源使用情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.2.gif" alt="GIF 2022-7-12 20-49-26" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 20-49-26</figcaption></figure><h5 id="_3、查看压测报告" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><h6 id="_1、察看结果树" tabindex="-1"><a class="header-anchor" href="#_1、察看结果树" aria-hidden="true">#</a> 1、察看结果树</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.3.1.png" alt="image-20220712205531631" tabindex="0" loading="lazy"><figcaption>image-20220712205531631</figcaption></figure><h6 id="_2、汇总报告" tabindex="-1"><a class="header-anchor" href="#_2、汇总报告" aria-hidden="true">#</a> 2、汇总报告</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.3.2.png" alt="image-20220712205512240" tabindex="0" loading="lazy"><figcaption>image-20220712205512240</figcaption></figure><h6 id="_3、聚合报告" tabindex="-1"><a class="header-anchor" href="#_3、聚合报告" aria-hidden="true">#</a> 3、聚合报告</h6><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.4.3.3.png" alt="image-20220712205433015" tabindex="0" loading="lazy"><figcaption>image-20220712205433015</figcaption></figure><h4 id="_5、测试gateway" tabindex="-1"><a class="header-anchor" href="#_5、测试gateway" aria-hidden="true">#</a> 5、测试Gateway</h4><h5 id="_1、准备工作-5" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-5" aria-hidden="true">#</a> 1、准备工作</h5><p>准备压测<code>gulimall-gateway</code>模块</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.1.1.png" alt="image-20220715110323719" tabindex="0" loading="lazy"><figcaption>image-20220715110323719</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>88</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.1.2.png" alt="image-20220712205703499" tabindex="0" loading="lazy"><figcaption>image-20220712205703499</figcaption></figure><p>要压测的页面： http://localhost:88/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.1.3.png" alt="image-20220712205736949" tabindex="0" loading="lazy"><figcaption>image-20220712205736949</figcaption></figure><h5 id="_2、执行测试-2" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-2" aria-hidden="true">#</a> 2、执行测试</h5><p>先打开<code>jvisualvm</code>查看<code>GulimallGatewayApplication</code>服务的资源占用情况，然后点击工具栏的<code>清除全部</code>按钮，然后点击<code>启动</code>按钮，切换到<code>jvisualvm</code>查看<code>GulimallGatewayApplication</code>服务的资源占用情况，可以看到网关和nginx差不多，都是消耗cpu型</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.2.gif" alt="GIF 2022-7-12 21-07-11" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 21-07-11</figcaption></figure><h5 id="_3、查看压测报告-1" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-1" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.3.1.png" alt="image-20220712211847512" tabindex="0" loading="lazy"><figcaption>image-20220712211847512</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.3.2.png" alt="image-20220712211858104" tabindex="0" loading="lazy"><figcaption>image-20220712211858104</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.5.3.3.png" alt="image-20220712211909526" tabindex="0" loading="lazy"><figcaption>image-20220712211909526</figcaption></figure><h4 id="_6、测试简单服务" tabindex="-1"><a class="header-anchor" href="#_6、测试简单服务" aria-hidden="true">#</a> 6、测试简单服务</h4><h5 id="_1、准备工作-6" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-6" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.web.IndexController</code>类里添加<code>hello</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.1.1.png" alt="image-20220712212223004" tabindex="0" loading="lazy"><figcaption>image-20220712212223004</figcaption></figure><p>重启<code>GulimallProductApplication</code>服务</p><p>要压测的页面： http://localhost:10000/hello</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.1.2.png" alt="image-20220712212504526" tabindex="0" loading="lazy"><figcaption>image-20220712212504526</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/hello</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.1.3.png" alt="image-20220712212849827" tabindex="0" loading="lazy"><figcaption>image-20220712212849827</figcaption></figure><h5 id="_2、执行测试-3" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-3" aria-hidden="true">#</a> 2、执行测试</h5><p>先打开<code>jvisualvm</code>查看<code>GulimallProductApplication</code>服务的资源占用情况，然后点击工具栏的<code>清除全部</code>按钮，然后点击<code>启动</code>按钮，切换到<code>jvisualvm</code>查看<code>GulimallProductApplication</code>服务的资源占用情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.2.gif" alt="GIF 2022-7-12 21-33-41" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 21-33-41</figcaption></figure><h5 id="_3、查看压测报告-2" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-2" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.3.1.png" alt="image-20220712213634549" tabindex="0" loading="lazy"><figcaption>image-20220712213634549</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.3.2.png" alt="image-20220712213653108" tabindex="0" loading="lazy"><figcaption>image-20220712213653108</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.6.3.3.png" alt="image-20220712213705375" tabindex="0" loading="lazy"><figcaption>image-20220712213705375</figcaption></figure><h4 id="_7、测试gateway-简单服务" tabindex="-1"><a class="header-anchor" href="#_7、测试gateway-简单服务" aria-hidden="true">#</a> 7、测试<code>Gateway</code>+<code>简单服务</code></h4><h5 id="_1、准备工作-7" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-7" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>gulimall-gateway</code>模块的<code>src/main/resources/application.yml</code>配置文件添加路径映射</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>product
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/api/product/<span class="token important">**</span><span class="token punctuation">,</span>/hello
  <span class="token key atrule">filters</span><span class="token punctuation">:</span>
    <span class="token comment"># (?&lt;segment&gt;/?.*) 和 $\{segment} 为固定写法</span>
    <span class="token comment">#http://localhost:88/api/product/category/list/tree 变为 http://localhost:10000/product/category/list/tree</span>
    <span class="token punctuation">-</span> RewritePath=/api/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>/<span class="token punctuation">?</span>.<span class="token important">*)</span><span class="token punctuation">,</span>/$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.1.1.png" alt="image-20220712213939761" tabindex="0" loading="lazy"><figcaption>image-20220712213939761</figcaption></figure><p>重启<code>GulimallGatewayApplication</code>服务，刷新前端页面： http://localhost:88/hello</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.1.2.png" alt="image-20220712214138315" tabindex="0" loading="lazy"><figcaption>image-20220712214138315</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>88</code>，<code>路径</code>输入<code>/hello</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.1.3.png" alt="image-20220712214237380" tabindex="0" loading="lazy"><figcaption>image-20220712214237380</figcaption></figure><h5 id="_2、执行测试-4" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-4" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.2.gif" alt="GIF 2022-7-12 21-46-20" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 21-46-20</figcaption></figure><h5 id="_3、查看压测报告-3" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-3" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.3.1.png" alt="image-20220712214657329" tabindex="0" loading="lazy"><figcaption>image-20220712214657329</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.3.2.png" alt="image-20220712214709096" tabindex="0" loading="lazy"><figcaption>image-20220712214709096</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.7.3.3.png" alt="image-20220712214719048" tabindex="0" loading="lazy"><figcaption>image-20220712214719048</figcaption></figure><h4 id="_8、测试全链路简单服务" tabindex="-1"><a class="header-anchor" href="#_8、测试全链路简单服务" aria-hidden="true">#</a> 8、测试全链路简单服务</h4><h5 id="_1、准备工作-8" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-8" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>gulimall.com</code>，<code>端口号：</code>输入<code>80</code>，<code>路径</code>输入<code>/hello</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.8.1.1.png" alt="image-20220712215447489" tabindex="0" loading="lazy"><figcaption>image-20220712215447489</figcaption></figure><p>要压测的页面： http://gulimall.com/hello</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.8.1.2.png" alt="image-20220712215521006" tabindex="0" loading="lazy"><figcaption>image-20220712215521006</figcaption></figure><h5 id="_2、执行测试-5" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-5" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.8.2.gif" alt="GIF 2022-7-12 21-57-19" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-12 21-57-19</figcaption></figure><h5 id="_3、查看压测报告-4" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-4" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.8.3.1.png" alt="image-20220712215825563" tabindex="0" loading="lazy"><figcaption>image-20220712215825563</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.8.3.2.png" alt="image-20220712215839520" tabindex="0" loading="lazy"><figcaption>image-20220712215839520</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.8.3.3.png" alt="image-20220712215851755" tabindex="0" loading="lazy"><figcaption>image-20220712215851755</figcaption></figure><h4 id="_9、首页一级菜单渲染" tabindex="-1"><a class="header-anchor" href="#_9、首页一级菜单渲染" aria-hidden="true">#</a> 9、首页一级菜单渲染</h4><h5 id="_1、准备工作-9" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-9" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.9.1.1.png" alt="image-20220713085131271" tabindex="0" loading="lazy"><figcaption>image-20220713085131271</figcaption></figure><p>要压测的页面： http://localhost:10000/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.9.1.2.png" alt="image-20220713085155651" tabindex="0" loading="lazy"><figcaption>image-20220713085155651</figcaption></figure><h5 id="_2、执行测试-6" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-6" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.9.2.gif" alt="GIF 2022-7-13 8-53-49" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 8-53-49</figcaption></figure><h5 id="_3、查看压测报告-5" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-5" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.9.3.1.png" alt="image-20220713085519971" tabindex="0" loading="lazy"><figcaption>image-20220713085519971</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.9.3.2.png" alt="image-20220713085535281" tabindex="0" loading="lazy"><figcaption>image-20220713085535281</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.9.3.3.png" alt="image-20220713085549911" tabindex="0" loading="lazy"><figcaption>image-20220713085549911</figcaption></figure><h4 id="_10、三级分类数据获取" tabindex="-1"><a class="header-anchor" href="#_10、三级分类数据获取" aria-hidden="true">#</a> 10、三级分类数据获取</h4><h5 id="_1、准备工作-10" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-10" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/index/catalog.json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.10.1.1.png" alt="image-20220713190216851" tabindex="0" loading="lazy"><figcaption>image-20220713190216851</figcaption></figure><p>要压测的页面是：http://localhost:10000/index/catalog.json</p><p>而不是：http://localhost:10000/index/json/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.10.1.2.png" alt="image-20220713190257988" tabindex="0" loading="lazy"><figcaption>image-20220713190257988</figcaption></figure><h5 id="_2、执行测试-7" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-7" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.10.2.gif" alt="GIF 2022-7-13 19-10-35" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 19-10-35</figcaption></figure><h5 id="_3、察看结果树-1" tabindex="-1"><a class="header-anchor" href="#_3、察看结果树-1" aria-hidden="true">#</a> 3、<strong>察看结果树</strong></h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.10.3.1.png" alt="image-20220713191148245" tabindex="0" loading="lazy"><figcaption>image-20220713191148245</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.10.3.2.png" alt="image-20220713191201840" tabindex="0" loading="lazy"><figcaption>image-20220713191201840</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.10.3.3.png" alt="image-20220713191218051" tabindex="0" loading="lazy"><figcaption>image-20220713191218051</figcaption></figure><h4 id="_11、首页全量数据获取" tabindex="-1"><a class="header-anchor" href="#_11、首页全量数据获取" aria-hidden="true">#</a> 11、首页全量数据获取</h4><h5 id="_1、准备工作-11" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-11" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.1.1.png" alt="image-20220713091414524" tabindex="0" loading="lazy"><figcaption>image-20220713091414524</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，勾选<code>从HTML文件获取所有内含的资源</code>和<code>并行下载</code>(并行下载数量为6)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.1.2.png" alt="image-20220713091431240" tabindex="0" loading="lazy"><figcaption>image-20220713091431240</figcaption></figure><p>要压测的页面： http://localhost:10000/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.1.3.png" alt="image-20220713091450595" tabindex="0" loading="lazy"><figcaption>image-20220713091450595</figcaption></figure><h5 id="_2、执行测试-8" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-8" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.2.gif" alt="GIF 2022-7-13 9-17-26" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 9-17-26</figcaption></figure><h5 id="_3、查看压测报告-6" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-6" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><p>在<code>察看结果树</code>的<code>取样器结果</code>里报了<code>404</code>的错误</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.3.1.png" alt="image-20220713091958676" tabindex="0" loading="lazy"><figcaption>image-20220713091958676</figcaption></figure><p>在<code>察看结果树</code>的<code>响应数据</code>里的<code>Response Body</code>里可以看到页面请求成功了，报<code>404</code>是因为有些<code>图片</code>、<code>javascript</code>没有请求成功</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.3.2.png" alt="image-20220713091944626" tabindex="0" loading="lazy"><figcaption>image-20220713091944626</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.3.3.png" alt="image-20220713092020556" tabindex="0" loading="lazy"><figcaption>image-20220713092020556</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.11.3.4.png" alt="image-20220713092032116" tabindex="0" loading="lazy"><figcaption>image-20220713092032116</figcaption></figure><h4 id="_12、首页渲染-开缓存" tabindex="-1"><a class="header-anchor" href="#_12、首页渲染-开缓存" aria-hidden="true">#</a> 12、首页渲染（开缓存）</h4><h5 id="_1、准备工作-12" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-12" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件里，把<code>thymeleaf</code>缓存打开</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.1.1.png" alt="image-20220713092819303" tabindex="0" loading="lazy"><figcaption>image-20220713092819303</figcaption></figure><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>50</code>，表示<strong>启动50个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.1.2.png" alt="image-20220713092941056" tabindex="0" loading="lazy"><figcaption>image-20220713092941056</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.1.3.png" alt="image-20220713092958127" tabindex="0" loading="lazy"><figcaption>image-20220713092958127</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，取消勾选<code>从HTML文件获取所有内含的资源</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.1.4.png" alt="image-20220713093012837" tabindex="0" loading="lazy"><figcaption>image-20220713093012837</figcaption></figure><p>要压测的页面： http://localhost:10000/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.1.5.png" alt="image-20220713093042423" tabindex="0" loading="lazy"><figcaption>image-20220713093042423</figcaption></figure><h5 id="_2、执行测试-9" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-9" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.2.gif" alt="GIF 2022-7-13 9-33-24" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 9-33-24</figcaption></figure><h5 id="_3、查看压测报告-7" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-7" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.3.1.png" alt="image-20220713093606192" tabindex="0" loading="lazy"><figcaption>image-20220713093606192</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.3.2.png" alt="image-20220713093616704" tabindex="0" loading="lazy"><figcaption>image-20220713093616704</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.12.3.3.png" alt="image-20220713093629776" tabindex="0" loading="lazy"><figcaption>image-20220713093629776</figcaption></figure><h4 id="_13、首页渲染-开缓存、优化数据库、关日志" tabindex="-1"><a class="header-anchor" href="#_13、首页渲染-开缓存、优化数据库、关日志" aria-hidden="true">#</a> 13、首页渲染（开缓存、优化数据库、关日志）</h4><h5 id="_1、修改日志级别" tabindex="-1"><a class="header-anchor" href="#_1、修改日志级别" aria-hidden="true">#</a> 1、修改日志级别</h5><p>修改<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件的日志级别</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.atguigu.gulimall</span><span class="token punctuation">:</span> error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.1.png" alt="image-20220713094701394" tabindex="0" loading="lazy"><figcaption>image-20220713094701394</figcaption></figure><h5 id="_2、使用索引" tabindex="-1"><a class="header-anchor" href="#_2、使用索引" aria-hidden="true">#</a> 2、使用索引</h5><h6 id="_1、没加索引" tabindex="-1"><a class="header-anchor" href="#_1、没加索引" aria-hidden="true">#</a> 1、没加索引</h6><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类的<code>getLevel1Categories</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getParentCid</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getCatId</span><span class="token punctuation">,</span> <span class="token class-name">CategoryEntity</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消耗时间：&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> categoryEntities<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.2.1.1.png" alt="image-20220713094412296" tabindex="0" loading="lazy"><figcaption>image-20220713094412296</figcaption></figure><p>多刷新几次主页后再测试：http://localhost:10000/</p><p>可以看到，消耗的时间都在<code>2~5</code>秒</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.2.1.2.png" alt="image-20220713095240494" tabindex="0" loading="lazy"><figcaption>image-20220713095240494</figcaption></figure><h6 id="_2、加索引" tabindex="-1"><a class="header-anchor" href="#_2、加索引" aria-hidden="true">#</a> 2、加索引</h6><p>打开<code>navicat</code>，选择<code>gulimall_pms</code>数据库的<code>pms_category</code>表，右键选择<code>设计表</code></p><p>点击<code>索引</code>，在<code>字段</code>里选择<code>parent_cid</code>，然后点击<code>保存</code>，这样就给<code>parent_cid</code>添加了一个默认的索引</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.2.2.1.png" alt="image-20220713095524701" tabindex="0" loading="lazy"><figcaption>image-20220713095524701</figcaption></figure><p><code>名</code>、<code>索引类型</code>、<code>索引方法</code>都为系统自动生成的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.2.2.2.png" alt="image-20220713095334084" tabindex="0" loading="lazy"><figcaption>image-20220713095334084</figcaption></figure><p>多刷新几次主页后再测试：http://localhost:10000/ （不用重启服务。保险起见，也可以重启<code>GulimallProductApplication</code>服务）</p><p>可以看到，消耗的时间都在<code>1~3</code>秒，加索引后速度还是有明显提升的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.2.2.3.png" alt="image-20220713095807730" tabindex="0" loading="lazy"><figcaption>image-20220713095807730</figcaption></figure><h5 id="_3、执行测试" tabindex="-1"><a class="header-anchor" href="#_3、执行测试" aria-hidden="true">#</a> 3、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.3.gif" alt="GIF 2022-7-13 10-01-01" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 10-01-01</figcaption></figure><h5 id="_4、查看压测报告" tabindex="-1"><a class="header-anchor" href="#_4、查看压测报告" aria-hidden="true">#</a> 4、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.4.1.png" alt="image-20220713100251659" tabindex="0" loading="lazy"><figcaption>image-20220713100251659</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.4.2.png" alt="image-20220713100343229" tabindex="0" loading="lazy"><figcaption>image-20220713100343229</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.13.4.3.png" alt="image-20220713100356061" tabindex="0" loading="lazy"><figcaption>image-20220713100356061</figcaption></figure><h4 id="_14、三级分类-优化业务" tabindex="-1"><a class="header-anchor" href="#_14、三级分类-优化业务" aria-hidden="true">#</a> 14、三级分类（优化业务）</h4><h5 id="_1、准备工作-13" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-13" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/index/catalog.json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.1.1.png" alt="image-20220713185422580" tabindex="0" loading="lazy"><figcaption>image-20220713185422580</figcaption></figure><p>要压测的页面是： http://localhost:10000/index/catalog.json</p><p>而不是： http://localhost:10000/index/json/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.1.2.png" alt="image-20220713185442346" tabindex="0" loading="lazy"><figcaption>image-20220713185442346</figcaption></figure><h5 id="_2、执行测试-10" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-10" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.2.gif" alt="GIF 2022-7-13 18-56-32" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 18-56-32</figcaption></figure><h5 id="_3、查看压测报告-8" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-8" aria-hidden="true">#</a> 3、查看压测报告</h5><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.3.1.png" alt="image-20220713185805721" tabindex="0" loading="lazy"><figcaption>image-20220713185805721</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.3.2.png" alt="image-20220713185839666" tabindex="0" loading="lazy"><figcaption>image-20220713185839666</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.3.3.png" alt="image-20220713185857661" tabindex="0" loading="lazy"><figcaption>image-20220713185857661</figcaption></figure><p>查询数据库消耗的时间：</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.7.14.3.4.png" alt="image-20220713190139525" tabindex="0" loading="lazy"><figcaption>image-20220713190139525</figcaption></figure><h4 id="_15、压测报告表" tabindex="-1"><a class="header-anchor" href="#_15、压测报告表" aria-hidden="true">#</a> 15、压测报告表</h4><table><thead><tr><th>压测内容</th><th>压测线程数</th><th>吞吐量/s</th><th>90%响应时间/ms</th><th>99%响应时间/ms</th></tr></thead><tbody><tr><td>Nginx</td><td>50</td><td>882</td><td>15</td><td>1899</td></tr><tr><td>Gateway</td><td>50</td><td>1552</td><td>47</td><td>149</td></tr><tr><td>简单服务</td><td>50</td><td>11431</td><td>8</td><td>24</td></tr><tr><td>首页一级菜单渲染</td><td>50</td><td>202</td><td>381</td><td>645</td></tr><tr><td>首页渲染（开缓存）</td><td>50</td><td>229</td><td>286</td><td>497</td></tr><tr><td>首页渲染（开缓存、优化数据库、关日志）</td><td>50</td><td>510</td><td>174</td><td>333</td></tr><tr><td>三级分类数据获取</td><td>50</td><td>1.5</td><td>33628</td><td>33789</td></tr><tr><td>三级分类（优化业务）</td><td>50</td><td>4.9</td><td>13230</td><td>14285</td></tr><tr><td>优化三级分类查询(查询一次数据库)</td><td>5</td><td>89.3</td><td>839</td><td>2047</td></tr><tr><td>三 级 分 类 （ 使用 redis 作为缓存）</td><td>50</td><td>159</td><td>422</td><td>842</td></tr><tr><td>首页全量数据获取</td><td>50</td><td>3</td><td>33699</td><td>38237</td></tr><tr><td>Nginx+Gateway</td><td>50</td><td></td><td></td><td></td></tr><tr><td>Gateway+简单服务</td><td>50</td><td>793</td><td>98</td><td>159</td></tr><tr><td>全链路</td><td>50</td><td>346</td><td>171</td><td>1240</td></tr></tbody></table><h3 id="_5-3-8、配置nginx" tabindex="-1"><a class="header-anchor" href="#_5-3-8、配置nginx" aria-hidden="true">#</a> 5.3.8、配置nginx</h3><h4 id="_1、nginx动静分离" tabindex="-1"><a class="header-anchor" href="#_1、nginx动静分离" aria-hidden="true">#</a> 1、nginx动静分离</h4><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.0.png" alt="image-20220721205151205" tabindex="0" loading="lazy"><figcaption>image-20220721205151205</figcaption></figure><p>1、以后将所有项目的静态资源都应该放在nginx里面</p><p>2、规则：/static/**所有请求都由nginx直接返回</p><h5 id="_1、复制文件" tabindex="-1"><a class="header-anchor" href="#_1、复制文件" aria-hidden="true">#</a> 1、复制文件</h5><p>在虚拟机的<code>/mydata/nginx/html/</code>目录里新建<code>static</code>目录，用于存放静态文件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /mydata/nginx/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> html/
<span class="token function">ls</span>
<span class="token function">mkdir</span> static
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> static/
<span class="token function">ls</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.1.1.png" alt="image-20220713111438938" tabindex="0" loading="lazy"><figcaption>image-20220713111438938</figcaption></figure><p>将<code>gulimall-product\src\main\resources\static</code>目录下的<code>index</code>文件夹复制到虚拟机的<code>/mydata/nginx/html/static</code>目录里</p><p>复制完后，删除<code>gulimall-product\src\main\resources\static</code>目录下的<code>index</code>文件夹</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.1.2.gif" alt="GIF 2022-7-13 14-31-53" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 14-31-53</figcaption></figure><h5 id="_2、修改index-html" tabindex="-1"><a class="header-anchor" href="#_2、修改index-html" aria-hidden="true">#</a> 2、修改<code>index.html</code></h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件里，修改部分代码，在所有请求的路径前都加上<code>/static/</code>(第一个<code>/</code>表示在当前项目下),使静态资源访问<code>nigix</code></p><p><a href="/gulimall/code/5.3.8.1.2.index.html" class="">点击查看<code>index.html</code>完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.2.png" alt="image-20220713145539244" tabindex="0" loading="lazy"><figcaption>image-20220713145539244</figcaption></figure><h5 id="_3、关闭缓存" tabindex="-1"><a class="header-anchor" href="#_3、关闭缓存" aria-hidden="true">#</a> 3、关闭缓存</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件里，把<code>thymeleaf</code>缓存关闭</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.3.png" alt="image-20220713145612544" tabindex="0" loading="lazy"><figcaption>image-20220713145612544</figcaption></figure><h5 id="_4、修改niginx配置" tabindex="-1"><a class="header-anchor" href="#_4、修改niginx配置" aria-hidden="true">#</a> 4、修改<code>niginx</code>配置</h5><p>查看虚拟机的<code>/mydata/nginx/conf/conf.d/default.conf</code>文件的配置</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /mydata/nginx/conf/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> conf.d/
<span class="token function">ls</span>
<span class="token function">cat</span> default.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.4.1.png" alt="image-20220713150356251" tabindex="0" loading="lazy"><figcaption>image-20220713150356251</figcaption></figure><p>复制<code>default.conf</code>文件里的<code>root /usr/share/nginx/html;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.4.2.png" alt="image-20220713145904671" tabindex="0" loading="lazy"><figcaption>image-20220713145904671</figcaption></figure><p>选中<code>1 电商</code>，右键选中<code>复制会话(D)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.4.3.png" alt="image-20220713152323017" tabindex="0" loading="lazy"><figcaption>image-20220713152323017</figcaption></figure><p>编辑<code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件，然后重启<code>nginx</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cd &quot;/mydata/nginx/conf/conf.d&quot;
ls
vi gulimall.conf
docker restart nginx
docker ps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.4.4.png" alt="image-20220713151144140" tabindex="0" loading="lazy"><figcaption>image-20220713151144140</figcaption></figure><p>在<code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件里配置以<code>/static/</code>开头的路径的访问规则</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>location /static/ {
	root   /usr/share/nginx/html;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.4.5.png" alt="image-20220713150219942" tabindex="0" loading="lazy"><figcaption>image-20220713150219942</figcaption></figure><p><code>/mydata/nginx/conf/conf.d/gulimall.conf</code>文件的完整内容：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">server</span> <span class="token value attr-value">{</span>
<span class="token key attr-name">    listen</span> <span class="token value attr-value">      80;</span>
<span class="token key attr-name">    server_name</span> <span class="token value attr-value"> gulimall.com;</span>

<span class="token comment">    #charset koi8-r;</span>
<span class="token comment">    #access_log  /var/log/nginx/log/host.access.log  main;</span>

<span class="token key attr-name">    location</span> <span class="token value attr-value">/static/ {</span>
<span class="token key attr-name">        root</span> <span class="token value attr-value">  /usr/share/nginx/html;</span>
    }

<span class="token key attr-name">    location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">        proxy_set_header</span> <span class="token value attr-value">Host $host;</span>
<span class="token key attr-name">        proxy_pass</span> <span class="token value attr-value">http://gulimall;</span>
    }

<span class="token comment">    #error_page  404              /404.html;</span>

<span class="token comment">    # redirect server error pages to the static page /50x.html</span>
<span class="token comment">    #</span>
<span class="token key attr-name">    error_page</span> <span class="token value attr-value">  500 502 503 504  /50x.html;</span>
<span class="token key attr-name">    location</span> <span class="token punctuation">=</span> <span class="token value attr-value">/50x.html {</span>
<span class="token key attr-name">        root</span> <span class="token value attr-value">  /usr/share/nginx/html;</span>
    }

<span class="token comment">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ \.php$ {</span>
<span class="token comment">    #    proxy_pass   http://127.0.0.1;</span>
<span class="token comment">    #}</span>

<span class="token comment">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ \.php$ {</span>
<span class="token comment">    #    root           html;</span>
<span class="token comment">    #    fastcgi_pass   127.0.0.1:9000;</span>
<span class="token comment">    #    fastcgi_index  index.php;</span>
<span class="token comment">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
<span class="token comment">    #    include        fastcgi_params;</span>
<span class="token comment">    #}</span>

<span class="token comment">    # deny access to .htaccess files, if Apache&#39;s document root</span>
<span class="token comment">    # concurs with nginx&#39;s one</span>
<span class="token comment">    #</span>
<span class="token comment">    #location ~ /\.ht {</span>
<span class="token comment">    #    deny  all;</span>
<span class="token comment">    #}</span>
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5、访问首页" tabindex="-1"><a class="header-anchor" href="#_5、访问首页" aria-hidden="true">#</a> 5、访问首页</h5><p>首先清除浏览器缓存，依次点击<code>chrome</code>浏览器的 竖着的三个点 -&gt; <code>设置</code> -&gt; <code>隐私设置和安全性</code> -&gt; <code>清吟浏览数据</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.5.1.png" alt="image-20220713154833600" tabindex="0" loading="lazy"><figcaption>image-20220713154833600</figcaption></figure><p>访问: http://gulimall.com/</p><p>可以看到，绝大部分都可以访问，只有两个不能访问，这两个文件本来就没有，当然无法访问，不用管这两个</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.5.2.png" alt="image-20220713154008320" tabindex="0" loading="lazy"><figcaption>image-20220713154008320</figcaption></figure><p>可以删掉这两个不能访问的请求</p><p>注释掉<code>&lt;img src=&quot;/static/index/img/top_find_logo.png&quot; alt=&quot;&quot;&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.5.3.png" alt="image-20220713155237607" tabindex="0" loading="lazy"><figcaption>image-20220713155237607</figcaption></figure><p>注释掉<code>&lt;script type=&quot;text/javascript&quot; src=&quot;/static/index/jsindex.js&quot;&gt;&lt;/script&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.1.5.4.png" alt="image-20220713155309068" tabindex="0" loading="lazy"><figcaption>image-20220713155309068</figcaption></figure><h4 id="_2、对nginx进行压力测试" tabindex="-1"><a class="header-anchor" href="#_2、对nginx进行压力测试" aria-hidden="true">#</a> 2、对<code>nginx</code>进行压力测试</h4><h5 id="_1、准备工作-14" tabindex="-1"><a class="header-anchor" href="#_1、准备工作-14" aria-hidden="true">#</a> 1、准备工作</h5><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>配置文件里，把<code>thymeleaf</code>缓存打开</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启<code>GulimallProductApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.1.1.png" alt="image-20220713154704430" tabindex="0" loading="lazy"><figcaption>image-20220713154704430</figcaption></figure><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>50</code>，表示<strong>启动50个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.1.2.png" alt="image-20220713154553456" tabindex="0" loading="lazy"><figcaption>image-20220713154553456</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>gulimall.com</code>，<code>端口号：</code>输入<code>80</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.1.3.png" alt="image-20220713154608124" tabindex="0" loading="lazy"><figcaption>image-20220713154608124</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，勾选<code>从HTML文件获取所有内含的资源</code>和<code>并行下载</code>(并行下载数量为6)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.1.4.png" alt="image-20220713154619058" tabindex="0" loading="lazy"><figcaption>image-20220713154619058</figcaption></figure><p>要压测的页面： http://gulimall.com/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.1.5.png" alt="image-20220713154918926" tabindex="0" loading="lazy"><figcaption>image-20220713154918926</figcaption></figure><h5 id="_2、执行测试-11" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-11" aria-hidden="true">#</a> 2、执行测试</h5><p>如果在<code>查看结果树</code>里全是异常也不要紧，只是没有把<code>想要访问不存在的资源</code>的语句删掉而已</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.2.1.gif" alt="GIF 2022-7-13 16-02-21" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 16-02-21</figcaption></figure><p>在测试期间，使用<code>jvisualvm</code>查看<code>CPU</code>、<code>堆</code>等的资源消耗情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.2.2.gif" alt="GIF 2022-7-13 16-12-34" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 16-12-34</figcaption></figure><h5 id="_3、查看压测报告-9" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-9" aria-hidden="true">#</a> 3、查看压测报告</h5><p>这次结果虽然比以前好一点，但是<code>jmeter</code>卡死了几次，以前都没卡死过</p><p>把压测报告写入压测报告表中（在<code>5.3.7.15、压测报告表</code>里面)</p><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.3.1.png" alt="image-20220713160459499" tabindex="0" loading="lazy"><figcaption>image-20220713160459499</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.3.2.png" alt="image-20220713160510090" tabindex="0" loading="lazy"><figcaption>image-20220713160510090</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.2.3.3.png" alt="image-20220713160520393" tabindex="0" loading="lazy"><figcaption>image-20220713160520393</figcaption></figure><h4 id="_3、oom" tabindex="-1"><a class="header-anchor" href="#_3、oom" aria-hidden="true">#</a> 3、OOM</h4><h5 id="_1、调大线程数" tabindex="-1"><a class="header-anchor" href="#_1、调大线程数" aria-hidden="true">#</a> 1、调大线程数</h5><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>200</code>，表示<strong>启动200个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.1.1.png" alt="image-20220713164142976" tabindex="0" loading="lazy"><figcaption>image-20220713164142976</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.1.2.png" alt="image-20220713164154508" tabindex="0" loading="lazy"><figcaption>image-20220713164154508</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，勾选<code>从HTML文件获取所有内含的资源</code>和<code>并行下载</code>(并行下载数量为6)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.1.3.png" alt="image-20220713164205572" tabindex="0" loading="lazy"><figcaption>image-20220713164205572</figcaption></figure><p>要压测的页面： http://localhost:10000/</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.1.4.png" alt="image-20220713164247057" tabindex="0" loading="lazy"><figcaption>image-20220713164247057</figcaption></figure><h5 id="_2、执行测试-12" tabindex="-1"><a class="header-anchor" href="#_2、执行测试-12" aria-hidden="true">#</a> 2、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.2.1.gif" alt="GIF 2022-7-13 16-29-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 16-29-17</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.2.2.gif" alt="GIF 2022-7-13 16-51-59" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 16-51-59</figcaption></figure><h5 id="_3、查看压测报告-10" tabindex="-1"><a class="header-anchor" href="#_3、查看压测报告-10" aria-hidden="true">#</a> 3、查看压测报告</h5><p>报<code>java.lang.OutOfMemoryError</code>异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Exception in thread &quot;RMI TCP Connection(idle)&quot; java.lang.OutOfMemoryError: Java heap space
Exception in thread &quot;http-nio-10000-Acceptor&quot; java.lang.OutOfMemoryError: Java heap space
Exception in thread &quot;http-nio-10000-BlockPoller&quot; Exception in thread &quot;File Watcher&quot; java.lang.OutOfMemoryError: Java heap space
java.lang.OutOfMemoryError: Java heap space
*** java.lang.instrument ASSERTION FAILED ***: &quot;!errorOutstanding&quot; with message can&#39;t create name string at JPLISAgent.c line: 807
Exception in thread &quot;http-nio-10000-ClientPoller&quot; java.lang.OutOfMemoryError: Java heap space

Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &quot;com.alibaba.nacos.client.Worker.fixed-127.0.0.1_8848-d6d03bd1-5815-4fa1-8caf-93b09462fd45&quot;

Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &quot;http-nio-10000-exec-206&quot;
Exception in thread &quot;http-nio-10000-exec-490&quot; 
Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &quot;http-nio-10000-exec-329&quot;
java.lang.OutOfMemoryError: Java heap space
Exception in thread &quot;http-nio-10000-exec-304&quot; java.lang.OutOfMemoryError: Java heap space
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.3.1.png" alt="image-20220713163701403" tabindex="0" loading="lazy"><figcaption>image-20220713163701403</figcaption></figure><p>刷新 http://localhost:10000/ 页面，可以发现无法访问</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.3.2.png" alt="image-20220713163906526" tabindex="0" loading="lazy"><figcaption>image-20220713163906526</figcaption></figure><p>此时堆使用的内存已满</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.3.3.png" alt="image-20220713163930108" tabindex="0" loading="lazy"><figcaption>image-20220713163930108</figcaption></figure><p><code>CPU</code>和<code>堆</code>资源占用都非常高</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.3.4.png" alt="image-20220713164002784" tabindex="0" loading="lazy"><figcaption>image-20220713164002784</figcaption></figure><h5 id="_4、调大堆内存" tabindex="-1"><a class="header-anchor" href="#_4、调大堆内存" aria-hidden="true">#</a> 4、调大堆内存</h5><blockquote><p>-Xss 设置每个线程可使用的内存大小，即栈的大小。 -Xms 堆内存的最小值，默认为物理内存的1/64。 -Xmx 堆内存的最大值，默认为物理内存的1/4。 -Xmn 堆内新生代(Eden+两个Survior)的大小，一般占据堆的 1/3 空间。通过这个值也可以得到老生代的大小：-Xmx减去-Xmn。</p></blockquote><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-Xmx1024m -Xms1024m -Xmn512m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在<code>GulimallProductApplication</code>模块的运行配置里的<code>Environment</code>栏的<code>VM options</code>里的右方框里输入<code>-Xmx1024m -Xms1024m -Xmn512m</code>，限制<code>GulimallProductApplication</code>模块的最大内存占用为<code>1024m</code>，最小内存占用为<code>1024m</code>，新生代的内存占用为<code>512m</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.4.png" alt="image-20220713165813319" tabindex="0" loading="lazy"><figcaption>image-20220713165813319</figcaption></figure><h5 id="_5、重新测试" tabindex="-1"><a class="header-anchor" href="#_5、重新测试" aria-hidden="true">#</a> 5、重新测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.5.gif" alt="GIF 2022-7-13 17-08-53" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 17-08-53</figcaption></figure><h5 id="_6、查看压测报告" tabindex="-1"><a class="header-anchor" href="#_6、查看压测报告" aria-hidden="true">#</a> 6、查看压测报告</h5><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.6.1.png" alt="image-20220713171228131" tabindex="0" loading="lazy"><figcaption>image-20220713171228131</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.6.2.png" alt="image-20220713171240146" tabindex="0" loading="lazy"><figcaption>image-20220713171240146</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.6.3.png" alt="image-20220713171253126" tabindex="0" loading="lazy"><figcaption>image-20220713171253126</figcaption></figure><p><code>Visual GC</code>里显示，过了很久也没出现内存不足的情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.6.4.png" alt="image-20220713172145919" tabindex="0" loading="lazy"><figcaption>image-20220713172145919</figcaption></figure><p><code>堆</code>在使用峰值时，也没有超过规定的<code>1024m</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.6.5.png" alt="image-20220713172159697" tabindex="0" loading="lazy"><figcaption>image-20220713172159697</figcaption></figure><p><code>GulimallProductApplication</code>服务的控制台也没报任何异常，说明调大内存可以很好地解决请求数过多的情况</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.3.6.6.png" alt="image-20220713172253880" tabindex="0" loading="lazy"><figcaption>image-20220713172253880</figcaption></figure><h4 id="_4、优化三级分类查询" tabindex="-1"><a class="header-anchor" href="#_4、优化三级分类查询" aria-hidden="true">#</a> 4、优化三级分类查询</h4><h5 id="_1、修改getcatalogjson方法" tabindex="-1"><a class="header-anchor" href="#_1、修改getcatalogjson方法" aria-hidden="true">#</a> 1、修改<code>getCatalogJson</code>方法</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.CategoryServiceImpl</code>类里修改<code>getCatalogJson</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//一次查询所有</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1、查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel1Categories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l1 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、该一级分类的所有二级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category2Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span>l1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">&gt;</span></span> catelog2VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>category2Entities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catelog2VoList <span class="token operator">=</span> category2Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog1Id</span><span class="token punctuation">(</span>l1<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//3、当前二级分类的所有三级分类</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> category3Entities <span class="token operator">=</span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span>categoryEntities<span class="token punctuation">,</span>l2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">&gt;</span></span> catelog3VoList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>category3Entities<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    catelog3VoList <span class="token operator">=</span> category3Entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span> catelog3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Catelog3Vo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        catelog3Vo<span class="token punctuation">.</span><span class="token function">setCatalog2Id</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> catelog3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>catelog3VoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catelog2VoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCategoryEntities</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities<span class="token punctuation">,</span><span class="token class-name">CategoryEntity</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//LambdaQueryWrapper&lt;CategoryEntity&gt; category2QueryWrapper = new LambdaQueryWrapper&lt;&gt;();</span>
    <span class="token comment">//category2QueryWrapper.eq(CategoryEntity::getParentCid, l1.getCatId());</span>
    <span class="token comment">//return this.baseMapper.selectList(category2QueryWrapper);</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> categoryEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>categoryEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> categoryEntity<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.1.png" alt="image-20220713183352367" tabindex="0" loading="lazy"><figcaption>image-20220713183352367</figcaption></figure><h5 id="_2、准备工作" tabindex="-1"><a class="header-anchor" href="#_2、准备工作" aria-hidden="true">#</a> 2、准备工作</h5><p>在<code>GulimallProductApplication</code>模块的运行配置里的<code>Environment</code>栏的<code>VM options</code>里的右方框里输入<code>-Xmx100m</code>，重新限制<code>GulimallProductApplication</code>模块的最大内存占用为<code>100m</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-Xmx100m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.2.1.png" alt="image-20220713183513139" tabindex="0" loading="lazy"><figcaption>image-20220713183513139</figcaption></figure><p>要压测的请求： http://localhost:10000/index/catalog.json</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.2.2.png" alt="image-20220713183630444" tabindex="0" loading="lazy"><figcaption>image-20220713183630444</figcaption></figure><p>在<code>线程组</code>的<code>线程属性</code>里的<code>线程数</code>里输入<code>50</code>，表示<strong>启动50个线程</strong></p><p>在<code>线程组</code>的<code>线程属性</code>里的<code>Ramp-Up时间(秒) :</code>里输入<code>1</code>，表示<strong>1秒内启动完成</strong></p><p>在<code>线程组</code>的<code>循环次数</code>里勾选<code>永远</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.2.3.png" alt="image-20220713183932382" tabindex="0" loading="lazy"><figcaption>image-20220713183932382</figcaption></figure><p>在<code>HTTP请求</code>的<code>基本</code>里的<code>Web服务器</code>里 <code>协议：</code>输入<code>http</code>，<code>服务器名称或IP:</code>输入<code>localhost</code>，<code>端口号：</code>输入<code>10000</code>，<code>路径</code>输入<code>/index/catalog.json</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.2.4.png" alt="image-20220713183947336" tabindex="0" loading="lazy"><figcaption>image-20220713183947336</figcaption></figure><p>在<code>HTTP请求</code>的<code>高级</code>里，取消勾选<code>从HTML文件获取所有内含的资源</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.2.5.png" alt="image-20220713183958623" tabindex="0" loading="lazy"><figcaption>image-20220713183958623</figcaption></figure><h5 id="_3、执行测试-1" tabindex="-1"><a class="header-anchor" href="#_3、执行测试-1" aria-hidden="true">#</a> 3、执行测试</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.3.gif" alt="GIF 2022-7-13 18-45-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-7-13 18-45-40</figcaption></figure><h5 id="_4、查看压测报告-1" tabindex="-1"><a class="header-anchor" href="#_4、查看压测报告-1" aria-hidden="true">#</a> 4、查看压测报告</h5><p><strong>察看结果树</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.4.1.png" alt="image-20220713184654867" tabindex="0" loading="lazy"><figcaption>image-20220713184654867</figcaption></figure><p><strong>汇总报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.4.2.png" alt="image-20220713184706250" tabindex="0" loading="lazy"><figcaption>image-20220713184706250</figcaption></figure><p><strong>聚合报告</strong></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.3.8.4.4.3.png" alt="image-20220713184720393" tabindex="0" loading="lazy"><figcaption>image-20220713184720393</figcaption></figure></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/apzs/apzs.github.io/edit/master/src/gulimall/advanced1.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: apzs@foxmaill.com">zhaoshuo</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.0.0-alpha.8</div></div></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2024 apzs</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-ldxHvpH7.js" defer></script>
  </body>
</html>
