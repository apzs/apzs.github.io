<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.5" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://apzs.github.io/gulimall/advanced5.html"><meta property="og:site_name" content="apzs"><meta property="og:title" content="六、订单"><meta property="og:description" content="5.8.RabbitMQ 5.8.1、RabbitMQ 基本使用 1、基本概念 主流的消息队列对比 特性 ActiveMQ RabbitMQ RocketMQ Kafka 单机吞吐量 万级，比 RocketMQ、Kafka 低一个数量级 同 ActiveMQ 10 万级，支撑高吞吐 10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景 topic 数量对吞吐量的影响 topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源 时效性 ms 级 微秒级，这是 RabbitMQ 的一大特点，延迟最低 ms 级 延迟在 ms 级以内 可用性 高，基于主从架构实现高可用 同 ActiveMQ 非常高，分布式架构 非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用 消息可靠性 有较低的概率丢失数据 基本不丢 经过参数优化配置，可以做到 0 丢失 同 RocketMQ 功能支持 MQ 领域的功能极其完备 基于 erlang 开发，并发能力很强，性能极好，延时很低 MQ 功能较为完善，还是分布式的，扩展性好 功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-05T06:05:15.000Z"><meta property="article:author" content="apzs"><meta property="article:modified_time" content="2024-03-05T06:05:15.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"六、订单","image":[""],"dateModified":"2024-03-05T06:05:15.000Z","author":[{"@type":"Person","name":"apzs","url":"https://apzs.eu.org"}]}</script><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>六、订单 | apzs</title><meta name="description" content="5.8.RabbitMQ 5.8.1、RabbitMQ 基本使用 1、基本概念 主流的消息队列对比 特性 ActiveMQ RabbitMQ RocketMQ Kafka 单机吞吐量 万级，比 RocketMQ、Kafka 低一个数量级 同 ActiveMQ 10 万级，支撑高吞吐 10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景 topic 数量对吞吐量的影响 topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源 时效性 ms 级 微秒级，这是 RabbitMQ 的一大特点，延迟最低 ms 级 延迟在 ms 级以内 可用性 高，基于主从架构实现高可用 同 ActiveMQ 非常高，分布式架构 非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用 消息可靠性 有较低的概率丢失数据 基本不丢 经过参数优化配置，可以做到 0 丢失 同 RocketMQ 功能支持 MQ 领域的功能极其完备 基于 erlang 开发，并发能力很强，性能极好，延时很低 MQ 功能较为完善，还是分布式的，扩展性好 功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用">
    <link rel="preload" href="/assets/style-1BJnvNLI.css" as="style"><link rel="stylesheet" href="/assets/style-1BJnvNLI.css">
    <link rel="modulepreload" href="/assets/app-YilgCgZO.js"><link rel="modulepreload" href="/assets/advanced5.html-x_FAsfet.js"><link rel="modulepreload" href="/assets/advanced5.html-P8fzJ-04.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/assets/index.html-y3g4CpbS.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-gEURi3aX.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-OcxTIOHO.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-XR72c_om.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-ZR4Y_K2h.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-M2icssIB.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-7Kx2gTnc.js" as="script"><link rel="prefetch" href="/assets/7.git.html-qXt_wASp.js" as="script"><link rel="prefetch" href="/assets/advanced1.html-9bBPC8sA.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-ZcYyohxw.js" as="script"><link rel="prefetch" href="/assets/advanced3.html--EENfr4C.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-qON-1HJR.js" as="script"><link rel="prefetch" href="/assets/advanced6.html-7fOhj-hR.js" as="script"><link rel="prefetch" href="/assets/base1.html-eTaS1DsU.js" as="script"><link rel="prefetch" href="/assets/base2.html-uamOpGZW.js" as="script"><link rel="prefetch" href="/assets/cluster.html-054M96dh.js" as="script"><link rel="prefetch" href="/assets/index.html-JHGBtjxR.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-pkyzvvBx.js" as="script"><link rel="prefetch" href="/assets/index.html-xnChJEJr.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-ihCCvaOP.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-DlR6lbEF.js" as="script"><link rel="prefetch" href="/assets/index.html-WlJS5XKx.js" as="script"><link rel="prefetch" href="/assets/index.html-PIK5baKV.js" as="script"><link rel="prefetch" href="/assets/01. Object类、常用API.html-lHyRs2IZ.js" as="script"><link rel="prefetch" href="/assets/02. Collection、泛型.html-E4Tgx9PC.js" as="script"><link rel="prefetch" href="/assets/03. List、Set.html-feyaNaov.js" as="script"><link rel="prefetch" href="/assets/04. Map.html-SWT_rrHx.js" as="script"><link rel="prefetch" href="/assets/05. 异常、线程.html-Cl13356t.js" as="script"><link rel="prefetch" href="/assets/06. 线程、同步.html-ygVUsPb1.js" as="script"><link rel="prefetch" href="/assets/07. 等待与唤醒案例、线程池、Lambda表达式.html-9AvmjUWW.js" as="script"><link rel="prefetch" href="/assets/08. File类、递归.html-T86VPX4J.js" as="script"><link rel="prefetch" href="/assets/09. 字节流、字符流.html-2rirHPnF.js" as="script"><link rel="prefetch" href="/assets/10. 缓冲流、转换流、序列化流、打印流.html-RyJEA2m9.js" as="script"><link rel="prefetch" href="/assets/11. 网络编程.html-cY4L19J7.js" as="script"><link rel="prefetch" href="/assets/12. 函数式接口.html-xyFXIgPI.js" as="script"><link rel="prefetch" href="/assets/13. 方法引用.html-0TOp5z_G.js" as="script"><link rel="prefetch" href="/assets/14. Stream流.html-zExXMgTS.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-S4sR6ceN.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-Kh1eiS8S.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-cnv0S7AD.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-RdX4lj_8.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-Vkoji7Ak.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-Hss7GySa.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-c4I-JYNu.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-uiWCOh_t.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-D3XpIr4T.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-37R9pYDr.js" as="script"><link rel="prefetch" href="/assets/index.html-liiu_EKl.js" as="script"><link rel="prefetch" href="/assets/index.html-dtYKHZhr.js" as="script"><link rel="prefetch" href="/assets/index.html-qiUusNr1.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-byrPjTkh.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-z3DJu42D.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-vfxkftz5.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-jIXgwym4.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-Nvn51T9A.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-VuxKIDTs.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-e7hJIwrX.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-KEOYKBuc.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-pQVHPuM2.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-gkZIiZ0O.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-OCMs98hu.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-aAZlZpvZ.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-fP5MFOz9.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-1exchFun.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-AnWmDxW-.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-ikYOGNzj.js" as="script"><link rel="prefetch" href="/assets/index.html-akVhaXQ4.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html--ZhPaP0k.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-79Q1AEOV.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-DSnWzAbP.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-TZ5yQpLY.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-sDSz1JQC.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-cfRQ68dX.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-L1LsoCVN.js" as="script"><link rel="prefetch" href="/assets/1.html_css.html-HtDgd32e.js" as="script"><link rel="prefetch" href="/assets/2.mobile.html-9lWICHBQ.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html-p80UjgQW.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-h6Mn4aXq.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-D58WqsOU.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-lPPevu4o.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-yibrblWe.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html--6DfVamv.js" as="script"><link rel="prefetch" href="/assets/index.html-sn-Co23C.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-MFo6bo05.js" as="script"><link rel="prefetch" href="/assets/01. Vue3入门.html-xjD5pLRU.js" as="script"><link rel="prefetch" href="/assets/02. Pinia入门.html-0XggN9Xu.js" as="script"><link rel="prefetch" href="/assets/03. 项目起步.html-2Gqxpyi5.js" as="script"><link rel="prefetch" href="/assets/04. Layout页.html-Gh73FbwU.js" as="script"><link rel="prefetch" href="/assets/05. Home页.html-XdDzW-ZD.js" as="script"><link rel="prefetch" href="/assets/06. 一级分类页.html-hu70RbbX.js" as="script"><link rel="prefetch" href="/assets/07. 二级分类页.html-dR5an8JB.js" as="script"><link rel="prefetch" href="/assets/08. 商品详情.html-2vm_Fbhd.js" as="script"><link rel="prefetch" href="/assets/09. 登录页.html-s8D8bZZJ.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-ccTItI9M.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-wE5xo-Dg.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-rrpz7OPI.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-iiMYxdVZ.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-j2pQhv12.js" as="script"><link rel="prefetch" href="/assets/00. uni-app前置知识.html-94R5zX1Z.js" as="script"><link rel="prefetch" href="/assets/01. 项目起步.html-r7sUKndc.js" as="script"><link rel="prefetch" href="/assets/02. 首页模块.html-_OzGqhFW.js" as="script"><link rel="prefetch" href="/assets/03. 推荐模块.html-utAtQCID.js" as="script"><link rel="prefetch" href="/assets/04. 分类模块.html-bKecFVa2.js" as="script"><link rel="prefetch" href="/assets/05. 详情模块.html-DVk1JbkT.js" as="script"><link rel="prefetch" href="/assets/06. 登录模块.html-rcIaMrj3.js" as="script"><link rel="prefetch" href="/assets/07. 用户模块.html-7eS_5DsD.js" as="script"><link rel="prefetch" href="/assets/08. 地址模块.html-fs9hAzYf.js" as="script"><link rel="prefetch" href="/assets/09. SKU模块.html-YK1MXHBh.js" as="script"><link rel="prefetch" href="/assets/10. 购物车模块.html-bkhVI477.js" as="script"><link rel="prefetch" href="/assets/11. 订单模块.html-zTJDIbZ2.js" as="script"><link rel="prefetch" href="/assets/12. 项目打包.html-Gy_cUBmf.js" as="script"><link rel="prefetch" href="/assets/index.html-9JBwGe9X.js" as="script"><link rel="prefetch" href="/assets/index.html-EjcBU5lt.js" as="script"><link rel="prefetch" href="/assets/index.html-I4z_CyW1.js" as="script"><link rel="prefetch" href="/assets/index.html-eShgq06u.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-tF5tEkv8.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-OeWRCV5k.js" as="script"><link rel="prefetch" href="/assets/index.html-nBxbKQIK.js" as="script"><link rel="prefetch" href="/assets/index.html-kj9FXuX6.js" as="script"><link rel="prefetch" href="/assets/learn.html-BD7CfiUB.js" as="script"><link rel="prefetch" href="/assets/404.html-btkZhlkE.js" as="script"><link rel="prefetch" href="/assets/index.html-T17ErqbF.js" as="script"><link rel="prefetch" href="/assets/index.html-Jib5dSeG.js" as="script"><link rel="prefetch" href="/assets/index.html-JqXNyWB5.js" as="script"><link rel="prefetch" href="/assets/index.html-hY-RGNU1.js" as="script"><link rel="prefetch" href="/assets/index.html-oqCBIS_v.js" as="script"><link rel="prefetch" href="/assets/index.html-AJMwoc2R.js" as="script"><link rel="prefetch" href="/assets/index.html-7nfKGyCc.js" as="script"><link rel="prefetch" href="/assets/index.html-IfBIxRfC.js" as="script"><link rel="prefetch" href="/assets/index.html-muoKEAuh.js" as="script"><link rel="prefetch" href="/assets/index.html-t45lBcxI.js" as="script"><link rel="prefetch" href="/assets/index.html-lAWe1giX.js" as="script"><link rel="prefetch" href="/assets/index.html-kSDPDur8.js" as="script"><link rel="prefetch" href="/assets/index.html-gbNr7hUM.js" as="script"><link rel="prefetch" href="/assets/index.html-6QthmMSB.js" as="script"><link rel="prefetch" href="/assets/index.html-42CY4ac1.js" as="script"><link rel="prefetch" href="/assets/index.html-ueDLoTJ_.js" as="script"><link rel="prefetch" href="/assets/index.html-_LMh2RFh.js" as="script"><link rel="prefetch" href="/assets/index.html-tzRxRAhM.js" as="script"><link rel="prefetch" href="/assets/index.html-A2W4RlcH.js" as="script"><link rel="prefetch" href="/assets/index.html-G9n0k6L7.js" as="script"><link rel="prefetch" href="/assets/index.html-CrBH0s0U.js" as="script"><link rel="prefetch" href="/assets/index.html-LY4lUlKW.js" as="script"><link rel="prefetch" href="/assets/index.html-mLa21Q4L.js" as="script"><link rel="prefetch" href="/assets/index.html-YOwGpRFB.js" as="script"><link rel="prefetch" href="/assets/index.html-hK44yUtw.js" as="script"><link rel="prefetch" href="/assets/index.html-unBKqZcs.js" as="script"><link rel="prefetch" href="/assets/index.html-XjlmNyCs.js" as="script"><link rel="prefetch" href="/assets/index.html-JK2p7ZfK.js" as="script"><link rel="prefetch" href="/assets/index.html-lzCrPyBd.js" as="script"><link rel="prefetch" href="/assets/index.html-RTbSWDU_.js" as="script"><link rel="prefetch" href="/assets/index.html-dHsCb8RY.js" as="script"><link rel="prefetch" href="/assets/index.html-KlaSRFzG.js" as="script"><link rel="prefetch" href="/assets/index.html-DGX3PCk-.js" as="script"><link rel="prefetch" href="/assets/index.html-Znc0hCnd.js" as="script"><link rel="prefetch" href="/assets/index.html-S6kMG4Fx.js" as="script"><link rel="prefetch" href="/assets/index.html-YqwzmRnM.js" as="script"><link rel="prefetch" href="/assets/index.html-egQ26E2T.js" as="script"><link rel="prefetch" href="/assets/index.html-o564GG_l.js" as="script"><link rel="prefetch" href="/assets/index.html-1somrFyk.js" as="script"><link rel="prefetch" href="/assets/index.html-lK4owPTJ.js" as="script"><link rel="prefetch" href="/assets/index.html-qqrI0K08.js" as="script"><link rel="prefetch" href="/assets/index.html-qAyUJ9W7.js" as="script"><link rel="prefetch" href="/assets/index.html-tehrrtUn.js" as="script"><link rel="prefetch" href="/assets/index.html-mMGauwho.js" as="script"><link rel="prefetch" href="/assets/index.html-m13qsTw5.js" as="script"><link rel="prefetch" href="/assets/index.html-QvL1dW2n.js" as="script"><link rel="prefetch" href="/assets/index.html-dKZ88i_K.js" as="script"><link rel="prefetch" href="/assets/index.html-onTroC3r.js" as="script"><link rel="prefetch" href="/assets/index.html-uBLya5A3.js" as="script"><link rel="prefetch" href="/assets/index.html-nKQ4V-jV.js" as="script"><link rel="prefetch" href="/assets/index.html-SU8Gk36j.js" as="script"><link rel="prefetch" href="/assets/index.html-WKUxslBi.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-buQoHI0B.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-6Ilk8XHi.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-iTPAGK_o.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-KLb4Ybdh.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-ZQ7qIH0k.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-7J_F_gYZ.js" as="script"><link rel="prefetch" href="/assets/7.git.html-kEhnXbW-.js" as="script"><link rel="prefetch" href="/assets/advanced1.html-Ixj-8GzS.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-sDAqnHTI.js" as="script"><link rel="prefetch" href="/assets/advanced3.html-LdSUjuYb.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-BsBmBKou.js" as="script"><link rel="prefetch" href="/assets/advanced6.html-PCd3X3fH.js" as="script"><link rel="prefetch" href="/assets/base1.html-sGNXcn2D.js" as="script"><link rel="prefetch" href="/assets/base2.html-fv3HwwI_.js" as="script"><link rel="prefetch" href="/assets/cluster.html-_FulAxVT.js" as="script"><link rel="prefetch" href="/assets/index.html--D2J1CRP.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-CkCVevc1.js" as="script"><link rel="prefetch" href="/assets/index.html-UXEz84gG.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-TGSDvDdI.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-r5CLPBGb.js" as="script"><link rel="prefetch" href="/assets/index.html-rl39vBjE.js" as="script"><link rel="prefetch" href="/assets/index.html-tHsHrAKM.js" as="script"><link rel="prefetch" href="/assets/01. Object类、常用API.html-EBAtoUJ5.js" as="script"><link rel="prefetch" href="/assets/02. Collection、泛型.html-DCwxgqBs.js" as="script"><link rel="prefetch" href="/assets/03. List、Set.html-v4MK4lOZ.js" as="script"><link rel="prefetch" href="/assets/04. Map.html-KYbwus-Z.js" as="script"><link rel="prefetch" href="/assets/05. 异常、线程.html-U050zIO3.js" as="script"><link rel="prefetch" href="/assets/06. 线程、同步.html-p9zrI5bh.js" as="script"><link rel="prefetch" href="/assets/07. 等待与唤醒案例、线程池、Lambda表达式.html-gTeV-Lhx.js" as="script"><link rel="prefetch" href="/assets/08. File类、递归.html-yFpIcRim.js" as="script"><link rel="prefetch" href="/assets/09. 字节流、字符流.html-OQkd88DU.js" as="script"><link rel="prefetch" href="/assets/10. 缓冲流、转换流、序列化流、打印流.html-FtidRHoi.js" as="script"><link rel="prefetch" href="/assets/11. 网络编程.html-Ix9DdzNg.js" as="script"><link rel="prefetch" href="/assets/12. 函数式接口.html-kzooFLX9.js" as="script"><link rel="prefetch" href="/assets/13. 方法引用.html-7YUofWZT.js" as="script"><link rel="prefetch" href="/assets/14. Stream流.html-ND-SMwsI.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-A6gkeJmF.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-Kybpnpdd.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-xMwgzn9Q.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-bsJrKtMD.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-3a3_u5Mc.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-DvfSHea-.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-6A4etJ0X.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-701jDK1u.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-K42J9bQi.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-sdeJiJvl.js" as="script"><link rel="prefetch" href="/assets/index.html-LC96kgCH.js" as="script"><link rel="prefetch" href="/assets/index.html-ndhLiHAc.js" as="script"><link rel="prefetch" href="/assets/index.html-V0eAxlkJ.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-II75oNeQ.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-ax2dyf5F.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-HHFuf4wg.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-ayCp6P9O.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-RaDUgj1X.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-HDj4_f-7.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-5uME0wEd.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-kUbu2Pa4.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-fEt-mgmv.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-9LPoVHPY.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-1WFojrKt.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-2NNBfxcD.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-qnygOmfJ.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-l4-T9DpO.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-FGy7e_o4.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-dNvFGgv6.js" as="script"><link rel="prefetch" href="/assets/index.html-IJimpRqc.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-dAIJRBb1.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-qgB923XV.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-XYnmIL7a.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-R4ENsWZI.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-h-rTLZZn.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-Tl5lYyQg.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-T0HtiItK.js" as="script"><link rel="prefetch" href="/assets/1.html_css.html-eZiTEApl.js" as="script"><link rel="prefetch" href="/assets/2.mobile.html-TVuonzcA.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html-sy0GiRGB.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-XoDgXxhP.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-kJ9enf_c.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-zENOJL3Q.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-rr3z2cep.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html-vCCrt9AF.js" as="script"><link rel="prefetch" href="/assets/index.html-5_Thv5jo.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-9hi56Bz5.js" as="script"><link rel="prefetch" href="/assets/01. Vue3入门.html-ZSWBRmCK.js" as="script"><link rel="prefetch" href="/assets/02. Pinia入门.html-D68HZEmv.js" as="script"><link rel="prefetch" href="/assets/03. 项目起步.html-pCtKVhMP.js" as="script"><link rel="prefetch" href="/assets/04. Layout页.html-rN6VTmKJ.js" as="script"><link rel="prefetch" href="/assets/05. Home页.html-XjRP44OT.js" as="script"><link rel="prefetch" href="/assets/06. 一级分类页.html-1V4OiRQv.js" as="script"><link rel="prefetch" href="/assets/07. 二级分类页.html-uhwbZcXa.js" as="script"><link rel="prefetch" href="/assets/08. 商品详情.html-DqSJw2AE.js" as="script"><link rel="prefetch" href="/assets/09. 登录页.html-vIuGtpg2.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-zLLa2-Yr.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-35fWPoGa.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-Or1LzGXr.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-gWOBqtTc.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-NE-ecKnV.js" as="script"><link rel="prefetch" href="/assets/00. uni-app前置知识.html-hdGjlwid.js" as="script"><link rel="prefetch" href="/assets/01. 项目起步.html-Br6Sl2T2.js" as="script"><link rel="prefetch" href="/assets/02. 首页模块.html-iGp8uTLO.js" as="script"><link rel="prefetch" href="/assets/03. 推荐模块.html-i0--SLdR.js" as="script"><link rel="prefetch" href="/assets/04. 分类模块.html-JFsVEDho.js" as="script"><link rel="prefetch" href="/assets/05. 详情模块.html--SiK_YOp.js" as="script"><link rel="prefetch" href="/assets/06. 登录模块.html-7E_IMh44.js" as="script"><link rel="prefetch" href="/assets/07. 用户模块.html-JtB0vXPD.js" as="script"><link rel="prefetch" href="/assets/08. 地址模块.html-ga_8N9r2.js" as="script"><link rel="prefetch" href="/assets/09. SKU模块.html-l5U3P-Mm.js" as="script"><link rel="prefetch" href="/assets/10. 购物车模块.html-wt2rG8rC.js" as="script"><link rel="prefetch" href="/assets/11. 订单模块.html-x6IZvxss.js" as="script"><link rel="prefetch" href="/assets/12. 项目打包.html-FOHJ5L7B.js" as="script"><link rel="prefetch" href="/assets/index.html-GsXEkmSN.js" as="script"><link rel="prefetch" href="/assets/index.html-6EDU2DSN.js" as="script"><link rel="prefetch" href="/assets/index.html-Fd9Crk4J.js" as="script"><link rel="prefetch" href="/assets/index.html-B6IHWF3t.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-Xjb_WK0O.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-ANX7stO_.js" as="script"><link rel="prefetch" href="/assets/index.html-nPshRRZl.js" as="script"><link rel="prefetch" href="/assets/index.html-VC6Tk-SJ.js" as="script"><link rel="prefetch" href="/assets/learn.html-lJtrH5-7.js" as="script"><link rel="prefetch" href="/assets/404.html-iIjV_D2M.js" as="script"><link rel="prefetch" href="/assets/index.html-F6-qCVXi.js" as="script"><link rel="prefetch" href="/assets/index.html-gXfNc5-T.js" as="script"><link rel="prefetch" href="/assets/index.html-iwAG9KBw.js" as="script"><link rel="prefetch" href="/assets/index.html-JvN9FDOb.js" as="script"><link rel="prefetch" href="/assets/index.html-I6LkakkV.js" as="script"><link rel="prefetch" href="/assets/index.html-4u7bkqXC.js" as="script"><link rel="prefetch" href="/assets/index.html-qNvK_zMg.js" as="script"><link rel="prefetch" href="/assets/index.html-kMHiZu0F.js" as="script"><link rel="prefetch" href="/assets/index.html-1N51cUjs.js" as="script"><link rel="prefetch" href="/assets/index.html-qQX45KD0.js" as="script"><link rel="prefetch" href="/assets/index.html-kWVrkoY1.js" as="script"><link rel="prefetch" href="/assets/index.html-SeLEr0PM.js" as="script"><link rel="prefetch" href="/assets/index.html-TyrCNpgw.js" as="script"><link rel="prefetch" href="/assets/index.html-c1wlnZMl.js" as="script"><link rel="prefetch" href="/assets/index.html-OhsaDUYp.js" as="script"><link rel="prefetch" href="/assets/index.html-ayCuQ39P.js" as="script"><link rel="prefetch" href="/assets/index.html-bPzUaRCi.js" as="script"><link rel="prefetch" href="/assets/index.html-R-T0FlI8.js" as="script"><link rel="prefetch" href="/assets/index.html-Vf_jIfs0.js" as="script"><link rel="prefetch" href="/assets/index.html-IsO_Bz1_.js" as="script"><link rel="prefetch" href="/assets/index.html-TToEbZc6.js" as="script"><link rel="prefetch" href="/assets/index.html-ziS6Pi1J.js" as="script"><link rel="prefetch" href="/assets/index.html-9ddBeVpf.js" as="script"><link rel="prefetch" href="/assets/index.html-JLTBxhzk.js" as="script"><link rel="prefetch" href="/assets/index.html-4llWwsWZ.js" as="script"><link rel="prefetch" href="/assets/index.html-BU8kAiS7.js" as="script"><link rel="prefetch" href="/assets/index.html-agm7i1hp.js" as="script"><link rel="prefetch" href="/assets/index.html-gJy1tr1Y.js" as="script"><link rel="prefetch" href="/assets/index.html-Nso6eIKS.js" as="script"><link rel="prefetch" href="/assets/index.html-BhM9Ytvm.js" as="script"><link rel="prefetch" href="/assets/index.html-mBh0KZqW.js" as="script"><link rel="prefetch" href="/assets/index.html-TrAZKJy6.js" as="script"><link rel="prefetch" href="/assets/index.html-YWQzjn7q.js" as="script"><link rel="prefetch" href="/assets/index.html-tRixvE3U.js" as="script"><link rel="prefetch" href="/assets/index.html-Nn9xiZGb.js" as="script"><link rel="prefetch" href="/assets/index.html-q6PwVdXW.js" as="script"><link rel="prefetch" href="/assets/index.html-OThMD00F.js" as="script"><link rel="prefetch" href="/assets/index.html-M6xhbB0F.js" as="script"><link rel="prefetch" href="/assets/index.html-uuOSiNl2.js" as="script"><link rel="prefetch" href="/assets/index.html-ppigcH3_.js" as="script"><link rel="prefetch" href="/assets/index.html-v-gmiD1o.js" as="script"><link rel="prefetch" href="/assets/index.html-PoaQULL4.js" as="script"><link rel="prefetch" href="/assets/index.html-U_t5V9dm.js" as="script"><link rel="prefetch" href="/assets/index.html-kuX275vM.js" as="script"><link rel="prefetch" href="/assets/index.html-t7yS6JmE.js" as="script"><link rel="prefetch" href="/assets/index.html-n2CiGVKV.js" as="script"><link rel="prefetch" href="/assets/index.html-Hq4T05ZV.js" as="script"><link rel="prefetch" href="/assets/index.html-h9wn3qaY.js" as="script"><link rel="prefetch" href="/assets/index.html-_hStuDAB.js" as="script"><link rel="prefetch" href="/assets/index.html--dTWARuU.js" as="script"><link rel="prefetch" href="/assets/index.html-MzIaEyf6.js" as="script"><link rel="prefetch" href="/assets/waline-meta-w40geAFS.js" as="script"><link rel="prefetch" href="/assets/component-vLW3cVOT.js" as="script"><link rel="prefetch" href="/assets/vue-repl-VdAxW5SP.js" as="script"><link rel="prefetch" href="/assets/codemirror-editor-OfMa-2rT.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-i2ohwMnJ.js" as="script"><link rel="prefetch" href="/assets/index-7SG8bi1h.js" as="script"><link rel="prefetch" href="/assets/pageview-HfhPrDvU.js" as="script"><link rel="prefetch" href="/assets/SearchResult-25eW0Fdb.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" aria-hidden><!----><span class="vp-site-name hide-in-pad">apzs</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="博客主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>html&amp;css</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="html&amp;css基础" class="vp-link nav-link nav-link" href="/front-base/html_css/1.html_css.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>html&amp;css基础<!----></a></li><li class="dropdown-subitem"><a aria-label="移动端布局" class="vp-link nav-link nav-link" href="/front-base/html_css/2.mobile.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>移动端布局<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>js</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="js基础" class="vp-link nav-link nav-link" href="/front-base/js/1.JS%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js基础<!----></a></li><li class="dropdown-subitem"><a aria-label="WebApi" class="vp-link nav-link nav-link" href="/front-base/js/2.WebApi%EF%BC%88BOM%E5%92%8CDOM%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>WebApi<!----></a></li><li class="dropdown-subitem"><a aria-label="Ajax" class="vp-link nav-link nav-link" href="/front-base/js/3.Ajax.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Ajax<!----></a></li><li class="dropdown-subitem"><a aria-label="js高级" class="vp-link nav-link nav-link" href="/front-base/js/4.js%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js高级<!----></a></li><li class="dropdown-subitem"><a aria-label="ECMAScript6" class="vp-link nav-link nav-link" href="/front-base/js/5.ECMAScript6.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ECMAScript6<!----></a></li><li class="dropdown-subitem"><a aria-label="Promise" class="vp-link nav-link nav-link" href="/front-base/js/6.Promise.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Promise<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>前置知识</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="npm基本使用" class="vp-link nav-link nav-link" href="/front-advance/npm/1.npm%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>npm基本使用<!----></a></li><li class="dropdown-subitem"><a aria-label="scss" class="vp-link nav-link nav-link" href="/front-advance/scss/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>scss<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>vue</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="vue2" class="vp-link nav-link nav-link" href="/front-advance/vue/1.vue2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue2<!----></a></li><li class="dropdown-subitem"><a aria-label="vue3" class="vp-link nav-link nav-link" href="/front-advance/vue/2.vue3.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue3<!----></a></li><li class="dropdown-subitem"><a aria-label="创建vue项目的几种方式" class="vp-link nav-link nav-link" href="/front-advance/vue/3.%E5%88%9B%E5%BB%BAvue%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>创建vue项目的几种方式<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>react</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="react入门" class="vp-link nav-link nav-link" href="/front-advance/react/01%20%E3%80%90react%E5%85%A5%E9%97%A8%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react入门<!----></a></li><li class="dropdown-subitem"><a aria-label="react脚手架" class="vp-link nav-link nav-link" href="/front-advance/react/02%20%E3%80%90react%E8%84%9A%E6%89%8B%E6%9E%B6%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react脚手架<!----></a></li><li class="dropdown-subitem"><a aria-label="路由" class="vp-link nav-link nav-link" href="/front-advance/react/03%20%E3%80%90%E8%B7%AF%E7%94%B1%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>路由<!----></a></li><li class="dropdown-subitem"><a aria-label="redux" class="vp-link nav-link nav-link" href="/front-advance/react/05%20%E3%80%90redux%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redux<!----></a></li><li class="dropdown-subitem"><a aria-label="hooks" class="vp-link nav-link nav-link" href="/front-advance/react/06%20%E3%80%90hooks%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>hooks<!----></a></li><li class="dropdown-subitem"><a aria-label="react高级" class="vp-link nav-link nav-link" href="/front-advance/react/07%20%E3%80%90react%E9%AB%98%E7%BA%A7%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react高级<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>webpack</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="基础" class="vp-link nav-link nav-link" href="/front-advance/webpack/1.%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>基础<!----></a></li><li class="dropdown-subitem"><a aria-label="高级" class="vp-link nav-link nav-link" href="/front-advance/webpack/2.%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>高级<!----></a></li><li class="dropdown-subitem"><a aria-label="项目配置" class="vp-link nav-link nav-link" href="/front-advance/webpack/3.%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>项目配置<!----></a></li><li class="dropdown-subitem"><a aria-label="原理分析" class="vp-link nav-link nav-link" href="/front-advance/webpack/4.%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>原理分析<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端项目"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>前端项目</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="小兔鲜PC (Vue3+Pinia+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%8F%E5%85%94%E9%B2%9CPC%20(Vue3_Pinia_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜PC (Vue3+Pinia+js)<!----></a></li><li class="dropdown-item"><a aria-label="小兔鲜儿uni-app (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%8F%E5%85%94%E9%B2%9C%E5%84%BFuni-app%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜儿uni-app (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="尚品汇 (Vue2+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%9A%E5%93%81%E6%B1%87%20(Vue2_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>尚品汇 (Vue2+js)<!----></a></li><li class="dropdown-item"><a aria-label="硅谷甄选 (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E7%A1%85%E8%B0%B7%E7%94%84%E9%80%89%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>硅谷甄选 (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="个人博客搭建教程" class="vp-link nav-link nav-link" href="/front-project/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>个人博客搭建教程<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="Java基础语法" class="vp-link nav-link nav-link" href="/back-base/1.Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java基础语法<!----></a></li><li class="dropdown-item"><a aria-label="Java核心" class="vp-link nav-link nav-link" href="/back-base/2.Java%E6%A0%B8%E5%BF%83/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java核心<!----></a></li><li class="dropdown-item"><a aria-label="JavaWeb" class="vp-link nav-link nav-link" href="/back-base/3.JavaWeb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>JavaWeb<!----></a></li><li class="dropdown-item"><a aria-label="mysql" class="vp-link nav-link nav-link" href="/back-base/4.mysql/MySQL.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mysql<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SSM" class="vp-link nav-link nav-link" href="/back-advance/5.SSM/SSM%E7%AC%94%E8%AE%B0.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SSM<!----></a></li><li class="dropdown-item"><a aria-label="redis" class="vp-link nav-link nav-link" href="/back-advance/6.redis/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redis<!----></a></li><li class="dropdown-item"><a aria-label="SpringBoot" class="vp-link nav-link nav-link" href="/back-advance/7.SpringBoot2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringBoot<!----></a></li><li class="dropdown-item"><a aria-label="git" class="vp-link nav-link nav-link" href="/back-advance/9.git/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>git<!----></a></li><li class="dropdown-item"><a aria-label="nginx" class="vp-link nav-link nav-link" href="/back-advance/10.nginx.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>nginx<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端高级"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端高级</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="docker" class="vp-link nav-link nav-link" href="/back-senior/11.docker/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>docker<!----></a></li><li class="dropdown-item"><a aria-label="gitlab+jeckins" class="vp-link nav-link nav-link" href="/back-senior/12.gitlab_jeckins/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>gitlab+jeckins<!----></a></li><li class="dropdown-item"><a aria-label="SpringSecurity" class="vp-link nav-link nav-link" href="/back-senior/13.SpringSecurity/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringSecurity<!----></a></li><li class="dropdown-item"><a aria-label="Netty" class="vp-link nav-link nav-link" href="/back-senior/14.Netty.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Netty<!----></a></li><li class="dropdown-item"><a aria-label="arthas" class="vp-link nav-link nav-link" href="/back-senior/15.arthas.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>arthas<!----></a></li><li class="dropdown-item"><a aria-label="ShardingSphere5" class="vp-link nav-link nav-link" href="/back-senior/16.ShardingSphere5.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ShardingSphere5<!----></a></li><li class="dropdown-item"><a aria-label="mongodb" class="vp-link nav-link nav-link" href="/back-senior/17.mongodb/mongodb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mongodb<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="谷粒商城"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>谷粒商城</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>基础篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="前后端环境搭建" class="vp-link nav-link nav-link" href="/gulimall/base1.html"><!---->前后端环境搭建<!----></a></li><li class="dropdown-subitem"><a aria-label="前后端联调" class="vp-link nav-link nav-link" href="/gulimall/base2.html"><!---->前后端联调<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>高级篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Elasticsearch &amp; nginx" class="vp-link nav-link nav-link" href="/gulimall/advanced1.html"><!---->Elasticsearch &amp; nginx<!----></a></li><li class="dropdown-subitem"><a aria-label="Redisson &amp; SpringCache" class="vp-link nav-link nav-link" href="/gulimall/advanced2.html"><!---->Redisson &amp; SpringCache<!----></a></li><li class="dropdown-subitem"><a aria-label="CompletableFuture" class="vp-link nav-link nav-link" href="/gulimall/advanced3.html"><!---->CompletableFuture<!----></a></li><li class="dropdown-subitem"><a aria-label="Spring Session &amp; OAuth2.0" class="vp-link nav-link nav-link" href="/gulimall/advanced4.html"><!---->Spring Session &amp; OAuth2.0<!----></a></li><li class="dropdown-subitem"><a aria-label="RabbitMQ &amp; Seata" class="vp-link nav-link active nav-link active" href="/gulimall/advanced5.html"><!---->RabbitMQ &amp; Seata<!----></a></li><li class="dropdown-subitem"><a aria-label="支付 &amp; Sentinel" class="vp-link nav-link nav-link" href="/gulimall/advanced6.html"><!---->支付 &amp; Sentinel<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>集群篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="K8s &amp; kubesphere" class="vp-link nav-link nav-link" href="/gulimall/cluster.html"><!---->K8s &amp; kubesphere<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="常用功能"><span class="title"><!---->常用功能</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SpringBoot相关" class="vp-link nav-link nav-link" href="/CommonFunctions/1.SpringBoot.html"><!---->SpringBoot相关<!----></a></li><li class="dropdown-item"><a aria-label="mysql相关" class="vp-link nav-link nav-link" href="/CommonFunctions/2.mysql.html"><!---->mysql相关<!----></a></li><li class="dropdown-item"><a aria-label="docker相关" class="vp-link nav-link nav-link" href="/CommonFunctions/3.docker.html"><!---->docker相关<!----></a></li><li class="dropdown-item"><a aria-label="maven相关" class="vp-link nav-link nav-link" href="/CommonFunctions/4.maven.html"><!---->maven相关<!----></a></li><li class="dropdown-item"><a aria-label="linux相关" class="vp-link nav-link nav-link" href="/CommonFunctions/5.linux.html"><!---->linux相关<!----></a></li><li class="dropdown-item"><a aria-label="windows相关" class="vp-link nav-link nav-link" href="/CommonFunctions/6.windows.html"><!---->windows相关<!----></a></li><li class="dropdown-item"><a aria-label="git相关" class="vp-link nav-link nav-link" href="/CommonFunctions/7.git.html"><!---->git相关<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="阅读源码"><span class="title"><!---->阅读源码</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="搭建SpringBoot源码环境" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/"><!---->搭建SpringBoot源码环境<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot自动配置 &amp; 请求处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%20_%20%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86.html"><!---->SpringBoot自动配置 &amp; 请求处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot异常处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/2.%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"><!---->SpringBoot异常处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/"><!---->SpringSecurity源码阅读<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity基础知识" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/learn.html"><!---->SpringSecurity基础知识<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Tomcat</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Tomcat源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/tomcat.html"><!---->Tomcat源码阅读<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Mybatis</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="MyBatis源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/mybatis/"><!---->MyBatis源码阅读<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/apzs/apzs.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="5.8.RabbitMQ" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced5.html#_5-8-rabbitmq"><!---->5.8.RabbitMQ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="5.8.1、RabbitMQ 基本使用" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_5-8-1、rabbitmq-基本使用"><!---->5.8.1、RabbitMQ 基本使用<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.8.2、整合RabbitMQ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_5-8-2、整合rabbitmq"><!---->5.8.2、整合RabbitMQ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.8.3、基本页面准备" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_5-8-3、基本页面准备"><!---->5.8.3、基本页面准备<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="6.1、订单模块" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced5.html#_6-1、订单模块"><!---->6.1、订单模块<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="6.1.1、编写基本功能" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-1-1、编写基本功能"><!---->6.1.1、编写基本功能<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.1.2、Feign丢失请求头" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-1-2、feign丢失请求头"><!---->6.1.2、Feign丢失请求头<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.1.3、完善结算页" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-1-3、完善结算页"><!---->6.1.3、完善结算页<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.1.4、接口幂等性" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-1-4、接口幂等性"><!---->6.1.4、接口幂等性<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="6.2、分布式事务" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/gulimall/advanced5.html#_6-2、分布式事务"><!---->6.2、分布式事务<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="6.2.1、分布式事务理论" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-2-1、分布式事务理论"><!---->6.2.1、分布式事务理论<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.2.2、Seata做分布式事务" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-2-2、seata做分布式事务"><!---->6.2.2、Seata做分布式事务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.2.3、延时队列" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-2-3、延时队列"><!---->6.2.3、延时队列<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.2.4、其他服务整合RabbitMQ" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/gulimall/advanced5.html#_6-2-4、其他服务整合rabbitmq"><!---->6.2.4、其他服务整合RabbitMQ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->六、订单</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://apzs.eu.org" target="_blank" rel="noopener noreferrer">apzs</a></span><span property="author" content="apzs"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-05T06:05:15.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/gulimall/advanced5.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 174 分钟</span><meta property="timeRequired" content="PT174M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_5-8-rabbitmq">5.8.RabbitMQ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-8-1、rabbitmq-基本使用">5.8.1、RabbitMQ 基本使用</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-8-2、整合rabbitmq">5.8.2、整合RabbitMQ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-8-3、基本页面准备">5.8.3、基本页面准备</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_6-1、订单模块">6.1、订单模块</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-1-1、编写基本功能">6.1.1、编写基本功能</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-1-2、feign丢失请求头">6.1.2、Feign丢失请求头</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-1-3、完善结算页">6.1.3、完善结算页</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-1-4、接口幂等性">6.1.4、接口幂等性</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_6-2、分布式事务">6.2、分布式事务</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-2-1、分布式事务理论">6.2.1、分布式事务理论</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-2-2、seata做分布式事务">6.2.2、Seata做分布式事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-2-3、延时队列">6.2.3、延时队列</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-2-4、其他服务整合rabbitmq">6.2.4、其他服务整合RabbitMQ</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="_5-8-rabbitmq" tabindex="-1"><a class="header-anchor" href="#_5-8-rabbitmq" aria-hidden="true">#</a> 5.8.RabbitMQ</h2><h3 id="_5-8-1、rabbitmq-基本使用" tabindex="-1"><a class="header-anchor" href="#_5-8-1、rabbitmq-基本使用" aria-hidden="true">#</a> 5.8.1、RabbitMQ 基本使用</h3><h4 id="_1、基本概念" tabindex="-1"><a class="header-anchor" href="#_1、基本概念" aria-hidden="true">#</a> 1、基本概念</h4><h5 id="主流的消息队列对比" tabindex="-1"><a class="header-anchor" href="#主流的消息队列对比" aria-hidden="true">#</a> 主流的消息队列对比</h5><table><thead><tr><th>特性</th><th>ActiveMQ</th><th>RabbitMQ</th><th>RocketMQ</th><th>Kafka</th></tr></thead><tbody><tr><td>单机吞吐量</td><td>万级，比 RocketMQ、Kafka 低一个数量级</td><td>同 ActiveMQ</td><td>10 万级，支撑高吞吐</td><td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td></tr><tr><td>topic 数量对吞吐量的影响</td><td></td><td></td><td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td><td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td></tr><tr><td>时效性</td><td>ms 级</td><td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td><td>ms 级</td><td>延迟在 ms 级以内</td></tr><tr><td>可用性</td><td>高，基于主从架构实现高可用</td><td>同 ActiveMQ</td><td>非常高，分布式架构</td><td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td></tr><tr><td>消息可靠性</td><td>有较低的概率丢失数据</td><td>基本不丢</td><td>经过参数优化配置，可以做到 0 丢失</td><td>同 RocketMQ</td></tr><tr><td>功能支持</td><td>MQ 领域的功能极其完备</td><td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td><td>MQ 功能较为完善，还是分布式的，扩展性好</td><td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td></tr></tbody></table><img src="https://gitlab.com/apzs/image/-/raw/master/image/mq对比.jpg" alt="mq对比" style="zoom:25%;"><h5 id="_1、异步处理" tabindex="-1"><a class="header-anchor" href="#_1、异步处理" aria-hidden="true">#</a> 1、异步处理</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.1.1.png" alt="image-20220811083529529" tabindex="0" loading="lazy"><figcaption>image-20220811083529529</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.1.2.png" alt="image-20220811083557739" tabindex="0" loading="lazy"><figcaption>image-20220811083557739</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.1.3.png" alt="image-20220811083605506" tabindex="0" loading="lazy"><figcaption>image-20220811083605506</figcaption></figure><h5 id="_2、应用解耦" tabindex="-1"><a class="header-anchor" href="#_2、应用解耦" aria-hidden="true">#</a> 2、应用解耦</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.2.1.png" alt="image-20220811083641392" tabindex="0" loading="lazy"><figcaption>image-20220811083641392</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.2.2.png" alt="image-20220811083649379" tabindex="0" loading="lazy"><figcaption>image-20220811083649379</figcaption></figure><h5 id="_3、流量控制" tabindex="-1"><a class="header-anchor" href="#_3、流量控制" aria-hidden="true">#</a> 3、流量控制</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.3.png" alt="image-20220811083703311" tabindex="0" loading="lazy"><figcaption>image-20220811083703311</figcaption></figure><ol><li><p>大多应用中，可通过消息服务中间件来提升系统异步通信、扩展解耦能力</p></li><li><p>消息服务中两个重要概念：</p><ul><li><p>消息代理（message broker）消息发送后，消息代理进行管理，消息代理保证消息传递到指定目的地；</p></li><li><p>目的地（destination）消息发送的目的地</p><p>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地。</p></li></ul></li><li><p>消息队列主要有两种形式的目的地</p><ul><li><p>队列（queue）：点对点消息通信（point-to-point）</p></li><li><p>主题（topic）：发布（publish）/订阅（subscribe）消息通信</p></li></ul></li></ol><ul><li><p>点对点式： 消息发送者发送消息，消息代理将其放入一个队列中，消息接收者从队列中获 取消息内容，消息读取后被移出队列 消息只有唯一的发送者和接受者，但并不是说只能有一个接收者</p></li><li><p>.发布订阅式： 发送者（发布者）发送消息到主题，多个接收者（订阅者）监听（订阅）这个 主题，那么就会在消息到达时同时收到消息</p></li><li><p>JMS（Java Message Service）JAVA消息服务： 基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现</p></li><li><p>AMQP（Advanced Message Queuing Protocol） 高级消息队列协议，也是一个消息代理的规范，兼容JMS，RabbitMQ是AMQP的实现</p></li></ul><h5 id="jms和amqp的区别" tabindex="-1"><a class="header-anchor" href="#jms和amqp的区别" aria-hidden="true">#</a> <strong><code>JMS</code>和<code>AMQP</code>的区别</strong></h5><table><thead><tr><th></th><th>JMS（Java Message Service）</th><th>AMQP（Advanced Message Queuing Protocol）</th></tr></thead><tbody><tr><td>定义</td><td>Java api</td><td>网络线级协议</td></tr><tr><td>跨语言</td><td>否</td><td>是</td></tr><tr><td>跨平台</td><td>否</td><td>是</td></tr><tr><td>Model</td><td>提供两种消息模型：<br>1、Peer-2-Peer <br>2、Pub/sub</td><td>提供了五种消息模型： <br>1、direct exchange <br>2、fanout exchange <br>3、topic change <br>4、headers exchange <br>5、system exchange <br>本质来讲，后四种和JMS的pub/sub模型没有太大差别 仅是在路由机制上做了更详细的划分；</td></tr><tr><td>支持消息类 型</td><td>多种消息类型： <br>TextMessage <br>MapMessage <br>BytesMessage <br>StreamMessage <br>ObjectMessage <br>Message （只有消息头和属性）</td><td>byte[] <br>当实际应用时，有复杂的消息，可以将消息序列化后发 送。</td></tr><tr><td>综合评价</td><td>JMS 定义了JAVA API层面的标准；<br>在java体系中， 多个client均可以通过JMS进行交互，不需要应用修 改代码，但是其对跨平台的支持较差；</td><td>AMQP定义了wire-level层的协议标准；天然具有跨平 台、跨语言特性。</td></tr></tbody></table><ul><li><p>Spring支持 spring-jms提供了对JMS的支持 spring-rabbit提供了对AMQP的支持 需要ConnectionFactory的实现来连接消息代理 提供JmsTemplate、RabbitTemplate来发送消息 @JmsListener（JMS）、@RabbitListener（AMQP）注解在方法上监听消息 代理发布的消息 @EnableJms、@EnableRabbit开启支持</p></li><li><p>Spring Boot自动配置 JmsAutoConfiguration</p><p>RabbitAutoConfiguration 10、市面的MQ产品 ActiveMQ、RabbitMQ、RocketMQ、Kafka</p></li></ul><p><strong>RabbitMQ概念</strong></p><ul><li>RabbitMQ简介： RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。</li></ul><p><strong>核心概念</strong></p><ul><li><p>Message 消息，消息是不具名的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成， 这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可 能需要持久性存储）等。</p></li><li><p>Publisher 消息的生产者，也是一个向交换器发布消息的客户端应用程序。</p></li><li><p>Exchange 交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。 Exchange有4种类型：direct(默认)，fanout, topic, 和headers，不同类型的Exchange转发消息的策略有所区别</p></li><li><p>Queue 消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直 在队列里面，等待消费者连接到这个队列将其取走。</p></li><li><p>Binding 绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交 换器理解成一个由绑定构成的路由表。 Exchange 和Queue的绑定可以是多对多的关系。</p></li><li><p>Connection 网络连接，比如一个TCP连接。</p></li><li><p>Channel 信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内的虚拟连接，AMQP 命令都是通过信道 发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁 TCP 都 是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP 连接。</p></li><li><p>Consumer 消息的消费者，表示一个从消息队列中取得消息的客户端应用程序。</p></li><li><p>Virtual Host 虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加 密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥 有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时 指定，RabbitMQ 默认的 vhost 是 / 。</p></li><li><p>Broker 表示消息队列服务器实体</p></li></ul><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.1.4.png" alt="image-20220811092602383" tabindex="0" loading="lazy"><figcaption>image-20220811092602383</figcaption></figure><h4 id="_2、简单测试" tabindex="-1"><a class="header-anchor" href="#_2、简单测试" aria-hidden="true">#</a> 2、简单测试</h4><h5 id="_1、下载-rabbitmq" tabindex="-1"><a class="header-anchor" href="#_1、下载-rabbitmq" aria-hidden="true">#</a> 1、下载 rabbitmq</h5><p>在 https://hub.docker.com/ 页面里搜索<code>rabbitmq</code>，选择官方镜像，下载带web管理后台的</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> pull rabbitmq:management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.1.1.png" alt="image-20220811092945598" tabindex="0" loading="lazy"><figcaption>image-20220811092945598</figcaption></figure><p>在linux虚拟机里输入如下命令，下载rabbitmq镜像并运行容器</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> rabbitmq 
<span class="token parameter variable">-p</span> <span class="token number">5671</span>:5671 <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">4369</span>:4369 <span class="token parameter variable">-p</span>  <span class="token number">25672</span>:25672 <span class="token parameter variable">-p</span> <span class="token number">15671</span>:15671 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672  
rabbitmq:management
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各端口的含义：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>4369, 25672 (Erlang发现&amp;集群端口)
5672, 5671 (AMQP端口)
15672 (web管理后台端口)
61613, 61614 (STOMP协议端口)
1883, 8883 (MQTT协议端口)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完整命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看镜像</span>
<span class="token function">docker</span> images
<span class="token comment"># 下载rabbitmq镜像并运行容器</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> rabbitmq <span class="token parameter variable">-p</span> <span class="token number">5671</span>:5671 <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">4369</span>:4369 <span class="token parameter variable">-p</span>  <span class="token number">25672</span>:25672 <span class="token parameter variable">-p</span> <span class="token number">15671</span>:15671 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672  rabbitmq:management
<span class="token comment"># 设置rabbitmq开机自启动</span>
<span class="token function">docker</span> update rabbitmq <span class="token parameter variable">--restart</span><span class="token operator">=</span>always
<span class="token comment"># 查看正在运行的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到<code>rabbitmq</code>已经启动了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.1.2.png" alt="image-20220811094014468" tabindex="0" loading="lazy"><figcaption>image-20220811094014468</figcaption></figure><p>浏览器访问<code>http://192.168.56.10:15672</code>，用户名和密码默认都为<code>guest</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.1.3.png" alt="image-20220811094146077" tabindex="0" loading="lazy"><figcaption>image-20220811094146077</figcaption></figure><h5 id="_2、rabbitmq管理后台信息" tabindex="-1"><a class="header-anchor" href="#_2、rabbitmq管理后台信息" aria-hidden="true">#</a> 2、rabbitmq管理后台信息</h5><p>登录后，在 http://192.168.56.10:15672/#/ 页面里可以看到<code>RabbitMQ</code>、<code>Erlang</code>的版本信息，<code>5s</code>钟刷新一次</p><p><code>Connections</code> (连接数)、<code>Channels</code> (信道)、<code>Exchanges</code>（交换机）、<code>Queues</code> (消息队列) 、<code>Consumers</code>（消费者数量）等信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.2.1.png" alt="image-20220811094402733" tabindex="0" loading="lazy"><figcaption>image-20220811094402733</figcaption></figure><p>在 http://192.168.56.10:15672/#/ 页面里往下滑， <code>Ports and contexts</code>里可以看到端口的占用信息，<code>Export definitions</code>可以导出配置、<code>Import definitions</code>可以导入配置</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.2.2.png" alt="image-20220811095438968" tabindex="0" loading="lazy"><figcaption>image-20220811095438968</figcaption></figure><p>点击 <code>Exchanges</code>（交换机），默认就会有7个交换机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.2.3.png" alt="image-20220811095639732" tabindex="0" loading="lazy"><figcaption>image-20220811095639732</figcaption></figure><h5 id="_3、添加虚拟机" tabindex="-1"><a class="header-anchor" href="#_3、添加虚拟机" aria-hidden="true">#</a> 3、添加虚拟机</h5><p>在<code>Admin</code> -&gt;<code>Virtual Hosts</code>-&gt;<code>Add a new virtual host</code>里输入<code>Name:</code>，然后点击<code>Add virtual host</code>可以添加一个虚拟主机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.3.1.png" alt="image-20220811095815095" tabindex="0" loading="lazy"><figcaption>image-20220811095815095</figcaption></figure><p>添加好虚拟主机后，会自动分配<code>7</code>个默认的交换机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.3.2.png" alt="image-20220811100236026" tabindex="0" loading="lazy"><figcaption>image-20220811100236026</figcaption></figure><p>点击刚刚新建的虚拟主机，可以在<code>Permissions</code>里给用户设置各种权限</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.3.3.png" alt="image-20220811100040244" tabindex="0" loading="lazy"><figcaption>image-20220811100040244</figcaption></figure><p>在<code>Delete this vhost</code>里可以点击<code>Delete this virtual host</code>删除一个虚拟主机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.2.3.4.png" alt="image-20220811100407980" tabindex="0" loading="lazy"><figcaption>image-20220811100407980</figcaption></figure><h4 id="_3、添加交换机" tabindex="-1"><a class="header-anchor" href="#_3、添加交换机" aria-hidden="true">#</a> 3、添加交换机</h4><h5 id="_1、交换机类型" tabindex="-1"><a class="header-anchor" href="#_1、交换机类型" aria-hidden="true">#</a> 1、交换机类型</h5><p>Exchange分发消息时根据类型的不同分发策略有区别，目前共四种类型：direct(点对点)、 fanout(扇出)、topic(发布/订阅)、headers 。headers 匹配 AMQP 消息的 header 而不是路由键， headers 交换器和 direct 交换器完全一致，但性能差很多，目前几乎用不到了，所以直接 看另外三种类型：</p><ul><li>direct(直连(点对点)，类似于<code>单播</code>)</li></ul><p>消息中的路由键（routing key）如果和Binding 中的 binding key 一致， 交换器就将消息发到对应的队列中。路由键与队列名完全匹配，如果一个队列绑定到交换机要求路由键为“dog”，则只转发 routingkey 标记为“dog”的消息，不会转发“dog.puppy”，、“dog.guard” 等等。它是完全匹配、单播的模式。（将消息发送给指定路由键的队列）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.1.1.png" alt="image-20220811101043102" tabindex="0" loading="lazy"><figcaption>image-20220811101043102</figcaption></figure><ul><li>fanout(扇形(扇出)、类似于<code>广播</code>)</li></ul><p>每个发到 fanout 类型交换器的消息都会分到所有绑定的队列上去。fanout 交换器不处理路由键，只是简单的将队列绑定到交换器上，每个发送到交换器的 消息都会被转发到与该交换器绑定的所 有队列上。很像子网广播，每台子网内 的主机都获得了一份复制的消息。fanout 类型转发消息是最快的。(不分路由键，将所有消息交给所有绑定的队列)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.1.2.png" alt="image-20220811101340077" tabindex="0" loading="lazy"><figcaption>image-20220811101340077</figcaption></figure><ul><li>topic(主题(发布/订阅)，类似于<code>组播</code>)</li></ul><p>topic 交换器通过模式匹配分配消息的 路由键属性，将路由键和某个模式进行匹配，此时队列需要绑定到一个模式上。 它将路由键和绑定键的字符串切分成单 词，这些单词之间用点隔开。它同样也 会识别两个通配符：符号<code>#</code>和符号<code>*</code>。<code>#</code>匹配0个或多个单词，<code>*</code>匹配一 个单词。（将消息发送给匹配路由键的绑定的队列）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.1.3.png" alt="image-20220811101511061" tabindex="0" loading="lazy"><figcaption>image-20220811101511061</figcaption></figure><h5 id="_2、添加交换机" tabindex="-1"><a class="header-anchor" href="#_2、添加交换机" aria-hidden="true">#</a> 2、添加交换机</h5><p>添加交换机(<code>交换机</code>可以绑定<code>交换机</code>和<code>队列</code>)</p><ul><li><p><code>Type</code>: 交换机类型</p></li><li><p><code>Durability</code>: 是否持久化</p></li><li><p><code>Auto delete</code>: If yes, the exchange will delete itself after at least one queue or exchange has been bound to this one, and then all queues or exchanges have been unbound.</p><p>如果选择yes，则在至少有一个队列或交换机绑定到该交换机。所有队列或交换机都已解除绑定，该交换机将自行删除</p></li><li><p><code>Internal</code>: If yes, clients cannot publish to this exchange directly. It can only be used with exchange to exchange bindings.</p><p>如果选择yes，客户端不能直接发布到这个交换机，它仅能被用于交换机与交换机之间绑定</p></li></ul><p>点击<code>Exchanges</code>-&gt;<code>Add a new exchange</code>，输入<code>Name</code>为<code>my.exchange.direct</code>，其他默认即可，然后点击<code>Add exchange</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.2.1.png" alt="image-20220811104127869" tabindex="0" loading="lazy"><figcaption>image-20220811104127869</figcaption></figure><p>点击刚刚新建的<code>my.exchange.direct</code>交换机，可以在<code>Bindings</code>里查看绑定的<code>Queues</code>，可以在<code>Publish message</code>里发消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.2.2.png" alt="image-20220811104823286" tabindex="0" loading="lazy"><figcaption>image-20220811104823286</figcaption></figure><h5 id="_3、新建一个队列" tabindex="-1"><a class="header-anchor" href="#_3、新建一个队列" aria-hidden="true">#</a> 3、新建一个队列</h5><p>点击<code>Queues</code>-&gt;<code>Add a new queue</code>，输入<code>name</code>，其他默认即可，然后点击<code>Add queue</code></p><ul><li><p>Auto delete:If yes, the queue will delete itself after at least one consumer has connected, and then all consumers have disconnected.</p><p>如果选择yes，则至少需要有一个消费者连接到该队列，当所有消费者都断开连接后该队列将自动删除</p></li></ul><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.3.1.png" alt="image-20220811105621937" tabindex="0" loading="lazy"><figcaption>image-20220811105621937</figcaption></figure><p>在<code>Exchanges</code>里点击刚刚创建的<code>my.exchange.direct</code>，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，选择<code>To queue</code>，然后输入刚刚新建的<code>Queues</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.3.3.2.png" alt="image-20220811110227654" tabindex="0" loading="lazy"><figcaption>image-20220811110227654</figcaption></figure><h4 id="_4、搭建rabbitmq测试结构" tabindex="-1"><a class="header-anchor" href="#_4、搭建rabbitmq测试结构" aria-hidden="true">#</a> 4、搭建RabbitMQ测试结构</h4><h5 id="_1、结构" tabindex="-1"><a class="header-anchor" href="#_1、结构" aria-hidden="true">#</a> 1、结构</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.4.1.png" alt="image-20220811203457236" tabindex="0" loading="lazy"><figcaption>image-20220811203457236</figcaption></figure><h5 id="_2、添加队列" tabindex="-1"><a class="header-anchor" href="#_2、添加队列" aria-hidden="true">#</a> 2、添加队列</h5><p>点击<code>Queues</code>-&gt;<code>Add a new queue</code>，输入<code>name</code>为<code>atguigu.news</code>，其他默认即可，然后点击<code>Add queue</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.4.2.1.png" alt="image-20220811110703384" tabindex="0" loading="lazy"><figcaption>image-20220811110703384</figcaption></figure><p>点击<code>Queues</code>-&gt;<code>Add a new queue</code>，输入<code>name</code>为<code>atguigu.emps</code>，其他默认即可，然后点击<code>Add queue</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.4.2.2.png" alt="image-20220811110827830" tabindex="0" loading="lazy"><figcaption>image-20220811110827830</figcaption></figure><p>点击<code>Queues</code>-&gt;<code>Add a new queue</code>，输入<code>name</code>为<code>gulixueyuan.news</code>，其他默认即可，然后点击<code>Add queue</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.4.2.3.png" alt="image-20220811110903011" tabindex="0" loading="lazy"><figcaption>image-20220811110903011</figcaption></figure><p>查看创建的队列是否正确</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.4.2.4.png" alt="image-20220811151155302" tabindex="0" loading="lazy"><figcaption>image-20220811151155302</figcaption></figure><p>在<code>Exchanges</code>里点击刚刚创建的<code>my.exchange.direct</code>交换机，点击<code>Delete this exchange</code>里的<code>Delete</code>，删除该交换机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.4.2.5.png" alt="image-20220811111119727" tabindex="0" loading="lazy"><figcaption>image-20220811111119727</figcaption></figure><h4 id="_5、直连交换机-类似单播" tabindex="-1"><a class="header-anchor" href="#_5、直连交换机-类似单播" aria-hidden="true">#</a> 5、直连交换机(类似单播)</h4><h5 id="_1、搭建直连交换机" tabindex="-1"><a class="header-anchor" href="#_1、搭建直连交换机" aria-hidden="true">#</a> 1、搭建直连交换机</h5><p>点击<code>Exchanges</code>-&gt;<code>Add a new exchange</code>，输入<code>Name</code>为<code>exchange.direct</code>，类型选择<code>direct</code>，其他默认即可，然后点击<code>Add exchange</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.1.1.png" alt="image-20220811111208952" tabindex="0" loading="lazy"><figcaption>image-20220811111208952</figcaption></figure><p>然后在<code>Exchanges</code>里点击刚刚创建的<code>exchange.direct</code>交换机，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，绑定<code>atguigu</code>队列、<code>atguigu.emps</code>队列、<code>atguigu.news</code>队列、<code>gulixueyuan.news</code>队列，绑定直连交换机的<code>To queue</code>队列名和<code>Routing Key</code>路由键要一致。</p><p>绑定<code>atguigu</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.1.2.png" alt="image-20220811111512129" tabindex="0" loading="lazy"><figcaption>image-20220811111512129</figcaption></figure><p>绑定<code>atguigu.emps</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.1.3.png" alt="image-20220811111442988" tabindex="0" loading="lazy"><figcaption>image-20220811111442988</figcaption></figure><p>绑定<code>atguigu.news</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.1.4.png" alt="image-20220811111656443" tabindex="0" loading="lazy"><figcaption>image-20220811111656443</figcaption></figure><p>绑定<code>gulixueyuan.news</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.1.5.png" alt="image-20220811111746102" tabindex="0" loading="lazy"><figcaption>image-20220811111746102</figcaption></figure><p>最终<code>exchange.direct</code>交换机绑定的队列和路由键如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.1.6.png" alt="image-20220811151109687" tabindex="0" loading="lazy"><figcaption>image-20220811151109687</figcaption></figure><h5 id="_2、测试" tabindex="-1"><a class="header-anchor" href="#_2、测试" aria-hidden="true">#</a> 2、测试</h5><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.direct</code>交换机，在<code>Publish message</code>里<code>Routing key</code>输入路由键，<code>Payload</code>里输入要发送的消息内容。比如在<code>Routing key</code>里输入<code>atguigu.news</code>，<code>Payload</code>里输入<code>atguigu.news atguigu.news atguigu.news</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.1.png" alt="image-20220811112220904" tabindex="0" loading="lazy"><figcaption>image-20220811112220904</figcaption></figure><p>点击<code>Queues</code>，可以看到<code>atguigu.news</code>收到了一条消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.2.png" alt="image-20220811112319354" tabindex="0" loading="lazy"><figcaption>image-20220811112319354</figcaption></figure><p>点击<code>Queues</code>里的<code>atguigu.news</code>，在<code>Get messages</code>里直接<code>Get messages</code>按钮，可以看到在<code>Payload</code>里已经显示消息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.3.png" alt="image-20220811112523846" tabindex="0" loading="lazy"><figcaption>image-20220811112523846</figcaption></figure><p>此时<code>atguigu.news</code>队列里的消息还在，这是因为默认选择了<code>Nack message requeue true </code>（ 获取消息，但是不做ack应答确认，消息重新入队) 模式</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.4.png" alt="image-20220811112856279" tabindex="0" loading="lazy"><figcaption>image-20220811112856279</figcaption></figure><p><code>Get messages</code>里<code>Ack Mode</code>有四种选择</p><ul><li><p><strong>Nack message requeue true</strong> 获取消息，但是不做ack应答确认，消息重新入队</p></li><li><p><strong>Automatic ack</strong> 获取消息，应答确认，消息不重新入队，将会从队列中删除</p></li><li><p><strong>Reject requeue true</strong> 拒绝获取消息，消息重新入队</p></li><li><p><strong>Reject requeue false</strong> 拒绝获取消息，消息不重新入队，将会被删除</p></li></ul><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.5.png" alt="image-20220811113254337" tabindex="0" loading="lazy"><figcaption>image-20220811113254337</figcaption></figure><p>点击<code>Queues</code>里的<code>atguigu.news</code>，在<code>Get messages</code>里<code>Ack Mode</code>选择<code>Automatic ack</code>，再点击<code>Get messages</code>按钮</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.6.png" alt="image-20220811113400248" tabindex="0" loading="lazy"><figcaption>image-20220811113400248</figcaption></figure><p>此时<code>atguigu.news</code>队列里就没有消息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.5.2.7.png" alt="image-20220811113454310" tabindex="0" loading="lazy"><figcaption>image-20220811113454310</figcaption></figure><h4 id="_6、扇形交换机-类似多播" tabindex="-1"><a class="header-anchor" href="#_6、扇形交换机-类似多播" aria-hidden="true">#</a> 6、扇形交换机(类似多播)</h4><h5 id="_1、搭建扇形交换机" tabindex="-1"><a class="header-anchor" href="#_1、搭建扇形交换机" aria-hidden="true">#</a> 1、搭建扇形交换机</h5><p>点击<code>Exchanges</code>-&gt;<code>Add a new exchange</code>，输入<code>Name</code>为<code>exchange.fanout</code>， 类型选择<code>fanout</code>，其他默认即可，然后点击<code>Add exchange</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.1.1.png" alt="image-20220811145105430" tabindex="0" loading="lazy"><figcaption>image-20220811145105430</figcaption></figure><p>然后在<code>Exchanges</code>里点击刚刚创建的<code>exchange.direct</code>交换机，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，绑定<code>atguigu</code>队列、<code>atguigu.emps</code>队列、<code>atguigu.news</code>队列、<code>gulixueyuan.news</code>队列，绑定扇形交换机队列名可以不指定路由键（因为指不指定都会将消息发送给绑定的全部队列）。</p><p>绑定<code>atguigu</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.1.2.png" alt="image-20220811145259997" tabindex="0" loading="lazy"><figcaption>image-20220811145259997</figcaption></figure><p>绑定<code>atguigu.emps</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.1.3.png" alt="image-20220811145459709" tabindex="0" loading="lazy"><figcaption>image-20220811145459709</figcaption></figure><p>绑定<code>atguigu.news</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.1.4.png" alt="image-20220811145552228" tabindex="0" loading="lazy"><figcaption>image-20220811145552228</figcaption></figure><p>绑定<code>gulixueyuan.news</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.1.5.png" alt="image-20220811145619431" tabindex="0" loading="lazy"><figcaption>image-20220811145619431</figcaption></figure><p>最终<code>exchange.fanout</code>交换机绑定的队列和路由键如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.1.6.png" alt="image-20220811151041332" tabindex="0" loading="lazy"><figcaption>image-20220811151041332</figcaption></figure><h5 id="_2、测试-1" tabindex="-1"><a class="header-anchor" href="#_2、测试-1" aria-hidden="true">#</a> 2、测试</h5><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.fanout</code>交换机，在<code>Publish message</code>里<code>Routing key</code>输入路由键，<code>Payload</code>里输入要发送的消息内容。比如在<code>Routing key</code>里输入<code>atguigu.emps</code>，<code>Payload</code>里输入<code>atguigu.emps atguigu.emps atguigu.emps</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.2.1.png" alt="image-20220811145712914" tabindex="0" loading="lazy"><figcaption>image-20220811145712914</figcaption></figure><p>可以看到即使指定了路由键，所有绑定的队列都有一条消息（因此写不写路由键都一样）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.2.2.png" alt="image-20220811145749412" tabindex="0" loading="lazy"><figcaption>image-20220811145749412</figcaption></figure><p>点击<code>Queues</code>里的<code>atguigu</code>，在<code>Get messages</code>里<code>Ack Mode</code>选择<code>Automatic ack</code>，再点击<code>Get messages</code>按钮即可获得消息并确认收到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.2.3.png" alt="image-20220811150016242" tabindex="0" loading="lazy"><figcaption>image-20220811150016242</figcaption></figure><p>此时<code>atguigu</code>队列里就没有消息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.2.4.png" alt="image-20220811150038840" tabindex="0" loading="lazy"><figcaption>image-20220811150038840</figcaption></figure><p>使用相同的方法，清空完所有消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.6.2.5.png" alt="image-20220811150145756" tabindex="0" loading="lazy"><figcaption>image-20220811150145756</figcaption></figure><h4 id="_7、主题交换机-类似组播" tabindex="-1"><a class="header-anchor" href="#_7、主题交换机-类似组播" aria-hidden="true">#</a> 7、主题交换机(类似组播)</h4><p><code>#</code>匹配0个或多个单词，<code>*</code>匹配一 个单词</p><h5 id="_1、搭建主题交换机" tabindex="-1"><a class="header-anchor" href="#_1、搭建主题交换机" aria-hidden="true">#</a> 1、搭建主题交换机</h5><p>点击<code>Exchanges</code>-&gt;<code>Add a new exchange</code>，输入<code>Name</code>为<code>exchange.topic</code>， 类型选择<code>topic</code>，其他默认即可，然后点击<code>Add exchange</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.1.1.png" alt="image-20220811150252271" tabindex="0" loading="lazy"><figcaption>image-20220811150252271</figcaption></figure><p>主题交换机绑定的<code>To queue</code>队列名和<code>Routing Key</code>路由键可以一致也可以不一致可以灵活的配置（类似于正则表达式），可以完成直连、扇形交换机的功能和它们不具有的功能。</p><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.topic</code>交换机，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，选择<code>To queue</code>并输入<code>atguigu</code>，<code>Routing key</code>输入<code>atguigu.#</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.1.2.png" alt="image-20220811150503956" tabindex="0" loading="lazy"><figcaption>image-20220811150503956</figcaption></figure><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.topic</code>交换机，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，选择<code>To queue</code>并输入<code>atguigu.emps</code>，<code>Routing key</code>输入<code>atguigu.#</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.1.3.png" alt="image-20220811150611339" tabindex="0" loading="lazy"><figcaption>image-20220811150611339</figcaption></figure><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.topic</code>交换机，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，选择<code>To queue</code>并输入<code>atguigu.news</code>，<code>Routing key</code>输入<code>atguigu.#</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.1.4.png" alt="image-20220811150718818" tabindex="0" loading="lazy"><figcaption>image-20220811150718818</figcaption></figure><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.topic</code>交换机，在<code>Bindings</code>里的<code>Add binding from this exchange</code>里，选择<code>To queue</code>并输入<code>gulixueyuan.news</code>，<code>Routing key</code>输入<code>*.news</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.1.5.png" alt="image-20220811150801598" tabindex="0" loading="lazy"><figcaption>image-20220811150801598</figcaption></figure><p>最终<code>exchange.topic</code>交换机绑定的队列和路由键如下图所示</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.1.6.png" alt="image-20220811151009581" tabindex="0" loading="lazy"><figcaption>image-20220811151009581</figcaption></figure><h5 id="_2、测试-2" tabindex="-1"><a class="header-anchor" href="#_2、测试-2" aria-hidden="true">#</a> 2、测试</h5><h6 id="_1、测试一" tabindex="-1"><a class="header-anchor" href="#_1、测试一" aria-hidden="true">#</a> 1、测试一</h6><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.topic</code>交换机，在<code>Publish message</code>里<code>Routing key</code>输入路由键，<code>Payload</code>里输入要发送的消息内容。比如在<code>Routing key</code>里输入<code>atguigu.news</code>，<code>Payload</code>里输入<code>atguigu.news atguigu.news atguigu.news</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.2.1.1.png" alt="image-20220811151321045" tabindex="0" loading="lazy"><figcaption>image-20220811151321045</figcaption></figure><p>由于4个队列都匹配到了输入的路由键，因此4个队列全收到了消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.2.1.2.png" alt="image-20220811151421184" tabindex="0" loading="lazy"><figcaption>image-20220811151421184</figcaption></figure><p>把4个队列的消息全部清空，再做测试</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.2.1.3.png" alt="image-20220811151549807" tabindex="0" loading="lazy"><figcaption>image-20220811151549807</figcaption></figure><h6 id="_2、测试二" tabindex="-1"><a class="header-anchor" href="#_2、测试二" aria-hidden="true">#</a> 2、测试二</h6><p>在<code>Exchanges</code>里点击刚刚创建的<code>exchange.topic</code>交换机，在<code>Publish message</code>里<code>Routing key</code>输入<code>hello.news</code>，<code>Payload</code>里输入<code>hello.news hello.news hello.news</code>。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.2.2.1.png" alt="image-20220811151645699" tabindex="0" loading="lazy"><figcaption>image-20220811151645699</figcaption></figure><p>只有<code>gulixueyuan.news</code>队列匹配到了输入的路由键，因此也只有该队列收到了消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.2.2.2.png" alt="image-20220811151712215" tabindex="0" loading="lazy"><figcaption>image-20220811151712215</figcaption></figure><p>点击<code>Queues</code>里的<code>gulixueyuan.news</code>，在<code>Get messages</code>里<code>Ack Mode</code>选择<code>Automatic ack</code>，再点击<code>Get messages</code>按钮即可获得消息并确认收到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.1.7.2.2.3.png" alt="image-20220811151737220" tabindex="0" loading="lazy"><figcaption>image-20220811151737220</figcaption></figure><h3 id="_5-8-2、整合rabbitmq" tabindex="-1"><a class="header-anchor" href="#_5-8-2、整合rabbitmq" aria-hidden="true">#</a> 5.8.2、整合<code>RabbitMQ</code></h3><h4 id="_1、整合rabbitmq" tabindex="-1"><a class="header-anchor" href="#_1、整合rabbitmq" aria-hidden="true">#</a> 1、整合<code>RabbitMQ</code></h4><h5 id="_1、引入rabbitmq" tabindex="-1"><a class="header-anchor" href="#_1、引入rabbitmq" aria-hidden="true">#</a> 1、引入<code>RabbitMQ</code></h5><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件里添加RabbitMQ依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入amqp场景，使用RabbitMQ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.1.1.png" alt="image-20220811153557936" tabindex="0" loading="lazy"><figcaption>image-20220811153557936</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplication</code>类上添加<code>@EnableRabbit</code>注解。(引入<code>spring-boot-starter-amqp</code>后<code>RabbitAutoConfiguration</code>自动生效)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRabbit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.1.2.png" alt="image-20220811155002969" tabindex="0" loading="lazy"><figcaption>image-20220811155002969</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>文件里添加<code>RabbitMQ</code>相关的配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
<span class="token key attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token value attr-value">5672</span>
<span class="token key attr-name">spring.rabbitmq.username</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
<span class="token key attr-name">spring.rabbitmq.password</span><span class="token punctuation">=</span><span class="token value attr-value">guest</span>
<span class="token comment">#虚拟主机</span>
<span class="token key attr-name">spring.rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token value attr-value">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.1.3.png" alt="image-20220811155102448" tabindex="0" loading="lazy"><figcaption>image-20220811155102448</figcaption></figure><h5 id="_2、自动配置" tabindex="-1"><a class="header-anchor" href="#_2、自动配置" aria-hidden="true">#</a> 2、自动配置</h5><p>在<code>org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration</code>类里配置了<code>连接工厂</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CachingConnectionFactory</span> <span class="token function">rabbitConnectionFactory</span><span class="token punctuation">(</span><span class="token class-name">RabbitProperties</span> properties<span class="token punctuation">,</span>
      <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConnectionNameStrategy</span><span class="token punctuation">&gt;</span></span> connectionNameStrategy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">PropertyMapper</span> map <span class="token operator">=</span> <span class="token class-name">PropertyMapper</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">CachingConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">(</span>
         <span class="token function">getRabbitConnectionFactoryBean</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">determineAddresses</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setAddresses</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">isPublisherConfirms</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setPublisherConfirms</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">isPublisherReturns</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setPublisherReturns</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">RabbitProperties<span class="token punctuation">.</span>Cache<span class="token punctuation">.</span>Channel</span> channel <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>channel<span class="token operator">::</span><span class="token function">getSize</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setChannelCacheSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>channel<span class="token operator">::</span><span class="token function">getCheckoutTimeout</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token operator">::</span><span class="token function">toMillis</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setChannelCheckoutTimeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">RabbitProperties<span class="token punctuation">.</span>Cache<span class="token punctuation">.</span>Connection</span> connection <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>connection<span class="token operator">::</span><span class="token function">getMode</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setCacheMode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>connection<span class="token operator">::</span><span class="token function">getSize</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setConnectionCacheSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>connectionNameStrategy<span class="token operator">::</span><span class="token function">getIfUnique</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>factory<span class="token operator">::</span><span class="token function">setConnectionNameStrategy</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.2.1.png" alt="image-20220811153833138" tabindex="0" loading="lazy"><figcaption>image-20220811153833138</figcaption></figure><p><code>RabbitTemplate</code> 常用于发送消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">PropertyMapper</span> map <span class="token operator">=</span> <span class="token class-name">PropertyMapper</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">RabbitTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">MessageConverter</span> messageConverter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageConverter<span class="token punctuation">.</span><span class="token function">getIfUnique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>messageConverter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template<span class="token punctuation">.</span><span class="token function">setMessageConverter</span><span class="token punctuation">(</span>messageConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   template<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token function">determineMandatoryFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">RabbitProperties<span class="token punctuation">.</span>Template</span> properties <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template<span class="token punctuation">.</span><span class="token function">setRetryTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryTemplateFactory</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>retryTemplateCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRetryTemplate</span><span class="token punctuation">(</span>
                  properties<span class="token punctuation">.</span><span class="token function">getRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RabbitRetryTemplateCustomizer<span class="token punctuation">.</span>Target</span><span class="token punctuation">.</span><span class="token constant">SENDER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getReceiveTimeout</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token operator">::</span><span class="token function">toMillis</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setReceiveTimeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getReplyTimeout</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token operator">::</span><span class="token function">toMillis</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setReplyTimeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getExchange</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setExchange</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getRoutingKey</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setRoutingKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getDefaultReceiveQueue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setDefaultReceiveQueue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.2.2.png" alt="image-20220811153920189" tabindex="0" loading="lazy"><figcaption>image-20220811153920189</figcaption></figure><p><code>AmqpAdmin</code> 常用于管理交换机、队列</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.rabbitmq&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;dynamic&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">AmqpAdmin</span> <span class="token function">amqpAdmin</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RabbitAdmin</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.2.3.png" alt="image-20220811154015402" tabindex="0" loading="lazy"><figcaption>image-20220811154015402</figcaption></figure><p><code>RabbitMessagingTemplate</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RabbitMessagingTemplate</span> <span class="token function">rabbitMessagingTemplate</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RabbitMessagingTemplate</span><span class="token punctuation">(</span>rabbitTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.2.4.png" alt="image-20220811154037439" tabindex="0" loading="lazy"><figcaption>image-20220811154037439</figcaption></figure><p>点击<code>org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration</code>类里的<code>AmqpAdmin</code>就来到了<code>org.springframework.amqp.core.AmqpAdmin</code>，再点击<code>Exchange</code>就来到了<code>org.springframework.amqp.core.Exchange</code>，使用<code>ctrl + H</code>快捷键可以看到该类与其他类的继承关系</p><p><code>org.springframework.amqp.core.AbstractExchange</code>抽象类实现了<code>org.springframework.amqp.core.Exchange</code>接口，该抽象类有如下几个实现类：</p><p>org.springframework.amqp.core.DirectExchange</p><p>org.springframework.amqp.core.FanoutExchange</p><p>org.springframework.amqp.core.CustomExchange 自定义</p><p>org.springframework.amqp.core.TopicExchange</p><p>org.springframework.amqp.core.HeadersExchange</p><p>这里面包含了前面测试RabbitMQ的几种交换机，而且还可以自定义交换机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.1.2.5.png" alt="image-20220811155414815" tabindex="0" loading="lazy"><figcaption>image-20220811155414815</figcaption></figure><h4 id="_2、测试-3" tabindex="-1"><a class="header-anchor" href="#_2、测试-3" aria-hidden="true">#</a> 2、测试</h4><h5 id="_1、创建交换机" tabindex="-1"><a class="header-anchor" href="#_1、创建交换机" aria-hidden="true">#</a> 1、创建交换机</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里修改为如下代码</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Slf4j
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">AmqpAdmin</span> amqpAdmin<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//声明交换机（durable：持久化）</span>
   <span class="token comment">//DirectExchange(String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span>
   <span class="token class-name">DirectExchange</span> directExchange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   amqpAdmin<span class="token punctuation">.</span><span class="token function">declareExchange</span><span class="token punctuation">(</span>directExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Exchange[{}]创建成功&quot;</span><span class="token punctuation">,</span>directExchange<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>控制台输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Exchange[hello-java-exchange]创建成功
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.1.1.png" alt="image-20220811160144915" tabindex="0" loading="lazy"><figcaption>image-20220811160144915</figcaption></figure><p>浏览器打开 http://192.168.56.10:15672/#/exchanges 页面，可以看到<code>hello-java-exchange</code>交换机创建成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.1.2.png" alt="image-20220811160218336" tabindex="0" loading="lazy"><figcaption>image-20220811160218336</figcaption></figure><h5 id="_2、创建队列" tabindex="-1"><a class="header-anchor" href="#_2、创建队列" aria-hidden="true">#</a> 2、创建队列</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里添加<code>createQueue</code>方法</p><p>注意： <code>Queue</code>要选<code>org.springframework.amqp.core</code>包下的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 创建队列
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//exclusive：排他(只能被声明的连接使用，只要一个连接连上该队列，其他连接就连不上该队列)</span>
   <span class="token comment">//Queue(String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span>
   <span class="token class-name">Queue</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   amqpAdmin<span class="token punctuation">.</span><span class="token function">declareQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Exchange[{}]创建成功&quot;</span><span class="token punctuation">,</span>queue<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>控制台输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Exchange[hello-java-queue]创建成功
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.2.1.png" alt="image-20220811161345321" tabindex="0" loading="lazy"><figcaption>image-20220811161345321</figcaption></figure><p>浏览器打开 http://192.168.56.10:15672/#/queues 页面，可以看到<code>hello-java-queue</code>队列创建成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.2.2.png" alt="image-20220811161412585" tabindex="0" loading="lazy"><figcaption>image-20220811161412585</figcaption></figure><p><code>org.springframework.amqp.core.Queue</code>类的构造函数详细说明如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Construct a new queue, given a name, durability, exclusive and auto-delete flags.
 * <span class="token keyword">@param</span> <span class="token parameter">name</span> the name of the queue.
 * <span class="token keyword">@param</span> <span class="token parameter">durable</span> true if we are declaring a durable queue (the queue will survive a server restart)
 * <span class="token keyword">@param</span> <span class="token parameter">exclusive</span> true if we are declaring an exclusive queue (the queue will only be used by the declarer&#39;s connection) 排他队列：只能被声明的连接使用
 * <span class="token keyword">@param</span> <span class="token parameter">autoDelete</span> true if the server should delete the queue when it is no longer in use
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> durable<span class="token punctuation">,</span> <span class="token keyword">boolean</span> exclusive<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoDelete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> durable<span class="token punctuation">,</span> exclusive<span class="token punctuation">,</span> autoDelete<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.2.3.png" alt="image-20220811160813636" tabindex="0" loading="lazy"><figcaption>image-20220811160813636</figcaption></figure><h5 id="_3、创建绑定关系" tabindex="-1"><a class="header-anchor" href="#_3、创建绑定关系" aria-hidden="true">#</a> 3、创建绑定关系</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里添加<code>createBinding</code>方法</p><p>注意： <code>Binding</code>要选<code>org.springframework.amqp.core</code>包下的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 创建绑定
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">/*
    * String destination :目的地
    * DestinationType destinationType :目的地类型（交换机/队列）
    * String exchange    :交换机
    * String routingKey  :路由键
    * Map&lt;String, Object&gt; arguments 参数
    */</span>
   <span class="token comment">//将exchange指定的交换机和destination目的地进行绑定，使用routingKey作为指定的路由键</span>
   <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
         <span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   amqpAdmin<span class="token punctuation">.</span><span class="token function">declareBinding</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Binding[{}]创建成功&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello-java-Binding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>控制台输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Binding[hello-java-Binding]创建成功
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.3.1.png" alt="image-20220811162613591" tabindex="0" loading="lazy"><figcaption>image-20220811162613591</figcaption></figure><p>在 http://192.168.56.10:15672/#/exchanges 页面里点击刚刚创建的<code>hello-java-exchange</code>交换机，可以看到该交换机已经绑定<code>hello-java-queue</code>队列了，且绑定的路由键为<code>hello.java</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.3.2.png" alt="image-20220811162636478" tabindex="0" loading="lazy"><figcaption>image-20220811162636478</figcaption></figure><h5 id="_4、发送字符串消息" tabindex="-1"><a class="header-anchor" href="#_4、发送字符串消息" aria-hidden="true">#</a> 4、发送字符串消息</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里添加<code>sendMessage</code>方法，用于<code>hello-java-exchange</code>交换机使用<code>hello.java</code>路由键发送字符串消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//rabbitTemplate.send();</span>
   <span class="token comment">//convertAndSend(String exchange, String routingKey, final Object object)</span>
   <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
   rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>控制台输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>消息发送完成hello world
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.4.1.png" alt="image-20220811163232674" tabindex="0" loading="lazy"><figcaption>image-20220811163232674</figcaption></figure><p>浏览器访问 http://192.168.56.10:15672/#/queues 页面，可以看到<code>hello-java-queue</code>已经有一条消息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.4.2.png" alt="image-20220811163253188" tabindex="0" loading="lazy"><figcaption>image-20220811163253188</figcaption></figure><p>点击<code>Queues</code>里的<code>hello-java-queue</code>，在<code>Get messages</code>里<code>Ack Mode</code>选择<code>Reject requeue false</code>，再点击<code>Get messages</code>按钮，此时已经正确获取到消息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.4.3.png" alt="image-20220811163515707" tabindex="0" loading="lazy"><figcaption>image-20220811163515707</figcaption></figure><h5 id="_5、发送java对象消息" tabindex="-1"><a class="header-anchor" href="#_5、发送java对象消息" aria-hidden="true">#</a> 5、发送Java对象消息</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里添加<code>sendMessage2</code>方法，用于<code>hello-java-exchange</code>交换机使用<code>hello.java</code>路由键发送Java对象消息</p><div class="language-JAVA line-numbers-mode" data-ext="JAVA"><pre class="language-JAVA"><code>@Test
public void sendMessage2(){
   OrderReturnReasonEntity entity = new OrderReturnReasonEntity();
   entity.setId(1L);
   entity.setCreateTime(new Date());
   entity.setName(&quot;啊啊啊&quot;);
   //rabbitTemplate.send();
   //convertAndSend(String exchange, String routingKey, final Object object)
   rabbitTemplate.convertAndSend(&quot;hello-java-exchange&quot;,&quot;hello.java&quot;,entity);
   log.info(&quot;消息发送完成{}&quot;,entity);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>控制台输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>消息发送完成OrderReturnReasonEntity(id=1, name=啊啊啊, sort=null, status=null, createTime=Thu Aug 11 16:40:19 CST 2022)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.5.1.png" alt="image-20220811164051363" tabindex="0" loading="lazy"><figcaption>image-20220811164051363</figcaption></figure><p>点击<code>Queues</code>里的<code>hello-java-queue</code>，在<code>Get messages</code>里<code>Ack Mode</code>选择<code>Reject requeue false</code>，再点击<code>Get messages</code>按钮，此时<code>Properties</code>里面的<code>content_type</code>的值为<code>application/x-java-serialized-object</code>，内容也是乱的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.2.5.2.png" alt="image-20220811164159081" tabindex="0" loading="lazy"><figcaption>image-20220811164159081</figcaption></figure><h4 id="_3、使用json进行序列化" tabindex="-1"><a class="header-anchor" href="#_3、使用json进行序列化" aria-hidden="true">#</a> 3、使用JSON进行序列化</h4><h5 id="_1、实现serializable接口" tabindex="-1"><a class="header-anchor" href="#_1、实现serializable接口" aria-hidden="true">#</a> 1、实现<code>Serializable</code>接口</h5><p>让<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.entity.OrderReturnReasonEntity</code>类实现<code>Serializable</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.1.png" alt="image-20220811164300656" tabindex="0" loading="lazy"><figcaption>image-20220811164300656</figcaption></figure><h5 id="_2、源码分析" tabindex="-1"><a class="header-anchor" href="#_2、源码分析" aria-hidden="true">#</a> 2、源码分析</h5><p><code>org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration</code>类的<code>RabbitTemplateConfiguration</code>静态内部类的<code>RabbitTemplateConfiguration</code>方法有一个<code>ObjectProvider&lt;MessageConverter&gt; messageConverter</code>参数，该方法会从容器种获取所有MessageConverter(消息转换器)，然后设给本类的<code>messageConverter</code>字段（如果这个消息转换器唯一，则使用该消息转换器）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RabbitTemplateConfiguration</span><span class="token punctuation">(</span><span class="token class-name">RabbitProperties</span> properties<span class="token punctuation">,</span>
      <span class="token comment">//ObjectProvider&lt;MessageConverter&gt;：从容器种获取所有MessageConverter(消息转换器)</span>
      <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageConverter</span><span class="token punctuation">&gt;</span></span> messageConverter<span class="token punctuation">,</span>
      <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RabbitRetryTemplateCustomizer</span><span class="token punctuation">&gt;</span></span> retryTemplateCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>messageConverter <span class="token operator">=</span> messageConverter<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>retryTemplateCustomizers <span class="token operator">=</span> retryTemplateCustomizers<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">PropertyMapper</span> map <span class="token operator">=</span> <span class="token class-name">PropertyMapper</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">RabbitTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//获取消息转换器</span>
   <span class="token class-name">MessageConverter</span> messageConverter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageConverter<span class="token punctuation">.</span><span class="token function">getIfUnique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>messageConverter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template<span class="token punctuation">.</span><span class="token function">setMessageConverter</span><span class="token punctuation">(</span>messageConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   template<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token function">determineMandatoryFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">RabbitProperties<span class="token punctuation">.</span>Template</span> properties <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template<span class="token punctuation">.</span><span class="token function">setRetryTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RetryTemplateFactory</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>retryTemplateCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRetryTemplate</span><span class="token punctuation">(</span>
                  properties<span class="token punctuation">.</span><span class="token function">getRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RabbitRetryTemplateCustomizer<span class="token punctuation">.</span>Target</span><span class="token punctuation">.</span><span class="token constant">SENDER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getReceiveTimeout</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token operator">::</span><span class="token function">toMillis</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setReceiveTimeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getReplyTimeout</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token operator">::</span><span class="token function">toMillis</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setReplyTimeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getExchange</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setExchange</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getRoutingKey</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setRoutingKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>properties<span class="token operator">::</span><span class="token function">getDefaultReceiveQueue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenNonNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>template<span class="token operator">::</span><span class="token function">setDefaultReceiveQueue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.2.1.png" alt="image-20220811165246108" tabindex="0" loading="lazy"><figcaption>image-20220811165246108</figcaption></figure><p>在<code>org.springframework.amqp.rabbit.core.RabbitTemplate</code>里如果容器中没有<code>messageConverter</code>(消息转换器)或不唯一，则会使用默认的<code>private MessageConverter messageConverter = new SimpleMessageConverter();</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.2.2.png" alt="image-20220811165318057" tabindex="0" loading="lazy"><figcaption>image-20220811165318057</figcaption></figure><p>在<code>org.springframework.amqp.support.converter.SimpleMessageConverter#createMessage</code>方法里，如果是<code>String</code>就转换为<code>byte[]</code>，如果实现类<code>Serializable</code>就用<code>SerializationUtils</code>进行序列化，因此如果不加以设置，默认将使用<code> SerializationUtils.serialize(object);</code>进行序列化</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Creates an AMQP Message from the provided Object.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Message</span> <span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span> messageProperties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessageConversionException</span> <span class="token punctuation">{</span>
   <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bytes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span>
      messageProperties<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MessageProperties</span><span class="token punctuation">.</span><span class="token constant">CONTENT_TYPE_BYTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         bytes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultCharset<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MessageConversionException</span><span class="token punctuation">(</span>
               <span class="token string">&quot;failed to convert to Message content&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      messageProperties<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MessageProperties</span><span class="token punctuation">.</span><span class="token constant">CONTENT_TYPE_TEXT_PLAIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      messageProperties<span class="token punctuation">.</span><span class="token function">setContentEncoding</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultCharset<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token keyword">instanceof</span> <span class="token class-name">Serializable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         bytes <span class="token operator">=</span> <span class="token class-name">SerializationUtils</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MessageConversionException</span><span class="token punctuation">(</span>
               <span class="token string">&quot;failed to convert to serialized Message content&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      messageProperties<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MessageProperties</span><span class="token punctuation">.</span><span class="token constant">CONTENT_TYPE_SERIALIZED_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      messageProperties<span class="token punctuation">.</span><span class="token function">setContentLength</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> messageProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">+</span> <span class="token string">&quot; only supports String, byte[] and Serializable payloads, received: &quot;</span> <span class="token operator">+</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.2.3.png" alt="image-20220811165718487" tabindex="0" loading="lazy"><figcaption>image-20220811165718487</figcaption></figure><p>如何使用JSON进行序列化呢？</p><p>搜先我们点进<code>org.springframework.amqp.support.converter.MessageConverter</code>接口，按住<code>ctrl + H</code>查看该类和其他类的依赖关系，即可看到<code>org.springframework.amqp.support.converter.Jackson2JsonMessageConverter</code>类。(<code>Jackson</code>是<code>Spring</code>默认的<code>JSON</code>序列化器)</p><p>因此我们只需向容器中注入<code>Jackson2JsonMessageConverter</code>类即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.2.4.png" alt="image-20220811170224381" tabindex="0" loading="lazy"><figcaption>image-20220811170224381</figcaption></figure><h5 id="_3、注入json消息转换器" tabindex="-1"><a class="header-anchor" href="#_3、注入json消息转换器" aria-hidden="true">#</a> 3、注入JSON消息转换器</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包下新建<code>config</code>文件夹，在<code>config</code>文件夹下新建<code>MyRabbitConfig</code>配置类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span><span class="token class-name">Jackson2JsonMessageConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span><span class="token class-name">MessageConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>


<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/11
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRabbitConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.3.png" alt="image-20220811170708228" tabindex="0" loading="lazy"><figcaption>image-20220811170708228</figcaption></figure><h5 id="_4、再次发送java对象消息" tabindex="-1"><a class="header-anchor" href="#_4、再次发送java对象消息" aria-hidden="true">#</a> 4、再次发送Java对象消息</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里再次执行<code>sendMessage2</code>方法，用于<code>hello-java-exchange</code>交换机使用<code>hello.java</code>路由键发送Java对象消息</p><p>控制台输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>消息发送完成OrderReturnReasonEntity(id=1, name=啊啊啊, sort=null, status=null, createTime=Thu Aug 11 17:10:30 CST 2022)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.4.1.png" alt="image-20220811171149957" tabindex="0" loading="lazy"><figcaption>image-20220811171149957</figcaption></figure><p>点击<code>Queues</code>里的<code>hello-java-queue</code>，在<code>Get messages</code>里<code>Ack Mode</code>选择<code>Reject requeue false</code>，再点击<code>Get messages</code>按钮，这时消息就是JSON格式的对象了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>headers:    
__TypeId__: com.atguigu.gulimall.order.entity.OrderReturnReasonEntity
content_type:   application/json
{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660209030108}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.3.4.2.png" alt="image-20220811171202932" tabindex="0" loading="lazy"><figcaption>image-20220811171202932</figcaption></figure><h4 id="_4、接收消息" tabindex="-1"><a class="header-anchor" href="#_4、接收消息" aria-hidden="true">#</a> 4、接收消息</h4><h5 id="_1、参数指定为object类型" tabindex="-1"><a class="header-anchor" href="#_1、参数指定为object类型" aria-hidden="true">#</a> 1、参数指定为<code>Object</code>类型</h5><p>在需要监听队列的业务方法上标注<code>@RabbitListener</code>注解（该方法所在的类需要在容器中）</p><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类里添加如下方法（这里只是测试用，平时开发不要放在配置类里），然后重启<code>gulimall-order</code>模块</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在需要监听队列的业务方法上标注@RabbitListener注解（该方法所在的类需要在容器中）
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息...内容：&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;==&gt;类型：&quot;</span><span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.1.1.png" alt="image-20220811190304872" tabindex="0" loading="lazy"><figcaption>image-20220811190304872</figcaption></figure><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里再次执行<code>sendMessage2</code>方法，用于<code>hello-java-exchange</code>交换机使用<code>hello.java</code>路由键发送Java对象消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-11 <span class="token number">17</span>:27:15.913  INFO <span class="token number">14580</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c.a.g.o.GulimallOrderApplicationTests    <span class="token builtin class-name">:</span> 消息发送完成OrderReturnReasonEntity<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span>啊啊啊, <span class="token assign-left variable">sort</span><span class="token operator">=</span>null, <span class="token assign-left variable">status</span><span class="token operator">=</span>null, <span class="token assign-left variable">createTime</span><span class="token operator">=</span>Thu Aug <span class="token number">11</span> <span class="token number">17</span>:27:15 CST <span class="token number">2022</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.1.2.png" alt="image-20220811172823781" tabindex="0" loading="lazy"><figcaption>image-20220811172823781</figcaption></figure><p>打开<code>gulimall-order</code>模块的控制台，可以看到接收到的消息的类型为<code>org.springframework.amqp.core.Message</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>接收到消息<span class="token punctuation">..</span>.内容：<span class="token punctuation">(</span>Body:<span class="token string">&#39;{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660210035834}&#39;</span> MessageProperties <span class="token punctuation">[</span>headers<span class="token operator">=</span><span class="token punctuation">{</span>__TypeId__<span class="token operator">=</span>com.atguigu.gulimall.order.entity.OrderReturnReasonEntity<span class="token punctuation">}</span>, <span class="token assign-left variable">contentType</span><span class="token operator">=</span>application/json, <span class="token assign-left variable">contentEncoding</span><span class="token operator">=</span>UTF-8, <span class="token assign-left variable">contentLength</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">receivedDeliveryMode</span><span class="token operator">=</span>PERSISTENT, <span class="token assign-left variable">priority</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">redelivered</span><span class="token operator">=</span>false, <span class="token assign-left variable">receivedExchange</span><span class="token operator">=</span>hello-java-exchange, <span class="token assign-left variable">receivedRoutingKey</span><span class="token operator">=</span>hello.java, <span class="token assign-left variable">deliveryTag</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">consumerTag</span><span class="token operator">=</span>amq.ctag-5sX1WFjvna_vui2BTkXVdg, <span class="token assign-left variable">consumerQueue</span><span class="token operator">=</span>hello-java-queue<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">&gt;</span>类型：class org.springframework.amqp.core.Message
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.1.3.png" alt="image-20220811190102733" tabindex="0" loading="lazy"><figcaption>image-20220811190102733</figcaption></figure><h5 id="_2、参数指定为message类型" tabindex="-1"><a class="header-anchor" href="#_2、参数指定为message类型" aria-hidden="true">#</a> 2、参数指定为<code>Message</code>类型</h5><p>由于接收到的消息的类型为<code>org.springframework.amqp.core.Message</code>，因此业务方法可以参数直接传<code>Message</code>类型，这样可以方便获取信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在需要监听队列的业务方法上标注@RabbitListener注解（该方法所在的类需要在容器中）
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660210035834}</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息的属性信息</span>
    <span class="token comment">//[headers={__TypeId__=com.atguigu.gulimall.order.entity.OrderReturnReasonEntity}, contentType=application/json, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=hello-java-exchange, receivedRoutingKey=hello.java, deliveryTag=1, consumerTag=amq.ctag-5sX1WFjvna_vui2BTkXVdg, consumerQueue=hello-java-queue]</span>
    <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> contentType <span class="token operator">=</span> messageProperties<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息...内容：&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;==&gt;类型：&quot;</span><span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.2.png" alt="image-20220811190730199" tabindex="0" loading="lazy"><figcaption>image-20220811190730199</figcaption></figure><h5 id="_3、添加消息内容实体参数" tabindex="-1"><a class="header-anchor" href="#_3、添加消息内容实体参数" aria-hidden="true">#</a> 3、添加消息内容实体参数</h5><p>也可以在<code>Message message</code>后面添加第二个参数用于接收发送的消息内容对象，Spring会自动封装，然后重启<code>gulimall-order</code>模块</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在需要监听队列的业务方法上标注@RabbitListener注解（该方法所在的类需要在容器中）
 * 参数可以写一下类型
 * 1、Message message:原生消息详细信息。头+体
 * 2、T<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>发送的消息的类型</span><span class="token punctuation">&gt;</span></span> OrderReturnReasonEntity content;
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660210035834}</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息的属性信息</span>
    <span class="token comment">//[headers={__TypeId__=com.atguigu.gulimall.order.entity.OrderReturnReasonEntity}, contentType=application/json, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=hello-java-exchange, receivedRoutingKey=hello.java, deliveryTag=1, consumerTag=amq.ctag-5sX1WFjvna_vui2BTkXVdg, consumerQueue=hello-java-queue]</span>
    <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> contentType <span class="token operator">=</span> messageProperties<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息：&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;==&gt;内容：&quot;</span><span class="token operator">+</span> entity<span class="token operator">+</span><span class="token string">&quot;==&gt;内容类型：&quot;</span><span class="token operator">+</span>contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.3.1.png" alt="image-20220811191525667" tabindex="0" loading="lazy"><figcaption>image-20220811191525667</figcaption></figure><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里再次执行<code>sendMessage2</code>方法，用于<code>hello-java-exchange</code>交换机使用<code>hello.java</code>路由键发送Java对象消息</p><p>控制台输出：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-11 <span class="token number">19</span>:11:53.932  INFO <span class="token number">13548</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c.a.g.o.GulimallOrderApplicationTests    <span class="token builtin class-name">:</span> 消息发送完成OrderReturnReasonEntity<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span>啊啊啊, <span class="token assign-left variable">sort</span><span class="token operator">=</span>null, <span class="token assign-left variable">status</span><span class="token operator">=</span>null, <span class="token assign-left variable">createTime</span><span class="token operator">=</span>Thu Aug <span class="token number">11</span> <span class="token number">19</span>:11:53 CST <span class="token number">2022</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.3.2.png" alt="image-20220811191225460" tabindex="0" loading="lazy"><figcaption>image-20220811191225460</figcaption></figure><p>打开<code>gulimall-order</code>模块的控制台，可以看到接收到的消息和序列化好的消息内容对象</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>接收到消息：(Body<span class="token operator">:</span>&#39;<span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;啊啊啊&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;sort&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token property">&quot;createTime&quot;</span><span class="token operator">:</span><span class="token number">1660216409211</span><span class="token punctuation">}</span>&#39; MessageProperties <span class="token punctuation">[</span>headers=<span class="token punctuation">{</span>__TypeId__=com.atguigu.gulimall.order.entity.OrderReturnReasonEntity<span class="token punctuation">}</span><span class="token punctuation">,</span> contentType=application/json<span class="token punctuation">,</span> contentEncoding=UTF<span class="token number">-8</span><span class="token punctuation">,</span> contentLength=<span class="token number">0</span><span class="token punctuation">,</span> receivedDeliveryMode=PERSISTENT<span class="token punctuation">,</span> priority=<span class="token number">0</span><span class="token punctuation">,</span> redelivered=<span class="token boolean">false</span><span class="token punctuation">,</span> receivedExchange=hello-java-exchange<span class="token punctuation">,</span> receivedRoutingKey=hello.java<span class="token punctuation">,</span> deliveryTag=<span class="token number">1</span><span class="token punctuation">,</span> consumerTag=amq.ctag-7ScvVL_ZKCfOBosHgXUfMQ<span class="token punctuation">,</span> consumerQueue=hello-java-queue<span class="token punctuation">]</span>)==&gt;内容：OrderReturnReasonEntity(id=<span class="token number">1</span><span class="token punctuation">,</span> name=啊啊啊<span class="token punctuation">,</span> sort=<span class="token null keyword">null</span><span class="token punctuation">,</span> status=<span class="token null keyword">null</span><span class="token punctuation">,</span> createTime=Thu Aug <span class="token number">11</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2022</span>)==&gt;内容类型application/json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.3.3.png" alt="image-20220811191408265" tabindex="0" loading="lazy"><figcaption>image-20220811191408265</figcaption></figure><h5 id="_4、添加channel类型参数" tabindex="-1"><a class="header-anchor" href="#_4、添加channel类型参数" aria-hidden="true">#</a> 4、添加<code>Channel</code>类型参数</h5><p>参数还可以传<code>com.rabbitmq.client.Channel</code>类型，获取当前传输数据的通道</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在需要监听队列的业务方法上标注@RabbitListener注解（该方法所在的类需要在容器中）
 * 参数可以写一下类型
 * 1、Message message:原生消息详细信息。头+体
 * 2、T<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>发送的消息的类型</span><span class="token punctuation">&gt;</span></span> OrderReturnReasonEntity content;
 * Channel channel: 当前传输数据的通道
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660210035834}</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息的属性信息</span>
    <span class="token comment">//[headers={__TypeId__=com.atguigu.gulimall.order.entity.OrderReturnReasonEntity}, contentType=application/json, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=hello-java-exchange, receivedRoutingKey=hello.java, deliveryTag=1, consumerTag=amq.ctag-5sX1WFjvna_vui2BTkXVdg, consumerQueue=hello-java-queue]</span>
    <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> contentType <span class="token operator">=</span> messageProperties<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息：&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;==&gt;内容：&quot;</span><span class="token operator">+</span> entity<span class="token operator">+</span><span class="token string">&quot;==&gt;内容类型：&quot;</span><span class="token operator">+</span>contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.4.4.png" alt="image-20220811191929570" tabindex="0" loading="lazy"><figcaption>image-20220811191929570</figcaption></figure><h4 id="_5、集群接收消息" tabindex="-1"><a class="header-anchor" href="#_5、集群接收消息" aria-hidden="true">#</a> 5、集群接收消息</h4><h5 id="_1、批量发送消息" tabindex="-1"><a class="header-anchor" href="#_1、批量发送消息" aria-hidden="true">#</a> 1、批量发送消息</h5><p>选中<code>GulimallorderApplication :9000/</code>这个服务，右键选择<code>Copy Configuration...</code>，在弹出的对话框的<code>Program arguments:</code>里输入<code>--server.port=9001</code>，然后点击<code>OK</code>就复制了一份配置，启动刚刚复制的<code>GulimallorderApplication(1)</code>这个服务，模拟集群接收消息</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.1.1.png" alt="GIF 2022-8-11 19-34-45" style="zoom:67%;"><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里修改<code>sendMessage2</code>方法，用于<code>hello-java-exchange</code>交换机使用<code>hello.java</code>路由键发送10条Java对象消息，然后执行该测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 发送其他对象类型消息
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//发送消息，如果发送的消息是个对象，我们会使用序列化机制，将对象写出去。对象必须实现Serializable</span>
      <span class="token class-name">OrderReturnReasonEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderReturnReasonEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      entity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;啊啊啊--&gt;&quot;</span><span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//rabbitTemplate.send();</span>
      <span class="token comment">//convertAndSend(String exchange, String routingKey, final Object object)</span>
      rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.1.2.png" alt="image-20220811192800214" tabindex="0" loading="lazy"><figcaption>image-20220811192800214</figcaption></figure><p><code>GulimallorderApplication :9000/</code> 服务收到了<code>0</code>、<code>3</code>、<code>6</code>、<code>9</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.1.3.png" alt="image-20220811192942423" tabindex="0" loading="lazy"><figcaption>image-20220811192942423</figcaption></figure><p><code>GulimallorderApplication(1) :9001/</code> 服务收到了<code>1</code>、<code>4</code>、<code>7</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.1.4.png" alt="image-20220811193020853" tabindex="0" loading="lazy"><figcaption>image-20220811193020853</figcaption></figure><p>还有3个消息被刚刚执行的<code>sendMessage2</code>测试方法收到了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.1.5.png" alt="image-20220811193154515" tabindex="0" loading="lazy"><figcaption>image-20220811193154515</figcaption></figure><h5 id="_2、模拟业务处理时间长" tabindex="-1"><a class="header-anchor" href="#_2、模拟业务处理时间长" aria-hidden="true">#</a> 2、模拟业务处理时间长</h5><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类里的<code>receiveMessage</code>方法，在方法里面让程序睡3s ，模拟业务处理时间长</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在需要监听队列的业务方法上标注@RabbitListener注解（该方法所在的类需要在容器中）
 * 参数可以写一下类型
 * 1、Message message:原生消息详细信息。头+体
 * 2、T<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>发送的消息的类型</span><span class="token punctuation">&gt;</span></span> OrderReturnReasonEntity content;
 * Channel channel: 当前传输数据的通道
 *
 * Queue:可以很多人都来监听。只要收到消息，队列删除消息，而且只能有一一个收到此消息
 * 场景:
 * 1)、订单服务启动多个;同一个消息，只能有一个客户端收到
 * 2)、只有一个消息完全处理完，方法运行结束，我们就可以接收到下一个消息
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">//{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660210035834}</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息的属性信息</span>
    <span class="token comment">//[headers={__TypeId__=com.atguigu.gulimall.order.entity.OrderReturnReasonEntity}, contentType=application/json, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=hello-java-exchange, receivedRoutingKey=hello.java, deliveryTag=1, consumerTag=amq.ctag-5sX1WFjvna_vui2BTkXVdg, consumerQueue=hello-java-queue]</span>
    <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> contentType <span class="token operator">=</span> messageProperties<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息：&quot;</span><span class="token operator">+</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息处理完成：&quot;</span> <span class="token operator">+</span> entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.2.1.png" alt="image-20220811194408956" tabindex="0" loading="lazy"><figcaption>image-20220811194408956</figcaption></figure><p>关闭<code>GulimallOrderApplication (1)</code>服务，重启<code>GulimallOrderApplication</code>服务（<code>gulimall-order</code>模块只启动一个服务）</p><p>可以看到即使业务执行时间很长，也是当前业务执行完后再处理的下一个请求，不会出现这个请求还没处理完下一个请求又开始处理的问题。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.2.2.gif" alt="GIF 2022-8-11 19-41-16" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-11 19-41-16</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包下新建<code>test</code>文件夹，在<code>test</code>文件夹里新建<code>ReceiveMessage</code>类，将<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类里的<code>receiveMessage</code>方法移动到该类（方便回来看代码）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderReturnReasonEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MessageProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/11
 * @Description: com.atguigu.gulimall.order.GulimallOrderApplicationTests.sendMessage2发送消息
 *  测试发放的控制台也有可能收到消息，测试方法的控制台也要看
 *  测试该类时，注释掉ReceiveMessage2类的方法
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessage</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 在需要监听队列的业务方法上标注@RabbitListener注解（该方法所在的类需要在容器中）
     * 参数可以写一下类型
     * 1、Message message:原生消息详细信息。头+体
     * 2、T<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>发送的消息的类型</span><span class="token punctuation">&gt;</span></span> OrderReturnReasonEntity content;
     * Channel channel: 当前传输数据的通道
     *
     * Queue:可以很多人都来监听。只要收到消息，队列删除消息，而且只能有一一个收到此消息
     * 场景:
     * 1)、订单服务启动多个;同一个消息，只能有一个客户端收到
     * 2)、只有一 -个消息完全处理完，方法运行结束，我们就可以接收到下一个消息
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//{&quot;id&quot;:1,&quot;name&quot;:&quot;啊啊啊&quot;,&quot;sort&quot;:null,&quot;status&quot;:null,&quot;createTime&quot;:1660210035834}</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息的属性信息</span>
        <span class="token comment">//[headers={__TypeId__=com.atguigu.gulimall.order.entity.OrderReturnReasonEntity}, contentType=application/json, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=hello-java-exchange, receivedRoutingKey=hello.java, deliveryTag=1, consumerTag=amq.ctag-5sX1WFjvna_vui2BTkXVdg, consumerQueue=hello-java-queue]</span>
        <span class="token class-name">MessageProperties</span> messageProperties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> contentType <span class="token operator">=</span> messageProperties<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息：&quot;</span><span class="token operator">+</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息处理完成：&quot;</span> <span class="token operator">+</span> entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.2.3.png" alt="image-20220811195116191" tabindex="0" loading="lazy"><figcaption>image-20220811195116191</figcaption></figure><h5 id="_3、接收多种实体对应的消息" tabindex="-1"><a class="header-anchor" href="#_3、接收多种实体对应的消息" aria-hidden="true">#</a> 3、接收多种实体对应的消息</h5><p>在<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类里添加<code>sendMessage3</code>方法，用于发送不同实体类型的消息内容</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 发送不同对象类型消息(模拟同一个队列发送不同对象 或 不同队列发送的对象不同)
 * 发送OrderReturnReasonEntity对象 ReceiveMessage2类的receiveMessage1方法接收该消息
 * 发送OrderEntity对象             ReceiveMessage2类的receiveMessage2方法接收该消息
 *
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//发送消息，如果发送的消息是个对象，我们会使用序列化机制，将对象写出去。对象必须实现Serializable</span>
         <span class="token class-name">OrderReturnReasonEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderReturnReasonEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;啊啊啊--&gt;&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//rabbitTemplate.send();</span>
         <span class="token comment">//convertAndSend(String exchange, String routingKey, final Object object)</span>
         rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token class-name">OrderEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.3.1.png" alt="image-20220811201450598" tabindex="0" loading="lazy"><figcaption>image-20220811201450598</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，执行<code>sendMessage3</code>测试方法，可以看到如果消息内容与前面参数的接收类型不一致，则获取不到别的类型的信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.3.2.gif" alt="GIF 2022-8-11 20-13-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-11 20-13-40</figcaption></figure><p>上节介绍的那种方式只能处理发送的消息内容是对应参数实体的消息，如何处理消息内容是多个不同实体的消息呢？</p><p>可以在类上添加<code>@RabbitListener(queues = {&quot;hello-java-queue&quot;})</code>注解，不同方法的参数传不同类型的实体，然后在方法上添加<code>@RabbitHandler</code>注解，用于处理不同对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderReturnReasonEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/11
 * @Description: com.atguigu.gulimall.order.GulimallOrderApplicationTests.sendMessage3发送消息
 *  测试发放的控制台也有可能收到消息，测试方法的控制台也要看
 *  测试该类时，注释掉ReceiveMessage1类的方法
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessage2</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage1</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrderReturnReasonEntity类消息处理完成：&quot;</span> <span class="token operator">+</span> entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage2</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> entity<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrderEntity类消息处理完成：&quot;</span> <span class="token operator">+</span> entity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.3.3.png" alt="image-20220811202134679" tabindex="0" loading="lazy"><figcaption>image-20220811202134679</figcaption></figure><p>注释掉<code>com.atguigu.gulimall.order.test.ReceiveMessage</code>类的<code>receiveMessage</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.3.4.png" alt="image-20220811202514362" tabindex="0" loading="lazy"><figcaption>image-20220811202514362</figcaption></figure><p>重启<code>gulimall-order</code>模块，再次执行<code>sendMessage3</code>测试方法，查看<code>gulimall-order</code>模块控制台，可以看到，消息被不同的方法正确处理了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.5.3.5.gif" alt="GIF 2022-8-11 20-27-09" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-11 20-27-09</figcaption></figure><h4 id="_6、消息可靠投递与消息可靠抵达" tabindex="-1"><a class="header-anchor" href="#_6、消息可靠投递与消息可靠抵达" aria-hidden="true">#</a> 6、消息可靠投递与消息可靠抵达</h4><p>Reliability Guide：可靠投递：https://www.rabbitmq.com/reliability.html</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.0.1.png" alt="GIF 2022-8-11 20-53-58" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-11 20-53-58</figcaption></figure><p>消息可靠抵达： https://www.rabbitmq.com/confirms.html#publisher-confirms</p><blockquote><p>Using standard AMQP 0-9-1, the only way to guarantee that a message isn&#39;t lost is by using transactions -- make the channel transactional then for each message or set of messages publish, commit. In this case, transactions are unnecessarily heavyweight and decrease throughput by a factor of 250. To remedy this, a confirmation mechanism was introduced. It mimics the consumer acknowledgements mechanism already present in the protocol.</p><p>使用标准 AMQP 0-9-1，保证消息不丢失的唯一方法是使用事务——使通道具有事务性，然后为每条消息或一组消息发布、提交。 在这种情况下，事务不确定是不是重量级的，并且会将吞吐量降低了 250 倍。为了解决这个问题，引入了确认机制。 它模仿了协议中已经存在的消费者确认机制。</p></blockquote><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.0.2.png" alt="GIF 2022-8-11 21-02-23" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-11 21-02-23</figcaption></figure><p><strong>RabbitMQ消息确认机制简介</strong></p><p>保证消息不丢失，可靠抵达，可以使用事务消息，但性能会下降250倍，为此引入确认机制</p><ul><li><p><strong>publisher</strong> confirmCallback 确认模式（发布者 -&gt; 消息代理，这里的消息代理指的是RabbitMQ）</p></li><li><p><strong>publisher</strong> returnCallback 未投递到 queue 退回模式 （交换机 -&gt; 队列）</p></li><li><p><strong>consumer</strong> ack机制 ( 队列 -&gt; 消费者 )</p></li></ul><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.0.3.png" alt="image-20220811210347860" tabindex="0" loading="lazy"><figcaption>image-20220811210347860</figcaption></figure><h5 id="_1、confirmcallback" tabindex="-1"><a class="header-anchor" href="#_1、confirmcallback" aria-hidden="true">#</a> 1、ConfirmCallback</h5><p><strong>spring.rabbitmq.publisher-confirms=true</strong></p><ul><li><p>在创建 connectionFactory 的时候设置 PublisherConfirms(true) 选项，开启confirmcallback 。</p></li><li><p>CorrelationData：用来表示当前消息唯一性。</p></li><li><p>消息只要被 broker 接收到就会执行 confirmCallback，如果是 cluster 模式，需要所有broker 接收到才会调用 confirmCallback。</p></li><li><p>被 broker 接收到只能表示 message 已经到达服务器，并不能保证消息一定会被投递 到目标 queue 里。所以需要用到接下来的returnCallback 。</p></li></ul><p>在<code>org.springframework.amqp.rabbit.core.RabbitTemplate</code>类里定义了<code>ConfirmCallback</code>函数式接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * A callback for publisher confirmations.
 *
 */</span>
<span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfirmCallback</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Confirmation callback.
    * <span class="token keyword">@param</span> <span class="token parameter">correlationData</span> correlation data for the callback.(消息的关联标识，唯一id)
    * <span class="token keyword">@param</span> <span class="token parameter">ack</span> true for ack, false for nack (消息有没有正确的收到)
    * <span class="token keyword">@param</span> <span class="token parameter">cause</span> An optional cause, for nack, when available, otherwise null. (消息如果没有被正确收到的原因)
    */</span>
   <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.1.png" alt="image-20220812090028474" tabindex="0" loading="lazy"><figcaption>image-20220812090028474</figcaption></figure><p>想要开启发布者发送消息到消息代理的确认，首先需要将<code>spring.rabbitmq.publisher-confirms</code>设为<code>true</code></p><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#开启 发布者发送消息到消息代理的确认 publisher-&gt;broker(默认false)</span>
<span class="token key attr-name">spring.rabbitmq.publisher-confirms</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.2.png" alt="image-20220812092304154" tabindex="0" loading="lazy"><figcaption>image-20220812092304154</figcaption></figure><p>然后调用<code>rabbitTemplate.setConfirmCallback()</code>方法，参数传<code>ConfirmCallback</code>函数式接口的实现类</p><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类里添加<code>initRabbitTemplate</code>方法,用于接收发布者发送消息到消息代理的确认</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 在构造器执行之后执行
 * 定制RabbitTemplate
 * 1、spring.rabbitmq.publisher-confirms=true
 * 2、设置确认回调
 */</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initRabbitTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *只要消息抵达Broker就ack=true
         * <span class="token keyword">@param</span> <span class="token parameter">correlationData</span> 当前消息的唯一关联数据(这个是消息的唯一-id)
         * <span class="token keyword">@param</span> <span class="token parameter">ack</span>             消息是否成功收到
         * <span class="token keyword">@param</span> <span class="token parameter">cause</span>           失败的原因
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;confirm...CorrelationData==&gt;[&quot;</span><span class="token operator">+</span>correlationData<span class="token operator">+</span><span class="token string">&quot;]ack==&gt;[&quot;</span><span class="token operator">+</span>ack<span class="token operator">+</span><span class="token string">&quot;]cause==&gt;[&quot;</span><span class="token operator">+</span>cause<span class="token operator">+</span><span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.3.png" alt="image-20220812093420886" tabindex="0" loading="lazy"><figcaption>image-20220812093420886</figcaption></figure><p>注释掉<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.test.ReceiveMessage</code>类上的方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.4.png" alt="image-20220812103741526" tabindex="0" loading="lazy"><figcaption>image-20220812103741526</figcaption></figure><p>注释掉<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类上的方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.5.png" alt="image-20220812103720520" tabindex="0" loading="lazy"><figcaption>image-20220812103720520</figcaption></figure><p>执行<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类的<code>sendMessage3</code>测试方法，可以看到没有消费者也能收到回调，但是获取的内容是null，这是因为发送消息时没有设置id</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>confirm<span class="token punctuation">..</span>.CorrelationData<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>ack<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>true<span class="token punctuation">]</span>cause<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.6.png" alt="image-20220812093305500" tabindex="0" loading="lazy"><figcaption>image-20220812093305500</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类的<code>sendMessage3</code>测试方法，在发送消息时指定<code>CorrelationData</code>，用于设置唯一id</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//发送消息，如果发送的消息是个对象，我们会使用序列化机制，将对象写出去。对象必须实现Serializable</span>
         <span class="token class-name">OrderReturnReasonEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderReturnReasonEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;啊啊啊--&gt;&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//rabbitTemplate.send();</span>
         <span class="token comment">//convertAndSend(String exchange, String routingKey, final Object object)</span>
         rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token class-name">OrderEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.7.png" alt="image-20220812102727147" tabindex="0" loading="lazy"><figcaption>image-20220812102727147</figcaption></figure><p>再次执行<code>sendMessage3</code>测试方法，在<code>gulimall-order</code>控制台就可以看到id信息了，这样就可以知道是哪个消息投递失败了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>confirm<span class="token punctuation">..</span>.CorrelationData<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>CorrelationData <span class="token punctuation">[</span>id<span class="token operator">=</span>a89916d3-4d48-443a-a32e-3a902c773b6d<span class="token punctuation">]</span><span class="token punctuation">]</span>ack<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>true<span class="token punctuation">]</span>cause<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>
confirm<span class="token punctuation">..</span>.CorrelationData<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>CorrelationData <span class="token punctuation">[</span>id<span class="token operator">=</span>e5d6db9a-a929-4345-b08f-cd2ef6fd24be<span class="token punctuation">]</span><span class="token punctuation">]</span>ack<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>true<span class="token punctuation">]</span>cause<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>
confirm<span class="token punctuation">..</span>.CorrelationData<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>CorrelationData <span class="token punctuation">[</span>id<span class="token operator">=</span>2b5a0e61-477c-4c5d-9043-df127c917c88<span class="token punctuation">]</span><span class="token punctuation">]</span>ack<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>true<span class="token punctuation">]</span>cause<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.1.8.png" alt="image-20220812102934374" tabindex="0" loading="lazy"><figcaption>image-20220812102934374</figcaption></figure><h5 id="_2、returncallback" tabindex="-1"><a class="header-anchor" href="#_2、returncallback" aria-hidden="true">#</a> 2、ReturnCallback</h5><p><strong>spring.rabbitmq.publisher-returns=true</strong><strong>spring.rabbitmq.template.mandatory=true</strong></p><ul><li><p>confrim 模式只能保证消息到达 broker，不能保证消息准确投递到目标 queue 里。在有 些业务场景下，我们需要保证消息一定要投递到目标 queue 里，此时就需要用到return 退回模式。</p></li><li><p>这样如果未能投递到目标 queue 里将调用 returnCallback ，可以记录下详细到投递数 据，定期的巡检或者自动纠错都需要这些数据。</p></li></ul><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，用于开启发送端消息从交换机抵达队列失败的回调</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#开启发送端消息从交换机抵达队列失败的回调(默认false)</span>
<span class="token key attr-name">spring.rabbitmq.publisher-returns</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#只要抵达队列，以异步发送优先回调我们这个returnConfirm(当然也可以不设置，默认false)</span>
<span class="token key attr-name">spring.rabbitmq.template.mandatory</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.2.1.png" alt="image-20220812093905279" tabindex="0" loading="lazy"><figcaption>image-20220812093905279</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyRabbitConfig</code>类的<code>initRabbitTemplate</code>方法添加如下代码，用于接收消息从交换机到队列的确认</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//消息从交换机抵达队列失败的回调（比如：让路由键匹配不到绑定的交换机或队列）</span>
rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 只要消息没有投递给指定的队列，就触发这个失败回调
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>    投递失败的消息详细信息
     * <span class="token keyword">@param</span> <span class="token parameter">replyCode</span>  回复的状态码
     * <span class="token keyword">@param</span> <span class="token parameter">replyText</span>  回复的文本内容
     * <span class="token keyword">@param</span> <span class="token parameter">exchange</span>   当时这个消息发给哪个交换机
     * <span class="token keyword">@param</span> <span class="token parameter">routingKey</span> 当时这个消息用哪个路由键
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">int</span> replyCode<span class="token punctuation">,</span> <span class="token class-name">String</span> replyText<span class="token punctuation">,</span> <span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;message = &quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;, replyCode = &quot;</span> <span class="token operator">+</span> replyCode <span class="token operator">+</span>
                <span class="token string">&quot;, replyText = &quot;</span> <span class="token operator">+</span> replyText <span class="token operator">+</span> <span class="token string">&quot;, exchange = &quot;</span> <span class="token operator">+</span> exchange <span class="token operator">+</span> <span class="token string">&quot;, routingKey = &quot;</span> <span class="token operator">+</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.2.2.png" alt="image-20220812101719532" tabindex="0" loading="lazy"><figcaption>image-20220812101719532</figcaption></figure><p>可以看到，只有消息投递到Broker的回调，没有交换机投递到队列的回调，这是因为只有消息从交换机投递到队列失败才会执行<code>ReturnCallback</code>的回调</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>confirm<span class="token punctuation">..</span>.CorrelationData<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>ack<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>true<span class="token punctuation">]</span>cause<span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>null<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.2.3.png" alt="image-20220812101535421" tabindex="0" loading="lazy"><figcaption>image-20220812101535421</figcaption></figure><p>那么如何让消息从交换机投递到队列失败呢？只需让路由键匹配不到绑定的交换机或队列即可</p><p>复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类的<code>sendMessage3</code>方法，将方法名修改为<code>sendMessage4</code>并让指定的路由键不对</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//发送消息，如果发送的消息是个对象，我们会使用序列化机制，将对象写出去。对象必须实现Serializable</span>
         <span class="token class-name">OrderReturnReasonEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderReturnReasonEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;啊啊啊--&gt;&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//rabbitTemplate.send();</span>
         <span class="token comment">//convertAndSend(String exchange, String routingKey, final Object object)</span>
         rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token class-name">OrderEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         entity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.javxxxxa&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
         log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.2.4.png" alt="image-20220812101848150" tabindex="0" loading="lazy"><figcaption>image-20220812101848150</figcaption></figure><p>执行<code>sendMessage4</code>测试方法，查看<code>gulimall-order</code>模块的控制台即可看到，此时就执行了<code>消息从交换机抵达队列失败的回调</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>message <span class="token operator">=</span> <span class="token punctuation">(</span>Body:<span class="token string">&#39;{&quot;id&quot;:null,&quot;memberId&quot;:null,&quot;orderSn&quot;:&quot;9e4b4e95-4ed3-4ce5-a384-85ce2ee6bdc5&quot;,&quot;couponId&quot;:null,&quot;createTime&quot;:null,&quot;memberUsername&quot;:null,&quot;totalAmount&quot;:null,&quot;payAmount&quot;:null,&quot;freightAmount&quot;:null,&quot;promotionAmount&quot;:null,&quot;integrationAmount&quot;:null,&quot;couponAmount&quot;:null,&quot;discountAmount&quot;:null,&quot;payType&quot;:null,&quot;sourceType&quot;:null,&quot;status&quot;:null,&quot;deliveryCompany&quot;:null,&quot;deliverySn&quot;:null,&quot;autoConfirmDay&quot;:null,&quot;integration&quot;:null,&quot;growth&quot;:null,&quot;billType&quot;:null,&quot;billHeader&quot;:null,&quot;billContent&quot;:null,&quot;billReceiverPhone&quot;:null,&quot;billReceiverEmail&quot;:null,&quot;receiverName&quot;:null,&quot;receiverPhone&quot;:null,&quot;receiverPostCode&quot;:null,&quot;receiverProvince&quot;:null,&quot;receiverCity&quot;:null,&quot;receiverRegion&quot;:null,&quot;receiverDetailAddress&quot;:null,&quot;note&quot;:null,&quot;confirmStatus&quot;:null,&quot;deleteStatus&quot;:null,&quot;useIntegration&quot;:null,&quot;paymentTime&quot;:null,&quot;deliveryTime&quot;:null,&quot;receiveTime&quot;:null,&quot;commentTime&quot;:null,&quot;modifyTime&quot;:null}&#39;</span> MessageProperties <span class="token punctuation">[</span>headers<span class="token operator">=</span><span class="token punctuation">{</span>__TypeId__<span class="token operator">=</span>com.atguigu.gulimall.order.entity.OrderEntity<span class="token punctuation">}</span>, <span class="token assign-left variable">contentType</span><span class="token operator">=</span>application/json, <span class="token assign-left variable">contentEncoding</span><span class="token operator">=</span>UTF-8, <span class="token assign-left variable">contentLength</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">receivedDeliveryMode</span><span class="token operator">=</span>PERSISTENT, <span class="token assign-left variable">priority</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">deliveryTag</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>, replyCode <span class="token operator">=</span> <span class="token number">312</span>, replyText <span class="token operator">=</span> NO_ROUTE, exchange <span class="token operator">=</span> hello-java-exchange, routingKey <span class="token operator">=</span> hello.javxxxxa
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.2.5.png" alt="image-20220812102033532" tabindex="0" loading="lazy"><figcaption>image-20220812102033532</figcaption></figure><h5 id="_3、默认的ack消息确认机制" tabindex="-1"><a class="header-anchor" href="#_3、默认的ack消息确认机制" aria-hidden="true">#</a> 3、默认的Ack消息确认机制</h5><p>消费者获取到消息，成功处理，可以回复Ack给Broker</p><ul><li><p>basic.ack用于肯定确认；broker将移除此消息</p></li><li><p>basic.nack用于否定确认；可以指定broker是否丢弃此消息，可以批量</p></li><li><p>basic.reject用于否定确认；同上，但不能批量</p></li></ul><p>默认自动ack，消息被消费者收到，就会从broker的queue中移除</p><p>queue无消费者，消息依然会被存储，直到消费者消费</p><p>消费者收到消息，默认会自动ack。但是如果无法确定此消息是否被处理完成， 或者成功处理。我们可以开启手动ack模式</p><ul><li><p>消息处理成功，ack()，接受下一个消息，此消息broker就会移除</p></li><li><p>消息处理失败，nack()/reject()，重新发送给其他人进行处理，或者容错处理后ack</p></li><li><p>消息一直没有调用ack/nack方法，broker认为此消息正在被处理，不会投递给别人，此时客户端断开，消息不会被broker移除，会投递给别人</p></li></ul><p>先取消注释<code>gulimall-order</code>模块<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.3.1.png" alt="image-20220812103905178" tabindex="0" loading="lazy"><figcaption>image-20220812103905178</figcaption></figure><p>先启动<code>GulimallOrderApplication</code>服务，让其把<code>hello-java-queue</code>里的消息都处理完，再停止<code>GulimallOrderApplication</code>服务，再注释掉<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的方法，再运行测试类的<code>sendMessage4</code>方法，保证<code>hello-java-queue</code>里有<code>5</code>条消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.3.2.png" alt="image-20220812104606169" tabindex="0" loading="lazy"><figcaption>image-20220812104606169</figcaption></figure><p>再打开<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的方法，并在<code>receiveMessage1</code>方法的<code>System.out.println(&quot;OrderReturnReasonEntity类消息处理完成：&quot; + entity.getName());</code>这一行打上断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.3.3.png" alt="image-20220812110139116" tabindex="0" loading="lazy"><figcaption>image-20220812110139116</figcaption></figure><p>以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务，可以看到如果服务停机，队列里的消息直接清零了，这是<code>IDEA</code>的问题，点击<code>IDEA</code>的<code>Stop</code>不会强制停止服务，而是等程序处理完才停止（类似于调用<code>tomcat</code>的<code>shutdown.bat</code>程序，而不是直接关闭<code>startup.bat</code>窗口。即告诉程序要将其关闭了，这个程序接送到关闭指令后可以选择不理会或者把剩余的事情做完后再关闭，而不是直接杀死进程。类似于电脑关机，点击关机后如果文件没保存这不会关机成功，如果文件都保存则自己会执行关闭指令，而并非直接拔掉电源）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.3.4.gif" alt="GIF 2022-8-12 10-59-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 10-59-54</figcaption></figure><p>使用上面的方法，再次让<code>hello-java-queue</code>里有<code>5</code>条消息</p><p>然后再以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务，可以看到放行一个后队列里减少了一个，然后直接强行杀死<code>java.exe</code>进程，此时队列里的消息还是<code>4</code>个，这样就不会变到<code>0</code>了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>taskkill /f /t /im java.exe
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到即使服务宕机，消息也不会丢失</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.3.5.gif" alt="GIF 2022-8-12 15-14-00" style="zoom:67%;"><h5 id="_4、手动确认消息" tabindex="-1"><a class="header-anchor" href="#_4、手动确认消息" aria-hidden="true">#</a> 4、手动确认消息</h5><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，将自动回复模式调为手动模式</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#将自动回复模式调为手动模式 (默认auto:自动回复)</span>
<span class="token key attr-name">spring.rabbitmq.listener.simple.acknowledge-mode</span><span class="token punctuation">=</span><span class="token value attr-value">manual</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.1.png" alt="image-20220812110817884" tabindex="0" loading="lazy"><figcaption>image-20220812110817884</figcaption></figure><p>注释掉<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的方法，再运行测试类的<code>sendMessage4</code>方法，保证<code>hello-java-queue</code>里有<code>5</code>条消息，再打开<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的方法，并在<code>receiveMessage1</code>方法的<code>System.out.println(&quot;OrderReturnReasonEntity类消息处理完成：&quot; + entity.getName());</code>这一行打上断点，以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务，</p><p>可以看到，只要不手动签收，消息就不会减少，服务停掉后，消息状态由<code>Unacked</code>变为了<code>Ready</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.2.gif" alt="GIF 2022-8-12 11-34-52" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 11-34-52</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的<code>receiveMessage1</code>方法，调用<code>channel.basicAck(deliveryTag,false);</code>手动确认消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitHandler</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage1</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrderReturnReasonEntity类消息处理完成：&quot;</span> <span class="token operator">+</span> entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//channel信道内按顺序自增</span>
    <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//签收货物</span>
        <span class="token comment">//basicAck(long deliveryTag, boolean multiple是否批量确认收货，如果为false只签收当前消息)</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;签收了第&quot;</span><span class="token operator">+</span>deliveryTag<span class="token operator">+</span><span class="token string">&quot;个货物&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//网络中断，签收失败</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.3.png" alt="image-20220812152209945" tabindex="0" loading="lazy"><figcaption>image-20220812152209945</figcaption></figure><p>再次以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务，此时手动确认后消息就会减少了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.4.gif" alt="GIF 2022-8-12 15-20-07" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 15-20-07</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.test.ReceiveMessage2</code>类的<code>receiveMessage1</code>方法，这次让<code>deliveryTag</code>为偶数的签收，<code>deliveryTag</code>为奇数的拒收</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitHandler</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage1</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">OrderReturnReasonEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrderReturnReasonEntity类消息处理完成：&quot;</span> <span class="token operator">+</span> entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//channel信道内按顺序自增</span>
    <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deliveryTag <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//签收消息</span>
        <span class="token comment">//basicAck(long deliveryTag, boolean multiple是否批量确认收货，如果为false只签收当前消息)</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;签收了第&quot;</span> <span class="token operator">+</span> deliveryTag <span class="token operator">+</span> <span class="token string">&quot;个货物&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//拒收消息</span>
        <span class="token comment">//requeue=false丢弃消息 requeue=true 消息发回服务器，服务器重新入队。</span>
        <span class="token comment">//basicReject(long deliveryTag, boolean requeue)</span>
        <span class="token comment">//channel.basicReject();</span>

        <span class="token comment">//basicNack(long deliveryTag, boolean multiple, boolean requeue)</span>
        channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;拒签了第&quot;</span><span class="token operator">+</span>deliveryTag<span class="token operator">+</span><span class="token string">&quot;个货物&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.5.png" alt="image-20220812155137808" tabindex="0" loading="lazy"><figcaption>image-20220812155137808</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplicationTests</code>测试类,添加<code>sendMessage5</code>方法，重新让<code>hello-java-queue</code>里有<code>5</code>条消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送消息，如果发送的消息是个对象，我们会使用序列化机制，将对象写出去。对象必须实现Serializable</span>
        <span class="token class-name">OrderReturnReasonEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderReturnReasonEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;发送第【&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;】个货物&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//rabbitTemplate.send();</span>
        <span class="token comment">//convertAndSend(String exchange, String routingKey, final Object object)</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成{}&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.6.png" alt="image-20220812154759677" tabindex="0" loading="lazy"><figcaption>image-20220812154759677</figcaption></figure><p>查看<code>gulimall-order</code>模块的控制台，可以看到拒绝签收的货物会重新入队</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>OrderReturnReasonEntity类消息处理完成：发送第【1】个货物
拒签了第1个货物
OrderReturnReasonEntity类消息处理完成：发送第【2】个货物
签收了第2个货物
OrderReturnReasonEntity类消息处理完成：发送第【3】个货物
拒签了第3个货物
OrderReturnReasonEntity类消息处理完成：发送第【4】个货物
签收了第4个货物
OrderReturnReasonEntity类消息处理完成：发送第【5】个货物
拒签了第5个货物
OrderReturnReasonEntity类消息处理完成：发送第【1】个货物
签收了第6个货物
OrderReturnReasonEntity类消息处理完成：发送第【3】个货物
拒签了第7个货物
OrderReturnReasonEntity类消息处理完成：发送第【5】个货物
签收了第8个货物
OrderReturnReasonEntity类消息处理完成：发送第【3】个货物
拒签了第9个货物
OrderReturnReasonEntity类消息处理完成：发送第【3】个货物
签收了第10个货物
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.2.6.4.7.png" alt="image-20220812155056526" tabindex="0" loading="lazy"><figcaption>image-20220812155056526</figcaption></figure><h3 id="_5-8-3、基本页面准备" tabindex="-1"><a class="header-anchor" href="#_5-8-3、基本页面准备" aria-hidden="true">#</a> 5.8.3、基本页面准备</h3><h4 id="_1、添加文件" tabindex="-1"><a class="header-anchor" href="#_1、添加文件" aria-hidden="true">#</a> 1、添加文件</h4><h5 id="_1、添加购物车详情页" tabindex="-1"><a class="header-anchor" href="#_1、添加购物车详情页" aria-hidden="true">#</a> 1、添加购物车详情页</h5><p>在<code>linux</code>虚拟机里的<code>/mydata/nginx/html/static</code>目录下新建<code>order</code>目录，在<code>/mydata/nginx/html/static/order</code>目录下新建<code>detail</code>目录，将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\等待付款</code>里的文件夹全部复制到linux虚拟机里的<code>/mydata/nginx/html/static/order/detail</code>目录下（不包括<code>index.html</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.1.1.gif" alt="GIF 2022-8-12 16-11-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 16-11-02</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources</code>新建<code>templates</code>文件夹，将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\等待付款</code>里的<code>index.html</code>复制到<code>src/main/resources/templates</code>里面，并将刚刚粘贴的<code>index.html</code>重命名为<code>detail.html</code>（我图片上的名字写错了，文件名应该是<code>detail.html</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.1.2.png" alt="image-20220812161433035" tabindex="0" loading="lazy"><figcaption>image-20220812161433035</figcaption></figure><h5 id="_2、添加全部订单页" tabindex="-1"><a class="header-anchor" href="#_2、添加全部订单页" aria-hidden="true">#</a> 2、添加全部订单页</h5><p>在<code>linux</code>虚拟机里的<code>/mydata/nginx/html/static/order</code>目录下新建<code>list</code>目录，将<code>\2.分布式高级篇（微服务架构篇）\资料源码\代码\html\订单页</code>里的文件夹全部复制到linux虚拟机里的<code>/mydata/nginx/html/static/order/list</code>目录下（不包括<code>index.html</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.2.1.gif" alt="GIF 2022-8-12 16-15-50" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 16-15-50</figcaption></figure><p>将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\订单页</code>里的<code>index.html</code>复制到<code>src/main/resources/templates</code>里面，并将刚刚粘贴的<code>index.html</code>重命名为<code>list.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.2.2.png" alt="image-20220812161724334" tabindex="0" loading="lazy"><figcaption>image-20220812161724334</figcaption></figure><h5 id="_3、添加确认支付页" tabindex="-1"><a class="header-anchor" href="#_3、添加确认支付页" aria-hidden="true">#</a> 3、添加确认支付页</h5><p>在<code>linux</code>虚拟机里的<code>/mydata/nginx/html/static/order</code>目录下新建<code>confirm</code>目录，将<code>\2.分布式高级篇（微服务架构篇）\资料源码\代码\html\结算页</code>里的文件夹全部复制到linux虚拟机里的<code>/mydata/nginx/html/static/order/confirm</code>目录下（不包括<code>index.html</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.3.1.gif" alt="GIF 2022-8-12 16-18-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 16-18-40</figcaption></figure><p>将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\结算页</code>里的<code>index.html</code>复制到<code>src/main/resources/templates</code>里面，并将刚刚粘贴的<code>index.html</code>重命名为<code>confirm.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.3.2.png" alt="image-20220812161915481" tabindex="0" loading="lazy"><figcaption>image-20220812161915481</figcaption></figure><h5 id="_4、添加支付页" tabindex="-1"><a class="header-anchor" href="#_4、添加支付页" aria-hidden="true">#</a> 4、添加支付页</h5><p>在<code>linux</code>虚拟机里的<code>/mydata/nginx/html/static/order</code>目录下新建<code>pay</code>目录，将<code>\2.分布式高级篇（微服务架构篇）\资料源码\代码\html\收银页</code>里的文件夹全部复制到linux虚拟机里的<code>/mydata/nginx/html/static/order/pay</code>目录下（不包括<code>index.html</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.4.1.gif" alt="GIF 2022-8-12 16-20-33" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 16-20-33</figcaption></figure><p>将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码\html\收银页</code>里的<code>index.html</code>复制到<code>src/main/resources/templates</code>里面，并将刚刚粘贴的<code>index.html</code>重命名为<code>pay.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.1.4.2.png" alt="image-20220812162123877" tabindex="0" loading="lazy"><figcaption>image-20220812162123877</figcaption></figure><h4 id="_2、修改配置" tabindex="-1"><a class="header-anchor" href="#_2、修改配置" aria-hidden="true">#</a> 2、修改配置</h4><h5 id="_1、添加域名" tabindex="-1"><a class="header-anchor" href="#_1、添加域名" aria-hidden="true">#</a> 1、添加域名</h5><p>在<code>hosts</code>文件里添加<code>order.gulimall.com</code>域名</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.1.png" alt="image-20220812162316152" tabindex="0" loading="lazy"><figcaption>image-20220812162316152</figcaption></figure><h5 id="_2、负载均衡到订单模块" tabindex="-1"><a class="header-anchor" href="#_2、负载均衡到订单模块" aria-hidden="true">#</a> 2、负载均衡到订单模块</h5><p>在<code>gulimall-gateway</code>网关模块的<code>src/main/resources/application.yml</code>配置文件里添加如下配置，负载均衡到订单模块</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_order_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>order
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Host=order.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.2.png" alt="image-20220812162541964" tabindex="0" loading="lazy"><figcaption>image-20220812162541964</figcaption></figure><h5 id="_3、修改页面" tabindex="-1"><a class="header-anchor" href="#_3、修改页面" aria-hidden="true">#</a> 3、修改页面</h5><p>修改<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件，将<code>src=&quot;</code>全部替换为<code>src=&quot;/static/order/confirm/</code>，将<code>href=&quot;</code>全部替换为<code>href=&quot;/static/order/confirm/</code></p><p><a href="/gulimall/code/5.8.3.2.3.1.html" class="">点击查看完整代码</a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;
src=&quot;</span>/static/order/confirm/

<span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;
href=&quot;</span>/static/order/confirm/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.3.1.png" alt="image-20220812164331436" tabindex="0" loading="lazy"><figcaption>image-20220812164331436</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>src/main/resources/templates/detail.html</code>文件（我图片上的名字写错了，文件名应该是<code>detail.html</code>），将<code>href=&quot;</code>全部替换为<code>href=&quot;/static/order/detail/</code>，将<code>src=&quot;</code>全部替换为<code>src=&quot;/static/order/detail/</code></p><p><a href="/gulimall/code/5.8.3.2.3.2.html" class="">点击查看完整代码</a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;
href=&quot;</span>/static/order/detail/

<span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;
src=&quot;</span>/static/order/detail/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.3.2.png" alt="image-20220812164336185" tabindex="0" loading="lazy"><figcaption>image-20220812164336185</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>src/main/resources/templates/list.html</code>文件，将<code>href=&quot;</code>全部替换为<code>href=&quot;/static/order/list/</code>，将<code>src=&quot;</code>全部替换为<code>src=&quot;/static/order/list/</code></p><p><a href="/gulimall/code/5.8.3.2.3.3.html" class="">点击查看完整代码</a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;
href=&quot;</span>/static/order/list/

<span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;
src=&quot;</span>/static/order/list/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.3.3.png" alt="image-20220812164341946" tabindex="0" loading="lazy"><figcaption>image-20220812164341946</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>src/main/resources/templates/pay.html</code>文件，将<code>href=&quot;</code>全部替换为<code>href=&quot;/static/order/pay/</code>，将<code>src=&quot;</code>全部替换为<code>src=&quot;/static/order/pay/</code></p><p><a href="/gulimall/code/5.8.3.2.3.4.html" class="">点击查看完整代码</a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;
href=&quot;</span>/static/order/pay/

<span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;
src=&quot;</span>/static/order/pay/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.3.4.png" alt="image-20220812164347258" tabindex="0" loading="lazy"><figcaption>image-20220812164347258</figcaption></figure><p>后面发现<code>detail.html</code>名字写错了，重新将<code>gulimall-order</code>模块的<code>src/main/resources/templates</code>文件夹里面的<code>deatil.html</code>改名为<code>detail.html</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.2.3.5.png" alt="image-20220812164454741" tabindex="0" loading="lazy"><figcaption>image-20220812164454741</figcaption></figure><h4 id="_3、添加配置" tabindex="-1"><a class="header-anchor" href="#_3、添加配置" aria-hidden="true">#</a> 3、添加配置</h4><h5 id="_1、引入thymeleaf" tabindex="-1"><a class="header-anchor" href="#_1、引入thymeleaf" aria-hidden="true">#</a> 1、引入<code>thymeleaf</code></h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包下新建<code>web</code>文件夹，在<code>web</code>文件夹下新建<code>HelloController</code>类，用于跳转到对应的页面</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/12
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{page}.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">listPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> page<span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> page<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.1.1.png" alt="image-20220812165506126" tabindex="0" loading="lazy"><figcaption>image-20220812165506126</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件中引入<code>thymeleaf</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--模板引擎：thymeleaf--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.1.2.png" alt="image-20220812165445920" tabindex="0" loading="lazy"><figcaption>image-20220812165445920</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，关闭<code>thymeleaf</code>缓存</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.thymeleaf.cache</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.1.3.png" alt="image-20220812165545721" tabindex="0" loading="lazy"><figcaption>image-20220812165545721</figcaption></figure><h5 id="_2、开启服务发现" tabindex="-1"><a class="header-anchor" href="#_2、开启服务发现" aria-hidden="true">#</a> 2、开启服务发现</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplication</code>启动类里添加如下注解，开启服务发现功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.1.png" alt="image-20220812165931686" tabindex="0" loading="lazy"><figcaption>image-20220812165931686</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，配置服务发现的服务端地址</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8848</span>
<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">gulimall-order</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.2.png" alt="image-20220812170213145" tabindex="0" loading="lazy"><figcaption>image-20220812170213145</figcaption></figure><p>启动<code>GulimallOrderApplication</code>服务和<code>GulimallGatewayApplication</code>服务</p><p>浏览器访问 http://order.gulimall.com/list.html 页面，可以看到已经成功显示了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.3.png" alt="image-20220812170311899" tabindex="0" loading="lazy"><figcaption>image-20220812170311899</figcaption></figure><p>浏览器访问 http://order.gulimall.com/confirm.html 页面，只有顶部的显示了，很明显：下面的渲染失败了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.4.png" alt="image-20220812170454565" tabindex="0" loading="lazy"><figcaption>image-20220812170454565</figcaption></figure><p>查看<code>gulimall-order</code>模块控制台，报了<code>未完成的块结构</code>的异常（其实就是只有<code>/*</code>没有<code>*/</code>的意思）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span><span class="token operator">:</span> <span class="token class-name">Unfinished</span> block structure <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token comment">/*...*/</span><span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>页面里搜索<code>/*</code>，把这个<code>/*</code>删掉</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.5.png" alt="image-20220812170533163" tabindex="0" loading="lazy"><figcaption>image-20220812170533163</figcaption></figure><p>重启<code>gulimall-order</code>模块，浏览器再次访问 http://order.gulimall.com/confirm.html 页面就可以发现访问成功了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.6.png" alt="image-20220812170553926" tabindex="0" loading="lazy"><figcaption>image-20220812170553926</figcaption></figure><p>浏览器访问 http://order.gulimall.com/detail.html 页面，也成功显示了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.7.png" alt="image-20220812170628021" tabindex="0" loading="lazy"><figcaption>image-20220812170628021</figcaption></figure><p>浏览器访问 http://order.gulimall.com/pay.html 页面，也成功显示了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.2.8.png" alt="image-20220812170658598" tabindex="0" loading="lazy"><figcaption>image-20220812170658598</figcaption></figure><h5 id="_3、引入spring-session" tabindex="-1"><a class="header-anchor" href="#_3、引入spring-session" aria-hidden="true">#</a> 3、引入Spring Session</h5><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件里引入<code>Spring Session</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--引入SpringSession--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.3.1.png" alt="image-20220812172537172" tabindex="0" loading="lazy"><figcaption>image-20220812172537172</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，指定session存储用redis</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#使用redis做session</span>
<span class="token key attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.3.2.png" alt="image-20220812172650505" tabindex="0" loading="lazy"><figcaption>image-20220812172650505</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/application.yml</code>配置文件里添加如下配置，配置redis的host</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.56.10
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.3.3.png" alt="image-20220812172817257" tabindex="0" loading="lazy"><figcaption>image-20220812172817257</figcaption></figure><p>复制<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config.GulimallSessionConfig</code>，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.3.4.png" alt="image-20220812172000032" tabindex="0" loading="lazy"><figcaption>image-20220812172000032</figcaption></figure><h5 id="_4、添加线程池" tabindex="-1"><a class="header-anchor" href="#_4、添加线程池" aria-hidden="true">#</a> 4、添加线程池</h5><p>再将<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.config</code>包下的<code>MyThreadConfig.java</code>文件和<code>ThreadPollConfigProperties.java</code>文件复制一份，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.4.1.png" alt="image-20220812172101394" tabindex="0" loading="lazy"><figcaption>image-20220812172101394</figcaption></figure><p>复制一份<code>gulimall-product</code>模块的<code>src/main/resources/application.properties</code>配置文件的线程池配置，粘贴到<code>gulimall-order</code>模块的<code>src/main/resources/application.properties</code>配置文件里</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">gulimall.thread.core-pool-size</span><span class="token punctuation">=</span><span class="token value attr-value">20</span>
<span class="token key attr-name">gulimall.thread.maximum-pool-size</span><span class="token punctuation">=</span><span class="token value attr-value">200</span>
<span class="token key attr-name">gulimall.thread.keep-alive-time</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.4.2.png" alt="image-20220812172156406" tabindex="0" loading="lazy"><figcaption>image-20220812172156406</figcaption></figure><h5 id="_5、完善页面" tabindex="-1"><a class="header-anchor" href="#_5、完善页面" aria-hidden="true">#</a> 5、完善页面</h5><p>在 http://gulimall.com/ 页面里，打开控制台，定位到<code>我的订单</code>位置，复制<code>我的订单</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.1.png" alt="image-20220812191803697" tabindex="0" loading="lazy"><figcaption>image-20220812191803697</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/templates/index.html</code>文件夹搜索<code>我的订单</code>，将该文本对应的<code>&lt;a&gt;</code>标签的<code>href</code>的值修改为<code>http://order.gulimall.com/list.html</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://order.gulimall.com/list.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我的订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.2.png" alt="image-20220812192043294" tabindex="0" loading="lazy"><figcaption>image-20220812192043294</figcaption></figure><p>在 http://order.gulimall.com/detail.html 页面里，打开控制台，定位到<code>你好，请登录</code>位置，复制<code>你好</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.3.png" alt="image-20220812193135848" tabindex="0" loading="lazy"><figcaption>image-20220812193135848</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/detail.html</code>文件里，将<code>&lt;html&gt;</code>修改为<code>&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</code>，以引入<code>thymeleaf</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.4.png" alt="image-20220812192725179" tabindex="0" loading="lazy"><figcaption>image-20220812192725179</figcaption></figure><p>然后在<code>detail.html</code>文件里搜索<code>你好</code>，修改周围的代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${session.loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>欢迎：[[${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/login.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${session.loginUser==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>你好，请登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://auth.gulimall.com/reg.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${session.loginUser==null}<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>免费注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
   |<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.5.png" alt="image-20220812192920395" tabindex="0" loading="lazy"><figcaption>image-20220812192920395</figcaption></figure><p>在 http://order.gulimall.com/confirm.html 页面里，打开控制台，定位到<code>尚硅谷</code>位置，复制<code>尚硅谷</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.6.png" alt="image-20220812193505560" tabindex="0" loading="lazy"><figcaption>image-20220812193505560</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里，将<code>&lt;html&gt;</code>修改为<code>&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</code>，以引入<code>thymeleaf</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.7.png" alt="image-20220812193628352" tabindex="0" loading="lazy"><figcaption>image-20220812193628352</figcaption></figure><p>然后在<code>confirm.html</code>文件里搜索<code>尚硅谷</code>，将<code>尚硅谷</code>替换为用户的昵称</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--尚硅谷--&gt;</span>[[${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/order/confirm/img/03.png<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">margin-bottom</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span><span class="token property">margin-left3</span><span class="token punctuation">:</span> 3px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/order/confirm/img/06.png<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.8.png" alt="image-20220812193546229" tabindex="0" loading="lazy"><figcaption>image-20220812193546229</figcaption></figure><p>在 http://order.gulimall.com/pay.html 页面里，打开控制台，定位到<code>尚硅谷</code>位置，复制<code>尚硅谷</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.9.png" alt="image-20220812193742730" tabindex="0" loading="lazy"><figcaption>image-20220812193742730</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/pay.html</code>文件里，将<code>&lt;html&gt;</code>修改为<code>&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</code>，以引入<code>thymeleaf</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.10.png" alt="image-20220812193819825" tabindex="0" loading="lazy"><figcaption>image-20220812193819825</figcaption></figure><p>然后在<code>pay.html</code>文件里搜索<code>尚硅谷</code>，将<code>尚硅谷</code>替换为用户的昵称</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--尚硅谷--&gt;</span>[[${session.loginUser?.nickname}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>退出<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.11.png" alt="image-20220812193900964" tabindex="0" loading="lazy"><figcaption>image-20220812193900964</figcaption></figure><p>重启<code>gulimall-order</code>模块和<code>gulimall-product</code>模块，浏览器打开以下页面，可以发现都可以正常访问</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://order.gulimall.com/list.html
http://order.gulimall.com/pay.html
http://order.gulimall.com/detail.html
http://order.gulimall.com/confirm.html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/5.8.3.3.5.12.gif" alt="GIF 2022-8-12 19-43-25" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 19-43-25</figcaption></figure><h1 id="六、订单" tabindex="-1"><a class="header-anchor" href="#六、订单" aria-hidden="true">#</a> 六、订单</h1><h2 id="_6-1、订单模块" tabindex="-1"><a class="header-anchor" href="#_6-1、订单模块" aria-hidden="true">#</a> 6.1、订单模块</h2><h3 id="_6-1-1、编写基本功能" tabindex="-1"><a class="header-anchor" href="#_6-1-1、编写基本功能" aria-hidden="true">#</a> 6.1.1、编写基本功能</h3><h4 id="_1、基本功能" tabindex="-1"><a class="header-anchor" href="#_1、基本功能" aria-hidden="true">#</a> 1、基本功能</h4><h5 id="_1、订单中心" tabindex="-1"><a class="header-anchor" href="#_1、订单中心" aria-hidden="true">#</a> 1、订单中心</h5><p>电商系统涉及到 3 流，分别时信息流，资金流，物流，而订单系统作为中枢将三者有机的集合起来。 用户信息包括用户账号、用户等级、用户的收货地址、收货人、收货人电话等组成，用户账户需要绑定手机号码，但是用户绑定的手机号码不一定是收货信息上的电话。用户可以添加多个收货信息，用户等级信息可以用来和促销系统进行匹配，获取商品折扣，同时用户等级还可以获取积分的奖励等 <strong>2、订单基础信息订单基础信息是订单流转的核心，其包括订单类型、父/子订单、订单编号、订单状态、订单流转的时间等。</strong> （1）订单类型包括实体商品订单和虚拟订单商品等，这个根据商城商品和服务类型进行区分。（2）同时订单都需要做父子订单处理，之前在初创公司一直只有一个订单，没有做父子订单处理后期需要进行拆单的时候就比较麻烦，尤其是多商户商场，和不同仓库商品的时候，父子订单就是为后期做拆单准备的。 （3）订单编号不多说了，需要强调的一点是父子订单都需要有订单编号，需要完善的时候可以对订单编号的每个字段进行统一定义和诠释。 （4）订单状态记录订单每次流转过程，后面会对订单状态进行单独的说明。 （5）订单流转时间需要记录下单时间，支付时间，发货时间，结束时间/关闭时间等等 <strong>3、商品信息商品信息从商品库中获取商品的 SKU 信息、图片、名称、属性规格、商品单价、商户信息等，从用户下单行为记录的用户下单数量，商品合计价格等。</strong><strong>4.优惠信息优惠信息记录用户参与的优惠活动，包括优惠促销活动，比如满减、满赠、秒杀等，用户使用的优惠券信息，优惠券满足条件的优惠券需要默认展示出来，具体方式已在之前的优惠券篇章做过详细介绍，另外还虚拟币抵扣信息等进行记录。</strong> 为什么把优惠信息单独拿出来而不放在支付信息里面呢？因为优惠信息只是记录用户使用的条目，而支付信息需要加入数据进行计算，所以做为区分。 <strong>5.支付信息</strong> （1）支付流水单号，这个流水单号是在唤起网关支付后支付通道返回给电商业务平台的支付流水号，财务通过订单号和流水单号与支付通道进行对账使用。 （2）支付方式用户使用的支付方式，比如微信支付、支付宝支付、钱包支付、快捷支付等。 支付方式有时候可能有两个——余额支付+第三方支付。 （3）商品总金额，每个商品加总后的金额；运费，物流产生的费用；优惠总金额，包括促销活动的优惠金额，优惠券优惠金额，虚拟积分或者虚拟币抵扣的金额，会员折扣的金额等之和；实付金额，用户实际需要付款的金额。 用户实付金额=商品总金额+运费-优惠总金额</p><p><strong>6.物流信息物流信息包括配送方式，物流公司，物流单号，物流状态，物流状态可以通过第三方接口来获取和向用户展示物流每个状态节点。</strong></p><h5 id="_2、订单状态" tabindex="-1"><a class="header-anchor" href="#_2、订单状态" aria-hidden="true">#</a> 2、订单状态</h5><ol><li>待付款 用户提交订单后，订单进行预下单，目前主流电商网站都会唤起支付，便于用户快速完成支付，需要注意的是待付款状态下可以对库存进行锁定，锁定库存需要配置支付超时时间，超时后将自动取消订单，订单变更关闭状态。</li><li>已付款/待发货 用户完成订单支付，订单系统需要记录支付时间，支付流水单号便于对账，订单下放到 WMS系统，仓库进行调拨，配货，分拣，出库等操作。</li><li>待收货/已发货 仓储将商品出库后，订单进入物流环节，订单系统需要同步物流信息，便于用户实时知悉物品物流状态</li><li>已完成 用户确认收货后，订单交易完成。后续支付侧进行结算，如果订单存在问题进入售后状态</li><li>已取消 付款之前取消订单。包括超时未付款或用户商户取消订单都会产生这种订单状态。</li><li>售后中 用户在付款后申请退款，或商家发货后用户申请退换货。售后也同样存在各种状态，当发起售后申请后生成售后订单，售后订单状态为待审核，等待商家审核，商家审核通过后订单状态变更为待退货，等待用户将商品寄回，商家收货后订单状态更新为待退款状态，退款到用户原账户后订单状态更新为售后成功。</li></ol><p>售后也同样存在各种状态，当发起售后申请后生成售后订单，售后订单状态为待审核，等待 商家审核，商家审核通过后订单状态变更为待退货，等待用户将商品寄回，商家收货后订单 状态更新为待退款状态，退款到用户原账户后订单状态更新为售后成功。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.1.2.png" alt="image-20220812200227632" tabindex="0" loading="lazy"><figcaption>image-20220812200227632</figcaption></figure><h5 id="_3、订单流程" tabindex="-1"><a class="header-anchor" href="#_3、订单流程" aria-hidden="true">#</a> 3、订单流程</h5><p>订单流程是指从订单产生到完成整个流转的过程，从而行程了一套标准流程规则。而不同的 产品类型或业务类型在系统中的流程会千差万别，比如上面提到的线上实物订单和虚拟订单 的流程，线上实物订单与 O2O 订单等，所以需要根据不同的类型进行构建订单流程。 不管类型如何订单都包括正向流程和逆向流程，对应的场景就是购买商品和退换货流程，正 向流程就是一个正常的网购步骤：</p><p>订单生成–&gt;支付订单–&gt;卖家发货–&gt;确认收货–&gt;交易成功。 而每个步骤的背后，订单是如何在多系统之间交互流转的，可概括如下图</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/电商订单流程图.png" alt="电商订单流程图" tabindex="0" loading="lazy"><figcaption>电商订单流程图</figcaption></figure><h4 id="_2、去结算" tabindex="-1"><a class="header-anchor" href="#_2、去结算" aria-hidden="true">#</a> 2、去结算</h4><h5 id="_1、修改页面" tabindex="-1"><a class="header-anchor" href="#_1、修改页面" aria-hidden="true">#</a> 1、修改页面</h5><p>在 http://cart.gulimall.com/cart.html 页面里， 打开控制台，定位到<code>去结算</code>位置，复制<code>去结算</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.1.1.png" alt="image-20220812201404756" tabindex="0" loading="lazy"><figcaption>image-20220812201404756</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>配置文件里搜<code>去结算</code>，会发现<code>去结算</code> 会调用 <code>toTrade()</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.1.2.png" alt="image-20220812201534509" tabindex="0" loading="lazy"><figcaption>image-20220812201534509</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>src/main/resources/templates/cartList.html</code>的<code>&lt;script&gt;</code>标签里添加<code>toTrade</code>方法，让其跳转到<code>http://order.gulimall.com/toTrade</code>页面</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>function <span class="token function">toTrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;http://order.gulimall.com/toTrade&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.1.3.png" alt="image-20220812201618445" tabindex="0" loading="lazy"><figcaption>image-20220812201618445</figcaption></figure><h5 id="_2、添加拦截器等配置" tabindex="-1"><a class="header-anchor" href="#_2、添加拦截器等配置" aria-hidden="true">#</a> 2、添加拦截器等配置</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web</code>包下，新建<code>OrderWebController</code>类，添加<code>toTrade</code>方法，将<code>/toTrade</code>请求返回<code>confirm.html</code>页面</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>web</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/12
 * @Description:
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderWebController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toTrade&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toTrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token string">&quot;confirm&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.1.png" alt="image-20220812202237450" tabindex="0" loading="lazy"><figcaption>image-20220812202237450</figcaption></figure><p>修改<code>gulimall-auth-server</code>模块的<code>com.atguigu.gulimall.auth.controller.LoginController</code>类的<code>login</code>方法</p><p>如果登录成功会在<code>redis</code>里放一个<code>MemberEntityTo</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">UserLoginVo</span> vo<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> redirectAttributes<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Object</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">MemberEntityTo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">,</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://gulimall.com&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>r<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;errors&quot;</span><span class="token punctuation">,</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.2.png" alt="image-20220812204045816" tabindex="0" loading="lazy"><figcaption>image-20220812204045816</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包下新建<code>interceptor</code>文件夹，在<code>interceptor</code>文件夹里添加<code>LoginUserInterceptor</code>类。如果登录了，就把<code>MemberEntityTo</code>放到<code>ThreadLocal</code>里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>interceptor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">AuthServerConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span></span><span class="token class-name">MemberEntityTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">HandlerInterceptor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/12
 * @Description: 添加拦截器
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUserInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberEntityTo</span><span class="token punctuation">&gt;</span></span> loginUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> attribute <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span><span class="token constant">LOGIN_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">MemberEntityTo</span> memberEntityTo<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberEntityTo</span><span class="token punctuation">)</span> attribute<span class="token punctuation">;</span>
            loginUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;请先进行登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//没登陆就重定向到登录页面</span>
            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">&quot;http://auth.gulimall.com/login.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.3.png" alt="image-20220812214626533" tabindex="0" loading="lazy"><figcaption>image-20220812214626533</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包下新建<code>OrderWebConfig</code>类，指定拦截器的拦截路径</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">LoginUserInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">InterceptorRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/12
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">LoginUserInterceptor</span> interceptor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.4.png" alt="image-20220812205038706" tabindex="0" loading="lazy"><figcaption>image-20220812205038706</figcaption></figure><p>在<code>gulimall-auth-server</code>模块的<code>src/main/resources/templates/login.html</code>文件里的<code>&lt;span&gt;谷粒商城不会以任何理由要求您转账汇款，谨防诈骗。&lt;/span&gt;</code>下面添加如下代码，如果用户未登录或登录失败了给与一些提示</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>br<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token string">&quot;color: red&quot;</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>session<span class="token operator">?</span><span class="token punctuation">.</span>msg<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.5.png" alt="image-20220812205455626" tabindex="0" loading="lazy"><figcaption>image-20220812205455626</figcaption></figure><p>重启<code>gulimall-auth-server</code>模块，在购物车页面 http://cart.gulimall.com/cart.html 里点击去结算，如果没有登录就会来到了登录页 http://auth.gulimall.com/login.html ，并会提示<code>请先进行登录</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.6.gif" alt="GIF 2022-8-12 20-55-33" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 20-55-33</figcaption></figure><p>登录成功后，就可以正常购买了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.2.7.gif" alt="GIF 2022-8-12 20-57-23" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-12 20-57-23</figcaption></figure><h5 id="_3、确认订单" tabindex="-1"><a class="header-anchor" href="#_3、确认订单" aria-hidden="true">#</a> 3、确认订单</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包下新建<code>vo</code>文件夹，在<code>vo</code>文件夹下新建<code>OrderConfirmVo</code>类</p><p><a href="code/6.1.1.2.3.OrderConfirmVo.java">点击查看<code>OrderConfirmVo</code>类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.3.1.png" alt="image-20220812211512652" tabindex="0" loading="lazy"><figcaption>image-20220812211512652</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.OrderWebController</code>类里修改<code>toTrade</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toTrade&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toTrade</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderConfirmData&quot;</span><span class="token punctuation">,</span>orderConfirmVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//订单确认页</span>
    <span class="token keyword">return</span> <span class="token string">&quot;confirm&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.3.2.png" alt="image-20220812211850970" tabindex="0" loading="lazy"><figcaption>image-20220812211850970</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里添加<code>confirmOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 给订单确认页返回需要的数据
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.3.3.png" alt="image-20220812211946621" tabindex="0" loading="lazy"><figcaption>image-20220812211946621</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里实现<code>confirmOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.3.4.png" alt="image-20220812212217746" tabindex="0" loading="lazy"><figcaption>image-20220812212217746</figcaption></figure><h5 id="_4、获取用户地址" tabindex="-1"><a class="header-anchor" href="#_4、获取用户地址" aria-hidden="true">#</a> 4、获取用户地址</h5><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.controller.MemberReceiveAddressController</code>类里添加<code>getAddress</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{memberId}/address&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> memberReceiveAddressService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.4.1.png" alt="image-20220812212920444" tabindex="0" loading="lazy"><figcaption>image-20220812212920444</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.MemberReceiveAddressService</code>接口里添加<code>getAddress</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 获取会员的收货地址列表
 * <span class="token keyword">@param</span> <span class="token parameter">memberId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token class-name">Long</span> memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.4.2.png" alt="image-20220812213004224" tabindex="0" loading="lazy"><figcaption>image-20220812213004224</figcaption></figure><p>在<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.service.impl.MemberReceiveAddressServiceImpl</code>类里实现<code>getAddress</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token class-name">Long</span> memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MemberReceiveAddressEntity</span><span class="token operator">::</span><span class="token function">getMemberId</span><span class="token punctuation">,</span>memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.4.3.png" alt="image-20220812213904292" tabindex="0" loading="lazy"><figcaption>image-20220812213904292</figcaption></figure><h5 id="_5、开启远程调用" tabindex="-1"><a class="header-anchor" href="#_5、开启远程调用" aria-hidden="true">#</a> 5、开启远程调用</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.GulimallOrderApplication</code>类上添加如下注解，用于开启远程调用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.5.1.png" alt="image-20220812212502236" tabindex="0" loading="lazy"><figcaption>image-20220812212502236</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign.MemberFeignService</code>接口里添加<code>getAddress</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/member/memberreceiveaddress/{memberId}/address&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>MemberAddressVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;memberId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.5.2.png" alt="image-20220812214426749" tabindex="0" loading="lazy"><figcaption>image-20220812214426749</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里，修改<code>confirmOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1、远程查询所有的收货地址列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>MemberAddressVo</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2、远程查询购物车所有选中的购物项</span>

    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.5.3.png" alt="image-20220812214942217" tabindex="0" loading="lazy"><figcaption>image-20220812214942217</figcaption></figure><h5 id="_6、获取用户购物项" tabindex="-1"><a class="header-anchor" href="#_6、获取用户购物项" aria-hidden="true">#</a> 6、获取用户购物项</h5><p>在<code>gulimall-cart</code>类的<code>com.atguigu.gulimall.cart.controller.CartController</code>类里，添加<code>getCurrentUserCartItems</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/currentUserCartItems&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> cartService<span class="token punctuation">.</span><span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.6.1.png" alt="image-20220812215229405" tabindex="0" loading="lazy"><figcaption>image-20220812215229405</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.CartService</code>接口里添加<code>getUserCartItems</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.6.2.png" alt="image-20220812215300264" tabindex="0" loading="lazy"><figcaption>image-20220812215300264</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里实现<code>getUserCartItems</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cartItems<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取所有被选中的购物项</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> cartItems<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">CartItemVo</span><span class="token operator">::</span><span class="token function">getCheck</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                        <span class="token comment">//获取商品最新价格</span>
                        <span class="token comment">//item.setPrice();</span>
                        <span class="token keyword">return</span> item<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.6.3.png" alt="image-20220815085149349" tabindex="0" loading="lazy"><figcaption>image-20220815085149349</figcaption></figure><h5 id="_7、查询最新价格" tabindex="-1"><a class="header-anchor" href="#_7、查询最新价格" aria-hidden="true">#</a> 7、查询最新价格</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.SkuInfoController</code>类里添加<code>getPrice</code>方法，用于查询商品最新价格</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 实时查询商品价格
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{skuId}/price&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SkuInfoEntity</span> skuInfoEntity <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> skuInfoEntity<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.7.1.png" alt="image-20220815085712933" tabindex="0" loading="lazy"><figcaption>image-20220815085712933</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.feign.ProductFeignService</code>接口里添加<code>getPrice</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/skuinfo/{skuId}/price&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.7.2.png" alt="image-20220815085918556" tabindex="0" loading="lazy"><figcaption>image-20220815085918556</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类里修改<code>getUserCartItems</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cartItems<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取所有被选中的购物项</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> cartItems<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">CartItemVo</span><span class="token operator">::</span><span class="token function">getCheck</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                        <span class="token comment">//获取商品最新价格</span>
                        <span class="token class-name">BigDecimal</span> price <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> item<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.7.3.png" alt="image-20220815090130557" tabindex="0" loading="lazy"><figcaption>image-20220815090130557</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign</code>包下新建<code>CartFeignService</code>接口，用于调用购物车模块</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">OrderConfirmVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/15
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-cart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CartFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/currentUserCartItems&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.7.4.png" alt="image-20220815090438769" tabindex="0" loading="lazy"><figcaption>image-20220815090438769</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里修改<code>confirmOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1、远程查询所有的收货地址列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>MemberAddressVo</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、远程查询购物车所有选中的购物项</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、查询用户积分</span>
    <span class="token class-name">Integer</span> integration <span class="token operator">=</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//orderConfirmVo.setIntegration(orderConfirmVo.getIntegration());</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 防重令牌</span>

    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.7.5.png" alt="image-20220815092345880" tabindex="0" loading="lazy"><figcaption>image-20220815092345880</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类里修改<code>getPayPrice</code>方法和<code>getTotal</code>方法，添加<code>orderToken</code>字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderConfirmVo</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token doc-comment comment">/**
     * 令牌，防止重复提交
     */</span>
    <span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span>
    <span class="token class-name">String</span> orderToken<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigDecimal</span> sum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BigDecimal</span> bigDecimal <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sum <span class="token operator">=</span> sum<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bigDecimal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="code/6.1.1.2.7.java">点击查看完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.2.7.6.png" alt="image-20220815092524337" tabindex="0" loading="lazy"><figcaption>image-20220815092524337</figcaption></figure><h4 id="_3、测试" tabindex="-1"><a class="header-anchor" href="#_3、测试" aria-hidden="true">#</a> 3、测试</h4><h5 id="_1、测试一-1" tabindex="-1"><a class="header-anchor" href="#_1、测试一-1" aria-hidden="true">#</a> 1、测试一</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法的<code>List&lt;OrderConfirmVo.MemberAddressVo&gt; address = memberFeignService.getAddress(memberEntityTo.getId());</code>和<code>List&lt;OrderConfirmVo.OrderItemVo&gt; items = cartFeignService.getCurrentUserCartItems();</code>上打断点</p><p>启动<code>GulimallThirdPartyApplication</code>、<code>GulimallSearchApplication</code>、<code>GulimallGatewayApplication</code>、<code>GulimallProductApplication</code>、<code>GulimallAuthServerApplication</code>服务，以<code>debug</code>方式启动<code>GulimallOrderApplication</code>、<code>GulimallMemberApplication</code>、<code>GulimallCartApplication</code>服务</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.1.png" alt="image-20220815093312419" tabindex="0" loading="lazy"><figcaption>image-20220815093312419</figcaption></figure><p>登录后，在 http://gulimall.com/ 页面点击 我的购物车 -&gt; 去结算，程序就会停到断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.2.gif" alt="GIF 2022-8-15 9-58-48" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-15 9-58-48</figcaption></figure><p>切换到<code>IDEA</code>，此时断点停在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法的<code>List&lt;OrderConfirmVo.MemberAddressVo&gt; address = memberFeignService.getAddress(memberEntityTo.getId());</code>上，此时已经获取到<code>7</code>号用户的基本信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.3.png" alt="image-20220815100024111" tabindex="0" loading="lazy"><figcaption>image-20220815100024111</figcaption></figure><p>查看<code>gulimall_ums</code>数据库的<code>ums_member_receive_address</code>表，可以看到<code>7</code>号用户此时还没有收货地址</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.4.png" alt="image-20220815100035034" tabindex="0" loading="lazy"><figcaption>image-20220815100035034</figcaption></figure><p>在<code>gulimall_ums</code>数据库的<code>ums_member_receive_address</code>表里，随便给<code>member_id</code>为7的用户增加点信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.5.png" alt="image-20220815100303139" tabindex="0" loading="lazy"><figcaption>image-20220815100303139</figcaption></figure><p>再次切换到<code>IDEA</code>，点击<code>GulimallOrderApplication</code>服务的<code>Step Over</code>(步过)按钮，执行当前方法的下一个语句，报了<code>no-argument constructor</code>没有无参构造的错误</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-15 <span class="token number">10</span>:04:23.391 ERROR <span class="token number">5340</span> --- <span class="token punctuation">[</span>nio-9000-exec-1<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is feign.codec.DecodeException: Error <span class="token keyword">while</span> extracting response <span class="token keyword">for</span> <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>java.util.List<span class="token operator">&lt;</span>com.atguigu.gulimall.order.vo.OrderConfirmVo<span class="token variable">$MemberAddressVo</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> and content <span class="token builtin class-name">type</span> <span class="token punctuation">[</span>application/json<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8<span class="token punctuation">]</span><span class="token punctuation">;</span> nested exception is org.springframework.http.converter.HttpMessageNotReadableException: JSON parse error: Cannot construct instance of <span class="token variable"><span class="token variable">`</span>com.atguigu.gulimall.order.vo.OrderConfirmVo$MemberAddressVo<span class="token variable">`</span></span> <span class="token punctuation">(</span>although at least one Creator exists<span class="token punctuation">)</span>: can only instantiate non-static inner class by using default, no-argument constructor<span class="token punctuation">;</span> nested exception is com.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot construct instance of <span class="token variable"><span class="token variable">`</span>com.atguigu.gulimall.order.vo.OrderConfirmVo$MemberAddressVo<span class="token variable">`</span></span> <span class="token punctuation">(</span>although at least one Creator exists<span class="token punctuation">)</span>: can only instantiate non-static inner class by using default, no-argument constructor
 at <span class="token punctuation">[</span>Source: <span class="token punctuation">(</span>PushbackInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span> line: <span class="token number">1</span>, column: <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>through reference chain: java.util.ArrayList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> with root cause

com.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot construct instance of <span class="token variable"><span class="token variable">`</span>com.atguigu.gulimall.order.vo.OrderConfirmVo$MemberAddressVo<span class="token variable">`</span></span> <span class="token punctuation">(</span>although at least one Creator exists<span class="token punctuation">)</span>: can only instantiate non-static inner class by using default, no-argument constructor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.6.png" alt="image-20220815100956608" tabindex="0" loading="lazy"><figcaption>image-20220815100956608</figcaption></figure><p>给<code>MemberAddressVo</code>和<code>OrderItemVo</code>加上<code>static</code>即可，<a href="code/6.1.1.3.1.java">点击查看完整代码</a></p><p>给<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类的内部类<code>MemberAddressVo</code>加<code>static</code>修饰符</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.7.png" alt="image-20220815101140462" tabindex="0" loading="lazy"><figcaption>image-20220815101140462</figcaption></figure><p>给<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类的内部类<code>OrderItemVo</code>加<code>static</code>修饰符</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.1.8.png" alt="image-20220815101206887" tabindex="0" loading="lazy"><figcaption>image-20220815101206887</figcaption></figure><h5 id="_2、测试二-1" tabindex="-1"><a class="header-anchor" href="#_2、测试二-1" aria-hidden="true">#</a> 2、测试二</h5><p>重启<code>gulimall-order</code>模块，刷新<code>http://order.gulimall.com/toTrade</code>页面，再次来到了<code>List&lt;OrderConfirmVo.MemberAddressVo&gt; address = memberFeignService.getAddress(memberEntityTo.getId());</code>这个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.1.png" alt="image-20220815101452977" tabindex="0" loading="lazy"><figcaption>image-20220815101452977</figcaption></figure><p>再在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>getUserCartItems</code>方法的第一行上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.2.png" alt="image-20220815101644535" tabindex="0" loading="lazy"><figcaption>image-20220815101644535</figcaption></figure><p>点击<code>GulimallCartApplication</code>服务<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点</p><p>点击两次该按钮，来到<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>getUserCartItems</code>方法的第一行</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.3.png" alt="image-20220815101824076" tabindex="0" loading="lazy"><figcaption>image-20220815101824076</figcaption></figure><p>点击<code>GulimallCartApplication</code>服务的<code>Step Over</code>(步过)按钮，执行完<code>UserInfoTo userInfoTo = CartInterceptor.threadLocal.get();</code>获取用户登录状态的代码，此时<code>userId</code>却为空</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.4.png" alt="image-20220815101931081" tabindex="0" loading="lazy"><figcaption>image-20220815101931081</figcaption></figure><p>但是浏览器访问<code>http://cart.gulimall.com/cart.html</code>页面，可以看到明明是登录状态确获取不到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.5.png" alt="image-20220815102740112" tabindex="0" loading="lazy"><figcaption>image-20220815102740112</figcaption></figure><p>再次点击<code>GulimallCartApplication</code>服务<code>8: Services</code>里的<code>Resume Program F9</code>按钮，准备跳转到下一处断点时就抛异常了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-08-15 10:20:40.489 ERROR 2368 --- [o-30000-exec-10] org.thymeleaf.TemplateEngine             : [THYMELEAF][http-nio-30000-exec-10] Exception processing template &quot;currentUserCartItems&quot;: Error resolving template [currentUserCartItems], template might not exist or might not be accessible by any of the configured Template Resolvers
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.6.png" alt="image-20220815102142268" tabindex="0" loading="lazy"><figcaption>image-20220815102142268</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>preHandle</code>方法的<code>HttpSession session = request.getSession();</code>这一行上打断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.7.png" alt="image-20220815102302578" tabindex="0" loading="lazy"><figcaption>image-20220815102302578</figcaption></figure><p>然后浏览器刷新<code>http://order.gulimall.com/toTrade</code>页面，切换到<code>IDEA</code>，点击2次<code>GulimallCartApplication</code>服务的<code>Step Over</code>(步过)按钮，跳转到<code>preHandle</code>方法的<code>if (userInfoTo == null) {</code>这一行，可以看到此时的member是空的，点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，让这个线程执行完</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.8.png" alt="image-20220815102449595" tabindex="0" loading="lazy"><figcaption>image-20220815102449595</figcaption></figure><p>切换到浏览器，刷新<code>http://cart.gulimall.com/cart.html</code>页面，可以看到请求头的<code>Cookie</code>里有<code>GULIMALL_JSESSIONID</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.9.png" alt="image-20220815102939191" tabindex="0" loading="lazy"><figcaption>image-20220815102939191</figcaption></figure><p>可以看到页面访问时一切是正常的，这些信息都能获取到，然后一直点击<code>Resume Program F9</code>按钮放行完这个请求</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.10.png" alt="image-20220815103121435" tabindex="0" loading="lazy"><figcaption>image-20220815103121435</figcaption></figure><p>页面也是能正常访问的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.1.3.2.11.png" alt="image-20220815103040756" tabindex="0" loading="lazy"><figcaption>image-20220815103040756</figcaption></figure><h3 id="_6-1-2、feign丢失请求头" tabindex="-1"><a class="header-anchor" href="#_6-1-2、feign丢失请求头" aria-hidden="true">#</a> 6.1.2、Feign丢失请求头</h3><h4 id="_1、feign远程调用丢失请求头" tabindex="-1"><a class="header-anchor" href="#_1、feign远程调用丢失请求头" aria-hidden="true">#</a> 1、Feign远程调用丢失请求头</h4><h5 id="_1、源码调试" tabindex="-1"><a class="header-anchor" href="#_1、源码调试" aria-hidden="true">#</a> 1、源码调试</h5><p>打开浏览器，刷新<code>http://order.gulimall.com/toTrade</code>页面</p><p>一直放行到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法的<code>List&lt;OrderConfirmVo.OrderItemVo&gt; items = cartFeignService.getCurrentUserCartItems();</code>这一行，可以看到这个<code>cartFeignService</code>是一个代理对象，step into进来</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.1.png" alt="image-20220815103648180" tabindex="0" loading="lazy"><figcaption>image-20220815103648180</figcaption></figure><p>首先判断是不是<code>equals</code>、<code>hashCode</code>、<code>toString</code>方法，如果不是则执行<code>dispatch.get(method).invoke(args);</code></p><p>点击<code>Step Over</code>直到最后一行</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;equals&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> otherHandler <span class="token operator">=</span>
          args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">getInvocationHandler</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">equals</span><span class="token punctuation">(</span>otherHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;toString&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> dispatch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.2.png" alt="image-20220815103949094" tabindex="0" loading="lazy"><figcaption>image-20220815103949094</figcaption></figure><p>再点击<code>Step Into</code>，选择<code>invoke</code>，一般调用<code>invoke</code>方法就开始准备执行核心方法了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.3.png" alt="image-20220815104251012" tabindex="0" loading="lazy"><figcaption>image-20220815104251012</figcaption></figure><p>没有传参，所以<code>argv</code>为<code>null</code>，先拿到一个克隆的重试器<code>Retryer</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
  <span class="token class-name">RequestTemplate</span> template <span class="token operator">=</span> buildTemplateFromArgs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Retryer</span> retryer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryer<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RetryableException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        retryer<span class="token punctuation">.</span><span class="token function">continueOrPropagate</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RetryableException</span> th<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> th<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propagationPolicy <span class="token operator">==</span> <span class="token constant">UNWRAP</span> <span class="token operator">&amp;&amp;</span> cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> cause<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> th<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">logRetry</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.4.png" alt="image-20220815104425072" tabindex="0" loading="lazy"><figcaption>image-20220815104425072</figcaption></figure><p>运行到这里，<code>executeAndDecode(template);</code>这里才是真正的执行，点击<code>Step Into</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.5.png" alt="image-20220815104643073" tabindex="0" loading="lazy"><figcaption>image-20220815104643073</figcaption></figure><p>先准备一个请求的模板，指定了请求的path</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Object</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
  <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token function">targetRequest</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">logRequest</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Response</span> response<span class="token punctuation">;</span>
  <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">logIOException</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token function">elapsedTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token function">errorExecuting</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.6.png" alt="image-20220815104920247" tabindex="0" loading="lazy"><figcaption>image-20220815104920247</figcaption></figure><p>先得到当前请求<code>Request request = targetRequest(template);</code>，然后利用客户端去执行<code>client.execute(request, options);</code></p><p>在<code>Request request = targetRequest(template);</code>这一行，点击<code>Step Into</code>看怎么得到的请求</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.7.png" alt="image-20220815105446852" tabindex="0" loading="lazy"><figcaption>image-20220815105446852</figcaption></figure><p>feign在远程调用之前要构造请求，拿到所有的request拦截器<code>for(RequestInterceptor interceptor : requestInterceptors)</code>，然后调用各拦截器的<code>apply</code>方法。但是我们这里没有拦截器，所以<code>feign</code>没有什么功能要增强的，所以将原生的<code>RequestTemplate</code>给传递过来，但此时的<code>template</code>的<code>queries</code>（请求参数），<code>headers</code>(请求头)都为<code>0</code>个，问题就出现在这了，参数的确为<code>0</code>。但是请求头里应该有<code>cookie</code>啊，请求头至少也需要有一个<code>cookie</code>啊</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Request</span> <span class="token function">targetRequest</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestInterceptor</span> interceptor <span class="token operator">:</span> requestInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    interceptor<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.8.png" alt="image-20220815110200487" tabindex="0" loading="lazy"><figcaption>image-20220815110200487</figcaption></figure><p>Feign远程调用丢失请求头问题可以用下图描述</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.9.png" alt="image-20220815112127127" tabindex="0" loading="lazy"><figcaption>image-20220815112127127</figcaption></figure><p>解决办法如下图描述</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.1.10.png" alt="image-20220815112057069" tabindex="0" loading="lazy"><figcaption>image-20220815112057069</figcaption></figure><h5 id="_2、查看该拦截器" tabindex="-1"><a class="header-anchor" href="#_2、查看该拦截器" aria-hidden="true">#</a> 2、查看该拦截器</h5><p>由于使用feign进行远程调用时会重新创建一个新的request，所以请求头丢失了，但feign在进行远程调用之前会遍历所有的<code>RequestInterceptor</code>，调用其<code>apply</code>方法，因此我们可以实现<code>feign.RequestInterceptor</code>接口，将<code>cookie</code>添加到该request的请求头中即可</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>

  <span class="token doc-comment comment">/**
   * Called for every request. Add data using methods on the supplied <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RequestTemplate</span></span><span class="token punctuation">}</span>.
   */</span>
  <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.1.png" alt="image-20220815112231555" tabindex="0" loading="lazy"><figcaption>image-20220815112231555</figcaption></figure><p>回到<code>feign.SynchronousMethodHandler</code>类，可以看到<code>SynchronousMethodHandler</code>的构造器里会得到所有的<code>request</code>拦截器，按<code>ctrl</code>点击这个构造器，看看哪个类使用了该构造器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.2.png" alt="image-20220815112624676" tabindex="0" loading="lazy"><figcaption>image-20220815112624676</figcaption></figure><p>可以看到这个<code>feign.SynchronousMethodHandler</code>类的内部类<code>Factory</code>的<code>create</code>方法返回<code>MethodHandler</code>类型，<code>SynchronousMethodHandler</code>类实现了<code>MethodHandler</code>接口（这个<code>MethodHandler</code>也需要<code>requestInterceptors</code>）</p><p><a href="code/6.1.2.2.java">点击查看SynchronousMethodHandler类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.3.png" alt="image-20220815113100186" tabindex="0" loading="lazy"><figcaption>image-20220815113100186</figcaption></figure><p>点击最开始的<code>feign.ReflectiveFeign</code>类继承的<code>Feign</code>类</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.4.png" alt="image-20221230153804613" tabindex="0" loading="lazy"><figcaption>image-20221230153804613</figcaption></figure><p>在<code>Feign</code>抽象类里调用的<code>SynchronousMethodHandler</code>对象的<code>Factory</code>方法的参数中也需要<code>requestInterceptors</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">Feign</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SynchronousMethodHandler<span class="token punctuation">.</span>Factory</span> synchronousMethodHandlerFactory <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">SynchronousMethodHandler<span class="token punctuation">.</span>Factory</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> retryer<span class="token punctuation">,</span> requestInterceptors<span class="token punctuation">,</span> logger<span class="token punctuation">,</span>
            logLevel<span class="token punctuation">,</span> decode404<span class="token punctuation">,</span> closeAfterDecode<span class="token punctuation">,</span> propagationPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ParseHandlersByName</span> handlersByName <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">ParseHandlersByName</span><span class="token punctuation">(</span>contract<span class="token punctuation">,</span> options<span class="token punctuation">,</span> encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> queryMapEncoder<span class="token punctuation">,</span>
            errorDecoder<span class="token punctuation">,</span> synchronousMethodHandlerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveFeign</span><span class="token punctuation">(</span>handlersByName<span class="token punctuation">,</span> invocationHandlerFactory<span class="token punctuation">,</span> queryMapEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.5.png" alt="image-20220815113342137" tabindex="0" loading="lazy"><figcaption>image-20220815113342137</figcaption></figure><p>而这个拦截器默认是空的，相当于什么都没有</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestInterceptor</span><span class="token punctuation">&gt;</span></span> requestInterceptors <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestInterceptor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.6.png" alt="image-20220815113431801" tabindex="0" loading="lazy"><figcaption>image-20220815113431801</figcaption></figure><p>但是容器中只有一个<code>RequestInterceptor</code>，就会将这个<code>requestInterceptor</code>给我们添进来。</p><p>如果容器中有多个，就会清空<code>this.requestInterceptors</code>，然后将这些都添加进<code>this.requestInterceptors</code>里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Adds a single request interceptor to the builder.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token class-name">RequestInterceptor</span> requestInterceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>requestInterceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>requestInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Sets the full set of request interceptors for the builder, overwriting any previous
 * interceptors.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">requestInterceptors</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestInterceptor</span><span class="token punctuation">&gt;</span></span> requestInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>requestInterceptors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestInterceptor</span> requestInterceptor <span class="token operator">:</span> requestInterceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestInterceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>requestInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.2.7.png" alt="image-20220815113625087" tabindex="0" loading="lazy"><figcaption>image-20220815113625087</figcaption></figure><h5 id="_3、添加拦截器" tabindex="-1"><a class="header-anchor" href="#_3、添加拦截器" aria-hidden="true">#</a> 3、添加拦截器</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包里新建<code>GuliFeignConfig</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/15
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GuliFeignConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;requestInterceptor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;feign远程之前先进行RequestInterceptor.apply&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.3.1.png" alt="image-20220815114245481" tabindex="0" loading="lazy"><figcaption>image-20220815114245481</figcaption></figure><p>要想在拦截器里获取之前的<code>request</code>请求，我们可以在<code>Controller</code>里添加<code>HttpServletRequest httpServletRequest</code>参数，然后使用<code>ThreadLocal</code>共享数据，不过<code>Spring</code>团队已经考虑到我们可能需要经常获取这些数据了，已经封装了一个工具类叫<code>RequestContextHolder</code>（可以看到<code>Spring</code>团队也是用的<code>ThreadLocal</code>）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAttributes</span><span class="token punctuation">&gt;</span></span> requestAttributesHolder <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Request attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAttributes</span><span class="token punctuation">&gt;</span></span> inheritableRequestAttributesHolder <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">NamedInheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Request context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.3.2.png" alt="image-20220815114942463" tabindex="0" loading="lazy"><figcaption>image-20220815114942463</figcaption></figure><p><code>ServletRequestAttributes</code>继承了<code>AbstractRequestAttributes</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.3.3.png" alt="image-20220815115338645" tabindex="0" loading="lazy"><figcaption>image-20220815115338645</figcaption></figure><p><code>AbstractRequestAttributes</code>实现了<code>RequestAttributes</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.3.4.png" alt="image-20220815115341469" tabindex="0" loading="lazy"><figcaption>image-20220815115341469</figcaption></figure><h5 id="_4、测试" tabindex="-1"><a class="header-anchor" href="#_4、测试" aria-hidden="true">#</a> 4、测试</h5><p>访问<code>http://order.gulimall.com/toTrade</code>请求时请求头会带上<code>Cookie</code>，不过<code>http://order.gulimall.com/toTrade</code>请求的<code>Cookie</code>好像少了<code>user-key</code>，这里应该有<code>user-key</code>的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.1.png" alt="image-20220815152728942" tabindex="0" loading="lazy"><figcaption>image-20220815152728942</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.GulimallSessionConfig</code>类上添加<code>@EnableRedisHttpSession</code>方法，开启Spring Session</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.2.png" alt="image-20220815153257907" tabindex="0" loading="lazy"><figcaption>image-20220815153257907</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>postHandle</code>方法的<code>cookie.setPath(&quot;gulimall.com&quot;);</code>打上断点，在 http://cart.gulimall.com/cart.html 页面里清空<code>cookie</code>，然后刷新 http://cart.gulimall.com/cart.html 页面。可以发现设置错了，应该设置的是<code>domain</code>，而不是<code>path</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.3.gif" alt="GIF 2022-8-15 15-46-04" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-15 15-46-04</figcaption></figure><p>将<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>postHandle</code>方法里的<code>cookie.setPath(&quot;gulimall.com&quot;);</code>修改为<code>cookie.setDomain(&quot;gulimall.com&quot;);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 业务执行完后，如果当前用户的cookies里没有user-key为键的cookie，就存放该cookie
 *
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@param</span> <span class="token parameter">response</span>
 * <span class="token keyword">@param</span> <span class="token parameter">handler</span>
 * <span class="token keyword">@param</span> <span class="token parameter">modelAndView</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfoTo<span class="token punctuation">.</span><span class="token function">isHasTempUserCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_NAME</span><span class="token punctuation">,</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token class-name">CartConstant</span><span class="token punctuation">.</span><span class="token constant">TEMP_USER_COOKIE_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//删除ThreadLocal，防止线程复用，获取到别的用户信息</span>
    threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.4.png" alt="image-20220815154910128" tabindex="0" loading="lazy"><figcaption>image-20220815154910128</figcaption></figure><p>在 http://cart.gulimall.com/cart.html 页面里清空<code>cookie</code>，然后刷新 http://cart.gulimall.com/cart.html 页面。这次就可以发现<code>domain</code>已经设置上去了。放行该请求后，切换到 http://cart.gulimall.com/cart.html 页面，打开控制台，此时名为<code>user-key</code>的<code>cookie</code>的作用范围已经变为<code>.gulimall.com</code>(本域名及其子域名)了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.5.gif" alt="GIF 2022-8-15 15-50-27" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-15 15-50-27</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.GuliFeignConfig</code>类的<code>requestInterceptor</code>方法，将<code>http://order.gulimall.com/toTrade</code>请求的请求头里的<code>Cookie</code>复制给为远程调用而构造的新请求，在<code>ServletRequestAttributes attributes = (ServletRequestAttributes) requestAttributes;</code>上打断点</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;requestInterceptor&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//拿到刚进来的这个请求(/toTrade)</span>
            <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ServletRequestAttributes extends AbstractRequestAttributes</span>
            <span class="token comment">//AbstractRequestAttributes implements RequestAttributes</span>
            <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> requestAttributes<span class="token punctuation">;</span>
            <span class="token comment">//原本的 /toTrade 请求</span>
            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//同步请求头数据，主要是Cookie</span>
            <span class="token class-name">String</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//为远程调用而构造的新请求</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">,</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//template.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.6.png" alt="image-20220815152016121" tabindex="0" loading="lazy"><figcaption>image-20220815152016121</figcaption></figure><p>重新以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务和<code>GulimallCartApplication</code>服务</p><p>重新发送<code>http://order.gulimall.com/toTrade</code>请求，就来到这<code>List&lt;OrderConfirmVo.MemberAddressVo&gt; address = memberFeignService.getAddress(memberEntityTo.getId());</code>，点击<code>Step Over F8</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.7.png" alt="image-20220815152209316" tabindex="0" loading="lazy"><figcaption>image-20220815152209316</figcaption></figure><p>可以看到在<code>gulimall-order</code>模块配置的<code>com.atguigu.gulimall.order.config.GuliFeignConfig</code>拦截器就起作用了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.8.png" alt="image-20220815152346370" tabindex="0" loading="lazy"><figcaption>image-20220815152346370</figcaption></figure><p>切换到浏览器的 http://cart.gulimall.com/cart.html 页面，可以看到此时带的cookie有<code>user-key</code>和<code>GULIMALL_JSESSIONID</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.9.png" alt="image-20220815155214210" tabindex="0" loading="lazy"><figcaption>image-20220815155214210</figcaption></figure><p>点击<code>GulimallOrderApplication</code>服务的<code>Step Over</code>(步过)按钮，直到执行到<code>template.header(&quot;Cookie&quot;,cookie);</code>这一行，查看<code>cookie</code>可以看到<code>user-key</code>和<code>GULIMALL_JSESSIONID</code>都获取到了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>user-key=1ae1d57c-cdde-4748-9ed8-384132ae47a9; GULIMALL_JSESSIONID=YjA2MGY4YjYtMTcwNi00MzdmLTg1MzItMzM0ZjRlMjBmNmRk
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.10.png" alt="image-20220815155307078" tabindex="0" loading="lazy"><figcaption>image-20220815155307078</figcaption></figure><p>再次点三次<code>Step Over F8</code>步过)按钮，此时就有请求头了，然后点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.11.png" alt="image-20220815155513360" tabindex="0" loading="lazy"><figcaption>image-20220815155513360</figcaption></figure><p>此时就来到了<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法的<code>List&lt;OrderConfirmVo.OrderItemVo&gt; items = cartFeignService.getCurrentUserCartItems();</code>这，点击<code>8: Services</code>里的<code>Resume Program F9</code>按钮，跳转到下一处断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.12.png" alt="image-20220815155959475" tabindex="0" loading="lazy"><figcaption>image-20220815155959475</figcaption></figure><p>此时就来到了<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>preHandle</code>方法的<code>MemberEntityTo member = (MemberEntityTo) session.getAttribute(AuthServerConstant.LOGIN_USER);</code>这，点击<code>Step Over F8</code> (步过)按钮，此时<code>member</code>就不为<code>null</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.1.4.13.png" alt="image-20220815160153828" tabindex="0" loading="lazy"><figcaption>image-20220815160153828</figcaption></figure><h4 id="_2、修改confirmorder方法" tabindex="-1"><a class="header-anchor" href="#_2、修改confirmorder方法" aria-hidden="true">#</a> 2、修改<code>confirmOrder</code>方法</h4><h5 id="_1、修改代码" tabindex="-1"><a class="header-anchor" href="#_1、修改代码" aria-hidden="true">#</a> 1、修改代码</h5><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> getAddressFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、远程查询所有的收货地址列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>MemberAddressVo</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderConfirmVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> cartFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、远程查询购物车所有选中的购物项</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderConfirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、查询用户积分</span>
    <span class="token class-name">Integer</span> integration <span class="token operator">=</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//orderConfirmVo.setIntegration(orderConfirmVo.getIntegration());</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 防重令牌</span>

    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>getAddressFuture<span class="token punctuation">,</span>cartFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.1.1.png" alt="image-20220815161330527" tabindex="0" loading="lazy"><figcaption>image-20220815161330527</figcaption></figure><p><code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法上声明抛出异常，<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.OrderWebController</code>类的<code>toTrade</code>方法上声明抛出异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.1.2.gif" alt="GIF 2022-8-15 16-13-55" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-15 16-13-55</figcaption></figure><h5 id="_2、测试-4" tabindex="-1"><a class="header-anchor" href="#_2、测试-4" aria-hidden="true">#</a> 2、测试</h5><p>在<code>GulimallOrderApplication</code>服务里，点击<code>View Breakpoints... Ctrl+ Shift+F8</code>取消所有断点(当然默认的<code>Java Exception Breakpoints</code>和<code>JavaScript Exception Breakpoints</code>不用管)</p><p>然后在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法的<code>CompletableFuture.allOf(getAddressFuture,cartFuture).get();</code>这一行打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.1.png" alt="image-20220815161955420" tabindex="0" loading="lazy"><figcaption>image-20220815161955420</figcaption></figure><p>在<code>GulimallCartApplication</code>服务里，点击<code>View Breakpoints... Ctrl+ Shift+F8</code>取消所有断点(当然默认的<code>Java Exception Breakpoints</code>和<code>JavaScript Exception Breakpoints</code>不用管)</p><p>然后在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.interceptor.CartInterceptor</code>类的<code>preHandle</code>方法的<code>HttpSession session = request.getSession();</code>这一行打个断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.2.png" alt="image-20220815162259671" tabindex="0" loading="lazy"><figcaption>image-20220815162259671</figcaption></figure><p>重新以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务和<code>GulimallCartApplication</code>服务</p><p>重新发送<code>http://order.gulimall.com/toTrade</code>请求，就来到了这，点击<code>Resume Program F9</code>跳到下一处断点，此时<code>GulimallOrderApplication</code>服务执行完了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.3.png" alt="image-20220815162708166" tabindex="0" loading="lazy"><figcaption>image-20220815162708166</figcaption></figure><p>然后点击<code>GulimallCartApplication</code>服务，来到了空指针异常类，再点击<code>Resume Program F9</code>跳到下一处断点，此时<code>GulimallCartApplication</code>服务执行完了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.4.png" alt="image-20220815162855683" tabindex="0" loading="lazy"><figcaption>image-20220815162855683</figcaption></figure><p>再点击<code>GulimallOrderApplication</code>服务，此时就报了空指针异常</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java.lang.NullPointerException: null
	at com.atguigu.gulimall.order.config.GuliFeignConfig$1.apply(GuliFeignConfig.java:32) ~[classes/:na]
	at feign.SynchronousMethodHandler.targetRequest(SynchronousMethodHandler.java:169) ~[feign-core-10.2.3.jar:na]
	at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:99) ~[feign-core-10.2.3.jar:na]
	at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:78) ~[feign-core-10.2.3.jar:na]
	at feign.ReflectiveFeign$FeignInvocationHandler.invoke(ReflectiveFeign.java:103) ~[feign-core-10.2.3.jar:na]
	at com.sun.proxy.$Proxy100.getAddress(Unknown Source) ~[na:na]
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.lambda$confirmOrder$0(OrderServiceImpl.java:53) ~[classes/:na]
	at java.util.concurrent.CompletableFuture$AsyncRun.run$$$capture(CompletableFuture.java:1640) ~[na:1.8.0_301]
	at java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java) ~[na:1.8.0_301]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_301]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[na:1.8.0_301]
	at java.lang.Thread.run(Thread.java:748) [na:1.8.0_301]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在<code>HttpServletRequest request = attributes.getRequest();</code>这一行打个断点，看看怎么报的空指针异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.5.png" alt="image-20220815163233436" tabindex="0" loading="lazy"><figcaption>image-20220815163233436</figcaption></figure><p>重新发送<code>http://order.gulimall.com/toTrade</code>请求（不用重启服务），点击<code>Resume Program F9</code>跳到下一处断点</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.6.png" alt="image-20220815163741196" tabindex="0" loading="lazy"><figcaption>image-20220815163741196</figcaption></figure><p>此时就来到了<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.GuliFeignConfig</code>类的<code>apply</code>方法的<code>HttpServletRequest request = attributes.getRequest();</code>这一行，可以看到<code>attributes</code>的值为<code>null</code>，所以就报空指针了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.7.png" alt="image-20220815163903019" tabindex="0" loading="lazy"><figcaption>image-20220815163903019</figcaption></figure><p>点击<code>Debugger</code>的<code>Frames</code>里的当前<code>GuliFeignConfig</code>类的下面那个类，可以看到是<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法的<code>List&lt;OrderConfirmVo.OrderItemVo&gt; items = cartFeignService.getCurrentUserCartItems();</code>这一行调用的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.2.2.8.png" alt="image-20220815164015783" tabindex="0" loading="lazy"><figcaption>image-20220815164015783</figcaption></figure><h4 id="_3、feign异步情况丢失上下文问题" tabindex="-1"><a class="header-anchor" href="#_3、feign异步情况丢失上下文问题" aria-hidden="true">#</a> 3、Feign异步情况丢失上下文问题</h4><h5 id="_1、原因" tabindex="-1"><a class="header-anchor" href="#_1、原因" aria-hidden="true">#</a> 1、原因</h5><p>没使用异步之前，所有执行都使用的是同一个<code>thread</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.1.png" alt="image-20220815165210874" tabindex="0" loading="lazy"><figcaption>image-20220815165210874</figcaption></figure><p>而开启异步后，查<code>address</code>和<code>cart</code>又开了不同的线程，新开的线程的<code>ThreadLocal</code>里肯定没有<code>cookie</code></p><h5 id="_2、测试-5" tabindex="-1"><a class="header-anchor" href="#_2、测试-5" aria-hidden="true">#</a> 2、测试</h5><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.GuliFeignConfig</code>类的<code>requestInterceptor</code>方法，在<code>HttpServletRequest request = attributes.getRequest();</code>方法之前输出当前线程，并注释掉输出当前线程之后的代码，避免报错</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;requestInterceptor&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//拿到刚进来的这个请求(/toTrade)</span>
            <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ServletRequestAttributes extends AbstractRequestAttributes</span>
            <span class="token comment">//AbstractRequestAttributes implements RequestAttributes</span>
            <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> requestAttributes<span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RequestInterceptor线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">////原本的 /toTrade 请求</span>
            <span class="token comment">//HttpServletRequest request = attributes.getRequest();</span>
            <span class="token comment">////同步请求头数据，主要是Cookie</span>
            <span class="token comment">//String cookie = request.getHeader(&quot;Cookie&quot;);</span>
            <span class="token comment">////为远程调用而构造的新请求</span>
            <span class="token comment">//template.header(&quot;Cookie&quot;,cookie);</span>
            <span class="token comment">////template.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.2.1.png" alt="image-20220815165635579" tabindex="0" loading="lazy"><figcaption>image-20220815165635579</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法里，在开启异步之前，开启异步之后，都输出当前线程的id</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> getAddressFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、远程查询所有的收货地址列表</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getAddressFuture线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>MemberAddressVo</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderConfirmVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> cartFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、远程查询购物车所有选中的购物项</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cartFuture线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderConfirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、查询用户积分</span>
    <span class="token class-name">Integer</span> integration <span class="token operator">=</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//orderConfirmVo.setIntegration(orderConfirmVo.getIntegration());</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 防重令牌</span>

    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>getAddressFuture<span class="token punctuation">,</span>cartFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.2.2.png" alt="image-20220815165915349" tabindex="0" loading="lazy"><figcaption>image-20220815165915349</figcaption></figure><p>取消所有<code>GulimallOrderApplication</code>服务的断点，以<code>debug</code>方式启动<code>GulimallOrderApplication</code>服务</p><p>重新发送<code>http://order.gulimall.com/toTrade</code>请求，可以看到开启异步后线程id变了，故线程变了，所以获取不到<code>ThreadLocal</code>本地线程数据了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>主线程：69
getAddressFuture线程：110
cartFuture线程：111
RequestInterceptor线程：111
RequestInterceptor线程：110
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.2.3.png" alt="image-20220815170226054" tabindex="0" loading="lazy"><figcaption>image-20220815170226054</figcaption></figure><p>图解大概是这个样子：订单服务开了两个异步任务来获取收货地址和购物车数据，由于用户的数据保存在<code>ThreadLocal</code>本地线程中，当线程改变后，就获取不到原来线程的<code>ThreadLocal</code>数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.2.4.png" alt="image-20220815170419254" tabindex="0" loading="lazy"><figcaption>image-20220815170419254</figcaption></figure><h5 id="_3、修改代码" tabindex="-1"><a class="header-anchor" href="#_3、修改代码" aria-hidden="true">#</a> 3、修改代码</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.GuliFeignConfig</code>类的<code>requestInterceptor</code>方法的<code>attributes.getRequest()</code>之前加一个判断，并在<code>ServletRequestAttributes attributes = (ServletRequestAttributes) requestAttributes;</code>上打个断点</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;requestInterceptor&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//拿到刚进来的这个请求(/toTrade)</span>
            <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ServletRequestAttributes extends AbstractRequestAttributes</span>
            <span class="token comment">//AbstractRequestAttributes implements RequestAttributes</span>
            <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> requestAttributes<span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RequestInterceptor线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//原本的 /toTrade 请求</span>
                <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//同步请求头数据，主要是Cookie</span>
                <span class="token class-name">String</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//为远程调用而构造的新请求</span>
                template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">,</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//template.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.3.1.png" alt="image-20220815171354969" tabindex="0" loading="lazy"><figcaption>image-20220815171354969</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>confirmOrder</code>方法里，先获取主线程<code>RequestAttributes</code>数据，然后将开启异步后的线程也设上<code>RequestAttributes</code>数据，这样新开的线程就有原来线程的数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.3.2.png" alt="image-20220815170739591" tabindex="0" loading="lazy"><figcaption>image-20220815170739591</figcaption></figure><p>虽然用的<code>RequestContextHolder</code>从头到尾都一样，但封装数据用的是<code>ThreadLocal</code>，只要线程不一样，<code>ThreadLocal</code>里的数据就不一样(但是新开的线程是复用的，设置完数据后没有清除，有可能给别的用户用了)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.3.3.png" alt="image-20220815170950030" tabindex="0" loading="lazy"><figcaption>image-20220815170950030</figcaption></figure><h5 id="_4、重新测试" tabindex="-1"><a class="header-anchor" href="#_4、重新测试" aria-hidden="true">#</a> 4、重新测试</h5><p>重启<code>GulimallOrderApplication</code>服务，发送<code>http://order.gulimall.com/toTrade</code>请求</p><p>此时<code>attributes</code>就不为<code>null</code>了，也能正确获得<code>cookie</code>的值了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.3.4.png" alt="image-20220815172234132" tabindex="0" loading="lazy"><figcaption>image-20220815172234132</figcaption></figure><h4 id="_4、编解码异常" tabindex="-1"><a class="header-anchor" href="#_4、编解码异常" aria-hidden="true">#</a> 4、编解码异常</h4><h5 id="_1、查看异常" tabindex="-1"><a class="header-anchor" href="#_1、查看异常" aria-hidden="true">#</a> 1、查看异常</h5><p>老师<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.feign.ProductFeignService</code>接口的<code>getPrice</code>方法这里出现了编解码异常</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.1.1.png" alt="image-20220815172354244" tabindex="0" loading="lazy"><figcaption>image-20220815172354244</figcaption></figure><p>而我并没有（还是改一下吧，不过下面的176行的那个<code>return null;</code>要改为<code>return collect;</code>，后面会改的）</p><p>老师出现的异常可能是直接返回的<code>BigDecimal</code>类型的数据出现了问题，而我的正确编码了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.1.2.png" alt="image-20220815172228974" tabindex="0" loading="lazy"><figcaption>image-20220815172228974</figcaption></figure><h5 id="_2、修改代码" tabindex="-1"><a class="header-anchor" href="#_2、修改代码" aria-hidden="true">#</a> 2、修改代码</h5><p>修改<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.SkuInfoController</code>类的<code>getPrice</code>方法，让其返回<code>R</code>对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 实时查询商品价格
 * <span class="token keyword">@param</span> <span class="token parameter">skuId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{skuId}/price&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SkuInfoEntity</span> skuInfoEntity <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.2.1.png" alt="image-20220815190703058" tabindex="0" loading="lazy"><figcaption>image-20220815190703058</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.feign.ProductFeignService</code>接口的<code>getPrice</code>方法的返回类型</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/skuinfo/{skuId}/price&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.2.2.png" alt="image-20220815172829558" tabindex="0" loading="lazy"><figcaption>image-20220815172829558</figcaption></figure><p>修改<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.service.impl.CartServiceImpl</code>类的<code>getUserCartItems</code>方法，让其接收<code>R</code>对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">.</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoTo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> cartKey <span class="token operator">=</span> <span class="token constant">CART_PREFIX</span> <span class="token operator">+</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> cartItems <span class="token operator">=</span> <span class="token function">getCartItems</span><span class="token punctuation">(</span>cartKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cartItems<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取所有被选中的购物项</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> cartItems<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">CartItemVo</span><span class="token operator">::</span><span class="token function">getCheck</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                        <span class="token comment">//获取商品最新价格</span>
                        <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> price <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> item<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> collect<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.2.3.png" alt="image-20220815200706017" tabindex="0" loading="lazy"><figcaption>image-20220815200706017</figcaption></figure><h5 id="_3、测试-1" tabindex="-1"><a class="header-anchor" href="#_3、测试-1" aria-hidden="true">#</a> 3、测试</h5><p>重启<code>GulimallCartApplication</code>服务和<code>GulimallOrderApplication</code>服务，访问 http://order.gulimall.com/toTrade 页面报了如下错误，告诉我们执行<code>CartFeignService#getCurrentUserCartItems()</code>方法报错了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Whitelabel Error Page
This application has no explicit mapping <span class="token keyword">for</span> /error, so you are seeing this as a fallback.

Mon Aug <span class="token number">15</span> <span class="token number">19</span>:28:25 CST <span class="token number">2022</span>
There was an unexpected error <span class="token punctuation">(</span>type<span class="token operator">=</span>Internal Server Error, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>.
feign.FeignException<span class="token variable">$InternalServerError</span><span class="token builtin class-name">:</span> status <span class="token number">500</span> reading CartFeignService<span class="token comment">#getCurrentUserCartItems()</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.3.1.png" alt="image-20220815190953627" tabindex="0" loading="lazy"><figcaption>image-20220815190953627</figcaption></figure><p>查看<code>GulimallCartApplication</code>服务的控制台，出现了<code>thymeleaf</code>的问题，但<code>getCurrentUserCartItems</code>方法根本就没返回页面</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-15 <span class="token number">19</span>:27:50.266 ERROR <span class="token number">6972</span> --- <span class="token punctuation">[</span>o-30000-exec-10<span class="token punctuation">]</span> org.thymeleaf.TemplateEngine             <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>THYMELEAF<span class="token punctuation">]</span><span class="token punctuation">[</span>http-nio-30000-exec-10<span class="token punctuation">]</span> Exception processing template <span class="token string">&quot;currentUserCartItems&quot;</span><span class="token builtin class-name">:</span> Error resolving template <span class="token punctuation">[</span>currentUserCartItems<span class="token punctuation">]</span>, template might not exist or might not be accessible by any of the configured Template Resolvers

org.thymeleaf.exceptions.TemplateInputException: Error resolving template <span class="token punctuation">[</span>currentUserCartItems<span class="token punctuation">]</span>, template might not exist or might not be accessible by any of the configured Template Resolvers
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.3.2.png" alt="image-20220815192957537" tabindex="0" loading="lazy"><figcaption>image-20220815192957537</figcaption></figure><p>在<code>gulimall-cart</code>模块的<code>com.atguigu.gulimall.cart.controller.CartController</code>类里修改<code>getCurrentUserCartItems</code>方法，在该方法上加上<code>@ResponseBody</code>注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/currentUserCartItems&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> cartService<span class="token punctuation">.</span><span class="token function">getUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.3.3.png" alt="image-20220815193244430" tabindex="0" loading="lazy"><figcaption>image-20220815193244430</figcaption></figure><p>重启<code>GulimallCartApplication</code>服务，刷新<code>http://order.gulimall.com/toTrade</code>页面，此时就可以看到页面了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.2.4.3.4.png" alt="image-20220815193408786" tabindex="0" loading="lazy"><figcaption>image-20220815193408786</figcaption></figure><h3 id="_6-1-3、完善结算页" tabindex="-1"><a class="header-anchor" href="#_6-1-3、完善结算页" aria-hidden="true">#</a> 6.1.3、完善结算页</h3><h4 id="_1、修改结算页面" tabindex="-1"><a class="header-anchor" href="#_1、修改结算页面" aria-hidden="true">#</a> 1、修改结算页面</h4><h5 id="_1、修改收货人信息" tabindex="-1"><a class="header-anchor" href="#_1、修改收货人信息" aria-hidden="true">#</a> 1、修改收货人信息</h5><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>收货人信息</code>位置，复制<code>收货人信息</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.1.1.png" alt="image-20220815193754771" tabindex="0" loading="lazy"><figcaption>image-20220815193754771</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>收货人信息</code>，将收货人信息修改为动态获取的信息，然后点击<code>Build</code> -&gt; <code>Recompile &#39;confirm.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>section<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--收货人信息--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>收货人信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>新增收货地址<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

   <span class="token comment">&lt;!--地址--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top-3<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addr: ${orderConfirmData.address}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;p&gt;家里&lt;/p&gt;&lt;span&gt;齐天大圣  北京市  昌平区城区晨曦小区-16号楼 吉利大学  150****2245&lt;/span&gt;--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>[[${addr.name}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>[[${addr.name}]] [[${addr.province}]]  [[${addr.detailAddress}]] 吉利大学  [[${addr.phone}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>更多地址︾<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hh1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.1.2.png" alt="image-20220815194259282" tabindex="0" loading="lazy"><figcaption>image-20220815194259282</figcaption></figure><p>修改<code>gulimall_ums</code>数据库的<code>ums_member_receive_address</code>表的<code>member_id</code>为<code>7</code>的那个元组的属性，修改其<code>province</code>属性为<code>上海市</code>、<code>detail_address</code>属性为<code>上海市松江区大厦6层</code>、<code>default_status</code>属性为<code>1</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.1.3.png" alt="image-20220815194515585" tabindex="0" loading="lazy"><figcaption>image-20220815194515585</figcaption></figure><p>刷新 http://order.gulimall.com/toTrade 页面，这样就显示用户的收货地址信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.1.4.png" alt="image-20220815194545580" tabindex="0" loading="lazy"><figcaption>image-20220815194545580</figcaption></figure><h5 id="_2、删除自提点信息" tabindex="-1"><a class="header-anchor" href="#_2、删除自提点信息" aria-hidden="true">#</a> 2、删除自提点信息</h5><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>北京市昌平区</code>位置，复制<code>北京市昌平区</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.2.1.png" alt="image-20220815194808760" tabindex="0" loading="lazy"><figcaption>image-20220815194808760</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>北京市昌平区</code>，注释掉这部分代码，然后点击<code>Build</code> -&gt; <code>Recompile &#39;confirm.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.2.2.png" alt="image-20220815194757094" tabindex="0" loading="lazy"><figcaption>image-20220815194757094</figcaption></figure><h5 id="_3、修改商品项信息" tabindex="-1"><a class="header-anchor" href="#_3、修改商品项信息" aria-hidden="true">#</a> 3、修改商品项信息</h5><p>刷新 http://order.gulimall.com/toTrade 页面就没有刚才那一行信息了，再打开控制台，定位到<code>小米手环2</code>的那个购物项，复制<code>商家：谷粒学院自营</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.3.1.png" alt="image-20220815195015257" tabindex="0" loading="lazy"><figcaption>image-20220815195015257</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>商家：谷粒学院自营</code>，将里面的商品项修改为动态的数据</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>to_right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h5</span><span class="token punctuation">&gt;</span></span>商家：谷粒学院自营<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h5</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>换购<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>已购满20.00元，再加49.90元，可返回购物车领取赠品<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--图片--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yun1<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item : ${orderConfirmData.items}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${item.image}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yun<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>[[${item.title}]] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span> ￥ [[${#numbers.formatDecimal(item.price,1,2)}]]  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span> x[[${item.count}]] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>[[${item.hasStock?&#39;有货&#39;:&#39;无货&#39;}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>0.095kg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tui-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/static/order/confirm/img/i_07.png<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>支持7天无理由退货<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hh1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>退换无忧 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>money<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>￥ 0.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.3.2.png" alt="image-20220815203229687" tabindex="0" loading="lazy"><figcaption>image-20220815203229687</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类的<code>OrderItemVo</code>内部类，添加是否有货字段和货物重量字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * //TODO 查询库存状态
 * 是否有货
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> hasStock<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 货物重量
 */</span>
<span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> weight<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.3.3.png" alt="image-20220815201633991" tabindex="0" loading="lazy"><figcaption>image-20220815201633991</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，刷新 http://order.gulimall.com/toTrade 页面，这样就动态显示购物项数据了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.3.4.png" alt="image-20220815203224222" tabindex="0" loading="lazy"><figcaption>image-20220815203224222</figcaption></figure><h5 id="_4、修改结算信息" tabindex="-1"><a class="header-anchor" href="#_4、修改结算信息" aria-hidden="true">#</a> 4、修改结算信息</h5><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>1 件商品，总商品金额：</code>位置，复制<code>件商品，总商品金额：</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.4.1.png" alt="image-20220815201937141" tabindex="0" loading="lazy"><figcaption>image-20220815201937141</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>件商品，总商品金额：</code>，将这些结算信息修改为动态的数据</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xia<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian_y<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>[[${orderConfirmData.count}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>件商品，总商品金额：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rmb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>￥[[${#numbers.formatDecimal(orderConfirmData.total,1,2)}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian_y<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>返现：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rmb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  -￥0.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian_y<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>运费： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rmb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> &amp;nbsp ￥0.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian_y<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>服务费： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rmb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> &amp;nbsp ￥0.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian_y<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>退换无忧： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rmb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> &amp;nbsp ￥0.00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yfze<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yfze_a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>z<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>应付总额：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hq<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>￥[[${#numbers.formatDecimal(orderConfirmData.payPrice,1,2)}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;p class=&quot;yfze_b&quot;&gt;寄送至： 北京 朝阳区 三环到四环之间 朝阳北路复兴国际大厦23层麦田房产 IT-中心研发二部 收货人：赵存权 188****5052&lt;/p&gt;--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yfze_b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>寄送至： xxx 收货人：xxx 188****5052<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tijiao<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>提交订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.4.2.png" alt="image-20220815204044953" tabindex="0" loading="lazy"><figcaption>image-20220815204044953</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类里添加<code>getCount</code>方法，页面直接写<code>${orderConfirmData.count}</code>就会调用<code>orderConfirmData</code>对象的<code>getCount</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">+=</span>item<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.4.3.png" alt="image-20220815202240893" tabindex="0" loading="lazy"><figcaption>image-20220815202240893</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，刷新 http://order.gulimall.com/toTrade 页面，这样就动态显示结算信息了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.4.4.png" alt="image-20220815204126564" tabindex="0" loading="lazy"><figcaption>image-20220815204126564</figcaption></figure><h5 id="_5、完善收货人信息" tabindex="-1"><a class="header-anchor" href="#_5、完善收货人信息" aria-hidden="true">#</a> 5、完善收货人信息</h5><p>在<code>gulimall_ums</code>数据库的<code>ums_member_receive_address</code>表里，再添加一条<code>member_id</code>为<code>7</code>的数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.5.1.png" alt="image-20220815204254248" tabindex="0" loading="lazy"><figcaption>image-20220815204254248</figcaption></figure><p>刷新 http://order.gulimall.com/toTrade 页面，可以看到这两个收货地址的<code>name</code>都有红框，并且都有<code>吉林大学</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.5.2.png" alt="image-20220815204335364" tabindex="0" loading="lazy"><figcaption>image-20220815204335364</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>吉利大学</code>，删掉这里的<code>吉利大学</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.5.3.png" alt="image-20220815204513934" tabindex="0" loading="lazy"><figcaption>image-20220815204513934</figcaption></figure><p>刷新 http://order.gulimall.com/toTrade 页面，可以看到这两个收货地址的<code>name</code>都有红框，但是没有<code>吉林大学</code>了，红框后面会解决的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.1.5.4.png" alt="image-20220815204537985" tabindex="0" loading="lazy"><figcaption>image-20220815204537985</figcaption></figure><h4 id="_2、批量查有货无货状态" tabindex="-1"><a class="header-anchor" href="#_2、批量查有货无货状态" aria-hidden="true">#</a> 2、批量查有货无货状态</h4><h5 id="_1、修改字段" tabindex="-1"><a class="header-anchor" href="#_1、修改字段" aria-hidden="true">#</a> 1、修改字段</h5><p>去掉<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类的<code>OrderItemVo</code>内部类的<code>private boolean hasStock;</code>字段</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>private boolean hasStock;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.1.1.png" alt="image-20220815204853511" tabindex="0" loading="lazy"><figcaption>image-20220815204853511</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.OrderConfirmVo</code>类里，添加<code>stocks</code>字段，用于判断是否有库存</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 是否有库存
 * Long：skuId
 * Boolean：是否有库存
 */</span>
<span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> stocks<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.1.2.png" alt="image-20220815211949704" tabindex="0" loading="lazy"><figcaption>image-20220815211949704</figcaption></figure><h5 id="_2、添加方法" tabindex="-1"><a class="header-anchor" href="#_2、添加方法" aria-hidden="true">#</a> 2、添加方法</h5><p><code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类里已经有了一个<code>getSkuHasStock</code>批量查库存方法了，直接调用就好了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.2.1.png" alt="image-20230103105912504" tabindex="0" loading="lazy"><figcaption>image-20230103105912504</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign</code>包里添加<code>WmsFeignService</code>接口，再里面远程调用<code>gulimall-ware</code>模块，用于查库存</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span></span><span class="token class-name">SkuHasStockTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">RS</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/15
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-ware&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WmsFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/waresku/hasStock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuHasStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.2.2.png" alt="image-20220815210934956" tabindex="0" loading="lazy"><figcaption>image-20220815210934956</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里修改<code>confirmOrder</code>方法，用于获取库存信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">WmsFeignService</span> wmsFeignService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取之前的请求</span>
    <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> getAddressFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、远程查询所有的收货地址列表</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getAddressFuture线程：&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//每一个线程都来共享之前的请求数据</span>
        <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>MemberAddressVo</span><span class="token punctuation">&gt;</span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderConfirmVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> cartFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//2、远程查询购物车所有选中的购物项</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cartFuture线程：&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//每一个线程都来共享之前的请求数据</span>
        <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentUserCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderConfirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenRunAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> orderConfirmVo<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">OrderConfirmVo<span class="token punctuation">.</span>OrderItemVo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">RS</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> skuHasStock <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockTo</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> stocks <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockTo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> <span class="token class-name">SkuHasStockTo</span><span class="token operator">::</span><span class="token function">getHasStock</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderConfirmVo<span class="token punctuation">.</span><span class="token function">setStocks</span><span class="token punctuation">(</span>stocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、查询用户积分</span>
    <span class="token class-name">Integer</span> integration <span class="token operator">=</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//orderConfirmVo.setIntegration(orderConfirmVo.getIntegration());</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 防重令牌</span>

    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>getAddressFuture<span class="token punctuation">,</span>cartFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.2.3.png" alt="image-20220815212236535" tabindex="0" loading="lazy"><figcaption>image-20220815212236535</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里，将<code>&lt;span&gt;[[${item.hasStock?&#39;有货&#39;:&#39;无货&#39;}]]&lt;/span&gt;</code>修改为<code>&lt;span&gt;[[${orderConfirmData.stocks[item.skuId]?&#39;有货&#39;:&#39;无货&#39;}]]&lt;/span&gt;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.2.4.png" alt="image-20220815213044944" tabindex="0" loading="lazy"><figcaption>image-20220815213044944</figcaption></figure><h5 id="_3、测试-2" tabindex="-1"><a class="header-anchor" href="#_3、测试-2" aria-hidden="true">#</a> 3、测试</h5><p>重启<code>GulimallOrderApplication</code>服务，启动<code>GulimallWareApplication</code>服务，此时购物项就显示<code>有货</code>、<code>无货</code>状态了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.2.3.png" alt="image-20220815213111386" tabindex="0" loading="lazy"><figcaption>image-20220815213111386</figcaption></figure><h4 id="_3、默认地址显示红色边框" tabindex="-1"><a class="header-anchor" href="#_3、默认地址显示红色边框" aria-hidden="true">#</a> 3、默认地址显示红色边框</h4><h5 id="_1、显示默认地址边框" tabindex="-1"><a class="header-anchor" href="#_1、显示默认地址边框" aria-hidden="true">#</a> 1、显示默认地址边框</h5><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>收货人信息</code>里的某个收货人的位置，复制<code>top-3</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.1.1.png" alt="image-20220816090304578" tabindex="0" loading="lazy"><figcaption>image-20220816090304578</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>top-3</code>，给<code>地址</code>所在的<code>&lt;div&gt;</code>再加一个<code>class</code>为<code>addr-item</code>，给收货人的<code>&lt;p&gt;</code>标签加一个自定义属性<code>th:attr=&quot;def=${addr.defaultStatus}&quot;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token comment">&lt;!--地址--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>top-3 addr-item<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addr: ${orderConfirmData.address}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--&lt;p&gt;家里&lt;/p&gt;&lt;span&gt;齐天大圣  北京市  昌平区城区晨曦小区-16号楼 吉利大学  150****2245&lt;/span&gt;--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">th:</span>attr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>def=${addr.defaultStatus}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>[[${addr.name}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>[[${addr.name}]] [[${addr.province}]]  [[${addr.detailAddress}]]  [[${addr.phone}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.1.2.png" alt="image-20220816090528912" tabindex="0" loading="lazy"><figcaption>image-20220816090528912</figcaption></figure><p>在<code>gulimall_ums</code>数据库的<code>ums_member_receive_address</code>表里，给<code>member_id</code>为<code>7</code>的第二个元组(这里指的是<code>id</code>为<code>2</code>元组)的<code>default_status</code>设置为<code>0</code>，表示不是默认地址</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.1.3.png" alt="image-20220816090836290" tabindex="0" loading="lazy"><figcaption>image-20220816090836290</figcaption></figure><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，可以看到默认地址的姓名所在的<code>&lt;p&gt;</code>标签的自定义<code>def</code>属性值为<code>1</code>，不是默认地址的姓名所在的<code>&lt;p&gt;</code>标签的自定义<code>def</code>属性值为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.1.4.png" alt="image-20220816090959775" tabindex="0" loading="lazy"><figcaption>image-20220816090959775</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里添加<code>highlight</code>方法，并在<code>$(document).ready()</code>方法(页面初始化方法)里调用该方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">highlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//让收货地址的姓名所在的边框置灰</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;border&quot;</span><span class="token operator">:</span><span class="token string">&quot;2px solid gray&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p[def=&#39;1&#39;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">&quot;border&quot;</span><span class="token operator">:</span><span class="token string">&quot;2px solid red&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.1.5.png" alt="image-20220816091828776" tabindex="0" loading="lazy"><figcaption>image-20220816091828776</figcaption></figure><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，可以看到<code>def=&quot;1&quot;</code>的是红色边框，<code>def=&quot;0&quot;</code>的是灰色边框</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.1.6.png" alt="image-20220816092039686" tabindex="0" loading="lazy"><figcaption>image-20220816092039686</figcaption></figure><h5 id="_2、修改配送的地址" tabindex="-1"><a class="header-anchor" href="#_2、修改配送的地址" aria-hidden="true">#</a> 2、修改配送的地址</h5><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里添加<code>.addr-item p</code>对应元素点击事件，修改配送的地址，然后点击<code>Build</code> -&gt; <code>Recompile &#39;confirm.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
   <span class="token function">highlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.2.png" alt="image-20220816092410550" tabindex="0" loading="lazy"><figcaption>image-20220816092410550</figcaption></figure><h5 id="_3、测试-3" tabindex="-1"><a class="header-anchor" href="#_3、测试-3" aria-hidden="true">#</a> 3、测试</h5><p>打开 http://order.gulimall.com/toTrade 页面，可以看到当点击其他收货人时，红色边框也跟着变了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.3.3.png" alt="GIF 2022-8-16 9-26-40" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-16 9-26-40</figcaption></figure><h4 id="_4、获取运费" tabindex="-1"><a class="header-anchor" href="#_4、获取运费" aria-hidden="true">#</a> 4、获取运费</h4><h5 id="_1、页面添加标识" tabindex="-1"><a class="header-anchor" href="#_1、页面添加标识" aria-hidden="true">#</a> 1、页面添加标识</h5><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里，在遍历收货人信息的<code>&lt;p&gt;</code>标签上添加自定义<code>addrId=${addr.id}</code>属性，方便获取<code>addrId</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>地址<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;top-3 addr-item&quot;</span> <span class="token literal-property property">th</span><span class="token operator">:</span>each<span class="token operator">=</span><span class="token string">&quot;addr: ${orderConfirmData.address}&quot;</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>家里<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>齐天大圣  北京市  昌平区城区晨曦小区<span class="token operator">-</span><span class="token number">16</span>号楼 吉利大学  <span class="token number">150</span><span class="token operator">**</span><span class="token operator">**</span><span class="token number">2245</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p th<span class="token operator">:</span>attr<span class="token operator">=</span><span class="token string">&quot;def=${addr.defaultStatus},addrId=${addr.id}&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>addr<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>addr<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>addr<span class="token punctuation">.</span>province<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>addr<span class="token punctuation">.</span>detailAddress<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>addr<span class="token punctuation">.</span>phone<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.1.png" alt="image-20220816092812983" tabindex="0" loading="lazy"><figcaption>image-20220816092812983</figcaption></figure><h5 id="_2、编写获取运费接口" tabindex="-1"><a class="header-anchor" href="#_2、编写获取运费接口" aria-hidden="true">#</a> 2、编写获取运费接口</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareInfoController</code>类里添加<code>getFare(Long addrId)</code>方法，用于获取运费</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/fare&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">BigDecimal</span> fare<span class="token operator">=</span> wareInfoService<span class="token punctuation">.</span><span class="token function">getFare</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>fare<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.1.png" alt="image-20220816093305892" tabindex="0" loading="lazy"><figcaption>image-20220816093305892</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareInfoService</code>接口里添加<code>getFare</code>抽象方法（下面先不急着实现该抽象方法）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.2.png" alt="image-20220816093346659" tabindex="0" loading="lazy"><figcaption>image-20220816093346659</figcaption></figure><p><code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.controller.MemberReceiveAddressController</code>类的<code>info</code>方法，可以根据<code>addrId</code>获取收货地址</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.3.png" alt="image-20220816093803222" tabindex="0" loading="lazy"><figcaption>image-20220816093803222</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.feign</code>包下新建<code>MemberFeignService</code>接口，在里面添加<code>addrInfo(@PathVariable(&quot;id&quot;) Long id)</code>方法，用于获取地址信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-member&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MemberFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/member/memberreceiveaddress/info/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">addrInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.4.png" alt="image-20220816094054486" tabindex="0" loading="lazy"><figcaption>image-20220816094054486</figcaption></figure><p>复制<code>gulimall-member</code>模块的<code>com.atguigu.gulimall.member.entity.MemberReceiveAddressEntity</code>类，粘贴到<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo</code>包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemberAddressVo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * member_id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 收货人姓名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 电话
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 邮政编码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> postCode<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 省份/直辖市
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> province<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 城市
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 区
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> region<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 详细地址(街道)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> detailAddress<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 省市区代码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> areacode<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 是否默认
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> defaultStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.5.png" alt="image-20220816094729549" tabindex="0" loading="lazy"><figcaption>image-20220816094729549</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware</code>包下新建<code>constant</code>文件夹，在<code>constant</code>文件夹下新建<code>FreightConstant</code>类，用于指定本地运费和外地运费的价格</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description: 用户需要支付的运费
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;gulimall.freight&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreightConstant</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 本地运费
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> localFreight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 外地运费
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> outlandFreight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;12&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.6.png" alt="image-20220816100420426" tabindex="0" loading="lazy"><figcaption>image-20220816100420426</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，用于设置本地运费和外地运费</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 设置本地运费</span>
<span class="token key attr-name">gulimall.freight.localFreight</span><span class="token punctuation">=</span><span class="token value attr-value">9</span>
<span class="token comment"># 设置外地运费</span>
<span class="token key attr-name">gulimall.freight.outlandFreight</span><span class="token punctuation">=</span><span class="token value attr-value">14</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.7.png" alt="image-20220816100545902" tabindex="0" loading="lazy"><figcaption>image-20220816100545902</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareInfoServiceImpl</code>类里实现<code>getFare</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据收货地址计算运费
 * 如果收货地址所在的省份/直辖市 有仓库就按本地运费计算
 * 如果收货地址所在的省份/直辖市 没有有仓库就按外地运费计算
 * <span class="token keyword">@param</span> <span class="token parameter">addrId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">addrInfo</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;memberReceiveAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberAddressVo</span> memberAddressVo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">MemberAddressVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取用户该收货地址 省份/直辖市</span>
    <span class="token class-name">String</span> city <span class="token operator">=</span> memberAddressVo<span class="token punctuation">.</span><span class="token function">getProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareInfoEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareInfoEntity</span><span class="token punctuation">&gt;</span></span> eq <span class="token operator">=</span> lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">WareInfoEntity</span><span class="token operator">::</span><span class="token function">getAddress</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WareInfoEntity</span> wareInfoEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>eq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wareInfoEntity<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//用户收货地址有仓库</span>
       <span class="token keyword">return</span> freightConstant<span class="token punctuation">.</span><span class="token function">getLocalFreight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> freightConstant<span class="token punctuation">.</span><span class="token function">getOutlandFreight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.2.8.png" alt="image-20220816105557985" tabindex="0" loading="lazy"><figcaption>image-20220816105557985</figcaption></figure><h5 id="_3、修改点击事件" tabindex="-1"><a class="header-anchor" href="#_3、修改点击事件" aria-hidden="true">#</a> 3、修改点击事件</h5><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里修改<code>.addr-item p</code>对应元素点击事件，发送请求，在控制台打印获取的数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>$<span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   $<span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
   $<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
   <span class="token function">highlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">//获取到当前的地址id</span>
   <span class="token keyword">var</span> addrId <span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;addrId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://gulimall.com/api/ware/wareinfo/fare?addrId=&quot;</span> <span class="token operator">+</span>addrId<span class="token punctuation">,</span>function <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.3.png" alt="image-20220816105640490" tabindex="0" loading="lazy"><figcaption>image-20220816105640490</figcaption></figure><h5 id="_4、测试-1" tabindex="-1"><a class="header-anchor" href="#_4、测试-1" aria-hidden="true">#</a> 4、测试</h5><p>重启<code>GulimallWareApplication</code>服务，刷新 http://order.gulimall.com/toTrade 页面，点击<code>北京市</code>的收货地址，查看请求信息，显示的响应里的<code>data</code>的值为<code>14</code>，也就是运费为<code>14</code>（上面配置的本地仓库的运费为<code>9</code>，外地仓库的运费为<code>14</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.4.1.png" alt="image-20220816105256019" tabindex="0" loading="lazy"><figcaption>image-20220816105256019</figcaption></figure><p>查看控制台，可以看到输出的<code>data</code>也为<code>14</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.4.2.png" alt="image-20220816110528463" tabindex="0" loading="lazy"><figcaption>image-20220816110528463</figcaption></figure><p>查看<code>gulimall_wms</code>数据库的<code>wms_ware_info</code>表的<code>address</code>字段，确实没有是<code>北京市</code>的仓库，只有<code>北京xx</code>和<code>上海市</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.4.3.png" alt="image-20220816105828227" tabindex="0" loading="lazy"><figcaption>image-20220816105828227</figcaption></figure><p>再点击<code>上海市</code>的收货地址，响应的<code>data</code>的值为<code>9</code>，有<code>北京市</code>的仓库，所以是本地仓库，运费为<code>9</code>元；但是点击<code>北京市</code>的收货人后红色边框没有换过来</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.4.4.png" alt="image-20220816105913892" tabindex="0" loading="lazy"><figcaption>image-20220816105913892</figcaption></figure><p>查看控制台，可以看到输出的<code>data</code>也为<code>9</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.4.5.png" alt="image-20220816110447054" tabindex="0" loading="lazy"><figcaption>image-20220816110447054</figcaption></figure><h5 id="_5、前端显示运费" tabindex="-1"><a class="header-anchor" href="#_5、前端显示运费" aria-hidden="true">#</a> 5、前端显示运费</h5><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到提交订单上面的<code>运费：</code>位置，复制<code>运费：</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.5.1.png" alt="image-20220816110058179" tabindex="0" loading="lazy"><figcaption>image-20220816110058179</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>运费：</code> ，将<code>&lt;span class=&quot;rmb&quot;&gt; &amp;nbsp ￥0.00&lt;/span&gt;</code>修改为<code>&lt;span class=&quot;rmb&quot;&gt; &amp;nbsp ￥&lt;b id=&quot;fareEle&quot;&gt;&lt;/b&gt;&lt;/span&gt;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qian_y<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>运费： <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rmb<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> &amp;nbsp ￥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fareEle<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.5.2.png" alt="image-20220816110259320" tabindex="0" loading="lazy"><figcaption>image-20220816110259320</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里，给收货地址的<code>&lt;p&gt;</code>标签绑定的<code>click</code>事件方法的最后添加 <code>$(&quot;#fareEle&quot;).text(data.data)</code>，将页面初始化方法调用的<code>highlight()</code>删掉，并在<code>$(document).ready()</code>页面初始化方法调用<code>$(&quot;.addr-item p[def=&#39;1&#39;]&quot;).click()</code>，自动点击默认收货地址</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
   <span class="token function">highlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">//获取到当前的地址id</span>
   <span class="token keyword">var</span> addrId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;addrId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://gulimall.com/api/ware/wareinfo/fare?addrId=&quot;</span> <span class="token operator">+</span>addrId<span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#fareEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.5.3.png" alt="image-20220816111607327" tabindex="0" loading="lazy"><figcaption>image-20220816111607327</figcaption></figure><h5 id="_6、测试" tabindex="-1"><a class="header-anchor" href="#_6、测试" aria-hidden="true">#</a> 6、测试</h5><p>重启<code>GulimallOrderApplication</code>服务，刷新 http://order.gulimall.com/toTrade 页面，修改收货人信息，可以看到红色边框改变了，下滑找到<code>运费</code>，可以看到当修改收货人信息后<code>运费</code>也变了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.4.6.gif" alt="GIF 2022-8-16 11-12-56" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-16 11-12-56</figcaption></figure><h4 id="_5、应付总额" tabindex="-1"><a class="header-anchor" href="#_5、应付总额" aria-hidden="true">#</a> 5、应付总额</h4><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>应付总额：</code>位置，复制<code>应付总额：</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.5.1.png" alt="image-20220816112137321" tabindex="0" loading="lazy"><figcaption>image-20220816112137321</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>应付总额：</code>，将<code>￥[[${#numbers.formatDecimal(orderConfirmData.payPrice,1,2)}]]</code>修改为<code>￥&lt;b id=&quot;payPriceEle&quot;&gt;[[${#numbers.formatDecimal(orderConfirmData.payPrice,1,2)}]]&lt;/b&gt;</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze&quot;</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze_a&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;z&quot;</span><span class="token operator">&gt;</span>应付总额：<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;hq&quot;</span><span class="token operator">&gt;</span>￥<span class="token operator">&lt;</span>b id<span class="token operator">=</span><span class="token string">&quot;payPriceEle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>orderConfirmData<span class="token punctuation">.</span>payPrice<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze_b&quot;</span><span class="token operator">&gt;</span>寄送至： 北京 朝阳区 三环到四环之间 朝阳北路复兴国际大厦<span class="token number">23</span>层麦田房产 <span class="token constant">IT</span><span class="token operator">-</span>中心研发二部 收货人：赵存权 <span class="token number">188</span><span class="token operator">**</span><span class="token operator">**</span><span class="token number">5052</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze_b&quot;</span><span class="token operator">&gt;</span>寄送至： xxx 收货人：xxx <span class="token number">188</span><span class="token operator">**</span><span class="token operator">**</span><span class="token number">5052</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.5.2.png" alt="image-20220816113817256" tabindex="0" loading="lazy"><figcaption>image-20220816113817256</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里修改<code>.addr-item p</code>对应元素点击事件，让其调用<code>getFare(addrId)</code>方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.addr-item p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
   <span class="token function">highlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">//获取到当前的地址id</span>
   <span class="token keyword">var</span> addrId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;addrId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">getFare</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token parameter">addrId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://gulimall.com/api/ware/wareinfo/fare?addrId=&quot;</span> <span class="token operator">+</span>addrId<span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#fareEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">)</span>

      <span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>orderConfirmData<span class="token punctuation">.</span>total<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token comment">// total*1 将其转为数字类型</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#payPriceEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>total<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span>data<span class="token punctuation">.</span>data<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.5.3.png" alt="image-20220816113634984" tabindex="0" loading="lazy"><figcaption>image-20220816113634984</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;confirm.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件，刷新 http://order.gulimall.com/toTrade 页面，可以看到将收获地址从没有本地仓库的地址修改为有本地仓库的地址后，<code>应付总额</code>也跟着变了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.5.4.gif" alt="GIF 2022-8-16 11-40-38" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-16 11-40-38</figcaption></figure><h4 id="_6、寄送人" tabindex="-1"><a class="header-anchor" href="#_6、寄送人" aria-hidden="true">#</a> 6、寄送人</h4><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo</code>包里新建<code>FareVo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FareVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">MemberAddressVo</span> memberAddressVo<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> fare<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.1.png" alt="image-20220816114457409" tabindex="0" loading="lazy"><figcaption>image-20220816114457409</figcaption></figure><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareInfoServiceImpl</code>类的<code>getFare</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据收货地址计算运费
 * 如果收货地址所在的省份/直辖市 有仓库就按本地运费计算
 * 如果收货地址所在的省份/直辖市 没有有仓库就按外地运费计算
 * <span class="token keyword">@param</span> <span class="token parameter">addrId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">FareVo</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">addrInfo</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;memberReceiveAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">FareVo</span> fareVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FareVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberAddressVo</span> memberAddressVo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">MemberAddressVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fareVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVo</span><span class="token punctuation">(</span>memberAddressVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取用户该收货地址 省份/直辖市</span>
    <span class="token class-name">String</span> city <span class="token operator">=</span> memberAddressVo<span class="token punctuation">.</span><span class="token function">getProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareInfoEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareInfoEntity</span><span class="token punctuation">&gt;</span></span> eq <span class="token operator">=</span> lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">WareInfoEntity</span><span class="token operator">::</span><span class="token function">getAddress</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WareInfoEntity</span> wareInfoEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>eq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> fare <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wareInfoEntity<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//用户收货地址有仓库</span>
       fareVo<span class="token punctuation">.</span><span class="token function">setFare</span><span class="token punctuation">(</span>freightConstant<span class="token punctuation">.</span><span class="token function">getLocalFreight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        fareVo<span class="token punctuation">.</span><span class="token function">setFare</span><span class="token punctuation">(</span>freightConstant<span class="token punctuation">.</span><span class="token function">getOutlandFreight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fareVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.2.png" alt="image-20220816114733801" tabindex="0" loading="lazy"><figcaption>image-20220816114733801</figcaption></figure><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareInfoService</code>接口的<code>getFare</code>方法返回值</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">FareVo</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.3.png" alt="image-20220816114810150" tabindex="0" loading="lazy"><figcaption>image-20220816114810150</figcaption></figure><p>修改<code>gulimall-warev</code>模块的<code>com.atguigu.gulimall.ware.controller.WareInfoController</code>类的<code>getFare</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/fare&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">FareVo</span> fare<span class="token operator">=</span> wareInfoService<span class="token punctuation">.</span><span class="token function">getFare</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>fare<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.4.png" alt="image-20220816114907518" tabindex="0" loading="lazy"><figcaption>image-20220816114907518</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里，修改<code>getFare(addrId)</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>function <span class="token function">getFare</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://gulimall.com/api/ware/wareinfo/fare?addrId=&quot;</span> <span class="token operator">+</span>addrId<span class="token punctuation">,</span>function <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      $<span class="token punctuation">(</span><span class="token string">&quot;#fareEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fare<span class="token punctuation">)</span>

      <span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>orderConfirmData<span class="token punctuation">.</span>total<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token comment">// total*1 将其转为数字类型</span>
      $<span class="token punctuation">(</span><span class="token string">&quot;#payPriceEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>total<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fare<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.5.png" alt="image-20220816115107557" tabindex="0" loading="lazy"><figcaption>image-20220816115107557</figcaption></figure><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>寄送至</code>位置，复制<code>寄送至</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.6.png" alt="image-20220816115158313" tabindex="0" loading="lazy"><figcaption>image-20220816115158313</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>寄送至</code>，</p><p>把<code>&lt;p class=&quot;yfze_b&quot;&gt;寄送至： xxx 收货人：xxx 188****5052&lt;/p&gt;</code>改为<code>&lt;p class=&quot;yfze_b&quot;&gt;寄送至： &lt;span id=&quot;receiveAddressEle&quot;&gt;&lt;/span&gt; 收货人：&lt;span id=&quot;receiveEle&quot;&gt;&lt;/span&gt;&lt;/p&gt;</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze&quot;</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze_a&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;z&quot;</span><span class="token operator">&gt;</span>应付总额：<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;hq&quot;</span><span class="token operator">&gt;</span>￥<span class="token operator">&lt;</span>b id<span class="token operator">=</span><span class="token string">&quot;payPriceEle&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>orderConfirmData<span class="token punctuation">.</span>payPrice<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze_b&quot;</span><span class="token operator">&gt;</span>寄送至： 北京 朝阳区 三环到四环之间 朝阳北路复兴国际大厦<span class="token number">23</span>层麦田房产 <span class="token constant">IT</span><span class="token operator">-</span>中心研发二部 收货人：赵存权 <span class="token number">188</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">5052</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;yfze_b&quot;</span><span class="token operator">&gt;</span>寄送至： <span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">&quot;receiveAddressEle&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span> 收货人：<span class="token operator">&lt;</span>span id<span class="token operator">=</span><span class="token string">&quot;receiveEle&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.7.png" alt="image-20220816115421918" tabindex="0" loading="lazy"><figcaption>image-20220816115421918</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里，再次修改<code>getFare(addrId)</code>方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token parameter">addrId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://gulimall.com/api/ware/wareinfo/fare?addrId=&quot;</span> <span class="token operator">+</span>addrId<span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//设置运费</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#fareEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fare<span class="token punctuation">)</span>
      <span class="token comment">//设置应付金额</span>
      <span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>orderConfirmData<span class="token punctuation">.</span>total<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token comment">// total*1 将其转为数字类型</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#payPriceEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>total<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fare<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">//设置收货人信息</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#receiveAddressEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>memberAddressVo<span class="token punctuation">.</span>province<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>memberAddressVo<span class="token punctuation">.</span>detailAddress<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#receiveEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>memberAddressVo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.8.png" alt="image-20220816120009456" tabindex="0" loading="lazy"><figcaption>image-20220816120009456</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，可以看到当点击别的寄送地址后，下面的<code>寄送至</code>的信息也会跟着改变</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.3.6.9.gif" alt="GIF 2022-8-16 15-05-17" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-16 15-05-17</figcaption></figure><h3 id="_6-1-4、接口幂等性" tabindex="-1"><a class="header-anchor" href="#_6-1-4、接口幂等性" aria-hidden="true">#</a> 6.1.4、接口幂等性</h3><h4 id="_1、接口幂等性概述" tabindex="-1"><a class="header-anchor" href="#_1、接口幂等性概述" aria-hidden="true">#</a> 1、接口幂等性概述</h4><h5 id="一、什么是幂等性" tabindex="-1"><a class="header-anchor" href="#一、什么是幂等性" aria-hidden="true">#</a> 一、什么是幂等性</h5><p>接口幂等性就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用；比如说支付场景，用户购买了商品支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结 果成功，用户查询余额返发现多扣钱了，流水记录也变成了两条．．．,这就没有保证接口的幂等性。</p><h5 id="二、哪些情况需要防止" tabindex="-1"><a class="header-anchor" href="#二、哪些情况需要防止" aria-hidden="true">#</a> 二、哪些情况需要防止</h5><ul><li>用户多次点击按钮</li><li>用户页面回退再次提交</li><li>微服务互相调用，由于网络问题，导致请求失败。feign 触发重试机制</li><li>其他业务情况</li></ul><h5 id="三、什么情况下需要幂等" tabindex="-1"><a class="header-anchor" href="#三、什么情况下需要幂等" aria-hidden="true">#</a> 三、什么情况下需要幂等</h5><p>以 SQL 为例，有些操作是天然幂等的。</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>SELECT * FROM table WHER id=?
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>无论执行多少次都不会改变状态，是天然的幂等。</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>UPDATE tab1 SET col1=1 WHERE col2=2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>无论执行成功多少次状态都是一致的，也是幂等操作。</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>delete from user where userid=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>多次操作，结果一样，具备幂等性</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>insert into user(userid,name) values(1,&#39;a&#39;) 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果userid 为唯一主键，即重复操作上面的业务，只会插入一条用户数据，具备幂等性。</p><hr><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>UPDATE tab1 SET col1=col1+1 WHERE col2=2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>每次执行的结果都会发生变化，不是幂等的。</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>insert into user(userid,name) values(1,&#39;a&#39;) 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如 userid 不是主键，可以重复，那上面业务多次操作，数据都会新增多条，不具备幂等性。</p><p>可以给<code>gulimall_oms</code>数据库的<code>oms_order</code>表的<code>order_sn</code>订单号字段设置唯一索引(数据库设置级别，保证同一个订单只有一条数据)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.1.3.png" alt="image-20220816153531103" tabindex="0" loading="lazy"><figcaption>image-20220816153531103</figcaption></figure><h5 id="四、幂等解决方案" tabindex="-1"><a class="header-anchor" href="#四、幂等解决方案" aria-hidden="true">#</a> 四、幂等解决方案</h5><h6 id="_1-token-机制" tabindex="-1"><a class="header-anchor" href="#_1-token-机制" aria-hidden="true">#</a> 1. token 机制</h6><p><strong>操作</strong></p><ol><li><p>服务端提供了发送 token 的接口。我们在分析业务的时候，哪些业务是存在幂等问题的，就必须在执行业务前，先去获取</p></li><li><p>然后调用业务接口请求时，把 token 携带过去，一般放在请求头部。</p></li><li><p>服务器判断 token 是否存在 redis 中，存在表示第一次请求，然后删除 token,继续执行业务。</p></li><li><p>如果判断 token 不存在 redis 中，就表示是重复操作，直接返回重复标记给 client，这样就保证了业务代码，不被重复执行。</p></li></ol><p><strong>危险性：</strong></p><ol><li><p>先删除 token 还是后删除 token； (1) 先删除可能导致，业务确实没有执行，重试还带上之前 token，由于防重设计导致，请求还是不能执行。 (2) 后删除可能导致，业务处理成功，但是服务闪断，出现超时，没有删除 token，别人继续重试，导致业务被执行两边 (3) 我们最好设计为先删除 token，如果业务调用失败，就重新获取 token 再次请求。</p></li><li><p>Token 获取、比较和删除必须是原子性 (1) redis.get(token) 、token.equals、redis.del(token)如果这两个操作不是原子，可能导致，高并发下，都 get 到同样的数据，判断都成功，继续业务并发执行 (2) 可以在 redis 使用 lua 脚本完成这个操作</p></li></ol><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;del&#39;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span> <span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h6 id="_2、各种锁机制" tabindex="-1"><a class="header-anchor" href="#_2、各种锁机制" aria-hidden="true">#</a> 2、各种锁机制</h6><p><strong>1、数据库悲观锁</strong></p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>select * from xxxx where id = 1 for update;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，需要根据实际情况选用。另外要注意的是，id 字段一定是主键或者唯一索引，不然可能造成锁表的结果，处理起来会非常麻烦。</p><p><strong>2、数据库乐观锁</strong></p><p>这种方法适合在更新的场景中，</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>update t_goods set count = count -1 , version = version + 1 where good_id=2 and version = 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>根据 version 版本，也就是在操作库存前先获取当前商品的 version 版本号，然后操作的时候 带上此 version 号。我们梳理下，我们第一次操作库存时，得到 version 为 1，调用库存服务 version 变成了 2；但返回给订单服务出现了问题，订单服务又一次发起调用库存服务，当订 单服务传如的 version 还是 1，再执行上面的 sql 语句时，就不会执行；因为 version 已经变 为 2 了，where 条件就不成立。这样就保证了不管调用几次，只会真正的处理一次。 乐观锁主要使用于处理读多写少的问题</p><p><strong>3、业务层分布式锁</strong></p><p>如果多个机器可能在同一时间同时处理相同的数据，比如多台机器定时任务都拿到了相同数据处理，我们就可以加分布式锁，锁定此数据，处理完成后释放锁。获取到锁的必须先判断 这个数据是否被处理过。</p><h6 id="_3、各种唯一约束" tabindex="-1"><a class="header-anchor" href="#_3、各种唯一约束" aria-hidden="true">#</a> 3、各种唯一约束</h6><p><strong>1、数据库唯一约束</strong> 插入数据，应该按照唯一索引进行插入，比如订单号，相同的订单就不可能有两条记录插入。我们在数据库层面防止重复。这个机制是利用了数据库的主键唯一约束的特性，解决了在 insert 场景时幂等问题。但主键的要求不是自增的主键，这样就需要业务生成全局唯一的主键。如果是分库分表场景下，路由规则要保证相同请求下，落地在同一个数据库和同一表中，要不然数据库主键约束就不起效果了，因为是不同的数据库和表主键不相关。 <strong>2、redis set 防重</strong> 很多数据需要处理，只能被处理一次，比如我们可以计算数据的 MD5 将其放入 redis 的 set，每次处理数据，先看这个 MD5 是否已经存在，存在就不处理。 <strong>4、防重表</strong> 使用订单号 orderNo 做为去重表的唯一索引，把唯一索引插入去重表，再进行业务操作，且他们在同一个事务中。这个保证了重复请求时，因为去重表有唯一约束，导致请求失败，避免了幂等问题。这里要注意的是，去重表和业务表应该在同一库中，这样就保证了在同一个事务，即使业务操作失败了，也会把去重表的数据回滚。这个很好的保证了数据一致性。(之前说的 redis防重也算)</p><p><strong>5、全局请求唯一 id</strong></p><p>调用接口时，生成一个唯一 id，redis 将数据保存到集合中（去重），存在即处理过。 可以使用 nginx 设置每一个请求的唯一 id；</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_set_header</span> X-Request-Id <span class="token variable">$request_id</span></span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_2、订单确认" tabindex="-1"><a class="header-anchor" href="#_2、订单确认" aria-hidden="true">#</a> 2、订单确认</h4><h5 id="_1、订单确认流程" tabindex="-1"><a class="header-anchor" href="#_1、订单确认流程" aria-hidden="true">#</a> 1、订单确认流程</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.2.1.png" alt="订单确认页流程" tabindex="0" loading="lazy"><figcaption>订单确认页流程</figcaption></figure><h5 id="_2、修改代码-1" tabindex="-1"><a class="header-anchor" href="#_2、修改代码-1" aria-hidden="true">#</a> 2、修改代码</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包下新建<code>constant</code>文件夹，在<code>constant</code>文件夹里新建<code>OrderConstant</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderConstant</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 用户生成订单的令牌前缀
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_ORDER_TOKEN_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;order:token:&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.2.2.1.png" alt="image-20220816155302842" tabindex="0" loading="lazy"><figcaption>image-20220816155302842</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里的<code>confirmOrder</code>方法里添加防重令牌，<a href="code/6.1.4.2.5.java">点击查看完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>orderConfirmVo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//TODO 防重令牌</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">OrderConstant</span><span class="token punctuation">.</span><span class="token constant">USER_ORDER_TOKEN_PREFIX</span> <span class="token operator">+</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>token<span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderConfirmVo<span class="token punctuation">.</span><span class="token function">setOrderToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>getAddressFuture<span class="token punctuation">,</span>cartFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orderConfirmVo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.2.2.2.png" alt="image-20220816155726108" tabindex="0" loading="lazy"><figcaption>image-20220816155726108</figcaption></figure><h4 id="_3、提交订单" tabindex="-1"><a class="header-anchor" href="#_3、提交订单" aria-hidden="true">#</a> 3、提交订单</h4><h5 id="_1、前端添加提交订单按钮" tabindex="-1"><a class="header-anchor" href="#_1、前端添加提交订单按钮" aria-hidden="true">#</a> 1、前端添加提交订单按钮</h5><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>提交订单</code>，在上面添加如下代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>orderToken<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${orderConfirmData.orderToken}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.1.1.png" alt="image-20220816160347855" tabindex="0" loading="lazy"><figcaption>image-20220816160347855</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包里新建<code>OrderSubmitVo</code>类，用于封装提交订单的信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description: 封装订单提交的数据
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSubmitVo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 收货地址的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> addrId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 支付方式（在线支付/货到付款）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> payType<span class="token punctuation">;</span>

    <span class="token comment">//再去购物车中查询商品，不用页面提交商品信息</span>
    <span class="token comment">//积分、优惠、发票</span>

    <span class="token doc-comment comment">/**
     * 防重令牌
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderToken<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 页面提交的应付价格（如果提交订单后判断的应付价格和页面提交过来的价格不一样，给予用户提示）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> payPrice<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单备注
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> note<span class="token punctuation">;</span>
    <span class="token comment">///用户相关信息，直接去session取出登录的用户</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.1.2.png" alt="image-20220816161846478" tabindex="0" loading="lazy"><figcaption>image-20220816161846478</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里，给<code>提交订单</code>的<code>&lt;button&gt;</code>标签和<code>name</code>为<code>orderToken</code>的<code>&lt;input&gt;</code>标签 添加一个父<code>&lt;form&gt;</code>标签，并在里面<code>&lt;form&gt;</code>标签里面（与<code>提交订单</code>的<code>&lt;button&gt;</code>标签、<code>orderToken</code>的<code>&lt;input&gt;</code>标签同级）添加隐藏的<code>addrIdInput</code>、<code>payPriceInput</code>、<code>note</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://order.gulimall.com/submitOrder<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addrIdInput<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addrId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>payPriceInput<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>payPrice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>note<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>orderToken<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${orderConfirmData.orderToken}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tijiao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>提交订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.1.3.png" alt="image-20220816163702202" tabindex="0" loading="lazy"><figcaption>image-20220816163702202</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里的<code>&lt;script&gt;</code>标签里，修改<code>getFare(addrId)</code>方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token parameter">addrId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   $<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://gulimall.com/api/ware/wareinfo/fare?addrId=&quot;</span> <span class="token operator">+</span>addrId<span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//设置运费</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#fareEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fare<span class="token punctuation">)</span>
      <span class="token comment">//设置应付金额</span>
      <span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>orderConfirmData<span class="token punctuation">.</span>total<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token comment">// total*1 将其转为数字类型</span>
      <span class="token keyword">var</span> payPrice <span class="token operator">=</span> total<span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fare<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#payPriceEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>payPrice<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#payPriceInput&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>payPrice<span class="token punctuation">)</span>
      <span class="token comment">//设置收货人信息</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#receiveAddressEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>memberAddressVo<span class="token punctuation">.</span>province<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>memberAddressVo<span class="token punctuation">.</span>detailAddress<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#receiveEle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>memberAddressVo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token comment">//给表单回填选中的地址</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#addrIdInput&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.1.4.png" alt="image-20220816163612907" tabindex="0" loading="lazy"><figcaption>image-20220816163612907</figcaption></figure><h5 id="_2、提交订单" tabindex="-1"><a class="header-anchor" href="#_2、提交订单" aria-hidden="true">#</a> 2、提交订单</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包里新建<code>SubmitOrderResponseVo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubmitOrderResponseVo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 订单信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderEntity</span> order<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 下单状态码(成功为0)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.2.1.png" alt="image-20220816164323519" tabindex="0" loading="lazy"><figcaption>image-20220816164323519</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.OrderWebController</code>类里添加<code>submitOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/submitOrder&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">SubmitOrderResponseVo</span> responseVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">submitOrder</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//下单:去创建订单，验令牌，验价格，锁库存...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseVo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//下单成功来到支付选择页</span>
        <span class="token keyword">return</span> <span class="token string">&quot;pay&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//下单失败回到订单确认页重新确认订单信息</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.2.2.png" alt="image-20220816164816816" tabindex="0" loading="lazy"><figcaption>image-20220816164816816</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里添加<code>submitOrder</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">SubmitOrderResponseVo</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.2.3.png" alt="image-20220816164843864" tabindex="0" loading="lazy"><figcaption>image-20220816164843864</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里实现<code>submitOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SubmitOrderResponseVo</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">OrderConstant</span><span class="token punctuation">.</span><span class="token constant">USER_ORDER_TOKEN_PREFIX</span> <span class="token operator">+</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SubmitOrderResponseVo</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubmitOrderResponseVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderConfirmVo</span> orderConfirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//下单:去创建订单，验令牌，验价格，锁库存...</span>
    <span class="token class-name">String</span> orderToken <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getOrderToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//验证并删除令牌[令牌的对比和删除必须保证原子性]</span>
    <span class="token comment">//0:令牌失败  -  1:删除成功</span>
    <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> result <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> orderToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> result <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//令牌验证失败</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//令牌验证成功</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.2.4.png" alt="image-20220816182653968" tabindex="0" loading="lazy"><figcaption>image-20220816182653968</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包里新建<code>to</code>文件夹，在<code>to</code>文件夹里新建<code>OrderCreateTo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>to</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderItemEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreateTo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 订单实体类
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderEntity</span> order<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单项
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">&gt;</span></span> orderItems<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 运费
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> fare<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单计算的应付价格
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> payPrice<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.2.5.png" alt="image-20220816183442814" tabindex="0" loading="lazy"><figcaption>image-20220816183442814</figcaption></figure><h5 id="_3、创建订单" tabindex="-1"><a class="header-anchor" href="#_3、创建订单" aria-hidden="true">#</a> 3、创建订单</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里新建<code>createOrder</code>方法，然后<code>submitOrder</code>方法调用该<code>createOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">OrderCreateTo</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">OrderCreateTo</span> orderCreateTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderCreateTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//订单号</span>
    <span class="token class-name">String</span> orderSn <span class="token operator">=</span> <span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getTimeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> orderCreateTo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.3.1.png" alt="image-20220816183954893" tabindex="0" loading="lazy"><figcaption>image-20220816183954893</figcaption></figure><p>将<code>2.分布式高级篇（微服务架构篇）\资料源码\代码</code> 里的 <code>enume</code>文件夹移动到<code>gulimall-order</code>模块里的<code>com.atguigu.gulimall.order</code>包下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.3.2.png" alt="image-20220816185354565" tabindex="0" loading="lazy"><figcaption>image-20220816185354565</figcaption></figure><h5 id="_4、获取运费-1" tabindex="-1"><a class="header-anchor" href="#_4、获取运费-1" aria-hidden="true">#</a> 4、获取运费</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareInfoController</code>类里已经有了一个计算运费的<code>getFare</code>方法了，因此直接调用即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.4.1.png" alt="image-20220816190556955" tabindex="0" loading="lazy"><figcaption>image-20220816190556955</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign.WmsFeignService</code>接口里添加如下方法，用于获取运费</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据addrId获取运费 和 MemberAddressVo
 * <span class="token keyword">@param</span> <span class="token parameter">addrId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/wareinfo/fare&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token class-name">Long</span> addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.4.2.png" alt="image-20220816191017087" tabindex="0" loading="lazy"><figcaption>image-20220816191017087</figcaption></figure><p>复制<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo.FareVo</code>类，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包里。复制<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo.MemberAddressVo</code>类里的代码，粘贴到<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo.FareVo</code>类里，作为<code>FareVo</code>类的静态内部类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FareVo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">MemberAddressVo</span> memberAddressVo<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> fare<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MemberAddressVo</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * member_id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 收货人姓名
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 电话
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 邮政编码
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> postCode<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 省份/直辖市
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> province<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 城市
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 区
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> region<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 详细地址(街道)
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> detailAddress<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 省市区代码
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> areacode<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 是否默认
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Integer</span> defaultStatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.4.3.png" alt="image-20220816191857675" tabindex="0" loading="lazy"><figcaption>image-20220816191857675</figcaption></figure><h5 id="_5、获取spu信息" tabindex="-1"><a class="header-anchor" href="#_5、获取spu信息" aria-hidden="true">#</a> 5、获取spu信息</h5><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.controller.SpuInfoController</code>类里添加<code>getSpuInfoBySkuId</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/skuId/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpuInfoEntity</span> spuInfoEntity <span class="token operator">=</span> spuInfoService<span class="token punctuation">.</span><span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>spuInfoEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.5.1.png" alt="image-20220816212502224" tabindex="0" loading="lazy"><figcaption>image-20220816212502224</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.SpuInfoService</code>接口里添加<code>getSpuInfoBySkuId</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">SpuInfoEntity</span> <span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.5.2.png" alt="image-20220816212447308" tabindex="0" loading="lazy"><figcaption>image-20220816212447308</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>com.atguigu.gulimall.product.service.impl.SpuInfoServiceImpl</code>类里实现<code>getSpuInfoBySkuId</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SpuInfoEntity</span> <span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SkuInfoEntity</span> skuInfoEntity <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuInfoEntity<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.5.3.png" alt="image-20220816212941842" tabindex="0" loading="lazy"><figcaption>image-20220816212941842</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign</code>包里新建<code>ProductFeignService</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/16
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/spuinfo/skuId/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.5.4.png" alt="image-20220816213313510" tabindex="0" loading="lazy"><figcaption>image-20220816213313510</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.vo</code>包里新建<code>SpuInfoVo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * spu信息
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpuInfoVo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * 商品id
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 商品名称
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> spuName<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 商品描述
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> spuDescription<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 所属分类id
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 品牌id
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> weight<span class="token punctuation">;</span>
   <span class="token doc-comment comment">/**
    * 上架状态[0 - 下架，1 - 上架]
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> publishStatus<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.5.5.png" alt="image-20220816213449916" tabindex="0" loading="lazy"><figcaption>image-20220816213449916</figcaption></figure><p><a href="code/6.1.4.3.5.java">点击查看OrderServiceImpl类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.3.5.6.png" alt="image-20220817110820988" tabindex="0" loading="lazy"><figcaption>image-20220817110820988</figcaption></figure><h4 id="_4、锁定库存" tabindex="-1"><a class="header-anchor" href="#_4、锁定库存" aria-hidden="true">#</a> 4、锁定库存</h4><h5 id="_1、添加to" tabindex="-1"><a class="header-anchor" href="#_1、添加to" aria-hidden="true">#</a> 1、添加To</h5><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>类里新建<code>ware</code>文件夹，在<code>ware</code>文件夹里新建<code>WareSkuLockTo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>ware</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/17
 * @Description: 下订单后锁库存
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WareSkuLockTo</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 订单号
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 需要锁的库存
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">&gt;</span></span> locks<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单项（某一个具体商品）
     */</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderItemVo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * sku的id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 商品的标题
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 商品的图片
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * sku的属性（选中的 颜色、内存容量 等）
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> skuAttr<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 商品的价格
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 商品的数量
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 总价(商品价格*商品数量)
         */</span><span class="token number">0</span><span class="token operator">-</span>
        <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalPrice<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 货物重量
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> weight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.1.1.png" alt="image-20220817101843418" tabindex="0" loading="lazy"><figcaption>image-20220817101843418</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.to.ware</code>包里新建<code>WareLockStockResult</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>to<span class="token punctuation">.</span>ware</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/17
 * @Description:
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WareLockStockResult</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 要锁定的sku的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 锁定了的件数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> num<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 是否锁定成功
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> locked<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.1.2.png" alt="image-20220817104611655" tabindex="0" loading="lazy"><figcaption>image-20220817104611655</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common.exception.BizCodeException</code>枚举类里添加枚举</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 下订单锁库存，没有库存的异常
 */</span>
<span class="token function">NO_STOCK_EXCEPTION</span><span class="token punctuation">(</span><span class="token number">21000</span><span class="token punctuation">,</span><span class="token string">&quot;商品库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.1.3.png" alt="image-20220817151949968" tabindex="0" loading="lazy"><figcaption>image-20220817151949968</figcaption></figure><h5 id="_2、锁订单" tabindex="-1"><a class="header-anchor" href="#_2、锁订单" aria-hidden="true">#</a> 2、锁订单</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareSkuController</code>类里添加<code>orderLockStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 下订单后。锁库存
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/lock/order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">WareSkuLockTo</span> wareSkuLockTo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> stock <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">orderLockStock</span><span class="token punctuation">(</span>wareSkuLockTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeException</span><span class="token punctuation">.</span><span class="token constant">NO_STOCK_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.1.png" alt="image-20220817152357375" tabindex="0" loading="lazy"><figcaption>image-20220817152357375</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareSkuService</code>接口里添加<code>orderLockStock</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Boolean</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token class-name">WareSkuLockTo</span> wareSkuLockTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.2.png" alt="image-20220817152455180" tabindex="0" loading="lazy"><figcaption>image-20220817152455180</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类里实现<code>orderLockStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 为订单锁定库存
 * <span class="token keyword">@param</span> <span class="token parameter">wareSkuLockTo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token class-name">WareSkuLockTo</span> wareSkuLockTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//按照下单的收货地址，找到一-个就近仓库，锁定库存。</span>

    <span class="token comment">//找到每个商品在哪个仓库都有库存</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareSkuLockTo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> locks <span class="token operator">=</span> wareSkuLockTo<span class="token punctuation">.</span><span class="token function">getLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuWareHasStock</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>orderItemVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuWareHasStock</span> skuWareHasStock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuWareHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> skuId <span class="token operator">=</span> orderItemVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuWareHasStock<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//select ware_id from wms_ware_sku where sku_id = 1 and stock - stock_locked &gt; 0</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> wareId <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">listWareIdHasSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuWareHasStock<span class="token punctuation">.</span><span class="token function">setWareId</span><span class="token punctuation">(</span>wareId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuWareHasStock<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>orderItemVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuWareHasStock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//锁定库存</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuWareHasStock</span> hasStock <span class="token operator">:</span> collect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> skuStocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> skuId <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> wareIds <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//没有库存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>wareIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//锁定库存</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> wareId <span class="token operator">:</span> wareIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//成功返回1，失败返回0</span>
            <span class="token comment">//update wms_ware_sku set stock_locked = stock_locked+2 where sku_id=1 and ware_id = 1 and stock - stock_locked&gt;=2</span>
            <span class="token class-name">Long</span> count <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">lockSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>wareId<span class="token punctuation">,</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//锁库存成功</span>
                skuStocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//锁库存成功</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skuStocked<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//当前商品没有库存了</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 判断哪些商品有库存
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">SkuWareHasStock</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> num<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> wareId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.3.png" alt="image-20220817152941132" tabindex="0" loading="lazy"><figcaption>image-20220817152941132</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.dao.WareSkuDao</code>接口里添加<code>listWareIdHasSkuStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">listWareIdHasSkuStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.4.png" alt="image-20220817152745903" tabindex="0" loading="lazy"><figcaption>image-20220817152745903</figcaption></figure><p>在<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表里，修改<code>stock_locked</code>字段，设置默认值为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.5.png" alt="image-20220817114928233" tabindex="0" loading="lazy"><figcaption>image-20220817114928233</figcaption></figure><p>把<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表里<code>stock_locked</code>字段为<code>null</code>的数据都修改为<code>0</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.6.png" alt="image-20220817115030062" tabindex="0" loading="lazy"><figcaption>image-20220817115030062</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件里添加<code>sql</code>语句</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--根据skuId查询有库存的仓库列表--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>listWareIdHasSkuStock<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>java.lang.Long<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select ware_id from gulimall_wms.wms_ware_sku where sku_id = #{skuId} and stock - stock_locked &gt; 0
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.7.png" alt="image-20220817153137023" tabindex="0" loading="lazy"><figcaption>image-20220817153137023</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware</code>包里新建<code>exception</code>文件夹，在<code>exception</code>文件夹里新建<code>NoStockException</code>异常类，用于抛出<code>没有库存异常</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/17
 * @Description:
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoStockException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;商品id：&quot;</span><span class="token operator">+</span> skuId <span class="token operator">+</span><span class="token string">&quot;；没有足够的库存了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> skuId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSkuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>skuId <span class="token operator">=</span> skuId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.2.8.png" alt="image-20220817153453382" tabindex="0" loading="lazy"><figcaption>image-20220817153453382</figcaption></figure><h5 id="_3、锁订单" tabindex="-1"><a class="header-anchor" href="#_3、锁订单" aria-hidden="true">#</a> 3、锁订单</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.dao.WareSkuDao</code>接口里添加<code>lockSkuStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//锁库存</span>
<span class="token class-name">Long</span> <span class="token function">lockSkuStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;wareId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> wareId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.3.1.png" alt="image-20220817153633817" tabindex="0" loading="lazy"><figcaption>image-20220817153633817</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件里添加sql</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lockSkuStock<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    update gulimall_wms.wms_ware_sku set stock_locked = stock_locked+#{num}
    where sku_id=#{skuId} and ware_id = #{wareId} and stock - stock_locked&gt;=#{num}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.3.2.png" alt="image-20220817153901584" tabindex="0" loading="lazy"><figcaption>image-20220817153901584</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign.WmsFeignService</code>接口里添加<code>orderLockStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 下订单后。锁库存
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/waresku/lock/order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">WareSkuLockTo</span> wareSkuLockTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.3.3.png" alt="image-20220817105457951" tabindex="0" loading="lazy"><figcaption>image-20220817105457951</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里修改<code>submitOrder</code>方法</p><p><a href="code/6.1.4.4.3.java">点击查看OrderServiceImpl类完整代码</a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SubmitOrderResponseVo</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orderSubmitVoThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MemberEntityTo</span> memberEntityTo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">OrderConstant</span><span class="token punctuation">.</span><span class="token constant">USER_ORDER_TOKEN_PREFIX</span> <span class="token operator">+</span> memberEntityTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SubmitOrderResponseVo</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubmitOrderResponseVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//下单:去创建订单，验令牌，验价格，锁库存...</span>
    <span class="token class-name">String</span> orderToken <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getOrderToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//验证并删除令牌[令牌的对比和删除必须保证原子性]</span>
    <span class="token comment">//0:令牌失败  -  1:删除成功</span>
    <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> result <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> orderToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> result <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//令牌验证失败</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//令牌验证成功</span>
    <span class="token comment">//创建订单</span>
    <span class="token class-name">OrderCreateTo</span> orderCreateTo <span class="token operator">=</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//验价</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>orderCreateTo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//保存订单</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveOrder</span><span class="token punctuation">(</span>orderCreateTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//锁定库存</span>
        <span class="token class-name">WareSkuLockTo</span> wareSkuLockTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareSkuLockTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wareSkuLockTo<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareSkuLockTo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> orderItemVos <span class="token operator">=</span> orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrderItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>orderItemEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">WareSkuLockTo<span class="token punctuation">.</span>OrderItemVo</span> orderItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareSkuLockTo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItemVo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItemVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderItemVo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> orderItemVo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wareSkuLockTo<span class="token punctuation">.</span><span class="token function">setLocks</span><span class="token punctuation">(</span>orderItemVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">orderLockStock</span><span class="token punctuation">(</span>wareSkuLockTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//锁定库存成功</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span>orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//锁定库存失败</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//金额对比失败</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.4.3.4.png" alt="image-20220817154720295" tabindex="0" loading="lazy"><figcaption>image-20220817154720295</figcaption></figure><h4 id="_5、准备支付" tabindex="-1"><a class="header-anchor" href="#_5、准备支付" aria-hidden="true">#</a> 5、准备支付</h4><h5 id="_1、修改页面-1" tabindex="-1"><a class="header-anchor" href="#_1、修改页面-1" aria-hidden="true">#</a> 1、修改页面</h5><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.OrderWebController</code>类的<code>submitOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/submitOrder&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> vo<span class="token punctuation">,</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">SubmitOrderResponseVo</span> responseVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">submitOrder</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//下单:去创建订单，验令牌，验价格，锁库存...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseVo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//下单成功来到支付选择页</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;submitOrderResp&quot;</span><span class="token punctuation">,</span>responseVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;pay&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//下单失败回到订单确认页重新确认订单信息</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.1.1.png" alt="image-20220817155110204" tabindex="0" loading="lazy"><figcaption>image-20220817155110204</figcaption></figure><p>在 http://order.gulimall.com/toTrade 页面里，打开控制台，定位到<code>订单提交成功，请尽快付款！订单号：</code>位置，复制<code>订单号</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.1.2.png" alt="image-20220817204439779" tabindex="0" loading="lazy"><figcaption>image-20220817204439779</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/pay.html</code>文件里搜索<code>订单号</code>，修改成动态的订单号和金额数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dd<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>span<span class="token punctuation">&gt;</span></span>订单提交成功，请尽快付款！订单号：<span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>submitOrderResp<span class="token punctuation">.</span>order<span class="token punctuation">.</span>orderSn<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>span<span class="token punctuation">&gt;</span></span>应付金额<span class="token generics"><span class="token punctuation">&lt;</span>font<span class="token punctuation">&gt;</span></span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>#numbers<span class="token punctuation">.</span><span class="token function">formatDecimal</span><span class="token punctuation">(</span>submitOrderResp<span class="token punctuation">.</span>order<span class="token punctuation">.</span>payAmount<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>font<span class="token operator">&gt;</span>元<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dd<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.1.3.png" alt="image-20220817180337325" tabindex="0" loading="lazy"><figcaption>image-20220817180337325</figcaption></figure><h5 id="_2、post-请求方式不支持" tabindex="-1"><a class="header-anchor" href="#_2、post-请求方式不支持" aria-hidden="true">#</a> 2、POST 请求方式不支持</h5><p>重启<code>GulimallProductApplication</code>服务，<code>GulimallOrderApplication</code>服务、<code>GulimallWareApplication</code>服务、<code>GulimallCartApplication</code>服务</p><p>浏览器访问 http://order.gulimall.com/submitOrder 页面，报了<code>POST 请求方式不支持</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Whitelabel Error Page
This application has no explicit mapping for /error, so you are seeing this as a fallback.

Wed Aug 17 18:04:07 CST 2022
There was an unexpected error (type=Method Not Allowed, status=405).
Request method &#39;POST&#39; not supported
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.2.1.png" alt="image-20220817180443080" tabindex="0" loading="lazy"><figcaption>image-20220817180443080</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.OrderWebController</code>类的<code>submitOrder</code>方法上，将<code>@GetMapping(&quot;/submitOrder&quot;)</code>修改为<code>@PostMapping(&quot;/submitOrder&quot;)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.2.2.png" alt="image-20220817180649139" tabindex="0" loading="lazy"><figcaption>image-20220817180649139</figcaption></figure><h5 id="_3、方法不被允许" tabindex="-1"><a class="header-anchor" href="#_3、方法不被允许" aria-hidden="true">#</a> 3、方法不被允许</h5><p>重启<code>GulimallOrderApplication</code>服务，登陆后，在 http://cart.gulimall.com/cart.html 购物页面里点击<code>去结算</code>，然后再 http://order.gulimall.com/toTrade 页面里点击<code>提交订单</code>，此时跳转到 http://order.gulimall.com/submitOrder 页面，并报了个错</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.3.1.gif" alt="GIF 2022-8-17 18-52-54" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-17 18-52-54</figcaption></figure><p>在 http://order.gulimall.com/submitOrder 页面里报了如下错误，读取<code>WmsFeignService#getFare(Long)</code>失败</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Whitelabel Error Page
This application has no explicit mapping for /error, so you are seeing this as a fallback.

Wed Aug 17 18:08:07 CST 2022
There was an unexpected error (type=Internal Server Error, status=500).
status 405 reading WmsFeignService#getFare(Long)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.3.2.png" alt="image-20220817180834600" tabindex="0" loading="lazy"><figcaption>image-20220817180834600</figcaption></figure><p>查看<code>GulimallOrderApplication</code>服务的控制台，提示<code>WmsFeignService#getFare(Long)</code>方法不被允许</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-17 <span class="token number">18</span>:52:37.101 ERROR <span class="token number">12336</span> --- <span class="token punctuation">[</span>nio-9000-exec-2<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is feign.FeignException<span class="token variable">$MethodNotAllowed</span><span class="token builtin class-name">:</span> status <span class="token number">405</span> reading WmsFeignService<span class="token comment">#getFare(Long)] with root cause</span>

feign.FeignException<span class="token variable">$MethodNotAllowed</span><span class="token builtin class-name">:</span> status <span class="token number">405</span> reading WmsFeignService<span class="token comment">#getFare(Long)</span>
	at feign.FeignException.errorStatus<span class="token punctuation">(</span>FeignException.java:100<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.FeignException.errorStatus<span class="token punctuation">(</span>FeignException.java:86<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.codec.ErrorDecoder<span class="token variable">$Default</span>.decode<span class="token punctuation">(</span>ErrorDecoder.java:93<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.executeAndDecode<span class="token punctuation">(</span>SynchronousMethodHandler.java:149<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.SynchronousMethodHandler.invoke<span class="token punctuation">(</span>SynchronousMethodHandler.java:78<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at feign.ReflectiveFeign<span class="token variable">$FeignInvocationHandler</span>.invoke<span class="token punctuation">(</span>ReflectiveFeign.java:103<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>feign-core-10.2.3.jar:na<span class="token punctuation">]</span>
	at com.sun.proxy.<span class="token variable">$Proxy105</span>.getFare<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.buildOrder<span class="token punctuation">(</span>OrderServiceImpl.java:282<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.createOrder<span class="token punctuation">(</span>OrderServiceImpl.java:208<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.submitOrder<span class="token punctuation">(</span>OrderServiceImpl.java:150<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>99092a92.invoke<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.3.3.png" alt="image-20220817185533072" tabindex="0" loading="lazy"><figcaption>image-20220817185533072</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign.WmsFeignService</code>类的<code>getFare</code>方法上，明明使用的是<code>@GetMapping(&quot;/ware/wareinfo/fare&quot;)</code>调用的远程服务，<code>GulimallWareApplication</code>服务的控制台却显示<code> Request method &#39;POST&#39; not supported</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.3.4.png" alt="image-20220817185417882" tabindex="0" loading="lazy"><figcaption>image-20220817185417882</figcaption></figure><p>可以看到调用远程的<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareInfoController</code>类的<code>getFare</code>方法也使用的是<code>@GetMapping(&quot;/fare&quot;)</code>，都使用的是<code>@GetMapping</code>应该是可以成功的啊</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2022-08-17 18:52:37.086  WARN 15556 --- [io-11000-exec-9] .w.s.m.s.DefaultHandlerExceptionResolver : Resolved [org.springframework.web.HttpRequestMethodNotSupportedException: Request method &#39;POST&#39; not supported]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.3.5.png" alt="image-20220817185423112" tabindex="0" loading="lazy"><figcaption>image-20220817185423112</figcaption></figure><h5 id="_4、源码调试" tabindex="-1"><a class="header-anchor" href="#_4、源码调试" aria-hidden="true">#</a> 4、源码调试</h5><p>调试发现，<code>R r = wmsFeignService.getFare(orderSubmitVo.getAddrId());</code>方法调用的远程服务的<code>addrId=1</code>，</p><p>此时的<code>feign.ReflectiveFeign.FeignInvocationHandler#invoke</code>方法的<code>proxy</code>参数里，<code>h</code>-&gt;<code>target</code>-&gt;<code>type</code>的<code>name</code>即为<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign.WmsFeignService</code>远程调用<code>gulimall-ware</code>模块的类</p><p><code>h</code>-&gt;<code>target</code>的<code>name</code>即为要调用的<code>模块名</code>，<code>h</code>-&gt;<code>target</code>的<code>url</code>即为要调用的<code>GulimallWareApplication</code>服务的<code>url</code>(负载均衡到<code>gulimall-ware</code>模块)</p><p><code>h</code>-&gt;<code>dispatch</code>为<code>LinkedHashMap</code>类型的<code>WmsFeignService</code>类的所有方法集合，<code>key</code>为<code>Method</code>类型，该<code>Method</code>类的<code>name</code>即为方法名，<code>returnType</code>即为返回类型</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.1.png" alt="image-20220817193013509" tabindex="0" loading="lazy"><figcaption>image-20220817193013509</figcaption></figure><p><code>h</code>-&gt;<code>dispatch</code>里随便点击一个类，这个类的<code>value</code>为<code>feign.SynchronousMethodHandler</code>类型，里面的<code>target</code>和<code>proxy</code>参数的<code>h</code>-&gt;<code>target</code>差不多</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.2.png" alt="image-20220817193326956" tabindex="0" loading="lazy"><figcaption>image-20220817193326956</figcaption></figure><p>由此可知<code>h</code>-&gt;<code>target</code>-&gt;<code>type</code>-&gt;<code>name</code>即为远程调用接口的全类名，<code>@FeignClient(&quot;gulimall-ware&quot;)</code>与<code>feign.ReflectiveFeign.FeignInvocationHandler#invoke</code>方法的<code>proxy</code>参数的<code>h</code>-&gt;<code>target</code>-&gt;<code>name</code>对应</p><p><code>h</code>-&gt;<code>dispatch</code>为该类的方法的信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.3.png" alt="image-20220817191539584" tabindex="0" loading="lazy"><figcaption>image-20220817191539584</figcaption></figure><p><code>method</code>即为该方法的信息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.4.png" alt="image-20220817191852111" tabindex="0" loading="lazy"><figcaption>image-20220817191852111</figcaption></figure><p><code>argv</code>即为调用该方法传递的参数</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.5.png" alt="image-20220817191922868" tabindex="0" loading="lazy"><figcaption>image-20220817191922868</figcaption></figure><p>此时的<code>feign.SynchronousMethodHandler#invoke</code>方法的<code>argv</code>里面已经有<code>attrId</code>的<code>1</code>了，而<code>template</code>的<code>queries</code>里竟然没有数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.6.png" alt="image-20220817184436790" tabindex="0" loading="lazy"><figcaption>image-20220817184436790</figcaption></figure><p>修改<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.feign.WmsFeignService</code>类的<code>getFare</code>方法的参数，给<code>Long addrId</code>参数加上<code>@RequestParam(&quot;addrId&quot;)</code>注解，向<code>feign</code>指明把<code>addrId</code>放在请求参数里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据addrId获取运费 和 MemberAddressVo
 * <span class="token keyword">@param</span> <span class="token parameter">addrId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ware/wareinfo/fare&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;addrId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.7.png" alt="image-20220817194254066" tabindex="0" loading="lazy"><figcaption>image-20220817194254066</figcaption></figure><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.controller.WareInfoController</code>类的<code>getFare</code>方法的参数，给<code>Long addrId</code>参数加上<code>@RequestParam(&quot;addrId&quot;)</code>注解（其实这个指不指定都行，<code>Spring MVC</code>会从请求参数里获取数据，亲测）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/fare&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getFare</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;addrId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> addrId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FareVo</span> fare <span class="token operator">=</span> wareInfoService<span class="token punctuation">.</span><span class="token function">getFare</span><span class="token punctuation">(</span>addrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> fare<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.8.png" alt="image-20220817194456765" tabindex="0" loading="lazy"><figcaption>image-20220817194456765</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务和<code>GulimallWareApplication</code>服务，重新调试，可以看到<code>queries</code>里已经封装请求参数<code>addrId=1</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.4.9.png" alt="image-20220817184419186" tabindex="0" loading="lazy"><figcaption>image-20220817184419186</figcaption></figure><h5 id="_5、空指针" tabindex="-1"><a class="header-anchor" href="#_5、空指针" aria-hidden="true">#</a> 5、空指针</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>submitOrder</code>方法里报了空指针，<code>orderEntity</code>的<code>growth</code>字段是后面才赋值的，这里用错类了，应该使用<code>orderItemEntity</code>对象的<code>giftGrowth</code>字段</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java.lang.NullPointerException: null
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.computePrice(OrderServiceImpl.java:248) ~[classes/:na]
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.createOrder(OrderServiceImpl.java:212) ~[classes/:na]
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.submitOrder(OrderServiceImpl.java:150) ~[classes/:na]
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl$$FastClassBySpringCGLIB$$99092a92.invoke(&lt;generated&gt;) ~[classes/:na]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.5.1.png" alt="image-20220817195509778" tabindex="0" loading="lazy"><figcaption>image-20220817195509778</figcaption></figure><p>将<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>submitOrder</code>方法里的<code>giftGrowth = giftGrowth.add(new BigDecimal(orderEntity.getGrowth().toString()));</code>改为<code>giftGrowth = giftGrowth.add(new BigDecimal(orderItemEntity.getGiftGrowth().toString()));</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.5.2.png" alt="image-20220817195832260" tabindex="0" loading="lazy"><figcaption>image-20220817195832260</figcaption></figure><h5 id="_6、order-sn字段太长" tabindex="-1"><a class="header-anchor" href="#_6、order-sn字段太长" aria-hidden="true">#</a> 6、<code>order_sn</code>字段太长</h5><p>重启<code>GulimallOrderApplication</code>服务，再次测试， 在 http://order.gulimall.com/submitOrder 页面里又报错了</p><p><code>Data too long for column &#39;order_sn&#39; at row 1 ;</code>插入的<code>order_sn</code>字段太长</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Whitelabel Error Page
This application has no explicit mapping <span class="token keyword">for</span> /error, so you are seeing this as a fallback.

Wed Aug <span class="token number">17</span> <span class="token number">20</span>:01:45 CST <span class="token number">2022</span>
There was an unexpected error <span class="token punctuation">(</span>type<span class="token operator">=</span>Internal Server Error, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>.
<span class="token comment">### Error updating database. Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column &#39;order_sn&#39; at row 1 ### The error may exist in com/atguigu/gulimall/order/dao/OrderDao.java (best guess) ### The error may involve com.atguigu.gulimall.order.dao.OrderDao.insert-Inline ### The error occurred while setting parameters ### SQL: INSERT INTO oms_order ( integration_amount, order_sn, receiver_province, auto_confirm_day, coupon_amount, modify_time, receiver_phone, pay_amount, delete_status, member_username, member_id, freight_amount, receiver_detail_address, total_amount, integration, growth, promotion_amount, status ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) ### Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column &#39;order_sn&#39; at row 1 ; Data truncation: Data too long for column &#39;order_sn&#39; at row 1; nested exception is com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column &#39;order_sn&#39; at row 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.1.png" alt="image-20220817200247339" tabindex="0" loading="lazy"><figcaption>image-20220817200247339</figcaption></figure><p>查看<code>GulimallOrderApplication</code>服务的控制台，可以发现是·1<code>order_sn</code>字段太长导致的</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-17 <span class="token number">20</span>:01:45.700 ERROR <span class="token number">8480</span> --- <span class="token punctuation">[</span>nio-9000-exec-3<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is org.springframework.dao.DataIntegrityViolationException: 
<span class="token comment">### Error updating database.  Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column &#39;order_sn&#39; at row 1</span>
<span class="token comment">### The error may exist in com/atguigu/gulimall/order/dao/OrderDao.java (best guess)</span>
<span class="token comment">### The error may involve com.atguigu.gulimall.order.dao.OrderDao.insert-Inline</span>
<span class="token comment">### The error occurred while setting parameters</span>
<span class="token comment">### SQL: INSERT INTO oms_order  ( integration_amount, order_sn,   receiver_province,    auto_confirm_day,  coupon_amount, modify_time, receiver_phone,  pay_amount,   delete_status, member_username,    member_id, freight_amount,    receiver_detail_address,     total_amount,   integration, growth, promotion_amount, status )  VALUES  ( ?, ?,   ?,    ?,  ?, ?, ?,  ?,   ?, ?,    ?, ?,    ?,     ?,   ?, ?, ?, ? )</span>
<span class="token comment">### Cause: com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long for column &#39;order_sn&#39; at row 1</span>
<span class="token punctuation">;</span> Data truncation: Data too long <span class="token keyword">for</span> <span class="token function">column</span> <span class="token string">&#39;order_sn&#39;</span> at row <span class="token number">1</span><span class="token punctuation">;</span> nested exception is com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long <span class="token keyword">for</span> <span class="token function">column</span> <span class="token string">&#39;order_sn&#39;</span> at row <span class="token number">1</span><span class="token punctuation">]</span> with root cause

com.mysql.cj.jdbc.exceptions.MysqlDataTruncation: Data truncation: Data too long <span class="token keyword">for</span> <span class="token function">column</span> <span class="token string">&#39;order_sn&#39;</span> at row <span class="token number">1</span>
	at com.mysql.cj.jdbc.exceptions.SQLExceptionsMapping.translateException<span class="token punctuation">(</span>SQLExceptionsMapping.java:104<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mysql-connector-java-8.0.17.jar:8.0.17<span class="token punctuation">]</span>
    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
	at com.sun.proxy.<span class="token variable">$Proxy90</span>.insert<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at com.baomidou.mybatisplus.extension.service.impl.ServiceImpl.save<span class="token punctuation">(</span>ServiceImpl.java:104<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>mybatis-plus-extension-3.2.0.jar:3.2.0<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.saveOrder<span class="token punctuation">(</span>OrderServiceImpl.java:192<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.submitOrder<span class="token punctuation">(</span>OrderServiceImpl.java:154<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>99092a92.invoke<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.2.png" alt="image-20220817200409669" tabindex="0" loading="lazy"><figcaption>image-20220817200409669</figcaption></figure><p>在<code>gulimall_oms</code>数据库的<code>oms_order</code>表里，将<code>order_sn</code>字段的长度从<code>32</code>改为<code>64</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.3.png" alt="image-20220817175736784" tabindex="0" loading="lazy"><figcaption>image-20220817175736784</figcaption></figure><p>在<code>gulimall_oms</code>数据库的<code>oms_order_item</code>表里，将<code>order_sn</code>字段的长度从<code>32</code>改为<code>64</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.4.png" alt="image-20220817180142436" tabindex="0" loading="lazy"><figcaption>image-20220817180142436</figcaption></figure><p>刷新<code>http://order.gulimall.com/toTrade</code>（不用重启任何服务），选择第二个收货地址，点击提交订单，可以看到已经生成了<code>订单号</code>和<code>应付价格</code>，<code>gulimall_oms</code>数据库的<code>oms_order</code>表已经生成了一条订单数据，<code>gulimall_oms</code>数据库的<code>oms_order_item</code>表生成了两条订单项数据</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.5.gif" alt="GIF 2022-8-17 20-15-55" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-17 20-15-55</figcaption></figure><p>此时<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表的<code>华为 HUAWEI Mate30Pro 罗兰紫 8GB+128GB</code>已经锁住了<code>3</code>件库存，<code>苹果手机</code>已经锁了<code>5</code>件库存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.6.png" alt="image-20220817201941776" tabindex="0" loading="lazy"><figcaption>image-20220817201941776</figcaption></figure><p>与 http://order.gulimall.com/toTrade 页面里显示的一样</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.5.6.7.png" alt="image-20220817202717979" tabindex="0" loading="lazy"><figcaption>image-20220817202717979</figcaption></figure><h4 id="_6、完善细节" tabindex="-1"><a class="header-anchor" href="#_6、完善细节" aria-hidden="true">#</a> 6、完善细节</h4><h5 id="_1、添加下单提示信息" tabindex="-1"><a class="header-anchor" href="#_1、添加下单提示信息" aria-hidden="true">#</a> 1、添加下单提示信息</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.OrderWebController</code>类里，修改<code>submitOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/submitOrder&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">submitOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderSubmitVo</span> vo<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">RedirectAttributes</span> redirectAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">SubmitOrderResponseVo</span> responseVo <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">submitOrder</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//下单:去创建订单，验令牌，验价格，锁库存...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseVo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//下单成功来到支付选择页</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;submitOrderResp&quot;</span><span class="token punctuation">,</span>responseVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;pay&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//下单失败回到订单确认页重新确认订单信息</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;下单失败，&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//成功为0,令牌验证失败为1,金额对比失败为2,锁定库存失败为3</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>responseVo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> msg<span class="token operator">+=</span><span class="token string">&quot;订单信息过期，请刷新页面再提交&quot;</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> msg<span class="token operator">+=</span><span class="token string">&quot;订单商品发送变化，请刷新页面重新获取订单信息&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> msg<span class="token operator">+=</span><span class="token string">&quot;库存锁定失败，商品库存不足&quot;</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span> msg<span class="token operator">+=</span><span class="token string">&quot;未知异常，请刷新重试&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        redirectAttributes<span class="token punctuation">.</span><span class="token function">addFlashAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.1.png" alt="image-20220817204257627" tabindex="0" loading="lazy"><figcaption>image-20220817204257627</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，在 http://order.gulimall.com/toTrade 页面里，就显示<code>填写并核对订单信息</code>了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.2.png" alt="image-20220817204530158" tabindex="0" loading="lazy"><figcaption>image-20220817204530158</figcaption></figure><p><s>因为<code>redirectAttributes.addFlashAttribute(&quot;msg&quot;,msg);</code>模拟了<code>session</code>可以在<code>session</code>里获取<code>msg</code></s>（亲测不行），默认给请求域也放了数据直接使用<code>msg</code>也能获取数据</p><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>填写并核对订单信息</code>，修改为如下代码</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>填写并核对订单信息 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${msg!=null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${msg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.3.png" alt="image-20220817210345342" tabindex="0" loading="lazy"><figcaption>image-20220817210345342</figcaption></figure><p>在<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表里，修改锁定的库存数，让库存数和锁定的库存数相等</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.4.png" alt="image-20220817205416928" tabindex="0" loading="lazy"><figcaption>image-20220817205416928</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务，打开 http://order.gulimall.com/toTrade 页面，点击提交订单，提示<code>下单失败，库存锁定失败，商品库存不足</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.5.png" alt="image-20220817210253467" tabindex="0" loading="lazy"><figcaption>image-20220817210253467</figcaption></figure><p>在<code>gulimall_oms</code>数据库的<code>oms_order</code>表里，此时还在创建一个订单</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.6.png" alt="image-20220817210145779" tabindex="0" loading="lazy"><figcaption>image-20220817210145779</figcaption></figure><p>在<code>gulimall_oms</code>数据库的<code>oms_order_item</code>表里，也创建了2个订单项</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.7.png" alt="image-20220817210148087" tabindex="0" loading="lazy"><figcaption>image-20220817210148087</figcaption></figure><p>在<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表里，此时的锁定库存的数量不变</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.1.8.png" alt="image-20220817210806734" tabindex="0" loading="lazy"><figcaption>image-20220817210806734</figcaption></figure><h5 id="_2、完善信息" tabindex="-1"><a class="header-anchor" href="#_2、完善信息" aria-hidden="true">#</a> 2、完善信息</h5><p>在<code>gulimall-order</code>模块的<code>src/main/resources/templates/confirm.html</code>文件里搜索<code>填写并核对订单信息</code>，可以在<code>session</code>中获取<code>msg</code>，在<code>&lt;p&gt;</code>标签里的<code>填写并核对订单信息</code>后面添加<code>&lt;span style=&quot;color: red&quot; th:if=&quot;${session.msg!=null}&quot; th:text=&quot;${session.msg}&quot;&gt;&lt;/span&gt;</code></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>填写并核对订单信息 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${session.msg!=null}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${session.msg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.2.1.png" alt="image-20220817205933229" tabindex="0" loading="lazy"><figcaption>image-20220817205933229</figcaption></figure><p>点击<code>Build</code> -&gt; <code>Recompile &#39;confirm.html&#39;</code> 或按快捷键<code>Ctrl+ Shift+F9</code>，重新编译当前静态文件，显示了错误的消息：<code>请先进行登录</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.2.2.png" alt="image-20220817205821210" tabindex="0" loading="lazy"><figcaption>image-20220817205821210</figcaption></figure><p>而调试是显示<code>&quot;下单失败，库存锁定失败，商品库存不足&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.1.4.6.2.3.png" alt="image-20220817210711752" tabindex="0" loading="lazy"><figcaption>image-20220817210711752</figcaption></figure><p>所以此方法不适用</p><h2 id="_6-2、分布式事务" tabindex="-1"><a class="header-anchor" href="#_6-2、分布式事务" aria-hidden="true">#</a> 6.2、分布式事务</h2><h3 id="_6-2-1、分布式事务理论" tabindex="-1"><a class="header-anchor" href="#_6-2-1、分布式事务理论" aria-hidden="true">#</a> 6.2.1、分布式事务理论</h3><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.0.png" alt="image-20220817212136730" tabindex="0" loading="lazy"><figcaption>image-20220817212136730</figcaption></figure><p><strong>事务保证：</strong></p><p>1、订单服务异常，库存锁定不运行，全部回滚， 撤销操作</p><p>2、库存服务事务自治，锁定失败全部回滚，订单感受到异常，继续回滚</p><p>3、库存服务锁定成功了，但是网络原因返回数据途中问题？</p><p>订单服务检测到报了<code>READ TIMEOUT</code>读取超时异常，订单服务回滚了，而库存服务没回滚</p><p>4、库存服务锁定成功了，库存服务下面的逻辑发生故障，订单回滚了，怎么处理？</p><p>此时订单服务回滚了，而库存服务没有回滚</p><p><strong>利用消息队列实 现最终一致</strong></p><p>库存服务锁定成功后发给消息队列消息（当前库存工作单），过段时间自动解锁，解锁时先查询 订单的支付状态。解锁成功修改库存工作单详情 项状态为已解锁</p><p>1、远程服务假失败：</p><p>远程服务其实成功了，由于网络故障等没有返回 导致：订单回滚，库存却扣减</p><p>2、远程服务执行完成，下面的其他方法出现问题</p><p>导致：已执行的远程请求，肯定不能回滚</p><p>本地事务，在分布式系统，只能控制住自己的回滚，控制不了其他服务的回滚 分布式事务: 最大原因。网络问题+分布式机器。</p><p>同一个Service也可以，只不过调用不能直接调，需要把当前Service通过@AutoWired注入进来调用，不过会循环依赖</p><p><strong>本地事务失效问题</strong> 同一个对象内事务方法互调默认失效，原因绕过了代理对象，事务使用代理对象来控制的 解决:使用代理对象来调用事务方法 1)、引入<code>aop-starter</code>；<code>spring-boot-starter-aop</code> 引入了<code>aspectj</code> 2)、<code>@EnableAspectJAutoProxy(exposeProxy = true)</code>开启<code>aspectj</code>动态代理功能。以后所有的动态代理都是<code>aspectj</code>创建的。(即使没有接口也可以创建动态代理) 对外暴露代理对象，然后本类互调用代理对象</p><h4 id="_1、本地事务" tabindex="-1"><a class="header-anchor" href="#_1、本地事务" aria-hidden="true">#</a> 1、本地事务</h4><h5 id="_1、事务的基本性质" tabindex="-1"><a class="header-anchor" href="#_1、事务的基本性质" aria-hidden="true">#</a> 1、事务的基本性质</h5><p>数据库事务的几个特性：原子性(Atomicity )、一致性( Consistency )、隔离性或独立性( Isolation) 和持久性(Durabilily)，简称就是 ACID；</p><ul><li><p>原子性：一系列的操作整体不可拆分，要么同时成功，要么同时失败</p></li><li><p>一致性：数据在事务的前后，业务整体一致。</p><ul><li>转账。A:1000；B:1000； 转 200 事务成功; A：800 B：1200</li></ul></li><li><p>隔离性：事务之间互相隔离。</p></li><li><p>持久性：一旦事务成功，数据一定会落盘在数据库。</p></li></ul><p>在以往的单体应用中，我们多个业务操作使用同一条连接操作不同的数据表，一旦有异常， 我们可以很容易的整体回滚； Business：我们具体的业务代码Storage：库存业务代码；扣库存Order：订单业务代码；保存订单Account：账号业务代码；减账户余额 比如买东西业务，扣库存，下订单，账户扣款，是一个整体；必须同时成功或者失败 一个事务开始，代表以下的所有操作都在同一个连接里面；</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.1.1.png" alt="image-20220818091044010" tabindex="0" loading="lazy"><figcaption>image-20220818091044010</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">REPEATABLE_READ</span><span class="token punctuation">,</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_2、事务的隔离级别" tabindex="-1"><a class="header-anchor" href="#_2、事务的隔离级别" aria-hidden="true">#</a> 2、事务的隔离级别</h5><p>READ UNCOMMITTED（读未提交） 该隔离级别的事务会读到其它未提交事务的数据，此现象也称之为脏读。 READ COMMITTED（读已提交） 一个事务可以读取另一个已提交的事务，多次读取会造成不一样的结果，此现象称为不可重 复读问题，Oracle 和 SQL Server 的默认隔离级别。 REPEATABLE READ（可重复读） 该隔离级别是 MySQL 默认的隔离级别，在同一个事务里，select 的结果是事务开始时时间点的状态，因此，同样的 select 操作读到的结果会是一致的，但是，会有幻读现象。MySQL 的 InnoDB 引擎可以通过 next-key locks 机制（参考下文&quot;行锁的算法&quot;一节）来避免幻读。 SERIALIZABLE（序列化） 在该隔离级别下事务都是串行顺序执行的，MySQL 数据库的 InnoDB 引擎会给读操作隐式加一把读共享锁，从而避免了脏读、不可重读复读和幻读问题。</p><h5 id="_3、事务的传播行为" tabindex="-1"><a class="header-anchor" href="#_3、事务的传播行为" aria-hidden="true">#</a> 3、事务的传播行为</h5><p>1、<code>PROPAGATION_REQUIRED</code>：如果当前没有事务，就创建一个新事务，如果当前存在事务， 就加入该事务，该设置是最常用的设置。 2、<code>PROPAGATION_SUPPORTS</code>：支持当前事务，如果当前存在事务，就加入该事务，如果当 前不存在事务，就以非事务执行。 3、<code>PROPAGATION_MANDATORY</code>：支持当前事务，如果当前存在事务，就加入该事务，如果当前不存在事务，就抛出异常。 4、<code>PROPAGATION_REQUIRES_NEW</code>：创建新事务，无论当前存不存在事务，都创建新事务。 5、<code>PROPAGATION_NOT_SUPPORTED</code>：以非事务方式执行操作，如果当前存在事务，就把当 前事务挂起。 6、<code>PROPAGATION_NEVER</code>：以非事务方式执行，如果当前存在事务，则抛出异常。 7、<code>PROPAGATION_NESTED</code>：如果当前存在事务，则在嵌套事务内执行。如果当前没有事务， 则执行与 PROPAGATION_REQUIRED 类似的操作。</p><h5 id="_4、springboot-事务关键点" tabindex="-1"><a class="header-anchor" href="#_4、springboot-事务关键点" aria-hidden="true">#</a> 4、SpringBoot 事务关键点</h5><p>1、事务的自动配置 <code>TransactionAutoConfiguration</code> 2、事务的坑 在同一个类里面，编写两个方法，内部调用的时候，会导致事务设置失效。原因是没有用到代理对象的缘故。解决： 1）、导入 <code>spring-boot-starter-aop</code> 2）、<code>@EnableTransactionManagement(proxyTargetClass = true)</code> 3）、<code>@EnableAspectJAutoProxy(exposeProxy=true)</code> 4）、<code>AopContext.currentProxy()</code> 调用方法</p><h4 id="_2、分布式事务" tabindex="-1"><a class="header-anchor" href="#_2、分布式事务" aria-hidden="true">#</a> 2、分布式事务</h4><h5 id="_1、为什么有分布式事务" tabindex="-1"><a class="header-anchor" href="#_1、为什么有分布式事务" aria-hidden="true">#</a> 1、为什么有分布式事务</h5><p>分布式系统经常出现的异常 机器宕机、网络异常、消息丢失、消息乱序、数据错误、不可靠的 TCP、存储数据丢失...</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.2.1.png" alt="image-20220818091630425" tabindex="0" loading="lazy"><figcaption>image-20220818091630425</figcaption></figure><p>分布式事务是企业集成中的一个技术难点，也是每一个分布式系统架构中都会涉及到的一个东西，特别是在微服务架构中，几乎可以说是无法避免。</p><h5 id="_2、cap-定理与-base-理论" tabindex="-1"><a class="header-anchor" href="#_2、cap-定理与-base-理论" aria-hidden="true">#</a> 2、CAP 定理与 BASE 理论</h5><p>1、CAP 定理 CAP 原则又称 CAP 定理，指的是在一个分布式系统中</p><ul><li><p>一致性（Consistency）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访 问同一份最新的数据副本）</p></li><li><p>可用性（Availability）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据 更新具备高可用性）</p></li><li><p>分区容错性（Partition tolerance）：大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务 器放在美国，这就是两个区，它们之间可能无法通信。</p></li></ul><p>CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.2.2.png" alt="image-20220818091656130" tabindex="0" loading="lazy"><figcaption>image-20220818091656130</figcaption></figure><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们， 剩下的 C 和 A 无法同时做到。 分布式系统中实现一致性的 raft 算法、paxos</p><p>raft算法动画演示： http://thesecretlivesofdata.com/raft/</p><p>2、面临的问题</p><p>对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，所 以节点故障、网络故障是常态，而且要保证服务可用性达到 99.99999%（N 个 9），即保证P 和 A，舍弃 C。</p><h5 id="_3、base-理论" tabindex="-1"><a class="header-anchor" href="#_3、base-理论" aria-hidden="true">#</a> 3、BASE 理论</h5><p>是对 CAP 理论的延伸，思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但可以采用适当的采取弱一致性，即最终一致性。BASE 是指</p><ul><li><p>基本可用（Basically Available） 基本可用是指分布式系统在出现故障的时候，允许损失部分可用性（例如响应时间、 功能上的可用性），允许损失部分可用性。需要注意的是，基本可用绝不等价于系统不可用。 响应时间上的损失：正常情况下搜索引擎需要在 0.5 秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询 结果的响应时间增加到了 1~2 秒。 功能上的损失：购物网站在购物高峰（如双十一）时，为了保护系统的稳定性， 部分消费者可能会被引导到一个降级页面。</p></li><li><p>软状态（ Soft State） 软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布 式存储中一般一份数据会有多个副本，允许不同副本同步的延时就是软状态的体 现。mysql replication 的异步复制也是一种体现。</p></li><li><p>最终一致性（ Eventual Consistency） 最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状 态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。</p></li></ul><h5 id="_4、强一致性、弱一致性、最终一致性" tabindex="-1"><a class="header-anchor" href="#_4、强一致性、弱一致性、最终一致性" aria-hidden="true">#</a> 4、强一致性、弱一致性、最终一致性</h5><p>从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性。对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。如果能容忍后续的部分或者全部访问不到，则是弱一致性。如果经过一段时间后要求 能访问到更新后的数据，则是最终一致性</p><p><a href="code/6.2.1.3.txt">点击老师讲的文字</a></p><h4 id="_3、分布式事务几种方案" tabindex="-1"><a class="header-anchor" href="#_3、分布式事务几种方案" aria-hidden="true">#</a> 3、分布式事务几种方案</h4><h5 id="_1、2pc-模式" tabindex="-1"><a class="header-anchor" href="#_1、2pc-模式" aria-hidden="true">#</a> 1、2PC 模式</h5><p>数据库支持的 2PC【2 phase commit 二阶提交】，又叫做 XA Transactions。MySQL 从 5.5 版本开始支持，SQL Server 2005 开始支持，Oracle 7 开始支持。其中，XA 是一个两阶段提交协议，该协议分为以下两个阶段： 第一阶段：事务协调器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是否可以提交. 第二阶段：事务协调器要求每个数据库提交数据。 其中，如果有任何一个数据库否决此次提交，那么所有数据库都会被要求回滚它们在此事务中的那部分信息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.3.1.png" alt="image-20220818115351211" tabindex="0" loading="lazy"><figcaption>image-20220818115351211</figcaption></figure><ul><li><p>XA 协议比较简单，而且一旦商业数据库实现了 XA 协议，使用分布式事务的成本也比较低。</p></li><li><p>XA 性能不理想，特别是在交易下单链路，往往并发量很高，XA 无法满足高并发场景</p></li><li><p>XA 目前在商业数据库支持的比较理想，在 mysql 数据库中支持的不太理想，mysql 的 XA 实现，没有记录 prepare 阶段日志，主备切换回导致主库与备库数据不一致。</p></li><li><p>许多 nosql 也没有支持 XA，这让 XA 的应用场景变得非常狭隘。</p></li><li><p>也有 3PC，引入了超时机制（无论协调者还是参与者，在向对方发送请求后，若长时间未收到回应则做出相应处理）</p></li></ul><h5 id="_2、柔性事务-tcc-事务补偿型方案" tabindex="-1"><a class="header-anchor" href="#_2、柔性事务-tcc-事务补偿型方案" aria-hidden="true">#</a> 2、柔性事务-TCC 事务补偿型方案</h5><p>刚性事务：遵循 ACID 原则，强一致性。 柔性事务：遵循 BASE 理论，最终一致性； 与刚性事务不同，柔性事务允许一定时间内，不同节点的数据不一致，但要求最终一致。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.3.2.1.png" alt="image-20220818151958893" tabindex="0" loading="lazy"><figcaption>image-20220818151958893</figcaption></figure><p>一阶段 prepare 行为：调用 自定义 的 prepare 逻辑。</p><p>二阶段 commit 行为：调用 自定义 的 commit 逻辑。</p><p>二阶段 rollback 行为：调用 自定义 的 rollback 逻辑。 所谓 TCC 模式，是指支持把 自定义的分支事务纳入到全局事务的管理中。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.1.3.2.2.png" alt="image-20220818152019083" tabindex="0" loading="lazy"><figcaption>image-20220818152019083</figcaption></figure><h5 id="_3、柔性事务-最大努力通知型方案" tabindex="-1"><a class="header-anchor" href="#_3、柔性事务-最大努力通知型方案" aria-hidden="true">#</a> 3、柔性事务-最大努力通知型方案</h5><p>按规律进行通知，不保证数据一定能通知成功，但会提供可查询操作接口进行核对。这种 方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。这种方案也是结合 MQ 进行实现，例如：通过 MQ 发送 http 请求，设置最大通知次数。达到通知次数后即不再通知。 案例：银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对账文件），支付宝的支付成功异步回调</p><h5 id="_4、柔性事务-可靠消息-最终一致性方案-异步确保型" tabindex="-1"><a class="header-anchor" href="#_4、柔性事务-可靠消息-最终一致性方案-异步确保型" aria-hidden="true">#</a> 4、柔性事务-可靠消息+最终一致性方案（异步确保型）</h5><p>实现：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只 记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确 认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。 防止消息丢失：</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>/**
 *1、做好消息确认机制（pulisher，consumer【手动ack】）
 *2、每一个发送的消息都在数据库做好记录。定期将失败的消息再次发送一遍
 */
CREATE TABLE `mq_message` (
`message_id` char(32) NOT NULL,
`content` text,
`to_exchane` varchar(255) DEFAULT NULL,
`routing_key` varchar(255) DEFAULT NULL,
`class_type` varchar(255) DEFAULT NULL,
`message_status` int(1) DEFAULT &#39;0&#39; COMMENT &#39;0-新建 1-已发送 2-错误抵达 3-已抵达&#39;,
`create_time` datetime DEFAULT NULL,
`update_time` datetime DEFAULT NULL, PRIMARY KEY (`message_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-2、seata做分布式事务" tabindex="-1"><a class="header-anchor" href="#_6-2-2、seata做分布式事务" aria-hidden="true">#</a> 6.2.2、Seata做分布式事务</h3><h4 id="_1、seata-简介" tabindex="-1"><a class="header-anchor" href="#_1、seata-简介" aria-hidden="true">#</a> 1、Seata 简介</h4><h5 id="_1、简介" tabindex="-1"><a class="header-anchor" href="#_1、简介" aria-hidden="true">#</a> 1、简介</h5><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p><p><a href="/gulimall/code/6.2.2-Seata.html" class="">点击查看完整介绍</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.1.1.png" alt="145942191-7a2d469f-94c8-4cd2-8c7e-46ad75683636" tabindex="0" loading="lazy"><figcaption>145942191-7a2d469f-94c8-4cd2-8c7e-46ad75683636</figcaption></figure><h5 id="_2、spring-cloud-中使用-seata" tabindex="-1"><a class="header-anchor" href="#_2、spring-cloud-中使用-seata" aria-hidden="true">#</a> 2、Spring Cloud 中使用 Seata</h5><p>Spring Cloud 中使用 Seata，使用 Feign 实现远程调用，使用 Spring Jpa 访问 MySQL 数据库</p><h6 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作" aria-hidden="true">#</a> 准备工作</h6><ol><li>执行<code>sql/all_in_one.sql</code></li><li>下载最新版本的 <a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener noreferrer">Seata Sever<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>解压并启动 Seata server</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>unzip seata-server-xxx.zip

cd distribution
sh ./bin/seata-server.sh 8091 file
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>启动 Account, Order, Stock, Business 服务</li></ol><blockquote><p>数据库配置的用户名和密码是 <code>root</code>和<code>123456</code>，因为没有使用注册中心，所有的 Feign 的配置都是 <code>127.0.0.1+端口</code>，如果不同请手动修改</p></blockquote><h6 id="测试" tabindex="-1"><a class="header-anchor" href="#测试" aria-hidden="true">#</a> 测试</h6><ul><li>无错误成功提交</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>curl http://127.0.0.1:8084/purchase/commit
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>完成后可以看到数据库中 <code>account_tbl</code>的<code>id</code>为1的<code>money</code>会减少 5，<code>order_tbl</code>中会新增一条记录，<code>stock_tbl</code>的<code>id</code>为1的<code>count</code>字段减少 1</p><ul><li>发生异常事务回滚</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>curl http://127.0.0.1:8084/purchase/rollback
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时 account-service 会抛出异常，发生回滚，待完成后数据库中的数据没有发生变化，回滚成功</p><h6 id="注意" tabindex="-1"><a class="header-anchor" href="#注意" aria-hidden="true">#</a> 注意</h6><ul><li>注入 DataSourceProxy</li></ul><p>因为 Seata 通过代理数据源实现分支事务，如果没有注入，事务无法成功回滚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DruidDataSource</span> <span class="token function">druidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 需要将 DataSourceProxy 设置为主数据源，否则事务无法回滚
     *
     * <span class="token keyword">@param</span> <span class="token parameter">druidDataSource</span> The DruidDataSource
     * <span class="token keyword">@return</span> The default datasource
     */</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;dataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DruidDataSource</span> druidDataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>druidDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>file.conf 的 service.vgroup_mapping 配置必须和<code>spring.application.name</code>一致</li></ul><p>在 <code>org.springframework.cloud:spring-cloud-starter-alibaba-seata</code> 的<code>org.springframework.cloud.alibaba.seata.GlobalTransactionAutoConfiguration</code> 类中，默认会使用 <code>${spring.application.name}-fescar-service-group</code>作为服务名注册到 Seata Server上，如果和<code>file.conf</code> 中的配置不一致，会提示 <code>no available server to connect</code>错误</p><p>也可以通过配置 <code>spring.cloud.alibaba.seata.tx-service-group</code>修改后缀，但是必须和<code>file.conf</code>中的配置保持一致</p><h4 id="_2、使用" tabindex="-1"><a class="header-anchor" href="#_2、使用" aria-hidden="true">#</a> 2、使用</h4><h5 id="_1、执行sql" tabindex="-1"><a class="header-anchor" href="#_1、执行sql" aria-hidden="true">#</a> 1、执行sql</h5><p>在<code>gulimall_wms</code>数据库中执行如下<code>sql</code>（这个<code>gulimall_wms</code>数据库已经有<code>undo_log</code>表了，就不用执行了）</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  `ext` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>gulimall_wms</code>数据库中已经有这个<code>undo_log</code>表了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.1.1.png" alt="image-20220818155419144" tabindex="0" loading="lazy"><figcaption>image-20220818155419144</figcaption></figure><p>在<code>gulimall_ums</code>数据库中执行刚刚的<code>sql</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.1.2.png" alt="image-20220818155747126" tabindex="0" loading="lazy"><figcaption>image-20220818155747126</figcaption></figure><p>在<code>gulimall_sms</code>数据库中执行刚刚的<code>sql</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.1.3.png" alt="image-20220818155611118" tabindex="0" loading="lazy"><figcaption>image-20220818155611118</figcaption></figure><p>在<code>gulimall_pms</code>数据库中执行刚刚的<code>sql</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.1.4.png" alt="image-20220818155647377" tabindex="0" loading="lazy"><figcaption>image-20220818155647377</figcaption></figure><p>在<code>gulimall_oms</code>数据库中执行刚刚的<code>sql</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.1.5.png" alt="image-20220818155831850" tabindex="0" loading="lazy"><figcaption>image-20220818155831850</figcaption></figure><p>在<code>gulimall_admin</code>数据库中执行刚刚的<code>sql</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.1.6.png" alt="image-20220818155909811" tabindex="0" loading="lazy"><figcaption>image-20220818155909811</figcaption></figure><h5 id="_2、添加seata依赖" tabindex="-1"><a class="header-anchor" href="#_2、添加seata依赖" aria-hidden="true">#</a> 2、添加seata依赖</h5><p>在<code>gulimall-common</code>模块的<code>pom.xml</code>文件里添加seata依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--导入seata--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.2.1.png" alt="image-20220818161033208" tabindex="0" loading="lazy"><figcaption>image-20220818161033208</figcaption></figure><p>导入这个依赖后，会自动导入<code>spring-cloud-alibaba-seata-2.1.0.RELEASE.jar</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.2.2.png" alt="image-20220818161335491" tabindex="0" loading="lazy"><figcaption>image-20220818161335491</figcaption></figure><p>和<code>seata-all-0.7.1.jar</code>，需要注意<code>seata-all-0.7.1.jar</code>的版本和<code>seata-server</code>的版本需要一致</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.2.3.png" alt="image-20220818161530665" tabindex="0" loading="lazy"><figcaption>image-20220818161530665</figcaption></figure><h5 id="_3、启动seata-server" tabindex="-1"><a class="header-anchor" href="#_3、启动seata-server" aria-hidden="true">#</a> 3、启动seata-server</h5><p>在<code>seata-server-0.7.1\conf\registry.conf</code>文件里，把<code>registry</code>里的<code>type = &quot;file&quot;</code>修改为<code>type = &quot;nacos&quot;</code>，把<code>registry</code>-&gt;<code>nacos</code>里的<code>serverAddr = &quot;localhost&quot;</code>修改为<code>serverAddr = &quot;localhost:8848&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.3.1.png" alt="image-20220818162116026" tabindex="0" loading="lazy"><figcaption>image-20220818162116026</figcaption></figure><p>还可以指定配置中心，如果指定配置中心，需要把<code>file.conf</code>文件复制到配置中心里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.3.2.png" alt="image-20220818162616787" tabindex="0" loading="lazy"><figcaption>image-20220818162616787</figcaption></figure><p>双击<code>seata-server-0.7.1\bin\seata-server.bat</code>即可启动<code>seata-server</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.3.3.png" alt="image-20220818163200656" tabindex="0" loading="lazy"><figcaption>image-20220818163200656</figcaption></figure><p>打开<code>nacos</code>里的<code>服务管理</code>-&gt;<code>服务列表</code>即可看到<code>serverAddr</code>已经启动了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.2.3.4.png" alt="image-20220818163047179" tabindex="0" loading="lazy"><figcaption>image-20220818163047179</figcaption></figure><h4 id="_3、查看源码" tabindex="-1"><a class="header-anchor" href="#_3、查看源码" aria-hidden="true">#</a> 3、查看源码</h4><p>在<code>DataSourceAutoConfiguration</code>类里，<code>SpringBoot</code>默认会导入<code>DataSourceConfiguration.Hikari.class</code>数据源</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token class-name">PooledDataSourceCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">XADataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Hikari</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Tomcat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
      <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Dbcp2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DataSourceConfiguration<span class="token punctuation">.</span>Generic</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
      <span class="token class-name">DataSourceJmxConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PooledDataSourceConfiguration</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.3.1.png" alt="image-20220818164907224" tabindex="0" loading="lazy"><figcaption>image-20220818164907224</figcaption></figure><p>如果容器中没有<code>DataSource.class</code>会把<code>HikariDataSource</code>类放入到容器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Hikari DataSource configuration.
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.type&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;com.zaxxer.hikari.HikariDataSource&quot;</span><span class="token punctuation">,</span>
      matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Hikari</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.hikari&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">HikariDataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HikariDataSource</span> dataSource <span class="token operator">=</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         dataSource<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.3.2.png" alt="image-20220818165116524" tabindex="0" loading="lazy"><figcaption>image-20220818165116524</figcaption></figure><p>创建<code>HikariDataSource</code>类时需要传递一个<code>DataSourceProperties</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.3.3.png" alt="image-20220818165912216" tabindex="0" loading="lazy"><figcaption>image-20220818165912216</figcaption></figure><p><code>org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</code>类使用了<code>@EnableConfigurationProperties(DataSourceProperties.class)</code>注解，把<code>DataSourceProperties.class</code>放入了容器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.3.4.png" alt="image-20220818165508302" tabindex="0" loading="lazy"><figcaption>image-20220818165508302</figcaption></figure><p>初始化<code>HikariDataSource</code>数据源时，调用的是<code>createDataSource(properties, HikariDataSource.class);</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Hikari DataSource configuration.
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.type&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;com.zaxxer.hikari.HikariDataSource&quot;</span><span class="token punctuation">,</span>
      matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Hikari</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.hikari&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">HikariDataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HikariDataSource</span> dataSource <span class="token operator">=</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         dataSource<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.3.5.png" alt="image-20220818165840949" tabindex="0" loading="lazy"><figcaption>image-20220818165840949</figcaption></figure><p>调的其实就是<code>DataSourceProperties</code>类的<code>initializeDataSourceBuilder().type(type).build();</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataSource</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.3.6.png" alt="image-20220818170034216" tabindex="0" loading="lazy"><figcaption>image-20220818170034216</figcaption></figure><h4 id="_4、修改配置" tabindex="-1"><a class="header-anchor" href="#_4、修改配置" aria-hidden="true">#</a> 4、修改配置</h4><h5 id="_1、指定数据源" tabindex="-1"><a class="header-anchor" href="#_1、指定数据源" aria-hidden="true">#</a> 1、指定数据源</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包里新建<code>MySeataConfig</code>类，用于配置<code>Seata</code>相关的配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>zaxxer<span class="token punctuation">.</span>hikari<span class="token punctuation">.</span></span><span class="token class-name">HikariDataSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>seata<span class="token punctuation">.</span>rm<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceProxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/18
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySeataConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">HikariDataSource</span> dataSource <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataSource<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.4.1.png" alt="image-20220818171744943" tabindex="0" loading="lazy"><figcaption>image-20220818171744943</figcaption></figure><h5 id="_2、复制配置" tabindex="-1"><a class="header-anchor" href="#_2、复制配置" aria-hidden="true">#</a> 2、复制配置</h5><p>把<code>seata-server-0.7.1\conf</code>里的<code>file.conf</code>和<code>registry.conf</code>复制到<code>gulimall-order</code>模块的<code>src/main/resources</code>里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.4.2.1.png" alt="image-20220818172909335" tabindex="0" loading="lazy"><figcaption>image-20220818172909335</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>src/main/resources/file.conf</code>文件里，把<code>vgroup_mapping.my_test_tx_group = &quot;default&quot;</code>修改为<code>vgroup_mapping.gulimall-order-fescar-service-group = &quot;default&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.4.2.2.png" alt="image-20220818184329694" tabindex="0" loading="lazy"><figcaption>image-20220818184329694</figcaption></figure><p>复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MySeataConfig</code>类到<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.config</code>包里</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.4.2.3.png" alt="image-20220818184546107" tabindex="0" loading="lazy"><figcaption>image-20220818184546107</figcaption></figure><p>把<code>seata-server-0.7.1\conf</code>里的<code>file.conf</code>和<code>registry.conf</code>也复制一份到<code>gulimall-ware</code>模块的<code>src/main/resources</code>里，并把<code>vgroup_mapping.my_test_tx_group = &quot;default&quot;</code>修改为<code>vgroup_mapping.gulimall-ware-fescar-service-group = &quot;default&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.4.2.4.png" alt="image-20220818184940343" tabindex="0" loading="lazy"><figcaption>image-20220818184940343</figcaption></figure><h4 id="_5、使用分布式事务" tabindex="-1"><a class="header-anchor" href="#_5、使用分布式事务" aria-hidden="true">#</a> 5、使用分布式事务</h4><h5 id="_1、简单使用" tabindex="-1"><a class="header-anchor" href="#_1、简单使用" aria-hidden="true">#</a> 1、简单使用</h5><p>在需要使用分布式事务的入口业务方法上添加<code>@GlobalTransactional</code>注解和<code>@Transactional</code>注解。</p><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>submitOrder</code>方法上<code>@Transactional</code>注解已经添加了，因此只需再添加<code>@GlobalTransactional</code>注解即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.1.1.png" alt="image-20220818185642556" tabindex="0" loading="lazy"><figcaption>image-20220818185642556</figcaption></figure><p>在调用远程服务的业务方法只需使用<code>@Transactional</code>注解即可（在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>orderLockStock</code>方法这里已经使用<code>@Transactional</code>注解了，不需要再进行额外的配置）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.1.2.png" alt="image-20220818190151638" tabindex="0" loading="lazy"><figcaption>image-20220818190151638</figcaption></figure><h5 id="_2、服务启动失败" tabindex="-1"><a class="header-anchor" href="#_2、服务启动失败" aria-hidden="true">#</a> 2、服务启动失败</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>submitOrder</code>方法里，在<code>response.setOrder(orderCreateTo.getOrder());</code>的下面添加<code>int i = 10/0;</code>，用于抛出除0异常，在<code>else</code>里的<code>response.setCode(3);</code>下面注释掉<code>return response;</code>，并在<code>response.setCode(3);</code>下面添加<code>throw new RuntimeException(&quot;锁定库存失败&quot;);</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.2.1.png" alt="image-20220818202903270" tabindex="0" loading="lazy"><figcaption>image-20220818202903270</figcaption></figure><p>重新启动所有服务后，<code>GulimallThirdPartyApplication</code>、<code>GulimallGatewayApplication</code>、<code>GulimallMemberApplication</code>三个服务都启动失败了，这是因为这些服务都引入了<code>gulimall-common</code>的依赖，所以也引入了<code>seata</code>依赖，但这些服务并没有配置<code>seata</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.2.2.png" alt="image-20220818190618762" tabindex="0" loading="lazy"><figcaption>image-20220818190618762</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>pom.xml</code>文件里，注释掉对<code>seata</code>的依赖</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.2.3.png" alt="image-20220818191022555" tabindex="0" loading="lazy"><figcaption>image-20220818191022555</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件的<code>&lt;dependencies&gt;</code>里添加<code>seata</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--导入seata--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>gulimall-order</code>模块的<code>pom.xml</code>文件的<code>&lt;dependencyManagement&gt;</code>的<code>&lt;dependencies&gt;</code>里对阿里巴巴的依赖进行版本管理</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.2.4.png" alt="image-20220818192536651" tabindex="0" loading="lazy"><figcaption>image-20220818192536651</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>pom.xml</code>文件的<code>&lt;dependencies&gt;</code>里添加<code>seata</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--导入seata--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>gulimall-ware</code>模块的<code>pom.xml</code>文件的<code>&lt;dependencyManagement&gt;</code>的<code>&lt;dependencies&gt;</code>里对阿里巴巴的依赖进行版本管理</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.2.5.png" alt="image-20220818192605132" tabindex="0" loading="lazy"><figcaption>image-20220818192605132</figcaption></figure><h5 id="_3、端口被占用" tabindex="-1"><a class="header-anchor" href="#_3、端口被占用" aria-hidden="true">#</a> 3、端口被占用</h5><p>启动<code>GulimallProductApplication</code>服务时在控制台报了<code>10000</code>端口被占用的异常</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Error starting ApplicationContext. To display the conditions report re-run your application with <span class="token string">&#39;debug&#39;</span> enabled.
<span class="token number">2022</span>-08-18 <span class="token number">19</span>:40:09.633 ERROR <span class="token number">7888</span> --- <span class="token punctuation">[</span>  restartedMain<span class="token punctuation">]</span> o.s.b.d.LoggingFailureAnalysisReporter   <span class="token builtin class-name">:</span> 

***************************
APPLICATION FAILED TO START
***************************

Description:

The Tomcat connector configured to listen on port <span class="token number">10000</span> failed to start. The port may already be <span class="token keyword">in</span> use or the connector may be misconfigured.

Action:

Verify the connector<span class="token string">&#39;s configuration, identify and stop any process that&#39;</span>s listening on port <span class="token number">10000</span>, or configure this application to listen on another port.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.3.1.png" alt="image-20220818194544347" tabindex="0" loading="lazy"><figcaption>image-20220818194544347</figcaption></figure><p>在<code>gulimall-product</code>模块的<code>src/main/resources/application.yml</code>文件里修改端口为<code>10001</code></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.3.2.png" alt="image-20220818194633417" tabindex="0" loading="lazy"><figcaption>image-20220818194633417</figcaption></figure><h5 id="_4、seata不支持异常" tabindex="-1"><a class="header-anchor" href="#_4、seata不支持异常" aria-hidden="true">#</a> 4、seata不支持异常</h5><p>重启完各个服务后，在 http://order.gulimall.com/toTrade 页面里提交订单，来到 http://order.gulimall.com/submitOrder 页面，又报错了</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Whitelabel Error Page
This application has no explicit mapping for /error, so you are seeing this as a fallback.

Thu Aug 18 19:47:42 CST 2022
There was an unexpected error (type=Internal Server Error, status=500).
### Error updating database. Cause: io.seata.common.exception.NotSupportYetException ### The error may exist in com/atguigu/gulimall/order/dao/OrderItemDao.java (best guess) ### The error may involve com.atguigu.gulimall.order.dao.OrderItemDao.insert-Inline ### The error occurred while setting parameters ### SQL: INSERT INTO oms_order_item ( sku_attrs_vals, spu_name, integration_amount, order_sn, sku_price, gift_integration, real_amount, sku_quantity, sku_name, spu_brand, coupon_amount, sku_pic, spu_id, gift_growth, promotion_amount, sku_id, category_id ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) ### Cause: io.seata.common.exception.NotSupportYetException
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.4.1.png" alt="image-20220818194816721" tabindex="0" loading="lazy"><figcaption>image-20220818194816721</figcaption></figure><p>查看<code>GulimallOrderApplication</code>服务的控制台，可以看到<code>OrderServiceImpl.java</code>文件的<code>203</code>行报错了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-18 <span class="token number">19</span>:47:42.779 ERROR <span class="token number">16064</span> --- <span class="token punctuation">[</span>nio-9000-exec-2<span class="token punctuation">]</span> o.a.c.c.C.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>.<span class="token punctuation">[</span>/<span class="token punctuation">]</span>.<span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span>    <span class="token builtin class-name">:</span> Servlet.service<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> <span class="token keyword">in</span> context with path <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span>Request processing failed<span class="token punctuation">;</span> nested exception is org.apache.ibatis.exceptions.PersistenceException: 
<span class="token comment">### Error updating database.  Cause: io.seata.common.exception.NotSupportYetException</span>
<span class="token comment">### The error may exist in com/atguigu/gulimall/order/dao/OrderItemDao.java (best guess)</span>
<span class="token comment">### The error may involve com.atguigu.gulimall.order.dao.OrderItemDao.insert-Inline</span>
<span class="token comment">### The error occurred while setting parameters</span>
<span class="token comment">### SQL: INSERT INTO oms_order_item  ( sku_attrs_vals, spu_name, integration_amount, order_sn,  sku_price,  gift_integration, real_amount, sku_quantity, sku_name, spu_brand, coupon_amount, sku_pic, spu_id, gift_growth, promotion_amount, sku_id, category_id )  VALUES  ( ?, ?, ?, ?,  ?,  ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )</span>
<span class="token comment">### Cause: io.seata.common.exception.NotSupportYetException] with root cause</span>

io.seata.common.exception.NotSupportYetException: null
	at io.seata.rm.datasource.AbstractPreparedStatementProxy.addBatch<span class="token punctuation">(</span>AbstractPreparedStatementProxy.java:252<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>seata-all-0.7.1.jar:0.7.1<span class="token punctuation">]</span>
	<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
	org.springframework.aop.framework.CglibAopProxy<span class="token variable">$DynamicAdvisedInterceptor</span>.intercept<span class="token punctuation">(</span>CglibAopProxy.java:688<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderItemServiceImpl<span class="token variable">$$</span>EnhancerBySpringCGLIB<span class="token variable">$$</span>e1e4ea49.saveBatch<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.saveOrder<span class="token punctuation">(</span>OrderServiceImpl.java:203<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl.submitOrder<span class="token punctuation">(</span>OrderServiceImpl.java:163<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.order.service.impl.OrderServiceImpl<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>99092a92.invoke<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.4.2.png" alt="image-20220818194913810" tabindex="0" loading="lazy"><figcaption>image-20220818194913810</figcaption></figure><p>貌似是seata不支持批量保存，在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里修改<code>saveOrder</code>方法，将批量保存修改为<code>for</code>循环单个保存</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 保存订单数据
 *
 * <span class="token keyword">@param</span> <span class="token parameter">orderCreateTo</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateTo</span> orderCreateTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setModifyTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItemEntity</span> orderItem <span class="token operator">:</span> orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrderItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        orderItemService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.4.3.png" alt="image-20220818201239848" tabindex="0" loading="lazy"><figcaption>image-20220818201239848</figcaption></figure><h5 id="_5、获取schema失败" tabindex="-1"><a class="header-anchor" href="#_5、获取schema失败" aria-hidden="true">#</a> 5、获取schema失败</h5><p>在<code>GulimallWareApplication</code>服务的控制台报了如下两个主要错误</p><p><a href="code/6.2.2.5.5.log">点击查看完整报错信息</a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>java.sql.SQLException: Failed to fetch schema of gulimall_wms.wms_ware_sku
	at io.seata.rm.datasource.sql.struct.TableMetaCache.fetchSchemeInDefaultWay<span class="token punctuation">(</span>TableMetaCache.java:115<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>seata-all-0.7.1.jar:0.7.1<span class="token punctuation">]</span>
	at io.seata.rm.datasource.sql.struct.TableMetaCache.fetchSchema<span class="token punctuation">(</span>TableMetaCache.java:94<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>seata-all-0.7.1.jar:0.7.1<span class="token punctuation">]</span>
	at io.seata.rm.datasource.sql.struct.TableMetaCache.lambda<span class="token variable">$getTableMeta</span><span class="token variable">$0</span><span class="token punctuation">(</span>TableMetaCache.java:73<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>seata-all-0.7.1.jar:0.7.1<span class="token punctuation">]</span>
	at com.github.benmanes.caffeine.cache.BoundedLocalCache.lambda<span class="token variable">$doComputeIfAbsent</span><span class="token variable">$14</span><span class="token punctuation">(</span>BoundedLocalCache.java:2039<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>caffeine-2.6.2.jar:na<span class="token punctuation">]</span>
	at java.util.concurrent.ConcurrentHashMap.compute<span class="token punctuation">(</span>ConcurrentHashMap.java:1853<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_301<span class="token punctuation">]</span>
	<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke<span class="token punctuation">(</span>JdkDynamicAopProxy.java:212<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at com.sun.proxy.<span class="token variable">$Proxy94</span>.lockSkuStock<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl.orderLockStock<span class="token punctuation">(</span>WareSkuServiceImpl.java:162<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>422f6383.invoke<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">&gt;</span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at org.springframework.cglib.proxy.MethodProxy.invoke<span class="token punctuation">(</span>MethodProxy.java:218<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-core-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
	at org.springframework.aop.framework.CglibAopProxy<span class="token variable">$CglibMethodInvocation</span>.invokeJoinpoint<span class="token punctuation">(</span>CglibAopProxy.java:749<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.0.1.png" alt="image-20220818201134344" tabindex="0" loading="lazy"><figcaption>image-20220818201134344</figcaption></figure><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>org.springframework.jdbc.UncategorizedSQLException: 
<span class="token comment">### Error updating database.  Cause: java.sql.SQLException: io.seata.common.exception.ShouldNeverHappenException: [xid:192.168.56.1:8091:2114539555]get tablemeta failed</span>
<span class="token comment">### The error may exist in file [B:\gulimall\gulimall-ware\target\classes\mapper\ware\WareSkuDao.xml]</span>
<span class="token comment">### The error may involve defaultParameterMap</span>
<span class="token comment">### The error occurred while setting parameters</span>
<span class="token comment">### SQL: update gulimall_wms.wms_ware_sku set stock_locked = stock_locked+?         where sku_id=? and ware_id = ? and stock - stock_locked&gt;=?</span>
<span class="token comment">### Cause: java.sql.SQLException: io.seata.common.exception.ShouldNeverHappenException: [xid:192.168.56.1:8091:2114539555]get tablemeta failed</span>
<span class="token punctuation">;</span> uncategorized SQLException<span class="token punctuation">;</span> SQL state <span class="token punctuation">[</span>null<span class="token punctuation">]</span><span class="token punctuation">;</span> error code <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> io.seata.common.exception.ShouldNeverHappenException: <span class="token punctuation">[</span>xid:192.168.56.1:8091:2114539555<span class="token punctuation">]</span>get tablemeta failed<span class="token punctuation">;</span> nested exception is java.sql.SQLException: io.seata.common.exception.ShouldNeverHappenException: <span class="token punctuation">[</span>xid:192.168.56.1:8091:2114539555<span class="token punctuation">]</span>get tablemeta failed
	at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate<span class="token punctuation">(</span>AbstractFallbackSQLExceptionTranslator.java:89<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.0.2.png" alt="image-20220818205453436" tabindex="0" loading="lazy"><figcaption>image-20220818205453436</figcaption></figure><h6 id="尝试一" tabindex="-1"><a class="header-anchor" href="#尝试一" aria-hidden="true">#</a> 尝试一：</h6><p>百度一直在说<code>Failed to fetch schema of XXXX表 java.sql.SQLException: Failed to fetch schema of XXXXX表</code>是因为<code>SPringCloud项目中使用了seata的分布式事务，其中xxx表中没有主键</code>，<code>给xxx表加一个主键ID就可以了</code>。但是我的<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>表有主键啊</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.1.png" alt="image-20220818205026604" tabindex="0" loading="lazy"><figcaption>image-20220818205026604</figcaption></figure><h6 id="尝试二" tabindex="-1"><a class="header-anchor" href="#尝试二" aria-hidden="true">#</a> 尝试二：</h6><p>删除<code>gulimall_wms</code>数据库中已经存在的<code>undo_log</code>表</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.2.1.png" alt="image-20220818201410226" tabindex="0" loading="lazy"><figcaption>image-20220818201410226</figcaption></figure><p>在<code>gulimall_wms</code>数据库里重新执行下面这条<code>sql</code>语句，重新创建表</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  `ext` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.2.2.png" alt="image-20220818201545733" tabindex="0" loading="lazy"><figcaption>image-20220818201545733</figcaption></figure><h6 id="尝试三-解决" tabindex="-1"><a class="header-anchor" href="#尝试三-解决" aria-hidden="true">#</a> 尝试三：（解决）</h6><p>删掉<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件里的<code>id</code>为<code>lockSkuStock</code>里的<code>gulimall_wms.</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.3.1.png" alt="image-20220818210814292" tabindex="0" loading="lazy"><figcaption>image-20220818210814292</figcaption></figure><p><code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件报红了不用管，这IDEA不知道使用的是哪个数据库，检测到没有这些表才报红的，不影响程序运行，至此才解决这个问题</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.3.2.png" alt="image-20220818210609807" tabindex="0" loading="lazy"><figcaption>image-20220818210609807</figcaption></figure><p>查看的链接：https://en.chowdera.com/2022/119/202204292239307418.html</p><p>原文链接：https://blog.csdn.net/weixin_44647371/article/details/124446175</p><p>io.seata.common.exception.ShouldNeverHappenException: Could not found any index in the table 报错关键语句：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Caused by: io.seata.common.exception.ShouldNeverHappenException: Could not found any index in the table
或者
io.seata.common.exception.ShouldNeverHappenException: [xid:192.168.25.1:8091:2104750907]get tablemeta failed
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解决，我这边找了半天发现是mybatis的sql中要去掉数据库名导致的，去掉sql语句中的库名即可 <img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.5.3.3.png" alt="在这里插入图片描述" loading="lazy"></p><h5 id="_6、测试-1" tabindex="-1"><a class="header-anchor" href="#_6、测试-1" aria-hidden="true">#</a> 6、测试</h5><p>重启<code>GulimallWareApplication</code>服务，截断<code>gulimall_oms</code>数据库的<code>oms_order</code>订单表和<code>oms_order_item</code>订单项表，将<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>库存表的<code>stock_locked</code>被锁库存属性全部修改为<code>0</code>，表示没有库存被锁住。在 http://order.gulimall.com/toTrade 页面里提交订单，来到 http://order.gulimall.com/submitOrder 页面，这时正确的报了<code>/ by zero</code>错误，查看数据库，可以看到<code>gulimall_oms</code>数据库的<code>oms_order</code>订单表和<code>oms_order_item</code>订单项表都没有新增数据，<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>库存表里也没有库存被锁住，因此可以判断出分布式事务已经生效了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.5.6.gif" alt="GIF 2022-8-18 21-37-49" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-18 21-37-49</figcaption></figure><h4 id="_6、at模式" tabindex="-1"><a class="header-anchor" href="#_6、at模式" aria-hidden="true">#</a> 6、<code>AT</code>模式</h4><p>Seata默认使用<code>AT</code>模式，类似于<code>2PC</code>二阶提交协议，不过<code>2PC</code>二阶提交协议的第一个阶段是准备阶段，不提交事务，而<code>Seata</code>直接把本地事务提交了。<code>Seata</code>在第二阶段如果失败了，就通过回滚日志进行反向补偿。</p><p>不过这并不适用于分布式系统中高并发的场景，倒是适合后台的<code>saveSpuInfo</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.6.png" alt="image-20220818202004999" tabindex="0" loading="lazy"><figcaption>image-20220818202004999</figcaption></figure><p><a href="code/6.2.2.6.1.xml">点击查看<code>gulimall-order</code>完整代码</a></p><p><a href="code/6.2.2.6.2.xml">点击查看<code>gulimall-ware</code>完整代码</a></p><h4 id="_7、seata分布式事务总结" tabindex="-1"><a class="header-anchor" href="#_7、seata分布式事务总结" aria-hidden="true">#</a> 7、Seata分布式事务总结</h4><p>1)、每一个微服务先必须创建<code>undo_log</code>表; 2)、安装事务协调器; <code>seata-server</code> https://github.com/seata/seata/releases 3)、整合 1、导入依赖<code>spring-cloud-starter-alibaba-seata seata-all-0.7.1</code> 2、解压并启动<code>seata-server</code>; <code>registry.conf</code>:注册中心配置;修改<code>registry type=nacos</code><code>file.conf</code>: 3、所有想要用到分布式事务的微服务使用<code>seata</code> <code>DataSourceProxy</code>代理 自己的数据源 4、每个微服务，都必须导入 <code>registry. conf</code><code>file.conf</code>里需要配置<code>vgroup mapping. {appl ication. name}-fescar-service-group = &quot;default&quot;</code> 5、启动测试分布式事务 6、给分布式大事务的入口标注<code>@GLobalTransactional</code> 7、每一个远程的小事务用<code>@Transactional</code></p><h4 id="_8、springboot事务失效" tabindex="-1"><a class="header-anchor" href="#_8、springboot事务失效" aria-hidden="true">#</a> 8、SpringBoot事务失效</h4><p>如一个类里面定义了方法A()和方法B()，然后方法A和B都各自开启了事务，如果不做处理，直接在方法A中调用方法B，这时就会导致方法B里面的事务失效，也就是如果程序出错时，B的事务是失效的，数据回滚不了，我们可以使用<code>aspect</code>来解决这个问题</p><p>参考: <a href="https://docs.spring.io/spring-framework/docs/5.1.3.RELEASE/spring-framework-reference/core.html#aop-understanding-aop-proxies" target="_blank" rel="noopener noreferrer">Core Technologies (spring.io)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>首先引入<code>spring-boot-starter-aop</code>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.8.1.png" alt="image-20220819212651091" tabindex="0" loading="lazy"><figcaption>image-20220819212651091</figcaption></figure><p>其实主要想使用<code>spring-boot-starter-aop</code>依赖的<code>aspect</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.8.2.png" alt="image-20220819212842976" tabindex="0" loading="lazy"><figcaption>image-20220819212842976</figcaption></figure><p>在主类上添加<code>@EnableAspectJAutoProxy</code>注解，并设置<code>exposeProxy = true</code>，对外暴露代理对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.8.3.png" alt="image-20220819213011046" tabindex="0" loading="lazy"><figcaption>image-20220819213011046</figcaption></figure><p>根据<code>EnableAspectJAutoProxy</code>注解接口的描述，我们可以使用<code>AopContext</code>获得当前代理对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Indicate that the proxy should be exposed by the AOP framework as a <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadLocal</span></span></span><span class="token punctuation">}</span>
 * for retrieval via the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">AopContext</span></span><span class="token punctuation">}</span> class.
 * Off by default, i.e. no guarantees that <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">AopContext</span></span></span><span class="token punctuation">}</span> access will work.
 * <span class="token keyword">@since</span> 4.3.1
 *表明代理应该由 AOP 框架作为一个 <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadLocal</span></span></span><span class="token punctuation">}</span> 被暴露
 *通过*<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">AopContext</span></span><span class="token punctuation">}</span> 类来获得。
 *默认关闭，即不保证 <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">AopContext</span></span></span><span class="token punctuation">}</span> 访问将起作用。
 */</span>
<span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.8.4.png" alt="image-20220819214208471" tabindex="0" loading="lazy"><figcaption>image-20220819214208471</figcaption></figure><p>然后调用代理对象的方法即可避免事务失效</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">OrderServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">AopContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Propagation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description:
 * 1、引入spring-boot-starter-aop依赖
 * 2、@EnableAspectJAutoProxy(exposeProxy = true)  exposeProxy = true对外暴露代理对象
 * 3、AspectJTest orderService = (AspectJTest) AopContext.currentProxy();
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AspectJTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行a方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AspectJTest</span> orderService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AspectJTest</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderService<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderService<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行b方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRES_NEW</span><span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行c方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.2.8.5.png" alt="image-20220819214136005" tabindex="0" loading="lazy"><figcaption>image-20220819214136005</figcaption></figure><h3 id="_6-2-3、延时队列" tabindex="-1"><a class="header-anchor" href="#_6-2-3、延时队列" aria-hidden="true">#</a> 6.2.3、延时队列</h3><h4 id="_1、延时队列场景" tabindex="-1"><a class="header-anchor" href="#_1、延时队列场景" aria-hidden="true">#</a> 1、延时队列场景</h4><h5 id="_1、场景" tabindex="-1"><a class="header-anchor" href="#_1、场景" aria-hidden="true">#</a> 1、场景</h5><p>延时队列可以用于关闭订单和解锁库存等场景，比如当用户点击下订单，30分钟后仍未支付订单，我们可以关闭这个订单（将这个订单的状态设置为已关闭），并主动通知库存服务解锁库存。</p><p>当用户点击下订单后，我们会将库存锁住，表示用户已经准备购买这个商品了（锁库存是为了防止同一个商品被多个卖家购买到），过了<code>40</code>分钟后检查锁库存的对应订单的状态，如果是订单关闭（订单关闭后会通知解锁库存，保险起见库存服务还是要检查一下是否需要解锁库存）、订单不存在（下订单的过程中失败了，比如某个商品锁库存失败了，此时会通知已锁库存的服务让其解锁对应的库存，保险起见库存服务还是要检查一下是否需要解锁库存）等下单失败的状态时，解锁库存。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.1.png" alt="image-20220818214502674" tabindex="0" loading="lazy"><figcaption>image-20220818214502674</figcaption></figure><h5 id="_2、定时任务的时效性问题" tabindex="-1"><a class="header-anchor" href="#_2、定时任务的时效性问题" aria-hidden="true">#</a> 2、定时任务的时效性问题</h5><p>如果我们使用传统的定时任务来做这件事情，就会有定时任务的时效性问题，比如用户在第<code>1</code>秒时下订单，此时用户一直未支付，直到第<code>31</code>秒时订单过期时需要及时解锁库存，但是由于定时任务是第<code>0</code>秒开始，每<code>30</code>秒执行一次，因此错过第<code>30</code>秒的检查后，只能在第<code>60</code>秒后才能检查到需要在第<code>31</code>秒时就应该解锁的库存，这样其他用户就不能及时看到其实应该已经解锁的库存。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.2.png" alt="image-20220818215448826" tabindex="0" loading="lazy"><figcaption>image-20220818215448826</figcaption></figure><h5 id="_3、rabbitmq实现延时队列基础" tabindex="-1"><a class="header-anchor" href="#_3、rabbitmq实现延时队列基础" aria-hidden="true">#</a> 3、RabbitMQ实现延时队列基础</h5><p>使用定时任务不能解决问题的原因主要就是时效性问题，如果我们能给每个订单都设置设置一个过期时间就好了，因此我们可以使用RabbitMQ来实现延时队列</p><p><strong>RabbitMQ延时队列（实现定时任务）</strong></p><p>场景：</p><p>比如未付款订单，超过一定时间后，系统自动取消订单并释放占有物品。</p><p>常用解决方案</p><p>spring的 schedule 定时任务轮询数据库</p><p>缺点</p><p>消耗系统内存、增加了数据库的压力、存在较大的时间误差</p><p>解决：rabbitmq的消息TTL和死信Exchange结合</p><p><strong>消息的TTL（Time To Live）</strong></p><ul><li><p>消息的TTL就是消息的存活时间。</p></li><li><p>RabbitMQ可以对队列和消息分别设置TTL。</p><ul><li><p>对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</p></li><li><p>如果队列设置了，消息也设置了，那么会取小的。所以一个消息如果被路由到不同的队列中，这个消息死亡的时间有可能不一样（不同的队列设置）。这里单讲单个消息的TTL，因为它才是实现延迟任务的关键。可以通过设置消息的expiration字段或者x- message-ttl属性来设置时间，两者是一样的效果。</p></li></ul></li></ul><p><strong>Dead Letter Exchanges（DLX）</strong></p><ul><li><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列， 一个路由可以对应很多队列。（什么是死信）</p><ul><li><p>一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不 会被再次放在队列里，被其他消费者使用。（basic.reject/ basic.nack）requeue=false</p></li><li><p>上面的消息的TTL到了，消息过期了。</p></li><li><p>队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上</p></li></ul></li><li><p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p></li><li><p>我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息 被路由到某一个指定的交换机，结合二者，其实就可以实现一个延时队列</p></li></ul><h5 id="_4、延时队列实现" tabindex="-1"><a class="header-anchor" href="#_4、延时队列实现" aria-hidden="true">#</a> 4、延时队列实现</h5><h6 id="_1-给队列设置过期时间" tabindex="-1"><a class="header-anchor" href="#_1-给队列设置过期时间" aria-hidden="true">#</a> 1. 给队列设置过期时间</h6><p>给一个队列设置一个过期时间，当时间到了仍然没有消费者处理时，这些消息就会交给死信交换机，死信交换机使用指定的死信路由键交给指定的队列，消费者可以获取指定队列的消息，这样获取到的都是延迟后的消息，进而间接实现了延时队列。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.4.1.png" alt="image-20220819090045466" tabindex="0" loading="lazy"><figcaption>image-20220819090045466</figcaption></figure><h6 id="_2-给消息设置过期时间-不推荐" tabindex="-1"><a class="header-anchor" href="#_2-给消息设置过期时间-不推荐" aria-hidden="true">#</a> 2. 给消息设置过期时间（不推荐）</h6><p>不仅可以给队列设置过期时间，还可以给消息设置过期时间，不过不推荐该做法。</p><p>（RabbitMQ采用惰性检查机制，在队列中只有前面的消息被取走后才会检查下一个消息有没有过期）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.4.2.png" alt="image-20220819090449587" tabindex="0" loading="lazy"><figcaption>image-20220819090449587</figcaption></figure><h5 id="_5、简单设计" tabindex="-1"><a class="header-anchor" href="#_5、简单设计" aria-hidden="true">#</a> 5、简单设计</h5><p>订单业务的简单设计如下图所示：下订单后，首先发布者将消息交给<code>user.order.delay.exchange</code>交换机，使用<code>order_delay</code>路由键交给<code>user.order.delay.queue</code>队列，到了过期时间后用户还没有支付则订单过期，过期后订单交给<code>user.order.exchange</code>交换机，使用<code>order</code>路由键交给<code>user.order.queue</code>队列，消费者监听<code>user.order.queue</code>队列就可以获取过期的订单消息了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.5.png" alt="image-20220819090811424" tabindex="0" loading="lazy"><figcaption>image-20220819090811424</figcaption></figure><h5 id="_6、最终设计" tabindex="-1"><a class="header-anchor" href="#_6、最终设计" aria-hidden="true">#</a> 6、最终设计</h5><p>最终设计的订单业务如下：（其实就是使用了同一个交换机，其他的也没怎么变动）</p><p>下订单后，首先发布者将消息交给<code>order-event-exchange</code>交换机，使用<code>order.create.order</code>路由键交给<code>order.delay.queue</code>队列，到了过期时间后用户还没有支付则订单过期，过期后订单还是交给<code>order-event-exchange</code>交换机不过路由键不同了，使用<code>order.release.order</code>路由键交给<code>order.release.order.queue</code>队列，消费者监听<code>order.release.order.queue</code>队列就可以获取过期的订单消息了。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.6.1.png" alt="image-20220819091300725" tabindex="0" loading="lazy"><figcaption>image-20220819091300725</figcaption></figure><p>本系统全部的消息列的路由过程如下</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.1.6.2.png" alt="消息队列流程" tabindex="0" loading="lazy"><figcaption>消息队列流程</figcaption></figure><h4 id="_2、简单使用" tabindex="-1"><a class="header-anchor" href="#_2、简单使用" aria-hidden="true">#</a> 2、简单使用</h4><h5 id="_1、创建队列、交换机、绑定关系" tabindex="-1"><a class="header-anchor" href="#_1、创建队列、交换机、绑定关系" aria-hidden="true">#</a> 1、创建队列、交换机、绑定关系</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config</code>包下新建<code>MyMQConfig</code>类，用于创建释放订单的队列、交换机、绑定关系，然后重启<code>GulimallOrderApplication</code>服务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Binding</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Exchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Queue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">TopicExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description: 消息队列配置类
 * 若RabbitMQ里没有，容器中的Binding， Queue, Exchange 都会自动创建
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMQConfig</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 给订单加上过期时间
     * x-dead-letter-exchange: order-event-exchange
     * x-dead-letter-routing-key: order.release.order
     * x-message-ttl: 60000
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">orderDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.release.order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Queue(String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;order.delay.queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 释放订单
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">orderReleaseOrderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">orderEventExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//TopicExchange(String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderCreateOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//Binding(String destination, DestinationType destinationType, String exchange, String routingKey,Map&lt;String, Object&gt; arguments)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;order.delay.queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
                <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.create.order&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderReleaseOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
                <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.release.order&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.2.1.png" alt="image-20220819094410966" tabindex="0" loading="lazy"><figcaption>image-20220819094410966</figcaption></figure><h5 id="_2、查看" tabindex="-1"><a class="header-anchor" href="#_2、查看" aria-hidden="true">#</a> 2、查看</h5><p>（如果没有的话可以先不用管，<code>spring</code>默认使用的是懒加载，当消费者监听队列后才创建相应的交换机和队列。）</p><p>访问 http://192.168.56.10:15672/#/exchanges 页面即可看到自动创建了<code>order-event-exchange</code>交换机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.2.2.1.png" alt="image-20220819094918219" tabindex="0" loading="lazy"><figcaption>image-20220819094918219</figcaption></figure><p>访问 http://192.168.56.10:15672/#/queues 页面即可看到自动创建了<code>order.delay.queue</code>和<code>order.release.order.queue</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.2.2.2.png" alt="image-20220819094920492" tabindex="0" loading="lazy"><figcaption>image-20220819094920492</figcaption></figure><h5 id="_3、测试-4" tabindex="-1"><a class="header-anchor" href="#_3、测试-4" aria-hidden="true">#</a> 3、测试</h5><p>先在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类里添加如下方法，用于监听<code>order.release.order.queue</code>队列</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * com.atguigu.gulimall.order.web.HelloController类的createOrderTest方法发送消息
 * <span class="token keyword">@param</span> <span class="token parameter">orderEntity</span>
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
 * <span class="token keyword">@param</span> <span class="token parameter">message</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到过期的订单信息，准备关闭订单=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;时间=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getModifyTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.2.3.1.png" alt="image-20220819111047776" tabindex="0" loading="lazy"><figcaption>image-20220819111047776</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.web.HelloController</code>类里添加<code>createOrderTest</code>方法，用于测试给<code>mq</code>发消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 *
 * com.atguigu.gulimall.order.config.MyMQConfig类的listener方法监听消息
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test/createOrder&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createOrderTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//订单下单成功</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderEntity<span class="token punctuation">.</span><span class="token function">setModifyTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//给MQ发消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.create.order&quot;</span><span class="token punctuation">,</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;收到过期的订单信息，准备关闭订单=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;时间=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getModifyTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.2.3.2.png" alt="image-20220819101116921" tabindex="0" loading="lazy"><figcaption>image-20220819101116921</figcaption></figure><p>先登录，再刷新<code>http://order.gulimall.com/test/createOrder</code>页面<code>5</code>次，可以看到<code>GulimallOrderApplication</code>服务的控制台立即打出了5个<code>消息抵达消息代理</code>的回调。此时通过<code>order.create.order</code>路由键发送给<code>order-event-exchange</code>交换机，然后交换机根据路由键发送给了<code>order.delay.queue</code>队列，此时<code>RabbltMQ</code>的<code>order.delay.queue</code>也已近有<code>5</code>条准备的消息了。过了<code>1</code>分钟后，<code>order.delay.queue</code>队列已经到了过期时间，消息又使用<code>order.release.order</code>路由键发送给了<code>order-event-exchange</code>交换机，然后交换机根据路由键发送给了<code>order.release.order.queue</code>队列，<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类的<code>listener</code>方法监听该队列，因此控制台打印了<code>关闭订单</code>的信息，并手动确认了接收消息。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.3.2.3.3.gif" alt="GIF 2022-8-19 11-07-02" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-19 11-07-02</figcaption></figure><h3 id="_6-2-4、其他服务整合rabbitmq" tabindex="-1"><a class="header-anchor" href="#_6-2-4、其他服务整合rabbitmq" aria-hidden="true">#</a> 6.2.4、其他服务整合RabbitMQ</h3><h4 id="_1、整合rabbitmq-1" tabindex="-1"><a class="header-anchor" href="#_1、整合rabbitmq-1" aria-hidden="true">#</a> 1、整合RabbitMQ</h4><h5 id="_1、引入rabbitmq-1" tabindex="-1"><a class="header-anchor" href="#_1、引入rabbitmq-1" aria-hidden="true">#</a> 1、引入RabbitMQ</h5><p>在<code>gulimall-ware</code>模块的<code>pom.xml</code>文件里添加引入amqp场景</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--引入amqp场景，使用RabbitMQ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.1.1.png" alt="image-20220819111236014" tabindex="0" loading="lazy"><figcaption>image-20220819111236014</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加<code>RabbitMQ</code>配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.56.10</span>
<span class="token key attr-name">spring.rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token value attr-value">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.1.2.png" alt="image-20220819111410041" tabindex="0" loading="lazy"><figcaption>image-20220819111410041</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.GulimallWareApplication</code>启动类上添加<code>@EnableRabbit</code>注解，开启<code>RabbitMQ</code>功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRabbit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.1.3.png" alt="image-20220819111446973" tabindex="0" loading="lazy"><figcaption>image-20220819111446973</figcaption></figure><h5 id="_2、业务图" tabindex="-1"><a class="header-anchor" href="#_2、业务图" aria-hidden="true">#</a> 2、业务图</h5><p>接下来我们实现锁定库存的功能，其业务功能为下面画的红色方框的部分</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.1.png" alt="消息队列流程" tabindex="0" loading="lazy"><figcaption>消息队列流程</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.config</code>包里新建<code>MyRabbitConfig</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Binding</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Exchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Queue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">TopicExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span><span class="token class-name">Jackson2JsonMessageConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>converter<span class="token punctuation">.</span></span><span class="token class-name">MessageConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRabbitConfig</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 消息转换器(转换为JSON数据)
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">stockEventExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//TopicExchange(String name, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token string">&quot;stock-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">stockReleaseStockQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//Queue(String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">stockDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;stock-event-exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stock.release&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;stock.delay.queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">stockReleaseBinging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//Binding(String destination, DestinationType destinationType, String exchange, String routingKey,Map&lt;String, Object&gt; arguments)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
                <span class="token string">&quot;stock-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;stock.release.#&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">stockLockedBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;stock.delay.queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
                <span class="token string">&quot;stock-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;stock.locked&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.2.png" alt="image-20220819114253845" tabindex="0" loading="lazy"><figcaption>image-20220819114253845</figcaption></figure><p>启动<code>GulimallWareApplication</code>服务，访问 http://192.168.56.10:15672/#/exchanges 页面可以看到没有新增<code>stock-event-exchange</code>交换机</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.3.png" alt="image-20220819114341970" tabindex="0" loading="lazy"><figcaption>image-20220819114341970</figcaption></figure><p>访问 http://192.168.56.10:15672/#/queues 页面可以看到没有新增<code>stock.release.stock.queue</code>和<code>stock.delay.queue</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.4.png" alt="image-20220819114344356" tabindex="0" loading="lazy"><figcaption>image-20220819114344356</figcaption></figure><p>这是因为<code>Spring</code>使用的是懒加载，当消费者监听队列后才创建相应的交换机和队列。使用<code>@RabbitListener</code>注解随便监听一个队列即可。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.5.png" alt="image-20220819114519129" tabindex="0" loading="lazy"><figcaption>image-20220819114519129</figcaption></figure><p>重启<code>GulimallWareApplication</code>服务，访问 http://192.168.56.10:15672/#/exchanges 页面可以看到已经创建<code>stock-event-exchange</code>交换机了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.6.png" alt="image-20220819114728239" tabindex="0" loading="lazy"><figcaption>image-20220819114728239</figcaption></figure><p>访问 http://192.168.56.10:15672/#/queues 页面可以看到已经创建<code>stock.release.stock.queue</code>和<code>stock.delay.queue</code>队列了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.2.7.png" alt="image-20220819114730458" tabindex="0" loading="lazy"><figcaption>image-20220819114730458</figcaption></figure><h5 id="_3、库存解锁的场景" tabindex="-1"><a class="header-anchor" href="#_3、库存解锁的场景" aria-hidden="true">#</a> 3、库存解锁的场景</h5><p>库存解锁的场景</p><p>1)、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消。都要解锁库存 2)、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。 之前锁定的库存就要自动解锁。</p><p>在<code>gulimall_wms</code>数据库的<code>wms_ware_order_task_detail</code>表里，添加<code>ware_id</code>和<code>lock_status</code>（我这里已近添加过了）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.3.1.png" alt="image-20220819154128242" tabindex="0" loading="lazy"><figcaption>image-20220819154128242</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.entity.WareOrderTaskDetailEntity</code>类里，添加<code>private Long wareId;</code>字段和<code>private Integer lockStatus;</code>字段。（这里已经添加过了）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.3.2.png" alt="image-20220819154421260" tabindex="0" loading="lazy"><figcaption>image-20220819154421260</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareOrderTaskDetailDao.xml</code>文件的<code>id=&quot;wareOrderTaskDetailMap&quot;</code>的<code>&lt;resultMap&gt;</code>里，在后面添加`<!----></p><!---->`<div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 可根据自己的需求，是否要使用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.atguigu.gulimall.ware.entity.WareOrderTaskDetailEntity<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wareOrderTaskDetailMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sku_id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sku_name<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skuNum<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sku_num<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>taskId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>task_id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wareId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ware_id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lockStatus<span class="token punctuation">&quot;</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lock_status<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.3.3.png" alt="image-20220819154752477" tabindex="0" loading="lazy"><figcaption>image-20220819154752477</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.entity.WareOrderTaskDetailEntity</code>类上添加如下注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.3.4.png" alt="image-20220819155240562" tabindex="0" loading="lazy"><figcaption>image-20220819155240562</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common</code>包里新增<code>mq</code>文件夹，在<code>mq</code>文件夹里新建<code>StockLockedTo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description: 每锁一件商品库存就向RabbitMQ发送一条消息
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockLockedTo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * wms_ware_order_task
     * 库存工作单的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * wms_ware_order_task_detail
     * 工作单详情的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> detailId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.3.5.png" alt="image-20220819160939417" tabindex="0" loading="lazy"><figcaption>image-20220819160939417</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>orderLockStock</code>方法里，<code>保存库存工作单</code>和<code>工作单详情</code>，并向<code>RabbitMQ</code>发送一条消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">WareOrderTaskService</span> wareOrderTaskService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">WareOrderTaskDetailService</span> wareOrderTaskDetailService<span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 为订单锁定库存
 * <span class="token keyword">@param</span> <span class="token parameter">wareSkuLockTo</span>
 * <span class="token keyword">@return</span>
 * 库存解锁的场景
 * 1)、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消。都要解锁库存
 * 2)、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。
 * 之前锁定的库存就要自动解锁。
 */</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token class-name">WareSkuLockTo</span> wareSkuLockTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//保存库存工作单</span>
    <span class="token class-name">WareOrderTaskEntity</span> wareOrderTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>wareSkuLockTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wareOrderTaskService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//按照下单的收货地址，找到一个就近仓库，锁定库存。</span>
    <span class="token comment">//找到每个商品在哪个仓库都有库存</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareSkuLockTo<span class="token punctuation">.</span>OrderItemVo</span><span class="token punctuation">&gt;</span></span> locks <span class="token operator">=</span> wareSkuLockTo<span class="token punctuation">.</span><span class="token function">getLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuWareHasStock</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>orderItemVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuWareHasStock</span> skuWareHasStock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuWareHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> skuId <span class="token operator">=</span> orderItemVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuWareHasStock<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//select ware_id from wms_ware_sku where sku_id = 1 and stock - stock_locked &gt; 0</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> wareId <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">listWareIdHasSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuWareHasStock<span class="token punctuation">.</span><span class="token function">setWareId</span><span class="token punctuation">(</span>wareId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        skuWareHasStock<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>orderItemVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuWareHasStock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//锁定库存</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuWareHasStock</span> hasStock <span class="token operator">:</span> collect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> skuStocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> skuId <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> wareIds <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//没有库存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>wareIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//锁定库存</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> wareId <span class="token operator">:</span> wareIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//成功返回1，失败返回0</span>
            <span class="token comment">//update wms_ware_sku set stock_locked = stock_locked+2 where sku_id=1 and ware_id = 1 and stock - stock_locked&gt;=2</span>
            <span class="token class-name">Long</span> count <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">lockSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>wareId<span class="token punctuation">,</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//锁库存成功</span>
                skuStocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">//保存工作单详情</span>
                <span class="token class-name">WareOrderTaskDetailEntity</span> wareOrderTaskDetailEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">setTaskId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">setWareId</span><span class="token punctuation">(</span>wareId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">setSkuNum</span><span class="token punctuation">(</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">setLockStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>wareOrderTaskDetailEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//向RabbitMQ发送一条消息</span>
                <span class="token class-name">StockLockedTo</span> stockLockedTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockLockedTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stockLockedTo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stockLockedTo<span class="token punctuation">.</span><span class="token function">setDetailId</span><span class="token punctuation">(</span>wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;stock.locked&quot;</span><span class="token punctuation">,</span>stockLockedTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//锁库存成功</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skuStocked<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//当前商品没有库存了</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.3.6.png" alt="image-20220819161346943" tabindex="0" loading="lazy"><figcaption>image-20220819161346943</figcaption></figure><p>1.如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给<code>RabbitMQ</code> 2.如果锁定失败，前面保存的工作单信息就回滚了，数据库就没有工作单信息了。给<code>RabbitMQ</code>发送出去的消息过期后即使要解锁记录，但由于去数据库查不到id,所以也就不用解锁了。</p><p>老师说在<code>wms_ware_sku</code>表里已经锁库存了，但是<code>wms_ware_order_task_detail</code>详细工作单回滚了，由于根据<code>id</code>查不出数据，相当于就不知道当时这个人是锁了多少个了。但是我觉得在同一个事务里<code>wms_ware_order_task_detail</code>详细工作单回滚了，<code>wms_ware_sku</code>表里已经锁定的库存也应该回滚啊，所以我觉得只发id没问题啊。</p><h5 id="_4、修改代码" tabindex="-1"><a class="header-anchor" href="#_4、修改代码" aria-hidden="true">#</a> 4、修改代码</h5><p>修改<code>gulimall-common</code>模块的<code>com.atguigu.common.mq.StockLockedTo</code>类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mq</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description: 每锁一件商品库存就向RabbitMQ发送一条消息
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockLockedTo</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * wms_ware_order_task
     * 库存工作单的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * wms_ware_order_task_detail
     * 工作单详情的id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">StockDetailTo</span> detail<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StockDetailTo</span><span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * id
         */</span>
        <span class="token annotation punctuation">@TableId</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * sku_id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * sku_name
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> skuName<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 购买个数
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Integer</span> skuNum<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 工作单id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> taskId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 仓库id
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> wareId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 1-已锁定  2-已解锁  3-扣减
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">Integer</span> lockStatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.4.1.png" alt="image-20220819163606111" tabindex="0" loading="lazy"><figcaption>image-20220819163606111</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>orderLockStock</code>方法里，将<code>stockLockedTo.setDetailId(wareOrderTaskDetailEntity.getId());</code>修改为如下代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//只发id不行，防止回滚以后找不到数据(我觉得只发id没问题)</span>
<span class="token class-name">StockLockedTo<span class="token punctuation">.</span>StockDetailTo</span> stockDetailTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockLockedTo<span class="token punctuation">.</span>StockDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>wareOrderTaskDetailEntity<span class="token punctuation">,</span>stockDetailTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
stockLockedTo<span class="token punctuation">.</span><span class="token function">setDetail</span><span class="token punctuation">(</span>stockDetailTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.4.2.png" alt="image-20220819165145679" tabindex="0" loading="lazy"><figcaption>image-20220819165145679</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>submitOrder</code>方法上删除<code>@GlobalTransactional</code>注解</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.4.3.png" alt="image-20220819192611846" tabindex="0" loading="lazy"><figcaption>image-20220819192611846</figcaption></figure><h5 id="_5、测试" tabindex="-1"><a class="header-anchor" href="#_5、测试" aria-hidden="true">#</a> 5、测试</h5><p>重启<code>GulimallOrderApplication</code>服务和<code>GulimallWareApplication</code>服务，截断<code>gulimall_oms</code>数据库的<code>oms_order</code>订单表和<code>oms_order_item</code>订单项表，将<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>库存表的<code>stock_locked</code>被锁库存属性全部修改为<code>0</code>，表示没有库存被锁住。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.5.1.gif" alt="GIF 2022-8-19 16-44-56" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-19 16-44-56</figcaption></figure><p>登录后，在 http://order.gulimall.com/toTrade 页面里，点击提交订单，此时会报<code>/ by zero</code>错误。可以看到在<code>gulimall_oms</code>数据库里，<code>oms_order</code>表和<code>oms_order_item</code>表回滚了。在<code>gulimall_wms</code>数据库里，<code>wms_ware_sku</code>表里已经锁定库存了，<code>wms_ware_order_task</code>已经保存工作单了，<code>wms_ware_order_task_detail</code>里已经保存工作单详情了（还没有实现解锁库存功能，所以被锁的库存不会解锁，这是正常的）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.1.5.2.gif" alt="GIF 2022-8-19 16-46-37" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-19 16-46-37</figcaption></figure><p><a href="code/6.2.3.3.5.java">点击查看OrderServiceImpl类完整代码</a></p><h4 id="_2、解锁库存" tabindex="-1"><a class="header-anchor" href="#_2、解锁库存" aria-hidden="true">#</a> 2、解锁库存</h4><h5 id="_1、返回订单状态" tabindex="-1"><a class="header-anchor" href="#_1、返回订单状态" aria-hidden="true">#</a> 1、返回订单状态</h5><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.controller.OrderController</code>类里添加<code>getOrderStatus</code>方法用于返回订单的状态</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 返回订单状态
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/status/{orderSn}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderSn&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getOrderStatusByOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.1.png" alt="image-20220819171529048" tabindex="0" loading="lazy"><figcaption>image-20220819171529048</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里添加<code>getOrderStatusByOrderSn</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">OrderEntity</span> <span class="token function">getOrderStatusByOrderSn</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.2.png" alt="image-20220819171558583" tabindex="0" loading="lazy"><figcaption>image-20220819171558583</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里实现<code>getOrderStatusByOrderSn</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">OrderEntity</span> <span class="token function">getOrderStatusByOrderSn</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span><span class="token operator">::</span><span class="token function">getOrderSn</span><span class="token punctuation">,</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.3.png" alt="image-20220819171737988" tabindex="0" loading="lazy"><figcaption>image-20220819171737988</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.feign</code>包里添加<code>OrderFeignService</code>接口，用于远程调用订单模块</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description:
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;gulimall-order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;order/order/status/{orderSn}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderSn&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.4.png" alt="image-20220819172000861" tabindex="0" loading="lazy"><figcaption>image-20220819172000861</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.vo</code>包里新建<code>OrderVo</code>类，用于封装订单包含的信息</p><p><a href="code/6.2.3.4.1.java">点击查看OrderVo类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.5.png" alt="image-20220819172744530" tabindex="0" loading="lazy"><figcaption>image-20220819172744530</figcaption></figure><p>在<code>gulimall-common</code>模块的<code>com.atguigu.common</code>包下新建<code>enums</code>文件夹，在<code>enums</code>文件夹里新建<code>OrderStatusEnum</code>枚举类，用于表示订单状态</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>enums</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span>  <span class="token class-name">OrderStatusEnum</span> <span class="token punctuation">{</span>
    <span class="token function">CREATE_NEW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;待付款&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">PAYED</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;已付款&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SENDED</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;已发货&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">RECIEVED</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;已完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">CANCLED</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;已取消&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SERVICING</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;售后中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SERVICED</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;售后完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

    <span class="token class-name">OrderStatusEnum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.6.png" alt="image-20220819184921119" tabindex="0" loading="lazy"><figcaption>image-20220819184921119</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/application.properties</code>配置文件里添加如下配置，设置<code>RabbitMQ</code>消息手动确认接收</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#手动ack</span>
<span class="token key attr-name">spring.rabbitmq.listener.simple.acknowledge-mode</span><span class="token punctuation">=</span><span class="token value attr-value">manual</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.1.7.png" alt="image-20220819191739659" tabindex="0" loading="lazy"><figcaption>image-20220819191739659</figcaption></figure><h5 id="_2、解锁库存-1" tabindex="-1"><a class="header-anchor" href="#_2、解锁库存-1" aria-hidden="true">#</a> 2、解锁库存</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware</code>包里新建<code>listener</code>文件夹，在<code>listener</code>文件夹里新建<code>StockReleaseListener</code>类，用于监听<code>stock.release.stock.queue</code>库存释放队列的消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mq<span class="token punctuation">.</span></span><span class="token class-name">StockLockedTo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>ware<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">WareSkuService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/19
 * @Description:
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockReleaseListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WareSkuService</span> wareSkuService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 库存自动解锁
     * 1)、下订单成功，订单过期没有支付被系统自动取消、被用户手动取消。都要解锁库存
     * 2)、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。
     *
     * <span class="token keyword">@param</span> <span class="token parameter">stockLockedTo</span>
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>
     */</span>
    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStockLockedRelease</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> stockLockedTo<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到解锁库存的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            wareSkuService<span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>stockLockedTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.2.1.png" alt="image-20220819194526264" tabindex="0" loading="lazy"><figcaption>image-20220819194526264</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareSkuService</code>接口里添加<code>unLockStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> stockLockedTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.2.2.png" alt="image-20220819194558031" tabindex="0" loading="lazy"><figcaption>image-20220819194558031</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类里实现<code>unLockStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> stockLockedTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//工作单详情</span>
    <span class="token class-name">StockLockedTo<span class="token punctuation">.</span>StockDetailTo</span> detail <span class="token operator">=</span> stockLockedTo<span class="token punctuation">.</span><span class="token function">getDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WareOrderTaskDetailEntity</span> wareOrderTaskDetailEntity <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wareOrderTaskDetailEntity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//工作单详情里没有数据，无需解锁，确认收到消息</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * 解锁库存
     * 1、没有订单：证明锁定库存后面的业务出问题了，这种情况需要解锁库存
     * 2、有订单：如果有订单需要判断订单状态，如果订单状态为`未支付`或`用户主动取消` 这时需要解锁库存
     */</span>
    <span class="token comment">//库存工作单id</span>
    <span class="token class-name">Long</span> wareOrderTaskId <span class="token operator">=</span> stockLockedTo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WareOrderTaskEntity</span> wareOrderTaskEntity <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>wareOrderTaskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">R</span> r <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//消息拒绝以后重新放到队列里面，让别人继续消费解锁。</span>
        <span class="token comment">//channel.basicReject(message.getMessageProperties().getDeliveryTag(),true);</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;获取订单状态异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderVo</span> orderVo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderVo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">OrderVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//没有订单或订单状态为待付款或取消 并且工作单的锁定状态为已锁定</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CREATE_NEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> wareOrderTaskDetailEntity<span class="token punctuation">.</span><span class="token function">getLockStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span><span class="token class-name">Long</span> wareId<span class="token punctuation">,</span><span class="token class-name">Integer</span> num<span class="token punctuation">,</span><span class="token class-name">Long</span> taskDetailId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//库存解锁</span>
    <span class="token comment">//update wms_ware_sku set stock_locked = stock_locked - 1 where sku_id = 1 and ware_id = 1</span>
    wareSkuDao<span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>wareId<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//更新库存工作单状态</span>
    <span class="token class-name">WareOrderTaskDetailEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    entity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>taskDetailId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//已解锁</span>
    entity<span class="token punctuation">.</span><span class="token function">setLockStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.2.3.png" alt="image-20220819201656739" tabindex="0" loading="lazy"><figcaption>image-20220819201656739</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.dao.WareSkuDao</code>接口里添加<code>unLockStock</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;wareId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> wareId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.2.4.png" alt="image-20220819195321505" tabindex="0" loading="lazy"><figcaption>image-20220819195321505</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>src/main/resources/mapper/ware/WareSkuDao.xml</code>文件里添加<code>id</code>为<code>unLockStock</code>的<code>sql</code></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>unLockStock<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    update gulimall_wms.wms_ware_sku
    set stock_locked = stock_locked - #{num} where sku_id = #{skuId} and ware_id = #{wareId}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.2.5.png" alt="image-20220819195528705" tabindex="0" loading="lazy"><figcaption>image-20220819195528705</figcaption></figure><p>删掉<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.config.MyRabbitConfig</code>配置类的<code>listener</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.2.6.png" alt="image-20220819200028084" tabindex="0" loading="lazy"><figcaption>image-20220819200028084</figcaption></figure><h5 id="_3、没有收到消息" tabindex="-1"><a class="header-anchor" href="#_3、没有收到消息" aria-hidden="true">#</a> 3、没有收到消息</h5><p>调试时发现延迟队列一直没有收到消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.3.1.png" alt="image-20220819203540905" tabindex="0" loading="lazy"><figcaption>image-20220819203540905</figcaption></figure><p>查看<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>orderLockStock</code>方法，可以看到是这里的交换机名称写错了，果然还是得用枚举或常量</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.3.2.png" alt="image-20220819203514587" tabindex="0" loading="lazy"><figcaption>image-20220819203514587</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>orderLockStock</code>方法里，把<code>&quot;order-event-exchange&quot;</code>改为<code>&quot;stock-event-exchange&quot;</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.3.3.png" alt="image-20220819203808641" tabindex="0" loading="lazy"><figcaption>image-20220819203808641</figcaption></figure><h5 id="_4、远程调用失败" tabindex="-1"><a class="header-anchor" href="#_4、远程调用失败" aria-hidden="true">#</a> 4、远程调用失败</h5><p>然后老师也说了,<code>feign</code>远程调用会失败<code>sun.net.www.http.HttpClient(http://auth.gulimall.com/login.html)</code>，失败的原因就是没有进行登录（配置的访问<code>GulimallOrderApplication</code>服务所有请求都需要登录）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.4.1.png" alt="image-20220819204634690" tabindex="0" loading="lazy"><figcaption>image-20220819204634690</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.interceptor.LoginUserInterceptor</code>类的<code>preHandle</code>方法的开头添加如下代码，直接放行<code>order/order/status/</code>开头的请求</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> match <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">&quot;order/order/status/**&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.4.2.png" alt="image-20220819205105392" tabindex="0" loading="lazy"><figcaption>image-20220819205105392</figcaption></figure><p>重启<code>GulimallOrderApplication</code>服务后，还是报了<code>feign</code>的错误</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>feign.codec.DecodeException: Could not extract response: no suitable HttpMessageConverter found for response type [class com.atguigu.common.utils.R] and content type [text/html;charset=UTF-8]
    at feign.SynchronousMethodHandler.decode(SynchronousMethodHandler.java:180)
    at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:140)
    at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:78)
    at feign.ReflectiveFeign$FeignInvocationHandler.invoke(ReflectiveFeign.java:103)
    at com.sun.proxy.$Proxy108.getOrderStatus(Unknown Source)
    at com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl.unLockStock(WareSkuServiceImpl.java:240)
    at com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl$$FastClassBySpringCGLIB$$422f6383.invoke(&lt;generated&gt;)
    at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.4.3.png" alt="image-20220819210401150" tabindex="0" loading="lazy"><figcaption>image-20220819210401150</figcaption></figure><p>调试后，发现还是跳转到了登录页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.4.4.png" alt="image-20220819211052935" tabindex="0" loading="lazy"><figcaption>image-20220819211052935</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.interceptor.LoginUserInterceptor</code>类的<code>preHandle</code>方法的开头，可以看到我们访问的是<code>/order/order/status/202208192040228431560607606966325249</code>，而我们放行的是以<code>&quot;order/order/status/**&quot;</code>开头的请求，所以还是被拦截了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.4.5.png" alt="image-20220819210303885" tabindex="0" loading="lazy"><figcaption>image-20220819210303885</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.interceptor.LoginUserInterceptor</code>类的<code>preHandle</code>方法的开头，将刚刚配置的<code>&quot;order/order/status/**&quot;</code>修改为<code>&quot;/order/order/status/**&quot;</code>即可</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.4.6.png" alt="image-20220819211232854" tabindex="0" loading="lazy"><figcaption>image-20220819211232854</figcaption></figure><h5 id="_5、再次测试" tabindex="-1"><a class="header-anchor" href="#_5、再次测试" aria-hidden="true">#</a> 5、再次测试</h5><p>重启<code>GulimallOrderApplication</code>服务和<code>GulimallWareApplication</code>服务，截断<code>gulimall_oms</code>数据库的<code>oms_order</code>订单表和<code>oms_order_item</code>订单项表，将<code>gulimall_wms</code>数据库的<code>wms_ware_sku</code>库存表的<code>stock_locked</code>被锁库存属性全部修改为<code>0</code>，表示没有库存被锁住。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.5.1.gif" alt="GIF 2022-8-19 16-44-56" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-19 16-44-56</figcaption></figure><p>登录后，在 http://order.gulimall.com/toTrade 页面里，点击提交订单，此时会报<code>/ by zero</code>错误。可以看到在<code>gulimall_oms</code>数据库里，<code>oms_order</code>表和<code>oms_order_item</code>表回滚了。在<code>gulimall_wms</code>数据库里，<code>wms_ware_sku</code>表里已经锁定库存了，<code>wms_ware_order_task</code>已经保存工作单了，<code>wms_ware_order_task_detail</code>里已经保存工作单详情了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.5.2.gif" alt="GIF 2022-8-20 9-22-37" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 9-22-37</figcaption></figure><p>等到了规定的时间还没有支付后，处理解锁库存的接口收到了解锁库存的消息，<code>gulimall_wms</code>数据库的<code>wms_ware_order_task_detail</code>表将刚新增的数据的<code>lock_status</code>字段变为<code>2</code>（状态由<code>已锁定</code>变为<code>已解锁</code>），<code>wms_ware_sku</code>表里已锁定的库存也重新被解锁了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.2.5.3.gif" alt="GIF 2022-8-20 9-24-37" tabindex="0" loading="lazy"><figcaption>GIF 2022-8-20 9-24-37</figcaption></figure><p><a href="code/6.2.3.4.5.OrderServiceImp.java">点击查看OrderServiceImpl类完整代码</a></p><p><a href="code/6.2.3.4.5.StockReleaseListener.java">点击查看StockReleaseListener类完整代码</a></p><p><a href="code/6.2.3.4.5.WareSkuServiceImpl.java">点击查看WareSkuServiceImpl类完整代码</a></p><h4 id="_3、释放订单" tabindex="-1"><a class="header-anchor" href="#_3、释放订单" aria-hidden="true">#</a> 3、释放订单</h4><h5 id="_1、添加关闭订单方法" tabindex="-1"><a class="header-anchor" href="#_1、添加关闭订单方法" aria-hidden="true">#</a> 1、添加关闭订单方法</h5><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.1.1.png" alt="消息队列流程" tabindex="0" loading="lazy"><figcaption>消息队列流程</figcaption></figure><p>剪切<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类的<code>listener</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * com.atguigu.gulimall.order.web.HelloController类的createOrderTest方法发送消息
 * <span class="token keyword">@param</span> <span class="token parameter">orderEntity</span>
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
 * <span class="token keyword">@param</span> <span class="token parameter">message</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
 */</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到过期的订单信息，准备关闭订单=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;时间=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getModifyTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.1.2.png" alt="image-20220820093919450" tabindex="0" loading="lazy"><figcaption>image-20220820093919450</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order</code>包里新建<code>listener</code>文件夹，在<code>listener</code>文件夹里新建<code>OrderCloseListener</code>，将刚刚剪切的代码粘贴到这里，并稍加改造。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> 无名氏
 * <span class="token keyword">@date</span> 2022/8/20
 * @Description:
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCloseListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * com.atguigu.gulimall.order.web.HelloController类的createOrderTest方法发送消息
     * <span class="token keyword">@param</span> <span class="token parameter">orderEntity</span>
     * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
     * <span class="token keyword">@param</span> <span class="token parameter">message</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到过期的订单信息，准备关闭订单=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;时间=&gt;&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getModifyTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            orderService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.1.3.png" alt="image-20220822210533628" tabindex="0" loading="lazy"><figcaption>image-20220822210533628</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.OrderService</code>接口里添加<code>closeOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.1.4.png" alt="image-20220820094606929" tabindex="0" loading="lazy"><figcaption>image-20220820094606929</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>实现类里实现<code>closeOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CREATE_NEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.1.5.png" alt="image-20220820100504664" tabindex="0" loading="lazy"><figcaption>image-20220820100504664</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>submitOrder</code>方法里，注释掉<code>int i = 10/0;</code>，并在下面添加<code>rabbitTemplate.convertAndSend(&quot;order-event-exchange&quot;,&quot;order.create.order&quot;,orderCreateTo.getOrder());</code>代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//int i = 10/0;</span>
<span class="token comment">//订单创建成功，发消息给RabbitMQ</span>
rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.create.order&quot;</span><span class="token punctuation">,</span>orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.1.6.png" alt="image-20220820100200680" tabindex="0" loading="lazy"><figcaption>image-20220820100200680</figcaption></figure><h5 id="_2、释放订单" tabindex="-1"><a class="header-anchor" href="#_2、释放订单" aria-hidden="true">#</a> 2、释放订单</h5><p>有可能订单创建成功后，由于各种原因，订单解锁比库存解锁后执行，因此订单解锁后可以给库存解锁发一条消息，告知库存服务及时解锁库存</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.1.png" alt="image-20220820100815031" tabindex="0" loading="lazy"><figcaption>image-20220820100815031</figcaption></figure><p>这次我们实现的业务功能为下面画的红色方框的部分</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.2.png" alt="消息队列流程" tabindex="0" loading="lazy"><figcaption>消息队列流程</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类里添加<code>orderReleaseOtherBinding</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderReleaseOtherBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;stock.release.stock.queue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span><span class="token constant">QUEUE</span><span class="token punctuation">,</span>
            <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.release.other.#&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.3.png" alt="image-20220820103021456" tabindex="0" loading="lazy"><figcaption>image-20220820103021456</figcaption></figure><p>复制<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.entity.OrderEntity</code>类，粘贴到<code>gulimall-common</code>模块的<code>com.atguigu.common.to</code>包下，并重命名为<code>OrderTo</code></p><p><a href="code/6.2.3.5.2.OrderTo.java">点击查看6.2.3.5.2.OrderTo类完整代码</a></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.4.png" alt="image-20220820104251097" tabindex="0" loading="lazy"><figcaption>image-20220820104251097</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类里添加<code>closeOrder</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CREATE_NEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OrderTo</span> orderTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">,</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.release.other&quot;</span><span class="token punctuation">,</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.5.png" alt="image-20220820104439272" tabindex="0" loading="lazy"><figcaption>image-20220820104439272</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.listener.StockReleaseListener</code>类里添加<code>handleStockLockedRelease</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitHandler</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStockLockedRelease</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;订单关闭，准备解锁库存&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        wareSkuService<span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.6.png" alt="image-20220820104842039" tabindex="0" loading="lazy"><figcaption>image-20220820104842039</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareSkuService</code>接口里添加<code>unLockStock(OrderTo orderTo);</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.7.png" alt="image-20220820104911873" tabindex="0" loading="lazy"><figcaption>image-20220820104911873</figcaption></figure><p>修改<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类的<code>unLockStock(StockLockedTo stockLockedTo)</code>方法，将这个<code>|| OrderStatusEnum.CREATE_NEW.getCode().equals(orderVo.getStatus())</code>删掉</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.8.png" alt="image-20220820103803950" tabindex="0" loading="lazy"><figcaption>image-20220820103803950</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareSkuServiceImpl</code>类里实现<code>unLockStock(OrderTo orderTo)</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 防止订单服务卡顿，导致订单状态消息一直改不了，库存消息优先到期。查订单状态新建状态，什么都不做就走了。
 * 导致卡顿的订单，永远不能解锁库存
 *
 * <span class="token keyword">@param</span> <span class="token parameter">orderTo</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> orderSn <span class="token operator">=</span> orderTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WareOrderTaskEntity</span> orderTaskEntity <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getOrderTaskByOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> taskId <span class="token operator">=</span> orderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">&gt;</span></span> orderTaskDetailEntities <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">getOrderTaskDetailsByTaskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WareOrderTaskDetailEntity</span> entity <span class="token operator">:</span> orderTaskDetailEntities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>entity<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>entity<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.2.9.png" alt="image-20220820111059199" tabindex="0" loading="lazy"><figcaption>image-20220820111059199</figcaption></figure><h5 id="_3、获取订单详细信息" tabindex="-1"><a class="header-anchor" href="#_3、获取订单详细信息" aria-hidden="true">#</a> 3、获取订单详细信息</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareOrderTaskService</code>接口里添加<code>getOrderTaskByOrderSn</code>抽象方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">WareOrderTaskEntity</span> <span class="token function">getOrderTaskByOrderSn</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.3.1.png" alt="image-20220820110519336" tabindex="0" loading="lazy"><figcaption>image-20220820110519336</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareOrderTaskServiceImpl</code>类里实现<code>getOrderTaskByOrderSn</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">WareOrderTaskEntity</span> <span class="token function">getOrderTaskByOrderSn</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">WareOrderTaskEntity</span><span class="token operator">::</span><span class="token function">getOrderSn</span><span class="token punctuation">,</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.3.2.png" alt="image-20220820110807546" tabindex="0" loading="lazy"><figcaption>image-20220820110807546</figcaption></figure><h5 id="_4、获取工作单详情" tabindex="-1"><a class="header-anchor" href="#_4、获取工作单详情" aria-hidden="true">#</a> 4、获取工作单详情</h5><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.WareOrderTaskDetailService</code>接口里添加<code>getOrderTaskDetailsByTaskId</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderTaskDetailsByTaskId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.4.1.png" alt="image-20220820111218019" tabindex="0" loading="lazy"><figcaption>image-20220820111218019</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.service.impl.WareOrderTaskDetailServiceImpl</code>类里实现<code>getOrderTaskDetailsByTaskId</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderTaskDetailsByTaskId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token operator">::</span><span class="token function">getTaskId</span><span class="token punctuation">,</span>taskId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token operator">::</span><span class="token function">getLockStatus</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.4.2.png" alt="image-20220820111428364" tabindex="0" loading="lazy"><figcaption>image-20220820111428364</figcaption></figure><h5 id="_5、测试-1" tabindex="-1"><a class="header-anchor" href="#_5、测试-1" aria-hidden="true">#</a> 5、测试</h5><p>测试时发现其他都正确，就是状态一直更新不成功</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.5.1.png" alt="image-20220822202205798" tabindex="0" loading="lazy"><figcaption>image-20220822202205798</figcaption></figure><p>查看<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.service.impl.OrderServiceImpl</code>类的<code>closeOrder</code>方法，发现更新时忘记写<code>id</code>了，在<code>OrderEntity update = new OrderEntity();</code>创建<code>OrderEntity</code>类对象后设置要更新的订单<code>id</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>update.setId(entity.getId());
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.5.2.png" alt="image-20220822203444329" tabindex="0" loading="lazy"><figcaption>image-20220822203444329</figcaption></figure><h5 id="_6、情况一" tabindex="-1"><a class="header-anchor" href="#_6、情况一" aria-hidden="true">#</a> 6、情况一</h5><p>（普通情况，先收到订单关闭消息，再收到解锁库存的消息，此时订单先关闭，订单关闭后通知了解锁库存服务，已将库存解锁，收到解锁库存的消息后库存已解锁）：这个视频在typora里无法播放</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
[//]: # (&lt;video src=&quot;video/6.2.4.3.6.mp4&quot;&gt;&lt;/video&gt;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_7、情况二" tabindex="-1"><a class="header-anchor" href="#_7、情况二" aria-hidden="true">#</a> 7、情况二</h5><p>（极端情况，由于网络原因或其他原因，先收到解锁库存的消息，此时不做处理，后收到订单关闭消息，订单关闭后再通知库存服务让其解锁库存）</p><p>我们可以设置订单关闭的时间大于库存释放时间，即订单关闭比库存解锁时间晚，用来模拟这种极端情况</p><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类的<code>orderDelayQueue</code>方法里，修改<code>key</code>为<code>x-message-ttl</code>的<code>value</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.7.1.png" alt="image-20220822210102386" tabindex="0" loading="lazy"><figcaption>image-20220822210102386</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.config.MyRabbitConfig</code>类的<code>stockDelayQueue</code>方法里，修改<code>key</code>为<code>x-message-ttl</code>的<code>value</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.7.2.png" alt="image-20220822210139229" tabindex="0" loading="lazy"><figcaption>image-20220822210139229</figcaption></figure><h5 id="_8、测试" tabindex="-1"><a class="header-anchor" href="#_8、测试" aria-hidden="true">#</a> 8、测试</h5><p>启动<code>GulimallWareApplication</code>服务后报了如下的错误，这是因为我们在代码里修改了<code>队列的配置</code>，修改后的2配置与<code>RabbitMQ</code>里队列的配置不一致导致报错了，我们只需删掉<code>RabbitMQ</code>里这些队列，让其自动再重新创建即可</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2022</span>-08-22 <span class="token number">21</span>:08:35.871 ERROR <span class="token number">7472</span> --- <span class="token punctuation">[</span>.168.56.10:5672<span class="token punctuation">]</span> o.s.a.r.c.CachingConnectionFactory       <span class="token builtin class-name">:</span> Channel shutdown: channel error<span class="token punctuation">;</span> protocol method: <span class="token comment">#method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg &#39;x-message-ttl&#39; for queue &#39;stock.delay.queue&#39; in vhost &#39;/&#39;: received &#39;60000&#39; but current is &#39;120000&#39;, class-id=50, method-id=10)</span>
<span class="token number">2022</span>-08-22 <span class="token number">21</span>:08:37.882 ERROR <span class="token number">7472</span> --- <span class="token punctuation">[</span>.168.56.10:5672<span class="token punctuation">]</span> o.s.a.r.c.CachingConnectionFactory       <span class="token builtin class-name">:</span> Channel shutdown: channel error<span class="token punctuation">;</span> protocol method: <span class="token comment">#method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg &#39;x-message-ttl&#39; for queue &#39;stock.delay.queue&#39; in vhost &#39;/&#39;: received &#39;60000&#39; but current is &#39;120000&#39;, class-id=50, method-id=10)</span>
<span class="token number">2022</span>-08-22 <span class="token number">21</span>:08:41.888 ERROR <span class="token number">7472</span> --- <span class="token punctuation">[</span>.168.56.10:5672<span class="token punctuation">]</span> o.s.a.r.c.CachingConnectionFactory       <span class="token builtin class-name">:</span> Channel shutdown: channel error<span class="token punctuation">;</span> protocol method: <span class="token comment">#method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg &#39;x-message-ttl&#39; for queue &#39;stock.delay.queue&#39; in vhost &#39;/&#39;: received &#39;60000&#39; but current is &#39;120000&#39;, class-id=50, method-id=10)</span>
<span class="token number">2022</span>-08-22 <span class="token number">21</span>:08:46.892 ERROR <span class="token number">7472</span> --- <span class="token punctuation">[</span>.168.56.10:5672<span class="token punctuation">]</span> o.s.a.r.c.CachingConnectionFactory       <span class="token builtin class-name">:</span> Channel shutdown: channel error<span class="token punctuation">;</span> protocol method: <span class="token comment">#method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg &#39;x-message-ttl&#39; for queue &#39;stock.delay.queue&#39; in vhost &#39;/&#39;: received &#39;60000&#39; but current is &#39;120000&#39;, class-id=50, method-id=10)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.8.1.png" alt="image-20220822210902236" tabindex="0" loading="lazy"><figcaption>image-20220822210902236</figcaption></figure><p>删掉<code>RabbitMQ</code>里的<code>stock.delay.queue</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.8.2.png" alt="image-20220822211025749" tabindex="0" loading="lazy"><figcaption>image-20220822211025749</figcaption></figure><p>删掉<code>RabbitMQ</code>里的<code>order.delay.queue</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.8.3.png" alt="image-20220822211028763" tabindex="0" loading="lazy"><figcaption>image-20220822211028763</figcaption></figure><p>此时可以看到即便是特殊情况，我们也能很好的进行处理，这个视频在typora里无法播放</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>
[//]: # (&lt;video src=&quot;video/6.2.4.3.8.mp4&quot;&gt;&lt;/video&gt;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_9、复原" tabindex="-1"><a class="header-anchor" href="#_9、复原" aria-hidden="true">#</a> 9、复原</h5><p>删掉<code>RabbitMQ</code>里的<code>order.delay.queue</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.9.1.png" alt="image-20220822214233325" tabindex="0" loading="lazy"><figcaption>image-20220822214233325</figcaption></figure><p>删掉<code>RabbitMQ</code>里的<code>stock.delay.queue</code>队列</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.9.2.png" alt="image-20220822214236017" tabindex="0" loading="lazy"><figcaption>image-20220822214236017</figcaption></figure><p>在<code>gulimall-order</code>模块的<code>com.atguigu.gulimall.order.config.MyMQConfig</code>类的<code>orderDelayQueue</code>方法里，重新修回<code>key</code>为<code>x-message-ttl</code>的<code>value</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>arguments.put(&quot;x-message-ttl&quot;, TimeUnit.MINUTES.toMillis(1));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.9.3.png" alt="image-20220822214459221" tabindex="0" loading="lazy"><figcaption>image-20220822214459221</figcaption></figure><p>在<code>gulimall-ware</code>模块的<code>com.atguigu.gulimall.ware.config.MyRabbitConfig</code>类的<code>stockDelayQueue</code>方法里，重新修改回<code>key</code>为<code>x-message-ttl</code>的<code>value</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>arguments.put(&quot;x-message-ttl&quot;, TimeUnit.MINUTES.toMillis(2));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.3.9.4.png" alt="image-20220822214432764" tabindex="0" loading="lazy"><figcaption>image-20220822214432764</figcaption></figure><h4 id="_4、如何保证消息可靠性" tabindex="-1"><a class="header-anchor" href="#_4、如何保证消息可靠性" aria-hidden="true">#</a> 4、如何保证消息可靠性</h4><h5 id="_1、消息丢失" tabindex="-1"><a class="header-anchor" href="#_1、消息丢失" aria-hidden="true">#</a> <strong>1、消息丢失</strong></h5><ul><li><p>消息发送出去，由于网络问题没有抵达服务器</p><ul><li><p>做好容错方法（try-catch），发送消息可能会网络失败，失败后要有重试机 制，可记录到数据库，采用定期扫描重发的方式</p></li><li><p>做好日志记录，每个消息状态是否都被服务器收到都应该记录</p></li><li><p>做好定期重发，如果消息没有发送成功，定期去数据库扫描未成功的消息进 行重发</p></li></ul></li><li><p>消息抵达Broker，Broker要将消息写入磁盘（持久化）才算成功。此时Broker尚 未持久化完成，宕机。</p><ul><li>publisher也必须加入确认回调机制，确认成功的消息，修改数据库消息状态。</li></ul></li><li><p>自动ACK的状态下。消费者收到消息，但没来得及消息然后宕机</p><ul><li>一定开启手动ACK，消费成功才移除，失败或者没来得及处理就noAck并重新入队</li></ul></li></ul><h5 id="_2、消息重复" tabindex="-1"><a class="header-anchor" href="#_2、消息重复" aria-hidden="true">#</a> <strong>2、消息重复</strong></h5><ul><li><p>消息消费成功，事务已经提交，ack时，机器宕机。导致没有ack成功，Broker的消息 重新由unack变为ready，并发送给其他消费者</p></li><li><p>消息消费失败，由于重试机制，自动又将消息发送出去</p></li><li><p>成功消费，ack时宕机，消息由unack变为ready，Broker又重新发送</p><ul><li><p>消费者的业务消费接口应该设计为幂等性的。比如扣库存有 工作单的状态标志</p></li><li><p>使用防重表（redis/mysql），发送消息每一个都有业务的唯 一标识，处理过就不用处理</p></li><li><p>rabbitMQ的每一个消息都有redelivered字段，可以获取是否 是被重新投递过来的，而不是第一次投递过来的</p></li></ul></li></ul><h5 id="_3、消息积压" tabindex="-1"><a class="header-anchor" href="#_3、消息积压" aria-hidden="true">#</a> <strong>3、消息积压</strong></h5><ul><li><p>消费者宕机积压</p></li><li><p>消费者消费能力不足积压</p></li><li><p>发送者发送流量太大</p><ul><li><p>上线更多的消费者，进行正常消费</p></li><li><p>上线专门的队列消费服务，将消息先批量取出来，记录数据库，离线慢慢处理</p></li></ul></li></ul><h4 id="_5、可能发生的情况" tabindex="-1"><a class="header-anchor" href="#_5、可能发生的情况" aria-hidden="true">#</a> 5、可能发生的情况</h4><h5 id="情况一" tabindex="-1"><a class="header-anchor" href="#情况一" aria-hidden="true">#</a> 情况一</h5><p>消息发送出去了，但由于网络问题没有抵达<code>Broker</code>消息代理(这里的消息代理指的是<code>RabbitMQ</code>)。我们在发送消息前可以先记录日志，定时扫描日志，及时发现没有抵达到消息代理的消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CREATE_NEW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OrderTo</span> orderTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">,</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderTo<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span><span class="token constant">CANCLED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//TODO 保证消息一定会发送出去，每一个消息都可以做好日志记录(给数据库保存每一个消息的详细信息)。</span>
            <span class="token comment">//定期扫描数据库将失败的消息再发送一遍;</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.release.other&quot;</span><span class="token punctuation">,</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//将没法送成功的消息进行重试发送。</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.5.1.1.png" alt="image-20220820113603559" tabindex="0" loading="lazy"><figcaption>image-20220820113603559</figcaption></figure><p>我们也可以在<code>gulimall_oms</code>模块里新建<code>mq_message</code>表，在消息发送前将消息状态设置为<code>已发送</code>，然后定期检查这张表，将订单状态一直为<code>已发送</code>的消息再次发送。（一直为<code>已发送</code>表示有可能是消息没有抵达）</p><div class="language-mysql line-numbers-mode" data-ext="mysql"><pre class="language-mysql"><code>CREATE TABLE `mq_message` (
    `message_id` CHAR ( 32 ) NOT NULL,
    `content` text,
    `to_exchane` VARCHAR ( 255 ) DEFAULT NULL,
    `routing_key` VARCHAR ( 255 ) DEFAULT NULL,
    `class_type` VARCHAR ( 255 ) DEFAULT NULL,
    `message_status` INT ( 1 ) DEFAULT &#39;0&#39; COMMENT &#39;0-新建 1-已发送 2-错误抵达 3-已抵达&#39;,
    `create_time` datetime DEFAULT NULL,
    `update_time` datetime DEFAULT NULL,
PRIMARY KEY ( `message_id` ) 
) ENGINE = INNODB DEFAULT CHARSET = utf8mb4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.5.1.2.png" alt="image-20220820112924243" tabindex="0" loading="lazy"><figcaption>image-20220820112924243</figcaption></figure><h5 id="情况二" tabindex="-1"><a class="header-anchor" href="#情况二" aria-hidden="true">#</a> 情况二</h5><p>消息抵达Broker，Broker要将消息写入磁盘（持久化）才算成功。此时Broker尚未持久化完成，然后突然宕机了。</p><p>可以在<code>publisher</code>消息的发布者里加入确认回调机制，确认成功的消息，修改数据库消息状态。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.5.2.png" alt="image-20220820151026268" tabindex="0" loading="lazy"><figcaption>image-20220820151026268</figcaption></figure><h5 id="情况三" tabindex="-1"><a class="header-anchor" href="#情况三" aria-hidden="true">#</a> 情况三</h5><p>自动<code>ACK</code>的状态下。消费者收到消息，但没来得及消费消息然后宕机，导致消息没有被处理。</p><p>一定开启手动<code>ACK</code>，消费成功后才移除消息，失败或者没来得及处理就<code>noAck</code>并重新入队（还要注意消息重复消费的问题，可以给消息设置唯一<code>id</code>，防止消息被重复消费）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.5.3.1.png" alt="image-20220822210413289" tabindex="0" loading="lazy"><figcaption>image-20220822210413289</figcaption></figure><p>消息消费成功，事务已经提交，准备<code>ack</code>时，机器宕机。导致没有<code>ack</code>成功，<code>Broker</code>的消息 重新由<code>unack</code>变为<code>ready</code>，并发送给其他消费者</p><p>消费者的业务消费接口应该设计为幂等性的。比如扣库存有 工作单的状态标志</p><p>使用防重表（使用<code>redis</code>或<code>mysql</code>），发送消息每一个都有业务的唯 一标识，处理过就不用处理</p><p><code>rabbitMQ</code>的每一个消息都有<code>redelivered</code>字段，可以获取是否是被重新投递过来的，而不是第一次投递过来的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/6.2.4.5.3.2.png" alt="image-20220822210402264" tabindex="0" loading="lazy"><figcaption>image-20220822210402264</figcaption></figure></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/apzs/apzs.github.io/edit/master/src/gulimall/advanced5.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: apzs@foxmaill.com">zhaoshuo</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.0.0-alpha.8</div></div></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2024 apzs</div></footer></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-YilgCgZO.js" defer></script>
  </body>
</html>
