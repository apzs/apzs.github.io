<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.5" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://apzs.github.io/sourceCode/spring/SpringSecurity/"><meta property="og:site_name" content="apzs"><meta property="og:title" content="认证"><meta property="og:description" content="认证 一 以往，我们使用继承WebSecurityConfigurerAdapter抽象接口的方式，修改自己的配置，但是至Spring Security5.7后，该方式就不被推荐了（注意将配置类加入至容器） public class SecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { } @Override public void configure(WebSecurity web) throws Exception { } }"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-05T06:05:15.000Z"><meta property="article:author" content="apzs"><meta property="article:modified_time" content="2024-03-05T06:05:15.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"认证","image":[""],"dateModified":"2024-03-05T06:05:15.000Z","author":[{"@type":"Person","name":"apzs","url":"https://apzs.eu.org"}]}</script><title>认证 | apzs</title><meta name="description" content="认证 一 以往，我们使用继承WebSecurityConfigurerAdapter抽象接口的方式，修改自己的配置，但是至Spring Security5.7后，该方式就不被推荐了（注意将配置类加入至容器） public class SecurityConfig extends WebSecurityConfigurerAdapter { @Override protected void configure(HttpSecurity http) throws Exception { } @Override public void configure(WebSecurity web) throws Exception { } }">
    <link rel="preload" href="/assets/style-EeUJz7Sj.css" as="style"><link rel="stylesheet" href="/assets/style-EeUJz7Sj.css">
    <link rel="modulepreload" href="/assets/app-db_OQQsY.js"><link rel="modulepreload" href="/assets/index.html-p166CSk-.js"><link rel="modulepreload" href="/assets/index.html-0QKlqw7B.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/assets/index.html-pHWXdINK.js" as="script"><link rel="prefetch" href="/assets/intro.html-B8GH9Why.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-gEURi3aX.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-OcxTIOHO.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-XR72c_om.js" as="script"><link rel="prefetch" href="/assets/4.maven.html-ZR4Y_K2h.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-M2icssIB.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-7Kx2gTnc.js" as="script"><link rel="prefetch" href="/assets/7.git.html-qXt_wASp.js" as="script"><link rel="prefetch" href="/assets/index.html-GFzEhmIP.js" as="script"><link rel="prefetch" href="/assets/disable.html-CuwxyM9v.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-NEQzx5Zz.js" as="script"><link rel="prefetch" href="/assets/layout.html-lHX6nth6.js" as="script"><link rel="prefetch" href="/assets/markdown.html-MpRqHFRe.js" as="script"><link rel="prefetch" href="/assets/page.html-x-ggS9aP.js" as="script"><link rel="prefetch" href="/assets/advanced1.html-9bBPC8sA.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-ZcYyohxw.js" as="script"><link rel="prefetch" href="/assets/advanced3.html--EENfr4C.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-qON-1HJR.js" as="script"><link rel="prefetch" href="/assets/advanced5.html-x_FAsfet.js" as="script"><link rel="prefetch" href="/assets/advanced6.html-7fOhj-hR.js" as="script"><link rel="prefetch" href="/assets/base1.html-eTaS1DsU.js" as="script"><link rel="prefetch" href="/assets/base2.html-uamOpGZW.js" as="script"><link rel="prefetch" href="/assets/cluster.html-054M96dh.js" as="script"><link rel="prefetch" href="/assets/1.Nginx的安装部署.html-uYbd2ebL.js" as="script"><link rel="prefetch" href="/assets/10.十分钟快速建站之在线论坛Discuz部署实战.html-QY6HLKuo.js" as="script"><link rel="prefetch" href="/assets/2.Nginx的的目录结构_基本运行原理及基本配置文件.html-Y7mqlMtZ.js" as="script"><link rel="prefetch" href="/assets/3.Nginx 虚拟主机与域名解析.html-sQ96m563.js" as="script"><link rel="prefetch" href="/assets/4.ServerName匹配规则.html-3xXeBzj4.js" as="script"><link rel="prefetch" href="/assets/5.反向代理在系统结构中的应用场景.html-k5aGGu3I.js" as="script"><link rel="prefetch" href="/assets/6.nginx动静分离及Rewrite实战.html-G-FLKxx7.js" as="script"><link rel="prefetch" href="/assets/7.nginx高可用及Keepalived实战.html-zyOteMot.js" as="script"><link rel="prefetch" href="/assets/8.Nginx配置防盗链(详细了解如何配置nginx防盗链).html-ZP_L6pTq.js" as="script"><link rel="prefetch" href="/assets/9.申请阿里云免费SSL证书并配置https访问实战.html-KHpQurCY.js" as="script"><link rel="prefetch" href="/assets/index.html-JHGBtjxR.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-bjBzt6JL.js" as="script"><link rel="prefetch" href="/assets/index.html-0VkVNp2J.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-QAsMGnnc.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-w0753rG7.js" as="script"><link rel="prefetch" href="/assets/index.html-pICozyRy.js" as="script"><link rel="prefetch" href="/assets/index.html-LsND_nHX.js" as="script"><link rel="prefetch" href="/assets/day01【Object类、常用API】-笔记.html-KOGCMVjn.js" as="script"><link rel="prefetch" href="/assets/day02【Collection、泛型】-笔记.html-O87TF1o2.js" as="script"><link rel="prefetch" href="/assets/day03【List、Set】.html-uOLEAQxu.js" as="script"><link rel="prefetch" href="/assets/day04 【Map】.html-wVrgo5WV.js" as="script"><link rel="prefetch" href="/assets/day05 【异常、线程】.html-keFwPayx.js" as="script"><link rel="prefetch" href="/assets/day06 【线程、同步】-笔记.html-Zp2PVn2X.js" as="script"><link rel="prefetch" href="/assets/day07【等待与唤醒案例、线程池、Lambda表达式】.html-_wTJY8FG.js" as="script"><link rel="prefetch" href="/assets/day08【File类、递归】.html-ytgMWtRZ.js" as="script"><link rel="prefetch" href="/assets/day09【字节流、字符流】.html-3TCqKRLK.js" as="script"><link rel="prefetch" href="/assets/day10【缓冲流、转换流、序列化流、打印流】.html-r9rQSbmb.js" as="script"><link rel="prefetch" href="/assets/day11【网络编程】.html-Zvlx--tb.js" as="script"><link rel="prefetch" href="/assets/day12【函数式接口】-笔记.html-3O7iFP_B.js" as="script"><link rel="prefetch" href="/assets/day13.1【Stream流】.html-tTs_GIJy.js" as="script"><link rel="prefetch" href="/assets/day13.2【方法引用】.html-F4M1t8l0.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-z934V7S3.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-y1W_8R2G.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-bFHCmOgf.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-9AAr2lIt.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-W1Rg-RB0.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-okTme7Cv.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-fsluqa98.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html-0FR7F5W3.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-CwpcGNNh.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-T9g22d05.js" as="script"><link rel="prefetch" href="/assets/index.html-liiu_EKl.js" as="script"><link rel="prefetch" href="/assets/index.html-IxRk3Ohd.js" as="script"><link rel="prefetch" href="/assets/index.html-qiUusNr1.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-byrPjTkh.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-z3DJu42D.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-vfxkftz5.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-jIXgwym4.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-oiw13F_a.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-n8EepeqG.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-5yv9NEC_.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-nS1PYjhk.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-cBl4nVoH.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-gkZIiZ0O.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-W7g-fbAg.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-zUWuxTai.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-8TaE0Zp1.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-rnTgMrUt.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-rT8S5BXV.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-KO3HDIMu.js" as="script"><link rel="prefetch" href="/assets/1.scss基础.html-7a79w5G1.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-uhthownJ.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-yV0wPlKP.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-EZgNsDIO.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-x8wQcT1s.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-vPTowO2E.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-Q5gjqvel.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-IkxemcdB.js" as="script"><link rel="prefetch" href="/assets/1.html.html-XP7fLhRZ.js" as="script"><link rel="prefetch" href="/assets/2.css.html-iD5KnMOI.js" as="script"><link rel="prefetch" href="/assets/3.mobile.html-k_6KIzVP.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html-cAJ4q7Ac.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-h6Mn4aXq.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-iXNFvl0G.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-eYCrWOga.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-7nS35Qvf.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html--6DfVamv.js" as="script"><link rel="prefetch" href="/assets/index.html-ANoDwuDF.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-MFo6bo05.js" as="script"><link rel="prefetch" href="/assets/1. Vue3入门.html-8MKbtpUa.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-N46eBw0r.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-AuK7S8JL.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-t37gH5mZ.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-gRvbBaoY.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-hN9ZWV7J.js" as="script"><link rel="prefetch" href="/assets/2. Pinia入门.html-bLyEEq1l.js" as="script"><link rel="prefetch" href="/assets/3. 项目起步.html-Zdt4idO-.js" as="script"><link rel="prefetch" href="/assets/4. Layout页.html-m8hubNti.js" as="script"><link rel="prefetch" href="/assets/5. Home页.html-XooE5Wxr.js" as="script"><link rel="prefetch" href="/assets/6. 一级分类页.html-8Q8zFNgV.js" as="script"><link rel="prefetch" href="/assets/7. 二级分类页.html-abMbyVsn.js" as="script"><link rel="prefetch" href="/assets/8. 商品详情.html-tM1-CXIh.js" as="script"><link rel="prefetch" href="/assets/9. 登录页.html-kiI-Zm8Q.js" as="script"><link rel="prefetch" href="/assets/0.uni-app前置知识.html-qpMfDU2j.js" as="script"><link rel="prefetch" href="/assets/01-项目起步.html-FuwveOvk.js" as="script"><link rel="prefetch" href="/assets/02-首页模块.html-CMvLGYbB.js" as="script"><link rel="prefetch" href="/assets/03-推荐模块.html-Y4QhLS25.js" as="script"><link rel="prefetch" href="/assets/04-分类模块.html-EiMYE6ec.js" as="script"><link rel="prefetch" href="/assets/05-详情模块.html-S6oqq8Am.js" as="script"><link rel="prefetch" href="/assets/06-登录模块.html-1Zs5MoZ_.js" as="script"><link rel="prefetch" href="/assets/07-用户模块.html-f61DRmB7.js" as="script"><link rel="prefetch" href="/assets/08-地址模块.html-hBbD5QY8.js" as="script"><link rel="prefetch" href="/assets/09-SKU模块.html-NW5AAfA-.js" as="script"><link rel="prefetch" href="/assets/10-购物车模块.html-VSBn_aff.js" as="script"><link rel="prefetch" href="/assets/11-订单模块.html-x63cg6Lu.js" as="script"><link rel="prefetch" href="/assets/12-项目打包.html-7iuLMMbc.js" as="script"><link rel="prefetch" href="/assets/index.html-9JBwGe9X.js" as="script"><link rel="prefetch" href="/assets/index.html-EjcBU5lt.js" as="script"><link rel="prefetch" href="/assets/index.html-I4z_CyW1.js" as="script"><link rel="prefetch" href="/assets/index.html-yJjipLz_.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-agnhV7l6.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-bVdW6071.js" as="script"><link rel="prefetch" href="/assets/index.html-nBxbKQIK.js" as="script"><link rel="prefetch" href="/assets/learn.html-BD7CfiUB.js" as="script"><link rel="prefetch" href="/assets/404.html-btkZhlkE.js" as="script"><link rel="prefetch" href="/assets/index.html-T17ErqbF.js" as="script"><link rel="prefetch" href="/assets/index.html-Jib5dSeG.js" as="script"><link rel="prefetch" href="/assets/index.html-JqXNyWB5.js" as="script"><link rel="prefetch" href="/assets/index.html-hY-RGNU1.js" as="script"><link rel="prefetch" href="/assets/index.html-oqCBIS_v.js" as="script"><link rel="prefetch" href="/assets/index.html-AJMwoc2R.js" as="script"><link rel="prefetch" href="/assets/index.html-7nfKGyCc.js" as="script"><link rel="prefetch" href="/assets/index.html-IfBIxRfC.js" as="script"><link rel="prefetch" href="/assets/index.html-muoKEAuh.js" as="script"><link rel="prefetch" href="/assets/index.html-t45lBcxI.js" as="script"><link rel="prefetch" href="/assets/index.html-lAWe1giX.js" as="script"><link rel="prefetch" href="/assets/index.html-kSDPDur8.js" as="script"><link rel="prefetch" href="/assets/index.html-gbNr7hUM.js" as="script"><link rel="prefetch" href="/assets/index.html-6QthmMSB.js" as="script"><link rel="prefetch" href="/assets/index.html-42CY4ac1.js" as="script"><link rel="prefetch" href="/assets/index.html-ueDLoTJ_.js" as="script"><link rel="prefetch" href="/assets/index.html-_LMh2RFh.js" as="script"><link rel="prefetch" href="/assets/index.html-8I_4T32_.js" as="script"><link rel="prefetch" href="/assets/index.html-tzRxRAhM.js" as="script"><link rel="prefetch" href="/assets/index.html-A2W4RlcH.js" as="script"><link rel="prefetch" href="/assets/index.html-G9n0k6L7.js" as="script"><link rel="prefetch" href="/assets/index.html-CrBH0s0U.js" as="script"><link rel="prefetch" href="/assets/index.html-LY4lUlKW.js" as="script"><link rel="prefetch" href="/assets/index.html-mLa21Q4L.js" as="script"><link rel="prefetch" href="/assets/index.html-YOwGpRFB.js" as="script"><link rel="prefetch" href="/assets/index.html-hK44yUtw.js" as="script"><link rel="prefetch" href="/assets/index.html-unBKqZcs.js" as="script"><link rel="prefetch" href="/assets/index.html-XjlmNyCs.js" as="script"><link rel="prefetch" href="/assets/index.html-JK2p7ZfK.js" as="script"><link rel="prefetch" href="/assets/index.html-lzCrPyBd.js" as="script"><link rel="prefetch" href="/assets/index.html-RTbSWDU_.js" as="script"><link rel="prefetch" href="/assets/index.html-dHsCb8RY.js" as="script"><link rel="prefetch" href="/assets/index.html-KlaSRFzG.js" as="script"><link rel="prefetch" href="/assets/index.html-0s9IjQ_S.js" as="script"><link rel="prefetch" href="/assets/index.html-5UVwpn2P.js" as="script"><link rel="prefetch" href="/assets/index.html-HXWTd4Hc.js" as="script"><link rel="prefetch" href="/assets/index.html-ZUKMfh1i.js" as="script"><link rel="prefetch" href="/assets/index.html-S6kMG4Fx.js" as="script"><link rel="prefetch" href="/assets/index.html-53Qkkx5i.js" as="script"><link rel="prefetch" href="/assets/index.html-yce2zXW0.js" as="script"><link rel="prefetch" href="/assets/index.html-l5b1TODm.js" as="script"><link rel="prefetch" href="/assets/index.html-RAdWGwdZ.js" as="script"><link rel="prefetch" href="/assets/index.html-OP-arxp4.js" as="script"><link rel="prefetch" href="/assets/index.html-onTroC3r.js" as="script"><link rel="prefetch" href="/assets/index.html-iaqZnKyP.js" as="script"><link rel="prefetch" href="/assets/index.html-tehrrtUn.js" as="script"><link rel="prefetch" href="/assets/index.html-uTpiuqPP.js" as="script"><link rel="prefetch" href="/assets/intro.html-Ios8BbBm.js" as="script"><link rel="prefetch" href="/assets/1.SpringBoot.html-y6zLNW1u.js" as="script"><link rel="prefetch" href="/assets/2.mysql.html-0PZ0s57O.js" as="script"><link rel="prefetch" href="/assets/3.docker.html-gxUTSYPQ.js" as="script"><link rel="prefetch" href="/assets/4.maven.html--Cspr9bY.js" as="script"><link rel="prefetch" href="/assets/5.linux.html-cEm4kKer.js" as="script"><link rel="prefetch" href="/assets/6.windows.html-SZSrVL8G.js" as="script"><link rel="prefetch" href="/assets/7.git.html-cDBhT0PQ.js" as="script"><link rel="prefetch" href="/assets/index.html-T-M5h4kF.js" as="script"><link rel="prefetch" href="/assets/disable.html-_5UVHWOa.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-QGtLeWmO.js" as="script"><link rel="prefetch" href="/assets/layout.html-hVorScz2.js" as="script"><link rel="prefetch" href="/assets/markdown.html-gwXcyCHz.js" as="script"><link rel="prefetch" href="/assets/page.html-h4yxCUPj.js" as="script"><link rel="prefetch" href="/assets/advanced1.html-yOpV4dsA.js" as="script"><link rel="prefetch" href="/assets/advanced2.html-e01Fn2x4.js" as="script"><link rel="prefetch" href="/assets/advanced3.html-QcF96RFt.js" as="script"><link rel="prefetch" href="/assets/advanced4.html-TZu722f7.js" as="script"><link rel="prefetch" href="/assets/advanced5.html-tdrxw_tW.js" as="script"><link rel="prefetch" href="/assets/advanced6.html-2GD2r1WF.js" as="script"><link rel="prefetch" href="/assets/base1.html-NJRH2aPP.js" as="script"><link rel="prefetch" href="/assets/base2.html-rw2rClH1.js" as="script"><link rel="prefetch" href="/assets/cluster.html-X0BNmKuI.js" as="script"><link rel="prefetch" href="/assets/1.Nginx的安装部署.html-eWqjEoXX.js" as="script"><link rel="prefetch" href="/assets/10.十分钟快速建站之在线论坛Discuz部署实战.html-hWaom5zu.js" as="script"><link rel="prefetch" href="/assets/2.Nginx的的目录结构_基本运行原理及基本配置文件.html-CmGbDXKe.js" as="script"><link rel="prefetch" href="/assets/3.Nginx 虚拟主机与域名解析.html-9ek9H1Gb.js" as="script"><link rel="prefetch" href="/assets/4.ServerName匹配规则.html-CYB95e_O.js" as="script"><link rel="prefetch" href="/assets/5.反向代理在系统结构中的应用场景.html-MNJ8UZxp.js" as="script"><link rel="prefetch" href="/assets/6.nginx动静分离及Rewrite实战.html-nCpiAEbS.js" as="script"><link rel="prefetch" href="/assets/7.nginx高可用及Keepalived实战.html-ejyJU-2j.js" as="script"><link rel="prefetch" href="/assets/8.Nginx配置防盗链(详细了解如何配置nginx防盗链).html-FYb0W8yS.js" as="script"><link rel="prefetch" href="/assets/9.申请阿里云免费SSL证书并配置https访问实战.html-z3ihRE56.js" as="script"><link rel="prefetch" href="/assets/index.html-cdvp4_Ul.js" as="script"><link rel="prefetch" href="/assets/SSM笔记.html-34mauKS6.js" as="script"><link rel="prefetch" href="/assets/index.html-0Os42Zce.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-xDstX_M3.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-8mH9T_zP.js" as="script"><link rel="prefetch" href="/assets/index.html-ApOQEbuD.js" as="script"><link rel="prefetch" href="/assets/index.html--UroL_c7.js" as="script"><link rel="prefetch" href="/assets/day01【Object类、常用API】-笔记.html-xhAWLoYU.js" as="script"><link rel="prefetch" href="/assets/day02【Collection、泛型】-笔记.html-GpSCfolp.js" as="script"><link rel="prefetch" href="/assets/day03【List、Set】.html-ENC-91tH.js" as="script"><link rel="prefetch" href="/assets/day04 【Map】.html-aW9GhIRw.js" as="script"><link rel="prefetch" href="/assets/day05 【异常、线程】.html-qKDLEY4A.js" as="script"><link rel="prefetch" href="/assets/day06 【线程、同步】-笔记.html-pLTHodGg.js" as="script"><link rel="prefetch" href="/assets/day07【等待与唤醒案例、线程池、Lambda表达式】.html-Hqs_SqLM.js" as="script"><link rel="prefetch" href="/assets/day08【File类、递归】.html-k-_IXL8e.js" as="script"><link rel="prefetch" href="/assets/day09【字节流、字符流】.html-ya2f-SsA.js" as="script"><link rel="prefetch" href="/assets/day10【缓冲流、转换流、序列化流、打印流】.html-9MJKY5Bk.js" as="script"><link rel="prefetch" href="/assets/day11【网络编程】.html-CQdBhT5e.js" as="script"><link rel="prefetch" href="/assets/day12【函数式接口】-笔记.html-iXebWMPz.js" as="script"><link rel="prefetch" href="/assets/day13.1【Stream流】.html-8DarjU4a.js" as="script"><link rel="prefetch" href="/assets/day13.2【方法引用】.html-1jDTk-eD.js" as="script"><link rel="prefetch" href="/assets/1.MySQL.html-kttceYJA.js" as="script"><link rel="prefetch" href="/assets/2.JDBC.html-Ch1EV4HA.js" as="script"><link rel="prefetch" href="/assets/3.Maven基础_MyBatis.html-O-ASkdgK.js" as="script"><link rel="prefetch" href="/assets/4.HTML_CSS_JS.html-27dmKbZD.js" as="script"><link rel="prefetch" href="/assets/5.HTTP_Tomcat_Servlet.html-bBNpOSNW.js" as="script"><link rel="prefetch" href="/assets/6.Request_Response_JSP_MVC.html-cUsCbgYU.js" as="script"><link rel="prefetch" href="/assets/7.会话技术Cookie_Session.html-juEJ79df.js" as="script"><link rel="prefetch" href="/assets/8.Filter_Listener_Ajax_Axios_JSON.html--7sBJq2S.js" as="script"><link rel="prefetch" href="/assets/9.VUE_Element整合Javaweb的商品管理系统.html-n5pvnmQY.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-7Mg2t_Ng.js" as="script"><link rel="prefetch" href="/assets/index.html-HZvhjqTB.js" as="script"><link rel="prefetch" href="/assets/index.html-5EK37o5K.js" as="script"><link rel="prefetch" href="/assets/index.html-m4O5ydjh.js" as="script"><link rel="prefetch" href="/assets/Netty01-nio.html-PpZyrxW7.js" as="script"><link rel="prefetch" href="/assets/Netty02-入门.html-Ma-No02-.js" as="script"><link rel="prefetch" href="/assets/Netty03-进阶.html-YuBKYtmE.js" as="script"><link rel="prefetch" href="/assets/Netty04-优化与源码.html-_1IC7Mi4.js" as="script"><link rel="prefetch" href="/assets/Arthas基础-笔记.html-3Me-ozdB.js" as="script"><link rel="prefetch" href="/assets/Arthas进阶-笔记.html-IzKeA3f4.js" as="script"><link rel="prefetch" href="/assets/ShardingSphere5.html-56rJwolp.js" as="script"><link rel="prefetch" href="/assets/docker环境安装.html-yApolYoS.js" as="script"><link rel="prefetch" href="/assets/mongodb.html-IPWNY4bF.js" as="script"><link rel="prefetch" href="/assets/1.npm基础.html-hbD72KIV.js" as="script"><link rel="prefetch" href="/assets/01 【react入门】.html-CLRM1yZJ.js" as="script"><link rel="prefetch" href="/assets/02 【react脚手架】.html-JnTd_3MH.js" as="script"><link rel="prefetch" href="/assets/03 【路由】.html-ssylLv09.js" as="script"><link rel="prefetch" href="/assets/05 【redux】.html-RgxSKqRE.js" as="script"><link rel="prefetch" href="/assets/06 【hooks】.html-_lf-n-EK.js" as="script"><link rel="prefetch" href="/assets/07 【react高级】.html-0Mt2ycU2.js" as="script"><link rel="prefetch" href="/assets/1.scss基础.html-bRgk_huQ.js" as="script"><link rel="prefetch" href="/assets/1.vue2.html-1AHhdugq.js" as="script"><link rel="prefetch" href="/assets/2.vue3.html-vn2HobRI.js" as="script"><link rel="prefetch" href="/assets/3.创建vue项目的几种方式.html-W7TOn8Nc.js" as="script"><link rel="prefetch" href="/assets/1.基础.html-n0X1WREA.js" as="script"><link rel="prefetch" href="/assets/2.高级.html-68pIIMxT.js" as="script"><link rel="prefetch" href="/assets/3.项目配置.html-bdZiy5gA.js" as="script"><link rel="prefetch" href="/assets/4.原理分析.html-ps8ULUeE.js" as="script"><link rel="prefetch" href="/assets/1.html.html-3lpFJ7Kn.js" as="script"><link rel="prefetch" href="/assets/2.css.html-jjsfv6nd.js" as="script"><link rel="prefetch" href="/assets/3.mobile.html-jIwMZDtD.js" as="script"><link rel="prefetch" href="/assets/1.JS基础.html-XDRLW69R.js" as="script"><link rel="prefetch" href="/assets/2.WebApi（BOM和DOM）.html-vO4KxOFO.js" as="script"><link rel="prefetch" href="/assets/3.Ajax.html-e9T9idft.js" as="script"><link rel="prefetch" href="/assets/4.js高级.html-V6dSQn7r.js" as="script"><link rel="prefetch" href="/assets/5.ECMAScript6.html-LN0aPCUy.js" as="script"><link rel="prefetch" href="/assets/6.Promise.html-QZ6_ee8i.js" as="script"><link rel="prefetch" href="/assets/index.html-k83MRZdY.js" as="script"><link rel="prefetch" href="/assets/使用vuepress-theme-hope.html-W_aXmiFV.js" as="script"><link rel="prefetch" href="/assets/1. Vue3入门.html-hhSVFHUw.js" as="script"><link rel="prefetch" href="/assets/10. 购物车.html-O3Ih_j-t.js" as="script"><link rel="prefetch" href="/assets/11. 订单页.html-56TDvFtT.js" as="script"><link rel="prefetch" href="/assets/12. 支付页.html-YmrSJQQZ.js" as="script"><link rel="prefetch" href="/assets/13. 会员中心.html-d9-Ai_vw.js" as="script"><link rel="prefetch" href="/assets/14. 拓展部分.html-BZ0_rd78.js" as="script"><link rel="prefetch" href="/assets/2. Pinia入门.html-RNEwksxb.js" as="script"><link rel="prefetch" href="/assets/3. 项目起步.html-jbP8JLjA.js" as="script"><link rel="prefetch" href="/assets/4. Layout页.html-UqIt2nf0.js" as="script"><link rel="prefetch" href="/assets/5. Home页.html-ciG8UNX-.js" as="script"><link rel="prefetch" href="/assets/6. 一级分类页.html-xcopvdT4.js" as="script"><link rel="prefetch" href="/assets/7. 二级分类页.html-LT-3liJf.js" as="script"><link rel="prefetch" href="/assets/8. 商品详情.html-zWSEZ5tD.js" as="script"><link rel="prefetch" href="/assets/9. 登录页.html-8No7mnWS.js" as="script"><link rel="prefetch" href="/assets/0.uni-app前置知识.html-U412gRrr.js" as="script"><link rel="prefetch" href="/assets/01-项目起步.html-sHsUgLnN.js" as="script"><link rel="prefetch" href="/assets/02-首页模块.html-i762t70c.js" as="script"><link rel="prefetch" href="/assets/03-推荐模块.html-EbCHOY-H.js" as="script"><link rel="prefetch" href="/assets/04-分类模块.html-_1T4RRKP.js" as="script"><link rel="prefetch" href="/assets/05-详情模块.html-L0S-anwa.js" as="script"><link rel="prefetch" href="/assets/06-登录模块.html-ckkOUtfT.js" as="script"><link rel="prefetch" href="/assets/07-用户模块.html-IGvDOACT.js" as="script"><link rel="prefetch" href="/assets/08-地址模块.html-cXLoSCSi.js" as="script"><link rel="prefetch" href="/assets/09-SKU模块.html-IgibE1ak.js" as="script"><link rel="prefetch" href="/assets/10-购物车模块.html-wdSeDZv-.js" as="script"><link rel="prefetch" href="/assets/11-订单模块.html-I_2hzgoS.js" as="script"><link rel="prefetch" href="/assets/12-项目打包.html-dczJqlp9.js" as="script"><link rel="prefetch" href="/assets/index.html-zjPeOKM4.js" as="script"><link rel="prefetch" href="/assets/index.html-SAN04a2u.js" as="script"><link rel="prefetch" href="/assets/index.html-0fhGPOq2.js" as="script"><link rel="prefetch" href="/assets/index.html-SRwEp2G-.js" as="script"><link rel="prefetch" href="/assets/1.自动配置 _ 请求处理.html-cXvoOXA7.js" as="script"><link rel="prefetch" href="/assets/2.异常处理.html-8_2Y7wsY.js" as="script"><link rel="prefetch" href="/assets/index.html-B4Qchm_X.js" as="script"><link rel="prefetch" href="/assets/learn.html-x2QPkN_9.js" as="script"><link rel="prefetch" href="/assets/404.html-yT0ZnZzZ.js" as="script"><link rel="prefetch" href="/assets/index.html-YCMLAisR.js" as="script"><link rel="prefetch" href="/assets/index.html-gSb1KOxz.js" as="script"><link rel="prefetch" href="/assets/index.html-aqc-p8LG.js" as="script"><link rel="prefetch" href="/assets/index.html-qNd4jneF.js" as="script"><link rel="prefetch" href="/assets/index.html-Tcmw6VVD.js" as="script"><link rel="prefetch" href="/assets/index.html-1iO55x2S.js" as="script"><link rel="prefetch" href="/assets/index.html-Rn3OnOVo.js" as="script"><link rel="prefetch" href="/assets/index.html-0OLx6zPi.js" as="script"><link rel="prefetch" href="/assets/index.html-kABQiLsH.js" as="script"><link rel="prefetch" href="/assets/index.html-DGLOm8Kn.js" as="script"><link rel="prefetch" href="/assets/index.html-JgKw9IUg.js" as="script"><link rel="prefetch" href="/assets/index.html-NcRKCsyK.js" as="script"><link rel="prefetch" href="/assets/index.html-7WQSM01i.js" as="script"><link rel="prefetch" href="/assets/index.html-DmuplBtf.js" as="script"><link rel="prefetch" href="/assets/index.html-iZwVHUvB.js" as="script"><link rel="prefetch" href="/assets/index.html-G1CAUX9X.js" as="script"><link rel="prefetch" href="/assets/index.html-VgpFN6z1.js" as="script"><link rel="prefetch" href="/assets/index.html-ZXl1cRL7.js" as="script"><link rel="prefetch" href="/assets/index.html-dXtpEhux.js" as="script"><link rel="prefetch" href="/assets/index.html-My4ZJE_T.js" as="script"><link rel="prefetch" href="/assets/index.html-qb9EPt3t.js" as="script"><link rel="prefetch" href="/assets/index.html-Oy8KvczV.js" as="script"><link rel="prefetch" href="/assets/index.html-1JdscVQL.js" as="script"><link rel="prefetch" href="/assets/index.html-VMmS48e4.js" as="script"><link rel="prefetch" href="/assets/index.html-p2BGUIkw.js" as="script"><link rel="prefetch" href="/assets/index.html-qHl-jjYs.js" as="script"><link rel="prefetch" href="/assets/index.html-6ydkr6un.js" as="script"><link rel="prefetch" href="/assets/index.html-OoMorjqQ.js" as="script"><link rel="prefetch" href="/assets/index.html-ZU1VQn2H.js" as="script"><link rel="prefetch" href="/assets/index.html-FsBlZX_Y.js" as="script"><link rel="prefetch" href="/assets/index.html-mrZxgsn1.js" as="script"><link rel="prefetch" href="/assets/index.html-Rqnw89g_.js" as="script"><link rel="prefetch" href="/assets/index.html-SpNz5luL.js" as="script"><link rel="prefetch" href="/assets/index.html-7KOIDJt6.js" as="script"><link rel="prefetch" href="/assets/index.html-W7hGVU5L.js" as="script"><link rel="prefetch" href="/assets/index.html-eVsVE7-H.js" as="script"><link rel="prefetch" href="/assets/index.html-Wx5iqY9C.js" as="script"><link rel="prefetch" href="/assets/index.html-vonhsBzY.js" as="script"><link rel="prefetch" href="/assets/index.html-fi1pMZbX.js" as="script"><link rel="prefetch" href="/assets/index.html-qZDkWb8t.js" as="script"><link rel="prefetch" href="/assets/index.html-CEbK1BJW.js" as="script"><link rel="prefetch" href="/assets/index.html-lIfmGTfx.js" as="script"><link rel="prefetch" href="/assets/index.html-eLYu30-n.js" as="script"><link rel="prefetch" href="/assets/index.html-BstdJstq.js" as="script"><link rel="prefetch" href="/assets/index.html-N2bEJcce.js" as="script"><link rel="prefetch" href="/assets/index.html-1jb5Bt97.js" as="script"><link rel="prefetch" href="/assets/waline-meta-w40geAFS.js" as="script"><link rel="prefetch" href="/assets/component-RhdSQaCV.js" as="script"><link rel="prefetch" href="/assets/vue-repl-E__IxP25.js" as="script"><link rel="prefetch" href="/assets/codemirror-editor-5vxvyvKP.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-i2ohwMnJ.js" as="script"><link rel="prefetch" href="/assets/pageview-iUO6_8x2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-5mMFw1vG.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" aria-hidden><!----><span class="vp-site-name hide-in-pad">apzs</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="博客主页" class="vp-link nav-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>html&amp;css</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="html基础" class="vp-link nav-link nav-link" href="/front-base/html_css/1.html.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>html基础<!----></a></li><li class="dropdown-subitem"><a aria-label="css基础" class="vp-link nav-link nav-link" href="/front-base/html_css/2.css.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>css基础<!----></a></li><li class="dropdown-subitem"><a aria-label="移动端布局" class="vp-link nav-link nav-link" href="/front-base/html_css/3.mobile.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>移动端布局<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>js</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="js基础" class="vp-link nav-link nav-link" href="/front-base/js/1.JS%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js基础<!----></a></li><li class="dropdown-subitem"><a aria-label="WebApi" class="vp-link nav-link nav-link" href="/front-base/js/2.WebApi%EF%BC%88BOM%E5%92%8CDOM%EF%BC%89.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>WebApi<!----></a></li><li class="dropdown-subitem"><a aria-label="Ajax" class="vp-link nav-link nav-link" href="/front-base/js/3.Ajax.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Ajax<!----></a></li><li class="dropdown-subitem"><a aria-label="js高级" class="vp-link nav-link nav-link" href="/front-base/js/4.js%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>js高级<!----></a></li><li class="dropdown-subitem"><a aria-label="ECMAScript6" class="vp-link nav-link nav-link" href="/front-base/js/5.ECMAScript6.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ECMAScript6<!----></a></li><li class="dropdown-subitem"><a aria-label="Promise" class="vp-link nav-link nav-link" href="/front-base/js/6.Promise.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Promise<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>前端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>前置知识</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="npm基本使用" class="vp-link nav-link nav-link" href="/front-advance/npm/1.npm%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>npm基本使用<!----></a></li><li class="dropdown-subitem"><a aria-label="scss" class="vp-link nav-link nav-link" href="/front-advance/scss/1.scss%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>scss<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>vue</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="vue2" class="vp-link nav-link nav-link" href="/front-advance/vue/1.vue2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue2<!----></a></li><li class="dropdown-subitem"><a aria-label="vue3" class="vp-link nav-link nav-link" href="/front-advance/vue/2.vue3.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>vue3<!----></a></li><li class="dropdown-subitem"><a aria-label="创建vue项目的几种方式" class="vp-link nav-link nav-link" href="/front-advance/vue/3.%E5%88%9B%E5%BB%BAvue%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>创建vue项目的几种方式<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>react</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="react入门" class="vp-link nav-link nav-link" href="/front-advance/react/01%20%E3%80%90react%E5%85%A5%E9%97%A8%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react入门<!----></a></li><li class="dropdown-subitem"><a aria-label="react脚手架" class="vp-link nav-link nav-link" href="/front-advance/react/02%20%E3%80%90react%E8%84%9A%E6%89%8B%E6%9E%B6%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react脚手架<!----></a></li><li class="dropdown-subitem"><a aria-label="路由" class="vp-link nav-link nav-link" href="/front-advance/react/03%20%E3%80%90%E8%B7%AF%E7%94%B1%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>路由<!----></a></li><li class="dropdown-subitem"><a aria-label="redux" class="vp-link nav-link nav-link" href="/front-advance/react/05%20%E3%80%90redux%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redux<!----></a></li><li class="dropdown-subitem"><a aria-label="hooks" class="vp-link nav-link nav-link" href="/front-advance/react/06%20%E3%80%90hooks%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>hooks<!----></a></li><li class="dropdown-subitem"><a aria-label="react高级" class="vp-link nav-link nav-link" href="/front-advance/react/07%20%E3%80%90react%E9%AB%98%E7%BA%A7%E3%80%91.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>react高级<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>webpack</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="基础" class="vp-link nav-link nav-link" href="/front-advance/webpack/1.%E5%9F%BA%E7%A1%80.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>基础<!----></a></li><li class="dropdown-subitem"><a aria-label="高级" class="vp-link nav-link nav-link" href="/front-advance/webpack/2.%E9%AB%98%E7%BA%A7.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>高级<!----></a></li><li class="dropdown-subitem"><a aria-label="项目配置" class="vp-link nav-link nav-link" href="/front-advance/webpack/3.%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>项目配置<!----></a></li><li class="dropdown-subitem"><a aria-label="原理分析" class="vp-link nav-link nav-link" href="/front-advance/webpack/4.%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>原理分析<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="前端项目"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>前端项目</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="小兔鲜PC (Vue3+Pinia+js)" class="vp-link nav-link nav-link" href="/front-project/小兔鲜PC%20(Vue3_Pinia_js).html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜PC (Vue3+Pinia+js)<!----></a></li><li class="dropdown-item"><a aria-label="小兔鲜儿uni-app (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/小兔鲜儿uni-app%20(Vue3_ts).html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>小兔鲜儿uni-app (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="尚品汇 (Vue2+js)" class="vp-link nav-link nav-link" href="/front-project/%E5%B0%9A%E5%93%81%E6%B1%87%20(Vue2_js)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>尚品汇 (Vue2+js)<!----></a></li><li class="dropdown-item"><a aria-label="硅谷甄选 (Vue3+ts)" class="vp-link nav-link nav-link" href="/front-project/%E7%A1%85%E8%B0%B7%E7%94%84%E9%80%89%20(Vue3_ts)/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>硅谷甄选 (Vue3+ts)<!----></a></li><li class="dropdown-item"><a aria-label="个人博客搭建教程" class="vp-link nav-link nav-link" href="/front-project/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>个人博客搭建教程<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端基础"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="Java基础语法" class="vp-link nav-link nav-link" href="/back-base/1.Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java基础语法<!----></a></li><li class="dropdown-item"><a aria-label="Java核心" class="vp-link nav-link nav-link" href="/back-base/2.Java%E6%A0%B8%E5%BF%83/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Java核心<!----></a></li><li class="dropdown-item"><a aria-label="JavaWeb" class="vp-link nav-link nav-link" href="/back-base/3.JavaWeb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>JavaWeb<!----></a></li><li class="dropdown-item"><a aria-label="mysql" class="vp-link nav-link nav-link" href="/back-base/4.mysql/MySQL.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mysql<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端进阶"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SSM" class="vp-link nav-link nav-link" href="/back-advance/5.SSM/SSM%E7%AC%94%E8%AE%B0.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SSM<!----></a></li><li class="dropdown-item"><a aria-label="redis" class="vp-link nav-link nav-link" href="/back-advance/6.redis/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>redis<!----></a></li><li class="dropdown-item"><a aria-label="SpringBoot" class="vp-link nav-link nav-link" href="/back-advance/7.SpringBoot2.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringBoot<!----></a></li><li class="dropdown-item"><a aria-label="git" class="vp-link nav-link nav-link" href="/back-advance/9.git/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>git<!----></a></li><li class="dropdown-item"><a aria-label="nginx" class="vp-link nav-link nav-link" href="/back-advance/10.nginx.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>nginx<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="后端高级"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>后端高级</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="docker" class="vp-link nav-link nav-link" href="/back-senior/11.docker/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>docker<!----></a></li><li class="dropdown-item"><a aria-label="gitlab+jeckins" class="vp-link nav-link nav-link" href="/back-senior/12.gitlab_jeckins/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>gitlab+jeckins<!----></a></li><li class="dropdown-item"><a aria-label="SpringSecurity" class="vp-link nav-link nav-link" href="/back-senior/13.SpringSecurity/"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>SpringSecurity<!----></a></li><li class="dropdown-item"><a aria-label="Netty" class="vp-link nav-link nav-link" href="/back-senior/14.Netty.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Netty<!----></a></li><li class="dropdown-item"><a aria-label="arthas" class="vp-link nav-link nav-link" href="/back-senior/15.arthas.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>arthas<!----></a></li><li class="dropdown-item"><a aria-label="ShardingSphere5" class="vp-link nav-link nav-link" href="/back-senior/16.ShardingSphere5.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>ShardingSphere5<!----></a></li><li class="dropdown-item"><a aria-label="mongodb" class="vp-link nav-link nav-link" href="/back-senior/17.mongodb/mongodb.html"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>mongodb<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="谷粒商城"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>谷粒商城</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>基础篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="前后端环境搭建" class="vp-link nav-link nav-link" href="/gulimall/base1.html"><!---->前后端环境搭建<!----></a></li><li class="dropdown-subitem"><a aria-label="前后端联调" class="vp-link nav-link nav-link" href="/gulimall/base2.html"><!---->前后端联调<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>高级篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Elasticsearch &amp; nginx" class="vp-link nav-link nav-link" href="/gulimall/advanced1.html"><!---->Elasticsearch &amp; nginx<!----></a></li><li class="dropdown-subitem"><a aria-label="Redisson &amp; SpringCache" class="vp-link nav-link nav-link" href="/gulimall/advanced2.html"><!---->Redisson &amp; SpringCache<!----></a></li><li class="dropdown-subitem"><a aria-label="CompletableFuture" class="vp-link nav-link nav-link" href="/gulimall/advanced3.html"><!---->CompletableFuture<!----></a></li><li class="dropdown-subitem"><a aria-label="Spring Session &amp; OAuth2.0" class="vp-link nav-link nav-link" href="/gulimall/advanced4.html"><!---->Spring Session &amp; OAuth2.0<!----></a></li><li class="dropdown-subitem"><a aria-label="RabbitMQ &amp; Seata" class="vp-link nav-link nav-link" href="/gulimall/advanced5.html"><!---->RabbitMQ &amp; Seata<!----></a></li><li class="dropdown-subitem"><a aria-label="支付 &amp; Sentinel" class="vp-link nav-link nav-link" href="/gulimall/advanced6.html"><!---->支付 &amp; Sentinel<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>集群篇</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="K8s &amp; kubesphere" class="vp-link nav-link nav-link" href="/gulimall/cluster.html"><!---->K8s &amp; kubesphere<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="常用功能"><span class="title"><!---->常用功能</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="SpringBoot相关" class="vp-link nav-link nav-link" href="/CommonFunctions/1.SpringBoot.html"><!---->SpringBoot相关<!----></a></li><li class="dropdown-item"><a aria-label="mysql相关" class="vp-link nav-link nav-link" href="/CommonFunctions/2.mysql.html"><!---->mysql相关<!----></a></li><li class="dropdown-item"><a aria-label="docker相关" class="vp-link nav-link nav-link" href="/CommonFunctions/3.docker.html"><!---->docker相关<!----></a></li><li class="dropdown-item"><a aria-label="maven相关" class="vp-link nav-link nav-link" href="/CommonFunctions/4.maven.html"><!---->maven相关<!----></a></li><li class="dropdown-item"><a aria-label="linux相关" class="vp-link nav-link nav-link" href="/CommonFunctions/5.linux.html"><!---->linux相关<!----></a></li><li class="dropdown-item"><a aria-label="windows相关" class="vp-link nav-link nav-link" href="/CommonFunctions/6.windows.html"><!---->windows相关<!----></a></li><li class="dropdown-item"><a aria-label="git相关" class="vp-link nav-link nav-link" href="/CommonFunctions/7.git.html"><!---->git相关<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="阅读源码"><span class="title"><!---->阅读源码</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="搭建SpringBoot源码环境" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/"><!---->搭建SpringBoot源码环境<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot自动配置 &amp; 请求处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/1.%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%20_%20%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86.html"><!---->SpringBoot自动配置 &amp; 请求处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringBoot异常处理" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringBoot/2.%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"><!---->SpringBoot异常处理<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity源码阅读" class="vp-link nav-link active nav-link active" href="/sourceCode/spring/SpringSecurity/"><!---->SpringSecurity源码阅读<!----></a></li><li class="dropdown-subitem"><a aria-label="SpringSecurity基础知识" class="vp-link nav-link nav-link" href="/sourceCode/spring/SpringSecurity/learn.html"><!---->SpringSecurity基础知识<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Tomcat</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="Tomcat源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/tomcat.html"><!---->Tomcat源码阅读<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Mybatis</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a aria-label="MyBatis源码阅读" class="vp-link nav-link nav-link" href="/sourceCode/mybatis/"><!---->MyBatis源码阅读<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/apzs/apzs.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="HttpSecurity的结构（构建SecurityFilterChain）" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#httpsecurity的结构-构建securityfilterchain"><!---->HttpSecurity的结构（构建SecurityFilterChain）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="WebSecurity的结构（构建Filter）" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#websecurity的结构-构建filter"><!---->WebSecurity的结构（构建Filter）<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="构建对象" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#构建对象"><!---->构建对象<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="HttpSecurity构建DefaultSecurityFilterChain" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#httpsecurity构建defaultsecurityfilterchain"><!---->HttpSecurity构建DefaultSecurityFilterChain<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="WebSecurity构建FilterChainProxy" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#websecurity构建filterchainproxy"><!---->WebSecurity构建FilterChainProxy<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="1、AbstractConfiguredSecurityBuilder" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#_1、abstractconfiguredsecuritybuilder"><!---->1、AbstractConfiguredSecurityBuilder<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="2、SecurityConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#_2、securityconfigurer"><!---->2、SecurityConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthenticationManager" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authenticationmanager"><!---->AuthenticationManager<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthenticationManagerBuilder" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authenticationmanagerbuilder"><!---->AuthenticationManagerBuilder<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ProviderManager" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#providermanager"><!---->ProviderManager<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthenticationProvider" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authenticationprovider"><!---->AuthenticationProvider<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Authentication" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authentication"><!---->Authentication<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="DaoAuthenticationProvider" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#daoauthenticationprovider"><!---->DaoAuthenticationProvider<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="retrieveUser" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#retrieveuser"><!---->retrieveUser<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="additionalAuthenticationChecks" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#additionalauthenticationchecks"><!---->additionalAuthenticationChecks<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="UsernamePasswordAuthenticationFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#usernamepasswordauthenticationfilter"><!---->UsernamePasswordAuthenticationFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="FormLoginConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#formloginconfigurer"><!---->FormLoginConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContext" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontext"><!---->SecurityContext<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContextHolder" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextholder"><!---->SecurityContextHolder<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContextHolderStrategy" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextholderstrategy"><!---->SecurityContextHolderStrategy<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContextRepository" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextrepository"><!---->SecurityContextRepository<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContextPersistenceFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextpersistencefilter"><!---->SecurityContextPersistenceFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContextHolderFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextholderfilter"><!---->SecurityContextHolderFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SecurityContextConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextconfigurer"><!---->SecurityContextConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="FilterChainProxy" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#filterchainproxy"><!---->FilterChainProxy<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="RememberMeAuthenticationFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#remembermeauthenticationfilter"><!---->RememberMeAuthenticationFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="RememberMeServices" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#remembermeservices"><!---->RememberMeServices<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="RememberMeAuthenticationToken" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#remembermeauthenticationtoken"><!---->RememberMeAuthenticationToken<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="RememberMeAuthenticationProvider" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#remembermeauthenticationprovider"><!---->RememberMeAuthenticationProvider<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AbstractRememberMeServices" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#abstractremembermeservices"><!---->AbstractRememberMeServices<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="TokenBasedRememberMeServices" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#tokenbasedremembermeservices"><!---->TokenBasedRememberMeServices<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="PersistentTokenBasedRememberMeServices" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#persistenttokenbasedremembermeservices"><!---->PersistentTokenBasedRememberMeServices<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="RememberMeConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#remembermeconfigurer"><!---->RememberMeConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SessionManagementFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#sessionmanagementfilter"><!---->SessionManagementFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SessionAuthenticationStrategy" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#sessionauthenticationstrategy"><!---->SessionAuthenticationStrategy<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="RegisterSessionAuthenticationStrategy" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#registersessionauthenticationstrategy"><!---->RegisterSessionAuthenticationStrategy<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ConcurrentSessionControlAuthenticationStrategy" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#concurrentsessioncontrolauthenticationstrategy"><!---->ConcurrentSessionControlAuthenticationStrategy<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="CompositeSessionAuthenticationStrategy" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#compositesessionauthenticationstrategy"><!---->CompositeSessionAuthenticationStrategy<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="AbstractSessionFixationProtectionStrategy" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#abstractsessionfixationprotectionstrategy"><!---->AbstractSessionFixationProtectionStrategy<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="SessionRegistry" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#sessionregistry"><!---->SessionRegistry<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ConcurrentSessionFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#concurrentsessionfilter"><!---->ConcurrentSessionFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="SessionManagementConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#sessionmanagementconfigurer"><!---->SessionManagementConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="1、默认配置的过滤器" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#_1、默认配置的过滤器"><!---->1、默认配置的过滤器<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="DisableEncodeUrlFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#disableencodeurlfilter"><!---->DisableEncodeUrlFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="WebAsyncManagerIntegrationFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#webasyncmanagerintegrationfilter"><!---->WebAsyncManagerIntegrationFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="HeaderWriterFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#headerwriterfilter"><!---->HeaderWriterFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="CsrfFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#csrffilter"><!---->CsrfFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="LogoutFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#logoutfilter"><!---->LogoutFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="RequestCacheAwareFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#requestcacheawarefilter"><!---->RequestCacheAwareFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="SecurityContextHolderAwareRequestFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#securitycontextholderawarerequestfilter"><!---->SecurityContextHolderAwareRequestFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="AnonymousAuthenticationFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#anonymousauthenticationfilter"><!---->AnonymousAuthenticationFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ExceptionTranslationFilter" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#exceptiontranslationfilter"><!---->ExceptionTranslationFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="2、加载过程" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#_2、加载过程"><!---->2、加载过程<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="HttpSecurityConfiguration" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#httpsecurityconfiguration"><!---->HttpSecurityConfiguration<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="WebSecurityConfiguration" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#websecurityconfiguration"><!---->WebSecurityConfiguration<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="DelegatingFilterProxy" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#delegatingfilterproxy"><!---->DelegatingFilterProxy<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="AuthorizationFilter" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authorizationfilter"><!---->AuthorizationFilter<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthorizationManager" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authorizationmanager"><!---->AuthorizationManager<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthorizationDecision" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authorizationdecision"><!---->AuthorizationDecision<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthorizeHttpRequestsConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authorizehttprequestsconfigurer-1"><!---->AuthorizeHttpRequestsConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthorizationManagerRequestMatcherRegistry" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authorizationmanagerrequestmatcherregistry"><!---->AuthorizationManagerRequestMatcherRegistry<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="AbstractRequestMatcherRegistry" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#abstractrequestmatcherregistry"><!---->AbstractRequestMatcherRegistry<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="AuthorizationManagerRequestMatcherRegistry" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#authorizationmanagerrequestmatcherregistry-1"><!---->AuthorizationManagerRequestMatcherRegistry<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="RequestMatcherDelegatingAuthorizationManager" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#requestmatcherdelegatingauthorizationmanager"><!---->RequestMatcherDelegatingAuthorizationManager<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AuthorityAuthorizationManager" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#authorityauthorizationmanager"><!---->AuthorityAuthorizationManager<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="配置过程" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#配置过程"><!---->配置过程<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="FilterInvocation" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#filterinvocation"><!---->FilterInvocation<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="FilterSecurityInterceptor" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#filtersecurityinterceptor-1"><!---->FilterSecurityInterceptor<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="AbstractSecurityInterceptor" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#abstractsecurityinterceptor"><!---->AbstractSecurityInterceptor<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="InterceptorStatusToken" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#interceptorstatustoken"><!---->InterceptorStatusToken<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="AbstractInterceptUrlConfigurer" class="vp-link nav-link vp-sidebar-link vp-sidebar-heading nav-link vp-sidebar-link vp-sidebar-heading" href="/sourceCode/spring/SpringSecurity/#abstractintercepturlconfigurer"><!---->AbstractInterceptUrlConfigurer<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="UrlAuthorizationConfigurer" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#urlauthorizationconfigurer"><!---->UrlAuthorizationConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="AbstractAccessDecisionManager" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#abstractaccessdecisionmanager"><!---->AbstractAccessDecisionManager<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="ExpressionUrlAuthorizationConfigurer" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/sourceCode/spring/SpringSecurity/#expressionurlauthorizationconfigurer"><!---->ExpressionUrlAuthorizationConfigurer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->认证</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://apzs.eu.org" target="_blank" rel="noopener noreferrer">apzs</a></span><span property="author" content="apzs"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-05T06:05:15.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/sourceCode/spring/SpringSecurity/">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 91 分钟</span><meta property="timeRequired" content="PT91M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#httpsecurity的结构-构建securityfilterchain">HttpSecurity的结构（构建SecurityFilterChain）</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#websecurity的结构-构建filter">WebSecurity的结构（构建Filter）</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#构建对象">构建对象</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#httpsecurity构建defaultsecurityfilterchain">HttpSecurity构建DefaultSecurityFilterChain</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#websecurity构建filterchainproxy">WebSecurity构建FilterChainProxy</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_1、abstractconfiguredsecuritybuilder">1、AbstractConfiguredSecurityBuilder</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_2、securityconfigurer">2、SecurityConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authenticationmanager">AuthenticationManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authenticationmanagerbuilder">AuthenticationManagerBuilder</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#providermanager">ProviderManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authenticationprovider">AuthenticationProvider</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authentication">Authentication</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#daoauthenticationprovider">DaoAuthenticationProvider</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#retrieveuser">retrieveUser</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#additionalauthenticationchecks">additionalAuthenticationChecks</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#usernamepasswordauthenticationfilter">UsernamePasswordAuthenticationFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#formloginconfigurer">FormLoginConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontext">SecurityContext</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontextholder">SecurityContextHolder</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontextholderstrategy">SecurityContextHolderStrategy</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontextrepository">SecurityContextRepository</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontextpersistencefilter">SecurityContextPersistenceFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontextholderfilter">SecurityContextHolderFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#securitycontextconfigurer">SecurityContextConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#filterchainproxy">FilterChainProxy</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#remembermeauthenticationfilter">RememberMeAuthenticationFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#remembermeservices">RememberMeServices</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#remembermeauthenticationtoken">RememberMeAuthenticationToken</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#remembermeauthenticationprovider">RememberMeAuthenticationProvider</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#abstractremembermeservices">AbstractRememberMeServices</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#tokenbasedremembermeservices">TokenBasedRememberMeServices</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#persistenttokenbasedremembermeservices">PersistentTokenBasedRememberMeServices</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#remembermeconfigurer">RememberMeConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#sessionmanagementfilter">SessionManagementFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#sessionauthenticationstrategy">SessionAuthenticationStrategy</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#registersessionauthenticationstrategy">RegisterSessionAuthenticationStrategy</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#concurrentsessioncontrolauthenticationstrategy">ConcurrentSessionControlAuthenticationStrategy</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#compositesessionauthenticationstrategy">CompositeSessionAuthenticationStrategy</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#abstractsessionfixationprotectionstrategy">AbstractSessionFixationProtectionStrategy</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#sessionregistry">SessionRegistry</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#concurrentsessionfilter">ConcurrentSessionFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#sessionmanagementconfigurer">SessionManagementConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_1、默认配置的过滤器">1、默认配置的过滤器</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#disableencodeurlfilter">DisableEncodeUrlFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#webasyncmanagerintegrationfilter">WebAsyncManagerIntegrationFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#headerwriterfilter">HeaderWriterFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#csrffilter">CsrfFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#logoutfilter">LogoutFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#requestcacheawarefilter">RequestCacheAwareFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#securitycontextholderawarerequestfilter">SecurityContextHolderAwareRequestFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#anonymousauthenticationfilter">AnonymousAuthenticationFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#exceptiontranslationfilter">ExceptionTranslationFilter</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_2、加载过程">2、加载过程</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#httpsecurityconfiguration">HttpSecurityConfiguration</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#websecurityconfiguration">WebSecurityConfiguration</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#delegatingfilterproxy">DelegatingFilterProxy</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authorizationfilter">AuthorizationFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authorizationmanager">AuthorizationManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authorizationdecision">AuthorizationDecision</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authorizehttprequestsconfigurer-1">AuthorizeHttpRequestsConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authorizationmanagerrequestmatcherregistry">AuthorizationManagerRequestMatcherRegistry</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#abstractrequestmatcherregistry">AbstractRequestMatcherRegistry</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#authorizationmanagerrequestmatcherregistry-1">AuthorizationManagerRequestMatcherRegistry</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#requestmatcherdelegatingauthorizationmanager">RequestMatcherDelegatingAuthorizationManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#authorityauthorizationmanager">AuthorityAuthorizationManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#配置过程">配置过程</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#filterinvocation">FilterInvocation</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#filtersecurityinterceptor-1">FilterSecurityInterceptor</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#abstractsecurityinterceptor">AbstractSecurityInterceptor</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#interceptorstatustoken">InterceptorStatusToken</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#abstractintercepturlconfigurer">AbstractInterceptUrlConfigurer</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#urlauthorizationconfigurer">UrlAuthorizationConfigurer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#abstractaccessdecisionmanager">AbstractAccessDecisionManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#expressionurlauthorizationconfigurer">ExpressionUrlAuthorizationConfigurer</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="认证" tabindex="-1"><a class="header-anchor" href="#认证" aria-hidden="true">#</a> 认证</h1><h1 id="一" tabindex="-1"><a class="header-anchor" href="#一" aria-hidden="true">#</a> 一</h1><p>以往，我们使用继承<code>WebSecurityConfigurerAdapter</code>抽象接口的方式，修改自己的配置，但是至Spring Security5.7后，该方式就不被推荐了（注意将配置类加入至容器）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101141749370.png" alt="image-20230101141749370" tabindex="0" loading="lazy"><figcaption>image-20230101141749370</figcaption></figure><p>我们可以根据<code>WebSecurityConfigurerAdapter</code>抽象类的描述知道应该使用哪些Spring官方推荐的做法，根据描述我们可以使用<code>SecurityFilterChain</code>来配置<code>HttpSecurity</code>，使用<code>WebSecurityCustomizer</code>来配置<code>WebSecurity</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ...
 * <span class="token keyword">@author</span> Rob Winch
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">EnableWebSecurity</span></span>
 * <span class="token keyword">@deprecated</span> Use a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">SecurityFilterChain</span></span><span class="token punctuation">}</span> Bean to
 * configure <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">}</span> or a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">WebSecurityCustomizer</span></span><span class="token punctuation">}</span> Bean to configure
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">WebSecurity</span></span><span class="token punctuation">}</span>. <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>
 <span class="token code-section">*     <span class="token line"><span class="token entity" title="@">&amp;#64;</span><span class="token code language-java"><span class="token class-name">Bean</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span></span>
 *         <span class="token line"><span class="token code language-java">http</span></span>
 *             <span class="token line"><span class="token code language-java"><span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authz<span class="token punctuation">)</span> <span class="token operator">-&gt;</span></span></span>
 *                 <span class="token line"><span class="token code language-java">authz<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
 *             <span class="token line"><span class="token code language-java"><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
 *             <span class="token line"><span class="token code language-java"><span class="token comment">// ...</span></span></span>
 *         <span class="token line"><span class="token code language-java"><span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
 *     <span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span>
 *
 *    <span class="token line"><span class="token entity" title="@">&amp;#64;</span><span class="token code language-java"><span class="token class-name">Bean</span></span></span>
 *    <span class="token line"><span class="token code language-java"><span class="token keyword">public</span> <span class="token class-name">WebSecurityCustomizer</span> <span class="token function">webSecurityCustomizer</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token punctuation">{</span></span></span>
 *        <span class="token line"><span class="token code language-java"><span class="token keyword">return</span> <span class="token punctuation">(</span>web<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/resources/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
 *    <span class="token line"><span class="token code language-java"><span class="token punctuation">}</span></span></span>
 *</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span> See the &lt;a href=
 * &quot;https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter&quot;&gt;Spring
 * Security without WebSecurityConfigurerAdapter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> for more details.
 */</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Deprecated</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">WebSecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSecurity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101142632262.png" alt="image-20230101142632262" tabindex="0" loading="lazy"><figcaption>image-20230101142632262</figcaption></figure><p>即应该配置成类似如下这样（注意将配置类加入至容器）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">WebSecurityCustomizer</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> web <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101163516128.png" alt="image-20230101163516128" tabindex="0" loading="lazy"><figcaption>image-20230101163516128</figcaption></figure><h2 id="httpsecurity的结构-构建securityfilterchain" tabindex="-1"><a class="header-anchor" href="#httpsecurity的结构-构建securityfilterchain" aria-hidden="true">#</a> <code>HttpSecurity</code>的结构（构建SecurityFilterChain）</h2><p><code>HttpSecurity</code>继承自<code>AbstractConfiguredSecurityBuilder</code>抽象类，而<code>AbstractConfiguredSecurityBuilder</code>继承自<code>AbstractSecurityBuilder</code>抽象类，而<code>AbstractSecurityBuilder</code>抽象类实现了<code>SecurityBuilder</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101143303005.png" alt="image-20230101143303005" tabindex="0" loading="lazy"><figcaption>image-20230101143303005</figcaption></figure><p><code>SecurityBuilder</code>这个接口非常简单，就一个<code>build</code>方法，用于构建一个泛型<code>O</code>对象</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101143456115.png" alt="image-20230101143456115" tabindex="0" loading="lazy"><figcaption>image-20230101143456115</figcaption></figure><p><code>HttpSecurity</code>用于构建一个<code>DefaultSecurityFilterChain</code>，即默认的安全过滤器链</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HttpSecurity</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConfiguredSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">,</span> <span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101144147132.png" alt="image-20230101144147132" tabindex="0" loading="lazy"><figcaption>image-20230101144147132</figcaption></figure><p><code>DefaultSecurityFilterChain</code>结构非常简单，其就是实现了<code>SecurityFilterChain</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101144420412.png" alt="image-20230101144420412" tabindex="0" loading="lazy"><figcaption>image-20230101144420412</figcaption></figure><p><code>SecurityFilterChain</code>接口就两个方法，一个<code>matches</code>方法用于判断这个请求能不能应用这些<code>Filter</code>，一个<code>getFilters</code>方法返回要应用的所有过滤器（即<code>matches</code>方法返回<code>true</code>后，会将<code>getFilters</code>方法返回的所有<code>Filter</code>都应用到这个请求上）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Defines a filter chain which is capable of being matched against an
 * <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">HttpServletRequest</span></span></span><span class="token punctuation">}</span>. in order to decide whether it applies to that request.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * Used to configure a <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">FilterChainProxy</span></span></span><span class="token punctuation">}</span>.
 *
 * <span class="token keyword">@author</span> Luke Taylor
 * <span class="token keyword">@since</span> 3.1
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityFilterChain</span> <span class="token punctuation">{</span>

	<span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101144705029.png" alt="image-20230101144705029" tabindex="0" loading="lazy"><figcaption>image-20230101144705029</figcaption></figure><h2 id="websecurity的结构-构建filter" tabindex="-1"><a class="header-anchor" href="#websecurity的结构-构建filter" aria-hidden="true">#</a> <code>WebSecurity</code>的结构（构建Filter）</h2><p>可以看到<code>WebSecurity</code>也继承自<code>AbstractConfiguredSecurityBuilder</code>抽象类，而<code>AbstractConfiguredSecurityBuilder</code>继承自<code>AbstractSecurityBuilder</code>抽象类，而<code>AbstractSecurityBuilder</code>抽象类实现了<code>SecurityBuilder</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101143631569.png" alt="image-20230101143631569" tabindex="0" loading="lazy"><figcaption>image-20230101143631569</figcaption></figure><p>而<code>WebSecurity</code>用于构建一个<code>Filter</code>对象，这个<code>Filter</code>就是<code>javax.servlet.Filter</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurity</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConfiguredSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">,</span> <span class="token class-name">WebSecurity</span><span class="token punctuation">&gt;</span></span>
		<span class="token keyword">implements</span> <span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">,</span> <span class="token class-name">ServletContextAware</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101143910431.png" alt="image-20230101143910431" tabindex="0" loading="lazy"><figcaption>image-20230101143910431</figcaption></figure><blockquote><p><code>HttpSecurity</code>和<code>WebSecurity</code>结构非常相似，只不过<code>HttpSecurity</code>要构建的是<code>DefaultSecurityFilterChain</code>对象，而<code>WebSecurity</code>要构建的是<code>Filter</code>对象</p></blockquote><h2 id="构建对象" tabindex="-1"><a class="header-anchor" href="#构建对象" aria-hidden="true">#</a> 构建对象</h2><p><code>HttpSecurity</code>和<code>WebSecurity</code>在哪里构建的对象呢？</p><p>首先我们来到最开始的<code>SecurityBuilder</code>接口，点击<code>build</code>方法的<code>下箭头接口</code>图标</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Builds the object and returns it or null.
    * <span class="token keyword">@return</span> the Object to be built or null if the implementation allows it.
    * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> if an error occurred when building the Object
    */</span>
   <span class="token class-name">O</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101150400062.png" alt="image-20230101150400062" tabindex="0" loading="lazy"><figcaption>image-20230101150400062</figcaption></figure><p>来到了<code>AbstractSecurityBuilder</code>抽象类，该类的<code>build</code>方法首先判断<code>building</code>是否为false。如果为false就将其修改为true，并调用doBuild方法，然后返回doBuild方法的返回值；如果为true，就表明已经构建过了，直接抛出已经构建异常（该抽象放法实现了<code>build</code>方法就是为了让其子类只有一个去构建，正真的构建逻辑在<code>doBuild</code>方法，其在该抽象类并定义为抽象方法，要求其具体子类必须去实现）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">AtomicBoolean</span> building <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">O</span> object<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">O</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>building<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>object <span class="token operator">=</span> <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>object<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AlreadyBuiltException</span><span class="token punctuation">(</span><span class="token string">&quot;This object has already been built&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
	
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token doc-comment comment">/**
    * Subclasses should implement this to perform the build.
    * <span class="token keyword">@return</span> the object that should be returned by <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>.
    * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span> if an error occurs
    */</span>
   <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">O</span> <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101150404906.png" alt="image-20230101150404906" tabindex="0" loading="lazy"><figcaption>image-20230101150404906</figcaption></figure><p>点击<code>AbstractSecurityBuilder</code>抽象类<code>doBuild</code>方法的<code>下箭头接口</code>图标，就来到了<code>AbstractConfiguredSecurityBuilder</code>抽象类</p><p>在<code>AbstractConfiguredSecurityBuilder</code>类里定义了一个<code>buildState</code>作为构建状态，在初始换之前调用<code>beforeInit();</code>方法，在配置之前调用<code>beforeConfigure();</code>方法，最后调用<code>performBuild();</code>方法构建对象。我们关心构建状态，可以实现<code>beforeInit();</code>或<code>beforeConfigure();</code>方法。当然如果不关心也可以不实现这两个中的任何方法，但都必须实现<code>performBuild();</code>方法，这个方法是构建对象的核心方法，必须实现。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractConfiguredSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
		<span class="token keyword">extends</span> <span class="token class-name">AbstractSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">private</span> <span class="token class-name">BuildState</span> buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">UNBUILT</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">O</span> <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">;</span>
			<span class="token function">beforeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">CONFIGURING</span><span class="token punctuation">;</span>
			<span class="token function">beforeConfigure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">BUILDING</span><span class="token punctuation">;</span>
			<span class="token class-name">O</span> result <span class="token operator">=</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">BUILT</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> result<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeConfigure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">O</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">BuildState</span> <span class="token punctuation">{</span>
		<span class="token function">UNBUILT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">INITIALIZING</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">CONFIGURING</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">BUILDING</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">BUILT</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> order<span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101150626554.png" alt="image-20230101150626554" tabindex="0" loading="lazy"><figcaption>image-20230101150626554</figcaption></figure><h3 id="httpsecurity构建defaultsecurityfilterchain" tabindex="-1"><a class="header-anchor" href="#httpsecurity构建defaultsecurityfilterchain" aria-hidden="true">#</a> HttpSecurity构建DefaultSecurityFilterChain</h3><p>点击<code>AbstractConfiguredSecurityBuilder</code>抽象类<code>performBuild()</code>方法的<code>下箭头接口</code>图标，选择<code>HttpSecurity</code>，<code>HttpSecurity</code>返回的是<code>DefaultSecurityFilterChain</code>对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> expressionConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span>
         <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> httpConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> oneConfigurerPresent <span class="token operator">=</span> expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">^</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">(</span>expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> oneConfigurerPresent<span class="token punctuation">,</span>
         <span class="token string">&quot;authorizeHttpRequests cannot be used in conjunction with authorizeRequests. Please select just one.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">OrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> sortedFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Filter</span> filter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sortedFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderedFilter</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher<span class="token punctuation">,</span> sortedFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101152532151.png" alt="image-20230101152532151" tabindex="0" loading="lazy"><figcaption>image-20230101152532151</figcaption></figure><h3 id="websecurity构建filterchainproxy" tabindex="-1"><a class="header-anchor" href="#websecurity构建filterchainproxy" aria-hidden="true">#</a> WebSecurity构建FilterChainProxy</h3><p>点击<code>AbstractConfiguredSecurityBuilder</code>抽象类<code>performBuild()</code>方法的<code>下箭头接口</code>图标，选择<code>WebSecurity</code>，<code>WebSecurity</code>返回的是<code>FilterChainProxy</code>对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token class-name">FilterChainProxy</span> filterChainProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span>securityFilterChains<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      filterChainProxy<span class="token punctuation">.</span><span class="token function">setFirewall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      filterChainProxy<span class="token punctuation">.</span><span class="token function">setRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   filterChainProxy<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">Filter</span> result <span class="token operator">=</span> filterChainProxy<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;\n\n&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;**********    This may include sensitive information.  *************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;**********      Do not use in a production system!     *************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DebugFilter</span><span class="token punctuation">(</span>filterChainProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>postBuildAction<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101152841367.png" alt="image-20230101152841367" tabindex="0" loading="lazy"><figcaption>image-20230101152841367</figcaption></figure><p><code>FilterChainProxy</code>继承<code>GenericFilterBean</code>抽象类，<code>GenericFilterBean</code>抽象类实现<code>Filter</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101154743297.png" alt="image-20230101154743297" tabindex="0" loading="lazy"><figcaption>image-20230101154743297</figcaption></figure><p>FilterChainProxy类的构造方法需要SecurityFilterChain集合，该类会实现<code>Filter</code>类的<code>doFilter</code>方法，实现的<code>doFilter</code>方法会执行<code> doFilterInternal(request, response, chain);</code>方法来实现正真的逻辑，在<code>doFilterInternal</code>方法里首先调用<code>getFilters(firewallRequest)</code>获取所有的<code>Filter</code>，然后创建被包装后的<code>FilterChain</code>对象：<code>VirtualFilterChain</code>，然后使用被包装后的<code>VirtualFilterChain</code>对象的<code>doFilter</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterChainProxy</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> filterChains<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span><span class="token class-name">SecurityFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> filterChains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>filterChains <span class="token operator">=</span> filterChains<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> clearContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clearContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token function">getFilters</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token class-name">VirtualFilterChain</span> virtualFilterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VirtualFilterChain</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
      virtualFilterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">,</span> firewallResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101155034966.png" alt="image-20230101155034966" style="zoom:25%;"><p>该<code>getFilters</code>方法会遍历构造方法传过来的<code>List&lt;SecurityFilterChain&gt;</code>，调用其<code>matches</code>方法，如果返回<code>true</code>，就调用其<code>getFilters()</code>方法作为该方法的返回值（即只会使用第一个匹配的）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityFilterChain</span> chain <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filterChains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Trying to match request against %s (%d/%d)&quot;</span><span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token operator">++</span>count<span class="token punctuation">,</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>filterChains<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101162218624.png" alt="image-20230101162218624" tabindex="0" loading="lazy"><figcaption>image-20230101162218624</figcaption></figure><p><code>VirtualFilterChain</code>类的<code>doFilter</code>就是将<code>FilterChainProxy</code>类的构造方法传来的<code>SecurityFilterChain</code>里的所有<code>Filter</code>都应用一遍，如果<code>SecurityFilterChain</code>里的<code>Filter</code>都应用完了，就调用原始过滤器链的<code>doFilter</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterChainProxy</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">VirtualFilterChain</span> <span class="token keyword">implements</span> <span class="token class-name">FilterChain</span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FilterChain</span> originalChain<span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> additionalFilters<span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FirewalledRequest</span> firewalledRequest<span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token keyword">int</span> currentPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">private</span> <span class="token class-name">VirtualFilterChain</span><span class="token punctuation">(</span><span class="token class-name">FirewalledRequest</span> firewalledRequest<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> additionalFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>originalChain <span class="token operator">=</span> chain<span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>additionalFilters <span class="token operator">=</span> additionalFilters<span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> additionalFilters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>firewalledRequest <span class="token operator">=</span> firewalledRequest<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 最开始currentPosition = 0 ，如果当前位置和传过来的Filter相等就证明SecurityFilterChain里的Filter为空</span>
        <span class="token comment">// 随着currentPosition++ 当this.currentPosition == this.size(执行完Filter)就调用原生过滤器链的doFilter方法</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Secured &quot;</span> <span class="token operator">+</span> <span class="token function">requestLine</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>firewalledRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Deactivate path stripping as we exit the security filter chain</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>firewalledRequest<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>originalChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 如果 this.currentPosition != this.size，先让currentPosition++获取第一个</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token comment">// 获取第一个需要 将currentPosition -1 </span>
         <span class="token class-name">Filter</span> nextFilter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>additionalFilters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Invoking %s (%d/%d)&quot;</span><span class="token punctuation">,</span> nextFilter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 调用nextFilter，继续让currentPosition++,直到this.currentPosition == this.size证明已经没有了</span>
         nextFilter<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101160045307.png" alt="image-20230101160045307" tabindex="0" loading="lazy"><figcaption>image-20230101160045307</figcaption></figure><h1 id="二" tabindex="-1"><a class="header-anchor" href="#二" aria-hidden="true">#</a> 二</h1><h2 id="_1、abstractconfiguredsecuritybuilder" tabindex="-1"><a class="header-anchor" href="#_1、abstractconfiguredsecuritybuilder" aria-hidden="true">#</a> 1、AbstractConfiguredSecurityBuilder</h2><p>接着我们查看<code>AbstractConfiguredSecurityBuilder</code>的<code>add(C configurer)</code>方法，这个方法用于添加配置，再配置Spring Security时都直接或间接调用了该方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">C</span> configurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>configurer<span class="token punctuation">,</span> <span class="token string">&quot;configurer cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> configurer
         <span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 首先加个锁，防止并发访问</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//如果现在的构建状态是已经配置或正在配置(this.order&gt;=CONFIGURING.order)就抛出异常（已经或正在配置时就不允许添加配置）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buildState<span class="token punctuation">.</span><span class="token function">isConfigured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot apply &quot;</span> <span class="token operator">+</span> configurer <span class="token operator">+</span> <span class="token string">&quot; to already built object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果允许相同类型的配置，就将configurers.get(clazz)类的值赋给configs（即获取到之前在configurers里的配置，然后调用configs.add(configurer)方法，添加新的配置，然后再put到configurers里）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowConfigurersOfSameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         configs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果不为空（允许相同类型的配置）就不变</span>
      <span class="token comment">// 如果为空（不允许相同类型的配置）就创建一个初始容量为1的ArrayList赋给configs（即重新创建一个新的配置，put到configurers里时覆盖掉之前的配置，如果之前有该配置的话）</span>
      configs <span class="token operator">=</span> <span class="token punctuation">(</span>configs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> configs <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将方法传过来configurer添加到configs里，即添加配置</span>
      configs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将clazz作为key，configs作为value,添加到configurers里</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buildState<span class="token punctuation">.</span><span class="token function">isInitializing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果是正在初始化，将这个配置添加到configurersAddedInInitializing里</span>
         <span class="token comment">// 也就是把已有的configs调完完成了后，再把在初始化过程中加入的config需要再调用一遍</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>configurersAddedInInitializing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101201241080.png" alt="image-20230101201241080" tabindex="0" loading="lazy"><figcaption>image-20230101201241080</figcaption></figure><h2 id="_2、securityconfigurer" tabindex="-1"><a class="header-anchor" href="#_2、securityconfigurer" aria-hidden="true">#</a> 2、SecurityConfigurer</h2><p>前面我们说到，<code>AbstractConfiguredSecurityBuilder</code>抽象类的<code>doBuild</code>方法在初始换之前调用<code>beforeInit();</code>方法，在配置之前调用<code>beforeConfigure();</code>方法，最后调用<code>performBuild();</code>方法构建对象。而初始化的<code>init</code>方法里会调用所有<code>SecurityConfigurer&lt;O, B&gt;</code>接口的<code>configurer.init((B) this);</code>方法，而进行配置的<code>configure</code>方法里会调用所有<code>SecurityConfigurer&lt;O, B&gt;</code>接口的<code>configurer.configure((B) this);</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurersAddedInInitializing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101164417385.png" alt="image-20230101164417385" tabindex="0" loading="lazy"><figcaption>image-20230101164417385</figcaption></figure><p>我们查看<code>SecurityConfigurer&lt;O, B&gt;</code>这个接口，这个接口也就<code>init(B builder)</code>和<code>configure(B builder)</code>两个方法（一般<code>init(B builder)</code>是初始化和设置共享对象的，<code>configure(B builder)</code>是创建相应的过滤器的）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token doc-comment comment">/**
	 * Initialize the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityBuilder</span></span><span class="token punctuation">}</span>. Here only shared state should be created
	 * and modified, but not properties on the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityBuilder</span></span><span class="token punctuation">}</span> used for building
	 * the object. This ensures that the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SecurityBuilder</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> method uses
	 * the correct shared objects when building. Configurers should be applied here.
	 * <span class="token keyword">@param</span> <span class="token parameter">builder</span>
	 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
	 */</span>
	<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/**
	 * Configure the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityBuilder</span></span><span class="token punctuation">}</span> by setting the necessary properties on the
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityBuilder</span></span><span class="token punctuation">}</span>.
	 * <span class="token keyword">@param</span> <span class="token parameter">builder</span>
	 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
	 */</span>
	<span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101195916279.png" alt="image-20230101195916279" tabindex="0" loading="lazy"><figcaption>image-20230101195916279</figcaption></figure><p>在<code>init()</code>和<code>configure()</code>方法里，首先会调用<code>getConfigurers()</code>方法，这个方法也比较简单，遍历前面刚刚提到的<code>configurers</code>的<code>values</code>，然后调用<code>result.addAll(configs);</code>方法，也就是遍历<code> this.configurers.values()</code>时，每一项是一个集合，将这些集合批量添加到<code>result</code>里（相当于<code>flatMap</code>，类似于将双层数组给展开成一层数组）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101203338987.png" alt="image-20230101203338987" tabindex="0" loading="lazy"><figcaption>image-20230101203338987</figcaption></figure><p>在<code>init()</code>方法里可以看到先执行<code>getConfigurers()</code>把<code>configurers</code>里的配置都调用一遍<code>configurer.init((B) this);</code>方法，在把<code>configurersAddedInInitializing</code>里的配置也调用一遍<code>configurer.init((B) this);</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurersAddedInInitializing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101204642592.png" alt="image-20230101204642592" tabindex="0" loading="lazy"><figcaption>image-20230101204642592</figcaption></figure><p><code>configure()</code>方法比较简单，直接遍历<code>configurers</code>调用其<code>configure</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101210140782.png" alt="image-20230101210140782" tabindex="0" loading="lazy"><figcaption>image-20230101210140782</figcaption></figure><p>接下来，我们继续说<code>HttpSecurity</code>类的<code>performBuild()</code>，返回了一个<code>DefaultSecurityFilterChain</code>对象，参数里的<code>sortedFilters</code>就是本类<code>filters</code>字段里所有的过滤器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取 ExpressionUrlAuthorizationConfigurer类型的配置</span>
   <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> expressionConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span>
         <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取AuthorizeHttpRequestsConfigurer类型的配置</span>
   <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> httpConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 判断这两个配置是不是有且只有一个配置不为null (^ 异或，相同为false，不同为true)</span>
   <span class="token comment">// boolean oneConfigurerPresent = (expressionConfigurer == null) ^ (httpConfigurer == null); </span>
   <span class="token keyword">boolean</span> oneConfigurerPresent <span class="token operator">=</span> expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">^</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">(</span>expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> oneConfigurerPresent<span class="token punctuation">,</span>
         <span class="token string">&quot;authorizeHttpRequests cannot be used in conjunction with authorizeRequests. Please select just one.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">OrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> sortedFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Filter</span> filter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sortedFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderedFilter</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher<span class="token punctuation">,</span> sortedFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101211348363.png" alt="image-20230101211348363" tabindex="0" loading="lazy"><figcaption>image-20230101211348363</figcaption></figure><p><code>requestMatcher</code>参数是<code>AnyRequestMatcher.INSTANCE</code>，也就是管理所有请求</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HttpSecurity</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractConfiguredSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">,</span> <span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">implements</span> <span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcherConfigurer</span> requestMatcherConfigurer<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderedFilter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> requestMatcher <span class="token operator">=</span> <span class="token class-name">AnyRequestMatcher</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">FilterOrderRegistration</span> filterOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterOrderRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101212828147.png" alt="image-20230101212828147" tabindex="0" loading="lazy"><figcaption>image-20230101212828147</figcaption></figure><p><code>AnyRequestMatcher.INSTANCE</code>用的是懒汉式创建的单例对象，其<code>matches</code>返回<code>true</code>，也就是配置所有请求路径</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AnyRequestMatcher</span> <span class="token keyword">implements</span> <span class="token class-name">RequestMatcher</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcher</span> <span class="token constant">INSTANCE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnyRequestMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AnyRequestMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">AnyRequestMatcher</span>
            <span class="token operator">||</span> obj <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span>AnyRequestMatcher</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;any request&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101212953678.png" alt="image-20230101212953678" tabindex="0" loading="lazy"><figcaption>image-20230101212953678</figcaption></figure><p>当然，我们也可以不使用默认的<code>AnyRequestMatcher</code>，自己设置<code>RequestMatcher</code>也可以</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">HttpSecurity</span> <span class="token function">requestMatcher</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requestMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher <span class="token operator">=</span> requestMatcher<span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230101213230307.png" alt="image-20230101213230307" tabindex="0" loading="lazy"><figcaption>image-20230101213230307</figcaption></figure><h1 id="三" tabindex="-1"><a class="header-anchor" href="#三" aria-hidden="true">#</a> 三</h1><h2 id="authenticationmanager" tabindex="-1"><a class="header-anchor" href="#authenticationmanager" aria-hidden="true">#</a> AuthenticationManager</h2><p><code>AuthenticationManager</code>有一个<code>authenticate</code>方法，对传来的<code>Authentication</code>做认证，如果账号被禁用了抛出<code>DisabledException</code>异常，账号被锁住了抛出<code>LockedException</code>异常，密码输错了抛出<code>BadCredentialsException</code>异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationManager</span> <span class="token punctuation">{</span>
   <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102092537227.png" alt="image-20230102092537227" tabindex="0" loading="lazy"><figcaption>image-20230102092537227</figcaption></figure><h2 id="authenticationmanagerbuilder" tabindex="-1"><a class="header-anchor" href="#authenticationmanagerbuilder" aria-hidden="true">#</a> AuthenticationManagerBuilder</h2><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102093131724.png" alt="image-20230102093131724" tabindex="0" loading="lazy"><figcaption>image-20230102093131724</figcaption></figure><p><code>performBuild</code>方法用于构建<code>ProviderManager</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">ProviderManager</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isConfigured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No authenticationProviders and no parentAuthenticationManager defined. Returning null.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 创建ProviderManager对象（传递认证提供者和父类的认证管理器）</span>
   <span class="token class-name">ProviderManager</span> providerManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationProviders<span class="token punctuation">,</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>parentAuthenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 身份认证后擦除凭据(即认证成功后将用户输入的存放在内存中密码字段重新设为null)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eraseCredentials <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      providerManager<span class="token punctuation">.</span><span class="token function">setEraseCredentialsAfterAuthentication</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eraseCredentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 设置认证事件发布器（发布认证成功或认证失败的消息）</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      providerManager<span class="token punctuation">.</span><span class="token function">setAuthenticationEventPublisher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 返回前调用后置处理方法</span>
   providerManager <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>providerManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> providerManager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102093634950.png" alt="image-20230102093634950" tabindex="0" loading="lazy"><figcaption>image-20230102093634950</figcaption></figure><p><code>postProcess</code>方法会调用<code>this.objectPostProcessor</code>的<code>postProcess</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">;</span>

<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">P</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">P</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">P</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102094151412.png" alt="image-20230102094151412" tabindex="0" loading="lazy"><figcaption>image-20230102094151412</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image2-20230102094052946.png" alt="image2-20230102094052946" tabindex="0" loading="lazy"><figcaption>image2-20230102094052946</figcaption></figure><p>而<code>ObjectPostProcessor</code>接口就一个<code>postProcess</code>方法，用于进行后置处理，可以拓展Spring Security的功能</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Initialize the object possibly returning a modified instance that should be used
    * instead.
    * <span class="token keyword">@param</span> <span class="token parameter">object</span> the object to initialize
    * <span class="token keyword">@return</span> the initialized version of the object
    */</span>
   <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">O</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">O</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102094657680.png" alt="image-20230102094657680" tabindex="0" loading="lazy"><figcaption>image-20230102094657680</figcaption></figure><h2 id="providermanager" tabindex="-1"><a class="header-anchor" href="#providermanager" aria-hidden="true">#</a> ProviderManager</h2><p>而<code>ProviderManager</code>实现了<code>AuthenticationManager</code>接口</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102093749723.png" alt="image-20230102093749723" tabindex="0" loading="lazy"><figcaption>image-20230102093749723</figcaption></figure><p><code>ProviderManager</code>类的构造方法需要传递<code>AuthenticationProvider</code>集合</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ProviderManager</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>providers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ProviderManager</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">&gt;</span></span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">(</span>providers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">ProviderManager</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">&gt;</span></span> providers<span class="token punctuation">,</span> <span class="token class-name">AuthenticationManager</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>providers<span class="token punctuation">,</span> <span class="token string">&quot;providers list cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>providers <span class="token operator">=</span> providers<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
   <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102095602776.png" alt="image-20230102095602776" tabindex="0" loading="lazy"><figcaption>image-20230102095602776</figcaption></figure><h2 id="authenticationprovider" tabindex="-1"><a class="header-anchor" href="#authenticationprovider" aria-hidden="true">#</a> AuthenticationProvider</h2><p><code>AuthenticationProvider</code>接口有两个方法<code>authenticate</code>和<code>supports</code>。这个<code>authenticate</code>方法和前面说的<code>AuthenticationManager</code>接口的<code>authenticate</code>方法简直一模一样；<code>supports</code>方法就是判断支不支持传过来的<code>authentication</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>
   
   <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>

   <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102095840728.png" alt="image-20230102095840728" tabindex="0" loading="lazy"><figcaption>image-20230102095840728</figcaption></figure><h2 id="authentication" tabindex="-1"><a class="header-anchor" href="#authentication" aria-hidden="true">#</a> Authentication</h2><p><code>Authentication</code>接口有如下几个接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Authentication</span> <span class="token keyword">extends</span> <span class="token class-name">Principal</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取所有的授权（获取角色和权限）</span>
   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取凭证（密码，code，token等等都有可能作为凭据）</span>
   <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取详细信息（ip地址，字符编号等）</span>
   <span class="token class-name">Object</span> <span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 这个登录人的主体（用户名）</span>
   <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 是否认证了</span>
   <span class="token keyword">boolean</span> <span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 设置是否认证了</span>
   <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102100921620.png" alt="image-20230102100921620" tabindex="0" loading="lazy"><figcaption>image-20230102100921620</figcaption></figure><p><code>ProviderManager</code>类最重要的就是<code>authentication</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> toTest <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AuthenticationException</span> lastException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token class-name">AuthenticationException</span> parentException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token class-name">Authentication</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token class-name">Authentication</span> parentResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> currentPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 首先遍历所有的providers，看是否支持传过来的Authentication类</span>
   <span class="token comment">// providers由AuthenticationManagerBuilder类的performBuild方法创建该对象传递</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationProvider</span> provider <span class="token operator">:</span> <span class="token function">getProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不支持获取下一个，看下一个是否支持</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>provider<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>toTest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Authenticating request with %s (%d/%d)&quot;</span><span class="token punctuation">,</span>
               provider<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span>currentPosition<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果支持就调用支持者的authenticate方法进行认证</span>
         result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 认证的结果不为空就复制详细信息并退出循环</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">copyDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccountStatusException</span> <span class="token operator">|</span> <span class="token class-name">InternalAuthenticationServiceException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">prepareException</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// SEC-546: Avoid polling additional providers if auth failure is due to</span>
         <span class="token comment">// invalid account status</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         lastException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 如果result为空(providers都不支持或支持的provider调用其authenticate方法却返回空)，且父亲不为空的话</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Allow the parent to try.</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 调用父亲的authenticate方法</span>
         <span class="token comment">// // parent由AuthenticationManagerBuilder类的performBuild方法创建该对象传递</span>
         parentResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
         result <span class="token operator">=</span> parentResult<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProviderNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// ignore as we will throw below if no other exception occurred prior to</span>
         <span class="token comment">// calling parent and the parent</span>
         <span class="token comment">// may throw ProviderNotFound even though a provider in the child already</span>
         <span class="token comment">// handled the request</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         parentException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
         lastException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// result != null 即认证成功</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eraseCredentialsAfterAuthentication <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">CredentialsContainer</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Authentication is complete. Remove credentials and other secret data</span>
         <span class="token comment">// from authentication</span>
         <span class="token comment">// 擦除凭证 （其实就是将输入的密码清空，不让敏感信息存在内存中）</span>
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CredentialsContainer</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// If the parent AuthenticationManager was attempted and successful then it</span>
      <span class="token comment">// will publish an AuthenticationSuccessEvent</span>
      <span class="token comment">// This check prevents a duplicate AuthenticationSuccessEvent if the parent</span>
      <span class="token comment">// AuthenticationManager already published it</span>
      <span class="token comment">// 如果parentResult为空（即首先遍历的providers中有provider调用authenticate方法认证成功），发布认证成功的消息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parentResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishAuthenticationSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token comment">// result == null 即认证失败，准备抛出异常</span>
	<span class="token comment">// Parent was null, or didn&#39;t authenticate (or throw an exception).</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>lastException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		lastException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderNotFoundException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;ProviderManager.providerNotFound&quot;</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> toTest<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;No AuthenticationProvider found for {0}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// If the parent AuthenticationManager was attempted and failed then it will</span>
	<span class="token comment">// publish an AbstractAuthenticationFailureEvent</span>
	<span class="token comment">// This check prevents a duplicate AbstractAuthenticationFailureEvent if the</span>
	<span class="token comment">// parent AuthenticationManager already published it</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>parentException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发布认证失败的消息</span>
		<span class="token function">prepareException</span><span class="token punctuation">(</span>lastException<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">throw</span> lastException<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">prepareException</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishAuthenticationFailure</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102103940382.png" alt="image-20230102103940382" style="zoom:25%;"><p><code>AuthenticationEventPublisher</code>接口就两个方法，一个方法是发布认证成功的消息，一个方法是发布认证失败的消息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationEventPublisher</span> <span class="token punctuation">{</span>

   <span class="token keyword">void</span> <span class="token function">publishAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">void</span> <span class="token function">publishAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102104105892.png" alt="image-20230102104105892" tabindex="0" loading="lazy"><figcaption>image-20230102104105892</figcaption></figure><h1 id="四、" tabindex="-1"><a class="header-anchor" href="#四、" aria-hidden="true">#</a> 四、</h1><h2 id="daoauthenticationprovider" tabindex="-1"><a class="header-anchor" href="#daoauthenticationprovider" aria-hidden="true">#</a> DaoAuthenticationProvider</h2><p>我们看<code>DaoAuthenticationProvider</code>，他继承于<code>AbstractUserDetailsAuthenticationProvider</code></p><p>(<code>MessageSourceAware</code>是做国际化的，我们不用管，一般国际化都是前端来做的)</p><p>(<code>AuthenticationManager</code>管理<code>AuthenticationProvider</code>，<code>DaoAuthenticationProvider</code>是<code>AuthenticationProvider</code>接口的实现类，<code>UsernamePasswordAuthenticationFilter</code>里调用的<code>this.getAuthenticationManager().authenticate(authRequest);</code>就是<code>DaoAuthenticationProvider</code>)</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102151516274.png" alt="image-20230102151516274" tabindex="0" loading="lazy"><figcaption>image-20230102151516274</figcaption></figure><p>AbstractUserDetailsAuthenticationProvider类</p><blockquote><p>A base AuthenticationProvider that allows subclasses to override and work with UserDetails objects. The class is designed to respond to UsernamePasswordAuthenticationToken authentication requests.</p><p>允许子类覆盖和使用 UserDetails 对象的基本 AuthenticationProvider。 该类被设计用于响应 UsernamePasswordAuthenticationToken 认证请求。</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> authentication<span class="token punctuation">,</span>
         <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span><span class="token punctuation">,</span>
               <span class="token string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 确定用户名</span>
   <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">determineUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 先设置使用缓存中的用户信息</span>
   <span class="token keyword">boolean</span> cacheWasUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token comment">// 从缓存中根据用户名获取用户信息</span>
   <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userCache<span class="token punctuation">.</span><span class="token function">getUserFromCache</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果缓存中没有，设置不是使用缓存中的</span>
      cacheWasUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 检索用户，获取用户信息（该方法为抽象方法，留给子类去实现）</span>
         user <span class="token operator">=</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to find user &#39;&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 如果设置了不隐藏用户没有找到异常就抛出用户名没找到异常（类似于用户名不存在）</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideUserNotFoundExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 如果想要隐藏用户没有找到异常就抛出错误的凭证异常（类似于用户名或密码不正确）</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
               <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bad credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;retrieveUser returned null - a violation of the interface contract&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 预认证检查</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>preAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 额外的认证检查（判断用户输入的密码和真实的密码是否正确，该方法为抽象方法，留给子类去实现）</span>
      <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果认证失败且不是缓存中的，则抛出认证失败异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheWasUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果认证失败但是是缓存中的，有可能是缓存更新不及时导致的，设置用户信息不是缓存中的，重新在检索用户一次，再进行额外的认证检查</span>
      <span class="token comment">// There was a problem, so try again after checking</span>
      <span class="token comment">// we&#39;re using latest data (i.e. not from the cache)</span>
      cacheWasUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>preAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>postAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 如果用户信息不是缓存中的，将用户信息放到缓存中</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheWasUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>userCache<span class="token punctuation">.</span><span class="token function">putUserInCache</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">Object</span> principalToReturn <span class="token operator">=</span> user<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>forcePrincipalAsString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      principalToReturn <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 创建成功认证对象（设置authenticated为true，代表已经认证成功了）</span>
   <span class="token keyword">return</span> <span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span>principalToReturn<span class="token punctuation">,</span> authentication<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102201535815.png" alt="image-20230102201535815" tabindex="0" loading="lazy"><figcaption>image-20230102201535815</figcaption></figure><p>接着我们看<code>创建成功认证对象</code>调用的<code>createSuccessAuthentication(principalToReturn, authentication, user);</code></p><p>这个方法还是比较简单的，调用<code>UsernamePasswordAuthenticationToken</code>类的<code>authenticated</code>静态方法，将用户的凭证、权限等信息传进来即可（使用带权限的构造方法会设置<code>authenticated</code>字段为<code>true</code>）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span>
      <span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// Ensure we return the original credentials the user supplied,</span>
   <span class="token comment">// so subsequent attempts are successful even with encoded passwords.</span>
   <span class="token comment">// Also ensure we return the original getDetails(), so that future</span>
   <span class="token comment">// authentication events after cache expiry contain the details</span>
   <span class="token class-name">UsernamePasswordAuthenticationToken</span> result <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span>
         authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authoritiesMapper<span class="token punctuation">.</span><span class="token function">mapAuthorities</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   result<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authenticated user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102203322803.png" alt="image-20230102203322803" tabindex="0" loading="lazy"><figcaption>image-20230102203322803</figcaption></figure><p>调用<code>UsernamePasswordAuthenticationToken</code>类的<code>authenticated</code>方法会构造有权限参数的对象，在有权限参数的构造方法中会设置<code>authenticated</code>字段为<code>true</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token class-name">SpringSecurityCoreVersion</span><span class="token punctuation">.</span><span class="token constant">SERIAL_VERSION_UID</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
      <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span>
         <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
      <span class="token comment">// 有权限的构造参数会设置authenticated字段为true，代表已经认证通过了</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// must use super, as we override</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token function">unauthenticated</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// authenticated方法会使用带有权限参数的构造器， 有权限的构造参数会设置authenticated字段为true，代表已经认证通过了</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span>
         <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> credentials<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token operator">!</span>isAuthenticated<span class="token punctuation">,</span>
            <span class="token string">&quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230108183834658.png" alt="image-20230108183834658" tabindex="0" loading="lazy"><figcaption>image-20230108183834658</figcaption></figure><h3 id="retrieveuser" tabindex="-1"><a class="header-anchor" href="#retrieveuser" aria-hidden="true">#</a> retrieveUser</h3><p>查看<code>DaoAuthenticationProvider</code>类实现的<code>AbstractUserDetailsAuthenticationProvider</code>抽象类的<code>retrieveUser</code>抽象方法（检索用户，获取用户信息）该方法非常简单，调用<code>UserDetailsService</code>的<code>loadUserByUsername</code>方法，返回<code>UserDetails</code>，并且返回的不能为空，否则抛出<code>内部认证服务异常</code>（UserDetailsService 返回 null，这是一个违反锲约的接口）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">UserDetails</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
   <span class="token comment">// 为计时攻击的防御做准备</span>
   <span class="token function">prepareTimingAttackProtection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">UserDetails</span> loadedUser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>loadedUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span>
               <span class="token string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> loadedUser<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓解计时攻击</span>
      <span class="token function">mitigateAgainstTimingAttack</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102203907158.png" alt="image-20230102203907158" tabindex="0" loading="lazy"><figcaption>image-20230102203907158</figcaption></figure><p><code>UserDetailsService</code>接口只有<code>loadUserByUsername</code>方法，根据用户名返回用户信息，其返回值为<code>完全填充的用户记录(从不为null)</code>，所以如果返回null，就抛出<code>内部认证服务异常</code>，并告诉我们违反接口契约。常用的实现类有<code>InMemoryUserDetailsManager</code>和<code>JdbcUserDetailsManager</code></p><blockquote><p>有些同学可能问了，数据库里面没有这个用户名，不返回null返回什么？</p><p>其实Spring Security的意思是如果数据库里面没有这个用户名，我们可以抛出UsernameNotFoundException异常</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Locates the user based on the username. In the actual implementation, the search
    * may possibly be case sensitive, or case insensitive depending on how the
    * implementation instance is configured. In this case, the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">UserDetails</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>
    * object that comes back may have a username that is of a different case than what
    * was actually requested..
    * <span class="token keyword">@param</span> <span class="token parameter">username</span> the username identifying the user whose data is required.
    * <span class="token keyword">@return</span> a fully populated user record (never <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>)
    * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">UsernameNotFoundException</span></span> if the user could not be found or the user has no
    * GrantedAuthority
    */</span>
   <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102151248037.png" alt="image-20230102151248037" tabindex="0" loading="lazy"><figcaption>image-20230102151248037</figcaption></figure><p>Spring Security如何防止计时攻击呢？</p><blockquote><p><a href="http://www.nndssk.com/dngz/332204gXbicg.html" target="_blank" rel="noopener noreferrer">计时攻击是旁路攻击的一种，在密码学中，旁道攻击又称侧信道攻击、边信道攻击(Side-channel attack)。<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>这种攻击方式并非利用加密算法的理论弱点，也不是暴力破解，而是从密码系统的物理实现中获取的信息。例如：时间信息、功率消耗、电磁泄露等额外的信息源，这些信息可被用于对系统的进一步破解。</p><p>假设 Spring Security从数据库中没有查到用户信息就直接抛出异常了，没有去执行mitigateAgainstTimingAttack方法，那么黑客经过大量的测试，再经过统计分析，就会发现有一些登录验证耗时明显少于其他登录，进而推断出登录验证时间较短的都是不存在的用户，而登录耗时较长的是数据库中存在的用户。</p></blockquote><p>首先在从数据库中加载用户名之前调用<code>prepareTimingAttackProtection</code>方法 为计时攻击的防御做准备，将<code>userNotFoundPassword</code>使用密码编码器进行加密，如果抛出了用户名没有找到异常就调用<code>mitigateAgainstTimingAttack</code>方法，使用加密后的<code>userNotFoundPassword</code>与输入的密码进行比较以浪费时间，使处理用户名不存在和处理密码错误所以需要的时间基本一致，防止黑客根据执行时间判断是用户名不存在还是密码错误。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_NOT_FOUND_PASSWORD</span> <span class="token operator">=</span> <span class="token string">&quot;userNotFoundPassword&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 为计时攻击的防御做准备</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">prepareTimingAttackProtection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userNotFoundEncodedPassword <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>userNotFoundEncodedPassword <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token constant">USER_NOT_FOUND_PASSWORD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 缓解计时攻击</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mitigateAgainstTimingAttack</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userNotFoundEncodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102210418341.png" alt="image-20230102210418341" tabindex="0" loading="lazy"><figcaption>image-20230102210418341</figcaption></figure><h3 id="additionalauthenticationchecks" tabindex="-1"><a class="header-anchor" href="#additionalauthenticationchecks" aria-hidden="true">#</a> additionalAuthenticationChecks</h3><p>查看<code>DaoAuthenticationProvider</code>类实现的<code>AbstractUserDetailsAuthenticationProvider</code>抽象类的<code>additionalAuthenticationChecks</code>抽象方法（额外的认证检查，判断用户输入的密码和真实的密码是否正确）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span>
      <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取用户输入的凭据（凭据可以为密码，token等，这里指的是密码）</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since no credentials provided&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果没有凭据，抛出坏的凭据异常</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
            <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bad credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 将凭据信息转为字符串</span>
   <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 使用容器中的密码编码器判断用户输入的明文密码是否与系统中存储的密文密码匹配</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since password does not match stored value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
            <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bad credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102201804903.png" alt="image-20230102201804903" tabindex="0" loading="lazy"><figcaption>image-20230102201804903</figcaption></figure><p><code>PasswordEncoder</code>密码编码器有<code>3</code>个方法，常用的就是<code>encode</code>和<code>matches</code>方法，<code>encode</code>方法用来对传来的信息进行加密，<code>matches</code>方法用于判断明文信息和密文信息是否匹配，<code>upgradeEncoding</code>用于设置是否想要升级加密算法（最常用的实现类为<code>BCryptPasswordEncoder</code>）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PasswordEncoder</span> <span class="token punctuation">{</span>

   <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">upgradeEncoding</span><span class="token punctuation">(</span><span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102202507842.png" alt="image-20230102202507842" tabindex="0" loading="lazy"><figcaption>image-20230102202507842</figcaption></figure><p><code>DaoAuthenticationProvider</code>类覆盖了<code>AbstractUserDetailsAuthenticationProvider</code>抽象类的<code>createSuccessAuthentication</code>方法，如果<code>PasswordEncoder</code>接口的实现类将<code>upgradeEncoding</code>设为<code>true</code>，则重新将认证的凭证使用密码编码器加密一下，并通知给<code>UserDetailsPasswordService</code>类，告述其密码更新了，最后再调用父类的<code>createSuccessAuthentication</code>方法（主要用于更新系统的加密算法，即加密方式平滑的切换）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span>
      <span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">boolean</span> upgradeEncoding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsPasswordService <span class="token operator">!=</span> <span class="token keyword">null</span>
         <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">upgradeEncoding</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeEncoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> newPassword <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsPasswordService<span class="token punctuation">.</span><span class="token function">updatePassword</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> authentication<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102211930471.png" alt="image-20230102211930471" tabindex="0" loading="lazy"><figcaption>image-20230102211930471</figcaption></figure><h2 id="usernamepasswordauthenticationfilter" tabindex="-1"><a class="header-anchor" href="#usernamepasswordauthenticationfilter" aria-hidden="true">#</a> UsernamePasswordAuthenticationFilter</h2><p><code>UsernamePasswordAuthenticationFilter</code>继承自<code>AbstractAuthenticationProcessingFilter</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102213419975.png" alt="image-20230102213419975" tabindex="0" loading="lazy"><figcaption>image-20230102213419975</figcaption></figure><p><code>AbstractAuthenticationProcessingFilter</code>既然是<code>Filter</code>，最重要的肯定是<code>doFilter</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
   <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果不需要认证，则直接放行</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">requiresAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 尝试认证 （该方法为抽象方法，由子类去实现）</span>
      <span class="token class-name">Authentication</span> authenticationResult <span class="token operator">=</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authenticationResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// return immediately as subclass has indicated that it hasn&#39;t completed</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 调用SessionAuthenticationStrategy接口的onAuthentication方法(可以实现多次登陆后让前面几次登录的下线之类的功能)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sessionStrategy<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authenticationResult<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Authentication success</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>continueChainBeforeSuccessfulAuthentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> authenticationResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Authentication failed</span>
      <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102213609548.png" alt="image-20230102213609548" tabindex="0" loading="lazy"><figcaption>image-20230102213609548</figcaption></figure><p>认证成功后会执行的方法，先会在上下文中存放一些信息，调用<code>RememberMeServices</code>的<code>loginSuccess</code>方法，然后调用<code>ApplicationEventPublisher</code>类的<code>publishEvent</code>方法发布交互的认证成功事件，再调用<code>AuthenticationSuccessHandler</code>类的<code>onAuthenticationSuccess</code>方法，也就是我们配置的认证成功后做的处理（比如返回json、跳转到成功页等）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
      <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
   <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to %s&quot;</span><span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>authResult<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102214118669.png" alt="image-20230102214118669" tabindex="0" loading="lazy"><figcaption>image-20230102214118669</figcaption></figure><p>认证失败后会调用的方法，清空<code>SecurityContextHolder</code>上下文，然后调用<code>RememberMeServices</code>类的<code>loginFail</code>方法，再调用<code>AuthenticationFailureHandler</code>类的<code>onAuthenticationFailure</code>方法，也就是我们配置的认证失败后做的处理（比如返回json、跳转到失败页等）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
      <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
   <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to process authentication request&quot;</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Cleared SecurityContextHolder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Handling authentication failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102214259842.png" alt="image-20230102214259842" tabindex="0" loading="lazy"><figcaption>image-20230102214259842</figcaption></figure><p>接着回到<code>UsernamePasswordAuthenticationFilter</code>类的<code>attemptAuthentication</code>尝试认证方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> usernameParameter <span class="token operator">=</span> <span class="token constant">SPRING_SECURITY_FORM_USERNAME_KEY</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> passwordParameter <span class="token operator">=</span> <span class="token constant">SPRING_SECURITY_FORM_PASSWORD_KEY</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>postOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication method not supported: &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 获取用户名</span>
   <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">obtainUsername</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
   username <span class="token operator">=</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取密码</span>
   <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">obtainPassword</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
   password <span class="token operator">=</span> <span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> password <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
   <span class="token comment">// 使用UsernamePasswordAuthenticationToken类的unauthenticated静态方法，构造UsernamePasswordAuthenticationToken对象</span>
   <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>
         password<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// Allow subclasses to set the &quot;details&quot; property</span>
   <span class="token comment">// 设置一些额外的详细信息</span>
   <span class="token function">setDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 调用AuthenticationManager接口的authenticate方法进行认证，这里使用的实现类是DaoAuthenticationProvider</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取密码</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">obtainPassword</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>passwordParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取用户名</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">obtainUsername</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>usernameParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102215131873.png" alt="image-20230102215131873" tabindex="0" loading="lazy"><figcaption>image-20230102215131873</figcaption></figure><h2 id="formloginconfigurer" tabindex="-1"><a class="header-anchor" href="#formloginconfigurer" aria-hidden="true">#</a> FormLoginConfigurer</h2><p>这个方法主要用于配置表单登录</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102220200090.png" alt="image-20230102220200090" tabindex="0" loading="lazy"><figcaption>image-20230102220200090</figcaption></figure><p>我们先看<code>SecurityConfigurerAdapter</code>抽象类，该类主要就是维护了一个<code>objectPostProcessor</code>，然后遍历其内部的<code>postProcessors</code>，调用其<code>postProcess</code>方法；提供了一个<code>and</code>方法用于进行链式调用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfigurerAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">B</span> securityBuilder<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">CompositeObjectPostProcessor</span> objectPostProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeObjectPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">B</span> <span class="token function">getBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;securityBuilder cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityBuilder<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">T</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBuilder</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>securityBuilder <span class="token operator">=</span> builder<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CompositeObjectPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObjectPostProcessor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unchecked&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span> opp <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> oppClass <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> oppType <span class="token operator">=</span> <span class="token class-name">GenericTypeResolver</span><span class="token punctuation">.</span><span class="token function">resolveTypeArgument</span><span class="token punctuation">(</span>oppClass<span class="token punctuation">,</span> <span class="token class-name">ObjectPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oppType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> oppType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               object <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> object<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102220422314.png" alt="image-20230102220422314" tabindex="0" loading="lazy"><figcaption>image-20230102220422314</figcaption></figure><p><code>AbstractHttpConfigurer</code>抽象类有<code>disable</code>方法和<code>withObjectPostProcessor</code>方法，<code>disable</code>方法用于移除配置并返回<code>HttpSecurityBuilder</code>用于链式调用。<code>withObjectPostProcessor</code>方法会调用<code>addObjectPostProcessor</code>方法并返回自己</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurerAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Disables the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractHttpConfigurer</span></span><span class="token punctuation">}</span> by removing it. After doing so a fresh
    * version of the configuration can be applied.
    * <span class="token keyword">@return</span> the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">HttpSecurityBuilder</span></span><span class="token punctuation">}</span> for additional customizations
    */</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeConfigurer</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">getBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">withObjectPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addObjectPostProcessor</span><span class="token punctuation">(</span>objectPostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102220854227.png" alt="image-20230102220854227" tabindex="0" loading="lazy"><figcaption>image-20230102220854227</figcaption></figure><p><code>AbstractHttpConfigurer</code>类继承的抽象类<code>SecurityConfigurerAdapter</code>的泛型继承于<code>SecurityBuilder</code>，<code>SecurityBuilder</code>接口有一个抽象类<code>AbstractConfiguredSecurityBuilder</code>，其有<code>removeConfigurer</code>方法（这个类我们最开始就说过，其<code>doBuild()</code>方法会调用子类的<code>O result = performBuild();</code>方法，返回构建的对象，<code>AbstractConfiguredSecurityBuilder</code>子类有<code>HttpSecurity</code>和<code>WebSecurity</code>）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">C</span> <span class="token function">removeConfigurer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
         <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Only one configurer expected for type &quot;</span> <span class="token operator">+</span> clazz <span class="token operator">+</span> <span class="token string">&quot;, but got &quot;</span> <span class="token operator">+</span> configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> configs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102221732457.png" alt="image-20230102221732457" tabindex="0" loading="lazy"><figcaption>image-20230102221732457</figcaption></figure><p>接着我们说<code>AbstractAuthenticationFilterConfigurer</code>抽象类，其间接继承<code>SecurityConfigurer</code>接口，就必有<code>init(B builder)</code>方法和<code>configure(B builder)</code>方法，<code>init(B builder)</code>方法就是做一些初始化工作就没什么好看的了，直接看<code>configure(B builder)</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">B</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">PortMapper</span> portMapper <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">PortMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>portMapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">setPortMapper</span><span class="token punctuation">(</span>portMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// requestCache用于登录过期重新登陆后返回到上次访问的页面，而不是首页，给用户带来良好的体验</span>
   <span class="token class-name">RequestCache</span> requestCache <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>defaultSuccessHandler<span class="token punctuation">.</span><span class="token function">setRequestCache</span><span class="token punctuation">(</span>requestCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 设置认证管理器</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 设置认证成功的处理器</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>successHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 设置认证失败的处理器</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// session认证策略</span>
   <span class="token class-name">SessionAuthenticationStrategy</span> sessionAuthenticationStrategy <span class="token operator">=</span> http
         <span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionAuthenticationStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setSessionAuthenticationStrategy</span><span class="token punctuation">(</span>sessionAuthenticationStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 记住我</span>
   <span class="token class-name">RememberMeServices</span> rememberMeServices <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RememberMeServices</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeServices <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setRememberMeServices</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">SecurityContextConfigurer</span> securityContextConfigurer <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>securityContextConfigurer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> securityContextConfigurer<span class="token punctuation">.</span><span class="token function">isRequireExplicitSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> securityContextConfigurer
            <span class="token punctuation">.</span><span class="token function">getSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextRepository</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">F</span> filter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 添加一个过滤器</span>
   http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102223621051.png" alt="image-20230102223621051" tabindex="0" loading="lazy"><figcaption>image-20230102223621051</figcaption></figure><p><code>FormLoginConfigurer</code>页没干很多事情，就是初始化了一些参数，然后可以进行配置</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 默认登录页面生成过滤器</span>
   <span class="token class-name">DefaultLoginPageGeneratingFilter</span> loginPageGeneratingFilter <span class="token operator">=</span> http
         <span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">DefaultLoginPageGeneratingFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>loginPageGeneratingFilter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isCustomLoginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setFormLoginEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setUsernameParameter</span><span class="token punctuation">(</span><span class="token function">getUsernameParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setPasswordParameter</span><span class="token punctuation">(</span><span class="token function">getPasswordParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setLoginPageUrl</span><span class="token punctuation">(</span><span class="token function">getLoginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setFailureUrl</span><span class="token punctuation">(</span><span class="token function">getFailureUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationUrl</span><span class="token punctuation">(</span><span class="token function">getLoginProcessingUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102223621052.png" alt="image-20230102223621052" tabindex="0" loading="lazy"><figcaption>image-20230102223621052</figcaption></figure><p><code>DefaultLoginPageGeneratingFilter</code>默认登录页面生成过滤器生成的页面就长下面这样</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102224841514.png" alt="image-20230102224841514" tabindex="0" loading="lazy"><figcaption>image-20230102224841514</figcaption></figure><p>如果没有配置的话，控制台会打印如下信息，输出随机生成的密码</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">2023</span>-01-02 <span class="token number">22</span>:48:17.033  WARN <span class="token number">7692</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> .s.s.UserDetailsServiceAutoConfiguration <span class="token builtin class-name">:</span> 

Using generated security password: <span class="token number">90655204</span>-f82d-4c49-a7b4-6f14aca7c157

This generated password is <span class="token keyword">for</span> development use only. Your security configuration must be updated before running your application <span class="token keyword">in</span> production.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102225203468.png" alt="image-20230102225203468" tabindex="0" loading="lazy"><figcaption>image-20230102225203468</figcaption></figure><p>查看<code>UserDetailsServiceAutoConfiguration</code>可以看到默认配置了一个<code>InMemoryUserDetailsManager</code>（使用<code>SecurityProperties</code>配置类的信息），并且如果密码是自动生成的还会打印密码信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Lazy</span>
<span class="token keyword">public</span> <span class="token class-name">InMemoryUserDetailsManager</span> <span class="token function">inMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token class-name">SecurityProperties</span> properties<span class="token punctuation">,</span>
      <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PasswordEncoder</span><span class="token punctuation">&gt;</span></span> passwordEncoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">SecurityProperties<span class="token punctuation">.</span>User</span> user <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span>
         <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">getOrDeducePassword</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getOrDeducePassword</span><span class="token punctuation">(</span><span class="token class-name">SecurityProperties<span class="token punctuation">.</span>User</span> user<span class="token punctuation">,</span> <span class="token class-name">PasswordEncoder</span> encoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">isPasswordGenerated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            <span class="token string">&quot;%n%nUsing generated security password: %s%n%nThis generated password is for development use only. &quot;</span>
                  <span class="token operator">+</span> <span class="token string">&quot;Your security configuration must be updated before running your application in &quot;</span>
                  <span class="token operator">+</span> <span class="token string">&quot;production.%n&quot;</span><span class="token punctuation">,</span>
            user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>encoder <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token constant">PASSWORD_ALGORITHM_PATTERN</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> password<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token constant">NOOP_PASSWORD_PREFIX</span> <span class="token operator">+</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102225335189.png" alt="image-20230102225335189" tabindex="0" loading="lazy"><figcaption>image-20230102225335189</figcaption></figure><p><code>org.springframework.boot.autoconfigure.security.SecurityProperties</code>类的静态内部类<code>User</code>里有<code>name</code>、<code>password</code>、<code>passwordGenerated</code>等字段</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * Default user name.
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Password for the default user name.
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Granted roles for the default user name.
    */</span>
   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> passwordGenerated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102225548176.png" alt="image-20230102225548176" tabindex="0" loading="lazy"><figcaption>image-20230102225548176</figcaption></figure><h1 id="源码调试" tabindex="-1"><a class="header-anchor" href="#源码调试" aria-hidden="true">#</a> 源码调试</h1><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>postOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication method not supported: &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// user</span>
   <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">obtainUsername</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
   username <span class="token operator">=</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
   <span class="token comment">// 控制台输出的密码</span>
   <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">obtainPassword</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
   password <span class="token operator">=</span> <span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> password <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
   <span class="token comment">// 封装成UsernamePasswordAuthenticationToken</span>
   <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>
         password<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// Allow subclasses to set the &quot;details&quot; property</span>
   <span class="token comment">// 设置remoteAddress、sessionId等信息</span>
   <span class="token function">setDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 调用ProviderManager的authenticate方法</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102230819024.png" alt="image-20230102230819024" tabindex="0" loading="lazy"><figcaption>image-20230102230819024</figcaption></figure><p>这个<code>ProviderManager</code>对象的<code>providers</code>里的为<code>AnonymousAuthenticationProvider</code>（匿名的认证提供者）不是我们需要的，而<code>parent</code>的<code>providers</code>里的<code>DaoAuthenticationProvider</code>才是我们需要的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102231240621.png" alt="image-20230102231240621" tabindex="0" loading="lazy"><figcaption>image-20230102231240621</figcaption></figure><p>因此首先找自己的<code>providers</code>没找到</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102231630933.png" alt="image-20230102231630933" tabindex="0" loading="lazy"><figcaption>image-20230102231630933</figcaption></figure><p>然后递归调用其父类的<code>authenticate</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102231723596.png" alt="image-20230102231723596" tabindex="0" loading="lazy"><figcaption>image-20230102231723596</figcaption></figure><p>父类的<code>DaoAuthenticationProvider</code>提供者支持</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230102232138900.png" alt="image-20230102232138900" tabindex="0" loading="lazy"><figcaption>image-20230102232138900</figcaption></figure><p>然后进入到<code>AbstractUserDetailsAuthenticationProvider</code>抽象类的<code>authenticate</code>方法，其会调用<code>retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);</code>方法检索用户</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103194334392.png" alt="image-20230103194334392" tabindex="0" loading="lazy"><figcaption>image-20230103194334392</figcaption></figure><p><code>retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);</code>方法为其子类<code>DaoAuthenticationProvider</code>实现的，这里面的<code>UserDetailsService</code>默认是<code>InMemoryUserDetailsManager</code>，即在内存中的用户，<code>password</code>里的<code>{noop}</code>表示使用的是明文密码</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103194711965.png" alt="image-20230103194711965" tabindex="0" loading="lazy"><figcaption>image-20230103194711965</figcaption></figure><p>获取用户信息后准备调用<code>additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);</code>做密码校验</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103195033174.png" alt="image-20230103195033174" tabindex="0" loading="lazy"><figcaption>image-20230103195033174</figcaption></figure><p>在这个方法里校验通过了</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103195204396.png" alt="image-20230103195204396" tabindex="0" loading="lazy"><figcaption>image-20230103195204396</figcaption></figure><p>然后判断如果不是在缓存中获取的用户信息，将用户信息放入缓存中</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103195251813.png" alt="image-20230103195251813" tabindex="0" loading="lazy"><figcaption>image-20230103195251813</figcaption></figure><p>然后调用<code> createSuccessAuthentication(principalToReturn, authentication, user);</code>方法，这个方法判断密码需要升级，因此升级密码后再调用父类的<code>createSuccessAuthentication(principal, authentication, user);</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103195510794.png" alt="image-20230103195510794" tabindex="0" loading="lazy"><figcaption>image-20230103195510794</figcaption></figure><p>父类的<code>createSuccessAuthentication</code>方法比较简单，调用<code>UsernamePasswordAuthenticationToken</code>类的<code>authenticated</code>静态方法，返回一个<code>UsernamePasswordAuthenticationToken</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103195653631.png" alt="image-20230103195653631" tabindex="0" loading="lazy"><figcaption>image-20230103195653631</figcaption></figure><p>在<code>ProviderManager</code>类里，认证成功后将密码擦除，然后发布认证成功的消息</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103195923315.png" alt="image-20230103195923315" tabindex="0" loading="lazy"><figcaption>image-20230103195923315</figcaption></figure><p>调用<code>attemptAuthentication(request, response);</code>方法尝试认证成功后，做认证成功的逻辑</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103200213215.png" alt="image-20230103200213215" tabindex="0" loading="lazy"><figcaption>image-20230103200213215</figcaption></figure><p>将认证成功的信息封装到<code>SecurityContext</code>里面，然后发布事件，执行<code>successHandler</code>成功处理器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103200401362.png" alt="image-20230103200401362" tabindex="0" loading="lazy"><figcaption>image-20230103200401362</figcaption></figure><p>在里面可以重定向到成功页</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103200544040.png" alt="image-20230103200544040" tabindex="0" loading="lazy"><figcaption>image-20230103200544040</figcaption></figure><h1 id="五、" tabindex="-1"><a class="header-anchor" href="#五、" aria-hidden="true">#</a> 五、</h1><h2 id="securitycontext" tabindex="-1"><a class="header-anchor" href="#securitycontext" aria-hidden="true">#</a> SecurityContext</h2><p>SecurityContext接口提供了与当前线程相关联的最小化安全信息，其方法也比较简单，一个是获取<code>Authentication</code>，一个是设置<code>Authentication</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Interface defining the minimum security information associated with the current thread
 * of execution.
 *
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * The security context is stored in a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContextHolder</span></span><span class="token punctuation">}</span>.
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token keyword">@author</span> Ben Alex
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityContext</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    
   <span class="token class-name">Authentication</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">void</span> <span class="token function">setAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103201735712.png" alt="image-20230103201735712" tabindex="0" loading="lazy"><figcaption>image-20230103201735712</figcaption></figure><p><code>SecurityContext</code>接口的常用实现了<code>SecurityContextImpl</code>非常简单，就是维护一个<code>Authentication</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SecurityContext</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token class-name">SpringSecurityCoreVersion</span><span class="token punctuation">.</span><span class="token constant">SERIAL_VERSION_UID</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authentication <span class="token operator">=</span> authentication<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">SecurityContextImpl</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextImpl</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
               <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authentication<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">nullSafeHashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authentication <span class="token operator">=</span> authentication<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authentication <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Null authentication&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103204042981.png" alt="image-20230103204042981" tabindex="0" loading="lazy"><figcaption>image-20230103204042981</figcaption></figure><h2 id="securitycontextholder" tabindex="-1"><a class="header-anchor" href="#securitycontextholder" aria-hidden="true">#</a> SecurityContextHolder</h2><p><code>SecurityContextHolder</code>维护一个<code>SecurityContext</code>，提供了增删查改方法，不过该类也不真正实现，全部委托给<code>SecurityContextHolderStrategy</code>安全上下文拥有者策略去实现</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103202430076.png" alt="image-20230103202430076" tabindex="0" loading="lazy"><figcaption>image-20230103202430076</figcaption></figure><h2 id="securitycontextholderstrategy" tabindex="-1"><a class="header-anchor" href="#securitycontextholderstrategy" aria-hidden="true">#</a> SecurityContextHolderStrategy</h2><p>在<code>SecurityContextHolderStrategy</code>接口里主要定义了获取、修改、删除<code>SecurityContext</code>的方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityContextHolderStrategy</span> <span class="token punctuation">{</span>

   <span class="token keyword">void</span> <span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">SecurityContext</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">void</span> <span class="token function">setContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">SecurityContext</span> <span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103203409008.png" alt="image-20230103203409008" tabindex="0" loading="lazy"><figcaption>image-20230103203409008</figcaption></figure><p>我们常常用到的是<code>ThreadLocalSecurityContextHolderStrategy</code>，这个类也非常简单，就是从<code>ThreadLocal</code>里获取、修改、删除<code>SecurityContext</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalSecurityContextHolderStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SecurityContextHolderStrategy</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> contextHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      contextHolder<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">SecurityContext</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContext</span> ctx <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ctx <span class="token operator">=</span> <span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;Only non-null SecurityContext instances are permitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">SecurityContext</span> <span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103203723012.png" alt="image-20230103203723012" tabindex="0" loading="lazy"><figcaption>image-20230103203723012</figcaption></figure><p>那我们怎么知道默认使用的是<code>ThreadLocalSecurityContextHolderStrategy</code>呢？</p><p>查看<code>SecurityContextHolder</code>的静态代码块，可以看到其会调用<code>initialize();</code>方法，而<code>initialize();</code>方法又会调用<code>initializeStrategy()</code>方法，如果没有设置系统属性，则默认使用<code>ThreadLocalSecurityContextHolderStrategy()</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextHolder</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MODE_THREADLOCAL</span> <span class="token operator">=</span> <span class="token string">&quot;MODE_THREADLOCAL&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MODE_INHERITABLETHREADLOCAL</span> <span class="token operator">=</span> <span class="token string">&quot;MODE_INHERITABLETHREADLOCAL&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MODE_GLOBAL</span> <span class="token operator">=</span> <span class="token string">&quot;MODE_GLOBAL&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MODE_PRE_INITIALIZED</span> <span class="token operator">=</span> <span class="token string">&quot;MODE_PRE_INITIALIZED&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYSTEM_PROPERTY</span> <span class="token operator">=</span> <span class="token string">&quot;spring.security.strategy&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> strategyName <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_PROPERTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SecurityContextHolderStrategy</span> strategy<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> initializeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

   <span class="token keyword">static</span> <span class="token punctuation">{</span>
      <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initializeStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      initializeCount<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果配置的strategyName为MODE_PRE_INITIALIZED表示已经设置过策略了，直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">MODE_PRE_INITIALIZED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>strategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;When using &quot;</span> <span class="token operator">+</span> <span class="token constant">MODE_PRE_INITIALIZED</span>
               <span class="token operator">+</span> <span class="token string">&quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果strategyName没有内容，则将strategyName设置为MODE_THREADLOCAL</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Set default</span>
         strategyName <span class="token operator">=</span> <span class="token constant">MODE_THREADLOCAL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果strategyName为MODE_THREADLOCAL，设置策略为ThreadLocalSecurityContextHolderStrategy()</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>strategyName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MODE_THREADLOCAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果strategyName为MODE_INHERITABLETHREADLOCAL，设置策略为InheritableThreadLocalSecurityContextHolderStrategy() (线程可以被继承，即创建新的线程执行任务的时候，可以继承父线程的ThreadLocal的信息)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>strategyName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MODE_INHERITABLETHREADLOCAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InheritableThreadLocalSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果strategyName为MODE_GLOBAL,设置策略为GlobalSecurityContextHolderStrategy()（全局就一个上下文，一般不会用到）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>strategyName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MODE_GLOBAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GlobalSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Try to load a custom strategy</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> customStrategy <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         strategy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolderStrategy</span><span class="token punctuation">)</span> customStrategy<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">handleReflectionException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103204531604.png" alt="image-20230103204531604" tabindex="0" loading="lazy"><figcaption>image-20230103204531604</figcaption></figure><h2 id="securitycontextrepository" tabindex="-1"><a class="header-anchor" href="#securitycontextrepository" aria-hidden="true">#</a> SecurityContextRepository</h2><p>用于持久化存储<code>SecurityContext</code>的策略，让用户第一次请求登陆后，下次请求不用再次登录</p><p><code>SecurityContextRepository</code>接口主要有加载上下文、保存上下文、判断上下文中是否有<code>SecurityContext</code>等方法，自定义实现该接口比较常用（比如分布式系统中，将用户信息保存在<code>redis</code>中，在<code>redis</code>里获取用户信息）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityContextRepository</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Deprecated</span>
   <span class="token class-name">SecurityContext</span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token class-name">HttpRequestResponseHolder</span> requestResponseHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">default</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">SingletonSupplier</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">saveContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> context<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">boolean</span> <span class="token function">containsContext</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103210504362.png" alt="image-20230103210504362" tabindex="0" loading="lazy"><figcaption>image-20230103210504362</figcaption></figure><h2 id="securitycontextpersistencefilter" tabindex="-1"><a class="header-anchor" href="#securitycontextpersistencefilter" aria-hidden="true">#</a> SecurityContextPersistenceFilter</h2><p><code>SecurityContextPersistenceFilter</code>：安全上下文持久化过滤器，根据<code>SecurityContextRepository</code>的信息填充<code>SecurityContextHolder</code>，这个类已经被弃用了，推荐使用<code>SecurityContextHolderFilter</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103211114688.png" alt="image-20230103211114688" tabindex="0" loading="lazy"><figcaption>image-20230103211114688</figcaption></figure><p>这个类里最重要的就是<code>doFilter</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Deprecated</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextPersistenceFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

   <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FILTER_APPLIED</span> <span class="token operator">=</span> <span class="token string">&quot;__spring_security_scpf_applied&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">SecurityContextRepository</span> repo<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> forceEagerSessionCreation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> repo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>repo <span class="token operator">=</span> repo<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 确保每个请求只应用一次过滤器</span>
      <span class="token comment">// ensure that filter is only applied once per request</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>forceEagerSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> session<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Created session %s eagerly&quot;</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">HttpRequestResponseHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 从SecurityContextRepository里加载SecurityContext</span>
      <span class="token class-name">SecurityContext</span> contextBeforeChainExecution <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 向SecurityContextHolder里设置SecurityContext信息</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to empty SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>logger
                     <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to %s&quot;</span><span class="token punctuation">,</span> contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// 将SecurityContextHolder里的SecurityContext拿出来</span>
         <span class="token class-name">SecurityContext</span> contextAfterChainExecution <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// Crucial removal of SecurityContextHolder contents before anything else.</span>
         <span class="token comment">// 将SecurityContext从SecurityContextHolder里清除掉，为什么要清除呢？因为默认使用的策略是ThreadLocalSecurityContextHolderStrategy()，如果不清除的话，容易造成内存泄漏</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 将SecurityContext保存到仓库中</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>contextAfterChainExecution<span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cleared SecurityContextHolder to complete request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setForceEagerSessionCreation</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceEagerSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>forceEagerSessionCreation <span class="token operator">=</span> forceEagerSessionCreation<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103211815527.png" alt="image-20230103211815527" tabindex="0" loading="lazy"><figcaption>image-20230103211815527</figcaption></figure><h2 id="securitycontextholderfilter" tabindex="-1"><a class="header-anchor" href="#securitycontextholderfilter" aria-hidden="true">#</a> SecurityContextHolderFilter</h2><p><code>SecurityContextPersistenceFilter</code>类被弃用，推荐使用<code>SecurityContextHolderFilter</code>类</p><p>一个使用 SecurityContextRepository 获取 SecurityContext 并将其设置在 SecurityContextHolder 上的 javax.servlet.Filter。 类似于 SecurityContextPersistenceFilter，除了必须显式调用 SecurityContextRepository.saveContext(SecurityContext, HttpServletRequest, HttpServletResponse) 来保存 SecurityContext。 通过允许不同的身份验证机制单独选择是否应保留身份验证，这提高了效率并提供了更好的灵活性。（意思就是我们使用这个类需要手动调用<code> SecurityContextRepository</code>类的<code>saveContext</code>方法）</p><p>这个类比<code>SecurityContextPersistenceFilter</code>简单，主要少了将SecurityContext保存到仓库中这一步，因此需要我们手动调用<code>SecurityContextRepository</code>类的<code>saveContext</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * A <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">Filter</span></span><span class="token punctuation">}</span> that uses the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContextRepository</span></span><span class="token punctuation">}</span> to
 * obtain the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContext</span></span><span class="token punctuation">}</span> and set it on the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContextHolder</span></span><span class="token punctuation">}</span>.
 * This is similar to <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContextPersistenceFilter</span></span><span class="token punctuation">}</span> except that the
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">#</span><span class="token function">saveContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span><span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * must be explicitly invoked to save the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SecurityContext</span></span><span class="token punctuation">}</span>. This improves the
 * efficiency and provides better flexibility by allowing different authentication
 * mechanisms to choose individually if authentication should be persisted.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextHolderFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> shouldNotFilterErrorDispatch<span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Creates a new instance.
    * <span class="token keyword">@param</span> <span class="token parameter">securityContextRepository</span> the repository to use. Cannot be null.
    */</span>
   <span class="token keyword">public</span> <span class="token class-name">SecurityContextHolderFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">,</span> <span class="token string">&quot;securityContextRepository cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository <span class="token operator">=</span> securityContextRepository<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 从SecurityContextRepository里加载SecurityContext</span>
      <span class="token class-name">SecurityContext</span> securityContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 向SecurityContextHolder里设置SecurityContext信息</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>securityContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
         filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// 将SecurityContext从SecurityContextHolder里清除掉</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103213205884.png" alt="image-20230103213205884" tabindex="0" loading="lazy"><figcaption>image-20230103213205884</figcaption></figure><h2 id="securitycontextconfigurer" tabindex="-1"><a class="header-anchor" href="#securitycontextconfigurer" aria-hidden="true">#</a> SecurityContextConfigurer</h2><p>这个类主要就是用来配置<code>SecurityContextHolderFilter</code>和<code>SecurityContextPersistenceFilter</code>的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103214326767.png" alt="image-20230103214326767" tabindex="0" loading="lazy"><figcaption>image-20230103214326767</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> <span class="token function">getSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 如果要求显式保存（自己手动保存到SecurityContextRepository里），就使用SecurityContextHolderFilter</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requireExplicitSave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContextHolderFilter</span> securityContextHolderFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">SecurityContextHolderFilter</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>securityContextHolderFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不要显示保存，就使用SecurityContextPersistenceFilter</span>
      <span class="token class-name">SecurityContextPersistenceFilter</span> securityContextFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">(</span>
            securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SessionManagementConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> sessionManagement <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">SessionManagementConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SessionCreationPolicy</span> sessionCreationPolicy <span class="token operator">=</span> <span class="token punctuation">(</span>sessionManagement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> sessionManagement<span class="token punctuation">.</span><span class="token function">getSessionCreationPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">ALWAYS</span> <span class="token operator">==</span> sessionCreationPolicy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         securityContextFilter<span class="token punctuation">.</span><span class="token function">setForceEagerSessionCreation</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForceEagerSessionCreationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      securityContextFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>securityContextFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>securityContextFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103213901854.png" alt="image-20230103213901854" tabindex="0" loading="lazy"><figcaption>image-20230103213901854</figcaption></figure><h2 id="filterchainproxy" tabindex="-1"><a class="header-anchor" href="#filterchainproxy" aria-hidden="true">#</a> FilterChainProxy</h2><p>Spring Security的核心就是<code>FilterChainProxy</code>，里面维护了一堆的<code>SecurityFilterChain</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103214538781.png" alt="image-20230103214538781" tabindex="0" loading="lazy"><figcaption>image-20230103214538781</figcaption></figure><p>在<code>HttpSecurity</code>类的<code>performBuild</code>方法里返回了一个默认的<code>SecurityFilterChain</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> expressionConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span>
         <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> httpConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> oneConfigurerPresent <span class="token operator">=</span> expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">^</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">(</span>expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> oneConfigurerPresent<span class="token punctuation">,</span>
         <span class="token string">&quot;authorizeHttpRequests cannot be used in conjunction with authorizeRequests. Please select just one.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">OrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> sortedFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Filter</span> filter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sortedFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderedFilter</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher<span class="token punctuation">,</span> sortedFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103214727211.png" alt="image-20230103214727211" tabindex="0" loading="lazy"><figcaption>image-20230103214727211</figcaption></figure><p>而在<code>WebSecurity</code>的<code>performBuild</code>方法里返回了一个<code>FilterChainProxy</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. &quot;</span>
               <span class="token operator">+</span> <span class="token string">&quot;Typically this is done by exposing a SecurityFilterChain bean. &quot;</span>
               <span class="token operator">+</span> <span class="token string">&quot;More advanced users can invoke &quot;</span> <span class="token operator">+</span> <span class="token class-name">WebSecurity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token operator">+</span> <span class="token string">&quot;.addSecurityFilterChainBuilder directly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> chainSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoredRequests<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chainSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcherEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">WebInvocationPrivilegeEvaluator</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMatcherPrivilegeEvaluatorsEntries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 将忽略拦截的请求路径放到SecurityFilterChain里</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> ignoredRequest <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoredRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">WebSecurity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;You are asking Spring Security to ignore &quot;</span> <span class="token operator">+</span> ignoredRequest
            <span class="token operator">+</span> <span class="token string">&quot;. This is not recommended -- please use permitAll via HttpSecurity#authorizeHttpRequests instead.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span>ignoredRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      requestMatcherPrivilegeEvaluatorsEntries
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getRequestMatcherPrivilegeEvaluatorsEntry</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChainBuilder <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">=</span> securityFilterChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      requestMatcherPrivilegeEvaluatorsEntries
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getRequestMatcherPrivilegeEvaluatorsEntry</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>privilegeEvaluator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>privilegeEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestMatcherDelegatingWebInvocationPrivilegeEvaluator</span><span class="token punctuation">(</span>
            requestMatcherPrivilegeEvaluatorsEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 使用securityFilterChains创建FilterChainProxydui&#39;xia</span>
   <span class="token class-name">FilterChainProxy</span> filterChainProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span>securityFilterChains<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      filterChainProxy<span class="token punctuation">.</span><span class="token function">setFirewall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      filterChainProxy<span class="token punctuation">.</span><span class="token function">setRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   filterChainProxy<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">Filter</span> result <span class="token operator">=</span> filterChainProxy<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;\n\n&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;**********    This may include sensitive information.  *************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;**********      Do not use in a production system!     *************\n&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DebugFilter</span><span class="token punctuation">(</span>filterChainProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>postBuildAction<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230103215058677.png" alt="image-20230103215058677" tabindex="0" loading="lazy"><figcaption>image-20230103215058677</figcaption></figure><h1 id="六" tabindex="-1"><a class="header-anchor" href="#六" aria-hidden="true">#</a> 六.</h1><h2 id="remembermeauthenticationfilter" tabindex="-1"><a class="header-anchor" href="#remembermeauthenticationfilter" aria-hidden="true">#</a> RememberMeAuthenticationFilter</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
   <span class="token comment">// 已经认证过了，不需要再次认证了，直接放行</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span>
            <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;SecurityContextHolder not populated with remember-me token, as it already contained: &#39;&quot;</span>
                  <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 首先调用RememberMeServices类的autoLogin方法，获得Authentication</span>
   <span class="token class-name">Authentication</span> rememberMeAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">autoLogin</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeAuth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Attempt authenticaton via AuthenticationManager</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 调用authenticationManager的authenticate方法进行认证，如果认证失败会抛出AuthenticationException</span>
         rememberMeAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// Store to SecurityContextHolder</span>
         <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 将SecurityContext保存到SecurityContextHolder里</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;SecurityContextHolder populated with remember-me token: &#39;&quot;</span>
               <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 将登录信息保存到仓库里</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 发布交互式身份验证成功事件</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>
                  <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 登录成功后的处理</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>successHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span>
               <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityContextHolder not populated with remember-me token, as AuthenticationManager &quot;</span>
                     <span class="token operator">+</span> <span class="token string">&quot;rejected Authentication returned by RememberMeServices: &#39;%s&#39;; &quot;</span>
                     <span class="token operator">+</span> <span class="token string">&quot;invalidating remember-me token&quot;</span><span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">,</span>
               ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 通知登录失败</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 认证失败，内容为空，意思就是认证失败了也不继续抛异常了，接着调用chain.doFilter(request, response);继续往后面的逻辑走，让用户登录即可（只是尝试登录一下，即便没有登录成功也不要紧，不直接将线程终止掉）</span>
         <span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104203745475.png" alt="image-20230104203745475" tabindex="0" loading="lazy"><figcaption>image-20230104203745475</figcaption></figure><h2 id="remembermeservices" tabindex="-1"><a class="header-anchor" href="#remembermeservices" aria-hidden="true">#</a> RememberMeServices</h2><p><code>RememberMeServices</code>接口有<code>3</code>个方法，<code>autoLogin</code>方法用于构造一个<code>Authentication</code>（这个<code>Authentication</code>必须要<code>AuthenticationManager</code>和<code>AuthenticationProvider</code>所接受，推荐使用<code>RememberMeAuthenticationToken</code>），然后拿着<code>Authentication</code>尝试调用<code>authenticationManager.authenticate(Authentication authentication)</code>去登录，<code>loginFail</code>就是登录失败的处理，<code>loginSuccess</code>就是登录成功的处理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RememberMeServices</span> <span class="token punctuation">{</span>

	<span class="token doc-comment comment">/**
	 * The returned <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">Authentication</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> must be acceptable to
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span></span><span class="token punctuation">}</span> or
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationProvider</span></span><span class="token punctuation">}</span> defined
	 * by the web application. It is recommended
	 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">RememberMeAuthenticationToken</span></span><span class="token punctuation">}</span>
	 * be used in most cases, as it has a corresponding authentication provider.
	 * <span class="token keyword">@param</span> <span class="token parameter">request</span> to look for a remember-me token within
	 * <span class="token keyword">@param</span> <span class="token parameter">response</span> to change, cancel or modify the remember-me token
	 * <span class="token keyword">@return</span> a valid authentication object, or <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> if the request should
	 * not be authenticated
	 */</span>
	<span class="token class-name">Authentication</span> <span class="token function">autoLogin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">loginFail</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
			<span class="token class-name">Authentication</span> successfulAuthentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104204536982.png" alt="image-20230104204536982" tabindex="0" loading="lazy"><figcaption>image-20230104204536982</figcaption></figure><h2 id="remembermeauthenticationtoken" tabindex="-1"><a class="header-anchor" href="#remembermeauthenticationtoken" aria-hidden="true">#</a> RememberMeAuthenticationToken</h2><p><code>RememberMeAuthenticationToken</code>继承自<code>AbstractAuthenticationToken</code>（<code>UsernamePasswordAuthenticationToken</code>也继承自<code>AbstractAuthenticationToken</code>）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104205137142.png" alt="image-20230104205137142" tabindex="0" loading="lazy"><figcaption>image-20230104205137142</figcaption></figure><p><code>UsernamePasswordAuthenticationToken</code>的继承结构</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104205239718.png" alt="image-20230104205239718" tabindex="0" loading="lazy"><figcaption>image-20230104205239718</figcaption></figure><p><code>RememberMeAuthenticationToken</code>比较简单，不管是哪个构造方法，只要<code>authorities</code>权限信息传过来，就认为是已经认证的状态了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RememberMeAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token class-name">SpringSecurityCoreVersion</span><span class="token punctuation">.</span><span class="token constant">SERIAL_VERSION_UID</span><span class="token punctuation">;</span>
   <span class="token comment">// 主体</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> keyHash<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
         <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 设置权限</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>principal <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot pass null or empty values to constructor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>keyHash <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
      <span class="token comment">// 设置已经认证过了</span>
      <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> keyHash<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
         <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 设置权限</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>keyHash <span class="token operator">=</span> keyHash<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
      <span class="token comment">// 设置已经认证过了</span>
      <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104205712263.png" alt="image-20230104205712263" tabindex="0" loading="lazy"><figcaption>image-20230104205712263</figcaption></figure><p><code>AbstractAuthenticationToken</code>类比较简单，就权限信息、详情、是否已认证 这3个信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token keyword">implements</span> <span class="token class-name">Authentication</span><span class="token punctuation">,</span> <span class="token class-name">CredentialsContainer</span> <span class="token punctuation">{</span>
   <span class="token comment">// 权限信息</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>
   <span class="token comment">// 详情</span>
   <span class="token keyword">private</span> <span class="token class-name">Object</span> details<span class="token punctuation">;</span>
   <span class="token comment">// 是否已经认证了</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> authenticated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104205421786.png" alt="image-20230104205421786" tabindex="0" loading="lazy"><figcaption>image-20230104205421786</figcaption></figure><h2 id="remembermeauthenticationprovider" tabindex="-1"><a class="header-anchor" href="#remembermeauthenticationprovider" aria-hidden="true">#</a> RememberMeAuthenticationProvider</h2><p><code>AuthenticationProvider</code>接口有一个实现类叫<code>RememberMeAuthenticationProvider</code>，因此<code>RememberMeAuthenticationToken</code>的这个<code>Authentication</code>肯定能被<code>AuthenticationProvider</code>接口的实现类<code>RememberMeAuthenticationProvider</code>所接受。</p><p><code>AuthenticationProvider</code>这个接口我们以前提到过，就是<code>ProviderManager</code>类的构造方法需要传递<code>AuthenticationProvider</code>集合，这个接口有两个方法，一个是<code>supports</code>方法，判断是否支持；另一个是<code>authenticate</code>执行认证逻辑。这是经典的策略模式，先判断是否支持，然后再调用具体的业务方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>

   <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>

   <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104211734834.png" alt="image-20230104211734834" tabindex="0" loading="lazy"><figcaption>image-20230104211734834</figcaption></figure><p>因此<code>RememberMeAuthenticationProvider</code>类最重要的就是<code>authenticate</code>、<code>supports</code>这两个方法了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RememberMeAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>

   <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 首先判断是否支持想要授权的类（其实执行authenticate方法之前肯定会判断是否支持的，只有支持了才会调用authenticate方法，不过这里判断一下也行）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">supports</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 判断key的hashCode()和authentication.getKeyHash()是否相同，不相同直接抛出异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;RememberMeAuthenticationProvider.incorrectKey&quot;</span><span class="token punctuation">,</span>
               <span class="token string">&quot;The presented RememberMeAuthenticationToken does not contain the expected key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果传来的authentication是RememberMeAuthenticationToken就支持</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230104211344976.png" alt="image-20230104211344976" tabindex="0" loading="lazy"><figcaption>image-20230104211344976</figcaption></figure><h2 id="abstractremembermeservices" tabindex="-1"><a class="header-anchor" href="#abstractremembermeservices" aria-hidden="true">#</a> AbstractRememberMeServices</h2><p><code>AbstractRememberMeServices</code>抽象类实现了<code>RememberMeServices</code>接口，<code>AbstractRememberMeServices</code>抽象类的实现类有两个，分别是<code>PersistentTokenBasedRememberMeServices</code>（持久化的）和<code>TokenBasedRememberMeServices</code> （非持久化的）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRememberMeServices</span>
      <span class="token keyword">implements</span> <span class="token class-name">RememberMeServices</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">LogoutHandler</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_REMEMBER_ME_COOKIE_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;remember-me&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_PARAMETER</span> <span class="token operator">=</span> <span class="token string">&quot;remember-me&quot;</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TWO_WEEKS_S</span> <span class="token operator">=</span> <span class="token number">1209600</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELIMITER</span> <span class="token operator">=</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">UserDetailsChecker</span> userDetailsChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountStatusUserDetailsChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Authentication</span> <span class="token function">autoLogin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取key为remember-me的cookie</span>
      <span class="token class-name">String</span> rememberMeCookie <span class="token operator">=</span> <span class="token function">extractRememberMeCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果没有这个cookie直接返回null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeCookie <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me cookie detected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeCookie<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie was empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 删除key为remember-me的cookie</span>
         <span class="token comment">// 将key为remember-me的cookie的值设为null,并设置maxAge为0（设置maxAge表示删除这个cookie）</span>
         <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 解码为BASE64编码</span>
         <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens <span class="token operator">=</span> <span class="token function">decodeCookie</span><span class="token punctuation">(</span>rememberMeCookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 处理自动登录的cookie（最重要的方法，该方法为抽象方法，留给子类去实现）</span>
         <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 检查用户状态 （登陆过期、已停用 等状态）</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsChecker<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me cookie accepted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 创建成功的认证</span>
         <span class="token keyword">return</span> <span class="token function">createSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CookieTheftException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me login was valid but corresponding user not found.&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidCookieException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid remember-me cookie: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccountStatusException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid UserDetails: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RememberMeAuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 获取key为remember-me的cookie</span>
   <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">extractRememberMeCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cookies <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cookies<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 获取key为remember-me的cookie</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  
   <span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createSuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// RememberMeAuthenticationToken的构造方法里只要将将用户的权限传进去，则构造方法里会设置认证成功</span>
      <span class="token class-name">RememberMeAuthenticationToken</span> auth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> user<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>authoritiesMapper<span class="token punctuation">.</span><span class="token function">mapAuthorities</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      auth<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> auth<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * Decodes the cookie and splits it into a set of token strings using the &quot;:&quot; delimiter.
    * <span class="token keyword">@param</span> <span class="token parameter">cookieValue</span> the value obtained from the submitted cookie
    * <span class="token keyword">@return</span> the array of tokens.
    * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">InvalidCookieException</span></span> if the cookie was not base64 encoded.
    */</span>
   <span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decodeCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span> cookieValue<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvalidCookieException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将字符串后面缺少的&quot;=&quot;补齐，使其能被4整除 (2的4次方等于64)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cookieValue<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         cookieValue <span class="token operator">=</span> cookieValue <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span> cookieAsPlainText<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 将cookieValue使用Base64编码进行解码</span>
         cookieAsPlainText <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>cookieValue<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token was not Base64 encoded; value was &#39;&quot;</span> <span class="token operator">+</span> cookieValue <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 将解码后的字符串使用:（冒号）做分隔符，分割成字符串数组</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">delimitedListToStringArray</span><span class="token punctuation">(</span>cookieAsPlainText<span class="token punctuation">,</span> <span class="token constant">DELIMITER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tokens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将分割后的字符串数组里的每一项使用URL解码工具解码</span>
            tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> tokens<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  
   <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">UserDetails</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RememberMeAuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>


   <span class="token comment">// 删除key为remember-me的cookie</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">cancelCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cancelling cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将key为remember-me的cookie的值设为null</span>
      <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置maxAge为0（设置maxAge表示删除这个cookie）</span>
      cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token function">getCookiePath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieDomain <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      cookie<span class="token punctuation">.</span><span class="token function">setSecure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>useSecureCookie <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>useSecureCookie <span class="token operator">:</span> request<span class="token punctuation">.</span><span class="token function">isSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105195802217.png" alt="image-20230105195802217" tabindex="0" loading="lazy"><figcaption>image-20230105195802217</figcaption></figure><h3 id="tokenbasedremembermeservices" tabindex="-1"><a class="header-anchor" href="#tokenbasedremembermeservices" aria-hidden="true">#</a> TokenBasedRememberMeServices</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenBasedRememberMeServices</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRememberMeServices</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// cookieTokens的长度必须为3</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cookieTokens<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span>
               <span class="token string">&quot;Cookie token did not contain 3&quot;</span> <span class="token operator">+</span> <span class="token string">&quot; tokens, but contained &#39;&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 获取token的过期时间，值为cookieTokens[1]，即数组里第二个数</span>
      <span class="token keyword">long</span> tokenExpiryTime <span class="token operator">=</span> <span class="token function">getTokenExpiryTime</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 判断是否过期（过期时间小于当前系统时间），过期了就抛出异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTokenExpired</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token[1] has expired (expired on &#39;&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">)</span>
               <span class="token operator">+</span> <span class="token string">&quot;&#39;; current time is &#39;&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Check the user exists. Defer lookup until after expiry time checked, to</span>
      <span class="token comment">// possibly avoid expensive database call.</span>
      <span class="token comment">// cookieTokens[0]为用户名，根据用户名获取用户信息</span>
      <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;UserDetailsService &quot;</span> <span class="token operator">+</span> <span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token string">&quot; returned null for username &quot;</span> <span class="token operator">+</span> cookieTokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;. &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;This is an interface contract violation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Check signature of token matches remaining details. Must do this after user</span>
      <span class="token comment">// lookup, as we need the DAO-derived password. If efficiency was a major issue,</span>
      <span class="token comment">// just add in a UserCache implementation, but recall that this method is usually</span>
      <span class="token comment">// only called once per HttpSession - if the token is valid, it will cause</span>
      <span class="token comment">// SecurityContextHolder population, whilst if invalid, will cause the cookie to</span>
      <span class="token comment">// be cancelled.</span>
      <span class="token comment">// 构造token签名</span>
      <span class="token class-name">String</span> expectedTokenSignature <span class="token operator">=</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 判断签名是否和cookieTokens[2]的值相同</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equals</span><span class="token punctuation">(</span>expectedTokenSignature<span class="token punctuation">,</span> cookieTokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token[2] contained signature &#39;&quot;</span> <span class="token operator">+</span> cookieTokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
               <span class="token operator">+</span> <span class="token string">&quot;&#39; but expected &#39;&quot;</span> <span class="token operator">+</span> expectedTokenSignature <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 获取token的过期时间</span>
   <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getTokenExpiryTime</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> nfe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span>
               <span class="token string">&quot;Cookie token[1] did not contain a valid number (contained &#39;&quot;</span> <span class="token operator">+</span> cookieTokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * Calculates the digital signature to be put in the cookie. Default value is MD5
    * (&quot;username:tokenExpiryTime:password:key&quot;)  构造token签名
    */</span>
   <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span><span class="token keyword">long</span> tokenExpiryTime<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> data <span class="token operator">=</span> username <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> tokenExpiryTime <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> password <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// java.security.MessageDigest信息摘要类（使用MD5算法）</span>
         <span class="token class-name">MessageDigest</span> digest <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 转为16进制</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>digest<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No MD5 algorithm available!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 判断token是否过期</span>
   <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isTokenExpired</span><span class="token punctuation">(</span><span class="token keyword">long</span> tokenExpiryTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> tokenExpiryTime <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105195846642.png" alt="image-20230105195846642" tabindex="0" loading="lazy"><figcaption>image-20230105195846642</figcaption></figure><h3 id="persistenttokenbasedremembermeservices" tabindex="-1"><a class="header-anchor" href="#persistenttokenbasedremembermeservices" aria-hidden="true">#</a> PersistentTokenBasedRememberMeServices</h3><p><code>PersistentTokenBasedRememberMeServices</code>和<code>TokenBasedRememberMeServices</code>很类似，只不过<code>PersistentTokenBasedRememberMeServices</code>可以持久化，<code>TokenBasedRememberMeServices</code>不可以持久化；<code>PersistentTokenBasedRememberMeServices</code>的<code>cookieTokens</code>长度为<code>2</code>，<code>TokenBasedRememberMeServices</code>的<code>cookieTokens</code>长度为<code>3</code>。核心代码都是调用<code>UserDetailsService</code>类的<code>loadUserByUsername</code>方法，根据用户名查询<code>UserDetails</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersistentTokenBasedRememberMeServices</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRememberMeServices</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">PersistentTokenRepository</span> tokenRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryTokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cookieTokens<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token did not contain &quot;</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">&quot; tokens, but contained &#39;&quot;</span>
               <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span> presentedSeries <span class="token operator">=</span> cookieTokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> presentedToken <span class="token operator">=</span> cookieTokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token class-name">PersistentRememberMeToken</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">getTokenForSeries</span><span class="token punctuation">(</span>presentedSeries<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// No series match, so we can&#39;t authenticate using this cookie</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationException</span><span class="token punctuation">(</span><span class="token string">&quot;No persistent token found for series id: &quot;</span> <span class="token operator">+</span> presentedSeries<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// We have a match for this user/series combination</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>presentedToken<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Token doesn&#39;t match series value. Delete all logins for this user and throw</span>
         <span class="token comment">// an exception to warn them.</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">removeUserTokens</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CookieTheftException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>
               <span class="token string">&quot;PersistentTokenBasedRememberMeServices.cookieStolen&quot;</span><span class="token punctuation">,</span>
               <span class="token string">&quot;Invalid remember-me token (Series/token) mismatch. Implies previous cookie theft attack.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">getTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationException</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me login has expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Token also matches, so login is valid. Update the token value, keeping the</span>
      <span class="token comment">// *same* series number.</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Refreshing persistent login token for user &#39;%s&#39;, series &#39;%s&#39;&quot;</span><span class="token punctuation">,</span>
            token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">PersistentRememberMeToken</span> newToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersistentRememberMeToken</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">generateTokenData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">updateToken</span><span class="token punctuation">(</span>newToken<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newToken<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newToken<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">addCookie</span><span class="token punctuation">(</span>newToken<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to update token: &quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationException</span><span class="token punctuation">(</span><span class="token string">&quot;Autologin failed due to data access problem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="remembermeconfigurer" tabindex="-1"><a class="header-anchor" href="#remembermeconfigurer" aria-hidden="true">#</a> RememberMeConfigurer</h2><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105200836312.png" alt="image-20230105200836312" tabindex="0" loading="lazy"><figcaption>image-20230105200836312</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RememberMeConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RememberMeConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token function">validateInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">RememberMeServices</span> rememberMeServices <span class="token operator">=</span> <span class="token function">getRememberMeServices</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置共享对象</span>
      http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RememberMeServices</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">LogoutConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> logoutConfigurer <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">LogoutConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logoutConfigurer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logoutConfigurer<span class="token punctuation">.</span><span class="token function">addLogoutHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">RememberMeAuthenticationProvider</span> authenticationProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationProvider</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 做一些后置处理（Spring Security很多类都有这个方法）</span>
      authenticationProvider <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>authenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>authenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 添加 RememberMeAuthenticationFilter 记住我认证过滤器</span>
      <span class="token class-name">RememberMeAuthenticationFilter</span> rememberMeFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationFilter</span><span class="token punctuation">(</span>
            http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationSuccessHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         rememberMeFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      rememberMeFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>rememberMeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>rememberMeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105201515809.png" alt="image-20230105201515809" tabindex="0" loading="lazy"><figcaption>image-20230105201515809</figcaption></figure><h1 id="六-1" tabindex="-1"><a class="header-anchor" href="#六-1" aria-hidden="true">#</a> 六..</h1><h2 id="sessionmanagementfilter" tabindex="-1"><a class="header-anchor" href="#sessionmanagementfilter" aria-hidden="true">#</a> SessionManagementFilter</h2><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105202222504.png" alt="image-20230105202222504" tabindex="0" loading="lazy"><figcaption>image-20230105202222504</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionManagementFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

   <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FILTER_APPLIED</span> <span class="token operator">=</span> <span class="token string">&quot;__spring_security_session_mgmt_filter_applied&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">SessionAuthenticationStrategy</span> sessionAuthenticationStrategy<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationTrustResolver</span> trustResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationTrustResolverImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">InvalidSessionStrategy</span> invalidSessionStrategy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationFailureHandler</span> failureHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">SessionManagementFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SessionFixationProtectionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">SessionManagementFilter</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span> securityContextRepository<span class="token punctuation">,</span>
         <span class="token class-name">SessionAuthenticationStrategy</span> sessionStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">,</span> <span class="token string">&quot;SecurityContextRepository cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>sessionStrategy<span class="token punctuation">,</span> <span class="token string">&quot;SessionAuthenticationStrategy cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository <span class="token operator">=</span> securityContextRepository<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sessionAuthenticationStrategy <span class="token operator">=</span> sessionStrategy<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有key为__spring_security_session_mgmt_filter_applied的session则直接放行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// SecurityContextRepository安全上下文仓库里有这个request才走下面的逻辑，否则直接放行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">containsContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// The user has been authenticated during the current request, so call the</span>
            <span class="token comment">// session strategy</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token comment">// authentication不为空且不是匿名的，才调用SessionAuthenticationStrategy会话认证策略的onAuthentication方法</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>sessionAuthenticationStrategy<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// The session strategy can reject the authentication</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;SessionAuthenticationStrategy rejected the authentication object&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 清空安全上下文</span>
               <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 失败处理器</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Eagerly save the security context to make it available for any possible</span>
            <span class="token comment">// re-entrant requests which may occur before the current request</span>
            <span class="token comment">// completes. SEC-1396.</span>
            <span class="token comment">// 如果没有抛出异常就保存上下文信息到SecurityContextRepository安全上下文仓库里</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// No security context or authentication present. Check for a session</span>
            <span class="token comment">// timeout</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isRequestedSessionIdValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Request requested invalid session id %s&quot;</span><span class="token punctuation">,</span>
                        request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>invalidSessionStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>invalidSessionStrategy<span class="token punctuation">.</span><span class="token function">onInvalidSessionDetected</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">return</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sessionauthenticationstrategy" tabindex="-1"><a class="header-anchor" href="#sessionauthenticationstrategy" aria-hidden="true">#</a> SessionAuthenticationStrategy</h2><p><code>onAuthentication</code>方法尝试认证，如果认证失败就抛<code>SessionAuthenticationException</code>异常</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * 在发生新的身份验证时执行与 Http 会话相关的功能
    * Performs Http session-related functionality when a new authentication occurs.
    * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">SessionAuthenticationException</span></span> if it is decided that the authentication is
    * not allowed for the session. This will typically be because the user has too many
    * sessions open at once.
    */</span>
   <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">SessionAuthenticationException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105203327894.png" alt="image-20230105203327894" tabindex="0" loading="lazy"><figcaption>image-20230105203327894</figcaption></figure><h3 id="registersessionauthenticationstrategy" tabindex="-1"><a class="header-anchor" href="#registersessionauthenticationstrategy" aria-hidden="true">#</a> RegisterSessionAuthenticationStrategy</h3><p><code>SessionAuthenticationStrategy</code>接口有一个实现类是<code>RegisterSessionAuthenticationStrategy</code>，该类是用于在身份验证成功后向 <code>SessionRegistry</code> 注册用户的策略类。</p><p>这个类的<code>onAuthentication</code>方法就是调用<code>SessionRegistry</code>接口的<code>registerNewSession</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterSessionAuthenticationStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SessionRegistry</span> sessionRegistry<span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * <span class="token keyword">@param</span> <span class="token parameter">sessionRegistry</span> the session registry which should be updated when the
    * authenticated session is changed.
    */</span>
   <span class="token keyword">public</span> <span class="token class-name">RegisterSessionAuthenticationStrategy</span><span class="token punctuation">(</span><span class="token class-name">SessionRegistry</span> sessionRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>sessionRegistry<span class="token punctuation">,</span> <span class="token string">&quot;The sessionRegistry cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry <span class="token operator">=</span> sessionRegistry<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * In addition to the steps from the superclass, the sessionRegistry will be updated
    * with the new session information.
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">registerNewSession</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105205209651.png" alt="image-20230105205209651" tabindex="0" loading="lazy"><figcaption>image-20230105205209651</figcaption></figure><h3 id="concurrentsessioncontrolauthenticationstrategy" tabindex="-1"><a class="header-anchor" href="#concurrentsessioncontrolauthenticationstrategy" aria-hidden="true">#</a> ConcurrentSessionControlAuthenticationStrategy</h3><p><code>SessionAuthenticationStrategy</code>接口有一个实现类叫<code>ConcurrentSessionControlAuthenticationStrategy</code>（并发会话控制认证策略），该类是用作控制并发session的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentSessionControlAuthenticationStrategy</span>
      <span class="token keyword">implements</span> <span class="token class-name">MessageSourceAware</span><span class="token punctuation">,</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

   <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SessionRegistry</span> sessionRegistry<span class="token punctuation">;</span>
   <span class="token comment">// 超出最大并发数量了是否需要抛出异常</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> exceptionIfMaximumExceeded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token comment">// 最大的会话数量</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> maximumSessions <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取这个用户最大允许有多少个session</span>
      <span class="token keyword">int</span> allowedSessions <span class="token operator">=</span> <span class="token function">getMaximumSessionsForThisUser</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedSessions <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// We permit unlimited logins</span>
         <span class="token comment">// 如果是-1，则不限制</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 从SessionRegistry里获取session信息</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">getAllSessions</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> sessionCount <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果SessionRegistry里session的数量小于允许的数量，证明还可以创建session，应该啥也不干，直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionCount <span class="token operator">&lt;</span> allowedSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// They haven&#39;t got too many login sessions running at present</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果SessionRegistry里session的数量等于允许的数量，此时不能创建session了，如果这个用户的session已经存储到SessionRegistry了则可以直接返回，但是如果这个用户的session没有存储在SessionRegistry里则意味着可能需要创建这个session，但是如果再创建session就超过最大允许的seeson数量了，此时需要处理是否允许会话数量超出</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionCount <span class="token operator">==</span> allowedSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 设置false，如果session不存在也不创建session</span>
         <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Only permit it though if this request is associated with one of the</span>
            <span class="token comment">// already registered sessions</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionInformation</span> si <span class="token operator">:</span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 判断从SessionRegistry里获取的sessions有没有sessionId等于这个请求的session的id，如果有则啥也不干，直接返回</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 如果能走到这，说明从SessionRegistry里获取的sessions没有sessionId等于这个请求的session的id，可能需要创建一个新的session，但是如果创建session则会超过允许的session数量</span>
         <span class="token comment">// If the session is null, a new one will be created by the parent class,</span>
         <span class="token comment">// exceeding the allowed number</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 是否允许会话数量超出</span>
      <span class="token function">allowableSessionsExceeded</span><span class="token punctuation">(</span>sessions<span class="token punctuation">,</span> allowedSessions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">allowableSessionsExceeded</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token keyword">int</span> allowableSessions<span class="token punctuation">,</span>
         <span class="token class-name">SessionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SessionAuthenticationException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果设置超出最大数量抛异常 或 sessions为空了就抛异常（接口契约规定sessionRegistry.getAllSessions方法不能返回null，而且如果为null了，前面sessions.size()就报空指针异常了，因此这个sessions == null的判断可以忽略）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exceptionIfMaximumExceeded <span class="token operator">||</span> <span class="token punctuation">(</span>sessions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SessionAuthenticationException</span><span class="token punctuation">(</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;ConcurrentSessionControlAuthenticationStrategy.exceededAllowed&quot;</span><span class="token punctuation">,</span>
                     <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> allowableSessions <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Maximum sessions of {0} for this principal exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Determine least recently used sessions, and mark them for invalidation</span>
      <span class="token comment">// 将这些session按照时间排个序，索引越大请求越新，将老的session删除掉，让新的session加入进来</span>
      sessions<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">SessionInformation</span><span class="token operator">::</span><span class="token function">getLastRequest</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> maximumSessionsExceededBy <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> allowableSessions <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">// 截取到老的session，将这些session失效</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessionsToBeExpired <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maximumSessionsExceededBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionInformation</span> session <span class="token operator">:</span> sessionsToBeExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 将这些老的session失效</span>
         session<span class="token punctuation">.</span><span class="token function">expireNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * Sets the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tt</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java">exceptionIfMaximumExceeded</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tt</span><span class="token punctuation">&gt;</span></span> property, which determines whether the
    * user should be prevented from opening more sessions than allowed. If set to
    * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tt</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token boolean">true</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tt</span><span class="token punctuation">&gt;</span></span>, a <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tt</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">SessionAuthenticationException</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tt</span><span class="token punctuation">&gt;</span></span> will be raised which means
    * the user authenticating will be prevented from authenticating. if set to
    * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tt</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token boolean">false</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tt</span><span class="token punctuation">&gt;</span></span>, the user that has already authenticated will be forcibly logged
    * out.
    * <span class="token keyword">@param</span> <span class="token parameter">exceptionIfMaximumExceeded</span> defaults to <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tt</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token boolean">false</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tt</span><span class="token punctuation">&gt;</span></span>.
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setExceptionIfMaximumExceeded</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> exceptionIfMaximumExceeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>exceptionIfMaximumExceeded <span class="token operator">=</span> exceptionIfMaximumExceeded<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * Sets the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tt</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java">maxSessions</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tt</span><span class="token punctuation">&gt;</span></span> property. The default value is 1. Use -1 for
    * unlimited sessions.
    * <span class="token keyword">@param</span> <span class="token parameter">maximumSessions</span> the maximimum number of permitted sessions a user can have
    * open simultaneously.
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMaximumSessions</span><span class="token punctuation">(</span><span class="token keyword">int</span> maximumSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>maximumSessions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token string">&quot;MaximumLogins must be either -1 to allow unlimited logins, or a positive integer to specify a maximum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>maximumSessions <span class="token operator">=</span> maximumSessions<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * Sets the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">MessageSource</span></span><span class="token punctuation">}</span> used for reporting errors back to the user when the
    * user has exceeded the maximum number of authentications.
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">,</span> <span class="token string">&quot;messageSource cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105213922175.png" alt="image-20230105213922175" tabindex="0" loading="lazy"><figcaption>image-20230105213922175</figcaption></figure><h3 id="compositesessionauthenticationstrategy" tabindex="-1"><a class="header-anchor" href="#compositesessionauthenticationstrategy" aria-hidden="true">#</a> CompositeSessionAuthenticationStrategy</h3><p><code>SessionAuthenticationStrategy</code>接口有一个实现类叫<code>CompositeSessionAuthenticationStrategy</code>，<code>CompositeSessionAuthenticationStrategy</code>类（组合的session认证策略）维护了一堆的<code>SessionAuthenticationStrategy</code>，比如说你即想要<code>RegisterSessionAuthenticationStrategy</code>策略又想要<code>ConcurrentSessionControlAuthenticationStrategy</code>策略捷克语使用该类。该类就是遍历<code>SessionAuthenticationStrategy</code>，调其<code>onAuthentication</code>方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositeSessionAuthenticationStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">&gt;</span></span> delegateStrategies<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">CompositeSessionAuthenticationStrategy</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">&gt;</span></span> delegateStrategies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>delegateStrategies<span class="token punctuation">,</span> <span class="token string">&quot;delegateStrategies cannot be null or empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span> strategy <span class="token operator">:</span> delegateStrategies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>strategy<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;delegateStrategies cannot contain null entires. Got &quot;</span> <span class="token operator">+</span> delegateStrategies<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies <span class="token operator">=</span> delegateStrategies<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SessionAuthenticationException</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> currentPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span> delegate <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Preparing session with %s (%d/%d)&quot;</span><span class="token punctuation">,</span>
                  delegate<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span>currentPosition<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         delegate<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; [delegateStrategies = &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105214243787.png" alt="image-20230105214243787" tabindex="0" loading="lazy"><figcaption>image-20230105214243787</figcaption></figure><h3 id="abstractsessionfixationprotectionstrategy" tabindex="-1"><a class="header-anchor" href="#abstractsessionfixationprotectionstrategy" aria-hidden="true">#</a> AbstractSessionFixationProtectionStrategy</h3><p><code>SessionAuthenticationStrategy</code>接口有一个实现类是<code>RegisterSessionAuthenticationStrategy</code>，该类为抽象类，用于防止session的固定会话攻击（即如果sessionId不变的话，容易被截取到，然后黑客使用截取的sessionId做一些非法的操作），主要通过生成一个新的sessionId来防止。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSessionFixationProtectionStrategy</span>
      <span class="token keyword">implements</span> <span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationEventPublisherAware</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
         <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> hadSessionAlready <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadSessionAlready <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>alwaysCreateSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Session fixation isn&#39;t a problem if there&#39;s no session</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Create new session if necessary</span>
      <span class="token comment">// 如果需要，创建一个新的session</span>
      <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hadSessionAlready <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">isRequestedSessionIdValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 原始sessionId</span>
         <span class="token class-name">String</span> originalSessionId<span class="token punctuation">;</span>
         <span class="token comment">// 新的sessionId</span>
         <span class="token class-name">String</span> newSessionId<span class="token punctuation">;</span>
         <span class="token class-name">Object</span> mutex <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getSessionMutex</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 锁住</span>
         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We need to migrate to a new session</span>
            <span class="token comment">// 获取原始sessionId</span>
            originalSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建一个新的session（该方法为抽象方法，留给子类去实现）</span>
            session <span class="token operator">=</span> <span class="token function">applySessionFixation</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>originalSessionId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newSessionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Your servlet container did not change the session ID when a new session &quot;</span>
                  <span class="token operator">+</span> <span class="token string">&quot;was created. You will not be adequately protected against session-fixation attacks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Changed session id from %s&quot;</span><span class="token punctuation">,</span> originalSessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token function">onSessionChange</span><span class="token punctuation">(</span>originalSessionId<span class="token punctuation">,</span> session<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105215257048.png" alt="image-20230105215257048" tabindex="0" loading="lazy"><figcaption>image-20230105215257048</figcaption></figure><h4 id="changesessionidauthenticationstrategy" tabindex="-1"><a class="header-anchor" href="#changesessionidauthenticationstrategy" aria-hidden="true">#</a> ChangeSessionIdAuthenticationStrategy</h4><p><code>AbstractSessionFixationProtectionStrategy</code>抽象类的实现类有两个，一个是<code>ChangeSessionIdAuthenticationStrategy</code>，一个是<code>SessionFixationProtectionStrategy</code>。</p><p><code>ChangeSessionIdAuthenticationStrategy</code>类的<code>applySessionFixation</code>方法非常简单，调用<code>request.changeSessionId();</code>方法改变<code>sessionId</code>（这个方法只会改变<code>sessionId</code>，不会删除<code>session</code>），然后返回<code>request.getSession();</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChangeSessionIdAuthenticationStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSessionFixationProtectionStrategy</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token class-name">HttpSession</span> <span class="token function">applySessionFixation</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span><span class="token function">changeSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105215453689.png" alt="image-20230105215453689" tabindex="0" loading="lazy"><figcaption>image-20230105215453689</figcaption></figure><h4 id="sessionfixationprotectionstrategy" tabindex="-1"><a class="header-anchor" href="#sessionfixationprotectionstrategy" aria-hidden="true">#</a> SessionFixationProtectionStrategy</h4><p><code>AbstractSessionFixationProtectionStrategy</code>抽象类的实现类有两个，一个是<code>ChangeSessionIdAuthenticationStrategy</code>，一个是<code>SessionFixationProtectionStrategy</code>。</p><p><code>SessionFixationProtectionStrategy</code>这个类的<code>applySessionFixation</code>方法稍微复杂一些，首先设置让老的<code>session</code>失效，然后创建一个新的<code>session</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">final</span> <span class="token class-name">HttpSession</span> <span class="token function">applySessionFixation</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> originalSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Invalidating session with Id &#39;&quot;</span> <span class="token operator">+</span> originalSessionId <span class="token operator">+</span> <span class="token string">&quot;&#39; &quot;</span>
         <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>migrateSessionAttributes <span class="token operator">?</span> <span class="token string">&quot;and&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;without&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; migrating attributes.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributesToMigrate <span class="token operator">=</span> <span class="token function">extractAttributes</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 获取老的session的过期时间</span>
   <span class="token keyword">int</span> maxInactiveIntervalToMigrate <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMaxInactiveInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 将老的session失效</span>
   session<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 参数设置true，如果不存在session就创建一个session</span>
   session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we now have a new session</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Started new session: %s&quot;</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">transferAttributes</span><span class="token punctuation">(</span>attributesToMigrate<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>migrateSessionAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将新的session的过期时间设置为 老的session的过期时间</span>
      session<span class="token punctuation">.</span><span class="token function">setMaxInactiveInterval</span><span class="token punctuation">(</span>maxInactiveIntervalToMigrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> session<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105215941205.png" alt="image-20230105215941205" tabindex="0" loading="lazy"><figcaption>image-20230105215941205</figcaption></figure><h2 id="sessionregistry" tabindex="-1"><a class="header-anchor" href="#sessionregistry" aria-hidden="true">#</a> SessionRegistry</h2><p>SessionRegistry： 维护<code>SessionInformation</code>实例的注册表。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SessionRegistry</span> <span class="token punctuation">{</span>

   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllPrincipals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllSessions</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includeExpiredSessions<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">SessionInformation</span> <span class="token function">getSessionInformation</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">void</span> <span class="token function">refreshLastRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token keyword">void</span> <span class="token function">registerNewSession</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">void</span> <span class="token function">removeSessionInformation</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105204623184.png" alt="image-20230105204623184" style="zoom:50%;"><p><code>SessionRegistry</code>接口只有一个实现类为<code>SessionRegistryImpl</code>，该类就是维护两个<code>ConcurrentHashMap</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionRegistryImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SessionRegistry</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractSessionEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">SessionRegistryImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// &lt;principal:Object,SessionIdSet&gt;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> principals<span class="token punctuation">;</span>

   <span class="token comment">// &lt;sessionId:Object,SessionInformation&gt;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessionIds<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">SessionRegistryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>principals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sessionIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">SessionRegistryImpl</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> principals<span class="token punctuation">,</span>
         <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessionIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>principals <span class="token operator">=</span> principals<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sessionIds <span class="token operator">=</span> sessionIds<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105204858723.png" alt="image-20230105204858723" tabindex="0" loading="lazy"><figcaption>image-20230105204858723</figcaption></figure><h2 id="concurrentsessionfilter" tabindex="-1"><a class="header-anchor" href="#concurrentsessionfilter" aria-hidden="true">#</a> ConcurrentSessionFilter</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentSessionFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 调用SessionRegistry的getSessionInformation方法，根据sessionId获取一个SessionInformation</span>
         <span class="token class-name">SessionInformation</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">getSessionInformation</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果过期了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// Expired - abort processing</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span>
                     <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Requested session ID &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; has expired.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 调用 doLogout 方法执行退出逻辑</span>
               <span class="token function">doLogout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 调用sessionInformationExpiredStrategy的onExpiredSessionDetected方法</span>
               <span class="token comment">// 这个SessionInformationExpiredStrategy接口只有一个onExpiredSessionDetected方法，有两个具体实现，ResponseBodySessionInformationExpiredStrategy响应一个文本，SimpleRedirectSessionInformationExpiredStrategy做重定向</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>sessionInformationExpiredStrategy
                     <span class="token punctuation">.</span><span class="token function">onExpiredSessionDetected</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionInformationExpiredEvent</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Non-expired - update last request date/time</span>
            <span class="token comment">// 调用SessionRegistry的refreshLastRequest方法，刷新这个SessionInformation</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">refreshLastRequest</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105220723140.png" alt="image-20230105220723140" tabindex="0" loading="lazy"><figcaption>image-20230105220723140</figcaption></figure><h2 id="sessionmanagementconfigurer" tabindex="-1"><a class="header-anchor" href="#sessionmanagementconfigurer" aria-hidden="true">#</a> SessionManagementConfigurer</h2><p><code>SessionManagementConfigurer</code>和前面的<code>xxxConfigurer</code>差不多</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105221757041.png" alt="image-20230105221757041" tabindex="0" loading="lazy"><figcaption>image-20230105221757041</figcaption></figure><p><code>init</code>方法就是做共享的</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105221945006.png" alt="image-20230105221945006" tabindex="0" loading="lazy"><figcaption>image-20230105221945006</figcaption></figure><p><code>configure</code>是用来配置过滤器的（创建了一个SimpleUrlAuthenticationFailureHandler，然后设置各种值）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230105222620672.png" alt="image-20230105222620672" tabindex="0" loading="lazy"><figcaption>image-20230105222620672</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SessionManagementConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionManagementConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> stateless <span class="token operator">=</span> <span class="token function">isStateless</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>securityContextRepository <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>stateless<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NullSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpSessionSecurityContextRepository</span> httpSecurityRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            httpSecurityRepository<span class="token punctuation">.</span><span class="token function">setDisableUrlRewriting</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableSessionUrlRewriting<span class="token punctuation">)</span><span class="token punctuation">;</span>
            httpSecurityRepository<span class="token punctuation">.</span><span class="token function">setAllowSessionCreation</span><span class="token punctuation">(</span><span class="token function">isAllowSessionCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AuthenticationTrustResolver</span> trustResolver <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationTrustResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>trustResolver <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               httpSecurityRepository<span class="token punctuation">.</span><span class="token function">setTrustResolver</span><span class="token punctuation">(</span>trustResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> httpSecurityRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">RequestCache</span> requestCache <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>stateless<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NullRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">getSessionAuthenticationStrategy</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">InvalidSessionStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">getInvalidSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 创建了一个SimpleUrlAuthenticationFailureHandler，然后设置各种值</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SessionManagementFilter</span> sessionManagementFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionManagementFilter</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">,</span>
            <span class="token function">getSessionAuthenticationStrategy</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionAuthenticationErrorUrl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         sessionManagementFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>
               <span class="token keyword">new</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionAuthenticationErrorUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">InvalidSessionStrategy</span> strategy <span class="token operator">=</span> <span class="token function">getInvalidSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         sessionManagementFilter<span class="token punctuation">.</span><span class="token function">setInvalidSessionStrategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">AuthenticationFailureHandler</span> failureHandler <span class="token operator">=</span> <span class="token function">getSessionAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>failureHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         sessionManagementFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>failureHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">AuthenticationTrustResolver</span> trustResolver <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationTrustResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>trustResolver <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         sessionManagementFilter<span class="token punctuation">.</span><span class="token function">setTrustResolver</span><span class="token punctuation">(</span>trustResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      sessionManagementFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>sessionManagementFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>sessionManagementFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isConcurrentSessionControlEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">ConcurrentSessionFilter</span> concurrentSessionFilter <span class="token operator">=</span> <span class="token function">createConcurrencyFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>

         concurrentSessionFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>concurrentSessionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
         http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>concurrentSessionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableSessionUrlRewriting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DisableEncodeUrlFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionPolicy <span class="token operator">==</span> <span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">ALWAYS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForceEagerSessionCreationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="七" tabindex="-1"><a class="header-anchor" href="#七" aria-hidden="true">#</a> 七</h1><h2 id="_1、默认配置的过滤器" tabindex="-1"><a class="header-anchor" href="#_1、默认配置的过滤器" aria-hidden="true">#</a> 1、默认配置的过滤器</h2><p>在<code>return http.build();</code>这一行上打个断点，然后以<code>debug</code>方式运行项目，断点停在该行上后，点击<code>Step Over</code>步过按钮，运行到下一行。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106203653757.png" alt="image-20230106203653757" tabindex="0" loading="lazy"><figcaption>image-20230106203653757</figcaption></figure><p>跳转到了<code>SimpleInstantiationStrategy</code>类的<code>instantiate</code>方法里。此时<code>args[0]</code> -&gt; <code>filters</code>里有13个过滤器</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106203830977.png" alt="image-20230106203830977" tabindex="0" loading="lazy"><figcaption>image-20230106203830977</figcaption></figure><h3 id="disableencodeurlfilter" tabindex="-1"><a class="header-anchor" href="#disableencodeurlfilter" aria-hidden="true">#</a> DisableEncodeUrlFilter</h3><p>该类是防止<code>sessionId</code>泄露的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Disables encoding URLs using the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">}</span> to prevent including the
 * session id in URLs which is not considered URL because the session id can be leaked in
 * things like HTTP access logs.
 * 使用 HttpServletResponse 禁用编码 URL，以防止在不被视为 URL 的 URL 中包含会话 ID，
 * 因为会话 ID 可能会在 HTTP 访问日志 等内容中泄露。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DisableEncodeUrlFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 该类只将response进行了包装（装饰器模式） Wrapper就是包装的意思</span>
      filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DisableEncodeUrlResponseWrapper</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DisableEncodeUrlResponseWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletResponseWrapper</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token comment">//直接让将session编码到url里的类的功能失效（覆盖了将session编码到url里的类的encodeURL，不让其将seesion编码到url里）</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encodeURL</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> url<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106205324407.png" alt="image-20230106205324407" tabindex="0" loading="lazy"><figcaption>image-20230106205324407</figcaption></figure><h3 id="webasyncmanagerintegrationfilter" tabindex="-1"><a class="header-anchor" href="#webasyncmanagerintegrationfilter" aria-hidden="true">#</a> WebAsyncManagerIntegrationFilter</h3><p>默认执行方法是同步的，访问的策略是<code>ThreadLocalSecurityContextHolderStrategy</code>，即同一个线程共享<code>SecurityContext</code>信息。如果开启异步后，访问方法是会再开一个线程，这样线程之间就不能共享<code>SecurityContext</code>信息了。该类就是解决这个问题，本质就是通过过滤器将老的线程的<code>SecurityContext</code>信息设置到新开的线程里。</p><p><code>WebAsyncManagerIntegrationFilter</code>注册了一个<code>SecurityContextCallableProcessingInterceptor</code>拦截器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WebAsyncManagerIntegrationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token constant">CALLABLE_INTERCEPTOR_KEY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">WebAsyncManager</span> asyncManager <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SecurityContextCallableProcessingInterceptor</span> securityProcessingInterceptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">)</span> asyncManager
            <span class="token punctuation">.</span><span class="token function">getCallableInterceptor</span><span class="token punctuation">(</span><span class="token constant">CALLABLE_INTERCEPTOR_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>securityProcessingInterceptor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         asyncManager<span class="token punctuation">.</span><span class="token function">registerCallableInterceptor</span><span class="token punctuation">(</span><span class="token constant">CALLABLE_INTERCEPTOR_KEY</span><span class="token punctuation">,</span>
               <span class="token keyword">new</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106210209845.png" alt="image-20230106210209845" tabindex="0" loading="lazy"><figcaption>image-20230106210209845</figcaption></figure><p>该<code>SecurityContextCallableProcessingInterceptor</code>拦截器在目标方法执行之前将维护的<code>SecurityContext</code>设置到新开的线程中了，在目标执行之后将新开的那个线程的<code>SecurityContext</code>删除掉。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">CallableProcessingInterceptorAdapter</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">preProcess</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">,</span> <span class="token class-name">Object</span> concurrentResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setSecurityContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>securityContext <span class="token operator">=</span> securityContext<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106210542362.png" alt="image-20230106210542362" tabindex="0" loading="lazy"><figcaption>image-20230106210542362</figcaption></figure><h3 id="headerwriterfilter" tabindex="-1"><a class="header-anchor" href="#headerwriterfilter" aria-hidden="true">#</a> HeaderWriterFilter</h3><p>顾名思义，就是向<code>Header</code>写东西的，该类维护了一个<code>HeaderWriter</code>列表</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderWriterFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token class-name">HeaderWriterFilter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>headerWriters<span class="token punctuation">,</span> <span class="token string">&quot;headerWriters cannot be null or empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>headerWriters <span class="token operator">=</span> headerWriters<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shouldWriteHeadersEagerly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">doHeadersBefore</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token function">doHeadersAfter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106211904977.png" alt="image-20230106211904977" tabindex="0" loading="lazy"><figcaption>image-20230106211904977</figcaption></figure><p>以前最常听到的<code>HeaderWriter</code>是<code>XFrameOptionsHeaderWriter</code>，默认情况下使用<code>Spring Security</code>后，会禁止使用<code>&lt;iframe&gt;</code>标签，该标签是用来嵌套<code>html</code>页面的（以前用的比较多，现在基本不用了），可以配置<code>headers().frameOptions().disable()</code>将这个<code>XFrameOptionsHeaderWriter</code>禁用掉就可以使用<code>&lt;iframe&gt;</code>标签了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106211934452.png" alt="image-20230106211934452" tabindex="0" loading="lazy"><figcaption>image-20230106211934452</figcaption></figure><h3 id="csrffilter" tabindex="-1"><a class="header-anchor" href="#csrffilter" aria-hidden="true">#</a> CsrfFilter</h3><p><code>CsrfFilter</code>是做防止跨站脚本攻击的，其默认使用<code>HttpSession</code>存储，使用模板引擎时可以直接拿到<code>session</code>里的数据，然后在表单里设置个隐藏的<code>name</code>，值为<code>token</code>，提交表单时会带上这个<code>token</code>，然后与存储的<code>token</code>做比较。前后端分离后<code>CsrfFilter</code>就很少使用了。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CsrfFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">CsrfToken</span> csrfToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">loadToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> missingToken <span class="token operator">=</span> <span class="token punctuation">(</span>csrfToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>missingToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         csrfToken <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>tokenRepository<span class="token punctuation">.</span><span class="token function">saveToken</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">CsrfToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getParameterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requireCsrfProtectionMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Did not protect against CSRF since request did not match &quot;</span>
                  <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requireCsrfProtectionMatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span> actualToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getHeaderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>actualToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         actualToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getParameterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equalsConstantTime</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actualToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
               <span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Invalid CSRF token found for &quot;</span> <span class="token operator">+</span> <span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">buildFullRequestUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">AccessDeniedException</span> exception <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>missingToken<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCsrfTokenException</span><span class="token punctuation">(</span>csrfToken<span class="token punctuation">,</span> actualToken<span class="token punctuation">)</span>
               <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MissingCsrfTokenException</span><span class="token punctuation">(</span>actualToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">skipRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">SHOULD_NOT_FILTER</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106212933296.png" alt="image-20230106212933296" tabindex="0" loading="lazy"><figcaption>image-20230106212933296</figcaption></figure><h3 id="logoutfilter" tabindex="-1"><a class="header-anchor" href="#logoutfilter" aria-hidden="true">#</a> LogoutFilter</h3><p>退出登录的过滤器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogoutFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> logoutRequestMatcher<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LogoutHandler</span> handler<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LogoutSuccessHandler</span> logoutSuccessHandler<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">requiresLogout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Logging out [%s]&quot;</span><span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 执行退出登录的逻辑</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 退出登录成功后的处理（比如返回一个退出登录成功的json）</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logoutSuccessHandler<span class="token punctuation">.</span><span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106213207654.png" alt="image-20230106213207654" tabindex="0" loading="lazy"><figcaption>image-20230106213207654</figcaption></figure><h3 id="requestcacheawarefilter" tabindex="-1"><a class="header-anchor" href="#requestcacheawarefilter" aria-hidden="true">#</a> RequestCacheAwareFilter</h3><p>该类的功能是没有登陆了跳转到登录页，登陆成功后访问最开的那个请求的，现在前后端分离的项目用不到了。该类主要就是将请求的所有信息保存起来，登录成功后在复原登录之前访问的那个请求。（最常使用的<code>RequestCache</code>接口的实现类还是<code>HttpSessionRequestCache</code>）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestCacheAwareFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">RequestCacheAwareFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">RequestCacheAwareFilter</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requestCache<span class="token punctuation">,</span> <span class="token string">&quot;requestCache cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache <span class="token operator">=</span> requestCache<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token class-name">HttpServletRequest</span> wrappedSavedRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache<span class="token punctuation">.</span><span class="token function">getMatchingRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>wrappedSavedRequest <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> wrappedSavedRequest <span class="token operator">:</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106214056361.png" alt="image-20230106214056361" tabindex="0" loading="lazy"><figcaption>image-20230106214056361</figcaption></figure><h3 id="securitycontextholderawarerequestfilter" tabindex="-1"><a class="header-anchor" href="#securitycontextholderawarerequestfilter" aria-hidden="true">#</a> SecurityContextHolderAwareRequestFilter</h3><p><code>xxxAware</code>就是用来感知<code>xxx</code>的，比如说<code>ApplicationContextAware</code>就是用来感知<code>ApplicationContext</code>的，同理<code>SecurityContextHolderAwareRequestFilter</code>就是用来感知<code>SecurityContextHolder</code>的（<code>aware</code>是<code>意识到</code>、<code>注意到</code>、<code>察觉</code>的意思）</p><p>该类就将<code>req</code>换了一下，覆盖了标准的<code>javax.servlet.http.HttpServletRequestWrapper</code>类的一些方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextHolderAwareRequestFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> rolePrefix <span class="token operator">=</span> <span class="token string">&quot;ROLE_&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">HttpServletRequestFactory</span> requestFactory<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106215326500.png" alt="image-20230106215326500" tabindex="0" loading="lazy"><figcaption>image-20230106215326500</figcaption></figure><p><code>HttpServletRequestFactory</code>接口只有一个<code>create</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">HttpServletRequestFactory</span> <span class="token punctuation">{</span>

   <span class="token class-name">HttpServletRequest</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106215430310.png" alt="image-20230106215430310" tabindex="0" loading="lazy"><figcaption>image-20230106215430310</figcaption></figure><p><code>HttpServletRequestFactory</code>接口只有一个实现类为<code>HttpServlet3RequestFactory</code>，<code>HttpServlet3RequestFactory</code>类的<code>create</code>方法创建了一个<code>Servlet3SecurityContextHolderAwareRequestWrapper</code>对象。（<code>Wrapper</code>是包装的意思，看到<code>Wrapper</code>就知道这个类使用的是装饰器模式）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HttpServlet3RequestFactory</span> <span class="token keyword">implements</span> <span class="token class-name">HttpServletRequestFactory</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">HttpServletRequest</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Servlet3SecurityContextHolderAwareRequestWrapper</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Servlet3SecurityContextHolderAwareRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityContextHolderAwareRequestWrapper</span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">;</span>

      <span class="token class-name">Servlet3SecurityContextHolderAwareRequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> rolePrefix<span class="token punctuation">,</span>
            <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">HttpServlet3RequestFactory</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver<span class="token punctuation">,</span> rolePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextAsyncContext</span> <span class="token keyword">implements</span> <span class="token class-name">AsyncContext</span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AsyncContext</span> asyncContext<span class="token punctuation">;</span>

      <span class="token class-name">SecurityContextAsyncContext</span><span class="token punctuation">(</span><span class="token class-name">AsyncContext</span> asyncContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>asyncContext <span class="token operator">=</span> asyncContext<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106215826624.png" alt="image-20230106215826624" tabindex="0" loading="lazy"><figcaption>image-20230106215826624</figcaption></figure><p><code>Servlet3SecurityContextHolderAwareRequestWrapper</code>类继承自<code>SecurityContextHolderAwareRequestWrapper</code>，<code>SecurityContextHolderAwareRequestWrapper</code>覆盖了<code>HttpServletRequestWrapper</code>类的<code>getRemoteUser</code>和<code>getUserPrincipal</code>方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextHolderAwareRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token doc-comment comment">/**
    * Returns the principal&#39;s name, as obtained from the
    * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">SecurityContextHolder</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>. Properly handles both <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">String</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>-based
    * and <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">UserDetails</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>-based principals.
    * <span class="token keyword">@return</span> the username or <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> if unavailable
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRemoteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>auth <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">UserDetails</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span><span class="token punctuation">)</span> auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token keyword">instanceof</span> <span class="token class-name">AbstractAuthenticationToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> auth<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token doc-comment comment">/**
    * Returns the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">Authentication</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> (which is a subclass of
    * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">Principal</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>), or <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> if unavailable.
    * <span class="token keyword">@return</span> the <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">Authentication</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>, or <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>
    */</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Principal</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>auth <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> auth<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106220647335.png" alt="image-20230106220647335" tabindex="0" loading="lazy"><figcaption>image-20230106220647335</figcaption></figure><p>而<code>HttpServletRequestWrapper</code>类为<code>java</code>原生的类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">ServletRequestWrapper</span> <span class="token keyword">implements</span>
        <span class="token class-name">HttpServletRequest</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token doc-comment comment">/**
     * The default behavior of this method is to return getRemoteUser() on the
     * wrapped request object.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRemoteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getHttpServletRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token doc-comment comment">/**
     * The default behavior of this method is to return getUserPrincipal() on
     * the wrapped request object.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>Principal</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getHttpServletRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106221005384.png" alt="image-20230106221005384" tabindex="0" loading="lazy"><figcaption>image-20230106221005384</figcaption></figure><h3 id="anonymousauthenticationfilter" tabindex="-1"><a class="header-anchor" href="#anonymousauthenticationfilter" aria-hidden="true">#</a> AnonymousAuthenticationFilter</h3><p>匿名的认证过滤器，如果没有权限就创建一个匿名的AuthenticationToken（如果用户没有登录，他就是匿名的；如果登录了又分为两种，一种是认证的，一种是完全认证的，通过记住我登录的是认证的，而通过用户名密码登录的是完全认证的）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnonymousAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">// 这个类只会处理SecurityContextHolder.getContext().getAuthentication()为null的情况</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果SecurityContextHolder.getContext().getAuthentication()为null，就创建一个Authentication</span>
         <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token function">createAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 创建一个空的SecurityContext</span>
         <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 设置SecurityContext的权限</span>
         context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 设置SecurityContext到SecurityContextHolder里</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Set SecurityContextHolder to &quot;</span>
                  <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to anonymous SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Did not set SecurityContextHolder since already authenticated &quot;</span>
                  <span class="token operator">+</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建一个匿名的AuthenticationToken</span>
      <span class="token class-name">AnonymousAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnonymousAuthenticationToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
      token<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> token<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230106222610599.png" alt="image-20230106222610599" tabindex="0" loading="lazy"><figcaption>image-20230106222610599</figcaption></figure><h3 id="exceptiontranslationfilter" tabindex="-1"><a class="header-anchor" href="#exceptiontranslationfilter" aria-hidden="true">#</a> ExceptionTranslationFilter</h3><p>转换异常的过滤器，该类先执行<code>chain.doFilter(request, response);</code>，如果抛出异常了就进行处理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionTranslationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">AccessDeniedHandler</span> accessDeniedHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedHandlerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationEntryPoint</span> authenticationEntryPoint<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationTrustResolver</span> authenticationTrustResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationTrustResolverImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">ThrowableAnalyzer</span> throwableAnalyzer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultThrowableAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">RequestCache</span> requestCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 先放行，如果出现了异常就处理</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果是IO异常，直接抛出</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Try to extract a SpringSecurityException from the stacktrace</span>
         <span class="token comment">// 尝试从堆栈跟踪中提取 SpringSecurityException</span>
         <span class="token class-name">Throwable</span><span class="token punctuation">[</span><span class="token punctuation">]</span> causeChain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer<span class="token punctuation">.</span><span class="token function">determineCauseChain</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 拿到第一个AuthenticationException异常</span>
         <span class="token class-name">RuntimeException</span> securityException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer
               <span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>securityException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果没有AuthenticationException异常就尝试拿AccessDeniedException异常</span>
            securityException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer
                  <span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>securityException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果这两个异常都没有就重新抛出（这个类只处理AuthenticationException异常和AccessDeniedException异常）</span>
            <span class="token function">rethrow</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to handle the Spring Security Exception &quot;</span>
                  <span class="token operator">+</span> <span class="token string">&quot;because the response is already committed.&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> securityException<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 处理不了的异常重新抛出</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rethrow</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token comment">// Rethrow ServletExceptions and RuntimeExceptions as-is</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">ServletException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">ServletException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Wrap other Exceptions. This shouldn&#39;t actually happen</span>
      <span class="token comment">// as we&#39;ve already covered all the possibilities for doFilter</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">// 处理AuthenticationException异常和AccessDeniedException异常</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
         <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果是AuthenticationException异常就执行handleAuthenticationException方法</span>
         <span class="token function">handleAuthenticationException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果是AccessDeniedException异常就执行handleAccessDeniedException方法</span>
         <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token comment">// 处理认证异常</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAuthenticationException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
         <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Sending to authentication entry point since authentication failed&quot;</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 重新认证</span>
      <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 处理权限拒绝异常</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
         <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> isAnonymous <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isAnonymous <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isRememberMe</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果是匿名的（未登录的）和记住我登录的，重新认证</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Sending %s to authentication entry point since access is denied&quot;</span><span class="token punctuation">,</span>
                  authentication<span class="token punctuation">)</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span>
               <span class="token keyword">new</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">(</span>
                     <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;ExceptionTranslationFilter.insufficientAuthentication&quot;</span><span class="token punctuation">,</span>
                           <span class="token string">&quot;Full authentication is required to access this resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// 否则就调用权限拒绝的处理器</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span>
                  <span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Sending %s to access denied handler since access is denied&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 发送重新认证</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
         <span class="token class-name">AuthenticationException</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token comment">// SEC-112: Clear the SecurityContextHolder&#39;s Authentication, as the</span>
      <span class="token comment">// existing Authentication is no longer considered valid</span>
      <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 先将想要访问的请i去保存起来，登录成功后在复原登录之前访问的那个请求(RequestCacheAwareFilter类里说过)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache<span class="token punctuation">.</span><span class="token function">saveRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 认证端点（访问的入口） 返回json或重定向到登录页</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">commence</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230107102203033.png" alt="image-20230107102203033" tabindex="0" loading="lazy"><figcaption>image-20230107102203033</figcaption></figure><p><code>ThrowableAnalyzer</code>类相当于是个管理者，里面的<code>extractorMap</code>维护了一堆的<code>ThrowableCauseExtractor</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThrowableAnalyzer</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ThrowableCauseExtractor</span><span class="token punctuation">&gt;</span></span> extractorMap<span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * Creates a new <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">ThrowableAnalyzer</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> instance.
    */</span>
   <span class="token keyword">public</span> <span class="token class-name">ThrowableAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>extractorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">CLASS_HIERARCHY_COMPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">initExtractorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230107104742234.png" alt="image-20230107104742234" tabindex="0" loading="lazy"><figcaption>image-20230107104742234</figcaption></figure><h2 id="_2、加载过程" tabindex="-1"><a class="header-anchor" href="#_2、加载过程" aria-hidden="true">#</a> 2、加载过程</h2><p>这一整条链到底如何装配起来了，HttpSecurity到底做 了什么? SpringSecurity 顶层流程: <strong>DelegatingFilterProxy -&gt; FilterChainProxy -&gt; SecurityFilterChain -&gt;具体的Filter</strong> HttpSecurityConfiguration配置了基础的HttpSecurity 对象以供我们注入使用 WebSecurityConfiguration注入了我们自己的SecurityFilterChain Bean然后 添加到WebSecurity中 最终由WebSecurity 构建出FilterChainProxy 来执行SpringSecurity的过滤逻辑</p><h3 id="httpsecurityconfiguration" tabindex="-1"><a class="header-anchor" href="#httpsecurityconfiguration" aria-hidden="true">#</a> HttpSecurityConfiguration</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">HttpSecurityConfiguration</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BEAN_NAME_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;org.springframework.security.config.annotation.web.configuration.HttpSecurityConfiguration.&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HTTPSECURITY_BEAN_NAME</span> <span class="token operator">=</span> <span class="token constant">BEAN_NAME_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;httpSecurity&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationConfiguration</span> authenticationConfiguration<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> context<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">void</span> <span class="token function">setObjectPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor <span class="token operator">=</span> objectPostProcessor<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">void</span> <span class="token function">setAuthenticationConfiguration</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationConfiguration</span> authenticationConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationConfiguration <span class="token operator">=</span> authenticationConfiguration<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 创建多例的HttpSecurity（@Scope(&quot;prototype&quot;)表示多例的，即容器中可以配置多个HttpSecurity）</span>
   <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">HTTPSECURITY_BEAN_NAME</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">&quot;prototype&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">HttpSecurity</span> <span class="token function">httpSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token class-name">WebSecurityConfigurerAdapter<span class="token punctuation">.</span>LazyPasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSecurityConfigurerAdapter<span class="token punctuation">.</span>LazyPasswordEncoder</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">AuthenticationManagerBuilder</span> authenticationBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSecurityConfigurerAdapter<span class="token punctuation">.</span>DefaultPasswordEncoderAuthenticationManagerBuilder</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      authenticationBuilder<span class="token punctuation">.</span><span class="token function">parentAuthenticationManager</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      authenticationBuilder<span class="token punctuation">.</span><span class="token function">authenticationEventPublisher</span><span class="token punctuation">(</span><span class="token function">getAuthenticationEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">HttpSecurity</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSecurity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">,</span> authenticationBuilder<span class="token punctuation">,</span> <span class="token function">createSharedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// @formatter:off</span>
      http
         <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAsyncManagerIntegrationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">securityContext</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">requestCache</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">servletApi</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultLoginPageConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// @formatter:on</span>
      <span class="token comment">// 加载spring.factory文件里配置的key为AbstractHttpConfigurer的所有类</span>
      <span class="token function">applyDefaultConfigurers</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> http<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager
            <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationConfiguration<span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthenticationEventPublisher</span> <span class="token function">getAuthenticationEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationEventPublisher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationEventPublisher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultAuthenticationEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyDefaultConfigurers</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 加载spring.factory文件里配置的key为AbstractHttpConfigurer的所有类</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractHttpConfigurer</span><span class="token punctuation">&gt;</span></span> defaultHttpConfigurers <span class="token operator">=</span> <span class="token class-name">SpringFactoriesLoader</span>
            <span class="token punctuation">.</span><span class="token function">loadFactories</span><span class="token punctuation">(</span><span class="token class-name">AbstractHttpConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractHttpConfigurer</span> configurer <span class="token operator">:</span> defaultHttpConfigurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 挨个调用apply方法</span>
         http<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">createSharedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sharedObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sharedObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> sharedObjects<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230107105844021.png" alt="image-20230107105844021" tabindex="0" loading="lazy"><figcaption>image-20230107105844021</figcaption></figure><p>那这些配置在哪用到呢？</p><h3 id="websecurityconfiguration" tabindex="-1"><a class="header-anchor" href="#websecurityconfiguration" aria-hidden="true">#</a> WebSecurityConfiguration</h3><p>在<code>WebSecurityConfiguration</code>类的<code>springSecurityFilterChain</code>方法里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ImportAware</span><span class="token punctuation">,</span> <span class="token class-name">BeanClassLoaderAware</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">WebSecurity</span> webSecurity<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">Boolean</span> debugEnabled<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">,</span> <span class="token class-name">WebSecurity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> webSecurityConfigurers<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChains <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSecurityCustomizer</span><span class="token punctuation">&gt;</span></span> webSecurityCustomizers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">// Bean的名字叫springSecurityFilterChain</span>
   <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">AbstractSecurityWebApplicationInitializer</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_FILTER_NAME</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">Filter</span> <span class="token function">springSecurityFilterChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> hasConfigurers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurityConfigurers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>webSecurityConfigurers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> hasFilterChain <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChains<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>hasConfigurers <span class="token operator">&amp;&amp;</span> hasFilterChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Found WebSecurityConfigurerAdapter as well as SecurityFilterChain. Please select just one.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasConfigurers <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasFilterChain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">WebSecurityConfigurerAdapter</span> adapter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>objectObjectPostProcessor
               <span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">addSecurityFilterChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Filter</span> filter <span class="token operator">:</span> securityFilterChain<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter <span class="token keyword">instanceof</span> <span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">securityInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WebSecurityCustomizer</span> customizer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurityCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         customizer<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230107110542168.png" alt="image-20230107110542168" tabindex="0" loading="lazy"><figcaption>image-20230107110542168</figcaption></figure><p>这些<code>Filter</code>又在哪用到呢？</p><h3 id="delegatingfilterproxy" tabindex="-1"><a class="header-anchor" href="#delegatingfilterproxy" aria-hidden="true">#</a> DelegatingFilterProxy</h3><p>在<code>org.springframework.web.filter.DelegatingFilterProxy</code>类的<code>doFilter</code>方法里（该类是<code>web</code>模块的）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelegatingFilterProxy</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> contextAttribute<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">WebApplicationContext</span> webApplicationContext<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> targetBeanName<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> targetFilterLifecycle <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Filter</span> delegate<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

      <span class="token comment">// Lazily initialize the delegate if necessary.</span>
      <span class="token class-name">Filter</span> delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
      <span class="token comment">// 双检锁</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">WebApplicationContext</span> wac <span class="token operator">=</span> <span class="token function">findWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>wac <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No WebApplicationContext found: &quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;no ContextLoaderListener or DispatcherServlet registered?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token comment">// 初始化</span>
               delegateToUse <span class="token operator">=</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span>wac<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegateToUse<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Let the delegate perform the actual doFilter operation.</span>
      <span class="token function">invokeDelegate</span><span class="token punctuation">(</span>delegateToUse<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Nullable</span>
   <span class="token keyword">protected</span> <span class="token class-name">WebApplicationContext</span> <span class="token function">findWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// The user has injected a context at construction time -&gt; use it...</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationContext <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConfigurableApplicationContext</span> cac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationContext<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cac<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// The context has not yet been refreshed -&gt; do so before returning it...</span>
               cac<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationContext<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span> attrName <span class="token operator">=</span> <span class="token function">getContextAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>attrName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token class-name">WebApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">getWebApplicationContext</span><span class="token punctuation">(</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attrName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token class-name">WebApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">findWebApplicationContext</span><span class="token punctuation">(</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span> wac<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> targetBeanName <span class="token operator">=</span> <span class="token function">getTargetBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>targetBeanName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No target bean name set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取Bean的名字为springSecurityFilterChain的过滤器（就是上面的过滤器）</span>
      <span class="token class-name">Filter</span> delegate <span class="token operator">=</span> wac<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>targetBeanName<span class="token punctuation">,</span> <span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTargetFilterLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 调用其init方法</span>
         delegate<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token function">getFilterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> delegate<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230107111656995.png" alt="image-20230107111656995" tabindex="0" loading="lazy"><figcaption>image-20230107111656995</figcaption></figure><h1 id="授权" tabindex="-1"><a class="header-anchor" href="#授权" aria-hidden="true">#</a> 授权</h1><h1 id="authorizehttprequestsconfigurer" tabindex="-1"><a class="header-anchor" href="#authorizehttprequestsconfigurer" aria-hidden="true">#</a> AuthorizeHttpRequestsConfigurer</h1><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113211130577.png" alt="image-20230113211130577" tabindex="0" loading="lazy"><figcaption>image-20230113211130577</figcaption></figure><h2 id="authorizationfilter" tabindex="-1"><a class="header-anchor" href="#authorizationfilter" aria-hidden="true">#</a> AuthorizationFilter</h2><p>AuthorizationManager：授权过滤器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">&gt;</span></span> authorizationManager<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthorizationEventPublisher</span> eventPublisher <span class="token operator">=</span> <span class="token class-name">AuthorizationFilter</span><span class="token operator">::</span><span class="token function">noPublish</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

      <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>
      <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> servletResponse<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>observeOncePerRequest <span class="token operator">&amp;&amp;</span> <span class="token function">isApplied</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skipDispatch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token class-name">String</span> alreadyFilteredAttributeName <span class="token operator">=</span> <span class="token function">getAlreadyFilteredAttributeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>alreadyFilteredAttributeName<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 授权决策 （第一个参数传递本类getAuthentication方法的返回值Authentication）</span>
         <span class="token class-name">AuthorizationDecision</span> decision <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authorizationManager<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getAuthentication</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 发布事件</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishAuthorizationEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getAuthentication</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> decision<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 如果授权决策不为null，且没有派发权限 (Granted是动词，派发权限) 就抛出权限拒绝异常</span>
         <span class="token comment">// decision为null证明不需要授权，decision.isGranted()为true表明该用户已yong&#39;yo</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>decision <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>decision<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string">&quot;Access Denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>alreadyFilteredAttributeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token class-name">Authentication</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationCredentialsNotFoundException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;An Authentication object was not found in the SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110210423380.png" alt="image-20230110210423380" tabindex="0" loading="lazy"><figcaption>image-20230110210423380</figcaption></figure><h2 id="authorizationmanager" tabindex="-1"><a class="header-anchor" href="#authorizationmanager" aria-hidden="true">#</a> AuthorizationManager</h2><p>AuthorizationManager：一个授权管理器，它可以确定一个认证是否可以访问特定对象。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * An Authorization manager which can determine if an <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Authentication</span></span><span class="token punctuation">}</span> has access to
 * a specific object.
 * 一个授权管理器，它可以确定一个认证是否可以访问特定对象。
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> the type of object that the authorization check is being done one.
 * 泛型<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span>就是授权检查能否访问的那个特定对象
 * <span class="token keyword">@author</span> Evgeniy Cheban
 */</span>
<span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用check方法进行校验，如果授权决策不为null，且没有派发权限 (Granted是动词，派发权限) 就抛出权限拒绝异常</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">,</span> <span class="token class-name">T</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">AuthorizationDecision</span> decision <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>decision <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>decision<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string">&quot;Access Denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token doc-comment comment">/**
	 * Supplier是java8新增的函数式接口，他是一个提供器，通过其get()方法可以获得该泛型对象，即Authentication
	 * AuthorizationFilter类的doFilter方法里使用的this.authorizationManager.check(this::getAuthentication, request); 里this::getAuthentication返回的就是AuthorizationFilter
	 */</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token class-name">AuthorizationDecision</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">,</span> <span class="token class-name">T</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110210632947.png" alt="image-20230110210632947" tabindex="0" loading="lazy"><figcaption>image-20230110210632947</figcaption></figure><p><strong>Supplier接口</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Gets a result.
     *
     * <span class="token keyword">@return</span> a result
     */</span>
    <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110213645851.png" alt="image-20230110213645851" tabindex="0" loading="lazy"><figcaption>image-20230110213645851</figcaption></figure><blockquote><p><a href="https://blog.csdn.net/SVDJASFHIAU/article/details/125238970" target="_blank" rel="noopener noreferrer">Supplier应用场景<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>Supplier可以返回一个对象的接口; 但实际Supplier和Functin一样有实现回调的功能,基于此特性可以实现类似设计模式中的装饰模式;可以在开发中对一些功能一致的操作进行封装 例子: 演示 回调场景,基于此可以实现很多功能,例如 mq的消费幂等,分布式锁等等 抽象类：做一些通用的逻辑</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>qdone<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span>
 
 
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Supplier</span></span><span class="token punctuation">;</span>
 
<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> ：xiangyuan.zhou
 * <span class="token keyword">@date</span> ：Created at 2022年06月09日 10:43
 * <span class="token keyword">@description</span>：当A2执行时
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">A1</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">idempotentMessageBody</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgKey<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//对消息体进行md5加密做为key, 放入redis, 有效时间暂定60s, 重复消息抛弃并告警</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获得锁&quot;</span><span class="token operator">+</span> msgKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token comment">//开始执行A2的printString()方法,  就可以在前后进行一些修饰</span>
        supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类：实现特殊的业务</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>qdone<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span>
 
<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> ：xiangyuan.zhou
 * <span class="token keyword">@date</span> ：Created at 2022年06月09日 10:44
 * <span class="token keyword">@description</span>：
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A2</span> <span class="token keyword">extends</span> <span class="token class-name">A1</span><span class="token punctuation">{</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token string">&quot;hugo&quot;</span><span class="token punctuation">;</span>
        <span class="token function">idempotentMessageBody</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span> <span class="token function">printString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
 
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">printString</span><span class="token punctuation">(</span><span class="token class-name">String</span> aaa<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;printString方法开始执行&quot;</span><span class="token operator">+</span> aaa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">//测试类,可以debug下看下执行流程</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">A2</span> a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        a2<span class="token punctuation">.</span><span class="token function">execution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h2 id="authorizationdecision" tabindex="-1"><a class="header-anchor" href="#authorizationdecision" aria-hidden="true">#</a> AuthorizationDecision</h2><p><code>AuthorizationDecision</code>类非常简单，就一个<code>boolean</code>类型的<code>granted</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationDecision</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> granted<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">AuthorizationDecision</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> granted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>granted <span class="token operator">=</span> granted<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>granted<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; [granted=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>granted <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110213857079.png" alt="image-20230110213857079" tabindex="0" loading="lazy"><figcaption>image-20230110213857079</figcaption></figure><h2 id="authorizehttprequestsconfigurer-1" tabindex="-1"><a class="header-anchor" href="#authorizehttprequestsconfigurer-1" aria-hidden="true">#</a> AuthorizeHttpRequestsConfigurer</h2><p>接下来，我们看<code>AuthorizeHttpRequestsConfigurer</code>，下图是其继承关系</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110214243350.png" alt="image-20230110214243350" tabindex="0" loading="lazy"><figcaption>image-20230110214243350</figcaption></figure><p>既然是<code>Configurer</code>，首先应该看的就是<code>init</code>方法和<code>configure</code>方法（这个类没有<code>init</code>方法，也就是该类不用设置一些共享对象）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> permitAllAuthorizationManager <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span>
         o<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationDecision</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 授权管理器请求匹配器的注册器</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> registry<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationEventPublisher</span> publisher<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过registry的createAuthorizationManager方法返回一个AuthorizationManager（创建授权管理器是一个复杂的过程）</span>
      <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">&gt;</span></span> authorizationManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">createAuthorizationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建AuthorizationFilter，构造方法传递刚刚创建的authorizationManager</span>
      <span class="token class-name">AuthorizationFilter</span> authorizationFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationFilter</span><span class="token punctuation">(</span>authorizationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
      authorizationFilter<span class="token punctuation">.</span><span class="token function">setAuthorizationEventPublisher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>publisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
      authorizationFilter<span class="token punctuation">.</span><span class="token function">setShouldFilterAllDispatcherTypes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>shouldFilterAllDispatcherTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 添加过滤器</span>
      http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token function">postProcess</span><span class="token punctuation">(</span>authorizationFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span>
         <span class="token keyword">extends</span> <span class="token class-name">AbstractRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizedUrl</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110215625697.png" alt="image-20230110215625697" tabindex="0" loading="lazy"><figcaption>image-20230110215625697</figcaption></figure><h2 id="authorizationmanagerrequestmatcherregistry" tabindex="-1"><a class="header-anchor" href="#authorizationmanagerrequestmatcherregistry" aria-hidden="true">#</a> AuthorizationManagerRequestMatcherRegistry</h2><p><code>AuthorizationManagerRequestMatcherRegistry</code>类是<code>AuthorizeHttpRequestsConfigurer</code>类的内部类，其继承自<code>AbstractRequestMatcherRegistry</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110215747805.png" alt="image-20230110215747805" tabindex="0" loading="lazy"><figcaption>image-20230110215747805</figcaption></figure><h3 id="abstractrequestmatcherregistry" tabindex="-1"><a class="header-anchor" href="#abstractrequestmatcherregistry" aria-hidden="true">#</a> AbstractRequestMatcherRegistry</h3><p><code>AuthorizationManagerRequestMatcherRegistry</code>类继承自<code>AbstractRequestMatcherRegistry</code>，<code>AbstractRequestMatcherRegistry</code>用于注册 RequestMatcher 的基类。 例如，它可能允许指定哪个 RequestMatcher 需要特定级别的授权。</p><p>查看该抽象类的方法，可以看到有些方法我们非常熟悉，比如说<code>anyRequest</code>、<code>antMatchers</code>等</p><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110220043930.png" alt="image-20230110220043930" style="zoom:80%;"><p><code>antMatchers</code>方法首先会判断<code>this.anyRequestConfigured</code>的值，然后调用<code>chainRequestMatchers</code>方法，并传递<code>List&lt;RequestMatcher&gt;</code>。<code>chainRequestMatchers</code>方法为抽象方法，交由子类去实现。</p><p>（泛型<code>C</code>为返回的对象，这些是一个链，也就是我们可以链式编程，调用完一个方法后可以输入<code>.</code>再调用其他方法）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">public</span> <span class="token class-name">C</span> <span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> antPatterns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>anyRequestConfigured<span class="token punctuation">,</span> <span class="token string">&quot;Can&#39;t configure antMatchers after anyRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">RequestMatchers</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> antPatterns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">C</span> <span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> antPatterns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>anyRequestConfigured<span class="token punctuation">,</span> <span class="token string">&quot;Can&#39;t configure antMatchers after anyRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">RequestMatchers</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>antPatterns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 子类实现该抽象方法</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">C</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RequestMatchers</span> <span class="token punctuation">{</span>

		<span class="token keyword">private</span> <span class="token class-name">RequestMatchers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> <span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span> httpMethod<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> antPatterns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> method <span class="token operator">=</span> <span class="token punctuation">(</span>httpMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> httpMethod<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> matchers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> pattern <span class="token operator">:</span> antPatterns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 循环创建AntPathRequestMatcher</span>
				matchers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> matchers<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230110220401669.png" alt="image-20230110220401669" tabindex="0" loading="lazy"><figcaption>image-20230110220401669</figcaption></figure><h3 id="authorizationmanagerrequestmatcherregistry-1" tabindex="-1"><a class="header-anchor" href="#authorizationmanagerrequestmatcherregistry-1" aria-hidden="true">#</a> AuthorizationManagerRequestMatcherRegistry</h3><p><code>AuthorizationManagerRequestMatcherRegistry</code>类是<code>AuthorizeHttpRequestsConfigurer</code>类的内部类，其实现了<code>AbstractRequestMatcherRegistry</code>抽象类的<code>chainRequestMatchers</code>方法</p><p>创建的<code>AuthorizedUrl</code>类也是<code>AuthorizeHttpRequestsConfigurer</code>类的内部类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">AuthorizedUrl</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">=</span> requestMatchers<span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizedUrl</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111210407089.png" alt="image-20230111210407089" tabindex="0" loading="lazy"><figcaption>image-20230111210407089</figcaption></figure><p><code>AuthorizedUrl</code>类的有些方法我们应该非常熟悉，他们最终都调用了<code>access</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111210551740.png" alt="image-20230111210551740" tabindex="0" loading="lazy"><figcaption>image-20230111210551740</figcaption></figure><p>这个<code>access</code>方法调用了本<code>AuthorizedUrl</code>内部内外部的<code>AuthorizeHttpRequestsConfigurer</code>类的<code>addMapping</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">access</span><span class="token punctuation">(</span>
      <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> <span class="token string">&quot;manager cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>matchers<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111211351194.png" alt="image-20230111211351194" tabindex="0" loading="lazy"><figcaption>image-20230111211351194</figcaption></figure><p>参数<code>manager</code>的泛型为<code>RequestAuthorizationContext</code>，其维护了<code>request</code>和<code>variables</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RequestAuthorizationContext</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> variables<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111212524191.png" alt="image-20230111212524191" tabindex="0" loading="lazy"><figcaption>image-20230111212524191</figcaption></figure><p><code>AuthorizeHttpRequestsConfigurer</code>类的<code>addMapping</code>方法，循环调用了<code>registry</code>对象的<code>addMapping</code>方法，这个<code>registry</code>就是本类的<code>AuthorizationManagerRequestMatcherRegistry</code>内部类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> matchers<span class="token punctuation">,</span>
      <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> matcher <span class="token operator">:</span> matchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111211649189.png" alt="image-20230111211649189" tabindex="0" loading="lazy"><figcaption>image-20230111211649189</figcaption></figure><p><code>AuthorizationManagerRequestMatcherRegistry</code>类的<code>addMapping</code>方法调用了<code>managerBuilder</code>对象的<code>add</code>方法，<code>managerBuilder</code>对象的值为<code>RequestMatcherDelegatingAuthorizationManager.builder()</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizedUrl</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager<span class="token punctuation">.</span>Builder</span> managerBuilder <span class="token operator">=</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager</span>
         <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> matcher<span class="token punctuation">,</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>managerBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mappingCount<span class="token operator">++</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111211932746.png" alt="image-20230111211932746" tabindex="0" loading="lazy"><figcaption>image-20230111211932746</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
		<span class="token keyword">extends</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> permitAllAuthorizationManager <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span>
			o<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationDecision</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> registry<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorizationEventPublisher</span> publisher<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建认证管理器，chaung类型为RequestMatcherDelegatingAuthorizationManager</span>
		<span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">&gt;</span></span> authorizationManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">createAuthorizationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">AuthorizationFilter</span> authorizationFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationFilter</span><span class="token punctuation">(</span>authorizationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		authorizationFilter<span class="token punctuation">.</span><span class="token function">setAuthorizationEventPublisher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>publisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
		authorizationFilter<span class="token punctuation">.</span><span class="token function">setShouldFilterAllDispatcherTypes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>shouldFilterAllDispatcherTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token function">postProcess</span><span class="token punctuation">(</span>authorizationFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> matchers<span class="token punctuation">,</span>
			<span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> matcher <span class="token operator">:</span> matchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span>
			<span class="token keyword">extends</span> <span class="token class-name">AbstractRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizedUrl</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager<span class="token punctuation">.</span>Builder</span> managerBuilder <span class="token operator">=</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager</span>
				<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> unmappedMatchers<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> matcher<span class="token punctuation">,</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>managerBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>mappingCount<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 创建认证管理器</span>
		<span class="token keyword">private</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">&gt;</span></span> <span class="token function">createAuthorizationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;An incomplete mapping was found for &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers
							<span class="token operator">+</span> <span class="token string">&quot;. Try completing it with something like requestUrls().&lt;something&gt;.hasRole(&#39;USER&#39;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappingCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
					<span class="token string">&quot;At least one mapping is required (for example, authorizeHttpRequests().anyRequest().authenticated())&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理managerBuilder.build()，managerBuilder对象的类型为RequestMatcherDelegatingAuthorizationManager.Builder</span>
            <span class="token comment">// 该build方法返回RequestMatcherDelegatingAuthorizationManager</span>
			<span class="token keyword">return</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>managerBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">protected</span> <span class="token class-name">AuthorizedUrl</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">=</span> requestMatchers<span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizedUrl</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">public</span> <span class="token class-name">H</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizedUrl</span> <span class="token punctuation">{</span>

		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> matchers<span class="token punctuation">;</span>
        
        <span class="token class-name">AuthorizedUrl</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> matchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>matchers <span class="token operator">=</span> matchers<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span>permitAllAuthorizationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">denyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationDecision</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">AuthorityAuthorizationManager</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">hasAnyRole</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">AuthorityAuthorizationManager</span><span class="token punctuation">.</span><span class="token function">hasAnyRole</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span> authority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">AuthorityAuthorizationManager</span><span class="token punctuation">.</span><span class="token function">hasAuthority</span><span class="token punctuation">(</span>authority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">AuthorityAuthorizationManager</span><span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatedAuthorizationManager</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token class-name">AuthorizationManagerRequestMatcherRegistry</span> <span class="token function">access</span><span class="token punctuation">(</span>
				<span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> <span class="token string">&quot;manager cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>matchers<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="requestmatcherdelegatingauthorizationmanager" tabindex="-1"><a class="header-anchor" href="#requestmatcherdelegatingauthorizationmanager" aria-hidden="true">#</a> RequestMatcherDelegatingAuthorizationManager</h2><p><code>managerBuilder</code>对象是<code>RequestMatcherDelegatingAuthorizationManager</code>类的内部类<code>Builder</code>，<code>RequestMatcherDelegatingAuthorizationManager</code>类的<code>builder</code>方法很简单，就创建了一个<code>Builder</code>对象。</p><p><code>RequestMatcherDelegatingAuthorizationManager</code>实现了<code>AuthorizationManager</code>接口，其维护了一堆的<code>AuthorizationManager</code>，它的<code>check</code>方法根据请求匹配的结果调用其维护的<code>AuthorizationManager</code>的<code>check</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager</span> <span class="token keyword">implements</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 维护一个mappings，这个类里面泛型套了个泛型又套了个泛型</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcherEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizationManager</span><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mappings<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">AuthorizationDecision</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Authorizing %s&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcherEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizationManager</span><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mapping <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 匹配请求</span>
			<span class="token class-name">RequestMatcher</span> matcher <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getRequestMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">MatchResult</span> matchResult <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>matchResult<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Checking authorization on %s using %s&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
                <span class="token comment">// 调用AuthorizationManager接口的check方法</span>
				<span class="token keyword">return</span> manager<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span>
						<span class="token keyword">new</span> <span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> matchResult<span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Abstaining since did not find matching RequestMatcher&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
   <span class="token comment">// builder方法创建了一个Builder对象</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Builder</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Builder</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里维护的mappings类型和这个内部类的外部类维护的mappings类型一模一样</span>
      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcherEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizationManager</span><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// add方法就是在mappings里添加RequestMatcherEntry</span>
      <span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> matcher<span class="token punctuation">,</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span></span> manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> <span class="token string">&quot;matcher cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> <span class="token string">&quot;manager cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>mappings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestMatcherEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Consumer是java8新增的消费器，mappings方法就是把mappingsConsumer传给我们，然后调用Consumer的accept方法，然后我们自己实现添加逻辑（我们可以高度自定义）</span>
      <span class="token keyword">public</span> <span class="token class-name">Builder</span> <span class="token function">mappings</span><span class="token punctuation">(</span>
            <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcherEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorizationManager</span><span class="token punctuation">&lt;</span><span class="token class-name">RequestAuthorizationContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mappingsConsumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>mappingsConsumer<span class="token punctuation">,</span> <span class="token string">&quot;mappingsConsumer cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         mappingsConsumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// managerBuilder对象的类型为RequestMatcherDelegatingAuthorizationManager.Builder，这是其build方法</span>
      <span class="token keyword">public</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestMatcherDelegatingAuthorizationManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230111215210144.png" alt="image-20230111215210144" tabindex="0" loading="lazy"><figcaption>image-20230111215210144</figcaption></figure><h2 id="authorityauthorizationmanager" tabindex="-1"><a class="header-anchor" href="#authorityauthorizationmanager" aria-hidden="true">#</a> AuthorityAuthorizationManager</h2><p>这是实际干活的类，用于判断某个请求是否需要某些权限，该类实现了<code>AuthorizationManager</code>接口。而<code>RequestMatcherDelegatingAuthorizationManager</code>也实现了<code>AuthorizationManager</code>接口，其维护了一堆的<code>AuthorizationManager</code>，它的<code>check</code>方法根据请求匹配的结果调用其维护的<code>AuthorizationManager</code>的<code>check</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AuthorityAuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">AuthorizationManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROLE_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;ROLE_&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">AuthorityAuthorizationManager</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>authorities <span class="token operator">=</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">createAuthorityList</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">AuthorizationDecision</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">,</span> <span class="token class-name">T</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> granted <span class="token operator">=</span> <span class="token function">isGranted</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorityAuthorizationDecision</span><span class="token punctuation">(</span>granted<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113205625845.png" alt="image-20230113205625845" tabindex="0" loading="lazy"><figcaption>image-20230113205625845</figcaption></figure><h2 id="配置过程" tabindex="-1"><a class="header-anchor" href="#配置过程" aria-hidden="true">#</a> 配置过程</h2><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113211648769.png" alt="image-20230113211648769" tabindex="0" loading="lazy"><figcaption>image-20230113211648769</figcaption></figure><p>当我们<code>.authorizeHttpRequests()</code>时返回了一个<code>AuthorizeHttpRequestsConfigurer&lt;HttpSecurity&gt;</code>的内部类<code>AuthorizationManagerRequestMatcherRegistry</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113211750416.png" alt="image-20230113211750416" tabindex="0" loading="lazy"><figcaption>image-20230113211750416</figcaption></figure><p>这个<code>AuthorizationManagerRequestMatcherRegistry</code>内部类继承了<code>AbstractRequestMatcherRegistry</code>抽象类</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113212226894.png" alt="image-20230113212226894" tabindex="0" loading="lazy"><figcaption>image-20230113212226894</figcaption></figure><p><code>AbstractRequestMatcherRegistry</code>抽象类有一个<code>antMatchers</code>方法返回一个<code>C</code>，这个<code>C</code>就是<code>AuthorizationManagerRequestMatcherRegistry</code>类继承该类时指定的泛型，即<code>AuthorizedUrl</code>，因此当我们在<code>IDEA</code>里配置<code>.antMatchers(&quot;/admin/**&quot;)</code>时，右边显示的是<code>AuthorizeHttpRequestsConfigurer&lt;...&gt;.AuthorizedUrl</code>，也就是<code>AuthorizeHttpRequestsConfigurer&lt;HttpSecurity&gt;</code>类的<code>AuthorizedUrl</code>内部类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token class-name">C</span> <span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> antPatterns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>anyRequestConfigured<span class="token punctuation">,</span> <span class="token string">&quot;Can&#39;t configure antMatchers after anyRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">RequestMatchers</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>antPatterns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113212338460.png" alt="image-20230113212338460" tabindex="0" loading="lazy"><figcaption>image-20230113212338460</figcaption></figure><p>该<code>AuthorizedUrl</code>类就有我们常见的<code>hasRole</code>、<code>hasAnyRole</code>、<code>hasAuthority</code>、<code>hasAnyAuthority</code>等方法，不过这些方法都会调用<code>access</code>方法，而<code>access</code>方法调用的是<code>AuthorizeHttpRequestsConfigurer</code>类的<code>addMapping</code>方法。当我们<code>.hasRole(&quot;ADMIN&quot;)</code>时又返回了一个<code>AuthorizationManagerRequestMatcherRegistry</code>，我们可以接着<code>.antMatchers(&quot;/user/**&quot;).hasRole(&quot;USER&quot;)</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230113213218230.png" alt="image-20230113213218230" tabindex="0" loading="lazy"><figcaption>image-20230113213218230</figcaption></figure><h1 id="分割线" tabindex="-1"><a class="header-anchor" href="#分割线" aria-hidden="true">#</a> --------------------分割线-----------------------------</h1><h1 id="filtersecurityinterceptor" tabindex="-1"><a class="header-anchor" href="#filtersecurityinterceptor" aria-hidden="true">#</a> FilterSecurityInterceptor</h1><p>授权有两个过滤器，分别是<code>AuthorizationFilter</code>和<code>FilterSecurityInterceptor</code>，而<code>FilterSecurityInterceptor</code>是最常使用也是最复杂的过滤器。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119182819009.png" alt="image-20230119182819009" tabindex="0" loading="lazy"><figcaption>image-20230119182819009</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterSecurityInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSecurityInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterInvocation</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>FilterSecurityInterceptor</code>类的<code>doFilter</code>方法创建了一个<code>FilterInvocation</code>对象，然后调用<code>invoke</code>方法</p><h2 id="filterinvocation" tabindex="-1"><a class="header-anchor" href="#filterinvocation" aria-hidden="true">#</a> FilterInvocation</h2><p>这个<code>FilterInvocation</code>比较简单，就维护了<code>FilterChain</code>、<code>HttpServletRequest</code>、<code>HttpServletResponse</code>三个属性</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterInvocation</span> <span class="token punctuation">{</span>

   <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FilterChain</span> <span class="token constant">DUMMY_CHAIN</span> <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;Dummy filter chain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">FilterInvocation</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>request <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> chain <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Cannot pass null values to constructor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>chain <span class="token operator">=</span> chain<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119183326572.png" alt="image-20230119183326572" tabindex="0" loading="lazy"><figcaption>image-20230119183326572</figcaption></figure><h2 id="filtersecurityinterceptor-1" tabindex="-1"><a class="header-anchor" href="#filtersecurityinterceptor-1" aria-hidden="true">#</a> FilterSecurityInterceptor</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterSecurityInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSecurityInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FILTER_APPLIED</span> <span class="token operator">=</span> <span class="token string">&quot;__spring_security_filterSecurityInterceptor_filterApplied&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">FilterInvocationSecurityMetadataSource</span> securityMetadataSource<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> observeOncePerRequest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">FilterInvocation</span> filterInvocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果应用过了并且只应用了一次，直接放行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isApplied</span><span class="token punctuation">(</span>filterInvocation<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observeOncePerRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// filter already applied to this request and user wants us to observe</span>
         <span class="token comment">// once-per-request handling, so don&#39;t re-do security checking</span>
         filterInvocation<span class="token punctuation">.</span><span class="token function">getChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>filterInvocation<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filterInvocation<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 这个请求第一次被调用，在request里添加key为__spring_security_filterSecurityInterceptor_filterApplied，value为TRUE的session</span>
      <span class="token comment">// first time this request being called, so perform security checking</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filterInvocation<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observeOncePerRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         filterInvocation<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">InterceptorStatusToken</span> token <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">beforeInvocation</span><span class="token punctuation">(</span>filterInvocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 执行过滤器链</span>
         filterInvocation<span class="token punctuation">.</span><span class="token function">getChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>filterInvocation<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filterInvocation<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// 将动态修改后的新的SecurityContext重新设置回老的SecurityContext</span>
         <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finallyInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 基于方法级别的校验的后置处理（@PostAuthorize、@PostFilter ）把需要的数据过滤出来</span>
      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 是否已经应用过了</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isApplied</span><span class="token punctuation">(</span><span class="token class-name">FilterInvocation</span> filterInvocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>filterInvocation<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>filterInvocation<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119184312043.png" alt="image-20230119184312043" tabindex="0" loading="lazy"><figcaption>image-20230119184312043</figcaption></figure><h2 id="abstractsecurityinterceptor" tabindex="-1"><a class="header-anchor" href="#abstractsecurityinterceptor" aria-hidden="true">#</a> AbstractSecurityInterceptor</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSecurityInterceptor</span>
      <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">SecurityMetadataSource</span> <span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">protected</span> <span class="token class-name">InterceptorStatusToken</span> <span class="token function">beforeInvocation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> <span class="token string">&quot;Object was null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Security invocation attempted for object &quot;</span> <span class="token operator">+</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token operator">+</span> <span class="token string">&quot; but AbstractSecurityInterceptor only configured to support secure objects of type: &quot;</span>
               <span class="token operator">+</span> <span class="token function">getSecureObjectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 通过元信息类获取一些属性</span>
      <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 没用获取到元信息（一般不会走到这里来）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//拒绝公共调用为false时，抛出异常（没有配置的是否让访问，一般我们最后会配置anyRequest，用于设置其他没有特殊配置的请求）</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rejectPublicInvocations<span class="token punctuation">,</span>
               <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Secure object invocation &quot;</span> <span class="token operator">+</span> object
                     <span class="token operator">+</span> <span class="token string">&quot; was denied as public invocations are not allowed via this interceptor. &quot;</span>
                     <span class="token operator">+</span> <span class="token string">&quot;This indicates a configuration error because the &quot;</span>
                     <span class="token operator">+</span> <span class="token string">&quot;rejectPublicInvocations property is set to &#39;true&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Authorized public object %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PublicInvocationEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// no further work post-invocation</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 该用户没有认证，不能进行授权</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">credentialsNotFound</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractSecurityInterceptor.authenticationNotFound&quot;</span><span class="token punctuation">,</span>
               <span class="token string">&quot;An Authentication object was not found in the SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 拿到认证信息</span>
      <span class="token class-name">Authentication</span> authenticated <span class="token operator">=</span> <span class="token function">authenticateIfRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Authorizing %s with attributes %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Attempt authorization</span>
      <span class="token comment">// 尝试授权（核心方法）（如果授权失败，则抛出异常）</span>
      <span class="token function">attemptAuthorization</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> authenticated<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Authorized %s with attributes %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 发布授权成功了事件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>publishAuthorizationSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorizedEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> authenticated<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Attempt to run as a different user</span>
      <span class="token comment">// 将原有的authenticated替换成为新的Authentication,可能增加原先没有的角色信息和权限信息（一般为null）</span>
      <span class="token class-name">Authentication</span> runAs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>runAsManager<span class="token punctuation">.</span><span class="token function">buildRunAs</span><span class="token punctuation">(</span>authenticated<span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>runAs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 把原有的SecurityContext保存一份</span>
         <span class="token class-name">SecurityContext</span> origCtx <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 创建一个新的SecurityContext</span>
         <span class="token class-name">SecurityContext</span> newCtx <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 把替换后的Authentication设置进去（其子类FilterSecurityInterceptor会调用super.finallyInvocation(token);进行复原）</span>
         newCtx<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>runAs<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Switched to RunAs authentication %s&quot;</span><span class="token punctuation">,</span> runAs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// need to revert to token.Authenticated post-invocation</span>
         <span class="token comment">// 创建一个动态修改过Authentication的InterceptorStatusToken</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorStatusToken</span><span class="token punctuation">(</span>origCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Did not switch RunAs authentication since RunAsManager returned null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// no further work post-invocation</span>
      <span class="token comment">// 创建一个Authentication，保存一些属性</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InterceptorStatusToken</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span>
   <span class="token comment">// 尝试进行授权</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attemptAuthorization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">,</span>
         <span class="token class-name">Authentication</span> authenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 访问决策管理器决策是否放行</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">.</span><span class="token function">decide</span><span class="token punctuation">(</span>authenticated<span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authorize %s with attributes %s using %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span>
                  attributes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authorize %s with attributes %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorizationFailureEvent</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> authenticated<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 将SecurityContext复原</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finallyInvocation</span><span class="token punctuation">(</span><span class="token class-name">InterceptorStatusToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果token不为空，并且需要被刷新，就将老的SecurityContext设置回去</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span><span class="token function">isContextHolderRefreshRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
                  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Reverted to original authentication &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 后置处理</span>
   <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">afterInvocation</span><span class="token punctuation">(</span><span class="token class-name">InterceptorStatusToken</span> token<span class="token punctuation">,</span> <span class="token class-name">Object</span> returnedObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// public object</span>
         <span class="token keyword">return</span> returnedObject<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 有可能我们实现AbstractSecurityInterceptor抽象类时没有调用finallyInvocation方法，因此这里消极地再调一遍（比如我们临时把普通用户升级为管理员，为了防止后面还是管理员，SpringSecurity宁愿多调一次也不让这种事情发生）</span>
      <span class="token function">finallyInvocation</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// continue to clean in this method for passivity</span>
      <span class="token comment">// 基于方法级别的校验的后置处理（@PostAuthorize、@PostFilter ）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Attempt after invocation handling</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 把需要的数据过滤出来</span>
            returnedObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>afterInvocationManager<span class="token punctuation">.</span><span class="token function">decide</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  token<span class="token punctuation">.</span><span class="token function">getSecureObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> returnedObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthorizationFailureEvent</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getSecureObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  token<span class="token punctuation">.</span><span class="token function">getSecurityContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> returnedObject<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">Authentication</span> <span class="token function">authenticateIfRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到认证信息</span>
      <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果已经认证过了，直接返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>alwaysReauthenticate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Did not re-authenticate %s before authorizing&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果还没有认证，调用authenticationManager认证管理器的authenticate方法进行认证（如果认证失败了会抛出异常）</span>
      authentication <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Don&#39;t authenticated.setAuthentication(true) because each provider does that</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Re-authenticated %s before authorizing&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建空的SecurityContext</span>
      <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将认证信息设置到上下文中</span>
      context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119193824426.png" alt="image-20230119193824426" tabindex="0" loading="lazy"><figcaption>image-20230119193824426</figcaption></figure><p><code>this.obtainSecurityMetadataSource().getAttributes(object);</code>调用本类抽象的<code>obtainSecurityMetadataSource();</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119194601566.png" alt="image-20230119194601566" tabindex="0" loading="lazy"><figcaption>image-20230119194601566</figcaption></figure><p>其返回类型为<code>SecurityMetadataSource</code>，该接口维护了一些<code>Collection&lt;ConfigAttribute&gt;</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityMetadataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AopInfrastructureBean</span> <span class="token punctuation">{</span>

   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">;</span>

   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllConfigAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120174126010.png" alt="image-20230120174126010" tabindex="0" loading="lazy"><figcaption>image-20230120174126010</figcaption></figure><p><code>ConfigAttribute</code>接口维护了一些属性，可以维护一些<code>角色</code>、<code>权限</code>等信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConfigAttribute</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

   <span class="token class-name">String</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120174310582.png" alt="image-20230120174310582" tabindex="0" loading="lazy"><figcaption>image-20230120174310582</figcaption></figure><p>其子类<code>FilterSecurityInterceptor</code>返回<code>this.securityMetadataSource</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SecurityMetadataSource</span> <span class="token function">obtainSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityMetadataSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119194645208.png" alt="image-20230119194645208" tabindex="0" loading="lazy"><figcaption>image-20230119194645208</figcaption></figure><p>其类型为<code>FilterInvocationSecurityMetadataSource</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119194743723.png" alt="image-20230119194743723" tabindex="0" loading="lazy"><figcaption>image-20230119194743723</figcaption></figure><h3 id="interceptorstatustoken" tabindex="-1"><a class="header-anchor" href="#interceptorstatustoken" aria-hidden="true">#</a> InterceptorStatusToken</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorStatusToken</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attr<span class="token punctuation">;</span>
   <span class="token comment">// 一般是FilterInvocation</span>
   <span class="token keyword">private</span> <span class="token class-name">Object</span> secureObject<span class="token punctuation">;</span>
   <span class="token comment">// ContextHolder是否已经被替换过了（即this.runAsManager.buildRunAs是否返回不为null）（一般不会被替换）</span>
   <span class="token keyword">private</span> <span class="token keyword">boolean</span> contextHolderRefreshRequired<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">InterceptorStatusToken</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">,</span> <span class="token keyword">boolean</span> contextHolderRefreshRequired<span class="token punctuation">,</span>
         <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">,</span> <span class="token class-name">Object</span> secureObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>securityContext <span class="token operator">=</span> securityContext<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>contextHolderRefreshRequired <span class="token operator">=</span> contextHolderRefreshRequired<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>attr <span class="token operator">=</span> attributes<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>secureObject <span class="token operator">=</span> secureObject<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230119191208712.png" alt="image-20230119191208712" tabindex="0" loading="lazy"><figcaption>image-20230119191208712</figcaption></figure><p>授权配置有<code>UrlAuthorizationConfigurer</code>（基于<code>url</code>配置）和<code>ExpressionUrlAuthorizationConfigurer</code>（基于<code>el</code>表达式的<code>url</code>配置），<code>ExpressionUrlAuthorizationConfigurer</code>是最常使用的类，但是比较复杂，因此我们先研究较为简单的<code>UrlAuthorizationConfigurer</code> 。</p><p><code>UrlAuthorizationConfigurer</code>类并没有实现<code>init</code>方法和<code>configure</code>方法，其父类<code>AbstractInterceptUrlConfigurer</code>实现了<code>configure</code>方法</p><h2 id="abstractintercepturlconfigurer" tabindex="-1"><a class="header-anchor" href="#abstractintercepturlconfigurer" aria-hidden="true">#</a> AbstractInterceptUrlConfigurer</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractInterceptUrlConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractInterceptUrlConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractHttpConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建元数据源</span>
      <span class="token class-name">FilterInvocationSecurityMetadataSource</span> metadataSource <span class="token operator">=</span> <span class="token function">createMetadataSource</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>metadataSource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建FilterSecurityInterceptor</span>
      <span class="token class-name">FilterSecurityInterceptor</span> securityInterceptor <span class="token operator">=</span> <span class="token function">createFilterSecurityInterceptor</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> metadataSource<span class="token punctuation">,</span>
            http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filterSecurityInterceptorOncePerRequest <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         securityInterceptor<span class="token punctuation">.</span><span class="token function">setObserveOncePerRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filterSecurityInterceptorOncePerRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      securityInterceptor <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>securityInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 添加这个过滤器</span>
      http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>securityInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置共享属性</span>
      http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> securityInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">abstract</span> <span class="token class-name">FilterInvocationSecurityMetadataSource</span> <span class="token function">createMetadataSource</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 创建默认的访问决策管理器</span>
   <span class="token keyword">private</span> <span class="token class-name">AccessDecisionManager</span> <span class="token function">createDefaultAccessDecisionManager</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 投票策略，该类是有一个同意即可（调用getDecisionVoters抽象方法获取决策投票器，让子类去实现该方法）</span>
      <span class="token class-name">AffirmativeBased</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AffirmativeBased</span><span class="token punctuation">(</span><span class="token function">getDecisionVoters</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 获取访问决策管理器</span>
   <span class="token keyword">private</span> <span class="token class-name">AccessDecisionManager</span> <span class="token function">getAccessDecisionManager</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager <span class="token operator">=</span> <span class="token function">createDefaultAccessDecisionManager</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accessDecisionManager<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">FilterSecurityInterceptor</span> <span class="token function">createFilterSecurityInterceptor</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">,</span>
         <span class="token class-name">FilterInvocationSecurityMetadataSource</span> metadataSource<span class="token punctuation">,</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建一个FilterSecurityInterceptor</span>
      <span class="token class-name">FilterSecurityInterceptor</span> securityInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterSecurityInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置安全元数据源</span>
      securityInterceptor<span class="token punctuation">.</span><span class="token function">setSecurityMetadataSource</span><span class="token punctuation">(</span>metadataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置权限决策管理器</span>
      securityInterceptor<span class="token punctuation">.</span><span class="token function">setAccessDecisionManager</span><span class="token punctuation">(</span><span class="token function">getAccessDecisionManager</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置认证管理器</span>
      securityInterceptor<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 校验操作</span>
      securityInterceptor<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> securityInterceptor<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122162035392.png" alt="image-20230122162035392" tabindex="0" loading="lazy"><figcaption>image-20230122162035392</figcaption></figure><h3 id="urlauthorizationconfigurer" tabindex="-1"><a class="header-anchor" href="#urlauthorizationconfigurer" aria-hidden="true">#</a> UrlAuthorizationConfigurer</h3><p><code>AbstractInterceptUrlConfigurer</code>抽象类的子类<code>UrlAuthorizationConfigurer</code>实现的<code>createMetadataSource</code>方法里返回<code>DefaultFilterInvocationSecurityMetadataSource</code>对象</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122162243872.png" alt="image-20230122162243872" tabindex="0" loading="lazy"><figcaption>image-20230122162243872</figcaption></figure><h4 id="defaultfilterinvocationsecuritymetadatasource" tabindex="-1"><a class="header-anchor" href="#defaultfilterinvocationsecuritymetadatasource" aria-hidden="true">#</a> DefaultFilterInvocationSecurityMetadataSource</h4><p><code>DefaultFilterInvocationSecurityMetadataSource</code>里面维护了一个<code>requestMap</code>，也就是<code>RequestMatcher</code>请求匹配器需要哪些配置属性。我们可以很明显的看到其是为<code>FilterInvocation</code>服务的。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFilterInvocationSecurityMetadataSource</span> <span class="token keyword">implements</span> <span class="token class-name">FilterInvocationSecurityMetadataSource</span> <span class="token punctuation">{</span>

   <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMap<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FilterInvocation</span><span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">FilterInvocation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122162654863.png" alt="image-20230122162654863" tabindex="0" loading="lazy"><figcaption>image-20230122162654863</figcaption></figure><p><code>AbstractInterceptUrlConfigurer</code>抽象类的子类<code>UrlAuthorizationConfigurer</code>实现的<code>getDecisionVoters</code>方法里向<code>decisionVoters</code>里添加了<code>RoleVoter</code>（角色投票器）和<code>AuthenticatedVoter</code>（认证投票器）</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractInterceptUrlConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> decisionVoters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decisionVoters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RoleVoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decisionVoters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthenticatedVoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> decisionVoters<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120190939867.png" alt="image-20230120190939867" tabindex="0" loading="lazy"><figcaption>image-20230120190939867</figcaption></figure><h4 id="standardintercepturlregistry" tabindex="-1"><a class="header-anchor" href="#standardintercepturlregistry" aria-hidden="true">#</a> StandardInterceptUrlRegistry</h4><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122162243872.png" alt="image-20230122162243872" tabindex="0" loading="lazy"><figcaption>image-20230122162243872</figcaption></figure><p><code>new DefaultFilterInvocationSecurityMetadataSource(this.registry.createRequestMap());</code>传的<code>this.registry</code>类型为<code>StandardInterceptUrlRegistry</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122170233184.png" alt="image-20230122170233184" tabindex="0" loading="lazy"><figcaption>image-20230122170233184</figcaption></figure><p><code>StandardInterceptUrlRegistry</code>结构如下图所示，其顶层继承于<code>AbstractRequestMatcherRegistry</code>（前面提到的<code>AuthorizationManagerRequestMatcherRegistry</code>也是继承该抽象类）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122170537697.png" alt="image-20230122170537697" tabindex="0" loading="lazy"><figcaption>image-20230122170537697</figcaption></figure><h4 id="abstractrequestmatcherregistry-1" tabindex="-1"><a class="header-anchor" href="#abstractrequestmatcherregistry-1" aria-hidden="true">#</a> AbstractRequestMatcherRegistry</h4><p>调用的<code>this.registry.createRequestMap()</code>就是调用<code>StandardInterceptUrlRegistry</code>抽象类<code>AbstractRequestMatcherRegistry</code>的<code>createRequestMap</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractConfigAttributeRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRequestMatcherRegistry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UrlMapping</span><span class="token punctuation">&gt;</span></span> urlMappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> unmappedMatchers<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">C</span> <span class="token function">chainRequestMatchers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">=</span> requestMatchers<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">chainRequestMatchersInternal</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">C</span> <span class="token function">chainRequestMatchersInternal</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">final</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">createRequestMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;An incomplete mapping was found for &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>unmappedMatchers
				<span class="token operator">+</span> <span class="token string">&quot;. Try completing it with something like requestUrls().&lt;something&gt;.hasRole(&#39;USER&#39;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">UrlMapping</span> mapping <span class="token operator">:</span> <span class="token function">getUrlMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">RequestMatcher</span> matcher <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getRequestMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttrs <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getConfigAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			requestMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> configAttrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> requestMap<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UrlMapping</span> <span class="token punctuation">{</span>

		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcher</span> requestMatcher<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttrs<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122171313158.png" alt="image-20230122171313158" tabindex="0" loading="lazy"><figcaption>image-20230122171313158</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122171342103.png" alt="image-20230122171342103" tabindex="0" loading="lazy"><figcaption>image-20230122171342103</figcaption></figure><p><code>AbstractConfigAttributeRequestMatcherRegistry</code>抽象类实现了<code>chainRequestMatchers</code>方法，其最终会调用<code>chainRequestMatchersInternal</code>方法，而<code>chainRequestMatchersInternal</code>又为抽象方法，留给子类去实现。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122173757957.png" alt="image-20230122173757957" tabindex="0" loading="lazy"><figcaption>image-20230122173757957</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">extends</span> <span class="token class-name">AbstractInterceptUrlConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StandardInterceptUrlRegistry</span> registry<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardInterceptUrlRegistry</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> decisionVoters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decisionVoters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RoleVoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      decisionVoters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthenticatedVoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> decisionVoters<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token class-name">FilterInvocationSecurityMetadataSource</span> <span class="token function">createMetadataSource</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultFilterInvocationSecurityMetadataSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">createRequestMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">private</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">,</span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requestMatcher <span class="token operator">:</span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	     <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span>
				<span class="token keyword">new</span> <span class="token class-name">AbstractConfigAttributeRequestMatcherRegistry<span class="token punctuation">.</span>UrlMapping</span><span class="token punctuation">(</span>requestMatcher<span class="token punctuation">,</span> configAttributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	   <span class="token punctuation">}</span>
	   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token operator">!</span>role<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;ROLE_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> role
            <span class="token operator">+</span> <span class="token string">&quot; should not start with ROLE_ since ROLE_ is automatically prepended when using hasRole. Consider using hasAuthority or access instead.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;ROLE_&quot;</span> <span class="token operator">+</span> role<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token keyword">extends</span>
         <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span>AbstractInterceptUrlRegistry<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StandardInterceptUrlRegistry</span><span class="token punctuation">,</span> <span class="token class-name">AuthorizedUrl</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">protected</span> <span class="token class-name">AuthorizedUrl</span> <span class="token function">chainRequestMatchersInternal</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizedUrl</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">public</span> <span class="token class-name">H</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizedUrl</span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">;</span>

      <span class="token class-name">AuthorizedUrl</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>requestMatchers<span class="token punctuation">,</span> <span class="token string">&quot;requestMatchers must contain at least one value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatchers <span class="token operator">=</span> requestMatchers<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">hasAnyRole</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token function">hasAnyRole</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">hasAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span> authority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span>authority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;ANONYMOUS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestMatchers<span class="token punctuation">,</span> <span class="token class-name">SecurityConfig</span><span class="token punctuation">.</span><span class="token function">createList</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMatchers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatchers<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>UrlAuthorizationConfigurer</code>类的内部类<code>StandardInterceptUrlRegistry</code>实现的<code>chainRequestMatchersInternal</code>直接<code>new</code>了一个<code>AuthorizedUrl</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122174712057.png" alt="image-20230122174712057" tabindex="0" loading="lazy"><figcaption>image-20230122174712057</figcaption></figure><p><code>UrlAuthorizationConfigurer</code>类的<code>AuthorizedUrl</code>和前面的配置类一样，也有<code>hasRole</code>、<code>hasAnyRole</code>、<code>hasAuthority</code>、<code>hasAnyAuthority</code>等方法，其最终还是调用<code>access</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestMatchers<span class="token punctuation">,</span> <span class="token class-name">SecurityConfig</span><span class="token punctuation">.</span><span class="token function">createList</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">UrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>SecurityConfig</code>类只有一个<code>attrib</code>属性，其<code>createList</code>方法根据<code>attributeNames</code>创建<code>SecurityConfig</code>对象，添加到<code>attributes</code>集合中</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigAttribute</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> attrib<span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> <span class="token function">createList</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> attributeNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>attributeNames<span class="token punctuation">,</span> <span class="token string">&quot;You must supply an array of attribute names&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>attributeNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> attribute <span class="token operator">:</span> attributeNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         attributes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityConfig</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> attributes<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122180318520.png" alt="image-20230122180318520" tabindex="0" loading="lazy"><figcaption>image-20230122180318520</figcaption></figure><p><code>addMapping</code>方法是本类<code>UrlAuthorizationConfigurer</code>的方法，将<code>requestMatchers</code>里全部的<code>requestMatcher</code>全部应用上<code>configAttributes</code>配置属性。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">StandardInterceptUrlRegistry</span> <span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMatcher</span><span class="token punctuation">&gt;</span></span> requestMatchers<span class="token punctuation">,</span>
      <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requestMatcher <span class="token operator">:</span> requestMatchers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">AbstractConfigAttributeRequestMatcherRegistry<span class="token punctuation">.</span>UrlMapping</span><span class="token punctuation">(</span>requestMatcher<span class="token punctuation">,</span> configAttributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="rolevoter" tabindex="-1"><a class="header-anchor" href="#rolevoter" aria-hidden="true">#</a> RoleVoter</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleVoter</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDecisionVoter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">String</span> rolePrefix <span class="token operator">=</span> <span class="token string">&quot;ROLE_&quot;</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRolePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRolePrefix</span><span class="token punctuation">(</span><span class="token class-name">String</span> rolePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix <span class="token operator">=</span> rolePrefix<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 如果配置的属性不为null，并且属性以ROLE_开头</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> attribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token function">getRolePrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 根据authentication判断是否具有访问object需要的attributes</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果没有authentication直接拒绝访问</span>
         <span class="token keyword">return</span> <span class="token constant">ACCESS_DENIED</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 先默认弃权</span>
      <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token constant">ACCESS_ABSTAIN</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取权限信息，有可能有角色和权限</span>
      <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token function">extractAuthorities</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attribute <span class="token operator">:</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果有支持的，默认先拒绝</span>
            result <span class="token operator">=</span> <span class="token constant">ACCESS_DENIED</span><span class="token punctuation">;</span>
            <span class="token comment">// Attempt to find a matching granted authority</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GrantedAuthority</span> authority <span class="token operator">:</span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 如果有一个权限相等就赞成</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authority<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token constant">ACCESS_GRANTED</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">extractAuthorities</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120192101683.png" alt="image-20230120192101683" tabindex="0" loading="lazy"><figcaption>image-20230120192101683</figcaption></figure><h4 id="authenticatedvoter" tabindex="-1"><a class="header-anchor" href="#authenticatedvoter" aria-hidden="true">#</a> AuthenticatedVoter</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticatedVoter</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDecisionVoter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 先默认弃权</span>
      <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token constant">ACCESS_ABSTAIN</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attribute <span class="token operator">:</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果有支持的，默认先拒绝</span>
            result <span class="token operator">=</span> <span class="token constant">ACCESS_DENIED</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">IS_AUTHENTICATED_FULLY</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 如果需要是完全认证（通过用户名密码登陆的），则访问者需要是完全认证</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFullyAuthenticated</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token constant">ACCESS_GRANTED</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">IS_AUTHENTICATED_REMEMBERED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 如果需要是记住我认证（通过记住我登陆的），则访问者需要是完全认证或记住我认证</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isRememberMe</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span>
                     <span class="token operator">||</span> <span class="token function">isFullyAuthenticated</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token constant">ACCESS_GRANTED</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 如果需要是匿名认证（没有登陆的），则访问者需要是完全认证或记住我认证或匿名认证的</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span>
                     <span class="token operator">||</span> <span class="token function">isFullyAuthenticated</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span>
                     <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isRememberMe</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token constant">ACCESS_GRANTED</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230122160025836.png" alt="image-20230122160025836" tabindex="0" loading="lazy"><figcaption>image-20230122160025836</figcaption></figure><h3 id="abstractaccessdecisionmanager" tabindex="-1"><a class="header-anchor" href="#abstractaccessdecisionmanager" aria-hidden="true">#</a> AbstractAccessDecisionManager</h3><p><code>createDefaultAccessDecisionManager</code>方法返回一个<code>AccessDecisionManager</code>，我们先看实现了<code>AccessDecisionManager</code>接口的抽象类<code>AbstractAccessDecisionManager</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractAccessDecisionManager</span>
      <span class="token keyword">implements</span> <span class="token class-name">AccessDecisionManager</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">// 访问决策投票</span>
   <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> decisionVoters<span class="token punctuation">;</span>

   <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> allowIfAllAbstainDecisions <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

   <span class="token keyword">protected</span> <span class="token class-name">AbstractAccessDecisionManager</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> decisionVoters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>decisionVoters<span class="token punctuation">,</span> <span class="token string">&quot;A list of AccessDecisionVoters is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>decisionVoters <span class="token operator">=</span> decisionVoters<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>decisionVoters<span class="token punctuation">,</span> <span class="token string">&quot;A list of AccessDecisionVoters is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">,</span> <span class="token string">&quot;A message source must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 如果所有投票者都弃权了是否让其访问（默认false）</span>
   <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">checkAllowIfAllAbstainDecisions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAllowIfAllAbstainDecisions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractAccessDecisionManager.accessDenied&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Access is denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  
   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>decisionVoters<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAllowIfAllAbstainDecisions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowIfAllAbstainDecisions<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAllowIfAllAbstainDecisions</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> allowIfAllAbstainDecisions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>allowIfAllAbstainDecisions <span class="token operator">=</span> allowIfAllAbstainDecisions<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceAccessor</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只要一个支持了，就返回true</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AccessDecisionVoter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> voter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>decisionVoters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>voter<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只要有一个拒绝了就返回false</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AccessDecisionVoter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> voter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>decisionVoters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>voter<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AbstractAccessDecisionManager</code>抽象类维护的<code>AccessDecisionVoter</code>如下所示</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccessDecisionVoter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token comment">// 同意</span>
   <span class="token keyword">int</span> <span class="token constant">ACCESS_GRANTED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token comment">// 弃权</span>
   <span class="token keyword">int</span> <span class="token constant">ACCESS_ABSTAIN</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">// 拒绝</span>
   <span class="token keyword">int</span> <span class="token constant">ACCESS_DENIED</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token comment">// 判断这个配置是否支持投票</span>
   <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 判断这个类是否支持投票</span>
   <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 判断拥有这个authentication和attributes能不能访问这个object</span>
   <span class="token keyword">int</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">S</span> object<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120183246502.png" alt="image-20230120183246502" tabindex="0" loading="lazy"><figcaption>image-20230120183246502</figcaption></figure><p><code>AbstractAccessDecisionManager</code>抽象类的实现类有三个：<code>AffirmativeBased</code>只要一个同意就允许访问；<code>ConsensusBased</code>少数服从多数，超过一半才允许访问（如果同意数和拒绝数相等且不为0可以进行单独配置，默认true即允许访问）；<code>UnanimousBased</code>全部同意了才允许访问</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120181859789.png" alt="image-20230120181859789" tabindex="0" loading="lazy"><figcaption>image-20230120181859789</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AffirmativeBased</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAccessDecisionManager</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token class-name">AffirmativeBased</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> decisionVoters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>decisionVoters<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unchecked&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decide</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> configAttributes<span class="token punctuation">)</span>
         <span class="token keyword">throws</span> <span class="token class-name">AccessDeniedException</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> deny <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AccessDecisionVoter</span> voter <span class="token operator">:</span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">int</span> result <span class="token operator">=</span> voter<span class="token punctuation">.</span><span class="token function">vote</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> object<span class="token punctuation">,</span> configAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 如果有一个同意了直接放行</span>
         <span class="token keyword">case</span> <span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">.</span><span class="token constant">ACCESS_GRANTED</span><span class="token operator">:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token comment">// 如果有一个拒绝了直接抛出异常</span>
         <span class="token keyword">case</span> <span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">.</span><span class="token constant">ACCESS_DENIED</span><span class="token operator">:</span>
            deny<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果有一个拒绝了直接抛出异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deny <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractAccessDecisionManager.accessDenied&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Access is denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果全部弃权了调用父类的checkAllowIfAllAbstainDecisions方法判断是否允许访问（默认不允许）</span>
      <span class="token comment">// To get this far, every AccessDecisionVoter abstained</span>
      <span class="token function">checkAllowIfAllAbstainDecisions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230120185309108.png" alt="image-20230120185309108" tabindex="0" loading="lazy"><figcaption>image-20230120185309108</figcaption></figure><h3 id="expressionurlauthorizationconfigurer" tabindex="-1"><a class="header-anchor" href="#expressionurlauthorizationconfigurer" aria-hidden="true">#</a> ExpressionUrlAuthorizationConfigurer</h3><div class="language-groovy line-numbers-mode" data-ext="groovy"><pre class="language-groovy"><code><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>SpelExpressionParser
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>support<span class="token punctuation">.</span>StandardEvaluationContext

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    String name<span class="token punctuation">;</span>
    Integer age<span class="token punctuation">;</span>

    <span class="token function">Person</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Integer age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age
    <span class="token punctuation">}</span>

    String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name
    <span class="token punctuation">}</span>

    Integer <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> expression <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;#name + &#39;的爱好是: &#39; + #hobby + &#39;,他的朋友是&#39; + name + &#39;,年龄是&#39; + age  &quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">def</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;name&quot;</span></span><span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">&quot;张三&quot;</span></span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;hobby&quot;</span></span><span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">&quot;打游戏&quot;</span></span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span><span class="token function">setRootObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">&quot;李四&quot;</span></span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
println expression<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="createmetadatasource" tabindex="-1"><a class="header-anchor" href="#createmetadatasource" aria-hidden="true">#</a> createMetadataSource：</h4><p><code>UrlAuthorizationConfigurer</code>和<code>ExpressionUrlAuthorizationConfigurer</code>差不多，只是<code>ExpressionUrlAuthorizationConfigurer</code>可以使用<code>SpEL</code>（<code>el</code>表达式）。<code>ExpressionUrlAuthorizationConfigurer</code>父类的<code>configure</code>方法里调用抽象的<code>createMetadataSource</code>方法，委派给其子类去实现。</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123140856907.png" alt="image-20230123140856907" tabindex="0" loading="lazy"><figcaption>image-20230123140856907</figcaption></figure><p><code>ExpressionUrlAuthorizationConfigurer</code>类的<code>createMetadataSource</code>方法首先还是调用<code>this.REGISTRY.createRequestMap()</code>构建<code>requestMap</code>，然后返回<code>ExpressionBasedFilterInvocationSecurityMetadataSource</code>，可以看到比<code>UrlAuthorizationConfigurer</code>的<code>createMetadataSource</code>方法多了一个表达式处理器的参数</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span> <span class="token function">createMetadataSource</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">REGISTRY</span><span class="token punctuation">.</span><span class="token function">createRequestMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span>requestMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">&quot;At least one mapping is required (i.e. authorizeRequests().anyRequest().authenticated())&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">,</span> <span class="token function">getExpressionHandler</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">SecurityExpressionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FilterInvocation</span><span class="token punctuation">&gt;</span></span> <span class="token function">getExpressionHandler</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123141952897.png" alt="image-20230123141952897" tabindex="0" loading="lazy"><figcaption>image-20230123141952897</figcaption></figure><h5 id="securityexpressionhandler" tabindex="-1"><a class="header-anchor" href="#securityexpressionhandler" aria-hidden="true">#</a> SecurityExpressionHandler</h5><p><code>SecurityExpressionHandler</code>接口有两个方法，一个返回<code>ExpressionParser</code>，一个返回<code>EvaluationContext</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123142107635.png" alt="image-20230123142107635" tabindex="0" loading="lazy"><figcaption>image-20230123142107635</figcaption></figure><p><code>ExpressionParser</code>接口的其中一个实现类是<code>SpelExpressionParser</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123142502679.png" alt="image-20230123142502679" tabindex="0" loading="lazy"><figcaption>image-20230123142502679</figcaption></figure><p><code>EvaluationContext</code>接口的其中一个实现类是<code>StandardEvaluationContext</code></p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123142420033.png" alt="image-20230123142420033" tabindex="0" loading="lazy"><figcaption>image-20230123142420033</figcaption></figure><p>可以看到实现<code>SecurityExpressionHandler</code>接口的抽象类使用的就是<code>SpelExpressionParser</code>和<code>StandardEvaluationContext</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSecurityExpressionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>
      <span class="token keyword">implements</span> <span class="token class-name">SecurityExpressionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">ExpressionParser</span> expressionParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">BeanResolver</span> beanResolver<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">RoleHierarchy</span> roleHierarchy<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">PermissionEvaluator</span> permissionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DenyAllPermissionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">protected</span> <span class="token class-name">StandardEvaluationContext</span> <span class="token function">createEvaluationContextInternal</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">T</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123143131098.png" alt="image-20230123143131098" tabindex="0" loading="lazy"><figcaption>image-20230123143131098</figcaption></figure><p>其子类<code>DefaultWebSecurityExpressionHandler</code>的<code>createSecurityExpressionRoot</code>方法里创建了<code>WebSecurityExpressionRoot</code>对象，因此我们可以直接使用其拥有的属性和方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123144122614.png" alt="image-20230123144122614" tabindex="0" loading="lazy"><figcaption>image-20230123144122614</figcaption></figure><p>因此可以使用<code>request</code>对象和<code>hasIpAddress</code>方法，以及其父类的<code>hasAuthority</code>、<code>hasAnyAuthority</code>、<code>hasRole</code>、<code>hasAnyRole</code>等方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123144327379.png" alt="image-20230123144327379" tabindex="0" loading="lazy"><figcaption>image-20230123144327379</figcaption></figure><h5 id="expressionbasedfilterinvocationsecuritymetadatasource" tabindex="-1"><a class="header-anchor" href="#expressionbasedfilterinvocationsecuritymetadatasource" aria-hidden="true">#</a> ExpressionBasedFilterInvocationSecurityMetadataSource</h5><p><code>ExpressionBasedFilterInvocationSecurityMetadataSource</code>类直接继承自<code>DefaultFilterInvocationSecurityMetadataSource</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span>
      <span class="token keyword">extends</span> <span class="token class-name">DefaultFilterInvocationSecurityMetadataSource</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">ExpressionBasedFilterInvocationSecurityMetadataSource</span><span class="token punctuation">(</span>
         <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMap<span class="token punctuation">,</span>
         <span class="token class-name">SecurityExpressionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FilterInvocation</span><span class="token punctuation">&gt;</span></span> expressionHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用父类的构造器时，先调用本类的processMap方法</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token function">processMap</span><span class="token punctuation">(</span>requestMap<span class="token punctuation">,</span> expressionHandler<span class="token punctuation">.</span><span class="token function">getExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>expressionHandler<span class="token punctuation">,</span> <span class="token string">&quot;A non-null SecurityExpressionHandler is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">processMap</span><span class="token punctuation">(</span>
         <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMap<span class="token punctuation">,</span> <span class="token class-name">ExpressionParser</span> parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token string">&quot;SecurityExpressionHandler returned a null parser object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 先将requestMap里的数据存到processed里</span>
      <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> processed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>requestMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 遍历requestMap，对于每一个键值对，都调用process方法，然后再添加到processed里</span>
      requestMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">process</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> request<span class="token punctuation">,</span> value<span class="token punctuation">,</span> processed<span class="token operator">::</span><span class="token function">put</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回processed</span>
      <span class="token keyword">return</span> processed<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">ExpressionParser</span> parser<span class="token punctuation">,</span> <span class="token class-name">RequestMatcher</span> request<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">,</span>
         <span class="token class-name">BiConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcher</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到配置属性的属性值</span>
      <span class="token class-name">String</span> expression <span class="token operator">=</span> <span class="token function">getExpression</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Adding web access control expression [%s] for %s&quot;</span><span class="token punctuation">,</span> expression<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建后置处理</span>
      <span class="token class-name">AbstractVariableEvaluationContextPostProcessor</span> postProcessor <span class="token operator">=</span> <span class="token function">createPostProcessor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建一个processed集合</span>
      <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> processed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 构造WebExpressionConfigAttribute对象，添加到本方法的processed上去</span>
         processed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebExpressionConfigAttribute</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">,</span> postProcessor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to parse expression &#39;&quot;</span> <span class="token operator">+</span> expression <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 调用外面传过来的processed.put(request, processed)方法  （consumer为processed::put的引用）</span>
      consumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> processed<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> request<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// value的大小必须为1</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Expected a single expression attribute for &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 拿到这个配置属性的属性值</span>
      <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigAttribute</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AbstractVariableEvaluationContextPostProcessor</span> <span class="token function">createPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 直接创建一个RequestVariablesExtractorEvaluationContextPostProcessor</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestVariablesExtractorEvaluationContextPostProcessor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RequestVariablesExtractorEvaluationContextPostProcessor</span>
         <span class="token keyword">extends</span> <span class="token class-name">AbstractVariableEvaluationContextPostProcessor</span> <span class="token punctuation">{</span>

      <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcher</span> matcher<span class="token punctuation">;</span>

      <span class="token class-name">RequestVariablesExtractorEvaluationContextPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> matcher<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">extractVariables</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 将request里的变量提取出来</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123155326929.png" alt="image-20230123155326929" tabindex="0" loading="lazy"><figcaption>image-20230123155326929</figcaption></figure><p><code>RequestVariablesExtractorEvaluationContextPostProcessor</code>的核心逻辑都在其抽象类<code>AbstractVariableEvaluationContextPostProcessor</code>里</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractVariableEvaluationContextPostProcessor</span>
		<span class="token keyword">implements</span> <span class="token class-name">EvaluationContextPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FilterInvocation</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">EvaluationContext</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">EvaluationContext</span> context<span class="token punctuation">,</span> <span class="token class-name">FilterInvocation</span> invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接创建了一个VariableEvaluationContext</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">VariableEvaluationContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">abstract</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">extractVariables</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// VariableEvaluationContext继承自DelegatingEvaluationContext</span>
	<span class="token keyword">class</span> <span class="token class-name">VariableEvaluationContext</span> <span class="token keyword">extends</span> <span class="token class-name">DelegatingEvaluationContext</span> <span class="token punctuation">{</span>

		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> variables<span class="token punctuation">;</span>

		<span class="token class-name">VariableEvaluationContext</span><span class="token punctuation">(</span><span class="token class-name">EvaluationContext</span> delegate<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 自己又维护了一个请求</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">// 如果代理的SpEl找不到，调用lookupVariable方法去找（我们可以直接使用在request里定义的）</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">lookupVariable</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">lookupVariable</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> result<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>variables <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>variables <span class="token operator">=</span> <span class="token function">extractVariables</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>variables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123155515984.png" alt="image-20230123155515984" tabindex="0" loading="lazy"><figcaption>image-20230123155515984</figcaption></figure><h4 id="createfiltersecurityinterceptor" tabindex="-1"><a class="header-anchor" href="#createfiltersecurityinterceptor" aria-hidden="true">#</a> createFilterSecurityInterceptor：</h4><p><code>AbstractInterceptUrlConfigurer</code>类的<code>createFilterSecurityInterceptor</code>方法里就调用的<code>getAccessDecisionManager</code>方法返回的不一样</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123154403102.png" alt="image-20230123154403102" tabindex="0" loading="lazy"><figcaption>image-20230123154403102</figcaption></figure><p><code>getAccessDecisionManager</code>方法会调用<code>createDefaultAccessDecisionManager</code>方法，<code>createDefaultAccessDecisionManager</code>方法会调用<code>getDecisionVoters</code>方法</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123154820989.png" alt="image-20230123154820989" tabindex="0" loading="lazy"><figcaption>image-20230123154820989</figcaption></figure><p>这个<code>getDecisionVoters</code>方法为抽象方法，留给子类去实现</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123154902852.png" alt="image-20230123154902852" tabindex="0" loading="lazy"><figcaption>image-20230123154902852</figcaption></figure><p><code>ExpressionUrlAuthorizationConfigurer</code>类里的<code>getDecisionVoters</code>方法创建的是基于表达式的投票器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDecisionVoters</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AccessDecisionVoter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> decisionVoters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">WebExpressionVoter</span> expressionVoter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebExpressionVoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   expressionVoter<span class="token punctuation">.</span><span class="token function">setExpressionHandler</span><span class="token punctuation">(</span><span class="token function">getExpressionHandler</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   decisionVoters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>expressionVoter<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> decisionVoters<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123155754270.png" alt="image-20230123155754270" tabindex="0" loading="lazy"><figcaption>image-20230123155754270</figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebExpressionVoter</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDecisionVoter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FilterInvocation</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">FilterInvocation</span> filterInvocation<span class="token punctuation">,</span>
         <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> <span class="token string">&quot;authentication must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>filterInvocation<span class="token punctuation">,</span> <span class="token string">&quot;filterInvocation must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>attributes<span class="token punctuation">,</span> <span class="token string">&quot;attributes must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 找到第一个类型为WebExpressionConfigAttribute的配置属性</span>
      <span class="token class-name">WebExpressionConfigAttribute</span> webExpressionConfigAttribute <span class="token operator">=</span> <span class="token function">findConfigAttribute</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>webExpressionConfigAttribute <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>logger
               <span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Abstained since did not find a config attribute of instance WebExpressionConfigAttribute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token constant">ACCESS_ABSTAIN</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">EvaluationContext</span> ctx <span class="token operator">=</span> webExpressionConfigAttribute<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>expressionHandler<span class="token punctuation">.</span><span class="token function">createEvaluationContext</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> filterInvocation<span class="token punctuation">)</span><span class="token punctuation">,</span> filterInvocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 判断是否同意</span>
      <span class="token keyword">boolean</span> granted <span class="token operator">=</span> <span class="token class-name">ExpressionUtils</span><span class="token punctuation">.</span><span class="token function">evaluateAsBoolean</span><span class="token punctuation">(</span>webExpressionConfigAttribute<span class="token punctuation">.</span><span class="token function">getAuthorizeExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>granted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token constant">ACCESS_GRANTED</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Voted to deny authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">ACCESS_DENIED</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token class-name">WebExpressionConfigAttribute</span> <span class="token function">findConfigAttribute</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigAttribute</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历寻找第一个类型为WebExpressionConfigAttribute的配置属性</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigAttribute</span> attribute <span class="token operator">:</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute <span class="token keyword">instanceof</span> <span class="token class-name">WebExpressionConfigAttribute</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">WebExpressionConfigAttribute</span><span class="token punctuation">)</span> attribute<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123160438070.png" alt="image-20230123160438070" tabindex="0" loading="lazy"><figcaption>image-20230123160438070</figcaption></figure><p><code>ExpressionUtils</code>类的<code>evaluateAsBoolean</code>方法就是调用<code>expr.getValue(ctx, Boolean.class);</code>，期待返回一个布尔值</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ExpressionUtils</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token class-name">ExpressionUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">evaluateAsBoolean</span><span class="token punctuation">(</span><span class="token class-name">Expression</span> expr<span class="token punctuation">,</span> <span class="token class-name">EvaluationContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> expr<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EvaluationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to evaluate expression &#39;&quot;</span> <span class="token operator">+</span> expr<span class="token punctuation">.</span><span class="token function">getExpressionString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span>
               ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123160540132.png" alt="image-20230123160540132" tabindex="0" loading="lazy"><figcaption>image-20230123160540132</figcaption></figure><p>代码示例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>httpSecurity
    <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">mvcMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/admin/**&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&quot;hasRole(&#39;ADMIN&#39;) &amp;&amp; hasAnyAuthority(&#39;GROUP_ADMIN&#39;) &amp;&amp; hasIpAddress(&#39;92.168.1.0/24&#39;)&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123161428856.png" alt="image-20230123161428856" tabindex="0" loading="lazy"><figcaption>image-20230123161428856</figcaption></figure><h1 id="基于token的认证方式" tabindex="-1"><a class="header-anchor" href="#基于token的认证方式" aria-hidden="true">#</a> 基于token的认证方式</h1><p><code>SecurityContextPersistenceFilter</code>或<code>SecurityContextHolderFilter</code>过滤器会把信息放到<code>SecurityContext</code>里，这两个过滤器的主要区别是<code>SecurityContextPersistenceFilter</code>每次在最后都会保存<code>SecurityContext</code>（这样比较消耗性能，没有必要每次都保存，因此该类被弃用了），而<code>SecurityContextHolderFilter</code>类不会保存（需要我们每次都手动保存）</p><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123164507762.png" alt="image-20230123164507762" tabindex="0" loading="lazy"><figcaption>image-20230123164507762</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230123164636037.png" alt="image-20230123164636037" tabindex="0" loading="lazy"><figcaption>image-20230123164636037</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230128145255300.png" alt="image-20230128145255300" tabindex="0" loading="lazy"><figcaption>image-20230128145255300</figcaption></figure><figure><img src="https://gitlab.com/apzs/image/-/raw/master/image/image-20230128145535457.png" alt="image-20230128145535457" tabindex="0" loading="lazy"><figcaption>image-20230128145535457</figcaption></figure></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/apzs/apzs.github.io/edit/master/src/sourceCode/spring/SpringSecurity/README.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: apzs@foxmaill.com">zhaoshuo</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.0.0-alpha.8</div></div></div><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2024 apzs</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-db_OQQsY.js" defer></script>
  </body>
</html>
